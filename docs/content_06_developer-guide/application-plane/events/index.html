<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_06_developer-guide/application-plane/events" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">イベント処理実装ガイド | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/events"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="イベント処理実装ガイド | IdP-Server Documentation"><meta data-rh="true" name="description" content="このドキュメントの目的"><meta data-rh="true" property="og:description" content="このドキュメントの目的"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/events"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/events" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/events" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.d90f1070.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.e38f4277.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">📚 ドキュメント索引</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">技術概要</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_01_intro/intro-02-features">機能</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_01_intro/intro-03-use-cases">ユースケース一覧</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">Getting-Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_02_quickstart/quickstart-02-setting-templates">初期設定テンプレート（予定）</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_03_concepts/concept-01-multi-tenant">コア概念</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-01-multi-tenant">マ  ルチテナント</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-02-id-management">ID（ユーザー）管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-03-id-verified">身元確認済みID</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-04-enterprise-id">エンタープライズID</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-05-authentication-policy">認証ポリシー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-06-token-management">トークン管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-07-session-management">セッション管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-08-mfa">多要素認証（MFA）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-09-custom-claims">カスタムクレーム・スコープ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-10-control-plane">コントロールプレーン</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-11-security-events">セキュリティイベント・フック</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-12-authorization">認可</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-13-audit-compliance">監査ログ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-14-grant-management">認可許諾管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-15-operations">運用・保守</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-16-external-service-integration">外部サービス連携</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-17-application-logging">アプリケーションログ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-18-id-token">IDトークン（ID Token）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-19-client">クライアント（Client）</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_03_concepts/basic/basic-01-identity-management-basics">基礎（読み物）</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認可プロトコル</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認可コードフロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_04_protocols/protocol-02-ciba-flow">CIBA フロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_04_protocols/protocol-03-introspection">イントロスペクション</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_05_how-to/index">How-to（設定・運用レシピ）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/index">How-to ガイド - 学習ロードマップ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-01-server-setup">サーバー初期設定ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-02-organization-initialization">組織初期化ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-03-tenant-setup">OIDCの最小設定ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-04-client-registration">クライアント登録ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-05-user-registration">ユーザー登録と初回認証</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-07-authentication-policy-basic">認証ポリシー設定ガイド（基礎編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-08-mfa-setup">MFA（多要素認証）の設定</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-09-token-strategy">トークン有効期限パターン</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-10-authentication-policy-advanced">認証ポリシー設定ガイド（詳細編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-11-federation-setup">外部IdP連携（Federation）の設定</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-12-ciba-flow-fido-uaf">CIBA + FIDO-UAF</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-13-fido-uaf-registration">FIDO-UAF 登録フロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-14-fido-uaf-deregistration">FIDO-UAF 解除フロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-15-identity-verification-guide">身元確認申込み 導入ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-16-identity-verification-application">身元確認申込み</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-17-identity-verification-registration">身元確認データ登録</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-18-security-event-hooks">セキュリティイベントフック設定ガイド</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/control-plane/resource-overview">Control Plane（管理API）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">Application Plane（認証・認可API）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">Application Plane - OAuth/OIDC認証フロー概要</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/authorization-flow">Authorization Code Flow実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/token-endpoint">Token Endpoint実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/authentication">認証実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/userinfo">UserInfo実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/ciba-flow">CIBA Flow実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/identity-verification">身元確認申込み実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/federation">フェデレーション（外部IdP連携）実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/events">イベント処理実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/client-authentication">クライアント認証実装ガイド</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/overview">Implementation Guides（実装ガイド）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/configuration/CONFIGURATION_COVERAGE">Configuration（設定）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/patterns/common-patterns">Patterns（実装パターン）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/troubleshooting/common-errors">Troubleshooting（トラブルシューティング）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/code-review-checklist">Reference（リファレンス）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/learning-paths/beginner">Learning Paths（学習パス）</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_07_reference/api-reference">API ドキュメント</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">テスト戦略</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_08_ops/ops-02-performance-test">ストレステスト結果</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_08_ops/commercial-deployment/overview">商用デプロイ</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-01-faq">project-01-faq</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-02-roadmap">🗺️ ロードマップ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-03-contributing">コントリビュートガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-04-license">License</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI開発者向けモジュールガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-02-lessons-learned">AI開発者向けドキュメント作成ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-10-use-cases">idp-server-use-cases - ユースケース層（EntryService実装）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-11-core">idp-server-core - OAuth 2.0/OIDC準拠コアエンジン</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-12-platform">idp-server-platform - プラットフォーム基盤</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-13-control-plane">idp-server-control-plane - 管理API契約定義</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-20-adapters">Adapter層 - Repository実装とインフラ統合</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-21-core-adapter">idp-server-core-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-22-database">idp-server-database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-23-springboot-adapter">idp-server-springboot-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-30-extensions">拡張機能層 - OAuth/OIDC拡張仕様</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-31-extension-ciba">idp-server-core-extension-ciba - CIBA拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-32-extension-fapi">idp-server-core-extension-fapi - FAPI拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-33-extension-ida">idp-server-core-extension-ida - IDA拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-34-extension-pkce">idp-server-core-extension-pkce - PKCE拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-35-extension-vc">idp-server-core-extension-verifiable-credentials - VC拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-40-authentication-federation">認証・連携層 - ユーザー認証とフェデレーション</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-41-authentication">idp-server-authentication-interactors - 認証インタラクター</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-42-webauthn">idp-server-webauthn4j-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-43-federation-oidc">idp-server-federation-oidc</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-50-notification-security-event">通知・イベント層 - 通知配信とセキュリティイベント</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-51-notification-fcm">idp-server-notification-fcm-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-52-notification-apns">idp-server-notification-apns-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-53-email-aws">idp-server-email-aws-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-54-security-event-framework">idp-server-security-event-framework</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-55-security-event-hooks">idp-server-security-event-hooks</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Developer Guide</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Application Plane（認証・認可API）</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">イベント処理実装ガイド</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>イベント処理実装ガイド</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="このドキュメントの目的">このドキュメントの目的<a href="#このドキュメントの目的" class="hash-link" aria-label="このドキュメントの目的 への直接リンク" title="このドキュメントの目的 への直接リンク">​</a></h2>
<p><strong>SecurityEventとUserLifecycleEvent</strong>の仕組みを理解することが目標です。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="所要時間">所要時間<a href="#所要時間" class="hash-link" aria-label="所要時間 への直接リンク" title="所要時間 への直接リンク">​</a></h3>
<p>⏱️ <strong>約20分</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="前提知識">前提知識<a href="#前提知識" class="hash-link" aria-label="前提知識 への直接リンク" title="前提知識 への直接リンク">​</a></h3>
<ul>
<li><a href="/idp-server/docs/content_06_developer-guide/application-plane/authentication">04. Authentication実装</a></li>
<li>Spring Frameworkの<code>@EventListener</code>の基礎知識（<a href="#%E8%A3%9C%E8%B6%B3-spring-framework-applicationeventpublisher">補足セクション</a>参照）</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="イベントシステムとは">イベントシステムとは<a href="#イベントシステムとは" class="hash-link" aria-label="イベントシステムとは への直接リンク" title="イベントシステムとは への直接リンク">​</a></h2>
<p>idp-serverの各種操作（認証・認可・ユーザー管理）で発生するイベントを記録・通知する仕組み。</p>
<p><strong>2種類のイベント</strong>:</p>
<table><thead><tr><th>イベントタイプ</th><th>目的</th><th>例</th></tr></thead><tbody><tr><td><strong>SecurityEvent</strong></td><td>「何が起きたか」を記録・通知</td><td>認証成功/失敗、トークン発行</td></tr><tr><td><strong>UserLifecycleEvent</strong></td><td>「ユーザー状態を変更する」アクション</td><td>アカウントロック、ユーザー削除</td></tr></tbody></table>
<p><strong>使い分け</strong>: SecurityEventは「監視」、UserLifecycleEventは「アクション」</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="アーキテクチャ全体像">アーキテクチャ全体像<a href="#アーキテクチャ全体像" class="hash-link" aria-label="アーキテクチャ全体像 への直接リンク" title="アーキテクチャ全体像 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="securityeventのアーキテクチャ">SecurityEventのアーキテクチャ<a href="#securityeventのアーキテクチャ" class="hash-link" aria-label="SecurityEventのアーキテクチャ への直接リンク" title="SecurityEventのアーキテクチャ への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Application Plane API（認証・認可・トークン発行等）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EntryService - eventPublisher.publish()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (同期)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ SecurityEventPublisher（インターフェース）             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  SecurityEventPublisherService（Adapter層）          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → applicationEventPublisher.publishEvent()       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       (Spring ApplicationEventPublisher)           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (同期で即座に返却)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EntryService処理完了 → HTTPレスポンス返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (非同期 - Spring @EventListener)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ SecurityEventListener（Spring Bean）                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  @EventListener                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  handleSecurityEvent(SecurityEvent event)           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  SecurityEventRunnable作成                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - TenantLoggingContext設定                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - SecurityEventHandler呼び出し                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  securityEventTaskExecutor.execute(runnable)        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → ThreadPoolに投入                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (ThreadPoolで非同期実行)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ 正常時: 別スレッドで実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └─ ThreadPool満杯時: RejectedExecutionHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ┌─────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │ RejectedExecutionHandler                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │  SecurityEventRetryScheduler.enqueue()          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │    → retryQueueに追加                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └─────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (別スレッド - 正常実行時)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ SecurityEventHandler（Platform層）                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. SecurityEventLogService.logEvent()              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → security_event テーブルに記録                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. SecurityEventHookConfiguration取得               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → 設定されたHookを取得                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. SecurityEventHook.shouldExecute()               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → イベントタイプフィルタリング                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  4. SecurityEventHook.execute()                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → 外部サービスに送信（Webhook/Slack/SIEM）        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  5. SecurityEventHookResult保存                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → security_event_hook_results テーブル           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (ThreadPool満杯でリトライキューに入った場合)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ SecurityEventRetryScheduler（Spring Scheduler）     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  @Scheduled(fixedDelay = 60_000)  ← 60秒ごと         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  resendFailedEvents()                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - retryQueueから取得                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - securityEventApi.handle()で再実行               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 失敗 → retryQueueに戻す                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>実装</strong>:</p>
<ul>
<li>Publisher: <a href="/idp-server/assets/files/SecurityEventPublisherService-76edae7639784d04f270baf872242fa1.java" target="_blank">SecurityEventPublisherService.java</a></li>
<li>Runnable: <a href="/idp-server/assets/files/SecurityEventRunnable-6d11dc52f416dcaae9d0d530e769b363.java" target="_blank">SecurityEventRunnable.java</a></li>
<li>Handler: <a href="/idp-server/assets/files/SecurityEventHandler-2d2339c420b65cc0b867f8d84c47f406.java" target="_blank">SecurityEventHandler.java</a></li>
<li>Retry Scheduler: <a href="/idp-server/assets/files/SecurityEventRetryScheduler-a45122a6106205091e11ae72c57bb9a2.java" target="_blank">SecurityEventRetryScheduler.java</a></li>
<li>ThreadPool設定: <a href="/idp-server/assets/files/AsyncConfig-5c038314bda15ce9a596f29049bdd513.java#L46-L69" target="_blank">AsyncConfig.java:46-69</a></li>
</ul>
<p><strong>ThreadPool設定</strong>:</p>
<ul>
<li><strong>CorePoolSize</strong>: 5スレッド</li>
<li><strong>MaxPoolSize</strong>: 10スレッド</li>
<li><strong>QueueCapacity</strong>: 50イベント</li>
<li><strong>RejectedExecutionHandler</strong>: ThreadPool満杯時にSecurityEventRetryScheduler.enqueue()</li>
</ul>
<p><strong>重要</strong>: SecurityEventRetrySchedulerは<strong>Hook送信失敗時ではなく、ThreadPool満杯時</strong>に使われる</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="userlifecycleeventのアーキテクチャ">UserLifecycleEventのアーキテクチャ<a href="#userlifecycleeventのアーキテクチャ" class="hash-link" aria-label="UserLifecycleEventのアーキテクチャ への直接リンク" title="UserLifecycleEventのアーキテクチャ への直接リンク">​</a></h3>
<p>SecurityEventと同じThreadPool + RejectedExecutionHandlerの仕組み：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">EntryService - userLifecycleEventPublisher.publish()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (同期)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────────────────────────────────── ────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ UserLifecycleEventPublisher（インターフェース）       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  UserLifecycleEventPublisherService（Adapter層）    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → applicationEventPublisher.publishEvent()       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       (Spring ApplicationEventPublisher)           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (同期で即座に返却)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EntryService処理完了 → HTTPレスポンス返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (非同期 - Spring @EventListener)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ UserLifecycleEventListener（Spring Bean）          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  @EventListener                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  handleUserLifecycleEvent(UserLifecycleEvent event) │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  UserLifecycleEventRunnable作成                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - TenantLoggingContext設定                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - UserLifecycleEventHandler呼び出し              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  userLifecycleEventTaskExecutor.execute(runnable)   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → ThreadPoolに投入                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (ThreadPoolで非同期実行)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ 正常時: 別スレッドで実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └─ ThreadPool満杯時: RejectedExecutionHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ┌─────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │ RejectedExecutionHandler                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │  UserLifecycleEventRetryScheduler.enqueue()     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    │    → retryQueueに追加                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └─────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (別スレッド - 正常実行時)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ UserLifecycleEventHandler（Platform層）             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  UserLifecycleType.LOCK の場合:                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    1. User.status = LOCKED                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    2. 全OAuthToken削除                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    3. SecurityEvent(user_locked)発行                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  UserLifecycleType.DELETE の場合:                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    1. 関連データ削除（12ステップ）                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    2. 外部サービスに通知（FIDO/VC等）                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    3. SecurityEvent(user_deleted)発行                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────────────────────  ──────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ (ThreadPool満杯でリトライキューに入った場合)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ UserLifecycleEventRetryScheduler（Spring Scheduler）│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  @Scheduled(fixedDelay = 60_000)  ← 60秒ごと         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  resendFailedEvents()                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - retryQueueから取得                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - userLifecycleEventApi.handle()で再実行          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 失敗 → retryQueueに戻す                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリッ プボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>実装</strong>:</p>
<ul>
<li>Publisher: <a href="/idp-server/assets/files/UserLifecycleEventPublisherService-7f4b6155b143b4d547feb312918b44b8.java" target="_blank">UserLifecycleEventPublisherService.java</a></li>
<li>Runnable: <a href="/idp-server/assets/files/UserLifecycleEventRunnable-8f3c77ebdea8247db6fc121e58d1199e.java" target="_blank">UserLifecycleEventRunnable.java</a></li>
<li>Handler: Platform層（イベントタイプ別に処理）</li>
<li>Retry Scheduler: <a href="/idp-server/assets/files/UserLifecycleEventRetryScheduler-16c53a4a80699f93fc8a2ddb436653dc.java" target="_blank">UserLifecycleEventRetryScheduler.java</a></li>
<li>ThreadPool設定: <a href="/idp-server/assets/files/AsyncConfig-5c038314bda15ce9a596f29049bdd513.java#L71-L94" target="_blank">AsyncConfig.java:71-94</a></li>
</ul>
<p><strong>ThreadPool設定</strong>:</p>
<ul>
<li><strong>CorePoolSize</strong>: 5スレッド</li>
<li><strong>MaxPoolSize</strong>: 10スレッド</li>
<li><strong>QueueCapacity</strong>: 50イベント</li>
<li><strong>RejectedExecutionHandler</strong>: ThreadPool満杯時にUserLifecycleEventRetryScheduler.enqueue()</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラスの責務">主要クラスの責務<a href="#主要クラスの責務" class="hash-link" aria-label="主要クラスの責務 への直接リンク" title="主要クラスの責務 への直接リンク">​</a></h3>
<table><thead><tr><th>クラス</th><th>層</th><th>役割</th><th>実装</th></tr></thead><tbody><tr><td><strong>SecurityEventPublisher</strong></td><td>Interface</td><td>イベント発行インターフェース</td><td>Platform</td></tr><tr><td><strong>SecurityEventPublisherService</strong></td><td>Adapter</td><td>Spring ApplicationEventPublisherへの委譲</td><td><a href="/idp-server/assets/files/SecurityEventPublisherService-76edae7639784d04f270baf872242fa1.java" target="_blank">SecurityEventPublisherService.java</a></td></tr><tr><td><strong>SecurityEventRunnable</strong></td><td>Adapter</td><td>TenantLoggingContext設定＋Handler実行</td><td><a href="/idp-server/assets/files/SecurityEventRunnable-6d11dc52f416dcaae9d0d530e769b363.java" target="_blank">SecurityEventRunnable.java</a></td></tr><tr><td><strong>SecurityEventHandler</strong></td><td>Platform</td><td>イベント処理・Hook実行（5ステップ）</td><td><a href="/idp-server/assets/files/SecurityEventHandler-2d2339c420b65cc0b867f8d84c47f406.java" target="_blank">SecurityEventHandler.java</a></td></tr><tr><td><strong>SecurityEventRetryScheduler</strong></td><td>Adapter</td><td>ThreadPool満杯時の再実行（60秒ごと）</td><td><a href="/idp-server/assets/files/SecurityEventRetryScheduler-a45122a6106205091e11ae72c57bb9a2.java" target="_blank">SecurityEventRetryScheduler.java</a></td></tr><tr><td><strong>AsyncConfig</strong></td><td>Adapter</td><td>ThreadPool設定（5-10スレッド、Queue50）</td><td><a href="/idp-server/assets/files/AsyncConfig-5c038314bda15ce9a596f29049bdd513.java" target="_blank">AsyncConfig.java</a></td></tr><tr><td><strong>SecurityEventHook</strong></td><td>Plugin</td><td>外部サービス送信（Webhook等）</td><td>Platform</td></tr><tr><td><strong>UserLifecycleEventPublisher</strong></td><td>Interface</td><td>ライフサイクルイベント発行</td><td>Core</td></tr><tr><td><strong>UserLifecycleEventPublisherService</strong></td><td>Adapter</td><td>Spring ApplicationEventPublisherへの委譲</td><td><a href="/idp-server/assets/files/UserLifecycleEventPublisherService-7f4b6155b143b4d547feb312918b44b8.java" target="_blank">UserLifecycleEventPublisherService.java</a></td></tr><tr><td><strong>UserLifecycleEventRunnable</strong></td><td>Adapter</td><td>TenantLoggingContext設定＋Handler実行</td><td><a href="/idp-server/assets/files/UserLifecycleEventRunnable-8f3c77ebdea8247db6fc121e58d1199e.java" target="_blank">UserLifecycleEventRunnable.java</a></td></tr><tr><td><strong>UserLifecycleEventRetryScheduler</strong></td><td>Adapter</td><td>ThreadPool満杯時の再実行（60秒ごと）</td><td><a href="/idp-server/assets/files/UserLifecycleEventRetryScheduler-16c53a4a80699f93fc8a2ddb436653dc.java" target="_blank">UserLifecycleEventRetryScheduler.java</a></td></tr></tbody></table>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="spring-applicationeventpublisherの利用">Spring ApplicationEventPublisherの利用<a href="#spring-applicationeventpublisherの利用" class="hash-link" aria-label="Spring ApplicationEventPublisherの利用 への直接リンク" title="Spring ApplicationEventPublisherの利用 への直接リンク">​</a></h3>
<p>idp-serverは<strong>Spring ApplicationEventPublisher</strong>を活用して非同期イベント処理を実現：</p>
<p><strong>Publisher側（同期）</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SecurityEventPublisherService implements SecurityEventPublisher {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ApplicationEventPublisher applicationEventPublisher;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void publish(SecurityEvent securityEvent) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applicationEventPublisher.publishEvent(securityEvent);  // 同期で発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Handler側（非同期）</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class SecurityEventListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @EventListener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Async  // 非同期実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void handleSecurityEvent(SecurityEvent event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    securityEventHandler.handle(event.tenant(), event);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>メリット</strong>:</p>
<ul>
<li>✅ EntryServiceはイベント発行後すぐに返却（パフォーマンス）</li>
<li>✅ Hook送信失敗がAPI呼び出しに影響しない</li>
<li>✅ Spring標準機能で非同期処理</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="securityevent詳細">SecurityEvent詳細<a href="#securityevent詳細" class="hash-link" aria-label="SecurityEvent詳細 への直接リンク" title="SecurityEvent詳細 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="特徴">特徴<a href="#特徴" class="hash-link" aria-label="特徴 への直接リンク" title="特徴 への直接リンク">​</a></h3>
<p><strong>目的</strong>: 「何が起きたか」を記録・通知</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">認証成功 → SecurityEvent(password_success) → 監査ログに記録 → 外部サービスに通知</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>特徴</strong>:</p>
<ul>
<li>✅ <strong>記録中心</strong>: security_eventテーブルに永久保存</li>
<li>✅ <strong>監視・通知</strong>: Security Event Hooksで外部サービスに送信</li>
<li>❌ <strong>状態変更しない</strong>: ユーザー・トークン等は変更しない</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要なイベントタイプ">主要なイベントタイプ<a href="#主要なイベントタイプ" class="hash-link" aria-label="主要なイベントタイプ への直接リンク" title="主要なイベントタイプ への直接リンク">​</a></h3>
<p>Application Planeで発行されるSecurityEvent：</p>
<table><thead><tr><th>イベントタイプ</th><th>発行タイミング</th><th>実装箇所</th></tr></thead><tbody><tr><td><code>password_success</code></td><td>パスワード認証成功</td><td><a href="/idp-server/assets/files/OAuthFlowEntryService-792731186f57c392174d768140826151.java#L210" target="_blank">OAuthFlowEntryService.java:210</a></td></tr><tr><td><code>password_failure</code></td><td>パスワード認証失敗</td><td>同上</td></tr><tr><td><code>oauth_authorize</code></td><td>Authorization Code発行</td><td><a href="/idp-server/assets/files/OAuthFlowEntryService-792731186f57c392174d768140826151.java#L330-L335" target="_blank">OAuthFlowEntryService.java:330-335</a></td></tr><tr><td><code>token_request_success</code></td><td>トークン発行成功</td><td>TokenEntryService</td></tr><tr><td><code>userinfo_success</code></td><td>UserInfo取得成功</td><td>UserinfoEntryService</td></tr><tr><td><code>backchannel_authentication_request_success</code></td><td>CIBA認証リクエスト成功</td><td>CibaFlowEntryService</td></tr></tbody></table>
<p><strong>完全なリスト</strong>: <a href="/idp-server/assets/files/DefaultSecurityEventType-6517df49c7650b5c2f98c0a924cdf7ec.java" target="_blank">DefaultSecurityEventType.java</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="イベント発行の実装">イベント発行の実装<a href="#イベント発行の実装" class="hash-link" aria-label="イベント発行の実装 への直接リンク" title="イベント発行の実装 への直接リンク">​</a></h3>
<p><strong>04-authentication.mdで見た例</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 10. イベント発行（Security Event）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">eventPublisher.publish(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    authorizationRequest,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result.user(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    result.eventType(),  // password_success or password_failure</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestAttributes);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="securityeventの保存先">SecurityEventの保存先<a href="#securityeventの保存先" class="hash-link" aria-label="SecurityEventの保存先 への直接リンク" title="SecurityEventの保存先 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- security_eventテーブル</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> security_event </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id UUID </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tenant_id UUID </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    event_type </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- &#x27;password_success&#x27; 等</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user_id UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    client_id </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ip_address </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">45</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    user_agent </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    event_data JSONB</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>用途</strong>:</p>
<ul>
<li>監査ログとして永久保存</li>
<li>Security Event Hooksで外部サービスに通知</li>
<li>SIEM（Security Information and Event Management）連携</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="userlifecycleevent詳細">UserLifecycleEvent詳細<a href="#userlifecycleevent詳細" class="hash-link" aria-label="UserLifecycleEvent詳細 への直接リンク" title="UserLifecycleEvent詳細 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="特徴-1">特徴<a href="#特徴-1" class="hash-link" aria-label="特徴 への直接リンク" title="特徴 への直接リンク">​</a></h3>
<p><strong>目的</strong>: 「ユーザー状態を変更する」アクション</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">認証失敗5回 → UserLifecycleEvent(LOCK) → User.status = LOCKED → トークン全削除</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコー ドをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>特徴</strong>:</p>
<ul>
<li>✅ <strong>状態変更</strong>: ユーザーステータス・トークン・関連データを変更</li>
<li>✅ <strong>非同期処理</strong>: 別スレッドでデータ削除・外部サービス連携</li>
<li>✅ <strong>副作用あり</strong>: SecurityEvent(user_locked)等を再発行</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ライフサイクルタイプ">ライフサイクルタイプ<a href="#ライフサイクルタイプ" class="hash-link" aria-label="ライフサイクルタイプ への直接リンク" title="ライフサイクルタイプ への直接リンク">​</a></h3>
<table><thead><tr><th>ライフサイクルタイプ</th><th>発行タイミング</th><th>用途</th></tr></thead><tbody><tr><td><code>LOCK</code></td><td>アカウントロック</td><td>ユーザーステータス更新、トークン失効</td></tr><tr><td><code>UNLOCK</code></td><td>アカウントロック解除</td><td>ユーザーステータス更新</td></tr><tr><td><code>DELETE</code></td><td>ユーザー削除</td><td>関連データ削除、外部サービス連携</td></tr><tr><td><code>SUSPEND</code></td><td>アカウント停止</td><td>ユーザーステータス更新</td></tr><tr><td><code>ACTIVATE</code></td><td>アカウント有効化</td><td>ユーザーステータス更新</td></tr><tr><td><code>INVITE_COMPLETE</code></td><td>招待完了</td><td>招待ステータス更新</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="イベント発行の実装-1">イベント発行の実装<a href="#イベント発行の実装-1" class="hash-link" aria-label="イベント発行の実装 への直接リンク" title="イベント発行の実装 への直接リンク">​</a></h3>
<p><strong>04-authentication.mdで見た例</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 9. ロック処理（失敗回数超過時）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (updatedTransaction.isLocked()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UserLifecycleEvent userLifecycleEvent =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      new UserLifecycleEvent(tenant, updatedTransaction.user(), UserLifecycleType.LOCK);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  userLifecycleEventPublisher.publish(userLifecycleEvent);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="userlifecycleeventの処理">UserLifecycleEventの処理<a href="#userlifecycleeventの処理" class="hash-link" aria-label="UserLifecycleEventの処理 への直接リンク" title="UserLifecycleEventの処理 への直接リンク">​</a></h3>
<p><strong>非同期処理</strong>: イベント発行後、別スレッドで処理</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">UserLifecycleEvent発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UserLifecycleEventHandler（非同期）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ UserLifecycleType.LOCK                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - User.status = LOCKED                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - OAuthToken全削除                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - SecurityEvent(user_locked)発行        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ UserLifecycleType.DELETE                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 関連データ削除（12ステップ）            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 外部サービスに通知（FIDO/VC等）         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - SecurityEvent(user_deleted)発行       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2種類のイベントの使い分け">2種類のイベントの使い分け<a href="#2種類のイベントの使い分け" class="hash-link" aria-label="2種類のイベントの使い分け への直接リンク" title="2種類のイベントの使い分け への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="パスワード認証失敗のフロー">パスワード認証失敗のフロー<a href="#パスワード認証失敗のフロー" class="hash-link" aria-label="パスワード認証失敗のフロー への直接リンク" title="パスワード認証失敗のフロー への直接リンク">​</a></h3>
<p>2つのイベントがどう連携するかの具体例：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. パスワード認証失敗</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → SecurityEvent(password_failure)発行  ← 監視・記録</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 失敗回数が5回に到達</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → UserLifecycleEvent(LOCK)発行  ← 状態変更トリガー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. UserLifecycleEventHandler（非同期）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├─ User.status = LOCKED  ← 状態変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ├─ 全OAuthToken削除  ← 状態変更</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   └─ SecurityEvent(user_locked)発行  ← 記録・通知</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>ポイント</strong>:</p>
<ul>
<li>SecurityEvent: 監視・記録のみ（状態変更しない）</li>
<li>UserLifecycleEvent: 状態変更のトリガー</li>
<li>1つのUserLifecycleEventが複数のSecurityEventを発生させることもある</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="アカウントロックフロー詳細">アカウントロックフロー（詳細）<a href="#アカウントロックフロー詳細" class="hash-link" aria-label="アカウントロックフロー（詳細） への直接リンク" title="アカウントロックフロー（詳細） への直接リンク">​</a></h2>
<p>認証失敗が一 定回数を超えた場合の自動ロック：</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">[パスワード認証失敗 x5]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthenticationTransaction.isLocked() = true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UserLifecycleEvent(type=LOCK)発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UserLifecycleEventHandler（非同期処理）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ User.status = LOCKED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ 全OAuthToken削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └─ SecurityEvent(user_locked)発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">次回認証試行時</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;error&quot;: &quot;account_locked&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;error_description&quot;: &quot;Account has been locked due to too many failed attempts&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/OAuthFlowEntryService-792731186f57c392174d768140826151.java#L204-L208" target="_blank">OAuthFlowEntryService.java:204-208</a></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ユーザー削除戦略">ユーザー削除戦略<a href="#ユーザー削除戦略" class="hash-link" aria-label="ユーザー削除戦略 への直接リンク" title="ユーザー削除戦略 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="削除方針">削除方針<a href="#削除方針" class="hash-link" aria-label="削除方針 への直接リンク" title="削除方針 への直接リンク">​</a></h3>
<table><thead><tr><th>カテゴリ</th><th>ストラテジー</th><th>対象テーブル</th></tr></thead><tbody><tr><td><strong>コアデータ</strong></td><td>物理削除</td><td><code>idp_user</code>, <code>idp_user_roles</code>, <code>oauth_token</code>, <code>authorization_code_grant</code>, <code>authentication_transaction</code>, <code>ciba_grant</code>, <code>federation_sso_session</code></td></tr><tr><td><strong>ログ・履歴</strong></td><td>論理削除/保持</td><td><code>authorization_granted</code>（revoked_at設定）, <code>identity_verification_application</code>（status=deleted）, <code>security_event</code>（保持）</td></tr><tr><td><strong>外部サービス</strong></td><td>非同期削除</td><td>FIDO-UAFデバイス、Verifiable Credentials</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="削除シーケンス推奨順序">削除シーケンス（推奨順序）<a href="#削除シーケンス推奨順序" class="hash-link" aria-label="削除シーケンス（推奨順序） への直接リンク" title="削除シーケンス（推奨順序） への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">UserLifecycleEvent(type=DELETE)発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">UserLifecycleEventHandler</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. authentication_interactions 削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. authentication_transaction 削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. idp_user_roles 削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. idp_user_permission_override 削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. oauth_token 削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6. authorization_code_grant 削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7. ciba_grant 削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">8. federation_sso_session 削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">9. authorization_granted 論理削除（revoked_at設定）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10. identity_verification_application 論理削除（status=deleted）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">11. idp_user 物理削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">12. security_event 監査エントリ追加</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">13. 外部サービスに delete_account イベント送信（非同期）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="監査ログは削除しない">監査ログは削除しない<a href="#監査ログは削除しない" class="hash-link" aria-label="監査ログは削除しな い への直接リンク" title="監査ログは削除しない への直接リンク">​</a></h3>
<p><strong>重要</strong>: <code>security_event</code>テーブルは削除せず、永久保存</p>
<p><strong>理由</strong>:</p>
<ul>
<li>法的要件（監査証跡の保持義務）</li>
<li>セキュリティ分析（過去の不正アクセス調査）</li>
<li>コンプライアンス（GDPR等の例外規定）</li>
</ul>
<p><strong>対応</strong>: ユーザー削除後も、security_eventは<code>user_id</code>を保持（または匿名化）</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="security-event-hooks">Security Event Hooks<a href="#security-event-hooks" class="hash-link" aria-label="Security Event Hooks への直接リンク" title="Security Event Hooks への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hooksとは">Hooksとは<a href="#hooksとは" class="hash-link" aria-label="Hooksとは への直接リンク" title="Hooksとは への直接リンク">​</a></h3>
<p>SecurityEventを外部サービス（Webhook/Slack/SIEM等）に通知する仕組み。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">SecurityEvent発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">SecurityEventHookExecutor（非同期）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────  ───────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 設定されたHookエンドポイントに送信          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  POST https://webhook.example.com/events │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  {                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    &quot;event_type&quot;: &quot;password_failure&quot;,     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    &quot;user_id&quot;: &quot;user-12345&quot;,              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    &quot;ip_address&quot;: &quot;192.168.1.1&quot;,          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    &quot;timestamp&quot;: &quot;2025-10-13T10:00:00Z&quot;   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  }                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">外部サービス（Slack/SIEM/監視ツール）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="hook設定">Hook設定<a href="#hook設定" class="hash-link" aria-label="Hook設定 への直接リンク" title="Hook設定 への直接リンク">​</a></h3>
<p><strong>Management APIで設定</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;uuid&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;event_types&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;password_failure&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user_locked&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;token_request_success&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;endpoint&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://webhook.example.com/events&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;auth_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;bearer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;auth_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;secret-token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;enabled&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>設定API</strong>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /v1/management/tenants/{tenant-id}/security-event-hooks</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="リトライ戦略">リトライ戦略<a href="#リトライ戦略" class="hash-link" aria-label="リトライ戦略 への直接リンク" title="リトライ戦略 への直接リンク">​</a></h3>
<p>Hook送信失敗時は自動リトライ：</p>
<ul>
<li><strong>max_retries</strong>: 3回（デフォルト）</li>
<li><strong>backoff</strong>: 1秒 → 2秒 → 4秒</li>
<li><strong>retryable_status_codes</strong>: 502, 503, 504</li>
</ul>
<p><strong>詳細</strong>: <a href="/idp-server/docs/content_06_developer-guide/implementation-guides/impl-15-security-event-hooks">実装ガイド: Security Event Hooks</a></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="よくある質問">よくある質問<a href="#よくある質問" class="hash-link" aria-label="よくある質問 への直接リンク" title="よくある質問 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="q1-securityeventとuserlifecycleeventの使い分けは">Q1: SecurityEventとUserLifecycleEventの使い分けは？<a href="#q1-securityeventとuserlifecycleeventの使い分けは" class="hash-link" aria-label="Q1: SecurityEventとUserLifecycleEventの使い分けは？ への直接リンク" title="Q1: SecurityEventとUserLifecycleEventの使い分けは？ への直接リンク">​</a></h3>
<p><strong>SecurityEvent</strong>:</p>
<ul>
<li>監視・監査が目的</li>
<li>外部サービスへの通知</li>
<li>ユーザー状態は変更しない</li>
</ul>
<p><strong>UserLifecycleEvent</strong>:</p>
<ul>
<li>ユーザー状態変更が目的</li>
<li>データ削除・更新</li>
<li>内部処理のトリガー</li>
</ul>
<p><strong>例</strong>: パスワード失敗</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. SecurityEvent(password_failure) → 監査ログに記録</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 5回失敗 → UserLifecycleEvent(LOCK) → ユーザーステータス更新</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. SecurityEvent(user_locked) → 外部に通知</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="q2-イベントは同期非同期">Q2: イベントは同期？非同期？<a href="#q2-イベントは同期非同期" class="hash-link" aria-label="Q2: イベントは同期？非同期？ への直接リンク" title="Q2: イベントは同期？非同期？ への直接リンク">​</a></h3>
<p><strong>SecurityEvent発行</strong>: 同期（eventPublisher.publish()）
<strong>SecurityEvent保存</strong>: 同期（DBに即座に記録）
<strong>Security Event Hooks送信</strong>: 非同期（別スレッド）</p>
<p><strong>UserLifecycleEvent発行</strong>: 同期（userLifecycleEventPublisher.publish()）
<strong>UserLifecycleEvent処理</strong>: 非同期（別スレッド）</p>
<p><strong>理由</strong>:</p>
<ul>
<li>イベント記録は即座に完了（監査証跡）</li>
<li>外部サービス通知は非同期（パフォーマンス影響を避ける）</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="q3-イベント発行失敗時は">Q3: イベント発行失敗時は？<a href="#q3-イベント発行失敗時は" class="hash-link" aria-label="Q3: イベント発行失敗時は？ への直接リンク" title="Q3: イベント発行失敗時は？ への直接リンク">​</a></h3>
<p><strong>SecurityEvent発行失敗</strong>:</p>
<ul>
<li>トランザクションロールバック</li>
<li>API呼び出し自体が失敗</li>
</ul>
<p><strong>Hook送信失敗</strong>:</p>
<ul>
<li>リトライ（3回）</li>
<li>最終的に失敗 → security_event_hook_results テーブルに記録</li>
<li>API呼び出しは成功（非同期のため影響なし）</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="補足-spring-framework-applicationeventpublisher">補足: Spring Framework ApplicationEventPublisher<a href="#補足-spring-framework-applicationeventpublisher" class="hash-link" aria-label="補足: Spring Framework ApplicationEventPublisher への直接リンク" title="補足: Spring Framework ApplicationEventPublisher への直接リンク">​</a></h2>
<p>idp-serverのイベントシステムは<strong>Spring Framework</strong>の標準機能を活用しています。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="applicationeventpublisherとは">ApplicationEventPublisherとは<a href="#applicationeventpublisherとは" class="hash-link" aria-label="ApplicationEventPublisherとは への直接リンク" title="ApplicationEventPublisherとは への直接リンク">​</a></h3>
<p>Spring Frameworkが提供するイベント駆動アーキテクチャの基盤コンポーネント。</p>
<p><strong>公式ドキュメント</strong>:</p>
<ul>
<li><a href="https://docs.spring.io/spring-framework/reference/core/beans/context-introduction.html#context-functionality-events" target="_blank" rel="noopener noreferrer">Spring Framework Reference - Standard and Custom Events</a></li>
<li><a href="https://docs.spring.io/spring-framework/reference/core/beans/context-introduction.html#context-functionality-events-annotation" target="_blank" rel="noopener noreferrer">Spring Framework Reference - Annotation-driven Event Listeners</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="基本的な使い方">基本的な使い方<a href="#基本的な使い方" class="hash-link" aria-label="基本的な使い方 への直接リンク" title="基本的な使い方 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// イベント発行側</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Service</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EventPublisher {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Autowired</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    private ApplicationEventPublisher applicationEventPublisher;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void doSomething() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 同期でイベント発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        applicationEventPublisher.publishEvent(new CustomEvent(this, &quot;data&quot;));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// イベント受信側</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Component</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class EventListener {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @EventListener</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Async  // 非同期実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public void handleEvent(CustomEvent event) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // イベント処理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="idp-serverでの活用ポイント">idp-serverでの活用ポイント<a href="#idp-serverでの活用ポイント" class="hash-link" aria-label="idp-serverでの活用ポイント への直接リンク" title="idp-serverでの活用ポイント への直接リンク">​</a></h3>
<ol>
<li><strong>同期発行 + 非同期処理</strong>: イベント発行は同期だが、<code>@Async</code>で処理は非同期</li>
<li><strong>疎結合</strong>: EntryServiceはイベント処理の詳細を知らない</li>
<li><strong>スレッドプール制御</strong>: <code>AsyncConfig</code>でThreadPool設定を細かく制御</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="学習リソース">学習リソース<a href="#学習リソース" class="hash-link" aria-label="学習リソース への直接リンク" title="学習リソース への直接リンク">​</a></h3>
<ul>
<li><a href="https://www.baeldung.com/spring-events" target="_blank" rel="noopener noreferrer">Baeldung - Spring Events</a> - 実践的な使い方</li>
<li><a href="https://docs.spring.io/spring-framework/docs/current/reference/html/core.html#context-functionality-events" target="_blank" rel="noopener noreferrer">Spring Framework Documentation - Application Events</a> - 最新の公式リファレンス</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="次のステップ">次のステップ<a href="#次のステップ" class="hash-link" aria-label="次のステップ への直接リンク" title="次のステップ への直接リンク">​</a></h2>
<p>✅ イベント処理の仕組みを理解した！</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-詳細情報">📖 詳細情報<a href="#-詳細情報" class="hash-link" aria-label="📖 詳細情報 への直接リンク" title="📖 詳細情報 への直接リンク">​</a></h3>
<ul>
<li><a href="/idp-server/docs/content_06_developer-guide/implementation-guides/impl-15-security-event-hooks">実装ガイド: Security Event Hooks</a> - Hook実装詳細</li>
<li><a href="/idp-server/content_10_ai_developer/ai-51-notification-security-event.md#security-event">AI開発者向け: Security Event</a></li>
</ul>
<hr>
<p><strong>情報源</strong>:</p>
<ul>
<li><a href="/idp-server/assets/files/OAuthFlowEntryService-792731186f57c392174d768140826151.java" target="_blank">OAuthFlowEntryService.java</a></li>
<li><a href="/libs/idp-server-platform/src/main/java/org/idp/server/platform/security/event/SecurityEventPublisher.java">SecurityEventPublisher.java</a></li>
<li><a href="/idp-server/assets/files/UserLifecycleEventPublisher-489457f54a9ead79f0c3929b33699d1b.java" target="_blank">UserLifecycleEventPublisher.java</a></li>
</ul>
<p><strong>最終更新</strong>: 2025-10-13</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_06_developer-guide/03-application-plane/09-events.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_06_developer-guide/application-plane/federation"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">フェデレーション（外部IdP連携）実装ガイド</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_06_developer-guide/application-plane/client-authentication"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">クライアント認証実装ガイド</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#このドキュメントの目的" class="table-of-contents__link toc-highlight">このドキュメントの目的</a><ul><li><a href="#所要時間" class="table-of-contents__link toc-highlight">所要時間</a></li><li><a href="#前提知識" class="table-of-contents__link toc-highlight">前提知識</a></li></ul></li><li><a href="#イベントシステムとは" class="table-of-contents__link toc-highlight">イベントシステムとは</a></li><li><a href="#アーキテクチャ全体像" class="table-of-contents__link toc-highlight">アーキテクチャ全体像</a><ul><li><a href="#securityeventのアーキテクチャ" class="table-of-contents__link toc-highlight">SecurityEventのアーキテクチャ</a></li><li><a href="#userlifecycleeventのアーキテクチャ" class="table-of-contents__link toc-highlight">UserLifecycleEventのアーキテクチャ</a></li><li><a href="#主要クラスの責務" class="table-of-contents__link toc-highlight">主要クラスの責務</a></li><li><a href="#spring-applicationeventpublisherの利用" class="table-of-contents__link toc-highlight">Spring ApplicationEventPublisherの利用</a></li></ul></li><li><a href="#securityevent詳細" class="table-of-contents__link toc-highlight">SecurityEvent詳細</a><ul><li><a href="#特徴" class="table-of-contents__link toc-highlight">特徴</a></li><li><a href="#主要なイベントタイプ" class="table-of-contents__link toc-highlight">主要なイベントタイプ</a></li><li><a href="#イベント発行の実装" class="table-of-contents__link toc-highlight">イベント発行 の実装</a></li><li><a href="#securityeventの保存先" class="table-of-contents__link toc-highlight">SecurityEventの保存先</a></li></ul></li><li><a href="#userlifecycleevent詳細" class="table-of-contents__link toc-highlight">UserLifecycleEvent詳細</a><ul><li><a href="#特徴-1" class="table-of-contents__link toc-highlight">特徴</a></li><li><a href="#ライフサイクルタイプ" class="table-of-contents__link toc-highlight">ライフサイクルタイプ</a></li><li><a href="#イベント発行の実装-1" class="table-of-contents__link toc-highlight">イベント発行の実装</a></li><li><a href="#userlifecycleeventの処理" class="table-of-contents__link toc-highlight">UserLifecycleEventの処理</a></li></ul></li><li><a href="#2種類のイベントの使い分け" class="table-of-contents__link toc-highlight">2種類のイベントの使い分け</a><ul><li><a href="#パスワード認証失敗のフロー" class="table-of-contents__link toc-highlight">パスワード認証失敗のフロー</a></li></ul></li><li><a href="#アカウントロックフロー詳細" class="table-of-contents__link toc-highlight">アカウントロックフロー（詳細）</a></li><li><a href="#ユーザー削除戦略" class="table-of-contents__link toc-highlight">ユーザー削除戦略</a><ul><li><a href="#削除方針" class="table-of-contents__link toc-highlight">削除方針</a></li><li><a href="#削除シーケンス推奨順序" class="table-of-contents__link toc-highlight">削除シーケンス（推奨順序）</a></li><li><a href="#監査ログは削除しない" class="table-of-contents__link toc-highlight">監査ログは削除しない</a></li></ul></li><li><a href="#security-event-hooks" class="table-of-contents__link toc-highlight">Security Event Hooks</a><ul><li><a href="#hooksとは" class="table-of-contents__link toc-highlight">Hooksとは</a></li><li><a href="#hook設定" class="table-of-contents__link toc-highlight">Hook設定</a></li><li><a href="#リトライ戦略" class="table-of-contents__link toc-highlight">リトライ戦略</a></li></ul></li><li><a href="#よくある質問" class="table-of-contents__link toc-highlight">よくある質問</a><ul><li><a href="#q1-securityeventとuserlifecycleeventの使い分けは" class="table-of-contents__link toc-highlight">Q1: SecurityEventとUserLifecycleEventの使い分けは？</a></li><li><a href="#q2-イベントは同期非同期" class="table-of-contents__link toc-highlight">Q2: イベントは同期？非同期？</a></li><li><a href="#q3-イベント発行失敗時は" class="table-of-contents__link toc-highlight">Q3: イベント発行失敗時は？</a></li></ul></li><li><a href="#補足-spring-framework-applicationeventpublisher" class="table-of-contents__link toc-highlight">補足: Spring Framework ApplicationEventPublisher</a><ul><li><a href="#applicationeventpublisherとは" class="table-of-contents__link toc-highlight">ApplicationEventPublisherとは</a></li><li><a href="#基本的な使い方" class="table-of-contents__link toc-highlight">基本的な使い方</a></li><li><a href="#idp-serverでの活用ポイント" class="table-of-contents__link toc-highlight">idp-serverでの活用ポイント</a></li><li><a href="#学習リソース" class="table-of-contents__link toc-highlight">学習リソース</a></li></ul></li><li><a href="#次のステップ" class="table-of-contents__link toc-highlight">次のステップ</a><ul><li><a href="#-詳細情報" class="table-of-contents__link toc-highlight">📖 詳細情報</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>