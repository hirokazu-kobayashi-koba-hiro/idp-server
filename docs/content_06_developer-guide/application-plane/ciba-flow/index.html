<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_06_developer-guide/application-plane/ciba-flow" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">CIBA Flow実装ガイド | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/ciba-flow"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="CIBA Flow実装ガイド | IdP-Server Documentation"><meta data-rh="true" name="description" content="このドキュメントの目的"><meta data-rh="true" property="og:description" content="このドキュメントの目的"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/ciba-flow"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/ciba-flow" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/ciba-flow" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.e8840035.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.b70dab8e.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">ドキュメントガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_03_concepts/foundation/concept-01-multi-tenant">コア概念</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認証・認可プロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_05_how-to/">How-to（設定・運用レシピ）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_06_developer-guide/">開発者ガイド</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/">開発者ガイドマップ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">はじめに</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/learning-paths/beginner">学習パス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/control-plane/resource-overview">管理API</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">認証・認可</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">Application Plane - OAuth/OIDC認証フロー概要</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/authorization-flow">Authorization Code Flow実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/token-endpoint">Token Endpoint実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/authentication">認証実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/userinfo">UserInfo実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/ciba-flow">CIBA Flow実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/identity-verification">身元確認申込み実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/federation">フェデレーション（外部IdP連携）実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/events">イベント処理実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/security-event">SecurityEvent 実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/user-lifecycle-event">UserLifecycleEvent 実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/client-authentication">クライアント認証実装ガイド</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/overview">実装ガイド</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/configuration/authentication-policy">設定</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/patterns/common-patterns">実装パターン</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/troubleshooting/common-errors">トラブルシューティング</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/code-review-checklist">リファレンス</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_11_learning/identity-basics/identity-management-basics">学習（Learning）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">開発者ガイド</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">認証・認可</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">CIBA Flow実装ガイド</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>CIBA Flow実装ガイド</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="このドキュメントの目的">このドキュメン トの目的<a href="#このドキュメントの目的" class="hash-link" aria-label="このドキュメントの目的 への直接リンク" title="このドキュメントの目的 への直接リンク">​</a></h2>
<p>**CIBA（Client Initiated Backchannel Authentication）**の実装を理解することが目標です。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="所要時間">所要時間<a href="#所要時間" class="hash-link" aria-label="所要時間 への直接リンク" title="所要時間 への直接リンク">​</a></h3>
<p>⏱️ <strong>約30分</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="前提知識">前提知識<a href="#前提知識" class="hash-link" aria-label="前提知識 への直接リンク" title="前提知識 への直接リンク">​</a></h3>
<ul>
<li><a href="/idp-server/docs/content_06_developer-guide/application-plane/authorization-flow">02. Authorization Flow</a></li>
<li><a href="/idp-server/docs/content_06_developer-guide/application-plane/token-endpoint">03. Token Flow</a></li>
<li>CIBA仕様基礎知識</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cibaとは">CIBAとは<a href="#cibaとは" class="hash-link" aria-label="CIBAとは への直接リンク" title="CIBAとは への直接リンク">​</a></h2>
<p><strong>バックチャネル認証</strong> - ユーザーがログインデバイスとは別のデバイス（スマホ等）で認証を承認する方式。</p>
<p><strong>OpenID Connect CIBA Core 1.0準拠</strong></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="通常のauthorization-code-flowとの違い">通常のAuthorization Code Flowとの違い<a href="#通常のauthorization-code-flowとの違い" class="hash-link" aria-label="通常のAuthorization Code Flowとの違い への直接リンク" title="通常のAuthorization Code Flowとの違い への直接リンク">​</a></h2>
<table><thead><tr><th>項目</th><th>Authorization Code Flow</th><th>CIBA</th></tr></thead><tbody><tr><td><strong>認証デバイス</strong></td><td>ブラウザ（同じデバイス）</td><td>スマホ等（別デバイス）</td></tr><tr><td><strong>リダイレクト</strong></td><td>あり（ブラウザリダイレクト）</td><td>なし</td></tr><tr><td><strong>ユーザー操作</strong></td><td>ブラウザでログイン</td><td>スマホでプッシュ通知承認</td></tr><tr><td><strong>ポーリング</strong></td><td>なし</td><td>あり（またはPing/Push）</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="アーキテクチャ全体像">アーキテクチャ全体像<a href="#アーキテクチャ全体像" class="hash-link" aria-label="アーキテクチャ全体像 への直接リンク" title="アーキテクチャ全体像 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="30秒で理解する全体像">30秒で理解する全体像<a href="#30秒で理解する全体像" class="hash-link" aria-label="30秒で理解する全体像 への直接リンク" title="30秒で理解する全体像 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HTTPリクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Controller (CibaV1Api) - HTTP処理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EntryService (CibaFlowEntryService) - オーケストレーション</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ Tenant取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ CibaRequest作成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ CibaProtocol.request()（UserHintResolver使用）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ AuthenticationTransaction作成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ デフォルト認証実行（プッシュ通知）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ イベント発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └─ auth_req_id返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Core層 (CibaProtocol)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ Validator: 入力形式チェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ UserHintResolver: login_hint → User解決</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ Verifier: ビジネスルール検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └─ BackchannelAuthenticationRequest生成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">プッシュ通知 → ユーザー承認 → トークン発行（Token Flow）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリッ  プボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラスの責務">主要クラスの責務<a href="#主要クラスの責務" class="hash-link" aria-label="主要クラスの責務 への直接リンク" title="主要クラスの責務 への直接リンク">​</a></h3>
<table><thead><tr><th>クラス</th><th>層</th><th>役割</th><th>実装</th></tr></thead><tbody><tr><td><strong>CibaV1Api</strong></td><td>Controller</td><td>HTTPエンドポイント</td><td><a href="/idp-server/assets/files/CibaV1Api-652890e35e8522bdfbf3c060394e6c33.java" target="_blank">CibaV1Api.java</a></td></tr><tr><td><strong>CibaFlowEntryService</strong></td><td>UseCase</td><td>トランザクション・オーケストレーション</td><td><a href="/idp-server/assets/files/CibaFlowEntryService-145a1d284c281445c1e47836aa3b12be.java#L86-L142" target="_blank">CibaFlowEntryService.java:86-142</a></td></tr><tr><td><strong>CibaProtocol</strong></td><td>Core</td><td>CIBA仕様準拠処理</td><td>Extension Core</td></tr><tr><td><strong>UserHintResolver</strong></td><td>Core</td><td>login_hint → User解決（Plugin）</td><td>Extension Core</td></tr><tr><td><strong>BackchannelAuthenticationRequest</strong></td><td>Core</td><td>CIBA認証リクエスト（5分TTL）</td><td>Extension Core</td></tr><tr><td><strong>AuthenticationTransaction</strong></td><td>Core</td><td>認証状態管理</td><td>Core Domain</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="cibaの特徴">CIBAの特徴<a href="#cibaの特徴" class="hash-link" aria-label="CIBAの特徴 への直接リンク" title="CIBAの特徴 への直接リンク">​</a></h3>
<p><strong>Authorization Code Flowとの違い</strong>:</p>
<ul>
<li>❌ <strong>リダイレクトなし</strong>: ユーザーは別デバイスで承認</li>
<li>✅ <strong>auth_req_id</strong>: Authorization Codeの代わり</li>
<li>✅ <strong>ポーリング</strong>: クライアントが定期的にトークンリクエスト</li>
<li>✅ <strong>プッシュ通知</strong>: FCM/APNS/SMSでユーザーに通知</li>
<li>✅ <strong>非同期</strong>: 認証リクエストとトークン取得が分離</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="cibaフロー">CIBAフロー<a href="#cibaフロー" class="hash-link" aria-label="CIBAフロー への直接リンク" title="CIBAフロー への直接リンク">​</a></h2>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. [クライアント] CIBA認証リクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/backchannel/authentications</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;login_hint&quot;: &quot;user@example.com&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;binding_message&quot;: &quot;Code: 1234&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;client_notification_token&quot;: &quot;xxx&quot;  // Push mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. [idp-server] auth_req_id返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;auth_req_id&quot;: &quot;auth-req-abc123&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;expires_in&quot;: 300,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;interval&quot;: 5  // Poll mode</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. [idp-server] ユーザーにプッシュ通知送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FCM/APNS → [ユーザーのスマホ]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">「Code: 1234でログイン承認しますか？」</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. [ユーザー] スマホで承認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. [idp-server] 認証完了を記録</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">6. [クライアント] トークンリクエスト（ポーリング）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;grant_type&quot;: &quot;urn:openid:params:grant-type:ciba&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;auth_req_id&quot;: &quot;auth-req-abc123&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;client_id&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;client_secret&quot;: &quot;yyy&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">7. [idp-server] Access Token + ID Token発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;access_token&quot;: &quot;eyJ...&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id_token&quot;: &quot;eyJ...&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;token_type&quot;: &quot;Bearer&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="エンドポイント">エンドポイント<a href="#エンドポイント" class="hash-link" aria-label="エンドポイント への直接リンク" title="エンドポイント への直接リンク">​</a></h2>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># CIBA認証リクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/backchannel/authentications</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># トークン取得（ポーリング）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;grant_type&quot;: &quot;urn:openid:params:grant-type:ciba&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;auth_req_id&quot;: &quot;xxx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>実装</strong>:</p>
<ul>
<li><a href="/idp-server/assets/files/CibaV1Api-652890e35e8522bdfbf3c060394e6c33.java" target="_blank">CibaV1Api.java</a></li>
<li><a href="/idp-server/assets/files/CibaFlowEntryService-145a1d284c281445c1e47836aa3b12be.java" target="_blank">CibaFlowEntryService.java</a></li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="entryservice実装">EntryService実装<a href="#entryservice実装" class="hash-link" aria-label="EntryService実装 への直接リンク" title="EntryService実装 への直接リンク">​</a></h2>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/CibaFlowEntryService-145a1d284c281445c1e47836aa3b12be.java#L86-L142" target="_blank">CibaFlowEntryService.java:86-142</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ciba認証リクエスト処理10ステップ">CIBA認証リクエスト処理（10ステップ）<a href="#ciba認証リクエスト処理10ステップ" class="hash-link" aria-label="CIBA認証リクエスト処理（10ステップ） への直接リンク" title="CIBA認証リクエスト処理（10ステップ） への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class CibaFlowEntryService implements CibaFlowApi {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CibaProtocols cibaProtocols;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UserHintResolvers userHintResolvers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationInteractors authenticationInteractors;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CibaRequestAdditionalVerifiers additionalVerifiers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TenantQueryRepository tenantQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationTransactionCommandRepository authenticationTransactionCommandRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationPolicyConfigurationQueryRepository authenticationPolicyConfigurationQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CibaFlowEventPublisher eventPublisher;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public CibaRequestResponse request(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TenantIdentifier tenantIdentifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Map&lt;String, String[]&gt; params,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      String authorizationHeader,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      String clientCert,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      RequestAttributes requestAttributes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. Tenant取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. CibaRequest作成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CibaRequest cibaRequest = new CibaRequest(tenant, authorizationHeader, params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cibaRequest.setClientCert(clientCert);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3. CibaProtocol取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CibaProtocol cibaProtocol = cibaProtocols.get(tenant.authorizationProvider());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4. Core層に委譲（UserHintResolver + AdditionalVerifiers使用）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CibaIssueResponse issueResponse =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        cibaProtocol.request(cibaRequest, userHintResolvers, additionalVerifiers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 5. エラー時は即座に返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!issueResponse.isOK()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return issueResponse.toErrorResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 6. イベント発行（CIBA認証リクエスト成功）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eventPublisher.publish(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        issueResponse.request(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        issueResponse.user(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        DefaultSecurityEventType.backchannel_authentication_request_success.toEventType(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestAttributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 7. AuthenticationPolicyConfiguration取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationPolicyConfiguration authenticationPolicyConfiguration =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authenticationPolicyConfigurationQueryRepository.find(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tenant, StandardAuthFlow.CIBA.toAuthFlow());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 8. AuthenticationTransaction作成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationTransaction authenticationTransaction =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CibaAuthenticationTransactionCreator.create(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tenant, issueResponse, authenticationPolicyConfiguration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 9. デフォルト認証実行（プッシュ通知送信）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationInteractionType authenticationInteractionType =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        issueResponse.defaultCibaAuthenticationInteractionType();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationInteractor authenticationInteractor =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authenticationInteractors.get(authenticationInteractionType);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationInteractionRequestResult interactionRequestResult =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authenticationInteractor.interact(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            authenticationTransaction,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            authenticationInteractionType,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new AuthenticationInteractionRequest(Map.of()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requestAttributes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            userQueryRepository);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 10. AuthenticationTransaction保存 + イベント発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationTransaction updatedTransaction =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authenticationTransaction.updateWith(interactionRequestResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    authenticationTransactionCommandRepository.register(tenant, updatedTransaction);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eventPublisher.publish(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        issueResponse.request(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        issueResponse.user(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        interactionRequestResult.eventType(),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestAttributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return issueResponse.toResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ポイント">ポイント<a href="#ポイント" class="hash-link" aria-label="ポイント への直接リンク" title="ポイント への直接リンク">​</a></h3>
<ul>
<li>✅ <strong>UserHintResolvers</strong>: login_hint（email/phone/sub）からUserを解決（Plugin拡張可能）</li>
<li>✅ <strong>CibaRequestAdditionalVerifiers</strong>: CIBA固有の検証（パスワード必須等）</li>
<li>✅ <strong>デフォルト認証実行</strong>: CIBA認証リクエスト時点でプッシュ通知を送信</li>
<li>✅ <strong>AuthenticationTransaction</strong>: 認証状態を管理（ユーザー承認待ち）</li>
<li>✅ <strong>イベント発行</strong>: 2回（リクエスト成功・プッシュ通知送信）</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="userhintresolverslogin_hint解決">UserHintResolvers（login_hint解決）<a href="#userhintresolverslogin_hint解決" class="hash-link" aria-label="UserHintResolvers（login_hint解決） への直接リンク" title="UserHintResolvers（login_hint解決） への直接リンク">​</a></h2>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/UserHintResolvers-76b8edb7b5b28c5c80d6ba5561fa97a9.java" target="_blank">UserHintResolvers.java</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="login_hintの形式">login_hintの形式<a href="#login_hintの形式" class="hash-link" aria-label="login_hintの形式 への直接リンク" title="login_hintの形式 への直接リンク">​</a></h3>
<p>CIBAでは<code>login_hint</code>パラメータでユーザーを特定します。複数の形式をサポート：</p>
<table><thead><tr><th>プレフィックス</th><th>形式</th><th>例</th><th>検索方法</th></tr></thead><tbody><tr><td><code>sub:</code></td><td>idp-server内部のユーザーID</td><td><code>sub:user-uuid-12345</code></td><td>UserIdentifierで直接取得</td></tr><tr><td><code>email:</code></td><td>メールアドレス</td><td><code>email:user@example.com</code></td><td>emailで検索</td></tr><tr><td><code>phone:</code></td><td>電話番号</td><td><code>phone:+81-90-1234-5678</code></td><td>phone_numberで検索</td></tr><tr><td><code>ex-sub:</code></td><td>外部IdPのsub</td><td><code>ex-sub:google-user-12345:google</code></td><td>external_user_id + provider_idで検索</td></tr><tr><td><code>device:</code></td><td>デバイスID</td><td><code>device:device-uuid-67890</code></td><td>authentication_device.idで検索</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="loginhintresolverの実装">LoginHintResolverの実装<a href="#loginhintresolverの実装" class="hash-link" aria-label="LoginHintResolverの実装 への直接リンク" title="LoginHintResolverの実装 への直接リンク">​</a></h3>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/LoginHintResolver-5c4587e9f8609c71c227457c74f81289.java#L27-L76" target="_blank">LoginHintResolver.java:27-76</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class LoginHintResolver implements UserHintResolver {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public User resolve(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Tenant tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UserHint userHint,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UserHintRelatedParams userHintRelatedParams,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      UserQueryRepository userQueryRepository) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String loginHint = userHint.value();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // プレフィックスマッチャー（5種類）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    List&lt;LoginHintMatcher&gt; matchers = List.of(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 1. sub:user-uuid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new PrefixMatcher(&quot;sub:&quot;, hints -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          UserIdentifier userIdentifier = new UserIdentifier(hints.getLeft());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          return userQueryRepository.get(tenant, userIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        }),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 2. ex-sub:external-sub:provider-id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new PrefixMatcher(&quot;ex-sub:&quot;, hints -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            userQueryRepository.findByExternalIdpSubject(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tenant, hints.getLeft(), hints.getRight())),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 3. device:device-id:provider-id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new PrefixMatcher(&quot;device:&quot;, hints -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            userQueryRepository.findByDeviceId(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                new AuthenticationDeviceIdentifier(hints.getLeft()),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                hints.getRight())),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 4. phone:+81-90-1234-5678:provider-id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new PrefixMatcher(&quot;phone:&quot;, hints -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            userQueryRepository.findByPhone(tenant, hints.getLeft(), hints.getRight())),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 5. email:user@example.com:provider-id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new PrefixMatcher(&quot;email:&quot;, hints -&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            userQueryRepository.findByEmail(tenant, hints.getLeft(), hints.getRight()))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 最初にマッチしたResolverでUser解決</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return matchers.stream()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .filter(matcher -&gt; matcher.matches(loginHint))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .findFirst()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .map(matcher -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          Pairs&lt;String, String&gt; hints = matcher.extractHints(loginHint);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          return matcher.resolve(hints);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        })</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .orElse(User.notFound());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用例">使用例<a href="#使用例" class="hash-link" aria-label="使用例 への直接リンク" title="使用例 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-emailでユーザー特定">1. emailでユーザー特定<a href="#1-emailでユーザー特定" class="hash-link" aria-label="1. emailでユーザー特定 への直接リンク" title="1. emailでユーザー特定 への直接リンク">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/backchannel/authentications&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Authorization: Basic $(echo -n &#x27;client:secret&#x27; | base64)&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;login_hint=email:user@example.com&amp;binding_message=Code: 1234&amp;scope=openid&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>処理</strong>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">login_hint=&quot;email:user@example.com&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">PrefixMatcher(&quot;email:&quot;).matches() → true</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">extractHints() → (&quot;user@example.com&quot;, &quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">userQueryRepository.findByEmail(tenant, &quot;user@example.com&quot;, &quot;&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User取得</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-phone番号でユーザー特定">2. phone番号でユーザー特定<a href="#2-phone番号でユーザー特定" class="hash-link" aria-label="2. phone番号でユーザー特定 への直接リンク" title="2. phone番号でユーザー特定 への直接リンク">​</a></h4>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;...&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;login_hint=phone:+81-90-1234-5678&amp;binding_message=Code: 1234&amp;scope=openid&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-デバイスidでユーザー特定">3. デバイスIDでユーザー特定<a href="#3-デバイスidでユーザー特定" class="hash-link" aria-label="3. デバイスIDでユーザー特定 への直接リンク" title="3. デバイスIDでユーザー特定 への直接リンク">​</a></h4>
<p>スマホアプリのデバイスIDを使用：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;...&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;login_hint=device:device-uuid-67890&amp;binding_message=Code: 1234&amp;scope=openid&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-外部idpのsubでユーザー特定">4. 外部IdPのsubでユーザー特定<a href="#4-外部idpのsubでユーザー特定" class="hash-link" aria-label="4. 外部IdPのsubでユーザー特定 への直接リンク" title="4. 外部IdPのsubでユーザー特定 への直接リンク">​</a></h4>
<p>Google等の外部IdPで既に認証済みのユーザー：</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;...&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;login_hint=ex-sub:google-user-12345:google&amp;binding_message=Code: 1234&amp;scope=openid&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="エラー">エラー<a href="#エラー" class="hash-link" aria-label="エラー への直接リンク" title="エラー への直接リンク">​</a></h3>
<p><strong>ユーザ ーが見つからない場合</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;invalid_request&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error_description&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;User not found for login_hint: email:unknown@example.com&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>HTTP Status</strong>: <code>400 Bad Request</code></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ciba-mode">CIBA Mode<a href="#ciba-mode" class="hash-link" aria-label="CIBA Mode への直接リンク" title="CIBA Mode への直接リンク">​</a></h2>
<p>CIBAは3つのモードをサポート：</p>
<table><thead><tr><th>Mode</th><th>説明</th><th>トークン取得方法</th></tr></thead><tbody><tr><td><strong>Poll</strong></td><td>ポーリング</td><td>クライアントが定期的にトークンリクエスト</td></tr><tr><td><strong>Ping</strong></td><td>Ping通知</td><td>idp-serverがclient_notification_endpointに通知</td></tr><tr><td><strong>Push</strong></td><td>プッシュ</td><td>idp-serverがclient_notification_endpointにトークン送信</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="poll-mode最も一般的">Poll Mode（最も一般的）<a href="#poll-mode最も一般的" class="hash-link" aria-label="Poll Mode（最も一般的） への直接リンク" title="Poll Mode（最も一般的） への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. CIBA Request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓ レスポンス</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;auth_req_id&quot;: &quot;xxx&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;expires_in&quot;: 300,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;interval&quot;: 5  // 5秒ごとにポーリング</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. クライアントがポーリング（5秒ごと）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;grant_type&quot;: &quot;urn:openid:params:grant-type:ciba&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;auth_req_id&quot;: &quot;xxx&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓ ユーザー未承認時</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;error&quot;: &quot;authorization_pending&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   ↓ ユーザー承認完了後</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;access_token&quot;: &quot;eyJ...&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;id_token&quot;: &quot;eyJ...&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="クライアント認証">クライアント認証<a href="#クライアント認証" class="hash-link" aria-label="クライアント認証 への直接リンク" title="クライアント認証 への直接リンク">​</a></h2>
<p>CIBA認証リクエストでは<strong>クライアント認証が必須</strong>です。</p>
<p><strong>詳細</strong>: <a href="/idp-server/docs/content_06_developer-guide/application-plane/client-authentication">10. Client Authentication実装</a> - 7つの認証方式の完全ガイド</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="サポートされる認証方式">サポートされる認証方式<a href="#サポートされる認証方式" class="hash-link" aria-label="サポートされる認証方式 への直接リンク" title="サポートされる認証方式 への直接リンク">​</a></h3>
<table><thead><tr><th>認証方式</th><th>送信方法</th><th>セキュリティレベル</th></tr></thead><tbody><tr><td><strong>client_secret_basic</strong></td><td>Basic認証ヘッダー</td><td>⭐⭐</td></tr><tr><td><strong>client_secret_post</strong></td><td>POSTボディ</td><td>⭐</td></tr><tr><td><strong>client_secret_jwt</strong></td><td>JWT署名（共有鍵）</td><td>⭐⭐⭐</td></tr><tr><td><strong>private_key_jwt</strong></td><td>JWT署名（秘密鍵）</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>tls_client_auth</strong></td><td>クライアント証明書（MTLS）</td><td>⭐⭐⭐⭐⭐</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="client_secret_basic-の例">client_secret_basic の例<a href="#client_secret_basic-の例" class="hash-link" aria-label="client_secret_basic の例 への直接リンク" title="client_secret_basic の例 への直接リンク">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/backchannel/authentications&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Authorization: Basic $(echo -n &#x27;my-client:my-secret&#x27; | base64)&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;login_hint=user@example.com&amp;binding_message=Code: 1234&amp;scope=openid profile&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="client_secret_post-の例">client_secret_post の例<a href="#client_secret_post-の例" class="hash-link" aria-label="client_secret_post の例 への直接リンク" title="client_secret_post の例 への直接リンク">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/backchannel/authentications&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;login_hint=user@example.com&amp;binding_message=Code: 1234&amp;scope=openid profile&amp;client_id=my-client&amp;client_secret=my-secret&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="トークンリクエストciba-grant-type">トークンリクエスト（CIBA Grant Type）<a href="#トークンリクエストciba-grant-type" class="hash-link" aria-label="トークンリクエスト（CIBA Grant Type） への直接リンク" title="トークンリクエスト（CIBA Grant Type） への直接リンク">​</a></h2>
<p><strong>実装</strong>: <a href="/libs/idp-server-core-extension-ciba/src/main/java/org/idp/server/core/extension/ciba/grant/CibaGrantService.java">CibaGrantService.java</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="リクエスト">リクエスト<a href="#リクエスト" class="hash-link" aria-label="リクエスト への直接リンク" title="リクエスト への直接リンク">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/x-www-form-urlencoded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Basic base64(client_id:client_secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">grant_type=urn:openid:params:grant-type:ciba&amp;auth_req_id=8d67dc78-7faa-4d41-aabd-67707b374255</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="処理フロー">処理フロー<a href="#処理フロー" class="hash-link" aria-label="処理フロー への直接リンク" title="処理フロー への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CibaGrantService.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 1. Validator（入力形式チェック）                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - auth_req_id必須チェック                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - grant_type検証                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 2. BackchannelAuthenticationRequest取得              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - auth_req_idでBackchannelAuthenticationRequest検索 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 存在しない → invalid_grant エラー                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 3. Verifier（ビジネスルール検証）                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 有効期限チェック（5分以内）                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - クライアント一致チェック                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ユーザー承認済みチェック                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 4. 承認状態チェック                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 承認待ち → authorization_pending                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ユーザー拒否 → access_denied                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 承認完了 → トークン発行へ                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓ 承認完了の場合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 5. トークン生成                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - Access Token生成（JWT、デフォルト1時間有効）        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - Refresh Token生成（設定による）                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ID Token生成（nonce/at_hash/c_hash含む）          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - BackchannelAuthenticationRequest削除（ワンタイム）  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OAuthToken（Access/Refresh/ID Token）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="レスポンスパターン">レスポンスパターン<a href="#レスポンスパターン" class="hash-link" aria-label="レスポンスパターン への直接リンク" title="レスポンスパターン への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-承認待ちauthorization_pending">1. 承認待ち（authorization_pending）<a href="#1-承認待ちauthorization_pending" class="hash-link" aria-label="1. 承認待ち（authorization_pending） への直接リンク" title="1. 承認待ち（authorization_pending） への直接リンク">​</a></h4>
<p>ユーザーがまだスマホで承認していない状態：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;authorization_pending&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error_description&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The authorization request is still pending&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>HTTP Status</strong>: <code>400 Bad Request</code></p>
<p><strong>対処</strong>: <code>interval</code>秒待機してリトライ（デフォルト5秒）</p>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-承認完了トークン発行">2. 承認完了（トークン発行）<a href="#2-承認完了トークン発行" class="hash-link" aria-label="2. 承認完了（トークン発行） への直接リンク" title="2. 承認完了（トークン発行） への直接リンク">​</a></h4>
<p>ユーザーがスマホで承認した後：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;access_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;token_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Bearer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;expires_in&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3600</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;refresh_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;id_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;scope&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;openid profile email&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>HTTP Status</strong>: <code>200 OK</code></p>
<p><strong>重要</strong>: auth_req_idは削除される（ワンタイム使用）</p>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-ユーザー拒否access_denied">3. ユーザー拒否（access_denied）<a href="#3-ユーザー拒否access_denied" class="hash-link" aria-label="3. ユーザー拒否（access_denied） への直接リンク" title="3. ユーザー拒否（access_denied） への直接リンク">​</a></h4>
<p>ユーザーがスマホで拒否ボタンを押した場合：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;access_denied&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error_description&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The resource owner denied the request&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>HTTP Status</strong>: <code>400 Bad Request</code></p>
<p><strong>対処</strong>: 新しいCIBA認証リクエストを実行</p>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-タイムアウトexpired_token">4. タイムアウト（expired_token）<a href="#4-タイムアウトexpired_token" class="hash-link" aria-label="4. タイムアウト（expired_token） への直接リンク" title="4. タイムアウト（expired_token） への直接リンク">​</a></h4>
<p>auth_req_idの有効期限（5分）が切れた場合：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;expired_token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error_description&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;The auth_req_id has expired&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>HTTP Status</strong>: <code>400 Bad Request</code></p>
<p><strong>対処</strong>: 新しいCIBA認証リクエストを実行</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ポーリング仕様openid-connect-ciba準拠">ポーリング仕様（OpenID Connect CIBA準拠）<a href="#ポーリング仕様openid-connect-ciba準拠" class="hash-link" aria-label="ポーリング仕様（OpenID Connect CIBA準拠） への直接リンク" title="ポーリング仕様（OpenID Connect CIBA準拠） への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="intervalポーリング間隔">interval（ポーリング間隔）<a href="#intervalポーリング間隔" class="hash-link" aria-label="interval（ポーリング間隔） への直接リンク" title="interval（ポーリング間隔） への直接リンク">​</a></h3>
<p>CIBA認証リクエストのレスポンスで返される<code>interval</code>を厳守：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;auth_req_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;expires_in&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;interval&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// この秒数ごとにポーリング</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>RFC仕様</strong>:</p>
<ul>
<li>クライアントは<strong>最低でも<code>interval</code>秒</strong>待機してからリトライ</li>
<li>interval未満でリクエスト → <code>slow_down</code>エラー</li>
<li><code>slow_down</code>受信時 → intervalを5秒延長</li>
</ul>
<p><strong>例</strong>: interval=5の場合</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">0秒: CIBA認証リクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5秒: 1回目のトークンリクエ スト → authorization_pending</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">10秒: 2回目のトークンリクエスト → authorization_pending</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">15秒: 3回目のトークンリクエスト → トークン発行成功</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="expires_in有効期限">expires_in（有効期限）<a href="#expires_in有効期限" class="hash-link" aria-label="expires_in（有効期限） への直接リンク" title="expires_in（有効期限） への直接リンク">​</a></h3>
<p>auth_req_idは<code>expires_in</code>秒間のみ有効：</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;auth_req_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;xxx&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;expires_in&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">300</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 300秒 = 5分間有効</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>動作</strong>:</p>
<ul>
<li>5分以内にユーザー承認 → トークン発行可能</li>
<li>5分経過後 → <code>expired_token</code>エラー</li>
<li>トークン発行後 → auth_req_id削除（再利用不可）</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="auth_req_id-のライフサイクル">auth_req_id のライフサイクル<a href="#auth_req_id-のライフサイクル" class="hash-link" aria-label="auth_req_id のライフサイクル への直接リンク" title="auth_req_id のライフサイクル への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="作成--使用--削除">作成 → 使用 → 削除<a href="#作成--使用--削除" class="hash-link" aria-label="作成 → 使用 → 削除 への直接リンク" title="作成 → 使用 → 削除 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. CIBA認証リクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → BackchannelAuthenticationRequest作成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → auth_req_id生成（UUID）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → Redis + DB保存（5分TTL）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. ユーザー承認待ち</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → ポーリング: authorization_pending</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → AuthenticationTransaction更新（承認状態）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. トークンリクエスト（承認完了後）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → BackchannelAuthenticationRequest取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → トークン生成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → BackchannelAuthenticationRequest削除  ← ワンタイム</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 再度トークンリクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → BackchannelAuthenticationRequest不存在</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → invalid_grant エラー</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要</strong>: Authorization Codeと同じく、<strong>使用後即削除</strong>される（<code>used</code>フラグではない）</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="backchannelauthenticationrequest-vs-authenticationtransaction">BackchannelAuthenticationRequest vs AuthenticationTransaction<a href="#backchannelauthenticationrequest-vs-authenticationtransaction" class="hash-link" aria-label="BackchannelAuthenticationRequest vs AuthenticationTransaction への直接リンク" title="BackchannelAuthenticationRequest vs AuthenticationTransaction への直接リンク">​</a></h2>
<p>2つの異なるオブジェクトが使われます：</p>
<table><thead><tr><th>オブジェクト</th><th>役割</th><th>作成タイミング</th><th>削除タイミング</th></tr></thead><tbody><tr><td><strong>BackchannelAuthenticationRequest</strong></td><td>CIBA認証リクエスト情報</td><td>CIBA認証リクエスト時</td><td>トークン発行後</td></tr><tr><td><strong>AuthenticationTransaction</strong></td><td>認証状態管理</td><td>CIBA認証リクエスト時</td><td>認証完了 or 失敗 or ロック時</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="backchannelauthenticationrequest">BackchannelAuthenticationRequest<a href="#backchannelauthenticationrequest" class="hash-link" aria-label="BackchannelAuthenticationRequest への直接リンク" title="BackchannelAuthenticationRequest への直接リンク">​</a></h3>
<p><strong>保存される情報</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- auth_req_id: UUID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- client_id: クライアントID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- login_hint: ユーザーヒント</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- binding_message: &quot;Code: 1234&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- scope: &quot;openid profile email&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- expiresAt: 現在時刻+5分</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>用途</strong>: トークンリクエスト時の検証（クライアント一致・有効期限等）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authenticationtransaction">AuthenticationTransaction<a href="#authenticationtransaction" class="hash-link" aria-label="AuthenticationTransaction への直接リンク" title="AuthenticationTransaction への直接リンク">​</a></h3>
<p><strong>保存される情報</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">- identifier: auth-req-12345</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- authorizationIdentifier: auth-req-12345</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- authenticationPolicy: 認証ポリシー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- interactionResults: {&quot;push_notification&quot;: {successCount: 0, attemptCount: 1}}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- request.user: User(sub=user-12345)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>用途</strong>: ユーザー承認状態の管理（承認待ち・承認完了・拒否）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使い分け">使い分け<a href="#使い分け" class="hash-link" aria-label="使い分け への直接リンク" title="使い分け への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">CIBA認証リクエスト:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  BackchannelAuthenticationRequest作成（auth_req_id発行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationTransaction作成（認証状態管理）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ユーザー承認:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationTransaction更新（interactionResults更新）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">トークンリクエスト:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  BackchannelAuthenticationRequest検証（有効期限・クライアント）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationTransaction確認（承認済みか）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  トークン発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  BackchannelAuthenticationRequest削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationTransaction削除</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="チェックリスト">チェックリスト<a href="#チェックリスト" class="hash-link" aria-label="チェックリスト への直接リンク" title="チェックリスト への直接リンク">​</a></h2>
<p>CIBA実装時の確認項目：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="entryserviceusecase層">EntryService（UseCase層）<a href="#entryserviceusecase層" class="hash-link" aria-label="EntryService（UseCase層） への直接リンク" title="EntryService（UseCase層） への直接リンク">​</a></h3>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->CibaRequest作成</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->UserHintResolvers使用（login_hint解決）</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->AuthenticationTransaction作成</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->プッシュ通知送信</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="core層cibaprotocol">Core層（CibaProtocol）<a href="#core層cibaprotocol" class="hash-link" aria-label="Core層（CibaProtocol） への直接リンク" title="Core層（CibaProtocol） への直接リンク">​</a></h3>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->login_hint検証</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->binding_message検証</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->BackchannelAuthenticationRequest生成</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="e2eテスト">E2Eテスト<a href="#e2eテスト" class="hash-link" aria-label="E2Eテスト への直接リンク" title="E2Eテスト への直接リンク">​</a></h3>
<ul class="contains-task-list containsTaskList_mC6p">
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->Poll modeテスト</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->ユーザー承認テスト</li>
<li class="task-list-item"><input type="checkbox" disabled=""> <!-- -->ユーザー拒否テスト</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="よくあるエラー">よくあるエラー<a href="#よくあるエラー" class="hash-link" aria-label="よくあるエラー への直接リンク" title="よくあるエラー への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="エラー1-authorization_pending---認証待ち">エラー1: <code>authorization_pending</code> - 認証待ち<a href="#エラー1-authorization_pending---認証待ち" class="hash-link" aria-label="エラー1-authorization_pending---認証待ち への直接リンク" title="エラー1-authorization_pending---認証待ち への直接リンク">​</a></h3>
<p><strong>原因</strong>: ユーザーがまだ承認していない</p>
<p><strong>解決策</strong>: ポーリング継続（interval秒待機）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="エラー2-access_denied---ユーザーが拒否">エラー2: <code>access_denied</code> - ユーザーが拒否<a href="#エラー2-access_denied---ユーザーが拒否" class="hash-link" aria-label="エラー2-access_denied---ユーザーが拒否 への直接リンク" title="エラー2-access_denied---ユーザーが拒否 への直接リンク">​</a></h3>
<p><strong>原因</strong>: ユーザーがスマホで拒否ボタンを押した</p>
<p><strong>解決策</strong>: 新しいCIBA認証リクエストを実行</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="次のステップ">次のステップ<a href="#次のステップ" class="hash-link" aria-label="次のステップ への直接リンク" title="次のステップ への直接リンク">​</a></h2>
<p>✅ CIBA Flowの実装を理解した！</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-次に読むべきドキュメント">📖 次に読むべきドキュメント<a href="#-次に読むべきドキュメント" class="hash-link" aria-label="📖 次に読むべきドキュメント への直接リンク" title="📖 次に読むべきドキュメント への直接リンク">​</a></h3>
<ol>
<li><a href="/idp-server/docs/content_06_developer-guide/application-plane/identity-verification">07. Identity Verification実装</a> - 身元確認申込み</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-詳細情報">🔗 詳細情報<a href="#-詳細情報" class="hash-link" aria-label="🔗 詳細情報 への直接リンク" title="🔗 詳細情報 への直接リンク">​</a></h3>
<ul>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-31-extension-ciba">AI開発者向け: CIBA Extension</a></li>
<li><a href="https://openid.net/specs/openid-client-initiated-backchannel-authentication-core-1_0.html" target="_blank" rel="noopener noreferrer">OpenID Connect CIBA Core 1.0</a></li>
</ul>
<hr>
<p><strong>情報源</strong>: <a href="/idp-server/assets/files/CibaFlowEntryService-145a1d284c281445c1e47836aa3b12be.java" target="_blank">CibaFlowEntryService.java</a>
<strong>最終更新</strong>: 2025-10-12</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_06_developer-guide/03-application-plane/06-ciba-flow.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_06_developer-guide/application-plane/userinfo"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">UserInfo実装ガイド</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_06_developer-guide/application-plane/identity-verification"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">身元確認申込み実装ガイド</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#このドキュメントの目的" class="table-of-contents__link toc-highlight">このドキュメントの目的</a><ul><li><a href="#所要時間" class="table-of-contents__link toc-highlight">所要時間</a></li><li><a href="#前提知識" class="table-of-contents__link toc-highlight">前提知識</a></li></ul></li><li><a href="#cibaとは" class="table-of-contents__link toc-highlight">CIBAとは</a></li><li><a href="#通常のauthorization-code-flowとの違い" class="table-of-contents__link toc-highlight">通常のAuthorization Code Flowとの違い</a></li><li><a href="#アーキテクチャ全体像" class="table-of-contents__link toc-highlight">アーキテクチャ全体像</a><ul><li><a href="#30秒で理解する全体像" class="table-of-contents__link toc-highlight">30秒で理解する全体像</a></li><li><a href="#主要クラスの責務" class="table-of-contents__link toc-highlight">主要クラスの責務</a></li><li><a href="#cibaの特徴" class="table-of-contents__link toc-highlight">CIBAの特徴</a></li></ul></li><li><a href="#cibaフロー" class="table-of-contents__link toc-highlight">CIBAフロー</a></li><li><a href="#エンドポイント" class="table-of-contents__link toc-highlight">エンドポイント</a></li><li><a href="#entryservice実装" class="table-of-contents__link toc-highlight">EntryService実装</a><ul><li><a href="#ciba認証リクエスト処理10ステップ" class="table-of-contents__link toc-highlight">CIBA認証リクエスト処理（10ステップ）</a></li><li><a href="#ポイント" class="table-of-contents__link toc-highlight">ポイント</a></li></ul></li><li><a href="#userhintresolverslogin_hint解決" class="table-of-contents__link toc-highlight">UserHintResolvers（login_hint解決）</a><ul><li><a href="#login_hintの形式" class="table-of-contents__link toc-highlight">login_hintの形式</a></li><li><a href="#loginhintresolverの実装" class="table-of-contents__link toc-highlight">LoginHintResolverの実装</a></li><li><a href="#使用例" class="table-of-contents__link toc-highlight">使用例</a></li><li><a href="#エラー" class="table-of-contents__link toc-highlight">エラー</a></li></ul></li><li><a href="#ciba-mode" class="table-of-contents__link toc-highlight">CIBA Mode</a><ul><li><a href="#poll-mode最も一般的" class="table-of-contents__link toc-highlight">Poll Mode（最も一般的）</a></li></ul></li><li><a href="#クライアント認証" class="table-of-contents__link toc-highlight">クライアント認証</a><ul><li><a href="#サポートされる認証方式" class="table-of-contents__link toc-highlight">サポートされる認証方式</a></li><li><a href="#client_secret_basic-の例" class="table-of-contents__link toc-highlight">client_secret_basic の例</a></li><li><a href="#client_secret_post-の例" class="table-of-contents__link toc-highlight">client_secret_post の例</a></li></ul></li><li><a href="#トークンリクエストciba-grant-type" class="table-of-contents__link toc-highlight">トークンリクエスト（CIBA Grant Type）</a><ul><li><a href="#リクエスト" class="table-of-contents__link toc-highlight">リクエスト</a></li><li><a href="#処理フロー" class="table-of-contents__link toc-highlight">処理フロー</a></li><li><a href="#レスポンスパターン" class="table-of-contents__link toc-highlight">レスポンスパターン</a></li></ul></li><li><a href="#ポーリング仕様openid-connect-ciba準拠" class="table-of-contents__link toc-highlight">ポーリング仕様（OpenID Connect CIBA準拠）</a><ul><li><a href="#intervalポーリング間隔" class="table-of-contents__link toc-highlight">interval（ポーリング間隔）</a></li><li><a href="#expires_in有効期限" class="table-of-contents__link toc-highlight">expires_in（有効期限）</a></li></ul></li><li><a href="#auth_req_id-のライフサイクル" class="table-of-contents__link toc-highlight">auth_req_id のライフサイクル</a><ul><li><a href="#作成--使用--削除" class="table-of-contents__link toc-highlight">作成 → 使用 → 削除</a></li></ul></li><li><a href="#backchannelauthenticationrequest-vs-authenticationtransaction" class="table-of-contents__link toc-highlight">BackchannelAuthenticationRequest vs AuthenticationTransaction</a><ul><li><a href="#backchannelauthenticationrequest" class="table-of-contents__link toc-highlight">BackchannelAuthenticationRequest</a></li><li><a href="#authenticationtransaction" class="table-of-contents__link toc-highlight">AuthenticationTransaction</a></li><li><a href="#使い分け" class="table-of-contents__link toc-highlight">使い分け</a></li></ul></li><li><a href="#チェックリスト" class="table-of-contents__link toc-highlight">チェックリスト</a><ul><li><a href="#entryserviceusecase層" class="table-of-contents__link toc-highlight">EntryService（UseCase層）</a></li><li><a href="#core層cibaprotocol" class="table-of-contents__link toc-highlight">Core層（CibaProtocol）</a></li><li><a href="#e2eテスト" class="table-of-contents__link toc-highlight">E2Eテスト</a></li></ul></li><li><a href="#よくあるエラー" class="table-of-contents__link toc-highlight">よくあるエラー</a><ul><li><a href="#エラー1-authorization_pending---認証待ち" class="table-of-contents__link toc-highlight">エラー1: <code>authorization_pending</code> - 認証待ち</a></li><li><a href="#エラー2-access_denied---ユーザーが拒否" class="table-of-contents__link toc-highlight">エラー2: <code>access_denied</code> - ユーザーが拒否</a></li></ul></li><li><a href="#次のステップ" class="table-of-contents__link toc-highlight">次のステップ</a><ul><li><a href="#-次に読むべきドキュメント" class="table-of-contents__link toc-highlight">📖 次に読むべきドキュメント</a></li><li><a href="#-詳細情報" class="table-of-contents__link toc-highlight">🔗 詳細情報</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>