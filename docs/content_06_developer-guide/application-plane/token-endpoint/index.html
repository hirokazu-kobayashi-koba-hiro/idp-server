<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_06_developer-guide/application-plane/token-endpoint" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">Token Endpoint実装ガイド | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/token-endpoint"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Token Endpoint実装ガイド | IdP-Server Documentation"><meta data-rh="true" name="description" content="このドキュメントの目的"><meta data-rh="true" property="og:description" content="このドキュメントの目的"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/token-endpoint"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/token-endpoint" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/application-plane/token-endpoint" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.10532692.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.d1b51878.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">ドキュメントガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_03_concepts/foundation/concept-01-multi-tenant">コア概念</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認証・認可プロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_05_how-to/">How-to（設定・運用レシピ）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">開発者ガイド</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">はじめに</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/control-plane/resource-overview">管理API</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">認証・認可</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">Application Plane - OAuth/OIDC認証フロー概要</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/authorization-flow">Authorization Code Flow実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/token-endpoint">Token Endpoint実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/authentication">認証実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/userinfo">UserInfo実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/ciba-flow">CIBA Flow実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/identity-verification">身元確認申込み実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/federation">フェデレーション（外部IdP連携）実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/events">イベント処理実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/security-event">SecurityEvent 実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/user-lifecycle-event">UserLifecycleEvent 実装ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/client-authentication">クライアント認証実装ガイド</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/overview">実装ガイド</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/configuration/CONFIGURATION_COVERAGE">設定</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/patterns/common-patterns">実装パターン</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/troubleshooting/common-errors">トラブルシューティング</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/code-review-checklist">リファレンス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/learning-paths/beginner">学習パス</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">開発者ガイド</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">認証・認可</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">Token Endpoint実装ガイド</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>Token Endpoint実装ガイド</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="このドキュメントの目的">このドキュメントの目的<a href="#このドキュメントの目的" class="hash-link" aria-label="このドキュメントの目的 への直接リンク" title="このドキュメントの目的 への直接リンク">​</a></h2>
<p><strong>トークンエンドポイント</strong>（トークン発行・検証・失効）の実装を理解することが目標です。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="所要時間">所要時間<a href="#所要時間" class="hash-link" aria-label="所要時間 への直接リンク" title="所要時間 への直  接リンク">​</a></h3>
<p>⏱️ <strong>約30分</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="前提知識">前提知識<a href="#前提知識" class="hash-link" aria-label="前提知識 への直接リンク" title="前提知識 への直接リンク">​</a></h3>
<ul>
<li><a href="/idp-server/docs/content_06_developer-guide/application-plane/authorization-flow">02. Authorization Flow</a></li>
<li>OAuth 2.0基礎知識</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="token-endpointとは">Token Endpointとは<a href="#token-endpointとは" class="hash-link" aria-label="Token Endpointとは への直接リンク" title="Token Endpointとは への直接リンク">​</a></h2>
<p>OAuth 2.0の<strong>トークンエンドポイント（Token Endpoint）</strong> は、トークンに関する3つの機能を提供します：</p>
<ol>
<li><strong>Token Request</strong>: トークン発行（RFC 6749 Section 3.2）</li>
<li><strong>Token Introspection</strong>: トークン検証（RFC 7662）</li>
<li><strong>Token Revocation</strong>: トークン失効（RFC 7009）</li>
</ol>
<p><strong>RFC準拠</strong>: OAuth 2.0 (RFC 6749), Token Introspection (RFC 7662), Token Revocation (RFC 7009)</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="エンドポイント一覧">エンドポイント一覧<a href="#エンドポイント一覧" class="hash-link" aria-label="エンドポイント一覧 への直接リンク" title="エンドポイント一覧 への直接リンク">​</a></h2>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># トークン発行（RFC 6749）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># トークンイントロスペクション（RFC 7662）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens/introspection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># トークン失効（RFC 7009）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens/revocation</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/TokenV1Api-73ef751cad927ce53a2dc97fa37bc842.java" target="_blank">TokenV1Api.java</a></p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="実装アーキテクチャ全体像">実装アーキテクチャ全体像<a href="#実装アーキテクチャ全体像" class="hash-link" aria-label="実装アーキテクチャ全体像 への直接リンク" title="実装アーキテクチャ全体像 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="30秒で理解す  る全体像">30秒で理解する全体像<a href="#30秒で理解する全体像" class="hash-link" aria-label="30秒で理解する全体像 への直接リンク" title="30秒で理解する全体像 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HTTPリクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Controller (TokenV1Api) - HTTP処理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EntryService (TokenEntryService) - トランザクション管理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Core層 (TokenProtocol → TokenRequestHandler)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ Validator: 入力形式チェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ クライアント認証（5種類）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ Grant Type別Service選択（4種類+拡張）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └─ トークン発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Repository - データ永続化</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラスの責務">主要クラスの責務<a href="#主要クラスの責務" class="hash-link" aria-label="主要クラスの責務 への直接リンク" title="主要クラスの責務 への直接リンク">​</a></h3>
<table><thead><tr><th>クラス</th><th>役割</th><th>主な処理</th></tr></thead><tbody><tr><td><strong>TokenV1Api</strong></td><td>HTTPエンドポイント</td><td>パラメータ受け取り、レスポンス返却</td></tr><tr><td><strong>TokenEntryService</strong></td><td>オーケストレーション</td><td>トランザクション、イベント発行</td></tr><tr><td><strong>TokenRequestHandler</strong></td><td>トークン発行処理</td><td>Validator、クライアント認証、Service選択</td></tr><tr><td><strong>ClientAuthenticationHandler</strong></td><td>クライアント認証</td><td>5種類の認証方式から選択・実行</td></tr><tr><td><strong>OAuthTokenCreationServices</strong></td><td>Grant Type振り分け</td><td>4種類+拡張からService選択</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要ドメインオブジェクト">主要ドメインオブジェクト<a href="#主要ドメインオブジェクト" class="hash-link" aria-label="主  要ドメインオブジェクト への直接リンク" title="主要ドメインオブジェクト への直接リンク">​</a></h3>
<table><thead><tr><th>オブジェクト</th><th>説明</th><th>保存場所</th><th>有効期限</th></tr></thead><tbody><tr><td><strong>OAuthToken</strong></td><td>Access Token/Refresh Token</td><td>DB</td><td>設定による（デフォルト1時間）</td></tr><tr><td><strong>AuthorizationCodeGrant</strong></td><td>Authorization Code</td><td>Redis + DB</td><td>5分（使用後即無効）</td></tr><tr><td><strong>ClientCredentials</strong></td><td>クライアント認証情報</td><td>-</td><td>-</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-token-requestトークン発行">1. Token Request（トークン発行）<a href="#1-token-requestトークン発行" class="hash-link" aria-label="1. Token Request（トークン発行） への直接リンク" title="1. Token Request（トークン発行） への直接リンク">​</a></h2>
<p>トークンエンドポイントの最も重要な機能は<strong>トークン発行</strong>です。Authorization Codeやクライアント認証情報を使ってAccess Token/Refresh Token/ID Tokenを発行します。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-処理フロー全体">1.1 処理フロー全体<a href="#11-処理フロー全体" class="hash-link" aria-label="1.1 処理フロー全体 への直接リンク" title="1.1 処理フロー全体 への直接リンク">​</a></h3>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/TokenRequestHandler-999bbca3323825dad5a7872fad8726d9.java#L82-L120" target="_blank">TokenRequestHandler.java:82-120</a></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TokenRequestHandler.handle()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 1. Validator（入力形式チェック）          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - grant_type必須                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - パラメータ形式チェック               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 2. 設定取得                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - AuthorizationServerConfiguration  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - ClientConfiguration               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 3. クライアント認証                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → ClientAuthenticationHandler       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ 5種類から選択・実行            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 4. Grant Type別Service選択              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → OAuthTokenCreationServices        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ 4種類+拡張から選択             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 5. トークン発行                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → Service.create()                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├─ Authorization Code検証        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├─ Access Token生成              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├─ Refresh Token生成             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ├─ ID Token生成（OIDC）          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ DB保存                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TokenRequestResponse</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-クライアント認証client-authentication">1.2 クライアント認証（Client Authentication）<a href="#12-クライアント認証client-authentication" class="hash-link" aria-label="1.2 クライアント認証（Client Authentication） への直接リンク" title="1.2 クライアント認証（Client Authentication） への直接リンク">​</a></h3>
<p><strong>詳細</strong>: <a href="/idp-server/docs/content_06_developer-guide/application-plane/client-authentication">10. Client Authentication実装</a> - 7つの認証方式の完全ガイド</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="標準5種類--fapi拡張2種類">標準5種類 + FAPI拡張2種類<a href="#標準5種類--fapi拡張2種類" class="hash-link" aria-label="標準5種類 + FAPI拡張2種類 への直接リンク" title="標準5種類 + FAPI拡張2種類 への直接リンク">​</a></h3>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/ClientAuthenticators-99daae9a4be18c2abd215247b2aefaf1.java#L32-L40" target="_blank">ClientAuthenticators.java:32-40</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="標準認証方式5種類">標準認証方式（5種類）<a href="#標準認証方式5種類" class="hash-link" aria-label="標準認証方式（5種類） への直接リンク" title="標準認証方式（5種類） への直接リンク">​</a></h4>
<table><thead><tr><th>認証方式</th><th>送信方法</th><th>用途</th><th>セキュリティレベル</th></tr></thead><tbody><tr><td><strong>client_secret_basic</strong></td><td>Basic認証ヘッダー</td><td>最も一般的</td><td>⭐⭐</td></tr><tr><td><strong>client_secret_post</strong></td><td>POSTボディ</td><td>レガシー</td><td>⭐</td></tr><tr><td><strong>client_secret_jwt</strong></td><td>JWT署名（共有鍵）</td><td>高セキュリティ</td><td>⭐⭐⭐</td></tr><tr><td><strong>private_key_jwt</strong></td><td>JWT署名（秘密鍵）</td><td>最高セキュリティ</td><td>⭐⭐⭐⭐</td></tr><tr><td><strong>none</strong></td><td>認証なし</td><td>パブリッククライアント（SPA/Mobile+PKCE）</td><td>-</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="fapi拡張認証方式2種類">FAPI拡張認証方式（2種類）<a href="#fapi拡張認証方式2種類" class="hash-link" aria-label="FAPI拡張認証方式（2種類） への直接リンク" title="FAPI拡張認証方式（2種類） への直接リンク">​</a></h4>
<p><strong>実装</strong>: <code>libs/idp-server-core-extension-fapi/src/main/java/org/idp/server/core/openid/extension/fapi/</code></p>
<table><thead><tr><th>認証方式</th><th>送信方法</th><th>用途</th><th>セキュリティレベル</th></tr></thead><tbody><tr><td><strong>tls_client_auth</strong></td><td>クライアント証明書（MTLS）</td><td>FAPI準拠・金融機関</td><td>⭐⭐⭐⭐⭐</td></tr><tr><td><strong>self_signed_tls_client_auth</strong></td><td>自己署名証明書（MTLS）</td><td>FAPI準拠・開発環境</td><td>⭐⭐⭐⭐</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="client_secret_basic-の例">client_secret_basic の例<a href="#client_secret_basic-の例" class="hash-link" aria-label="client_secret_basic の例 への直接リンク" title="client_secret_basic の例 への直接リンク">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># Authorization ヘッダーにBase64エンコード</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Basic base64(client_id:client_secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 実際のリクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/tokens&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Authorization: Basic $(echo -n &#x27;my-client:my-secret&#x27; | base64)&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;grant_type=authorization_code&amp;code=${CODE}&amp;redirect_uri=${REDIRECT_URI}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="client_secret_post-の例">client_secret_post の例<a href="#client_secret_post-の例" class="hash-link" aria-label="client_secret_post の例 への直接リンク" title="client_secret_post の例 への直接リンク">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># POSTボディにclient_id/client_secretを含める</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/tokens&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;grant_type=authorization_code&amp;code=${CODE}&amp;redirect_uri=${REDIRECT_URI}&amp;client_id=my-client&amp;client_secret=my-secret&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="クライアント認証の処理フロー">クライアント認証の処理フロー<a href="#クライアント認証の 処理フロー" class="hash-link" aria-label="クライアント認証の処理フロー への直接リンク" title="クライアント認証の処理フロー への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">TokenRequestHandler.handle()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TokenRequestContext作成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ clientSecretBasic (Authorizationヘッダーから抽出)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ├─ clientCert (MTLSヘッダーから抽出)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    └─ parameters (POSTボディ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClientAuthenticationHandler.authenticate(context)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ ClientAuthenticators.get(認証タイプ)       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  client_secret_basic                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → ClientSecretBasicAuthenticator      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ Base64デコード → 検証           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  client_secret_post                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → ClientSecretPostAuthenticator       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ POSTボディから抽出 → 検証       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  client_secret_jwt                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → ClientSecretJwtAuthenticator        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ JWT検証（HMAC署名）             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  private_key_jwt                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → PrivateKeyJwtAuthenticator          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ JWT検証（RSA/ECDSA署名）        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  none                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → PublicClientAuthenticator           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ PKCE必須チェック                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  + FAPI拡張（プラグイン）                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  tls_client_auth                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → TlsClientAuthAuthenticator          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ クライアント証明書検証（MTLS）   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  self_signed_tls_client_auth             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → SelfSignedTlsClientAuthAuthenticator│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       └─ 自己署名証明書検証（MTLS）       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClientCredentials（認証済み情報）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">※ FAPIモジュールがロードされている場合のみMTLS認証が有効</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-grant-type別のservice">1.3 Grant Type別のService<a href="#13-grant-type別のservice" class="hash-link" aria-label="1.3 Grant Type別のService への直接リンク" title="1.3 Grant Type別のService への直接リンク">​</a></h3>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4種類の標準grant-type">4種類の標準Grant Type<a href="#4種類の標準grant-type" class="hash-link" aria-label="4種類の標準Grant Type への直接リンク" title="4種類の標準Grant Type への直接リンク">​</a></h3>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/OAuthTokenCreationServices-1dca63693ab789be5009f6c2ff4a717b.java#L43-L56" target="_blank">OAuthTokenCreationServices.java:43-56</a></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">OAuthTokenCreationServices.get(grantType)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ Grant Typeで振り分け                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ authorization_code                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   → AuthorizationCodeGrantService      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ Validator（code必須等）        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ AuthorizationCodeGrant取得     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ Verifier（used, 期限, URI）    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ AccessToken生成                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ RefreshToken生成               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ IdToken生成（OIDC）            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      └─ AuthorizationGranted保存       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ refresh_token                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   → RefreshTokenGrantService           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      └─ 新しいAccess Token発行         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ password                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   → ResourceOwnerPasswordCredentials   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      └─ ユーザー認証・トークン発行      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ client_credentials                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   → ClientCredentialsGrantService      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      └─ クライアント権限でトークン発行   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ + 拡張Grant Type（プラグイン）           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   例: urn:openid:params:grant-type:ciba │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="authorizationcodegrantservice-の処理詳細">AuthorizationCodeGrantService の処理詳細<a href="#authorizationcodegrantservice-の処理詳細" class="hash-link" aria-label="AuthorizationCodeGrantService の処理詳細 への直接リンク" title="AuthorizationCodeGrantService の処理詳細 への直接リンク">​</a></h3>
<p><strong>実装場所</strong>: <a href="/idp-server/assets/files/AuthorizationCodeGrantService-51584ffaad2ed181451cdfb01295eae0.java#L127-L203" target="_blank">AuthorizationCodeGrantService.java:127-203</a></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AuthorizationCodeGrantService.create(tokenRequestContext, clientCredentials)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 1. Validator（入力形式チェック）               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    実装: TokenRequestCodeGrantValidator      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - code必須チェック                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 2. AuthorizationCodeGrant取得                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  authorizationCodeGrantRepository.find()    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 存在しない → invalid_grant エラー         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 3. AuthorizationRequest取得                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  authorizationRequestRepository.find()      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 元の認可リクエスト情報（scope, nonce等）   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 4. Verifier（ビジネスルール検証）             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    実装: AuthorizationCodeGrantVerifier      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Base Verifier選択（OAuth2 or OIDC）         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├─ 有効期限チェック                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├─ used=false チェック                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├─ redirect_uri完全一致                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├─ クライアント一致                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    └─ PKCE検証（該当時）                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Extension Verifiers（該当時のみ）            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    └─ プラグインロード拡張検証                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 5. トークン生成                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  AuthorizationGrant抽出                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├─ user, scope, authentication           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  AccessTokenCreator.create()                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ├─ JWT生成（RS256等）                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    └─ 有効期限設定（デフォルト1時間）          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  RefreshTokenCreator.create()               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    └─ 有効期限設定（設定による）              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  if (OIDC)                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    IdTokenCreator.createIdToken()           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ nonce含める                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ at_hash, c_hash計算                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      └─ カスタムクレーム追加                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  OAuthTokenBuilder.build()                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    └─ 全トークンを1つのOAuthTokenに統合       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 6. AuthorizationGranted登録/更新             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  authorizationGrantedRepository.find()      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 既存の同意情報を取得                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  exists? → merge() : register()             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 同意情報を記録（次回の自動承認用）       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 7. クリーンアップ                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  oAuthTokenCommandRepository.register()     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - OAuthToken保存                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  authorizationCodeGrantRepository.delete()  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - Authorization Code削除（使用済み）      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  authorizationRequestRepository.delete()    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - AuthorizationRequest削除（不要）        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────── ─────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OAuthToken（Access/Refresh/ID Token）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>RFC 6749 Section 4.1.3準拠の実装</strong></p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="14-各grant-typeの詳細実装">1.4 各Grant Typeの詳細実装<a href="#14-各grant-typeの詳細実装" class="hash-link" aria-label="1.4 各Grant Typeの詳細実装 への直接リンク" title="1.4 各Grant Typeの詳細実装 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="141-authorization-code-grant最重要">1.4.1 Authorization Code Grant（最重要）<a href="#141-authorization-code-grant最重要" class="hash-link" aria-label="1.4.1 Authorization Code Grant（最重要） への直接リンク" title="1.4.1 Authorization Code Grant（最重要） への直接リンク">​</a></h4>
<p><strong>用途</strong>: ユーザー認証後にトークン取得（最も一般的なフロー）</p>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/AuthorizationCodeGrantService-51584ffaad2ed181451cdfb01295eae0.java#L127-L203" target="_blank">AuthorizationCodeGrantService.java:127-203</a></p>
<p><strong>リクエスト例</strong>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/tokens&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Authorization: Basic $(echo -n &#x27;client-id:client-secret&#x27; | base64)&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;grant_type=authorization_code&amp;code=${CODE}&amp;redirect_uri=${REDIRECT_URI}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>レスポンス</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;access_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;token_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Bearer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;expires_in&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3600</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;refresh_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;id_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;scope&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;openid profile email&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>処理の詳細</strong>: 上記「AuthorizationCodeGrantService の処理詳細」セクション参照</p>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="142-client-credentials-grant">1.4.2 Client Credentials Grant<a href="#142-client-credentials-grant" class="hash-link" aria-label="1.4.2 Client Credentials Grant への直接リンク" title="1.4.2 Client Credentials Grant への直接リンク">​</a></h4>
<p>**用途</p>
<p><strong>サーバー間通信</strong>（ユーザーなし）- バックエンドサービスがAPIに  アクセス</p>
<p><strong>使用場面</strong>:</p>
<ul>
<li>マイクロサービス間通信</li>
<li>バッチ処理</li>
<li>管理用スクリプト</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="リクエスト例">リクエスト例<a href="#リクエスト例" class="hash-link" aria-label="リクエスト例 への直接リンク" title="リクエスト例 への直接リンク">​</a></h3>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/ClientCredentialsGrantService-3ce58a20b5aa830b7bf63a2586cc3a99.java#L49-L88" target="_blank">ClientCredentialsGrantService.java:49-88</a></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/tokens&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Authorization: Basic $(echo -n &#x27;client-id:client-secret&#x27; | base64)&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;grant_type=client_credentials&amp;scope=api:read api:write&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>レスポンス</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;access_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;token_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Bearer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;expires_in&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3600</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;scope&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;api:read api:write&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>注意</strong>: Refresh TokenとID Tokenは発行されない（ユーザーコンテキストがないため）</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="処理フロー">処理フロー<a href="#処理フロー" class="hash-link" aria-label="処理フロー への直接リンク" title="処理フロー への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ClientCredentialsGrantService.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 1. Validator                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    実装: ClientCredentialsGrantValidator     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - scope形式チェック                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 2. Scope検証                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    実装: ClientCredentialsGrantVerifier      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - クライアント許可scopeでフィルタリング       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 空なら例外                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 3. AuthorizationGrant作成                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - subject: なし（クライアント自身）          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - scope: フィルタリング済みscope             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - grant_type: client_credentials           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 4. AccessToken生成                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  AccessTokenCreator.create()                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - subjectはclient_id                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - scopeに基づく権限設定                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 5. OAuthToken保存                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │  oAuthTokenCommandRepository.register()     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="143-refresh-token-grant">1.4.3 Refresh Token Grant<a href="#143-refresh-token-grant" class="hash-link" aria-label="1.4.3 Refresh Token Grant への直接リンク" title="1.4.3 Refresh Token Grant への直接リンク">​</a></h4>
<p>**用途</p>
<p><strong>Access Token更新</strong> - 有効期限切れ前に新しいAccess Tokenを取得</p>
<p><strong>使用場面</strong>:</p>
<ul>
<li>Access Token期限切れ時</li>
<li>ユーザー再認証なしでトークン更新</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="リクエスト例-1">リクエスト例<a href="#リクエスト例-1" class="hash-link" aria-label="リクエスト例 への直接リンク" title="リクエスト例 への直接リンク">​</a></h3>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/RefreshTokenGrantService-01c87868014d186e4b9603667d660a54.java#L53-L90" target="_blank">RefreshTokenGrantService.java:53-90</a></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/tokens&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Authorization: Basic $(echo -n &#x27;client-id:client-secret&#x27; | base64)&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;grant_type=refresh_token&amp;refresh_token=${REFRESH_TOKEN}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>レスポンス</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;access_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 新しいAccess Token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;token_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Bearer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;expires_in&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3600</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;refresh_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">// 新しいRefresh Token</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;scope&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;openid profile email&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="処理フロー-1">処理フロー<a href="#処理フロー-1" class="hash-link" aria-label="処理フロー への直接リンク" title="処理フロー への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">RefreshTokenGrantService.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────  ────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 1. Validator                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    実装: RefreshTokenGrantValidator          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - refresh_token必須チェック                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 2. 元のOAuthToken取得                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  oAuthTokenQueryRepository.find()           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - Refresh Tokenに紐づくOAuthToken取得       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 3. Verifier検証                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    実装: RefreshTokenVerifier                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - Refresh Token有効期限チェック              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - クライアント一致チェック                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ユーザー存在チェック                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ユーザーステータスチェック（Issue #900）     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 4. 新しいトークン生成                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  AccessTokenCreator.refresh()               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 新しいAccess Token生成                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  RefreshTokenCreator.refresh()              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 新しいRefresh Token生成                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - または既存のRefresh Tokenを再利用       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 5. トークン入れ替え                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  oAuthTokenCommandRepository.delete(旧)     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  oAuthTokenCommandRepository.register(新)   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要</strong>: 元のOAuthTokenは削除され、新しいOAuthTokenに置き換わる</p>
<hr>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="144-resource-owner-password-credentials-grant">1.4.4 Resource Owner Password Credentials Grant<a href="#144-resource-owner-password-credentials-grant" class="hash-link" aria-label="1.4.4 Resource Owner Password Credentials Grant への直接リンク" title="1.4.4 Resource Owner Password Credentials Grant への直接  リンク">​</a></h4>
<p><strong>用途</strong></p>
<p><strong>ユーザー認証</strong> - ユーザー名とパスワードで直接トークン取得（レガシーシステム移行用）</p>
<p><strong>使用場面</strong>:</p>
<ul>
<li>レガシーシステムからの移行期間中</li>
<li>信頼できるファーストパーティアプリケーション</li>
</ul>
<p>⚠️ <strong>注意</strong>: OAuth 2.1では非推奨。新規実装では使用を避けてください。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="リクエスト例-2">リクエスト例<a href="#リクエスト例-2" class="hash-link" aria-label="リクエスト例 への直接リンク" title="リクエスト例 への直接リンク">​</a></h3>
<p><strong>実装</strong>: <a href="/libs/idp-server-core/src/main/java/org/idp/server/core/openid/token/service/ResourceOwnerPasswordGrantService.java">ResourceOwnerPasswordGrantService.java</a></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/tokens&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Content-Type: application/x-www-form-urlencoded&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Authorization: Basic $(echo -n &#x27;client-id:client-secret&#x27; | base64)&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;grant_type=password&amp;username=${USERNAME}&amp;password=${PASSWORD}&amp;scope=openid&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>レスポンス</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;access_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;token_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Bearer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;expires_in&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">3600</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;refresh_token&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;scope&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;openid&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="  処理フロー-2">処理フロー<a href="#処理フロー-2" class="hash-link" aria-label="処理フロー への直接リンク" title="処理フロー への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ResourceOwnerPasswordGrantService.create()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 1. Validator                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    実装: ResourceOwnerPasswordGrantValidator │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - username必須チェック                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - password必須チェック                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 2. ユーザー認証                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ResourceOwnerPasswordGrantDelegate         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    .authenticate(username, password)        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - パスワード検証                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ユーザー取得                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 3. Verifier検証                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    実装: ResourceOwnerPasswordGrantVerifier  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ユーザー存在チェック                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ユーザーステータスチェック（Issue #900）     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - スコープ検証                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 4. トークン生成                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  AccessTokenCreator.create()                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  RefreshTokenCreator.create()               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  IdTokenCreator.createIdToken() (OIDC時)    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ↓</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 5. OAuthToken保存                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  oAuthTokenCommandRepository.register()     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-token-introspectionトークン検証">2. Token Introspection（トークン検証）<a href="#2-token-introspectionトークン検証" class="hash-link" aria-label="2. Token Introspection（トークン検証） への直接リンク" title="2. Token Introspection（トークン検証） への直接リンク">​</a></h2>
<p><strong>RFC 7662準拠</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="リクエスト">リクエスト<a href="#リクエスト" class="hash-link" aria-label="リクエスト への直接リンク" title="リクエスト への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens/introspection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/x-www-form-urlencoded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Basic base64(client_id:client_secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="レスポンス">レスポンス<a href="#レスポンス" class="hash-link" aria-label="レスポンス への直接リンク" title="レスポンス への直接リンク">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;active&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;scope&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;openid profile email&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;client_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;test-client&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;username&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user@example.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;token_type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Bearer&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;exp&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1695555600</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;iat&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1695552000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;sub&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user-12345&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="entryservice実装">EntryService実装<a href="#entryservice実装" class="hash-link" aria-label="EntryService実装 への直接リンク" title="EntryService実装 への直接リンク">​</a></h3>
<p><strong>実装</strong>: <a href="/idp-server/assets/files/TokenEntryService-31af38cd6c1f3e692a89dbc484889c89.java#L83" target="_blank">TokenEntryService.java:83</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public TokenIntrospectionResponse inspect(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TenantIdentifier tenantIdentifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;String, String[]&gt; params,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String authorizationHeader,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    String clientCert,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RequestAttributes requestAttributes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 1. Tenant取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 2. TokenIntrospectionRequest作成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TokenIntrospectionRequest tokenIntrospectionRequest =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      new TokenIntrospectionRequest(tenant, authorizationHeader, params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  tokenIntrospectionRequest.setClientCert(clientCert);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 3. Core層に委譲</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TokenProtocol tokenProtocol = tokenProtocols.get(tenant.authorizationProvider());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TokenIntrospectionResponse result = tokenProtocol.inspect(tokenIntrospectionRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 4. イベント発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (result.hasOAuthToken()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    eventPublisher.publish(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tenant, result.oAuthToken(), result.securityEventType(), requestAttributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return result;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-token-revocationト ークン失効">3. Token Revocation（トークン失効）<a href="#3-token-revocationトークン失効" class="hash-link" aria-label="3. Token Revocation（トークン失効） への直接リンク" title="3. Token Revocation（トークン失効） への直接リンク">​</a></h2>
<p><strong>RFC 7009準拠</strong></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="リクエスト-1">リクエスト<a href="#リクエスト-1" class="hash-link" aria-label="リクエスト への直接リンク" title="リクエスト への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /{tenant-id}/v1/tokens/revocation</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/x-www-form-urlencoded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Basic base64(client_id:client_secret)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token=eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...&amp;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token_type_hint=access_token</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="レスポンス-1">レスポンス<a href="#レスポンス-1" class="hash-link" aria-label="レスポンス への直接リンク" title="レスポンス への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 200 OK</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>注意</strong>: RFC 7009により、成功時はボディなし（200 OKのみ）</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="e2eテストの書き方">E2Eテストの書き方<a href="#e2eテストの書き方" class="hash-link" aria-label="E2Eテストの書き方 への直接リンク" title="E2Eテストの書き方 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="実際のテストファイル">実際のテストファ  イル<a href="#実際のテストファイル" class="hash-link" aria-label="実際のテストファイル への直接リンク" title="実際のテストファイル への直接リンク">​</a></h3>
<p><strong>参考</strong>: <code>e2e/src/tests/scenario/application/scenario-02-sso-oidc.test.js</code></p>
<p>実際のE2Eテストでは、以下のシナリオをカバーしています：</p>
<ul>
<li>テナント・クライアント・ユーザーのセットアップ</li>
<li>Authorization Code Flow全体</li>
<li>トークン発行・検証・失効</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="テスト時のチェックポイント">テスト時のチェックポイント<a href="#テスト時のチェックポイント" class="hash-link" aria-label="テスト時のチェックポイント への直接リンク" title="テスト時のチェックポイント への直接リンク">​</a></h3>
<div class="language-javascript codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-javascript codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">// ✅ 確認すべきこと</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">status</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toBe</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toHaveProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;access_token&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toHaveProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;token_type&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;Bearer&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toHaveProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;expires_in&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// OIDC時</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toHaveProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;id_token&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">// Refresh Token発行時</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token function" style="color:#d73a49">expect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">response</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">data</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">toHaveProperty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;refresh_token&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="テスト実行">テスト実行<a href="#テスト実行" class="hash-link" aria-label="テスト実行 への直接リンク" title="テスト実行 への直接リンク">​</a></h3>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">cd e2e</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">npm test -- scenario-02-sso-oidc.test.js</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="よくあるエラーと対処法">よくあるエラーと対処法<a href="#よくあるエラーと対処法" class="hash-link" aria-label="よくあるエラーと対処法 への直接リンク" title="よくあるエラーと対処法 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="エラー1-invalid_client---クライアント認証失敗">エラー1: <code>invalid_client</code> - クライアント認証失敗<a href="#エラー1-invalid_client---クライアント認証失敗" class="hash-link" aria-label="エラ ー1-invalid_client---クライアント認証失敗 への直接リンク" title="エラー1-invalid_client---クライアント認証失敗 への直接リンク">​</a></h3>
<p><strong>実際のエラー</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;invalid_client&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error_description&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Client authentication failed&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原因</strong>:</p>
<ul>
<li>client_id/client_secretが不正</li>
<li>Basic認証のBase64エンコードミス</li>
<li>Authorizationヘッダーとボディでclient_idが異なる</li>
</ul>
<p><strong>解決策</strong>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ✅ 正しい（client_secret_basic）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/tokens&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -H &quot;Authorization: Basic $(echo -n &#x27;my-client:my-secret&#x27; | base64)&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;grant_type=authorization_code&amp;code=${CODE}&amp;redirect_uri=${REDIRECT_URI}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ❌ 間違い: -nオプション忘れ（改行が入る）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &#x27;my-client:my-secret&#x27; | base64</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ✅ 正しい（client_secret_post）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -X POST &quot;http://localhost:8080/${TENANT_ID}/v1/tokens&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -d &quot;grant_type=authorization_code&amp;code=${CODE}&amp;client_id=my-client&amp;client_secret=my-secret&amp;redirect_uri=${REDIRECT_URI}&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="エラー2-invalid_grant---authorization-code不正">エラー2: <code>invalid_grant</code> - Authorization Code不正<a href="#エラー2-invalid_grant---authorization-code不正" class="hash-link" aria-label="エラー2-invalid_grant---authorization-code不正 への直接リンク" title="エラー2-invalid_grant---authorization-code不正 への直接リンク">​</a></h3>
<p><strong>実際のエラー</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;invalid_grant&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error_description&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;not found authorization code.&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原因</strong>:</p>
<ol>
<li><strong>Authorization Codeが既に使用済み</strong> （使用後即削除される）</li>
<li><strong>Authorization Codeが期限切れ</strong> （5分経過で自動削除）</li>
<li><strong>Authorization Codeが存在しない</strong> （誤ったコード）</li>
<li><strong>redirect_uriの不  一致</strong></li>
</ol>
<p><strong>実装詳細</strong>:
このシステムでは<code>used</code>フラグではなく、<strong>使用後即削除する設計</strong>を採用しています。</p>
<ul>
<li>トークン発行成功 → Authorization Code削除（<a href="/idp-server/assets/files/AuthorizationCodeGrantService-51584ffaad2ed181451cdfb01295eae0.java#L199" target="_blank">AuthorizationCodeGrantService.java:199</a>）</li>
<li>再使用試行 → レコード不存在 → <code>invalid_grant</code>エラー</li>
<li>セキュリティ: used/expired/存在しない を区別しない（攻撃者に情報を与えない）</li>
</ul>
<p><strong>解決策</strong>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># 1. Authorization Codeの存在確認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec -it postgres psql -U idp_user -d idp_db -c \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;SELECT code, expires_at, redirect_uri FROM authorization_code_grant WHERE code=&#x27;${CODE}&#x27;;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 2. レコードが存在しない場合 → 最初からやり直し（Authorization Requestから再実行）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 3. expires_at &lt; now の場合 → 最初からやり直し</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 4. redirect_uri不一致 → 正しいURIを指定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Authorization Requestで指定したredirect_uriと完全一致必須</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redirect_uri=https://app.example.com/callback  # ✅</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">redirect_uri=https://app.example.com/callback/ # ❌ 末尾スラッシュ</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要</strong>: Authorization Codeは<strong>ワンタイム使用</strong>です。一度使用すると物理的に削除されるため、再使用は不可能です。</p>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="エラー3-unsupported_grant_type">エラー3: <code>unsupported_grant_type</code><a href="#エラー3-unsupported_grant_type" class="hash-link" aria-label="エラー3-unsupported_grant_type への直接リンク" title="エラー3-unsupported_grant_type への直接リンク">​</a></h3>
<p><strong>実際のエラー</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;unsupported_grant_type&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error_description&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;unsupported grant_type (password)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原因</strong>: テナント設定でGrant Typeが無効化されている</p>
<p><strong>解決策</strong>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># サポートされているgrant_typeを確認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl -X GET &quot;http://localhost:8080/${TENANT_ID}/.well-known/openid-configuration&quot; \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  | jq &#x27;.grant_types_supported&#x27;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 出力例:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># [&quot;authorization_code&quot;, &quot;refresh_token&quot;, &quot;client_credentials&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># passwordが含まれていない → テナント設定で無効化されている</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Management APIで有効化が必要</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="エラー4-invalid_grant---ユーザーが無効状態issue-900">エラー4: <code>invalid_grant</code> - ユーザーが無効状態（Issue #900）<a href="#エラー4-invalid_grant---ユーザーが無効状態issue-900" class="hash-link" aria-label="エラー4-invalid_grant---ユーザーが無効状態issue-900 への直接リンク" title="エラー4-invalid_grant---ユーザーが無効状態issue-900 への直接リンク">​</a></h3>
<p><strong>実際のエラー</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;invalid_grant&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;error_description&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;user is not active (id: user-12345, status: LOCKED)&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原因</strong>: トークン発行時にユーザーが無効状態になっている</p>
<p><strong>対象Grant Type</strong>:</p>
<ul>
<li><strong>Refresh Token Grant</strong>: トークン更新時にユーザーステータスをチェック</li>
<li><strong>Password Grant</strong>: ユーザー認証時にユーザーステータスをチェック</li>
</ul>
<p><strong>無効と判定されるステータス</strong>:</p>
<table><thead><tr><th>ステータス</th><th>説明</th><th>発生ケース</th></tr></thead><tbody><tr><td><strong>LOCKED</strong></td><td>アカウントロック</td><td>認証失敗回数超過</td></tr><tr><td><strong>DISABLED</strong></td><td>無効化</td><td>管理者による無効化</td></tr><tr><td><strong>SUSPENDED</strong></td><td>一時停止</td><td>ポリシー違反等</td></tr><tr><td><strong>DEACTIVATED</strong></td><td>非アクティブ化</td><td>ユーザーによる退会申請</td></tr><tr><td><strong>DELETED_PENDING</strong></td><td>削除待ち</td><td>削除処理中</td></tr><tr><td><strong>DELETED</strong></td><td>削除済み</td><td>完全削除</td></tr></tbody></table>
<p><strong>実装詳細</strong>:</p>
<ul>
<li>Refresh Token Grant: <a href="/idp-server/assets/files/RefreshTokenVerifier-7cfe993ced2936cc49c482c544415a1a.java" target="_blank">RefreshTokenVerifier.java</a> の <code>throwExceptionIfInactiveUser()</code></li>
<li>Password Grant: <a href="/idp-server/assets/files/ResourceOwnerPasswordGrantVerifier-3648d0a904c3383ae2f65eca85e9b32c.java" target="_blank">ResourceOwnerPasswordGrantVerifier.java</a> の <code>throwExceptionIfInactiveUser()</code></li>
</ul>
<p><strong>セキュリティ考慮事項</strong>:</p>
<ul>
<li><strong>Authorization Code Grant では未チェック</strong>: 認可時点でユーザー認証済みのため、トークン交換時の再チェックは不要（Keycloakと同じアプローチ）</li>
<li><strong>Refresh Token Grant でのチェック理由</strong>: 長期間有効なRefresh Tokenの場合、その間にユーザーが無効化される可能性がある</li>
</ul>
<p><strong>解決策</strong>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ユーザーステータス確認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker exec -it postgres psql -U idp_user -d idp_db -c \</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;SELECT id, status FROM idp_user WHERE id=&#x27;${USER_ID}&#x27;;&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 有効なステータス（ACTIVE）でない場合、管理者によるステータス変更が必要</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># または新しいユーザーで認証をやり直す</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="次のステップ">次のステップ<a href="#次のステップ" class="hash-link" aria-label="次のステップ への直接リンク" title="次のステップ への直接リンク">​</a></h2>
<p>✅ Token Flowの実装を理解した！</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-次に読むべきドキュメント">📖 次に読むべきドキュメント<a href="#-次に読むべきドキュメント" class="hash-link" aria-label="📖 次に読むべきドキュメント への直接リンク" title="📖 次に読むべきドキュメント への直接リンク">​</a></h3>
<ol>
<li><a href="/idp-server/docs/content_06_developer-guide/application-plane/authentication">04. Authentication実装</a> - ユーザー認証</li>
<li><a href="/idp-server/docs/content_06_developer-guide/application-plane/userinfo">05. UserInfo実装</a> - ユーザー情報取得</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-詳細情報">🔗 詳細情報<a href="#-詳細情報" class="hash-link" aria-label="🔗 詳細情報 への直接リンク" title="🔗 詳細情報 への直接リンク">​</a></h3>
<ul>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-11-core#token---%E3%83%88%E3%83%BC%E3%82%AF%E3%83%B3%E3%83%89%E3%83%A1%E3%82%A4%E3%83%B3">AI開発者向け: Core - Token</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc6749#section-3.2" target="_blank" rel="noopener noreferrer">RFC 6749 Section 3.2</a> - Token Endpoint</li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7662" target="_blank" rel="noopener noreferrer">RFC 7662</a> - Token Introspection</li>
</ul>
<hr>
<p><strong>情報源</strong>: <a href="/idp-server/assets/files/TokenEntryService-31af38cd6c1f3e692a89dbc484889c89.java" target="_blank">TokenEntryService.java</a>
<strong>最終更新</strong>: 2025-12-03</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_06_developer-guide/03-application-plane/03-token-endpoint.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_06_developer-guide/application-plane/authorization-flow"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">Authorization Code Flow実装ガイド</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_06_developer-guide/application-plane/authentication"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">認証実装ガイド</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#このドキュメントの目的" class="table-of-contents__link toc-highlight">このドキュメントの目的</a><ul><li><a href="#所要時間" class="table-of-contents__link toc-highlight">所要時間</a></li><li><a href="#前提知識" class="table-of-contents__link toc-highlight">前提知識</a></li></ul></li><li><a href="#token-endpointとは" class="table-of-contents__link toc-highlight">Token Endpointとは</a></li><li><a href="#エンドポイント一覧" class="table-of-contents__link toc-highlight">エンドポイント一覧</a></li><li><a href="#実装アーキテクチャ全体像" class="table-of-contents__link toc-highlight">実装アーキテクチャ全体像</a><ul><li><a href="#30秒で理解する全体像" class="table-of-contents__link toc-highlight">30秒で理解する全体像</a></li><li><a href="#主要クラスの責務" class="table-of-contents__link toc-highlight">主要クラスの責務</a></li><li><a href="#主要ドメインオブジェクト" class="table-of-contents__link toc-highlight">主要ドメインオブジェクト</a></li></ul></li><li><a href="#1-token-requestトークン発行" class="table-of-contents__link toc-highlight">1. Token Request（トークン発行）</a><ul><li><a href="#11-処理フロー全体" class="table-of-contents__link toc-highlight">1.1 処理フロー全体</a></li><li><a href="#12-クライアント認証client-authentication" class="table-of-contents__link toc-highlight">1.2 クライアント認証（Client Authentication）</a></li><li><a href="#標準5種類--fapi拡張2種類" class="table-of-contents__link toc-highlight">標準5種類 + FAPI拡張2種類</a></li><li><a href="#client_secret_basic-の例" class="table-of-contents__link toc-highlight">client_secret_basic の例</a></li><li><a href="#client_secret_post-の例" class="table-of-contents__link toc-highlight">client_secret_post の例</a></li><li><a href="#クライアント認証の処理フロー" class="table-of-contents__link toc-highlight">クライアント認証の処理フロー</a></li><li><a href="#13-grant-type別のservice" class="table-of-contents__link toc-highlight">1.3 Grant Type別のService</a></li><li><a href="#4種類の標準grant-type" class="table-of-contents__link toc-highlight">4種類の標準Grant Type</a></li><li><a href="#authorizationcodegrantservice-の処理詳細" class="table-of-contents__link toc-highlight">AuthorizationCodeGrantService の処理詳細</a></li><li><a href="#14-各grant-typeの詳細実装" class="table-of-contents__link toc-highlight">1.4 各Grant Typeの詳細実装</a></li><li><a href="#リクエスト例" class="table-of-contents__link toc-highlight">リクエスト例</a></li><li><a href="#処理フロー" class="table-of-contents__link toc-highlight">処理フロー</a></li><li><a href="#リクエスト例-1" class="table-of-contents__link toc-highlight">リクエスト例</a></li><li><a href="#処理フロー-1" class="table-of-contents__link toc-highlight">処理フロー</a></li><li><a href="#リクエスト例-2" class="table-of-contents__link toc-highlight">リクエスト例</a></li><li><a href="#処理フロー-2" class="table-of-contents__link toc-highlight">処理フロー</a></li></ul></li><li><a href="#2-token-introspectionトークン検証" class="table-of-contents__link toc-highlight">2. Token Introspection（トークン検証）</a><ul><li><a href="#リクエスト" class="table-of-contents__link toc-highlight">リクエスト</a></li><li><a href="#レスポンス" class="table-of-contents__link toc-highlight">レスポンス</a></li><li><a href="#entryservice実装" class="table-of-contents__link toc-highlight">EntryService実装</a></li></ul></li><li><a href="#3-token-revocationトークン失効" class="table-of-contents__link toc-highlight">3. Token Revocation（トークン失効）</a><ul><li><a href="#リクエス  ト-1" class="table-of-contents__link toc-highlight">リクエスト</a></li><li><a href="#レスポンス-1" class="table-of-contents__link toc-highlight">レスポンス</a></li></ul></li><li><a href="#e2eテストの書き方" class="table-of-contents__link toc-highlight">E2Eテストの書き方</a><ul><li><a href="#実際のテストファイル" class="table-of-contents__link toc-highlight">実際のテストファイル</a></li><li><a href="#テスト時のチェックポイント" class="table-of-contents__link toc-highlight">テスト時のチェックポイント</a></li><li><a href="#テスト実行" class="table-of-contents__link toc-highlight">テスト実行</a></li></ul></li><li><a href="#よくあるエラーと対処法" class="table-of-contents__link toc-highlight">よくあるエラーと対処法</a><ul><li><a href="#エラー1-invalid_client---クライアント認証失敗" class="table-of-contents__link toc-highlight">エラー1: <code>invalid_client</code> - クライアント認証失敗</a></li><li><a href="#エラー2-invalid_grant---authorization-code不正" class="table-of-contents__link toc-highlight">エラー2: <code>invalid_grant</code> - Authorization Code不正</a></li><li><a href="#エラー3-unsupported_grant_type" class="table-of-contents__link toc-highlight">エラー3: <code>unsupported_grant_type</code></a></li><li><a href="#エラー4-invalid_grant---ユーザーが無効状態issue-900" class="table-of-contents__link toc-highlight">エラー4: <code>invalid_grant</code> - ユーザーが無効状態（Issue #900）</a></li></ul></li><li><a href="#次のステップ" class="table-of-contents__link toc-highlight">次のステップ</a><ul><li><a href="#-次に読むべきドキュメント" class="table-of-contents__link toc-highlight">📖 次に読むべきドキュメント</a></li><li><a href="#-詳細情報" class="table-of-contents__link toc-highlight">🔗 詳細情報</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>