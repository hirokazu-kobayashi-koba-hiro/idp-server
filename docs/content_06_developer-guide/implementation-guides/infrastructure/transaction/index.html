<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_06_developer-guide/implementation-guides/infrastructure/transaction" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">トランザクション | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/transaction"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="トランザクション | IdP-Server Documentation"><meta data-rh="true" name="description" content="1. 概要"><meta data-rh="true" property="og:description" content="1. 概要"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/transaction"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/transaction" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/transaction" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.3ded8780.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.739e3161.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">ドキュメントガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_03_concepts/foundation/concept-01-multi-tenant">コア概念</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認証・認可プロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_05_how-to/">How-to（設定・運用レシピ）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_06_developer-guide/">開発者ガイド</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/">開発者ガイドマップ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">はじめに</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/learning-paths/beginner">学習パス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/control-plane/resource-overview">管理API</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">認証・認可</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/overview">実装ガイド</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/overview">実装ガイド概要</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/caching">インフラ・基盤</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/caching">キャッシュ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/dependency-injection">DI (Dependency Injection)</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/multi-tenancy">マルチテナント</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/repository">Repository</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/spring-session">Session</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/transaction">トランザクション</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/writer-reader-datasource">Writer/Reader DataSource</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/oauth-oidc/discovery-metadata">OAuth/OIDC</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/authentication/authentication-interactor">認証</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/integration/external-integration">外部連携</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/advanced/audit-logging">高度な機能</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/configuration/authentication-policy">設定</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/patterns/common-patterns">実装パターン</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/troubleshooting/common-errors">トラブルシューティング</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/code-review-checklist">リファレンス</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_11_learning/identity-basics/identity-management-basics">学習（Learning）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">開発者ガイド</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">実装ガイド</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">インフラ・基盤</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">トランザクション</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>トランザクション</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-概要">1. 概要<a href="#1-概要" class="hash-link" aria-label="1. 概要 への直接リンク" title="1. 概要 への直接リンク">​</a></h2>
<p><code>idp-server</code> は、<strong>フレームワーク非依存のトランザクション管理レイヤー</strong>を実装しており、Spring Boot、Quarkus、Jakarta EE
など異なるアプリケーションスタック間での移植性をサポートします。これにより、特定の DI や Web
フレームワークに密結合せずにトランザクションの伝播や境界制御が可能となります。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-カスタムトランザクションアノテーション">2. カスタムトランザクションアノテーション<a href="#2-カスタムトランザクションアノテー ション" class="hash-link" aria-label="2. カスタムトランザクションアノテーション への直接リンク" title="2. カスタムトランザクションアノテーション への直接リンク">​</a></h2>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OAuthFlowEntryService implements OAuthFlowApi {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // transactional service logic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li><code>@Transaction</code> アノテーションは、クラスまたはメソッドをトランザクション対象としてマークします。</li>
<li><strong>宣言的なトランザクション境界の制御</strong>を実現します。</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-トランザクションの伝播">3. トランザクションの伝播<a href="#3-トランザクションの伝播" class="hash-link" aria-label="3. トランザクションの伝播 への直接リンク" title="3. トランザクションの伝播 への直接リンク">​</a></h2>
<p>現在の <code>@Transaction</code> システムでは、以下の伝播動作をサポートしています：</p>
<table><thead><tr><th>伝播タイプ</th><th>サポート状況</th><th>説明</th></tr></thead><tbody><tr><td>REQUIRED</td><td>✅ 対応済み</td><td>トランザクションが存在しない場合に新規作成。既に存在する場合はエラー。</td></tr><tr><td>REQUIRES_NEW</td><td>❌ 非対応</td><td>ネストや中断されたトランザクションは未対応。</td></tr><tr><td>SUPPORTS</td><td>❌ 非対応</td><td>明示的なトランザクションコンテキストが必要。</td></tr></tbody></table>
<blockquote>
<p>備考：このトランザクションシステムはフレームワーク非依存であり、ThreadLocal
によってトランザクション状態を管理します。マルチレベル伝播やネストトランザクションは現時点では未対応です。</p>
</blockquote>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-サンプルフロー">4. サンプルフロー<a href="#4-サンプルフロー" class="hash-link" aria-label="4. サンプルフロー への直接リンク" title="4. サンプルフロー への直接リンク">​</a></h2>
<!-- -->
<p>すべてのDB呼び出しは、サービスレベルで定義された1つのトランザクションスコープ内で処理されます。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-エラーハンドリングとロールバック">5. エラーハンドリングとロールバック<a href="#5-エラーハンドリングとロールバック" class="hash-link" aria-label="5. エラーハンドリングとロールバッ ク への直接リンク" title="5. エラーハンドリングとロールバック への直接リンク">​</a></h2>
<p>例外（ランタイム例外またはラップされたチェック例外）が発生した場合、トランザクションは自動的にロールバックされます。</p>
<ul>
<li>中央集権的な例外ハンドラーとの統合を推奨</li>
<li>カスタムロールバックルールはアダプターごとに設定可能</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-実装クラス">6. 実装クラス<a href="#6-実装クラス" class="hash-link" aria-label="6. 実装クラス への直接リンク" title="6. 実装クラス への直接リンク">​</a></h2>
<ul>
<li><code>@Transaction</code> アノテーション：<code>org.idp.server.platform.datasource</code> に存在</li>
<li>アダプターエントリポイント：例 <code>TenantAwareEntryServiceProxy</code></li>
<li>リポジトリインターフェース：コマンド／クエリ分離設計（<code>register()</code>, <code>update()</code> など）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tenantawareentryserviceproxy---dynamic-proxy実装">TenantAwareEntryServiceProxy - Dynamic Proxy実装<a href="#tenantawareentryserviceproxy---dynamic-proxy実装" class="hash-link" aria-label="TenantAwareEntryServiceProxy - Dynamic Proxy実装 への直接リンク" title="TenantAwareEntryServiceProxy - Dynamic Proxy実装 への直接リンク">​</a></h3>
<p><code>TenantAwareEntryServiceProxy</code>は、Java Dynamic Proxyを使用して<code>@Transaction</code>アノテーションを検出し、自動的にトランザクション管理を実行します。</p>
<p><strong>詳細な実装パターンと8ステップの動作フロー</strong>:</p>
<ul>
<li><a href="/idp-server/docs/content_06_developer-guide/implementation-guides/content_10_ai_developer/ai-12-platform.md#datasource%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3proxy">AI開発者向け  ドキュメント - platform.md</a></li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-トランザクション分離レベル">7. トランザクション分離レベル<a href="#7-トランザクション分離レベル" class="hash-link" aria-label="7. トランザクション分離レベル への直接リンク" title="7. トランザクション分離レベル への直接リンク">​</a></h2>
<p><code>idp-server</code> では、PostgreSQL/MySQLのデフォルト分離レベルである <strong>READ COMMITTED</strong> を使用しています。</p>
<p><strong>関連ドキュメント</strong>: Writer/Reader DataSourceの分岐については <a href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/writer-reader-datasource">Writer/Reader DataSource</a> を参照してください。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="分離レベルの特性">分離レベルの特性<a href="#分離レベルの特性" class="hash-link" aria-label="分離レベルの特性 への直接リンク" title="分離レベルの特性 への直接リンク">​</a></h3>
<table><thead><tr><th>分離レベル</th><th>動作</th></tr></thead><tbody><tr><td><strong>READ COMMITTED</strong></td><td>コミット済みのデータのみ参照可能。同一トランザクション内では自分の更新は即座に参照可能（Read Your Own Writes）</td></tr></tbody></table>
<p><strong>PostgreSQL</strong>: デフォルトで READ COMMITTED
<strong>MySQL/InnoDB</strong>: デフォルトで REPEATABLE READ（より厳密）だが、Read Your Own Writesは両方でサポート</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="データベース別の動作">データベース別の動作<a href="#データベース別の動作" class="hash-link" aria-label="データベース別の動作 への直接リンク" title="データベース別の動作 への直接リンク">​</a></h3>
<table><thead><tr><th>データベース</th><th>デフォルト分離レベル</th><th>Read Your Own Writes</th></tr></thead><tbody><tr><td>PostgreSQL</td><td>READ COMMITTED</td><td>✅ サポート</td></tr><tr><td>MySQL (InnoDB)</td><td>REPEATABLE READ</td><td>✅ サポート</td></tr></tbody></table>
<p><strong>参考</strong>:</p>
<ul>
<li><a href="https://www.postgresql.org/docs/current/transaction-iso.html" target="_blank" rel="noopener noreferrer">PostgreSQL - Transaction Isolation</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html" target="_blank" rel="noopener noreferrer">MySQL - Transaction Isolation Levels</a></li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-read-your-own-writes-パターン">8. Read Your Own Writes パターン<a href="#8-read-your-own-writes-パターン" class="hash-link" aria-label="8. Read Your Own Writes パターン への直接リンク" title="8. Read Your Own Writes パターン への直接リンク">​</a></h2>
<p>同一トランザクション内では、自分が更新したデータは即座に参照可能です。</p>
<p><strong>重要</strong>: このパターンは<strong>Writer DataSource</strong>での書き込みトランザクションで有効です。Reader DataSourceは読み取り専用のため、Read Your Own Writesは適用されません。詳細は <a href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/writer-reader-datasource#writerreader%E5%88%86%E5%B2%90%E3%81%AE%E8%A9%B3%E7%B4%B0">Writer/Reader DataSource</a> を参照してください。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="ユースケース-更新api実行後のデータ再取得">ユースケース: 更新API実行後のデータ再取得<a href="#ユースケース-更新api実行後のデータ再取得" class="hash-link" aria-label="ユースケース: 更新API実行後のデータ再取得 への直接リンク" title="ユースケース: 更新API実行後のデータ再取得 への直接リンク">​</a></h3>
<p>更新APIでDBから再取得してレスポンスを返す場合、同一トランザクション内で更新後のデータを正確に取得できます。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 1. トランザクション開始（@Transactionアノテーションにより自動開始）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public UserManagementResponse update(TenantIdentifier tenant, ...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. UPDATE実行（updated_at = now() はDB側で設定）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    userCommandRepository.update(tenant, user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3. 同一トランザクション内で再取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // → 更新後のデータ（updated_at含む）が即座に取得可能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User updatedUser = userQueryRepository.get(tenant, userIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4. レスポンス生成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return toResponse(updatedUser);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 5. コミット（メソッド終了時に自動コミット）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="read-your-own-writes-が保証する動作">Read Your Own Writes が保証する動作<a href="#read-your-own-writes-が保証する動作" class="hash-link" aria-label="Read Your Own Writes が保証する動作 への直接リンク" title="Read Your Own Writes が保証する動作 への直接リンク">​</a></h3>
<ul>
<li><strong>即座の可視性</strong>: UPDATE/INSERT直後のSELECTで最新データを取得可能</li>
<li><strong>DB関数の値</strong>: <code>now()</code>, <code>CURRENT_TIMESTAMP</code>, <code>uuid_generate_v4()</code> 等のDB側で設定される値も取得可能</li>
<li><strong>ThreadLocal共有</strong>: <code>ThreadLocal</code>により同一スレッドで同じ <code>Connection</code> を使用</li>
<li><strong>コミット前でも参照可能</strong>: コミット前でもSELECTで自分の更新を参照可能</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="関連テーブルのjoin取得">関連テーブルのJOIN取得<a href="#関連テーブルのjoin取得" class="hash-link" aria-label="関連テーブルのJOIN取得 への直接リンク" title="関連テーブルのJOIN取得 への直接リンク">​</a></h3>
<p>ユーザーエンティティなど、複数テーブルにまたがるデータの場合、更新後に再取得することでメインテーブルと関連テーブルの両方の最新データを一括で取得できます。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">関連テーブル例（Userエンティティ）:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- idp_user               メインテーブル（updated_atがDB側で更新される）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- idp_user_roles         ロール割り当て</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- idp_user_assigned_tenants        テナント割り当て</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- idp_user_assigned_organizations  組織割り当て</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>メリット</strong>:</p>
<ul>
<li>1回のSELECT（JOIN）で全関連データを取得</li>
<li>DB側で設定された値（updated_at等）も含めて取得</li>
<li>レスポンスに最新の正確なデータを含められる</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="注意点">注意点<a href="#注意点" class="hash-link" aria-label="注意点 への直接リンク" title="注意点 への直接リンク">​</a></h3>
<ul>
<li><strong>同一トランザクション内でのみ有効</strong>: トランザクション境界を超えると、別のConnectionが使用される可能性がある</li>
<li><strong>他トランザクションの更新は不可視</strong>: READ COMMITTEDのため、他のトランザクションの未コミット更新は参照できない</li>
<li><strong>ThreadLocal依存</strong>: 同一スレッド内でのみ有効（非同期処理では動作が異なる可能性）</li>
</ul>
<hr>
<p>このモジュール化されたトランザクションアーキテクチャは、すべての ID／認可フローにおいて移植性、拡張性、安全なデータ一貫性を保証します。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-row-level-securityrlsとの統合">9. Row-Level Security（RLS）との統合<a href="#9-row-level-securityrlsとの統合" class="hash-link" aria-label="9. Row-Level Security（RLS）との統合 への直接リンク" title="9. Row-Level Security（RLS）との統合 への直接リンク">​</a></h2>
<p><code>idp-server</code> では、PostgreSQL の <strong>Row-Level Security（RLS）</strong> を独自トランザクション管理レイヤーと組 み合わせることで、テナントベースのデータ分離を厳密に実現します。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-主な概念">🔐 主な概念<a href="#-主な概念" class="hash-link" aria-label="🔐 主な概念 への直接リンク" title="🔐 主な概念 への直接リンク">​</a></h3>
<ul>
<li>全マルチテナントテーブルに対して以下のような RLS ポリシーを定義：</li>
</ul>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">POLICY rls_</span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">table_name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain">table_name</span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">USING</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">tenant_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> current_setting</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;app.tenant_id&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::uuid</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>強制適用には以下を使用：</li>
</ul>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> table_name </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FORCE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ROW</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LEVEL</span><span class="token plain"> SECURITY</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-rls-コンテキストの伝播">🔧 RLS コンテキストの伝播<a href="#-rls-コンテキストの伝播" class="hash-link" aria-label="🔧 RLS コンテキストの伝播 への直接リンク" title="🔧 RLS コンテキストの伝播 への直接リンク">​</a></h3>
<p><code>TransactionManager</code> は各 DB コネクションに適切なテナントコンテキストを適用します：</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">private static void setTenantId(Connection conn, TenantIdentifier tenantIdentifier) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    log.trace(&quot;[RLS] SET app.tenant_id: tenant={}&quot;, tenantIdentifier.value());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Use set_config() function with PreparedStatement to prevent SQL Injection</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // See: https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-SET</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    try (var stmt = conn.prepareStatement(&quot;SELECT set_config(&#x27;app.tenant_id&#x27;, ?, true)&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stmt.setString(1, tenantIdentifier.value());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        stmt.execute();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    } catch (SQLException e) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        throw new SqlRuntimeException(&quot;Failed to set tenant_id&quot;, e);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>この <code>app.tenant_id</code> は RLS ポリシーで使用されるセッションレベル変数です。</li>
<li><strong>SQL 実  行前に必ず設定</strong>されている必要があります。</li>
<li>テナント ID は <code>TenantIdentifier</code> として明示的に渡されます。</li>
</ul>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-運用ベストプラクス">💡 運用ベストプラクス<a href="#-運用ベストプラクス" class="hash-link" aria-label="💡 運用ベストプラクス への直接リンク" title="💡 運用ベストプラクス への直接リンク">​</a></h3>
<ul>
<li>リクエスト初期に解決が必要な場合は、<code>tenant</code> テーブルへの RLS 適用は避けることを推奨</li>
<li>Flyway マイグレーション後には以下のような権限設定を実行：</li>
</ul>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">GRANT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ALL</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLES</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SCHEMA</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> idp_app_user</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>将来的なテーブル・シーケンスにも適用されるようにデフォルト権限を変更：</li>
</ul>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIVILEGES</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> ROLE postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SCHEMA</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">GRANT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">INSERT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLES</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> idp_app_user</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">PRIVILEGES</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> ROLE postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SCHEMA</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">GRANT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">USAGE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> SEQUENCES </span><span class="token keyword" style="color:#00009f">TO</span><span class="token plain"> idp_app_user</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-デバッグヒント">🔍 デバッグヒント<a href="#-デバッグヒント" class="hash-link" aria-label="🔍 デバッグヒント への直接リンク" title="🔍 デバッグヒント への直接リンク">​</a></h3>
<ul>
<li>RLS ポリシー一覧表示：</li>
</ul>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> pg_policies</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> schemaname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;public&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<ul>
<li>テーブルに対するユーザー権限の確認：</li>
</ul>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> information_schema</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">role_table_grants</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> grantee </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;idp_app_user&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> table_schema </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;public&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<p>この設計により、<strong>あらゆる実行環境においてもマルチテナント安全性をデータベースレベルで実現</strong>できます。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="10-entryservice-proxy-の使  い分け">10. EntryService Proxy の使い分け<a href="#10-entryservice-proxy-の使い分け" class="hash-link" aria-label="10. EntryService Proxy の使い分け への直接リンク" title="10. EntryService Proxy の使い分け への直接リンク">​</a></h2>
<p>EntryServiceは、用途に応じて異なるProxyでラップする必要があります。Proxyの選択を誤ると、トランザクション管理やRLS設定が正しく動作しません。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="101-tenantawareentryserviceproxy">10.1 TenantAwareEntryServiceProxy<a href="#101-tenantawareentryserviceproxy" class="hash-link" aria-label="10.1 TenantAwareEntryServiceProxy への直接リンク" title="10.1 TenantAwareEntryServiceProxy への直接リンク">​</a></h3>
<p><strong>用途</strong>: Application層のAPI（第一引数に<code>TenantIdentifier</code>を持つ）</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 使用例: TenantIdentifierを第一引数に持つAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">this.tenantMetaDataApi = TenantAwareEntryServiceProxy.createProxy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new TenantMetaDataEntryService(tenantQueryRepository),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TenantMetaDataApi.class,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    databaseTypeProvider);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコード をコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>動作</strong>:</p>
<ul>
<li>メソッド引数から <code>TenantIdentifier</code> を自動解決</li>
<li>RLS（Row-Level Security）用の <code>app.tenant_id</code> を自動設定</li>
<li>トランザクション管理（コミット/ロールバック）</li>
</ul>
<p><strong>対象APIの例</strong>:</p>
<ul>
<li><code>TenantMetaDataApi</code> - <code>get(TenantIdentifier tenantIdentifier)</code></li>
<li><code>ClientManagementApi</code> - <code>create(TenantIdentifier tenantIdentifier, ...)</code></li>
<li><code>UserManagementApi</code> - <code>findList(TenantIdentifier tenantIdentifier, ...)</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="102-managementtypeentryserviceproxy">10.2 ManagementTypeEntryServiceProxy<a href="#102-managementtypeentryserviceproxy" class="hash-link" aria-label="10.2 ManagementTypeEntryServiceProxy への直接リンク" title="10.2 ManagementTypeEntryServiceProxy への直接リンク">​</a></h3>
<p><strong>用途</strong>: Control Plane層の管理API（<code>TenantIdentifier</code>を引数に持たない、または別の識別子から内部で解決する必要がある）</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 使用例: OrganizationIdentifierのみを引数に持つAPI</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">this.organizationTenantResolverApi = ManagementTypeEntryServiceProxy.createProxy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new OrganizationTenantResolverEntryService(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        organizationRepository, tenantQueryRepository),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OrganizationTenantResolverApi.class,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    databaseTypeProvider);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>動作</strong>:</p>
<ul>
<li>TenantIdentifierの自動解決を行わない</li>
<li>RLS設定を行わない（サービス内で必要に応じて設定）</li>
<li>純粋なトランザクション管理のみ</li>
</ul>
<p><strong>対象APIの例</strong>:</p>
<ul>
<li><code>OrganizationTenantResolverApi</code> - <code>resolveOrganizerTenant(OrganizationIdentifier orgId)</code></li>
<li><code>OnboardingApi</code> - <code>create(OnboardingRequest request)</code></li>
<li><code>OrganizationManagementApi</code> - <code>create(OrganizationRegistrationRequest request)</code></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="103-選択基準">10.3 選択基準<a href="#103-選択基準" class="hash-link" aria-label="10.3 選択基準 への直接リンク" title="10.3 選択基準 への直接リンク">​</a></h3>
<table><thead><tr><th>レイヤー</th><th>Proxy</th></tr></thead><tbody><tr><td>Application Plane</td><td><code>TenantAwareEntryServiceProxy</code></td></tr><tr><td>System-level Control Plane</td><td><code>TenantAwareEntryServiceProxy</code></td></tr><tr><td>Organization-level Control Plane</td><td><code>ManagementTypeEntryServiceProxy</code></td></tr></tbody></table>
<table><thead><tr><th>Proxy</th><th>RLS設定</th><th>トランザクション</th></tr></thead><tbody><tr><td><code>TenantAwareEntryServiceProxy</code></td><td>✅ 自動</td><td>✅ 自動</td></tr><tr><td><code>ManagementTypeEntryServiceProxy</code></td><td>❌ なし</td><td>✅ 自動</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="104-よくあるエラーと対処法">10.4 よくあるエラーと対処法<a href="#104-よくあるエラーと対処法" class="hash-link" aria-label="10.4 よくあるエラーと対処法 への直接リンク" title="10.4 よくあるエラーと対処法 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="エラー-missingrequiredtenantidentifierexception">エラー: MissingRequiredTenantIdentifierException<a href="#エラー-missingrequiredtenantidentifierexception" class="hash-link" aria-label="エラー: MissingRequiredTenantIdentifierException への直接リンク" title="エラー: MissingRequiredTenantIdentifierException への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">MissingRequiredTenantIdentifierException: Missing required TenantIdentifier.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Please ensure it is explicitly passed to the service.</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原因</strong>: <code>TenantAwareEntryServiceProxy</code>を使用しているが、APIメソッドの引数に<code>TenantIdentifier</code>が含まれていない。</p>
<p><strong>対処法</strong>: <code>ManagementTypeEntryServiceProxy</code>に変更する。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 変更前（エラー発生）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">this.myApi = TenantAwareEntryServiceProxy.createProxy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new MyEntryService(...),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyApi.class,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    databaseTypeProvider);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 変更後（正常動作）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">this.myApi = ManagementTypeEntryServiceProxy.createProxy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new MyEntryService(...),</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    MyApi.class,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    databaseTypeProvider);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<hr>
<p><strong>情報源</strong>:</p>
<ul>
<li><a href="/idp-server/libs/idp-server-platform/src/main/java/org/idp/server/platform/datasource/TransactionManager.java">TransactionManager.java</a></li>
<li><a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/TenantAwareEntryServiceProxy.java">TenantAwareEntryServiceProxy.java</a></li>
<li><a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/ManagementTypeEntryServiceProxy.java">ManagementTypeEntryServiceProxy.java</a></li>
<li><a href="https://www.postgresql.org/docs/current/transaction-iso.html" target="_blank" rel="noopener noreferrer">PostgreSQL - Transaction Isolation</a></li>
<li><a href="https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-SET" target="_blank" rel="noopener noreferrer">PostgreSQL - set_config()</a></li>
<li><a href="https://dev.mysql.com/doc/refman/8.0/en/innodb-transaction-isolation-levels.html" target="_blank" rel="noopener noreferrer">MySQL - Transaction Isolation Levels</a></li>
</ul>
<p><strong>最終更新</strong>: 2025-12-18</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_06_developer-guide/04-implementation-guides/infrastructure/transaction.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/spring-session"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">Session</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/writer-reader-datasource"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">Writer/Reader DataSource</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-概要" class="table-of-contents__link toc-highlight">1. 概要</a></li><li><a href="#2-カスタムトランザクションアノテーション" class="table-of-contents__link toc-highlight">2. カスタムトランザクションアノテーション</a></li><li><a href="#3-トランザクションの伝播" class="table-of-contents__link toc-highlight">3. トランザクションの伝播</a></li><li><a href="#4-サンプルフロー" class="table-of-contents__link toc-highlight">4. サンプルフロー</a></li><li><a href="#5-エラーハンドリングとロールバック" class="table-of-contents__link toc-highlight">5. エラーハンドリングとロールバック</a></li><li><a href="#6-実装クラス" class="table-of-contents__link toc-highlight">6. 実装クラス</a><ul><li><a href="#tenantawareentryserviceproxy---dynamic-proxy実装" class="table-of-contents__link toc-highlight">TenantAwareEntryServiceProxy - Dynamic Proxy実装</a></li></ul></li><li><a href="#7-トランザクション分離レベル" class="table-of-contents__link toc-highlight">7. トランザクション分離レベル</a><ul><li><a href="#分離レベルの特性" class="table-of-contents__link toc-highlight">分離レベルの特性</a></li><li><a href="#データベース別の動作" class="table-of-contents__link toc-highlight">データベース別の動作</a></li></ul></li><li><a href="#8-read-your-own-writes-パターン" class="table-of-contents__link toc-highlight">8. Read Your Own Writes パターン</a><ul><li><a href="#ユースケース-更新api実行後のデータ再取得" class="table-of-contents__link toc-highlight">ユースケース: 更新API実行後のデータ再取得</a></li><li><a href="#read-your-own-writes-が保証する動作" class="table-of-contents__link toc-highlight">Read Your Own Writes が保証する動作</a></li><li><a href="#関連テーブルのjoin取得" class="table-of-contents__link toc-highlight">関連テーブルのJOIN取得</a></li><li><a href="#注意点" class="table-of-contents__link toc-highlight">注意点</a></li></ul></li><li><a href="#9-row-level-securityrlsとの統合" class="table-of-contents__link toc-highlight">9. Row-Level Security（RLS）との統合</a><ul><li><a href="#-主な概念" class="table-of-contents__link toc-highlight">🔐 主な概念</a></li><li><a href="#-rls-コンテキストの伝播" class="table-of-contents__link toc-highlight">🔧 RLS コンテキストの伝播</a></li><li><a href="#-運用ベストプラクス" class="table-of-contents__link toc-highlight">💡 運用ベストプラクス</a></li><li><a href="#-デバッグヒント" class="table-of-contents__link toc-highlight">🔍 デバッグヒント</a></li></ul></li><li><a href="#10-entryservice-proxy-の使い分け" class="table-of-contents__link toc-highlight">10. EntryService Proxy の使い分け</a><ul><li><a href="#101-tenantawareentryserviceproxy" class="table-of-contents__link toc-highlight">10.1 TenantAwareEntryServiceProxy</a></li><li><a href="#102-managementtypeentryserviceproxy" class="table-of-contents__link toc-highlight">10.2 ManagementTypeEntryServiceProxy</a></li><li><a href="#103-選択基準" class="table-of-contents__link toc-highlight">10.3 選択基準</a></li><li><a href="#104-よくあるエラーと対処法" class="table-of-contents__link toc-highlight">10.4 よくあるエラーと対処法</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>