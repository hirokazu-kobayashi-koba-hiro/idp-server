<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_06_developer-guide/reference/database-partitioning-guide" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">データベースパーティショニングガイド | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/reference/database-partitioning-guide"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="データベースパーティショニングガイド | IdP-Server Documentation"><meta data-rh="true" name="description" content="1. 概要"><meta data-rh="true" property="og:description" content="1. 概要"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/reference/database-partitioning-guide"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/reference/database-partitioning-guide" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_06_developer-guide/reference/database-partitioning-guide" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.873d0c83.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.0791e485.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">ドキュメントガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_03_concepts/foundation/concept-01-multi-tenant">コア概念</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認証・認可プロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_05_how-to/">How-to（設定・運用レシピ）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_06_developer-guide/">開発者ガイド</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/">開発者ガイドマップ</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">はじめに</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/learning-paths/beginner">学習パス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/control-plane/resource-overview">管理API</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">認証・認可</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/overview">実装ガイド</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/configuration/authentication-policy">設定</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/patterns/common-patterns">実装パターン</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/troubleshooting/common-errors">トラブルシューティング</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/code-review-checklist">リファレンス</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/code-review-checklist">05. コードレビューチェックリスト</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/database-partitioning-guide">データベースパーティショニングガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/pg-partman-operations-guide">pg_partman + pg_cron パーティション運用ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/security-event-archive-guide">セキュリティイベント アーカイブガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/tenant-statistics-implementation">テナント統計機能 実装ガイド</a></li></ul></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_11_learning/identity-basics/identity-management-basics">学習（Learning）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">開発者ガイド</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">リファレンス</span><meta itemprop="position" content="2"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">データベースパーティショニングガイド</span><meta itemprop="position" content="3"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>データベースパーティショニングガイド</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-概要">1. 概要<a href="#1-概要" class="hash-link" aria-label="1. 概要 への直接リンク" title="1. 概要 への直接リンク">​</a></h2>
<p>本ドキュメントでは、idp-serverにおけるPostgreSQLパーティショニングの設計指針と実装パターンを説明します。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-パーティショニングとは">1.1 パーティショニングとは<a href="#11-パーティショニングとは" class="hash-link" aria-label="1.1 パーティショニングとは への直接リンク" title="1.1 パーティショニングとは への直接リンク">​</a></h3>
<p>パーティショニングは、1つの論理テーブルを複数の物理テーブル（パーティション）に分割する技術です。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    security_event (親テーブル = 論理的な窓口)               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  「私はただの入り口です。実データは子テーブルが持っています」                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────────────────────────────┬─────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ┌─────────────────────────┼─────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          │                         │                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          ▼                         ▼                                     ▼</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ┌───────────────┐         ┌───────────────┐                     ┌───────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │ _2025_12_01   │         │ _2025_12_02   │         ...         │ _2025_12_90   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │               │         │               │                     │               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │ 12/01のデータ │         │ 12/02のデータ │                     │ 90日後のデータ│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │               │         │               │                     │               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │ 物理ファイルA │         │ 物理ファイルB │                     │ 物理ファイルN │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  └───────────────┘         └───────────────┘                     └───────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">各パーティション = 独立した物理ファイル</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-主なメリット">1.2 主なメリット<a href="#12-主なメリット" class="hash-link" aria-label="1.2 主なメリット への直接リンク" title="1.2 主なメリット への直接リンク">​</a></h3>
<table><thead><tr><th>項目</th><th>従来方式</th><th>パーティショニング</th></tr></thead><tbody><tr><td><strong>古いデータ削除</strong></td><td>DELETE文（数時間〜数日）</td><td>DROP TABLE（数秒）</td></tr><tr><td><strong>VACUUM負荷</strong></td><td>高い</td><td>なし</td></tr><tr><td><strong>日付範囲クエリ</strong></td><td>全件スキャン</td><td>パーティションプルーニング</td></tr><tr><td><strong>ストレージ管理</strong></td><td>手動管理</td><td>自動削除で一定量維持</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-delete-vs-drop-table">2. DELETE vs DROP TABLE<a href="#2-delete-vs-drop-table" class="hash-link" aria-label="2. DELETE vs DROP TABLE への直接リンク" title="2. DELETE vs DROP TABLE への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-delete文の動作通常テーブル">2.1 DELETE文の動作（通常テーブル）<a href="#21-delete文の動作通常テーブル" class="hash-link" aria-label="2.1 DELETE文の動作（通常テーブル） への直接リンク" title="2.1 DELETE文の動作（通常テーブル） への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">DELETE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> security_event </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> created_at </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2025-09-05&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                          security_event                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ 行1 │ 行2 │ 行3 │ 行4 │ 行5 │ 行6 │ 行7 │ 行8 │ 行9 │行10 │ ...          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ 古い│ 古い│ 新し│ 古い│ 新し│ 古い│ 新し│ 古い│ 新し│ 古い│              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ↓     ↓           ↓           ↓           ↓           ↓                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    削除  削除        削除        削除        削除        削除               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   マーク マーク      マーク      マーク      マーク      マーク              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  処理内容:                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. 全行をスキャン (WHERE条件チェック)     ← 時間かかる                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. 該当行に「削除済み」マークを付ける     ← 時間かかる                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. トランザクションログに記録             ← I/O負荷                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  4. 後でVACUUMで実際に領域回収             ← さらに時間かかる               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  結果: 5億行削除 = 数時間〜数日                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-drop-tableの動作パーティションテーブル">2.2 DROP TABLEの動作（  パーティションテーブル）<a href="#22-drop-tableの動作パーティションテーブル" class="hash-link" aria-label="2.2 DROP TABLEの動作（パーティションテーブル） への直接リンク" title="2.2 DROP TABLEの動作（パーティションテーブル） への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">DROP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> security_event_2025_09_05</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌────────────── ───────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  パーティション = 独立した物理ファイル                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────┐                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ _2025_09_05     │   rm /var/lib/postgresql/.../security_event_...        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                 │   ──────────────────────────────────────────────▶      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  物理ファイル   │                   ファイル削除！                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │    625GB        │                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────┘                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           │                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ▼                                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        🗑️ ゴミ箱へ（ファイルシステムレベルで即削除）                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  処理内容:                                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. メタデータ（カタログ）から登録解除    ← 一瞬                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. ファイルシステムがファイル削除        ← 一瞬                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  結果: 625GB削除 = 数秒                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコー ドをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-処理時間比較5億行日の場合">2.3 処理時間比較（5億行/日の場合）<a href="#23-処理時間比較5億行日の場合" class="hash-link" aria-label="2.3 処理時間比較（5億行/日の場合） への直接リンク" title="2.3 処理時間比較（5億行/日の場合） への直接リンク">​</a></h3>
<table><thead><tr><th>操作</th><th>DELETE方式</th><th>DROP TABLE方式</th></tr></thead><tbody><tr><td>該当行特定</td><td>30分</td><td>-</td></tr><tr><td>削除マーク付与</td><td>2時間</td><td>-</td></tr><tr><td>トランザクションログ</td><td>1時間</td><td>-</td></tr><tr><td>VACUUM</td><td>3時間</td><td>-</td></tr><tr><td>メタデータ更新</td><td>-</td><td>0.1秒</td></tr><tr><td>ファイル削除</td><td>-</td><td>0.5秒</td></tr><tr><td><strong>合計</strong></td><td><strong>約6〜7時間</strong></td><td><strong>約1秒</strong></td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-パーティションプルーニング">3. パーティションプルーニング<a href="#3-パーティションプルーニング" class="hash-link" aria-label="3. パーティションプルーニング への直接リンク" title="3. パーティションプルーニング への直接リンク">​</a></h2>
<p>クエリ実行時に、条件に合致するパーティションのみをスキャンする最適化機能です。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-プルーニングが効く場合">3.1 プルーニングが効く場合<a href="#31-プルーニングが効く場合" class="hash-link" aria-label="3.1 プルーニングが効く場合 への直接リンク" title="3.1 プルーニングが効く場合 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> security_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> created_at </span><span class="token operator" style="color:#393A34">&gt;=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2025-12-01&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> created_at </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2025-12-04&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐ ┌───────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 11/29     │ │ 11/30     │ │ 12/01     │ │ 12/02     │ │ 12/03     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           │ │           │ │  ✓ SCAN   │ │  ✓ SCAN   │ │  ✓ SCAN   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ✗ SKIP   │ │  ✗ SKIP   │ │           │ │           │ │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────┘ └───────────┘ └───────────┘ └───────────┘ └───────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌───────────┐ ┌───────────┐ ┌ ───────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 12/04     │ │ 12/05     │ │ ...       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           │ │           │ │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ✗ SKIP   │ │  ✗ SKIP   │ │  ✗ SKIP   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────┘ └───────────┘ └───────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">結果: 90パーティション中、3パーティションのみスキャン = 約30倍高速</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-プルーニングが効かない場合">3.2 プルーニングが効かない場合<a href="#32-プルーニングが効かない場合" class="hash-link" aria-label="3.2 プルーニングが効かない場合 への直接リンク" title="3.2 プルーニングが効かない場合 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- パーティションキー（created_at）を指定していない</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> security_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> user_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;user-uuid-xxx&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 12/01   │ │ 12/02   │ │ 12/03   │ │ ...     │ │ 03/01   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  SCAN   │ │  SCAN   │ │  SCAN   │ │  SCAN   │ │  SCAN   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                  ↑</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        全90パーティションをスキャン（通常テーブルより遅くなる可能性）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-パーティショニングの制約">4. パーティショニングの制約<a href="#4-パーティショニングの制約" class="hash-link" aria-label="4. パーティショニングの制約 への直接リンク" title="4. パーティショニングの制約 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-primary-key-の制約">4.1 PRIMARY KEY の制約<a href="#41-primary-key-の制約" class="hash-link" aria-label="4.1 PRIMARY KEY の制約 への直接リンク" title="4.1 PRIMARY KEY の制約 への直接リンク">​</a></h3>
<p>パーティションキーをPRIMARY KEYに含める必要があります。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- ❌ 不可</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ✅ 必須</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> created_at</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>理由</strong>: PostgreSQLは「このidはどのパーティションにある？」を効率的に判断するため</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-外部キーforeign-keyの制約">4.2 外部キー（FOREIGN KEY）の制約<a href="#42-外部キーforeign-keyの制約" class="hash-link" aria-label="4.2 外部キー（FOREIGN KEY）の制約 への直接リンク" title="4.2 外部キー（FOREIGN KEY）の制約 への直接リンク">​</a></h3>
<p>他テーブルからパーティションテーブルへの外部キー参照は作成できません。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- ❌ エラーになる</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> security_event_detail </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id UUID </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    security_event_id UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOREIGN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">security_event_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REFERENCES</span><span class="token plain"> security_event</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>回避策</strong>:</p>
<ul>
<li>アプリケーション層で整合性チェック</li>
<li>RLSで制御</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-運用上のオーバーヘッド">4.3 運用上のオーバーヘッド<a href="#43-運用上のオーバーヘッド" class="hash-link" aria-label="4.3 運用上のオーバーヘッド への直接リンク" title="4.3 運用上のオーバーヘッド への直接リンク">​</a></h3>
<table><thead><tr><th>項目</th><th>内容</th></tr></thead><tbody><tr><td>パーティション作成</td><td>毎日自動実行（pg_cron）</td></tr><tr><td>パーティション削除</td><td>毎日自動実行（pg_cron）</td></tr><tr><td>監視</td><td>pg_cronジョブ状態、パーティション数</td></tr><tr><td>障害対応</td><td>DEFAULTパーティション肥大化の監視</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-パーティショニング適性判断">5. パーティショニング適性判断<a href="#5-パーティショニング適性判断" class="hash-link" aria-label="5. パーティショニング適性判断 への直接リンク" title="5. パーティショニング適性判断 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-チェックリスト">5.1 チェックリスト<a href="#51-チェックリスト" class="hash-link" aria-label="5.1 チェックリスト への直接リンク" title="5.1 チェックリスト への直接リンク">​</a></h3>
<p>パーティショニングを検討する際は、以下を確認してください。</p>
<table><thead><tr><th>チェック項目</th><th>説明</th></tr></thead><tbody><tr><td>□ 主要クエリでパーティションキーを指定できるか？</td><td>日付範囲検索が主なら適している</td></tr><tr><td>□ 古いデータを「期間単位」で削除したいか？</td><td>90日経過で一括削除など</td></tr><tr><td>□ 外部キー参照がないか？</td><td>参照されている場合は不可</td></tr><tr><td>□ PRIMARY KEY変更の影響を許容できるか？</td><td>複合キーへの変更</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-idp-serverのテーブル適性">5.2 idp-serverのテーブル適性<a href="#52-idp-serverのテーブル適性" class="hash-link" aria-label="5.2 idp-serverのテーブル適性 への直接リンク" title="5.2 idp-serverのテーブル適性 への直接リンク">​</a></h3>
<table><thead><tr><th>テーブル</th><th>適性</th><th>理由</th></tr></thead><tbody><tr><td><code>security_event</code></td><td>✓ 適している</td><td>日付検索が主、期間削除したい</td></tr><tr><td><code>security_event_hook_results</code></td><td>✓ 適している</td><td>同上</td></tr><tr><td><code>audit_log</code></td><td>✗ 不要</td><td>永続保存（コンプライアンス要件）</td></tr><tr><td><code>oauth_token</code></td><td>✗ 不向き</td><td>ハッシュ検索が主、日付指定不可（後述）</td></tr><tr><td><code>tenant</code></td><td>✗ 不向き</td><td>マスタデータ、外部キー参照あり</td></tr><tr><td><code>idp_user</code></td><td>✗ 不向き</td><td>マスタデータ</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-oauth_token-がパーティショニングに不向きな理由">6. oauth_token がパーティショニングに不向きな理由<a href="#6-oauth_token-がパーティショニングに不向きな理由" class="hash-link" aria-label="6. oauth_token がパーティショニングに不向きな理由 への直接リンク" title="6. oauth_token がパーティショニングに不向きな理由 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-イントロスペクションの検索パターン">6.1 イントロスペクションの検索パターン<a href="#61-イントロスペクションの検索パターン" class="hash-link" aria-label="6.1 イントロスペクションの検索パターン への直接リンク" title="6.1 イントロスペクションの検索パターン への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /introspect</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">token=eyJhbGciOiJSUzI1NiIs...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>アプリケーション側の処理:</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- トークン文字列をハッシュ化してDBで検索</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> oauth_token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> tenant_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> :tenantId</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> hashed_access_token </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> :hashedToken</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ※ created_at は検索条件に使えない</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ※ クライアントはトークン文字列しか知らない</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="62-パーティショニングした場合の問題">6.2 パーティショニングした場合の問題<a href="#62-パーティショニングした場合の問題" class="hash-link" aria-label="6.2 パーティショニングした場合の問題 への直接リンク" title="6.2 パーティショニングした場合の問題 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  仮に PARTITION BY RANGE (access_token_created_at) とした場合               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  SELECT * FROM oauth_token                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  WHERE hashed_access_token = :hash;                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        ↑ access_token_created_at は不明！                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐ ┌─────────┐               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ 12/01   │ │ 12/02   │ │ 12/03   │ │ ...     │ │ 03/01   │               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  SCAN   │ │  SCAN   │ │  SCAN   │ │  SCAN   │ │  SCAN   │               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────┘ └─────────┘ └─────────┘ └─────────┘ └─────────┘               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                               ↑                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    全90パーティションをスキャン！                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    パーティションプルーニング効かない                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  結果:                                                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - パーティショニングのメリット（検索高速化）が得られない                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - むしろオーバーヘッドで遅くなる可能性                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="63-oauth_token-の運用戦略">6.3 oauth_token の運用戦略<a href="#63-oauth_token-の運用戦略" class="hash-link" aria-label="6.3 oauth_token の運用戦略 への直接リンク" title="6.3 oauth_token の運用戦略 への直接リンク">​</a></h3>
<table><thead><tr><th>方式</th><th>説明</th><th>メリット</th><th>デメリット</th></tr></thead><tbody><tr><td>定期DELETE + VACUUM</td><td>従来方式で期限切れトークンを削除</td><td>シンプル</td><td>大量データ時は重い</td></tr><tr><td>TTLインデックス</td><td>PostgreSQL拡張で自動削除</td><td>自動化</td><td>拡張導入が必要</td></tr><tr><td>アプリ層での期限チェック</td><td>DBに問い合わせず期限判定</td><td>DB負荷軽減</td><td>取り消し対応が別途必要</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-実装例">7. 実装例<a href="#7-実装例" class="hash-link" aria-label="7. 実装例 への直接リンク" title="7. 実装例 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="71-パーティションテーブル作成v0_9_1">7.1 パーティションテーブル作成（V0_9_1）<a href="#71-パーティションテーブル作成v0_9_1" class="hash-link" aria-label="7.1 パーティションテーブル作成（V0_9_1） への直接リンク" title="7.1 パーティションテーブル作成（V0_9_1） への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 親テーブル作成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> security_event </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    id UUID</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">type</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">VARCHAR</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">255</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tenant_id UUID </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    detail JSONB </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    created_at </span><span class="token keyword" style="color:#00009f">TIMESTAMP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CURRENT_TIMESTAMP</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">NULL</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">PRIMARY</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">KEY</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- パーティションキーを含める</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> RANGE </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- デフォルトパーティション（安全弁）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> security_event_default </span><span class="token keyword" style="color:#00009f">PARTITION</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">OF</span><span class="token plain"> security_event </span><span class="token keyword" style="color:#00009f">DEFAULT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 日別パーティション作成（90日分）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DO</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_date </span><span class="token keyword" style="color:#00009f">DATE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_name </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">FOR</span><span class="token plain"> i </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.</span><span class="token number" style="color:#36acaa">.89</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        partition_date :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CURRENT_DATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">i </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27; days&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">::</span><span class="token keyword" style="color:#00009f">interval</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        partition_name :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;security_event_&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> to_char</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">partition_date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;YYYY_MM_DD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            </span><span class="token string" style="color:#e3116c">&#x27;CREATE TABLE IF NOT EXISTS %I PARTITION OF security_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">             FOR VALUES FROM (%L) TO (%L)&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            partition_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            to_char</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">partition_date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;YYYY-MM-DD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            to_char</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">partition_date </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1 day&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;YYYY-MM-DD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LOOP</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token plain"> $$</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="72-自動パーティション管理v0_9_2">7.2 自動パーティション管理（V0_9_2）<a href="#72-自動パーティション管理v0_9_2" class="hash-link" aria-label="7.2 自動パーティション管理（V0_9_2） への直接リンク" title="7.2 自動パーティション管理（V0_9_2） への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- pg_cron拡張有効化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> pg_cron</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 新規パーティション作成関数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FUNCTION</span><span class="token plain"> create_next_day_partitions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNS</span><span class="token plain"> void </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    next_day </span><span class="token keyword" style="color:#00009f">DATE</span><span class="token plain"> :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CURRENT_DATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;90 days&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_name </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_name :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;security_event_&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> to_char</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">next_day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;YYYY_MM_DD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token string" style="color:#e3116c">&#x27;CREATE TABLE IF NOT EXISTS %I PARTITION OF security_event</span><br></span><span class="token-line" style="color:#393A34"><span class="token string" style="color:#e3116c">         FOR VALUES FROM (%L) TO (%L)&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        partition_name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        to_char</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">next_day</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;YYYY-MM-DD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        to_char</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">next_day </span><span class="token operator" style="color:#393A34">+</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1 day&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;YYYY-MM-DD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> plpgsql</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 古いパーティション削除関数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">REPLACE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FUNCTION</span><span class="token plain"> drop_old_daily_partitions</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">RETURNS</span><span class="token plain"> void </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> $$</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">DECLARE</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    cutoff_date </span><span class="token keyword" style="color:#00009f">DATE</span><span class="token plain"> :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">CURRENT_DATE</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">-</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">interval</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;90 days&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_name </span><span class="token keyword" style="color:#00009f">TEXT</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">BEGIN</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    partition_name :</span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;security_event_&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> to_char</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">cutoff_date</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;YYYY_MM_DD&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">format</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;DROP TABLE IF EXISTS %I CASCADE&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> partition_name</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">END</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">$$ </span><span class="token keyword" style="color:#00009f">LANGUAGE</span><span class="token plain"> plpgsql</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- スケジュール設定（postgres DBに接続 して実行）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- psql -h localhost -U idp -d postgres</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schedule_in_database</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;create-next-day-partitions&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0 2 * * *&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token string" style="color:#e3116c">&#x27;SELECT create_next_day_partitions();&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;idpserver&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schedule_in_database</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;drop-old-daily-partitions&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;0 3 * * *&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     </span><span class="token string" style="color:#e3116c">&#x27;SELECT drop_old_daily_partitions();&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;idpserver&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-運用監視">8. 運用監視<a href="#8-運用監視" class="hash-link" aria-label="8. 運用監視 への直接リンク" title="8. 運用監視 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="81-パーティション一覧確認">8.1 パーティション一覧確認<a href="#81-パーティション一覧確認" class="hash-link" aria-label="8.1 パーティション一覧確認 への直接リンク" title="8.1 パーティション一覧確認 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tablename</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    pg_size_pretty</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">pg_total_relation_size</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">schemaname </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;.&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">||</span><span class="token plain"> tablename</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> size</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> pg_tables</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> tablename </span><span class="token operator" style="color:#393A34">LIKE</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;security_event_%&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> tablename </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="82-pg_cronジョブ状態確認">8.2 pg_cronジョブ状態確認<a href="#82-pg_cronジョブ状態確認" class="hash-link" aria-label="8.2 pg_cronジョブ状態確認 への直接リンク" title="8.2 pg_cronジョブ状態確認 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> jobid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> jobname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> schedule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> command</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> nodename</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="83-defaultパーティション監視">8.3 DEFAULTパーティション監視<a href="#83-defaultパーティション監視" class="hash-link" aria-label="8.3 DEFAULTパーティション監視 への直接リンク" title="8.3 DEFAULTパーティション監視 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- DEFAULTパーティションにデータが溜まっていないか確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">COUNT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token operator" style="color:#393A34">*</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> security_event_default</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 0以外の場合、パーティション作成が追いついていない可能性</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-統計データテーブルのパーティショニング考察">9. 統計データテーブルのパーティショニング考察<a href="#9-統計データテーブルのパーティショニング考察" class="hash-link" aria-label="9. 統計データテーブルのパーティショニング考察 への直接リンク" title="9. 統計データテーブルのパーティショニング考察 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="91-統計データテーブル一覧">9.1 統計データテーブル一覧<a href="#91-統計データテーブル一覧" class="hash-link" aria-label="9.1 統計データテーブル一覧 への直接リンク" title="9.1 統計データテーブル一覧 への直接リンク">​</a></h3>
<p>idp-serverには以下の統計データテーブルがあります。</p>
<table><thead><tr><th>テーブル</th><th>粒度</th><th>用途</th></tr></thead><tbody><tr><td><code>statistics_monthly</code></td><td>月次集計</td><td>MAU、イベントカウント等の集計データ</td></tr><tr><td><code>statistics_yearly</code></td><td>年次集計</td><td>YAU等の年次集計データ</td></tr><tr><td><code>statistics_daily_users</code></td><td>日×ユーザー</td><td>DAU計算用（ユニークユーザー追跡）</td></tr><tr><td><code>statistics_monthly_users</code></td><td>月×ユーザー</td><td>MAU計算用（ユニークユーザー追跡）</td></tr><tr><td><code>statistics_yearly_users</code></td><td>年×ユーザー</td><td>YAU計算用（ユニークユーザー追跡）</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="92-パーティショニング適性判断">9.2 パーティショニング適性判断<a href="#92-パーティショニング適性判断" class="hash-link" aria-label="9.2 パーティショニング適性判断 への直接リンク" title="9.2 パーティショ ニング適性判断 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="security_event-との比較">security_event との比較<a href="#security_event-との比較" class="hash-link" aria-label="security_event との比較 への直接リンク" title="security_event との比較 への直接リンク">​</a></h4>
<table><thead><tr><th>項目</th><th>security_event</th><th>statistics_daily_users</th></tr></thead><tbody><tr><td><strong>1日のレコード数</strong></td><td>5億</td><td>100万（最大）</td></tr><tr><td><strong>1日のサイズ</strong></td><td>625GB</td><td>~56MB</td></tr><tr><td><strong>90日のサイズ</strong></td><td>56TB</td><td>~5GB</td></tr><tr><td><strong>削除負荷</strong></td><td>非常に高い</td><td>低い</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="データ量試算100万ユーザー想定">データ量試算（100万ユーザー想定）<a href="#データ量試算100万ユーザー想定" class="hash-link" aria-label="データ量試算（100万ユーザー想定） への直接リンク" title="データ量試算（100万ユーザー想定） への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">statistics_daily_users:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1レコード ≈ 56 bytes (UUID×2 + DATE + TIMESTAMP×2)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1日 = 100万レコード × 56 bytes = 56MB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  90日 = 56MB × 90 = 約5GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">security_event（比較用）:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1日 = 5億レコード × 1.25KB = 625GB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  90日 = 56TB</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>データ量の差: 約10,000倍</strong></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="結論-パーティショニングは不要">結論: パーティショニングは不要<a href="#結論-パーティショニングは不要" class="hash-link" aria-label="結論: パーティショニングは不要 への直接リンク" title="結論: パーティショニングは不要 への直接リンク">​</a></h4>
<table><thead><tr><th>テーブル</th><th>判定</th><th>理由</th></tr></thead><tbody><tr><td><code>statistics_monthly</code></td><td>✗ 不要</td><td>月次集計のため年間12レコード/テナント程度</td></tr><tr><td><code>statistics_yearly</code></td><td>✗ 不要</td><td>年次集計のため年間1レコード/テナント</td></tr><tr><td><code>statistics_daily_users</code></td><td>✗ 不要</td><td>5GB/90日程度、DELETE文で十分高速</td></tr><tr><td><code>statistics_monthly_users</code></td><td>✗ 不要</td><td>700MB/12ヶ月程度</td></tr><tr><td><code>statistics_yearly_users</code></td><td>✗ 不要</td><td>200MB/年程度、永続保持推奨</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="93-推奨運用方法">9.3 推奨運用方法<a href="#93-推奨運用方法" class="hash-link" aria-label="9.3 推奨運用方法 への直接リンク" title="9.3 推奨運用方法 への直接リンク">​</a></h3>
<p>パーティショニングではなく、既存のクリーンアップ関数をpg_cronで定期実行します。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 統計データのクリーンアップスケジュール（推奨）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- postgres DBに接続して実行: psql -h localhost -U idp -d postgres</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- daily_users: 90日保持</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schedule_in_database</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;cleanup-daily-users&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;0 4 * * *&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- 毎日午前4時</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;SELECT cleanup_old_daily_users(90);&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;idpserver&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- monthly_users: 13ヶ月保持（YoY比較用）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schedule_in_database</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;cleanup-monthly-users&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;0 4 1 * *&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- 毎月1日午前4時</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;SELECT cleanup_old_monthly_users(13);&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;idpserver&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- statistics_monthly: 25ヶ月保持（YoY比較用）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schedule_in_database</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;cleanup-monthly-statistics&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;0 4 1 * *&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;SELECT cleanup_old_statistics(25);&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;idpserver&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- yearly_users, statistics_yearly: 永続保持（削除しない）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="94-判断のポイント">9.4 判断のポイント<a href="#94-判断のポイント" class="hash-link" aria-label="9.4 判断のポイント への直接リンク" title="9.4 判断のポイント への直接リンク">​</a></h3>
<p>パーティショニングを導入すべきかの判断基準:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  パーティショニング導入判断フローチャート                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Q1: 1日のデータ量は100GB以上か？                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      │                                                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ Yes → Q2へ                                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      └─ No  → パーティショニング不要（DELETE文で十分）                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Q2: 古いデータを日単位/月単位で一括削除したいか？                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      │                                                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ Yes → Q3へ                                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      └─ No  → パーティショニング不要                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Q3: クエリで日付範囲検索が主か？                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      │                                                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ├─ Yes → パーティショニング推奨                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      └─ No  → パーティショニング非推奨（プルーニング効果なし）              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>統計データテーブルの場合:</strong></p>
<ul>
<li>Q1: No（5GB/90日、100GB/日より大幅に小さい）</li>
<li>→ パーティショニング不要</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="10-関連issuepr">10. 関連Issue・PR<a href="#10-関連issuepr" class="hash-link" aria-label="10. 関連Issue・PR への直接リンク" title="10. 関連Issue・PR への直接リンク">​</a></h2>
<table><thead><tr><th>Issue/PR</th><th>内容</th></tr></thead><tbody><tr><td>#950</td><td>パーティショニング要件定義</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="11-pg_partman--pg_cron-初期化">11. pg_partman / pg_cron 初期化<a href="#11-pg_partman--pg_cron-初期化" class="hash-link" aria-label="11. pg_partman / pg_cron 初期化 への直接リンク" title="11. pg_partman / pg_cron 初期化 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="111-docker環境での初期化">11.1 Docker環境での初期化<a href="#111-docker環境での初期化" class="hash-link" aria-label="11.1 Docker環境での初期化 への直接リンク" title="11.1 Docker環境での初期化 への直接リンク">​</a></h3>
<p>idp-serverでは、Docker PostgreSQLイメージの初期化スクリプトで pg_partman と pg_cron を設定しています。</p>
<p><strong>重要</strong>: pg_cron はクロスデータベースモードで動作します。</p>
<ul>
<li>pg_cron 拡張は <code>postgres</code> データベースにインストール</li>
<li>ジョブは <code>cron.schedule_in_database()</code> で <code>idpserver</code> データベースを指定して実行</li>
<li>これにより複数データベースのジョブを一元管理可能</li>
</ul>
<p><strong>初期化スクリプト位置</strong>: <code>libs/idp-server-database/postgresql/init/02-init-partman.sh</code></p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">#!/bin/sh</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">set -eu</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Application owner user configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">: &quot;${DB_OWNER_USER:=idp}&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Initialize pg_cron in postgres database (cross-database setup)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># pg_cron is configured with cron.database_name=postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># This allows scheduling jobs that run on any database using</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># cron.schedule_in_database() function.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psql -v ON_ERROR_STOP=1 --username &quot;$POSTGRES_USER&quot; --dbname &quot;postgres&quot; &lt;&lt;-EOSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- pg_cron for scheduled execution (cross-database mode)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- Note: pg_cron must be in shared_preload_libraries</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CREATE EXTENSION IF NOT EXISTS pg_cron;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- Grant cron schema permissions to application owner user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- This allows the user to create and manage scheduled jobs</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GRANT USAGE ON SCHEMA cron TO ${DB_OWNER_USER};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA cron TO ${DB_OWNER_USER};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Initialize pg_partman in application database</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">psql -v ON_ERROR_STOP=1 --username &quot;$POSTGRES_USER&quot; --dbname &quot;$POSTGRES_DB&quot; &lt;&lt;-EOSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- pg_partman for partition management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CREATE SCHEMA IF NOT EXISTS partman;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CREATE EXTENSION IF NOT EXISTS pg_partman WITH SCHEMA partman;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- Grant permissions to application owner user</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- partman schema permissions</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GRANT USAGE, CREATE ON SCHEMA partman TO ${DB_OWNER_USER};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA partman TO ${DB_OWNER_USER};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA partman TO ${DB_OWNER_USER};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GRANT ALL ON ALL SEQUENCES IN SCHEMA partman TO ${DB_OWNER_USER};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- Grant file write permission for archive export</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- Required for COPY TO file in archive.export_partition_to_external_storage()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- This allows the DB owner to export archived partitions to local files.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -- Note: In production with AWS RDS/Aurora, use aws_s3 extension instead.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GRANT pg_write_server_files TO ${DB_OWNER_USER};</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EOSQL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Create archive export directory</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># pg_partman archive export writes CSV files to this directory.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># Located inside the data volume so it persists and is writable by postgres.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ARCHIVE_DIR=&quot;/var/lib/postgresql/data/archive&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mkdir -p &quot;$ARCHIVE_DIR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">chown postgres:postgres &quot;$ARCHIVE_DIR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Archive export directory created: $ARCHIVE_DIR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;pg_cron and pg_partman extensions initialized with permissions for &#x27;${DB_OWNER_USER}&#x27;&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="112-トラブルシューティング">11.2 トラブルシューティング<a href="#112-トラブルシューティング" class="hash-link" aria-label="11.2 トラブルシューティング への直接リンク" title="11.2 トラブルシューティング への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="permission-denied-エラー">Permission denied エラー<a href="#permission-denied-エラー" class="hash-link" aria-label="Permission denied エラー への直接リンク" title="Permission denied エラー への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/bin/sh: /docker-entrypoint-initdb.d/02-init-partman.sh: Permission denied</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原因</strong>: シェルスクリプトの読み取り権限が不足</p>
<p><strong>解決策</strong>:</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">chmod 755 libs/idp-server-database/postgresql/init/02-init-partman.sh</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="partman-スキーマが  存在しない">partman スキーマが存在しない<a href="#partman-スキーマが存在しない" class="hash-link" aria-label="partman スキーマが存在しない への直接リンク" title="partman スキーマが存在しない への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ERROR: schema &quot;partman&quot; does not exist</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原因</strong>: 初期化スクリプトが実行されていない</p>
<p><strong>解決策</strong>:</p>
<ol>
<li>
<p>Docker ボリュームを削除して再初期化</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose down -v</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">docker-compose up -d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p>手動で初期化（既存データがある場合）</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SCHEMA</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> partman</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> EXTENSION </span><span class="token keyword" style="color:#00009f">IF</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">NOT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">EXISTS</span><span class="token plain"> pg_partman </span><span class="token keyword" style="color:#00009f">WITH</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SCHEMA</span><span class="token plain"> partman</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="raise-notice-エラー">RAISE NOTICE エラー<a href="#raise-notice-エラー" class="hash-link" aria-label="RAISE NOTICE エラー への直接リンク" title="RAISE NOTICE エラー への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ERROR: syntax error at or near &quot;RAISE&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原因</strong>: <code>RAISE NOTICE</code> は PL/pgSQL 専用構文であり、プレーンSQLでは使用不可</p>
<p><strong>解決策</strong>: シェルの <code>echo</code> コマンドを使用</p>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># ❌ 誤り（EOSQL内）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># RAISE NOTICE &#x27;Completed&#x27;;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># ✅ 正解（EOSQL外）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">echo &quot;Completed&quot;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="113-docker-compose-設定">11.3 Docker Compose 設定<a href="#113-docker-compose-設定" class="hash-link" aria-label="11.3 Docker Compose 設定 への直接リンク" title="11.3 Docker Compose 設定 への直接リンク">​</a></h3>
<p>pg_partman / pg_cron を使用するには、<code>shared_preload_libraries</code> と <code>cron.database_name</code> の設定が必要です。</p>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">services</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">postgres</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">image</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><span class="token punctuation" style="color:#393A34">:</span><span class="token number" style="color:#36acaa">16</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># pg_cron はクロスデータベースモードで postgres データベースにインストール</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># pg_partman_bgw は使用せず、pg_cron でパーティション管理をスケジュール実行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">command</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">c shared_preload_libraries=pg_cron </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">c cron.database_name=postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">environment</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">POSTGRES_DB</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> idpserver</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">POSTGRES_USER</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> postgres</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">POSTGRES_PASSWORD</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> password</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">volumes</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain"> ./libs/idp</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">server</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">database/postgresql/init</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">/docker</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">entrypoint</span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">initdb.d</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Note</strong>:</p>
<ul>
<li><code>docker-entrypoint-initdb.d</code> のスクリプトは、データディレクトリが空の場合のみ実行されます。</li>
<li><code>cron.database_name=postgres</code> により、pg_cron は postgres データベースで動作し、<code>cron.schedule_in_database()</code> で他のデータベースのジョブも実行可能です。</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="12-運用カスタマイズ">12. 運用カスタマイズ<a href="#12-運用カスタマイズ" class="hash-link" aria-label="12. 運用カスタマイズ への直接リンク" title="12. 運用カスタマイズ への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="121-デフォルト設定">12.1 デフォルト設定<a href="#121-デフォルト設定" class="hash-link" aria-label="12.1 デフォルト設定 への直接リンク" title="12.1 デフォルト設定 への直接リンク">​</a></h3>
<table><thead><tr><th>項目</th><th>デフォルト値</th><th>設定場所</th></tr></thead><tbody><tr><td>メンテナンス実行時刻</td><td>毎日 02:00 UTC</td><td><code>setup-pg-cron-jobs.sql</code></td></tr><tr><td>security_event 保持期間</td><td>90日</td><td><code>V0_9_21_1__add_event_partitioning.sql</code></td></tr><tr><td>security_event_hook_results 保持期間</td><td>90日</td><td>同上</td></tr><tr><td>statistics_*_users 保持期間</td><td>テーブルにより異なる</td><td><code>V0_9_21_2__statistics.sql</code></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="122-cronスケジュールの変更">12.2 cronスケジュールの変更<a href="#122-cronスケジュールの変更" class="hash-link" aria-label="12.2 cronスケジュールの変更 への直接リンク" title="12.2 cronスケジュールの変更 への直接リンク">​</a></h3>
<p><code>setup-pg-cron-jobs.sql</code> を編集するか、直接SQLを実行します。</p>
<p><strong>重要</strong>: pg_cron は <code>postgres</code> データベースにインストールされているため、cron操作は <code>postgres</code> データベースに接続して行います。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- postgres データベースに接続して操作</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- psql -h localhost -U idp -d postgres</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 現在のスケジュール確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> jobid</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> jobname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> schedule</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">database</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> command</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> active </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">job</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- スケジュール変更（例: 毎時実行に変更）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">unschedule</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;partman-maintenance&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">schedule_in_database</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;partman-maintenance&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;0 * * * *&#x27;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- 毎時0分</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    $$</span><span class="token keyword" style="color:#00009f">CALL</span><span class="token plain"> partman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run_maintenance_proc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain">$$</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string" style="color:#e3116c">&#x27;idpserver&#x27;</span><span class="token plain">   </span><span class="token comment" style="color:#999988;font-style:italic">-- 実行対象データベース</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ジョブの一時停止</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">job </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> active </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">false</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> jobname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;partman-maintenance&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ジョブの再開</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">job </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> active </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> jobname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;partman-maintenance&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="123-保持期間の変更">12.3 保持期間の変更<a href="#123-保持期間の変更" class="hash-link" aria-label="12.3 保持期間の変更 への直接リンク" title="12.3 保持期間の変更 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 現在の設定確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> parent_table</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> partition_interval</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> retention</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> premake</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> partman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">part_config</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- security_event の保持期間を180日に変更</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> partman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">part_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> retention </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;180 days&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> parent_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;public.security_event&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- security_event_hook_results の保持期間を30日に短縮</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">UPDATE</span><span class="token plain"> partman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">part_config</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> retention </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;30 days&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> parent_table </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;public.security_event_hook_results&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="124-partmanpart_config-の主要設定項目">12.4 partman.part_config の主要設定項目<a href="#124-partmanpart_config-の主要設定項目" class="hash-link" aria-label="12.4 partman.part_config の主要設定項目 への直接リンク" title="12.4 partman.part_config の主要設定項目 への直接リンク">​</a></h3>
<table><thead><tr><th>カラム</th><th>説明</th><th>例</th></tr></thead><tbody><tr><td><code>partition_interval</code></td><td>パーティション間隔</td><td><code>1 day</code>, <code>1 month</code></td></tr><tr><td><code>retention</code></td><td>保持期間（超過で自動削除）</td><td><code>90 days</code>, <code>1 year</code></td></tr><tr><td><code>premake</code></td><td>事前作成するパーティション数</td><td><code>90</code></td></tr><tr><td><code>infinite_time_partitions</code></td><td>無限にパーティション作成</td><td><code>true</code></td></tr><tr><td><code>retention_keep_table</code></td><td>削除時にテーブルを残すか</td><td><code>false</code></td></tr><tr><td><code>retention_keep_index</code></td><td>削除時にインデックスを残すか</td><td><code>false</code></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="125-手動メンテナンス実行">12.5 手動メンテナンス実行<a href="#125-手動メンテナンス実行" class="hash-link" aria-label="12.5 手動メンテナンス実行 への直接リンク" title="12.5 手動メンテナンス実行 への直接リンク">​</a></h3>
<p>cronを待たずに即時実行したい場合：</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- パーティション作成・削除を即時実行</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CALL</span><span class="token plain"> partman</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">run_maintenance_proc</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 実行結果確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> cron</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">job_run_details </span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> runid </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="126-ddl-vs-運用スクリプトの切り分け">12.6 DDL vs 運用スクリプトの切り分け<a href="#126-ddl-vs-運用スクリプトの切り分け" class="hash-link" aria-label="12.6 DDL vs 運用スクリプトの切り分け への直接リンク" title="12.6 DDL vs 運用スクリプトの切り分け への直接リンク">​</a></h3>
<table><thead><tr><th>項目</th><th>管理場所</th><th>変更方法</th></tr></thead><tbody><tr><td>テーブル構造</td><td>DDL (Flyway)</td><td>新規マイグレーション作成</td></tr><tr><td>パーティション初期設定</td><td>DDL (Flyway)</td><td>新規マイグレーション作成</td></tr><tr><td>cronスケジュール</td><td><code>setup-pg-cron-jobs.sql</code></td><td>ファイル編集 or 直接SQL</td></tr><tr><td>保持期間</td><td><code>partman.part_config</code></td><td>直接SQL</td></tr></tbody></table>
<p><strong>設計思想</strong>: DDLはスキーマ定義（リリース時に確定）、運用設定は環境ごとに調整可能。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="13-参考資料">13. 参考資料<a href="#13-参考資料" class="hash-link" aria-label="13. 参考資料 への直接リンク" title="13. 参考資料 への直接リンク">​</a></h2>
<ul>
<li><a href="https://www.postgresql.org/docs/current/ddl-partitioning.html" target="_blank" rel="noopener noreferrer">PostgreSQL Table Partitioning</a></li>
<li><a href="https://github.com/citusdata/pg_cron" target="_blank" rel="noopener noreferrer">pg_cron Extension</a></li>
<li><a href="https://github.com/pgpartman/pg_partman" target="_blank" rel="noopener noreferrer">pg_partman Extension</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_06_developer-guide/08-reference/database-partitioning-guide.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_06_developer-guide/reference/code-review-checklist"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">05. コードレビューチェックリスト</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_06_developer-guide/reference/pg-partman-operations-guide"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">pg_partman + pg_cron パーティション運用ガイド</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#1-概要" class="table-of-contents__link toc-highlight">1. 概要</a><ul><li><a href="#11-パーティショニングとは" class="table-of-contents__link toc-highlight">1.1 パーティショニングとは</a></li><li><a href="#12-主なメリット" class="table-of-contents__link toc-highlight">1.2 主なメリット</a></li></ul></li><li><a href="#2-delete-vs-drop-table" class="table-of-contents__link toc-highlight">2. DELETE vs DROP TABLE</a><ul><li><a href="#21-delete文の動作通常テーブル" class="table-of-contents__link toc-highlight">2.1 DELETE文の動作（通常テーブル）</a></li><li><a href="#22-drop-tableの動作パーティションテーブル" class="table-of-contents__link toc-highlight">2.2 DROP TABLEの動作（ パーティションテーブル）</a></li><li><a href="#23-処理時間比較5億行日の場合" class="table-of-contents__link toc-highlight">2.3 処理時間比較（5億行/日の場合）</a></li></ul></li><li><a href="#3-パーティションプルーニング" class="table-of-contents__link toc-highlight">3. パーティションプルーニング</a><ul><li><a href="#31-プルーニングが効く場合" class="table-of-contents__link toc-highlight">3.1 プルーニングが効く場合</a></li><li><a href="#32-プルーニングが効かない場合" class="table-of-contents__link toc-highlight">3.2 プルーニングが効かない場合</a></li></ul></li><li><a href="#4-パーティショニングの制約" class="table-of-contents__link toc-highlight">4. パーティショニングの制約</a><ul><li><a href="#41-primary-key-の制約" class="table-of-contents__link toc-highlight">4.1 PRIMARY KEY の制約</a></li><li><a href="#42-外部キーforeign-keyの制約" class="table-of-contents__link toc-highlight">4.2 外部キー（FOREIGN KEY）の制約</a></li><li><a href="#43-運用上のオーバーヘッド" class="table-of-contents__link toc-highlight">4.3 運用上のオーバーヘッド</a></li></ul></li><li><a href="#5-パーティショニング適性判断" class="table-of-contents__link toc-highlight">5. パーティショニング適性判断</a><ul><li><a href="#51-チェックリスト" class="table-of-contents__link toc-highlight">5.1 チェックリスト</a></li><li><a href="#52-idp-serverのテーブル適性" class="table-of-contents__link toc-highlight">5.2 idp-serverのテーブル適性</a></li></ul></li><li><a href="#6-oauth_token-がパーティショニングに不向きな理由" class="table-of-contents__link toc-highlight">6. oauth_token がパーティショニングに不向きな理由</a><ul><li><a href="#61-イントロスペクションの検索パターン" class="table-of-contents__link toc-highlight">6.1 イントロスペクションの検索パターン</a></li><li><a href="#62-パーティショニングした場合の問題" class="table-of-contents__link toc-highlight">6.2 パーティショニングした場合の問題</a></li><li><a href="#63-oauth_token-の運用戦略" class="table-of-contents__link toc-highlight">6.3 oauth_token の運用戦略</a></li></ul></li><li><a href="#7-実装例" class="table-of-contents__link toc-highlight">7. 実装例</a><ul><li><a href="#71-パーティションテーブル作成v0_9_1" class="table-of-contents__link toc-highlight">7.1 パーティションテーブル作成（V0_9_1）</a></li><li><a href="#72-自動パーティション管理v0_9_2" class="table-of-contents__link toc-highlight">7.2 自動パーティション管理（V0_9_2）</a></li></ul></li><li><a href="#8-運用監視" class="table-of-contents__link toc-highlight">8. 運用監視</a><ul><li><a href="#81-パーティション一覧確認" class="table-of-contents__link toc-highlight">8.1 パーティション一覧確認</a></li><li><a href="#82-pg_cronジョブ状態確認" class="table-of-contents__link toc-highlight">8.2 pg_cronジョブ状態確認</a></li><li><a href="#83-defaultパーティション監視" class="table-of-contents__link toc-highlight">8.3 DEFAULTパーティション監視</a></li></ul></li><li><a href="#9-統計データテーブルのパーティショニング考察" class="table-of-contents__link toc-highlight">9. 統計データテーブルのパーティショニング考察</a><ul><li><a href="#91-統計データテーブル一覧" class="table-of-contents__link toc-highlight">9.1 統計データテーブル一覧</a></li><li><a href="#92-パーティショニング適性判断" class="table-of-contents__link toc-highlight">9.2 パーティショニング適性判断</a></li><li><a href="#93-推奨運用方法" class="table-of-contents__link toc-highlight">9.3 推奨運用方法</a></li><li><a href="#94-判断のポイント" class="table-of-contents__link toc-highlight">9.4 判断のポイント</a></li></ul></li><li><a href="#10-関連issuepr" class="table-of-contents__link toc-highlight">10. 関連Issue・PR</a></li><li><a href="#11-pg_partman--pg_cron-初期化" class="table-of-contents__link toc-highlight">11. pg_partman / pg_cron 初期化</a><ul><li><a href="#111-docker環境での初期化" class="table-of-contents__link toc-highlight">11.1 Docker環境での初期化</a></li><li><a href="#112-トラブルシューティング" class="table-of-contents__link toc-highlight">11.2 トラブルシューティング</a></li><li><a href="#113-docker-compose-設定" class="table-of-contents__link toc-highlight">11.3 Docker Compose 設定</a></li></ul></li><li><a href="#12-運用カスタマイズ" class="table-of-contents__link toc-highlight">12. 運用カスタマイズ</a><ul><li><a href="#121-デフォルト設定" class="table-of-contents__link toc-highlight">12.1 デフォルト設定</a></li><li><a href="#122-cronスケジュールの変更" class="table-of-contents__link toc-highlight">12.2 cronスケジュールの変更</a></li><li><a href="#123-保持期間の変更" class="table-of-contents__link toc-highlight">12.3 保持期間の変更</a></li><li><a href="#124-partmanpart_config-の主要設定項目" class="table-of-contents__link toc-highlight">12.4 partman.part_config の主要設定項目</a></li><li><a href="#125-手動メンテナンス実行" class="table-of-contents__link toc-highlight">12.5 手動メンテナンス実行</a></li><li><a href="#126-ddl-vs-運用スクリプトの切り分け" class="table-of-contents__link toc-highlight">12.6 DDL vs 運用スクリプトの切り分け</a></li></ul></li><li><a href="#13-参考資料" class="table-of-contents__link toc-highlight">13. 参考資料</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>