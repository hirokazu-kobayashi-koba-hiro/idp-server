<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_10_ai_developer/ai-11-core" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">idp-server-core - OAuth 2.0/OIDC準拠コアエンジン | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_10_ai_developer/ai-11-core"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="idp-server-core - OAuth 2.0/OIDC準拠コアエンジン | IdP-Server Documentation"><meta data-rh="true" name="description" content="モジュール概要"><meta data-rh="true" property="og:description" content="モジュール概要"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_10_ai_developer/ai-11-core"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_10_ai_developer/ai-11-core" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_10_ai_developer/ai-11-core" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.d90f1070.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.e38f4277.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">📚 ドキュメント索引</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">技術概要</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_01_intro/intro-02-features">機能</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_01_intro/intro-03-use-cases">ユースケース一覧</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">Getting-Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_02_quickstart/quickstart-02-setting-templates">初期設定テンプレート（予定）</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_03_concepts/concept-01-multi-tenant">コア概念</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-01-multi-tenant">マ  ルチテナント</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-02-id-management">ID（ユーザー）管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-03-id-verified">身元確認済みID</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-04-enterprise-id">エンタープライズID</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-05-authentication-policy">認証ポリシー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-06-token-management">トークン管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-07-session-management">セッション管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-08-mfa">多要素認証（MFA）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-09-custom-claims">カスタムクレーム・スコープ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-10-control-plane">コントロールプレーン</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-11-security-events">セキュリティイベント・フック</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-12-authorization">認可</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-13-audit-compliance">監査ログ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-14-grant-management">認可許諾管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-15-operations">運用・保守</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-16-external-service-integration">外部サービス連携</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-17-application-logging">アプリケーションログ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-18-id-token">IDトークン（ID Token）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-19-client">クライアント（Client）</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_03_concepts/basic/basic-01-identity-management-basics">基礎（読み物）</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認可プロトコル</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認可コードフロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_04_protocols/protocol-02-ciba-flow">CIBA フロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_04_protocols/protocol-03-introspection">イントロスペクション</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_05_how-to/index">How-to（設定・運用レシピ）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/index">How-to ガイド - 学習ロードマップ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-01-server-setup">サーバー初期設定ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-02-organization-initialization">組織初期化ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-03-tenant-setup">OIDCの最小設定ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-04-client-registration">クライアント登録ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-05-user-registration">ユーザー登録と初回認証</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-07-authentication-policy-basic">認証ポリシー設定ガイド（基礎編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-08-mfa-setup">MFA（多要素認証）の設定</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-09-token-strategy">トークン有効期限パターン</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-10-authentication-policy-advanced">認証ポリシー設定ガイド（詳細編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-11-federation-setup">外部IdP連携（Federation）の設定</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-12-ciba-flow-fido-uaf">CIBA + FIDO-UAF</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-13-fido-uaf-registration">FIDO-UAF 登録フロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-14-fido-uaf-deregistration">FIDO-UAF 解除フロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-15-identity-verification-guide">身元確認申込み 導入ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-16-identity-verification-application">身元確認申込み</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-17-identity-verification-registration">身元確認データ登録</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-18-security-event-hooks">セキュリティイベントフック設定ガイド</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/control-plane/resource-overview">Control Plane（管理API）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">Application Plane（認証・認可API）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/overview">Implementation Guides（実装ガイド）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/configuration/CONFIGURATION_COVERAGE">Configuration（設定）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/patterns/common-patterns">Patterns（実装パターン）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/troubleshooting/common-errors">Troubleshooting（トラブルシューティング）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/code-review-checklist">Reference（リファレンス）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/learning-paths/beginner">Learning Paths（学習パス）</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_07_reference/api-reference">API ドキュメント</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">テスト戦略</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_08_ops/ops-02-performance-test">ストレステスト結果</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_08_ops/commercial-deployment/overview">商用デプロイ</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-01-faq">project-01-faq</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-02-roadmap">🗺️ ロードマップ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-03-contributing">コントリビュートガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-04-license">License</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI開発者向けモジュールガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-02-lessons-learned">AI開発者向けドキュメント作成ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-10-use-cases">idp-server-use-cases - ユースケース層（EntryService実装）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-11-core">idp-server-core - OAuth 2.0/OIDC準拠コアエンジン</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-12-platform">idp-server-platform - プラットフォーム基盤</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-13-control-plane">idp-server-control-plane - 管理API契約定義</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-20-adapters">Adapter層 - Repository実装とインフラ統合</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-21-core-adapter">idp-server-core-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-22-database">idp-server-database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-23-springboot-adapter">idp-server-springboot-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-30-extensions">拡張機能層 - OAuth/OIDC拡張仕様</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-31-extension-ciba">idp-server-core-extension-ciba - CIBA拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-32-extension-fapi">idp-server-core-extension-fapi - FAPI拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-33-extension-ida">idp-server-core-extension-ida - IDA拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-34-extension-pkce">idp-server-core-extension-pkce - PKCE拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-35-extension-vc">idp-server-core-extension-verifiable-credentials - VC拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-40-authentication-federation">認証・連携層 - ユーザー認証とフェデレーション</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-41-authentication">idp-server-authentication-interactors - 認証インタラクター</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-42-webauthn">idp-server-webauthn4j-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-43-federation-oidc">idp-server-federation-oidc</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-50-notification-security-event">通知・イベント層 - 通知配信とセキュリティイベント</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-51-notification-fcm">idp-server-notification-fcm-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-52-notification-apns">idp-server-notification-apns-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-53-email-aws">idp-server-email-aws-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-54-security-event-framework">idp-server-security-event-framework</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-55-security-event-hooks">idp-server-security-event-hooks</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">AI</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">idp-server-core - OAuth 2.0/OIDC準拠コアエンジン</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>idp-server-core - OAuth 2.0/OIDC準拠コアエンジン</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="モジュール概要">モジュール概要<a href="#モジュール概要" class="hash-link" aria-label="モジュール概要 への直接リンク" title="モジュール概要 への直接リンク">​</a></h2>
<p><strong>情報源</strong>: <code>libs/idp-server-core/src/main/java/org/idp/server/core/</code>
<strong>確認日</strong>: 2025-10-12</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="責務">責務<a href="#責務" class="hash-link" aria-label="責務 への直接リンク" title="責務 への直接リンク">​</a></h3>
<p>OAuth 2.0、OpenID Connect (OIDC)、およびその拡張仕様に準拠した認証・認可・トークン発行のドメインロジックを提供。</p>
<ul>
<li><strong>プロトコル準拠</strong>: RFC 6749 (OAuth 2.0), RFC 6750 (Bearer Token), OpenID Connect Core 1.0等</li>
<li><strong>ドメインロジック</strong>: Handler-Service-Repositoryパターンによる層責任分離</li>
<li><strong>拡張可能性</strong>: Pluginインターフェースによる機能拡張</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="依存関係">依存関係<a href="#依存関係" class="hash-link" aria-label="依存関係 への直接リンク" title="依存関係 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">idp-server-core</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓ (依存)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">idp-server-platform (マルチテナント・セッション・ログ等)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ディレクトリ構造">ディレクトリ構造<a href="#ディレクトリ構造" class="hash-link" aria-label="ディレクトリ構造 への直接リンク" title="ディレクトリ構造 への直接リンク">​</a></h2>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">libs/idp-server-core/src/main/java/org/idp/server/core/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├── openid/</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── authentication/       # 認証ドメイン</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── discovery/           # OIDC Discovery</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── federation/          # フェデレーション</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── grant_management/    # グラント管理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── identity/            # Identity・身元確認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── oauth/               # OAuth 2.0コア</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── plugin/              # プラグインインターフェース</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ├── token/               # トークン処理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └── userinfo/            # UserInfo エンドポイント</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>情報源</strong>: <code>find libs/idp-server-core/src/main/java/org/idp/server/core -type d -maxdepth 2</code></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="アーキテクチャパターン">アーキテクチャパターン<a href="#アーキテクチャパターン" class="hash-link" aria-label="アーキテクチャパターン への直接リンク" title="アーキテクチャパターン への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="handler-service-repository-パターン">Handler-Service-Repository パターン<a href="#handler-service-repository-パターン" class="hash-link" aria-label="Handler-Service-Repository パターン への直接リンク" title="Handler-Service-Repository パターン への直接リンク">​</a></h3>
<p>idp-server-coreでは、以下の3層パターンでドメインロジックを実装：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-handler---プロトコル処理オーケストレーション">1. Handler - プロトコル処理・オーケストレーション<a href="#1-handler---プロトコル処理オーケストレーション" class="hash-link" aria-label="1. Handler - プロトコル処理・オーケストレーション への直接リンク" title="1. Handler - プロトコル処理・オーケストレーション への直接リンク">​</a></h4>
<p><strong>命名規則</strong>: <code>{&#x27;{Domain}{Action}Handler&#x27;}</code></p>
<p><strong>責務</strong>:</p>
<ul>
<li>プロトコルリクエストの受け取り</li>
<li>Validator/Verifierによる検証</li>
<li>Repositoryからのデータ取得</li>
<li>Service/Creatorへの処理委譲</li>
<li>プロトコルレスポンスの生成</li>
</ul>
<p><strong>実装例</strong>: <a href="/idp-server/libs/idp-server-core/src/main/java/org/idp/server/core/openid/oauth/handler/OAuthAuthorizeHandler.java#L51">OAuthAuthorizeHandler.java:51</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 情報源: libs/idp-server-core/src/main/java/org/idp/server/core/openid/oauth/handler/OAuthAuthorizeHandler.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの77-133行目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OAuthAuthorizeHandler {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LoggerWrapper log = LoggerWrapper.getLogger(OAuthAuthorizeHandler.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationResponseCreators creators;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationRequestRepository authorizationRequestRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationCodeGrantRepository authorizationCodeGrantRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OAuthTokenCommandRepository oAuthTokenCommandRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationServerConfigurationQueryRepository authorizationServerConfigurationQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientConfigurationQueryRepository clientConfigurationQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public AuthorizationResponse handle(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      OAuthAuthorizeRequest request, OAuthSessionDelegate delegate) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. リクエストから必要情報を抽出</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tenant tenant = request.tenant();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorizationRequestIdentifier authorizationRequestIdentifier = request.toIdentifier();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User user = request.user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Authentication authentication = request.authentication();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    CustomProperties customProperties = request.toCustomProperties();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DeniedScopes deniedScopes = request.toDeniedScopes();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. Validatorで入力検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OAuthAuthorizeRequestValidator validator =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new OAuthAuthorizeRequestValidator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            authorizationRequestIdentifier, user, authentication, customProperties);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    validator.validate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 3. Repositoryからデータ取得（注意: Tenant第一引数）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorizationRequest authorizationRequest =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authorizationRequestRepository.get(tenant, authorizationRequestIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RequestedClientId requestedClientId = authorizationRequest.requestedClientId();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorizationServerConfiguration authorizationServerConfiguration =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        authorizationServerConfigurationQueryRepository.get(tenant);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientConfiguration clientConfiguration =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        clientConfigurationQueryRepository.get(tenant, requestedClientId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 4. Contextを構築</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OAuthAuthorizeContext context =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new OAuthAuthorizeContext(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            authorizationRequest,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            user,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            authentication,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            customProperties,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            deniedScopes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            authorizationServerConfiguration,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            clientConfiguration);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 5. Creatorでレスポンス生成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorizationResponseCreator authorizationResponseCreator =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        creators.get(context.responseType());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorizationResponse authorizationResponse = authorizationResponseCreator.create(context);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 6. 認可コード/トークンの永続化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorizationGrant authorizationGrant = context.authorize();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (authorizationResponse.hasAuthorizationCode()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AuthorizationCodeGrant authorizationCodeGrant =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          AuthorizationCodeGrantCreator.create(context, authorizationResponse);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      authorizationCodeGrantRepository.register(tenant, authorizationCodeGrant);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (authorizationResponse.hasAccessToken()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      OAuthToken oAuthToken = OAuthTokenFactory.create(authorizationResponse, authorizationGrant);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      oAuthTokenCommandRepository.register(tenant, oAuthToken);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 7. セッション登録</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OAuthSessionKey oAuthSessionKey =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new OAuthSessionKey(tenant.identifierValue(), requestedClientId.value());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OAuthSession session =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        OAuthSession.create(oAuthSessionKey, user, authentication, authorizationRequest.maxAge());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    delegate.registerSession(session);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return authorizationResponse;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要ポイント</strong>:</p>
<ul>
<li>✅ <strong>Tenant第一引数</strong>: 全Repository操作で<code>Tenant</code>を最初に渡す（マルチテナント分離）</li>
<li>✅ <strong>Validator/Verifier分離</strong>: 入力検証とビジネスルール検証を明確に分離</li>
<li>✅ <strong>Context Pattern</strong>: ドメインロジックをContextオブジェクトにカプセル化</li>
<li>✅ <strong>Factory/Creator</strong>: オブジェクト生成ロジックを専用クラスに分離</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-service---純粋ビジネスロジック">2. Service - 純粋ビジネスロジック<a href="#2-service---純粋ビジネスロジック" class="hash-link" aria-label="2. Service - 純粋ビジネスロジック への直接リンク" title="2. Service - 純粋ビジネスロジック への直接リンク">​</a></h4>
<p><strong>命名規則</strong>: <code>{&#x27;{Domain}{Action}Service&#x27;}</code></p>
<p><strong>責務</strong>:</p>
<ul>
<li>RFC準拠のビジネスロジック実装</li>
<li>副作用のない純粋な処理（可能な限り）</li>
<li>複数のRepositoryを組み合わせたロジック</li>
</ul>
<p><strong>実装例</strong>: <a href="/idp-server/libs/idp-server-core/src/main/java/org/idp/server/core/openid/token/service/AuthorizationCodeGrantService.java#L96">AuthorizationCodeGrantService.java:96</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 4.1.3. Access Token Request authorization code handling</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;The client makes a request to the token endpoint by sending the following parameters using the</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &quot;application/x-www-form-urlencoded&quot; format per Appendix B with a character encoding of UTF-8 in</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * the HTTP request entity-body:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;grant_type REQUIRED. Value MUST be set to &quot;authorization_code&quot;.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;code REQUIRED. The authorization code received from the authorization server.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;redirect_uri REQUIRED, if the &quot;redirect_uri&quot; parameter was included in the authorization</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     request as described in Section 4.1.1, and their values MUST be identical.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;client_id REQUIRED, if the client is not authenticating with the authorization server as</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *     described in Section 3.2.1.</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;For example, the client makes the following HTTP request using TLS (with extra line breaks for</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * display purposes only):</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;POST /token HTTP/1.1 Host: server.example.com Authorization: Basic</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * czZCaGRSa3F0MzpnWDFmQmF0M2JW Content-Type: application/x-www-form-urlencoded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &lt;p&gt;grant_type=authorization_code&amp;code=SplxlOBeZQQYbYS6WxSbIA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * &amp;redirect_uri=https%3A%2F%2Fclient%2Eexample%2Ecom%2Fcb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * @see &lt;a href=&quot;https://www.rfc-editor.org/rfc/rfc6749#section-4.1.3&quot;&gt;4.1.3. Access Token Request&lt;/a&gt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> *</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 情報源: libs/idp-server-core/src/main/java/org/idp/server/core/openid/token/service/AuthorizationCodeGrantService.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの1-95行目（Javadocコメント）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizationCodeGrantService</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    implements OAuthTokenCreationService, RefreshTokenCreatable, CNonceCreatable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationRequestRepository authorizationRequestRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OAuthTokenCommandRepository oAuthTokenCommandRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要ポイント</strong>:</p>
<ul>
<li>✅ <strong>RFC引用Javadoc</strong>: 仕様書の章番号・引用を必ず記載</li>
<li>✅ <strong>インターフェース実装</strong>: 機能特性をインターフェースで表現（<code>RefreshTokenCreatable</code>等）</li>
<li>✅ <strong>ビジネスロジック集中</strong>: プロトコル詳細はServiceに集約</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-repository---データアクセス抽象化">3. Repository - データアクセス抽象化<a href="#3-repository---データアクセス抽象化" class="hash-link" aria-label="3. Repository - データアクセス抽象化 への直接リンク" title="3. Repository - データアクセス抽象化 への直接リンク">​</a></h4>
<p><strong>命名規則</strong>: <code>{&#x27;{Entity}QueryRepository&#x27;}</code> / <code>{&#x27;{Entity}CommandRepository&#x27;}</code></p>
<p><strong>責務</strong>:</p>
<ul>
<li>CQRS (Command Query Responsibility Segregation) パターン</li>
<li>データソースへのアクセス抽象化</li>
<li><strong>ドメインロジック禁止</strong> - データアクセスのみ</li>
</ul>
<p><strong>実装例</strong>: <a href="/idp-server/libs/idp-server-core/src/main/java/org/idp/server/core/openid/oauth/configuration/client/ClientConfigurationQueryRepository.java#L23">ClientConfigurationQueryRepository.java:23</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 情報源: libs/idp-server-core/src/main/java/org/idp/server/core/openid/oauth/configuration/client/ClientConfigurationQueryRepository.java</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの23-39行目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public interface ClientConfigurationQueryRepository {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 必須存在: get() - データが存在しない場合は例外スロー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientConfiguration get(Tenant tenant, RequestedClientId requestedClientId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientConfiguration get(Tenant tenant, ClientIdentifier clientIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 任意存在: find() - データが存在しない場合はnull/空を返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientConfiguration find(Tenant tenant, ClientIdentifier clientIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientConfiguration findWithDisabled(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Tenant tenant, ClientIdentifier clientIdentifier, boolean includeDisabled);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ リスト取得: findList()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;ClientConfiguration&gt; findList(Tenant tenant, int limit, int offset);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;ClientConfiguration&gt; findList(Tenant tenant, ClientQueries queries);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ カウント: findTotalCount()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  long findTotalCount(Tenant tenant, ClientQueries queries);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要ポイント</strong>:</p>
<ul>
<li>🚨 <strong>Tenant第一引数必須</strong>: 全メソッドで<code>Tenant</code>が第一引数（マルチテナント分離の基本原則）<!-- -->
<ul>
<li><strong>例外</strong>: <code>OrganizationRepository</code>のみ（組織はテナントより上位概念）</li>
</ul>
</li>
<li>✅ <strong>get() vs find()</strong>: <code>get()</code>は必須存在、<code>find()</code>は任意存在</li>
<li>✅ <strong>Query/Command分離</strong>: 読み取り（Query）と書き込み（Command）でインターフェース分離</li>
<li>✅ <strong>値オブジェクト引数</strong>: <code>String</code>ではなく<code>RequestedClientId</code>等の型安全な値オブジェクト</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="validator-vs-verifier">Validator vs Verifier<a href="#validator-vs-verifier" class="hash-link" aria-label="Validator vs Verifier への直接リンク" title="Validator vs Verifier への直接リンク">​</a></h3>
<p><strong>Validator</strong>: 入力形式チェック → <code>{&#x27;{Operation}BadRequestException&#x27;}</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 形式チェック: nullチェック、形式妥当性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OAuthAuthorizeRequestValidator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void validate() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throwExceptionIfIdentifierIsInvalid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throwExceptionIfUserIsInvalid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throwExceptionIfAuthenticationIsInvalid();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>Verifier</strong>: ビジネスルール検証 → <code>OAuthRedirectableBadRequestException</code></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ビジネスルール: プロトコル仕様準拠チェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizationCodeGrantVerifier {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void verify() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verifyAuthorizationCode();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verifyClientAuthentication();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    verifyRedirectUri();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verifierの階層パターンbase--extension">Verifierの階層パターン（Base + Extension）<a href="#verifierの階層パターンbase--extension" class="hash-link" aria-label="Verifierの階層パターン（Base + Extension） への直接リンク" title="Verifierの階層パターン（Base + Extension） への直接リンク">​</a></h3>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-core/src/main/java/org/idp/server/core/openid/token/verifier/AuthorizationCodeGrantVerifier.java#L29">AuthorizationCodeGrantVerifier.java:29</a></p>
<p>idp-serverのVerifierは、**Base Verifier（OAuth2/OIDC）+ Extension Verifier（PKCE/FAPI等）**の2層構造。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorizationcodegrantverifier---統合verifier">AuthorizationCodeGrantVerifier - 統合Verifier<a href="#authorizationcodegrantverifier---統合verifier" class="hash-link" aria-label="AuthorizationCodeGrantVerifier - 統合Verifier への直接リンク" title="AuthorizationCodeGrantVerifier - 統合Verifier への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Authorization Code Grant統合Verifier</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * Base + Extensionの両方を実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの29-77行目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizationCodeGrantVerifier {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Map&lt;AuthorizationProfile, AuthorizationCodeGrantVerifierInterface&gt; baseVerifiers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;AuthorizationCodeGrantExtensionVerifierInterface&gt; extensionVerifiers;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public AuthorizationCodeGrantVerifier() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Base Verifier登録（OAuth2/OIDC）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.baseVerifiers = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseVerifiers.put(AuthorizationProfile.OAUTH2, new AuthorizationCodeGrantOAuth2Verifier());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseVerifiers.put(AuthorizationProfile.OIDC, new AuthorizationCodeGrantOidcVerifier());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ PluginからBase Verifierロード（FAPI_BASELINE, FAPI_ADVANCE等）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Map&lt;AuthorizationProfile, AuthorizationCodeGrantVerifierInterface&gt; loadedBaseVerifiers =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AuthorizationCodeGrantVerifierPluginLoader.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseVerifiers.putAll(loadedBaseVerifiers);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Extension Verifierロード（PKCE等）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.extensionVerifiers = AuthorizationCodeGrantExtensionVerifierPluginLoader.load();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public void verify(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TokenRequestContext tokenRequestContext,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AuthorizationRequest authorizationRequest,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AuthorizationCodeGrant authorizationCodeGrant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ClientCredentials clientCredentials) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 1. Base Verifier実行（プロファイル別）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorizationCodeGrantVerifierInterface baseVerifier =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        baseVerifiers.get(authorizationRequest.profile());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (baseVerifier == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      throw new UnSupportedException(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;Unsupported profile: &quot; + authorizationRequest.profile().name());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    baseVerifier.verify(tokenRequestContext, authorizationRequest, authorizationCodeGrant, clientCredentials);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 2. Extension Verifier実行（shouldVerify() でフィルタリング）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    extensionVerifiers.forEach(extensionVerifier -&gt; {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      if (extensionVerifier.shouldVerify(...)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        extensionVerifier.verify(...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    });</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="base-verifier---プロファイル別検証">Base Verifier - プロファイル別検証<a href="#base-verifier---プロファイル別検証" class="hash-link" aria-label="Base Verifier - プロファイル別検証 への直接リンク" title="Base Verifier - プロファイル別検証 への直接リンク">​</a></h4>
<table><thead><tr><th>AuthorizationProfile</th><th>Base Verifier</th><th>検証内容</th></tr></thead><tbody><tr><td><code>OAUTH2</code></td><td><code>AuthorizationCodeGrantOAuth2Verifier</code></td><td>OAuth 2.0基本検証</td></tr><tr><td><code>OIDC</code></td><td><code>AuthorizationCodeGrantOidcVerifier</code></td><td>OIDC追加検証（nonce等）</td></tr><tr><td><code>FAPI_BASELINE</code></td><td><code>AuthorizationCodeGrantFapiBaselineVerifier</code></td><td>FAPI Baseline要件</td></tr><tr><td><code>FAPI_ADVANCE</code></td><td><code>AuthorizationCodeGrantFapiAdvanceVerifier</code></td><td>FAPI Advanced要件</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="extension-verifier---拡張仕様検証">Extension Verifier - 拡張仕様検証<a href="#extension-verifier---拡張仕様検証" class="hash-link" aria-label="Extension Verifier - 拡張仕様検証 への直接リンク" title="Extension Verifier - 拡張仕様検証 への直接リンク">​</a></h4>
<table><thead><tr><th>Extension Verifier</th><th>検証内容</th><th>shouldVerify条件</th><th>実装モジュール</th></tr></thead><tbody><tr><td><code>PkceVerifier</code></td><td>code_verifier検証</td><td>リクエストにcode_challengeが含まれる</td><td><a href="/idp-server/docs/content_10_ai_developer/ai-34-extension-pkce">idp-server-core-extension-pkce</a></td></tr><tr><td>FAPI Base/Advance</td><td>JAR/JARM/MTLS要件</td><td>プロファイルがFAPI</td><td><a href="/idp-server/docs/content_10_ai_developer/ai-32-extension-fapi">idp-server-core-extension-fapi</a></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="verifierパターンの利点">Verifierパターンの利点<a href="#verifierパターンの利点" class="hash-link" aria-label="Verifierパターンの利点 への直接リンク" title="Verifierパターンの利点 への直接リンク">​</a></h3>
<ol>
<li>✅ <strong>プロファイル別検証</strong>: OAuth2/OIDC/FAPI等を自動選択</li>
<li>✅ <strong>拡張可能性</strong>: Extension VerifierをPluginで追加可能</li>
<li>✅ <strong>条件付き実行</strong>: shouldVerify()で不要な検証をスキップ</li>
<li>✅ <strong>責務分離</strong>: Base（仕様準拠）とExtension（追加要件）を分離</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="拡張モジュールとの統合">拡張モジュールとの統合<a href="#拡張モジュールとの統合" class="hash-link" aria-label="拡張モジュールとの統合 への直接リンク" title="拡張モジュールとの統合 への直接リンク">​</a></h3>
<p>**Core層（本モジュール）**が提供:</p>
<ul>
<li><code>AuthorizationCodeGrantVerifier</code> - 統合Verifier</li>
<li><code>AuthorizationCodeGrantVerifierInterface</code> - Base Verifierインターフェース</li>
<li><code>AuthorizationCodeGrantExtensionVerifierInterface</code> - Extension Verifierインターフェース</li>
<li>Plugin読み込み機構</li>
</ul>
<p><strong>拡張モジュール</strong>が実装:</p>
<ul>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-34-extension-pkce">PKCE</a>: <code>PkceVerifier</code> (Extension Verifier)</li>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-32-extension-fapi">FAPI</a>: <code>FapiBaselineVerifier</code>, <code>FapiAdvanceVerifier</code> (Base Verifier)</li>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-31-extension-ciba">CIBA</a>: CIBA専用Verifier</li>
</ul>
<p><strong>統合フロー</strong>:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. Core層がPlugin Loaderで拡張Verifierをロード</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. AuthorizationProfileに基づいてBase Verifier選択</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. Extension Verifierを条件付きで全実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 全検証が成功した場合のみ処理継続</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードに コードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>詳細</strong>: <a href="/idp-server/docs/content_10_ai_developer/ai-30-extensions">拡張機能層統合ドキュメント</a></p>
<p><strong>情報源</strong>: CLAUDE.md「検証・エラーハンドリング」セクション</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="主要ドメイン">主要ドメイン<a href="#主要ドメイン" class="hash-link" aria-label="主要ドメイン への直接リンク" title="主要ドメイン への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="1-oauth-openidoauth">1. OAuth (<code>openid/oauth/</code>)<a href="#1-oauth-openidoauth" class="hash-link" aria-label="1-oauth-openidoauth への直接リンク" title="1-oauth-openidoauth への直接リンク">​</a></h3>
<p>OAuth 2.0準拠の認可フロー実装。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラス一覧">主要クラス一覧<a href="#主要クラス一覧" class="hash-link" aria-label="主要クラス一覧 への直接リンク" title="主要クラス一覧 への直接リンク">​</a></h4>
<table><thead><tr><th>クラス</th><th>責務</th></tr></thead><tbody><tr><td><code>OAuthAuthorizeHandler</code></td><td>認可リクエスト処理</td></tr><tr><td><code>OAuthHandler</code></td><td>トークンエンドポイント処理</td></tr><tr><td><code>AuthorizationRequest</code></td><td>認可リクエストドメインモデル</td></tr><tr><td><code>AuthorizationResponse</code></td><td>認可レスポンスド  メインモデル</td></tr><tr><td><code>OAuthSession</code></td><td>OAuthセッション管理</td></tr><tr><td><code>OAuthAuthorizeContext</code></td><td>認可コンテキスト</td></tr><tr><td><code>AuthorizationServerConfiguration</code></td><td>認可サーバー設定</td></tr><tr><td><code>ClientConfiguration</code></td><td>クライアント設定</td></tr></tbody></table>
<p><strong>情報源</strong>: <code>libs/idp-server-core/src/main/java/org/idp/server/core/openid/oauth/</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorizationrequest---認可リクエストドメインモデル">AuthorizationRequest - 認可リクエストドメインモデル<a href="#authorizationrequest---認可リクエストドメインモデル" class="hash-link" aria-label="AuthorizationRequest - 認可リクエストドメインモデル への直接リンク" title="AuthorizationRequest - 認可リクエストドメインモデル への直接リンク">​</a></h4>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-core/src/main/java/org/idp/server/core/openid/oauth/request/AuthorizationRequest.java#L34">AuthorizationRequest.java:34</a></p>
<p>OAuth 2.0/OIDC認可リクエストの全パラメータを型安全に保持。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 認可リクエストドメインモデル</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの34-150行目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizationRequest {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 識別子・テナント</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationRequestIdentifier identifier;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TenantIdentifier tenantIdentifier;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationProfile profile;  // OIDC/OAuth2/FAPI等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ OAuth 2.0必須パラメータ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ResponseType responseType;          // code, token, id_token等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RequestedClientId requestedClientId;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RedirectUri redirectUri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Scopes scopes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  State state;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ OAuth 2.0オプションパラメータ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ResponseMode responseMode;          // query, fragment, form_post</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ OIDC拡張パラメータ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Nonce nonce;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Display display;                    // page, popup, touch, wap</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Prompts prompts;                    // none, login, consent, select_account</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MaxAge maxAge;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UiLocales uiLocales;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  IdTokenHint idTokenHint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LoginHint loginHint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AcrValues acrValues;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClaimsValue claimsValue;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ JAR (JWT Authorization Request)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RequestObject requestObject;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RequestUri requestUri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RequestedClaimsPayload requestedClaimsPayload;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ PKCE (Proof Key for Code Exchange)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CodeChallenge codeChallenge;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CodeChallengeMethod codeChallengeMethod;  // S256, plain</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ RAR (Rich Authorization Requests)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationDetails authorizationDetails;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ カスタムパラメータ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  CustomParams customParams;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientAttributes clientAttributes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 有効期限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ExpiresIn expiresIn;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ExpiresAt expiresAt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 判定メソッド</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean hasScope() { return scopes.exists(); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean hasNonce() { return nonce.exists(); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean hasCodeChallenge() { return codeChallenge.exists(); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean hasAuthorizationDetails() { return authorizationDetails.exists(); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要ポイント</strong>:</p>
<ul>
<li>✅ <strong>全パラメータ型安全</strong>: <code>String</code>ではなく値オブジェクト（<code>Scopes</code>, <code>ResponseType</code>等）</li>
<li>✅ <strong>判定メソッド</strong>: <code>has*()</code>で存在チェック</li>
<li>✅ <strong>不変オブジェクト</strong>: Immutable設計</li>
<li>✅ <strong>拡張対応</strong>: PKCE/JAR/RAR等の拡張仕様をサポート</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorizationresponse---認可レスポンスドメインモデル">AuthorizationResponse - 認可レスポンスドメイン モデル<a href="#authorizationresponse---認可レスポンスドメインモデル" class="hash-link" aria-label="AuthorizationResponse - 認可レスポンスドメインモデル への直接リンク" title="AuthorizationResponse - 認可レスポンスドメインモデル への直接リンク">​</a></h4>
<p><strong>ResponseType別のCreatorパターン</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ResponseType: code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthorizationResponseCodeCreator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → AuthorizationResponse.with(code, state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ResponseType: token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthorizationResponseTokenCreator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → AuthorizationResponse.with(accessToken, tokenType, expiresIn, state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ResponseType: id_token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthorizationResponseIdTokenCreator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → AuthorizationResponse.with(idToken, state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ResponseType: code token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthorizationResponseCodeTokenCreator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → AuthorizationResponse.with(code, accessToken, tokenType, expiresIn, state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ResponseType: code id_token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthorizationResponseCodeIdTokenCreator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → AuthorizationResponse.with(code, idToken, state)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ResponseType: code id_token token</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthorizationResponseCodeIdTokenTokenCreator</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  → AuthorizationResponse.with(code, idToken, accessToken, tokenType, expiresIn, state)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>情報源</strong>: <code>libs/idp-server-core/src/main/java/org/idp/server/core/openid/oauth/response/</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="oauthsession---セッション管理">OAuthSession - セッション管理<a href="#oauthsession---セッション管理" class="hash-link" aria-label="OAuthSession - セッション管理 への直接リンク" title="OAuthSession - セッション管理 への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class OAuthSession {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OAuthSessionKey key;              // (tenantId, clientId)のペア</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  User user;                        // 認証済みユーザー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Authentication authentication;    // 認証情報</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  MaxAge maxAge;                    // セッション有効期限</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Instant authenticatedAt;          // 認証時刻</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ セッション作成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static OAuthSession create(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      OAuthSessionKey key,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      User user,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Authentication authentication,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      MaxAge maxAge) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new OAuthSession(key, user, authentication, maxAge, Instant.now());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ セッション有効性チェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean isExpired() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!maxAge.exists()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return false;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Instant expiresAt = authenticatedAt.plusSeconds(maxAge.value());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return Instant.now().isAfter(expiresAt);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>用途</strong>: SSO（Single Sign-On）実現のためのセッション管理。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="configuration---設定ドメインモデル">Configuration - 設定ドメインモデル<a href="#configuration---設定ドメインモデル" class="hash-link" aria-label="Configuration - 設定ドメインモデル への直接リンク" title="Configuration - 設定ドメインモデル への直接リンク">​</a></h4>
<p><strong>AuthorizationServerConfiguration</strong> - 認可サーバー設定:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizationServerConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String issuer;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String authorizationEndpoint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String tokenEndpoint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String userinfoEndpoint;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String jwksUri;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;String&gt; responseTypesSupported;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;String&gt; grantTypesSupported;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;String&gt; scopesSupported;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;String&gt; tokenEndpointAuthMethodsSupported;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 判定メソッド</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean supportsResponseType(ResponseType responseType) { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean supportsGrantType(GrantType grantType) { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean supportsScope(Scope scope) { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>ClientConfiguration</strong> - クライアント設定:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ClientConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientIdentifier identifier;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientName name;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientType clientType;              // public, confidential</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  RedirectUris redirectUris;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GrantTypes grantTypes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ResponseTypes responseTypes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Scopes scopes;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientSecret clientSecret;          // confidentialのみ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TokenEndpointAuthMethod tokenEndpointAuthMethod;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 判定メソッド</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean isConfidential() { return clientType.isConfidential(); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean allowsGrantType(GrantType grantType) { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean allowsRedirectUri(RedirectUri redirectUri) { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2-token-openidtoken">2. Token (<code>openid/token/</code>)<a href="#2-token-openidtoken" class="hash-link" aria-label="2-token-openidtoken への直接リンク" title="2-token-openidtoken への直接リンク">​</a></h3>
<p>トークン発行・検証・リフレッシュ処理。</p>
<p><strong>主要クラス</strong>:</p>
<ul>
<li><code>AuthorizationCodeGrantService</code> - 認可コードフロー</li>
<li><code>ClientCredentialsGrantService</code> - クライアントクレデンシャルフロー</li>
<li><code>RefreshTokenGrantService</code> - リフレッシュトークンフロー</li>
<li><code>OAuthTokenCreationService</code> - トークン生成インターフェース</li>
</ul>
<p><strong>Grant Type拡張パターン</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Map&lt;GrantType, Service&gt; パターン</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Map&lt;GrantType, OAuthTokenCreationService&gt; services = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.put(GrantType.AUTHORIZATION_CODE, new AuthorizationCodeGrantService(...));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.put(GrantType.CLIENT_CREDENTIALS, new ClientCredentialsGrantService(...));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">services.put(GrantType.REFRESH_TOKEN, new RefreshTokenGrantService(...));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 実行時に動的選択</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OAuthTokenCreationService service = services.get(tokenRequest.grantType());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>情報源</strong>: CLAUDE.md「Extension: <code>Map&lt;GrantType, Service&gt;</code> + Plugin インターフェース」</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="3-identity-openididentity">3. Identity (<code>openid/identity/</code>)<a href="#3-identity-openididentity" class="hash-link" aria-label="3-identity-openididentity への直接リンク" title="3-identity-openididentity への直接リンク">​</a></h3>
<p>ユーザー情報・ID Token・Verified Claims処理。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラス一覧-1">主要クラス一覧<a href="#主要クラス一覧-1" class="hash-link" aria-label="主要クラス一覧 への直接リンク" title="主要クラス一覧 への直接リンク">​</a></h4>
<table><thead><tr><th>クラス</th><th>責務</th></tr></thead><tbody><tr><td><code>User</code></td><td>ユーザードメインモデル</td></tr><tr><td><code>UserIdentifier</code></td><td>ユーザー識別子（sub）</td></tr><tr><td><code>IdTokenCreator</code></td><td>ID Token生成</td></tr><tr><td><code>IdTokenCustomClaimsBuilder</code></td><td>カスタムクレーム追加</td></tr><tr><td><code>UserAuthenticationApi</code></td><td>ユーザー認証API</td></tr><tr><td><code>UserOperationApi</code></td><td>ユーザー操作API</td></tr><tr><td><code>AuthenticationDevices</code></td><td>認証デバイス管理</td></tr></tbody></table>
<p><strong>情報源</strong>: <code>libs/idp-server-core/src/main/java/org/idp/server/core/openid/identity/</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="user---ユーザードメインモ デル">User - ユーザードメインモデル<a href="#user---ユーザードメインモデル" class="hash-link" aria-label="User - ユーザードメインモデル への直接リンク" title="User - ユーザードメインモデル への直接リンク">​</a></h4>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-core/src/main/java/org/idp/server/core/openid/identity/User.java#L36">User.java:36</a></p>
<p>OpenID Connect標準クレーム + 拡張機能を含む包括的なユーザーモデル。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * ユーザードメインモデル</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの36-100行目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class User implements JsonReadable, Serializable, UuidConvertable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ OpenID Connect 標準クレーム</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String sub;                     // Subject Identifier（必須・一意）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String name;                    // Full name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String givenName;               // Given name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String familyName;              // Family name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String middleName;              // Middle name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String nickname;                // Casual name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String preferredUsername;       // Preferred username</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String profile;                 // Profile page URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String picture;                 // Profile picture URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String website;                 // Website URL</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String email;                   // Email address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Boolean emailVerified;          // Email verified flag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String gender;                  // Gender</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String birthdate;               // Birthdate (YYYY-MM-DD)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String zoneinfo;                // Time zone</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String locale;                  // Locale</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String phoneNumber;             // Phone number</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Boolean phoneNumberVerified;    // Phone number verified flag</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Address address;                // Address</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 拡張機能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String providerId;              // Identity Provider ID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String externalUserId;          // 外部プロバイダーのユーザーID</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HashMap&lt;String, Object&gt; externalProviderOriginalPayload; // 外部IdPの元データ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 認証関連</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String hashedPassword;          // ハッシュ化されたパスワード</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String rawPassword;             // 一時的な平文パスワード（永続化しない）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;AuthenticationDevice&gt; authenticationDevices; // FIDO2/Passkey等</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 権限・ロール</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;UserRole&gt; roles;           // ユーザーロール</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;String&gt; permissions;       // 権限リスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ マルチテナント・組織</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String currentTenant;           // 現在のテナント</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;String&gt; assignedTenants;   // 割り当てられたテナント</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String currentOrganizationId;   // 現在の組織</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;String&gt; assignedOrganizations; // 割り当てられた組織</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ Verified Claims (IDA)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HashMap&lt;String, Object&gt; verifiedClaims; // 検証済み身元情報</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ Verifiable Credentials</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;HashMap&lt;String, Object&gt;&gt; credentials; // VCリスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ カスタムプロパティ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  HashMap&lt;String, Object&gt; customProperties; // テナント固有の追加情報</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ ライフサイクル</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LocalDateTime createdAt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LocalDateTime updatedAt;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  UserStatus status;              // INITIALIZED, ACTIVE, SUSPENDED, DELETED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ ライフサイクル管理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean canTransit(UserStatus from, UserStatus to) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return UserLifecycleManager.canTransit(from, to);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public User transitStatus(UserStatus newStatus) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.status = UserLifecycleManager.transit(this.status, newStatus);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return this;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 権限判定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Set&lt;String&gt; permissionsAsSet() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new HashSet&lt;&gt;(permissions);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public String permissionsAsString() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return String.join(&quot;,&quot;, permissions);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要ポイント</strong>:</p>
<ul>
<li>✅ <strong>OIDC標準準拠</strong>: RFC準拠の標準クレーム</li>
<li>✅ <strong>拡張機能</strong>: FIDO2, IDA, VC対応</li>
<li>✅ <strong>マルチテナント</strong>: 複数テナント・組織への所属</li>
<li>✅ <strong>ライフサイクル管理</strong>: ステータス遷移制御</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="userstatus---ユーザーステータス">UserStatus - ユーザーステータス<a href="#userstatus---ユーザーステータス" class="hash-link" aria-label="UserStatus - ユーザーステータス への直接リンク" title="UserStatus - ユーザーステータス への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public enum UserStatus {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  INITIALIZED,  // 初期化済み（登録直後）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ACTIVE,       // アクティブ（通常利用可能）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  SUSPENDED,    // 一時停止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DELETED       // 削除済み</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ライフサイクル遷移ルール</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// INITIALIZED → ACTIVE</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ACTIVE ↔ SUSPENDED</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ACTIVE/SUSPENDED → DELETED</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="address---住所クレーム">Address - 住所クレーム<a href="#address---住所クレーム" class="hash-link" aria-label="Address - 住所クレーム への直接リンク" title="Address - 住所クレーム への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class Address {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String formatted;       // 完全な住所文字列</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String streetAddress;   // 番地</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String locality;        // 市区町村</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String region;          // 都道府県</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String postalCode;      // 郵便番号</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String country;         // 国コード（ISO 3166-1）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="4-authentication-openidauthentication">4. Authentication (<code>openid/authentication/</code>)<a href="#4-authentication-openidauthentication" class="hash-link" aria-label="4-authentication-openidauthentication への直接リンク" title="4-authentication-openidauthentication への直接リンク">​</a></h3>
<p>認証処理・認証トランザクション管理。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラス一覧-2">主要クラス一覧<a href="#主要クラス一覧-2" class="hash-link" aria-label="主要クラス一覧 への直接リンク" title="主要クラス一覧 への直接リンク">​</a></h4>
<table><thead><tr><th>クラス</th><th>責務</th></tr></thead><tbody><tr><td><code>Authentication</code></td><td>認証結果ドメインモデル</td></tr><tr><td><code>AuthenticationTransaction</code></td><td>認証トランザクション管理</td></tr><tr><td><code>AuthenticationContext</code></td><td>認証コンテキスト</td></tr><tr><td><code>AuthenticationInteractor</code></td><td>認証インタラクター（FIDO2/Password等）</td></tr><tr><td><code>AuthenticationMethod</code></td><td>認証方式</td></tr><tr><td><code>AuthenticationPolicy</code></td><td>認証ポリシー</td></tr><tr><td><code>AuthenticationInteractionResult</code></td><td>認証インタラクション結果</td></tr></tbody></table>
<p><strong>情報源</strong>: <code>libs/idp-server-core/src/main/java/org/idp/server/core/openid/authentication/</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="authentication---認証結果ドメインモデル">Authentication - 認証結果ドメインモデル<a href="#authentication---認証結果ドメインモデル" class="hash-link" aria-label="Authentication - 認証結果ドメインモデル への直接リンク" title="Authentication - 認証結果ドメインモデル への直接リンク">​</a></h4>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-core/src/main/java/org/idp/server/core/openid/authentication/Authentication.java#L24">Authentication.java:24</a></p>
<p>認証完了後の情報を保持。ID Tokenの<code>auth_time</code>, <code>amr</code>, <code>acr</code>クレームに使用。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 認証結果ドメインモデル</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの24-84行目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class Authentication implements Serializable, JsonReadable {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LocalDateTime time;          // 認証時刻（auth_time）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  List&lt;String&gt; methods;        // 認証方式リスト（amr: Authentication Methods References）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  String acr;                  // 認証コンテキストクラス参照（acr: Authentication Context Class Reference）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 認証時刻</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public LocalDateTime time() { return time; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean hasAuthenticationTime() { return Objects.nonNull(time); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 認証方式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public List&lt;String&gt; methods() { return methods; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean hasMethod() { return !methods.isEmpty(); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ ACR (Authentication Context Class Reference)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public String acr() { return acr; }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean hasAcrValues() { return acr != null &amp;&amp; !acr.isEmpty(); }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>AMR（Authentication Methods References）例</strong>:</p>
<ul>
<li><code>[&quot;pwd&quot;]</code> - パスワード認証</li>
<li><code>[&quot;fido&quot;, &quot;pwd&quot;]</code> - FIDO2 + パスワード（MFA）</li>
<li><code>[&quot;otp&quot;, &quot;sms&quot;]</code> - SMS OTP</li>
<li><code>[&quot;fed&quot;]</code> - フェデレーション</li>
</ul>
<p><strong>情報源</strong>: <a href="https://www.rfc-editor.org/rfc/rfc8176.html" target="_blank" rel="noopener noreferrer">RFC 8176 - Authentication Method Reference Values</a></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="authenticationtransaction---認証トランザクション">AuthenticationTransaction - 認証トランザクション<a href="#authenticationtransaction---認証トランザクション" class="hash-link" aria-label="AuthenticationTransaction - 認証トランザクション への直接リンク" title="AuthenticationTransaction - 認証トランザクション への直接リンク">​</a></h4>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-core/src/main/java/org/idp/server/core/openid/authentication/AuthenticationTransaction.java#L35">AuthenticationTransaction.java:35</a></p>
<p>複数ステップの認証フロー（MFA等）を管理。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 認証トランザクション管理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの35-120行目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthenticationTransaction {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationTransactionIdentifier identifier;  // トランザクション識別子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationIdentifier authorizationIdentifier; // 認可リクエスト識別子</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationRequest request;                   // 認証リクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationPolicy authenticationPolicy;       // 認証ポリシー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationInteractionResults interactionResults; // 認証インタラクション結果集合</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationTransactionAttributes attributes;   // カスタム属性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ インタラクション結果の追加・更新</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public AuthenticationTransaction updateWith(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AuthenticationInteractionRequestResult interactionRequestResult) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // Immutableパターン: 新しいインスタンスを返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 認証完了判定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean isCompleted() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return authenticationPolicy.isCompleted(interactionResults);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ MFA必要判定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean requiresMfa() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return authenticationPolicy.requiresMfa();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>認証フロー例（MFA）</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 1. パスワード認証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthenticationInteractionRequestResult passwordResult =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new AuthenticationInteractionRequestResult(&quot;PASSWORD&quot;, &quot;pwd&quot;, true, user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">transaction = transaction.updateWith(passwordResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. MFA必要判定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (transaction.requiresMfa()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // FIDO2認証を要求</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationInteractionRequestResult fidoResult =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      new AuthenticationInteractionRequestResult(&quot;FIDO2&quot;, &quot;fido&quot;, true, user);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  transaction = transaction.updateWith(fidoResult);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 3. 認証完了判定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (transaction.isCompleted()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Authentication authentication = transaction.createAuthentication();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // authentication.methods() → [&quot;pwd&quot;, &quot;fido&quot;]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="authenticationmethod---標準認証方式">AuthenticationMethod - 標準認証方式<a href="#authenticationmethod---標準認証方式" class="hash-link" aria-label="AuthenticationMethod - 標準認証方式 への直接リンク" title="AuthenticationMethod - 標準認証方式 への直接リンク">​</a></h4>
<table><thead><tr><th>AMR値</th><th>説明</th></tr></thead><tbody><tr><td><code>pwd</code></td><td>Password</td></tr><tr><td><code>otp</code></td><td>One-Time Password</td></tr><tr><td><code>sms</code></td><td>SMS OTP</td></tr><tr><td><code>fido</code></td><td>FIDO2/WebAuthn</td></tr><tr><td><code>hwk</code></td><td>Hardware Key</td></tr><tr><td><code>swk</code></td><td>Software Key</td></tr><tr><td><code>pin</code></td><td>PIN</td></tr><tr><td><code>face</code></td><td>顔認証</td></tr><tr><td><code>fpt</code></td><td>指紋認証</td></tr><tr><td><code>mfa</code></td><td>Multiple-Factor Authentication</td></tr><tr><td><code>fed</code></td><td>Federation</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="5-grant-management-openidgrant_management">5. Grant Management (<code>openid/grant_management/</code>)<a href="#5-grant-management-openidgrant_management" class="hash-link" aria-label="5-grant-management-openidgrant_management への直接リンク" title="5-grant-management-openidgrant_management への直接リンク">​</a></h3>
<p>ユーザーによる認可（スコープ・クレーム同意）の管理。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラス一覧-3">主要クラス一覧<a href="#主要クラス一覧-3" class="hash-link" aria-label="主要クラス一覧 への直接リンク" title="主要クラス一覧 への直接リンク">​</a></h4>
<table><thead><tr><th>クラス</th><th>責務</th></tr></thead><tbody><tr><td><code>AuthorizationGranted</code></td><td>認可済みグラント（永続化）</td></tr><tr><td><code>AuthorizationGrant</code></td><td>認可グラント（一時）</td></tr><tr><td><code>AuthorizationCodeGrant</code></td><td>認可コードグラント</td></tr><tr><td><code>ConsentClaims</code></td><td>同意されたクレーム</td></tr><tr><td><code>GrantIdTokenClaims</code></td><td>ID Token用クレーム</td></tr><tr><td><code>GrantUserinfoClaims</code></td><td>UserInfo用クレーム</td></tr></tbody></table>
<p><strong>情報源</strong>: <code>libs/idp-server-core/src/main/java/org/idp/server/core/openid/grant_management/</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorizationgranted---認可済みグラント">AuthorizationGranted - 認可済みグラント<a href="#authorizationgranted---認可済みグラント" class="hash-link" aria-label="AuthorizationGranted - 認可済みグラント への直接リンク" title="AuthorizationGranted - 認可済みグラント への直接リンク">​</a></h4>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-core/src/main/java/org/idp/server/core/openid/grant_management/AuthorizationGranted.java#L25">AuthorizationGranted.java:25</a></p>
<p>ユーザーが過去に同意したスコープ・クレームを永続化。</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 認可済みグラント</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの25-80行目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizationGranted {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationGrantedIdentifier identifier;  // (user, client)のペア</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthorizationGrant authorizationGrant;      // 認可内容</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ スコープ認可チェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean isGrantedScopes(Scopes requestedScopes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return authorizationGrant.isGrantedScopes(requestedScopes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 未認可スコープ取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public Scopes unauthorizedScopes(Scopes requestedScopes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return authorizationGrant.unauthorizedScopes(requestedScopes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ クレーム認可チェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean isGrantedClaims(GrantIdTokenClaims requestedIdTokenClaims) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return authorizationGrant.isGrantedIdTokenClaims(requestedIdTokenClaims);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ グラントマージ（追加同意）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public AuthorizationGranted merge(AuthorizationGrant newAuthorizationGrant) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthorizationGrant merged = authorizationGrant.merge(newAuthorizationGrant);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new AuthorizationGranted(identifier, merged);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>用途</strong>:</p>
<ol>
<li><strong>初回認可</strong>: ユーザーが同意画面で承認 → <code>AuthorizationGranted</code>を保存</li>
<li><strong>2回目以降</strong>: <code>AuthorizationGranted</code>を確認 → 同意済みなら同意画面スキップ</li>
<li><strong>追加スコープ</strong>: 未認可スコープのみ同意画面表示</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="authorizationgrant---認可グラント一時">AuthorizationGrant - 認可グラント（一時）<a href="#authorizationgrant---認可グラント一時" class="hash-link" aria-label="AuthorizationGrant - 認可グラント（一時） への直接リンク" title="AuthorizationGrant - 認可グラント（一時） への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizationGrant {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Scopes scopes;                    // 認可されたスコープ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ConsentClaims consentClaims;      // 同意されたクレーム</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GrantIdTokenClaims idTokenClaims; // ID Token用クレーム</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GrantUserinfoClaims userinfoClaims; // UserInfo用クレーム</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ スコープ判定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean isGrantedScopes(Scopes requestedScopes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return scopes.containsAll(requestedScopes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ マージ（追加認可）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public AuthorizationGrant merge(AuthorizationGrant other) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Scopes mergedScopes = scopes.merge(other.scopes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ConsentClaims mergedClaims = consentClaims.merge(other.consentClaims);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new AuthorizationGrant(mergedScopes, mergedClaims, ...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="6-discovery-openiddiscovery">6. Discovery (<code>openid/discovery/</code>)<a href="#6-discovery-openiddiscovery" class="hash-link" aria-label="6-discovery-openiddiscovery への直接リンク" title="6-discovery-openiddiscovery への直接リンク">​</a></h3>
<p>OpenID Connect Discovery（<code>.well-known/openid-configuration</code>）とJWKS提供。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラス一覧-4">主要クラス一覧<a href="#主要クラス一覧-4" class="hash-link" aria-label="主要クラス一覧 への直接リンク" title="主要クラス一覧 への直接リンク">​</a></h4>
<table><thead><tr><th>クラス</th><th>責務</th></tr></thead><tbody><tr><td><code>DiscoveryHandler</code></td><td>Discoveryエンドポイント処理</td></tr><tr><td><code>ServerConfigurationResponseCreator</code></td><td>メタデータ生成</td></tr><tr><td><code>OidcMetaDataApi</code></td><td>Discovery API</td></tr></tbody></table>
<p><strong>情報源</strong>: <code>libs/idp-server-core/src/main/java/org/idp/server/core/openid/discovery/</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="discovery-metadata---openid-provider-metadata">Discovery Metadata - OpenID Provider Metadata<a href="#discovery-metadata---openid-provider-metadata" class="hash-link" aria-label="Discovery Metadata - OpenID Provider Metadata への直接リンク" title="Discovery Metadata - OpenID Provider Metadata への直接リンク">​</a></h4>
<p><strong>エンドポイント</strong>: <code>GET /.well-known/openid-configuration</code></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;issuer&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://idp.example.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;authorization_endpoint&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://idp.example.com/authorize&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;token_endpoint&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://idp.example.com/token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;userinfo_endpoint&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://idp.example.com/userinfo&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;jwks_uri&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://idp.example.com/.well-known/jwks.json&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;registration_endpoint&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://idp.example.com/register&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;scopes_supported&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;openid&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;profile&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;email&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;address&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;phone&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;response_types_supported&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;code&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id_token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;code token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;code id_token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;id_token token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;code id_token token&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;response_modes_supported&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;query&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;fragment&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;form_post&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;grant_types_supported&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;authorization_code&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;implicit&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;refresh_token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;client_credentials&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;subject_types_supported&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;public&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;pairwise&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;id_token_signing_alg_values_supported&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;RS256&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RS384&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RS512&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ES256&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ES384&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ES512&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;token_endpoint_auth_methods_supported&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;client_secret_basic&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;client_secret_post&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;client_secret_jwt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;private_key_jwt&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;claims_supported&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;sub&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;given_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;family_name&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;email&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;email_verified&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;code_challenge_methods_supported&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token string" style="color:#e3116c">&quot;S256&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;plain&quot;</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="jwks-endpoint---json-web-key-set">JWKS Endpoint - JSON Web Key Set<a href="#jwks-endpoint---json-web-key-set" class="hash-link" aria-label="JWKS Endpoint - JSON Web Key Set への直接リンク" title="JWKS Endpoint - JSON Web Key Set への直接リンク">​</a></h4>
<p><strong>エンドポイント</strong>: <code>GET /.well-known/jwks.json</code></p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;keys&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;kty&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RSA&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;use&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;sig&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;kid&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;2024-key-1&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;alg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;RS256&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;n&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;xGOr...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token property" style="color:#36acaa">&quot;e&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;AQAB&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="7-userinfo-openiduserinfo">7. UserInfo (<code>openid/userinfo/</code>)<a href="#7-userinfo-openiduserinfo" class="hash-link" aria-label="7-userinfo-openiduserinfo への直接リンク" title="7-userinfo-openiduserinfo への直接リンク">​</a></h3>
<p>OpenID Connect UserInfoエンドポイント実装。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラス一覧-5">主要クラス一覧<a href="#主要クラス一覧-5" class="hash-link" aria-label="主要クラス一覧 への直接リンク" title="主要クラス一覧 への直接リンク">​</a></h4>
<table><thead><tr><th>クラス</th><th>責務</th></tr></thead><tbody><tr><td><code>UserinfoHandler</code></td><td>UserInfoエンドポイント処理</td></tr><tr><td><code>UserinfoResponse</code></td><td>UserInfo レスポンス</td></tr><tr><td><code>UserinfoCustomIndividualClaimsCreator</code></td><td>カスタムクレーム追加（Plugin）</td></tr></tbody></table>
<p><strong>情報源</strong>: <code>libs/idp-server-core/src/main/java/org/idp/server/core/openid/userinfo/</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="userinfo-endpoint">UserInfo Endpoint<a href="#userinfo-endpoint" class="hash-link" aria-label="UserInfo Endpoint への直接リンク" title="UserInfo Endpoint への直接リンク">​</a></h4>
<p><strong>エンドポイント</strong>: <code>GET /userinfo</code>
<strong>認証</strong>: <code>Authorization: Bearer &lt;access_token&gt;</code></p>
<p><strong>レスポンス例</strong>:</p>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;sub&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;248289761001&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Jane Doe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;given_name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Jane&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;family_name&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Doe&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;email&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;janedoe@example.com&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;email_verified&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;picture&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://example.com/janedoe.jpg&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>スコープとクレームのマッピング</strong>:</p>
<table><thead><tr><th>スコープ</th><th>返却されるクレーム</th></tr></thead><tbody><tr><td><code>openid</code></td><td><code>sub</code></td></tr><tr><td><code>profile</code></td><td><code>name</code>, <code>given_name</code>, <code>family_name</code>, <code>middle_name</code>, <code>nickname</code>, <code>preferred_username</code>, <code>profile</code>, <code>picture</code>, <code>website</code>, <code>gender</code>, <code>birthdate</code>, <code>zoneinfo</code>, <code>locale</code>, <code>updated_at</code></td></tr><tr><td><code>email</code></td><td><code>email</code>, <code>email_verified</code></td></tr><tr><td><code>address</code></td><td><code>address</code></td></tr><tr><td><code>phone</code></td><td><code>phone_number</code>, <code>phone_number_verified</code></td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="8-federation-openidfederation">8. Federation (<code>openid/federation/</code>)<a href="#8-federation-openidfederation" class="hash-link" aria-label="8-federation-openidfederation への直接リンク" title="8-federation-openidfederation への 直接リンク">​</a></h3>
<p>外部IdPとのフェデレーション（SSO連携）。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="主要クラス一覧-6">主要クラス一覧<a href="#主要クラス一覧-6" class="hash-link" aria-label="主要クラス一覧 への直接リンク" title="主要クラス一覧 への直接リンク">​</a></h4>
<table><thead><tr><th>クラス</th><th>責務</th></tr></thead><tbody><tr><td><code>FederationInteractor</code></td><td>フェデレーション実行（Plugin）</td></tr><tr><td><code>FederationInteractionResult</code></td><td>フェデレーション結果</td></tr><tr><td><code>FederationConfigurationQueryRepository</code></td><td>フェデレーション設定取得</td></tr></tbody></table>
<p><strong>情報源</strong>: <code>libs/idp-server-core/src/main/java/org/idp/server/core/openid/federation/</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="federation-flow">Federation Flow<a href="#federation-flow" class="hash-link" aria-label="Federation Flow への直接リンク" title="Federation Flow への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// 1. フェデレーション設定取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FederationConfiguration config =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    federationConfigurationQueryRepository.get(tenant, providerId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 2. 外部IdPへリダイレクト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FederationInteractor interactor = federationInteractorFactory.create(config);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String authorizationUrl = interactor.createAuthorizationUrl(authorizationRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// → https://external-idp.com/authorize?client_id=...&amp;redirect_uri=...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 3. コールバック処理</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FederationInteractionResult result = interactor.handleCallback(callbackRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 4. ユーザー情報取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User externalUser = result.user();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 5. ローカルユーザーとのアカウントリンキング</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">User localUser = userRepository.findByEmail(tenant, externalUser.email());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (localUser == null) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  localUser = createNewUser(externalUser);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  localUser = linkFederatedIdentity(localUser, externalUser, providerId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>対応プロトコル</strong>:</p>
<ul>
<li>✅ OIDC Federation（<code>idp-server-federation-oidc</code>モジュール）</li>
<li>🔜 SAML 2.0（将来対応予定）</li>
<li>🔜 LDAP（将来対応予定）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="9-plugin-openidplugin">9. Plugin (<code>openid/plugin/</code>)<a href="#9-plugin-openidplugin" class="hash-link" aria-label="9-plugin-openidplugin への直接リンク" title="9-plugin-openidplugin への直接リンク">​</a></h3>
<p>機能拡張用プラグインインターフェース定義。</p>
<p><strong>主要インターフェース</strong>:</p>
<ul>
<li><code>AuthorizationRequestExtensionVerifier</code> - 認可リクエスト拡張検証</li>
<li><code>OAuthTokenCreationServiceFactory</code> - トークン生成Service拡張</li>
<li><code>AccessTokenCustomClaimsCreator</code> - アクセストークンクレーム拡張</li>
<li><code>ClientAuthenticator</code> - クライアント認証拡張</li>
</ul>
<p><strong>情報源</strong>: <a href="/idp-server/documentation/docs/content_01_intro/intro-01-tech-overview.md#L93-L170">intro-01-tech-overview.md:93-170</a></p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="値オブジェクトパターン">値オブジェクトパターン<a href="#値オブジェクトパターン" class="hash-link" aria-label="値オブジェクトパターン への直接リンク" title="値オブジェクトパターン への直接リンク">​</a></h2>
<p>idp-server-coreでは、<code>String</code>/<code>Map</code>の濫用を避け、意味のある値オブジェクトを使用。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="悪い例-">悪い例 ❌<a href="#悪い例-" class="hash-link" aria-label="悪い例 ❌ への直接リンク" title="悪い例 ❌ への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ String濫用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void register(Tenant tenant, String clientId, String clientSecret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // clientIdとclientSecretを間違えて渡してもコンパイルエラーにならない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ Map濫用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Map&lt;String, Object&gt; getTokenResponse(Map&lt;String, String&gt; request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 型安全性がない、IDE補完が効かない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="良い例-">良い例 ✅<a href="#良い例-" class="hash-link" aria-label="良い例 ✅ への直接リンク" title="良い例 ✅ への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 値オブジェクト使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void register(Tenant tenant, RequestedClientId clientId, ClientSecret clientSecret) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 型が違うため、間違えるとコンパイルエラー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ ドメインモデル使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public TokenResponse createToken(TokenRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 型安全、IDE補完が効く、仕様が明確</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>値オブジェクト例</strong>:</p>
<ul>
<li><code>RequestedClientId</code> - クライアントID</li>
<li><code>AuthorizationCode</code> - 認可コード</li>
<li><code>AccessToken</code> - アクセストークン</li>
<li><code>RefreshToken</code> - リフレッシュトークン</li>
<li><code>Scope</code> / <code>Scopes</code> - スコープ</li>
<li><code>RedirectUri</code> - リダイレクトURI</li>
<li><code>GrantType</code> - グラントタイプ</li>
</ul>
<p><strong>情報源</strong>: CLAUDE.md「型安全性: String/Map濫用禁止、意味のある値オブジェクト優先」</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="例外ハンドリング">例外ハンドリング<a href="#例外ハンドリング" class="hash-link" aria-label="例 外ハンドリング への直接リンク" title="例外ハンドリング への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="例外命名パターン">例外命名パターン<a href="#例外命名パターン" class="hash-link" aria-label="例外命名パターン への直接リンク" title="例外命名パターン への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// OAuth標準エラー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">throw new OAuthBadRequestException(&quot;invalid_request&quot;, &quot;Missing required parameter: code&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">throw new OAuthUnauthorizedException(&quot;invalid_client&quot;, &quot;Client authentication failed&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// OAuth Redirectableエラー（認可エンドポイント）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">throw new OAuthRedirectableBadRequestException(&quot;invalid_scope&quot;, &quot;Requested scope is invalid&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// 内部エラー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">throw new ServerConfigurationNotFoundException(&quot;Authorization server configuration not found&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="throwexceptionifcondition-パターン"><code>throwExceptionIf{Condition}() パターン</code><a href="#throwexceptionifcondition-パターン" class="hash-link" aria-label="throwexceptionifcondition-パターン への直接リンク" title="throwexceptionifcondition-パターン への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: 条件を明示的に表現</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">private void throwExceptionIfCodeIsInvalid(AuthorizationCode code) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (code == null || code.isEmpty()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    throw new TokenBadRequestException(&quot;invalid_grant&quot;, &quot;Authorization code is invalid&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: 早期リターンで可読性向上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public void verify() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throwExceptionIfCodeIsInvalid(authorizationCode);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throwExceptionIfClientIdMismatch(clientId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  throwExceptionIfRedirectUriMismatch(redirectUri);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // メインロジック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>情報源</strong>: CLAUDE.md「例外: <code>throwExceptionIf{Condition}()</code> パターン、OAuth標準エラーコード」</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="アンチパ ターン">アンチパターン<a href="#アンチパターン" class="hash-link" aria-label="アンチパターン への直接リンク" title="アンチパターン への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-1-util濫用">❌ 1. Util濫用<a href="#-1-util濫用" class="hash-link" aria-label="❌ 1. Util濫用 への直接リンク" title="❌ 1. Util濫用 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 悪い例: 共通ロジックをUtilに逃がす</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OAuthUtils {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public static boolean isValidAuthorizationCode(String code) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ドメインロジックがUtilに漏れている</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: ドメインオブジェクトに配置</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class AuthorizationCode {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean isValid() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ドメインロジックはドメインオブジェクトに</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-2-map濫用">❌ 2. Map濫用<a href="#-2-map濫用" class="hash-link" aria-label="❌ 2. Map濫用 への直接リンク" title="❌ 2. Map濫用 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 悪い例: Map&lt;String, Object&gt;で情報を持ち回る</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Map&lt;String, Object&gt; authorize(Map&lt;String, String&gt; request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  response.put(&quot;access_token&quot;, &quot;...&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  response.put(&quot;expires_in&quot;, 3600);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: 専用クラス使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public AuthorizationResponse authorize(AuthorizationRequest request) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return AuthorizationResponse.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .accessToken(new AccessToken(&quot;...&quot;))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .expiresIn(3600)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-3-永続化層でのビジネスロジック">❌ 3. 永続化層でのビジネスロジック<a href="#-3-永続化層でのビジネスロジック" class="hash-link" aria-label="❌ 3. 永続化層でのビジネスロジック への直接リンク" title="❌ 3. 永続化層でのビジネスロジック への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 悪い例: Repository実装でビジネス判定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ClientConfigurationRepositoryImpl implements ClientConfigurationQueryRepository {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ClientConfiguration get(Tenant tenant, RequestedClientId clientId) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientConfiguration config = dao.findById(clientId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ❌ ビジネスロジックがデータソース層に漏れている</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (&quot;ORGANIZER&quot;.equals(tenant.type())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      config.setSpecialPermissions(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return config;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: ドメイン層で判定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ClientConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public boolean hasSpecialPermissions(Tenant tenant) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ ビジネスロジックはドメインオブジェクトに</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return tenant.isOrganizer() &amp;&amp; this.permissionLevel.isSpecial();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要教訓</strong>: データソース層 = SELECT/INSERT/UPDATE/DELETE、ドメイン層 = 業務ルール</p>
<p><strong>情報源</strong>: CLAUDE.md「⚠️ レイヤー責任違反の重要教訓」</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="設定パターン">設定パターン<a href="#設定パターン" class="hash-link" aria-label="設定パターン への直接リンク" title="設定パターン への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="tenantattributes活用">TenantAttributes活用<a href="#tenantattributes活用" class="hash-link" aria-label="TenantAttributes活用 への直接リンク" title="TenantAttributes活用 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// テナント固有設定の取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">boolean enablePKCE = tenantAttributes.optValueAsBoolean(&quot;oauth.pkce.enabled&quot;, false);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">int tokenLifetime = tenantAttributes.optValueAsInt(&quot;token.access_token.lifetime_seconds&quot;, 3600);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">String customClaim = tenantAttributes.optValueAsString(&quot;token.custom_claim_key&quot;, &quot;&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label=" クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>情報源</strong>: CLAUDE.md「設定: TenantAttributes.optValueAsBoolean(key, default) パターン」</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="idp-server-core-を理解するための5つのポイント">idp-server-core を理解するための5つのポイント<a href="#idp-server-core-を理解するための5つのポイント" class="hash-link" aria-label="idp-server-core を理解するための5つのポイント への直接リンク" title="idp-server-core を理解するための5つのポイント への直接リンク">​</a></h3>
<ol>
<li><strong>Handler-Service-Repository パターン</strong>: 層責任を明確に分離</li>
<li><strong>Tenant第一引数の原則</strong>: 全Repository操作でマルチテナント分離</li>
<li><strong>値オブジェクト優先</strong>: String/Map濫用を避け、型安全な設計</li>
<li><strong>RFC準拠Javadoc</strong>: 仕様書引用で実装意図を明確化</li>
<li><strong>Plugin拡張</strong>: <code>Map&lt;GrantType, Service&gt;</code>パターンで機能拡張</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="次のステップ">次のステップ<a href="#次のステップ" class="hash-link" aria-label="次のステップ への直接リンク" title="次 のステップ への直接リンク">​</a></h3>
<ul>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-12-platform">idp-server-platform（プラットフォーム基盤）</a> - マルチテナント実装詳細</li>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-10-use-cases">idp-server-use-cases（ユースケース層）</a> - EntryServiceパターン</li>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-21-core-adapter">idp-server-core-adapter（アダプター層）</a> - Repository実装</li>
</ul>
<hr>
<p><strong>情報源</strong>:</p>
<ul>
<li><code>libs/idp-server-core/src/main/java/</code>配下の実装コード</li>
<li>CLAUDE.md「4層アーキテクチャ詳細」「Handler-Service-Repository パターン」</li>
<li><a href="/idp-server/documentation/docs/content_01_intro/intro-01-tech-overview.md">intro-01-tech-overview.md</a></li>
</ul>
<p><strong>最終更新</strong>: 2025-10-12
<strong>確認方法</strong>: <code>find libs/idp-server-core -type f -name &quot;*.java&quot; | head -20</code></p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_10_ai_developer/ai-11-core.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_10_ai_developer/ai-10-use-cases"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">idp-server-use-cases - ユースケース層（EntryService実装）</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_10_ai_developer/ai-12-platform"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">idp-server-platform - プラットフォーム基盤</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#モジュール概要" class="table-of-contents__link toc-highlight">モジュール概要</a><ul><li><a href="#責務" class="table-of-contents__link toc-highlight">責務</a></li><li><a href="#依存関係" class="table-of-contents__link toc-highlight">依存関係</a></li></ul></li><li><a href="#ディレクトリ構造" class="table-of-contents__link toc-highlight">ディレクトリ構造</a></li><li><a href="#アーキテクチャパターン" class="table-of-contents__link toc-highlight">アーキテクチャパターン</a><ul><li><a href="#handler-service-repository-パターン" class="table-of-contents__link toc-highlight">Handler-Service-Repository パターン</a></li><li><a href="#validator-vs-verifier" class="table-of-contents__link toc-highlight">Validator vs Verifier</a></li><li><a href="#verifierの階層パターンbase--extension" class="table-of-contents__link toc-highlight">Verifierの階層パターン（Base + Extension）</a></li><li><a href="#verifierパターンの利点" class="table-of-contents__link toc-highlight">Verifierパターンの利点</a></li><li><a href="#拡張モジュールとの統合" class="table-of-contents__link toc-highlight">拡張モジュールとの統合</a></li></ul></li><li><a href="#主要ドメイン" class="table-of-contents__link toc-highlight">主要ドメイン</a><ul><li><a href="#1-oauth-openidoauth" class="table-of-contents__link toc-highlight">1. OAuth (<code>openid/oauth/</code>)</a></li><li><a href="#2-token-openidtoken" class="table-of-contents__link toc-highlight">2. Token (<code>openid/token/</code>)</a></li><li><a href="#3-identity-openididentity" class="table-of-contents__link toc-highlight">3. Identity (<code>openid/identity/</code>)</a></li><li><a href="#4-authentication-openidauthentication" class="table-of-contents__link toc-highlight">4. Authentication (<code>openid/authentication/</code>)</a></li><li><a href="#5-grant-management-openidgrant_management" class="table-of-contents__link toc-highlight">5. Grant Management (<code>openid/grant_management/</code>)</a></li><li><a href="#6-discovery-openiddiscovery" class="table-of-contents__link toc-highlight">6. Discovery (<code>openid/discovery/</code>)</a></li><li><a href="#7-userinfo-openiduserinfo" class="table-of-contents__link toc-highlight">7. UserInfo (<code>openid/userinfo/</code>)</a></li><li><a href="#8-federation-openidfederation" class="table-of-contents__link toc-highlight">8. Federation (<code>openid/federation/</code>)</a></li><li><a href="#9-plugin-openidplugin" class="table-of-contents__link toc-highlight">9. Plugin (<code>openid/plugin/</code>)</a></li></ul></li><li><a href="#値オブジェクトパターン" class="table-of-contents__link toc-highlight">値オブジェクトパターン</a><ul><li><a href="#悪い例-" class="table-of-contents__link toc-highlight">悪い例 ❌</a></li><li><a href="#良い例-" class="table-of-contents__link toc-highlight">良い例 ✅</a></li></ul></li><li><a href="#例外ハンドリング" class="table-of-contents__link toc-highlight">例外ハンドリング</a><ul><li><a href="#例外命名パターン" class="table-of-contents__link toc-highlight">例外命名パターン</a></li><li><a href="#throwexceptionifcondition-パターン" class="table-of-contents__link toc-highlight"><code>throwExceptionIf{Condition}() パターン</code></a></li></ul></li><li><a href="#アンチパターン" class="table-of-contents__link toc-highlight">アンチパターン</a><ul><li><a href="#-1-util濫用" class="table-of-contents__link toc-highlight">❌ 1. Util濫用</a></li><li><a href="#-2-map濫用" class="table-of-contents__link toc-highlight">❌ 2. Map濫用</a></li><li><a href="#-3-永続化層でのビジネスロジック" class="table-of-contents__link toc-highlight">❌ 3. 永続化層でのビジネスロジック</a></li></ul></li><li><a href="#設定パターン" class="table-of-contents__link toc-highlight">設定パターン</a><ul><li><a href="#tenantattributes活用" class="table-of-contents__link toc-highlight">TenantAttributes活用</a></li></ul></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a><ul><li><a href="#idp-server-core-を理解するための5つのポイント" class="table-of-contents__link toc-highlight">idp-server-core を理解するための5つのポイント</a></li><li><a href="#次のステップ" class="table-of-contents__link toc-highlight">次のステップ</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>