<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_10_ai_developer/ai-10-use-cases" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">idp-server-use-cases - ユースケース層（EntryService実装） | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_10_ai_developer/ai-10-use-cases"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="idp-server-use-cases - ユースケース層（EntryService実装） | IdP-Server Documentation"><meta data-rh="true" name="description" content="モジュール概要"><meta data-rh="true" property="og:description" content="モジュール概要"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_10_ai_developer/ai-10-use-cases"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_10_ai_developer/ai-10-use-cases" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_10_ai_developer/ai-10-use-cases" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.92c1f5ce.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.e38f4277.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">📚 ドキュメント索引</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">技術概要</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_01_intro/intro-02-features">機能</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_01_intro/intro-03-use-cases">ユースケース一覧</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">Getting-Started</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_02_quickstart/quickstart-02-setting-templates">初期設定テンプレート（予定）</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_03_concepts/concept-01-multi-tenant">コア概念</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-01-multi-tenant">マ  ルチテナント</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-02-id-management">ID（ユーザー）管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-03-id-verified">身元確認済みID</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-04-enterprise-id">エンタープライズID</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-05-authentication-policy">認証ポリシー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-06-token-management">トークン管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-07-session-management">セッション管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-08-mfa">多要素認証（MFA）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-09-custom-claims">カスタムクレーム・スコープ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-10-control-plane">コントロールプレーン</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-11-security-events">セキュリティイベント・フック</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-12-authorization">認可</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-13-audit-compliance">監査ログ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-14-grant-management">認可許諾管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-15-operations">運用・保守</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-16-external-service-integration">外部サービス連携</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-17-application-logging">アプリケーションログ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-18-id-token">IDトークン（ID Token）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_03_concepts/concept-19-client">クライアント（Client）</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_03_concepts/basic/basic-01-identity-management-basics">基礎（読み物）</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認可プロトコル</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認可コードフロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_04_protocols/protocol-02-ciba-flow">CIBA フロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_04_protocols/protocol-03-introspection">イントロスペクション</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_05_how-to/index">How-to（設定・運用レシピ）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/index">How-to ガイド - 学習ロードマップ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-01-server-setup">サーバー初期設定ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-02-organization-initialization">組織初期化ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-03-tenant-setup">OIDCの最小設定ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-04-client-registration">クライアント登録ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-05-user-registration">ユーザー登録と初回認証</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-07-authentication-policy-basic">認証ポリシー設定ガイド（基礎編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-08-mfa-setup">MFA（多要素認証）の設定</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-09-token-strategy">トークン有効期限パターン</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-10-authentication-policy-advanced">認証ポリシー設定ガイド（詳細編）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-11-federation-setup">外部IdP連携（Federation）の設定</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-12-ciba-flow-fido-uaf">CIBA + FIDO-UAF</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-13-fido-uaf-registration">FIDO-UAF 登録フロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-14-fido-uaf-deregistration">FIDO-UAF 解除フロー</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-15-identity-verification-guide">身元確認申込み 導入ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-16-identity-verification-application">身元確認申込み</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-17-identity-verification-registration">身元確認データ登録</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_05_how-to/how-to-18-security-event-hooks">セキュリティイベントフック設定ガイド</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">Developer Guide</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/getting-started/service-overview">Getting Started</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/control-plane/resource-overview">Control Plane（管理API）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/application-plane/overview">Application Plane（認証・認可API）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/implementation-guides/overview">Implementation Guides（実装ガイド）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/configuration/CONFIGURATION_COVERAGE">Configuration（設定）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/patterns/common-patterns">Patterns（実装パターン）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/troubleshooting/common-errors">Troubleshooting（トラブルシューティング）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/reference/code-review-checklist">Reference（リファレンス）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_06_developer-guide/learning-paths/beginner">Learning Paths（学習パス）</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_07_reference/api-reference">API ドキュメント</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">テスト戦略</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_08_ops/ops-02-performance-test">ストレステスト結果</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_08_ops/commercial-deployment/overview">商用デプロイ</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-01-faq">project-01-faq</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-02-roadmap">🗺️ ロードマップ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-03-contributing">コントリビュートガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_09_project/project-04-license">License</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI開発者向けモジュールガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-02-lessons-learned">AI開発者向けドキュメント作成ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-10-use-cases">idp-server-use-cases - ユースケース層（EntryService実装）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-11-core">idp-server-core - OAuth 2.0/OIDC準拠コアエンジン</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-12-platform">idp-server-platform - プラットフォーム基盤</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-13-control-plane">idp-server-control-plane - 管理API契約定義</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-20-adapters">Adapter層 - Repository実装とインフラ統合</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-21-core-adapter">idp-server-core-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-22-database">idp-server-database</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-23-springboot-adapter">idp-server-springboot-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-30-extensions">拡張機能層 - OAuth/OIDC拡張仕様</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-31-extension-ciba">idp-server-core-extension-ciba - CIBA拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-32-extension-fapi">idp-server-core-extension-fapi - FAPI拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-33-extension-ida">idp-server-core-extension-ida - IDA拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-34-extension-pkce">idp-server-core-extension-pkce - PKCE拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-35-extension-vc">idp-server-core-extension-verifiable-credentials - VC拡張</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-40-authentication-federation">認証・連携層 - ユーザー認証とフェデレーション</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-41-authentication">idp-server-authentication-interactors - 認証インタラクター</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-42-webauthn">idp-server-webauthn4j-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-43-federation-oidc">idp-server-federation-oidc</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-50-notification-security-event">通知・イベント層 - 通知配信とセキュリティイベント</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-51-notification-fcm">idp-server-notification-fcm-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-52-notification-apns">idp-server-notification-apns-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-53-email-aws">idp-server-email-aws-adapter</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-54-security-event-framework">idp-server-security-event-framework</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_10_ai_developer/ai-55-security-event-hooks">idp-server-security-event-hooks</a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">AI</span><meta itemprop="position" content="1"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">idp-server-use-cases - ユースケース層（EntryService実装）</span><meta itemprop="position" content="2"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>idp-server-use-cases - ユースケース層（EntryService実装）</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="モジュール概要">モジュール概要<a href="#モジュール概要" class="hash-link" aria-label="モジュール概要 への直接リンク" title="モジュール概要 への直接リンク">​</a></h2>
<p><strong>情報源</strong>: <code>libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/</code>
<strong>確認日</strong>: 2025-10-12</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="責務">責務<a href="#責務" class="hash-link" aria-label="責務 への直接リンク" title="責務 への直接リンク">​</a></h3>
<p>アプリケーション層のオーケストレーション。Control Plane APIの契約を実装し、Core層のHandlerを呼び出す。</p>
<ul>
<li><strong>EntryService実装</strong>: <code>{&#x27;{Domain}{Action}EntryService&#x27;}</code> パターン</li>
<li><strong>トランザクション境界</strong>: <code>@Transaction</code> によるトランザクション管理</li>
<li><strong>認可チェック</strong>: 権限検証・アクセス制御</li>
<li><strong>Audit Log記録</strong>: 全操作の監査ログ出力</li>
<li><strong>Dry Run対応</strong>: 検証のみの実行モード</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="依存関係">依存関係<a href="#依存関係" class="hash-link" aria-label="依存関係 への直接リンク" title="依存関係 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">idp-server-use-cases</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓ (依存)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">idp-server-core (ドメインロジック)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">idp-server-platform (基盤機能)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">idp-server-control-plane (API契約定義)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="パッケージ構成">パッケージ構成<a href="#パッケージ構成" class="hash-link" aria-label="パッケージ構成 への直接リンク" title="パッケージ構成 への直接リンク">​</a></h2>
<p><strong>情報源</strong>: <code>find libs/idp-server-use-cases/src/main/java/org/idp/server/usecases -type d -maxdepth 2</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-application層-application">🔷 Application層 (<code>application/</code>)<a href="#-application層-application" class="hash-link" aria-label="-application層-application への直接リンク" title="-application層-application への直接リンク">​</a></h3>
<p>エンドユーザー・RP（Relying Party）・システム向けのアプリケーションロジック。</p>
<table><thead><tr><th>サブパッケージ</th><th>責務</th></tr></thead><tbody><tr><td><code>relying_party/</code></td><td>OAuth/OIDC認証・認可フロー</td></tr><tr><td><code>enduser/</code></td><td>エンドユーザー向けAPI</td></tr><tr><td><code>identity_verification_service/</code></td><td>身元確認サービス</td></tr><tr><td><code>system/</code></td><td>システム内部API</td></tr><tr><td><code>tenant_invitator/</code></td><td>テナント招待処理</td></tr></tbody></table>
<p><strong>特徴</strong>: Control Plane層と異なり、<strong>シン  プルな委譲パターン</strong>を採用。</p>
<ul>
<li>❌ 権限チェックなし（公開API or トークン検証済み前提）</li>
<li>❌ Audit Logなし（必要な場合はCore層で記録）</li>
<li>❌ Dry Runなし</li>
<li>❌ Context Creatorなし</li>
<li>✅ Core層のProtocol/Interactorへの委譲</li>
<li>✅ Transaction管理のみ</li>
</ul>
<p><strong>詳細</strong>: <a href="#application%E5%B1%A4-entryservice-%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3">Application層 EntryServiceパターン</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="️-control-plane層-control_plane">🎛️ Control Plane層 (<code>control_plane/</code>)<a href="#️-control-plane層-control_plane" class="hash-link" aria-label="️-control-plane層-control_plane への直接リンク" title="️-control-plane層-control_plane への直接リンク">​</a></h3>
<p>管理API実装。システム管理者・組織管理者向け。</p>
<table><thead><tr><th>サブパッケージ</th><th>責務</th></tr></thead><tbody><tr><td><code>system_manager/</code></td><td>システムレベル管理API</td></tr><tr><td><code>system_administrator/</code></td><td>システム管理者API</td></tr><tr><td><code>organization_manager/</code></td><td>組織レベル管理API</td></tr></tbody></table>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="entryservice-パターン">EntryService パターン<a href="#entryservice-パターン" class="hash-link" aria-label="EntryService パターン への直接リンク" title="EntryService パターン への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="命名規則">命名規則<a href="#命名規則" class="hash-link" aria-label="命名規則 への直接リンク" title="命名規則 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">{Domain}{Action}EntryService</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>例</strong>:</p>
<ul>
<li><code>ClientManagementEntryService</code> - クライアント管理</li>
<li><code>UserManagementEntryService</code> - ユーザー管理</li>
<li><code>AuthorizationServerManagementEntryService</code> - 認可サーバー管理</li>
<li><code>TenantManagementEntryService</code> - テナント管理</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="実装パターン">実装パターン<a href="#実装パターン" class="hash-link" aria-label="実装パターン への直接リンク" title="実装パターン への直接リンク">​</a></h3>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/control_plane/system_manager/ClientManagementEntryService.java#L47">ClientManagementEntryService.java:47</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">/**</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * EntryServiceの標準実装パターン</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> * 確認方法: 実ファイルの47-114行目</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> */</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Transaction // ✅ トランザクション境界</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ClientManagementEntryService implements ClientManagementApi {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ Repository依存性注入</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TenantQueryRepository tenantQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientConfigurationCommandRepository clientConfigurationCommandRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientConfigurationQueryRepository clientConfigurationQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuditLogPublisher auditLogPublisher;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  LoggerWrapper log = LoggerWrapper.getLogger(ClientManagementEntryService.class);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ コンストラクタインジェクション</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ClientManagementEntryService(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TenantQueryRepository tenantQueryRepository,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ClientConfigurationCommandRepository clientConfigurationCommandRepository,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ClientConfigurationQueryRepository clientConfigurationQueryRepository,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AuditLogPublisher auditLogPublisher) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.tenantQueryRepository = tenantQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.clientConfigurationCommandRepository = clientConfigurationCommandRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.clientConfigurationQueryRepository = clientConfigurationQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.auditLogPublisher = auditLogPublisher;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ClientManagementResponse create(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TenantIdentifier tenantIdentifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      User operator,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      OAuthToken oAuthToken,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ClientRegistrationRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      RequestAttributes requestAttributes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      boolean dryRun) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 1: 権限取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AdminPermissions permissions = getRequiredPermissions(&quot;create&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 2: Tenant取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 3: Validator - 入力検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientRegistrationRequestValidator validator =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new ClientRegistrationRequestValidator(request, dryRun);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientRegistrationRequestValidationResult validate = validator.validate();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 4: Context Creator - コンテキスト構築</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientRegistrationContextCreator contextCreator =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        new ClientRegistrationContextCreator(tenant, request, dryRun);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientRegistrationContext context = contextCreator.create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 5: Audit Log記録</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuditLog auditLog =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        AuditLogCreator.create(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            &quot;ClientManagementApi.create&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            operator,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            oAuthToken,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            context,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            requestAttributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auditLogPublisher.publish(auditLog);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 6: 権限チェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!permissions.includesAll(operator.permissionsAsSet())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      response.put(&quot;error&quot;, &quot;access_denied&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      response.put(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          &quot;error_description&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          String.format(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              &quot;permission denied required permission %s, but %s&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              permissions.valuesAsString(), operator.permissionsAsString()));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      log.warn(response.toString());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return new ClientManagementResponse(ClientManagementStatus.FORBIDDEN, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 7:   バリデーションエラーチェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (!validate.isValid()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return validate.errorResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 8: Dry Run対応</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (dryRun) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      return context.toResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 9: 永続化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientConfigurationCommandRepository.register(tenant, context.configuration());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Phase 10: レスポンス返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return context.toResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="entryserviceの10フェーズ">EntryServiceの10フェーズ<a href="#entryserviceの10フェーズ" class="hash-link" aria-label="EntryServiceの10フェーズ への直接リンク" title="EntryServiceの10フェーズ への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-1-権限取得">Phase 1: 権限取得<a href="#phase-1-権限取得" class="hash-link" aria-label="Phase 1: 権限取得 への直接リンク" title="Phase 1: 権限取得 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AdminPermissions permissions = getRequiredPermissions(&quot;create&quot;);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要</strong>: Control Plane APIインターフェースの<code>default</code>メソッドで自動計算されるため、通常は実装不要。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-2-tenant取得">Phase 2: Tenant取得<a href="#phase-2-tenant取得" class="hash-link" aria-label="Phase 2: Tenant取得 への直接リンク" title="Phase 2: Tenant取得 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原則</strong>: システムレベルAPIは必ずTenantを最初に取得。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-3-validator---入力検証">Phase 3: Validator - 入力検証<a href="#phase-3-validator---入力検証" class="hash-link" aria-label="Phase 3: Validator - 入  力検証 への直接リンク" title="Phase 3: Validator - 入力検証 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ClientRegistrationRequestValidator validator =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new ClientRegistrationRequestValidator(request, dryRun);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClientRegistrationRequestValidationResult validate = validator.validate();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>責務</strong>: リクエストパラメータの形式・必須チェック。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-4-context-creator---コンテキスト構築">Phase 4: Context Creator - コンテキスト構築<a href="#phase-4-context-creator---コンテキスト構築" class="hash-link" aria-label="Phase 4: Context Creator - コンテキスト構築 への直接リンク" title="Phase 4: Context Creator - コンテキスト構築 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">ClientRegistrationContextCreator contextCreator =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    new ClientRegistrationContextCreator(tenant, request, dryRun);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClientRegistrationContext context = contextCreator.create();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要</strong>: Context Creatorは<strong>絶対必須</strong>。TODOコメントで済ませない。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-5-audit-log記録">Phase 5: Audit Log記録<a href="#phase-5-audit-log記録" class="hash-link" aria-label="Phase 5: Audit Log記録 への直接リンク" title="Phase 5: Audit Log記録 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AuditLog auditLog =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuditLogCreator.create(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        &quot;ClientManagementApi.create&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        oAuthToken,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        context,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        requestAttributes);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auditLogPublisher.publish(auditLog);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原則</strong>: 全操作の監査ログを記録（create/update/delete別）。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-6-権限チェック">Phase 6: 権限チェック<a href="#phase-6-権限チェック" class="hash-link" aria-label="Phase 6: 権限チェッ  ク への直接リンク" title="Phase 6: 権限チェック への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (!permissions.includesAll(operator.permissionsAsSet())) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return new ClientManagementResponse(ClientManagementStatus.FORBIDDEN, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>ステータスコード</strong>: <code>403 Forbidden</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-7-バリデーションエラーチェック">Phase 7: バリデーションエラーチェック<a href="#phase-7-バリデーションエラーチェック" class="hash-link" aria-label="Phase 7: バリデーションエラーチェック への直接リンク" title="Phase 7: バリデーションエラーチェック への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (!validate.isValid()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return validate.errorResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>ステータスコード</strong>: <code>400 Bad Request</code></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-8-dry-run対応">Phase 8: Dry Run対応<a href="#phase-8-dry-run対応" class="hash-link" aria-label="Phase 8: Dry Run対応 への直接リンク" title="Phase 8: Dry Run対応 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">if (dryRun) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return context.toResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>目的</strong>: 実行せずに検証結果のみ返却。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-9-永続化">Phase 9: 永続化<a href="#phase-9-永続化" class="hash-link" aria-label="Phase 9: 永続化 への直接リンク" title="Phase 9: 永続化 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">clientConfigurationCommandRepository.register(tenant, context.configuration());</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原則</strong>: Tenant第一引数必須。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="phase-10-レスポンス返却">Phase 10: レスポンス返却<a href="#phase-10-レスポンス返却" class="hash-link" aria-label="Phase 10: レスポンス返却 への直接リンク" title="Phase 10: レスポンス返却 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">return context.toResponse();</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="application層-entryservice-パターン">Application層 EntryService パターン<a href="#application層-entryservice-パターン" class="hash-link" aria-label="Application層 EntryService パターン への直接リンク" title="Application層 EntryService パターン への直接リンク">​</a></h2>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/application/enduser/OAuthFlowEntryService.java">OAuthFlowEntryService.java</a>, <a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/application/relying_party/OidcMetaDataEntryService.java">OidcMetaDataEntryService.java</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="設計思想">設計思想<a href="#設計思想" class="hash-link" aria-label="設計思想 への直接リンク" title="設計思想 への直接リンク">​</a></h3>
<p>Application層は<strong>エンドユーザー・RP（Relying Party）向けAPI</strong>であり、Control Plane層とは異なる設計原則を採用。</p>
<p><strong>Control Plane層との違い</strong>:</p>
<ul>
<li><strong>対象</strong>: 管理者 → エンドユーザー/RP</li>
<li><strong>複雑度</strong>: 10フェーズ → 3-4フェーズ</li>
<li><strong>責務</strong>: 検証・認可・Context構築・永続化 → Protocol委譲・Transaction管理</li>
<li><strong>依存</strong>: Repository直接 → Protocol/Interactor経由</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="application層の特徴">Application層の特徴<a href="#application層の特徴" class="hash-link" aria-label="Application層の特徴 への直接リンク" title="Application層の特徴 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-採用する機能">✅ 採用する機能<a href="#-採用する機能" class="hash-link" aria-label="✅ 採用する機能 への直接リンク" title="✅ 採用する機能 への直接リンク">​</a></h4>
<ul>
<li><strong>Transaction管理</strong>: <code>@Transaction</code> / <code>@Transaction(readOnly = true)</code></li>
<li><strong>Tenant取得</strong>: 全操作の最初にTenant取得</li>
<li><strong>Protocol委譲</strong>: Core層の<code>Protocol</code>/<code>Interactor</code>にビジネスロジック委譲</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-採用しない機能">❌ 採用しない機能<a href="#-採用しない機能" class="hash-link" aria-label="❌ 採用しない機能 への直接リンク" title="❌ 採用しない機能 への直接リンク">​</a></h4>
<ul>
<li><strong>権限チェック</strong>: Controller層で完了済み or 公開API</li>
<li><strong>Audit Log</strong>: Core層でイベント駆動記録</li>
<li><strong>Dry Run</strong>: 管理操作ではないため不要</li>
<li><strong>Context Creator</strong>: Protocolが内部で処理</li>
<li><strong>Validator</strong>: Protocol内で実装</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="実装パターン1-oauth認可フロー">実装パターン1: OAuth認可フロー<a href="#実装パターン1-oauth認可フロー" class="hash-link" aria-label="実装パターン1: OAuth認可フロー への直接リンク" title="実装パターン1: OAuth認可フロー への直接リンク">​</a></h3>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/application/enduser/OAuthFlowEntryService.java#L117-L138">OAuthFlowEntryService.java:117-138</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OAuthFlowEntryService implements OAuthFlowApi {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OAuthProtocols oAuthProtocols;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TenantQueryRepository tenantQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  AuthenticationTransactionCommandRepository authenticationTransactionCommandRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public OAuthRequestResponse request(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TenantIdentifier tenantIdentifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Map&lt;String, String[]&gt; params,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      RequestAttributes requestAttributes) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ フェーズ 1: Tenant取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ フェーズ 2: Request構築</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OAuthRequest oAuthRequest = new OAuthRequest(tenant, params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ フェーズ 3: Core層Protocol取得・実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OAuthProtocol oAuthProtocol = oAuthProtocols.get(tenant.authorizationProvider());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OAuthRequestResponse response = oAuthProtocol.request(oAuthRequest);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ フェーズ 4: Transaction管理（成功時のみ）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    if (response.isOK()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AuthenticationPolicyConfiguration policyConfig =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          authenticationPolicyConfigurationQueryRepository.find(tenant, StandardAuthFlow.OAUTH.toAuthFlow());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      AuthenticationTransaction transaction =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">          OAuthAuthenticationTransactionCreator.create(tenant, response, policyConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      authenticationTransactionCommandRepository.register(tenant, transaction);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return response;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要ポイント</strong>:</p>
<ul>
<li><strong>Protocol中心</strong>: <code>OAuthProtocol</code>がOAuth 2.0仕様準拠の処理を実装</li>
<li><strong>Transaction管理</strong>: 認証トランザクションの永続化のみ担当</li>
<li><strong>エラーハンドリング</strong>: Protocolがエラーレスポンス構築</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="実装パターン2-メタデータapi読み取り専用">実装パターン2: メタデータAPI（読み取り専用）<a href="#実装パターン2-メタデータapi読み取り専用" class="hash-link" aria-label="実装パターン2: メタデータAPI（読み取り専用） への直接リンク" title="実装パターン2: メタデータAPI（読み取り専用） への直接リンク">​</a></h3>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/application/relying_party/OidcMetaDataEntryService.java#L29-L56">OidcMetaDataEntryService.java:29-56</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Transaction(readOnly = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OidcMetaDataEntryService implements OidcMetaDataApi {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  TenantQueryRepository tenantQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  DiscoveryProtocols discoveryProtocols;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public OidcMetaDataEntryService(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TenantQueryRepository tenantQueryRepository,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      DiscoveryProtocols discoveryProtocols) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.tenantQueryRepository = tenantQueryRepository;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.discoveryProtocols = discoveryProtocols;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ServerConfigurationRequestResponse getConfiguration(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      TenantIdentifier tenantIdentifier) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ フェーズ 1: Tenant取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ フェーズ 2: Core層Protocol取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DiscoveryProtocol protocol = discoveryProtocols.get(tenant.authorizationProvider());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ フェーズ 3: 委譲実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return protocol.getConfiguration(tenant);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public JwksRequestResponse getJwks(TenantIdentifier tenantIdentifier) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    DiscoveryProtocol protocol = discoveryProtocols.get(tenant.authorizationProvider());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return protocol.getJwks(tenant);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要ポイント</strong>:</p>
<ul>
<li><strong>読み取り専用</strong>: <code>@Transaction(readOnly = true)</code>でパフォーマンス最適化</li>
<li><strong>公開API</strong>: 認証不要のOIDC Discovery仕様準拠</li>
<li><strong>単純委譲</strong>: ビジネスロジックなし、Protocol呼び出しのみ</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="application層の3-4フェーズ">Application層の3-4フェーズ<a href="#application層の3-4フェーズ" class="hash-link" aria-label="Application層の3-4フェーズ への直接リンク" title="Application層の3-4フェーズ への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="標準フロー読み書き">標準フロー（読み書き）<a href="#標準フロー読み書き" class="hash-link" aria-label="標準フロー（読み書き） への直接リンク" title="標準フロー（読み書き） への直接リンク">​</a></h4>
<ol>
<li><strong>Tenant取得</strong>: <code>tenantQueryRepository.get(tenantIdentifier)</code></li>
<li><strong>Request構築</strong>: ドメインオブジェクト生成</li>
<li><strong>Protocol実行</strong>: Core層への委譲</li>
<li><strong>Transaction管理</strong>: 成功時のみ永続化</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="簡易フロー読み取り専用">簡易フロー（読み取り専用）<a href="#簡易フロー読み取り専用" class="hash-link" aria-label="簡易フロー（読み取り専用） への直接リンク" title="簡易フロー（読み取り専用） への直接リンク">​</a></h4>
<ol>
<li><strong>Tenant取得</strong>: <code>tenantQueryRepository.get(tenantIdentifier)</code></li>
<li><strong>Protocol取得</strong>: <code>protocols.get(tenant.authorizationProvider())</code></li>
<li><strong>委譲実行</strong>: <code>protocol.method(tenant)</code></li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="application層-vs-control-plane層-比較">Application層 vs Control Plane層 比較<a href="#application層-vs-control-plane層-比較" class="hash-link" aria-label="Application層 vs Control Plane層 比較 への直接リンク" title="Application層 vs Control Plane層 比較 への直接リンク">​</a></h3>
<table><thead><tr><th>項目</th><th>Application層</th><th>Control Plane層</th></tr></thead><tbody><tr><td><strong>対象ユーザー</strong></td><td>エンドユーザー/RP</td><td>管理者（システム/組織）</td></tr><tr><td><strong>フェーズ数</strong></td><td>3-4フェーズ</td><td>10フェーズ</td></tr><tr><td><strong>権限チェック</strong></td><td>❌ なし</td><td>✅ AdminPermissions</td></tr><tr><td><strong>Audit Log</strong></td><td>❌ なし</td><td>✅ 全操作記録</td></tr><tr><td><strong>Dry Run</strong></td><td>❌ なし</td><td>✅ 必須</td></tr><tr><td><strong>Context Creator</strong></td><td>❌ なし</td><td>✅ 必須</td></tr><tr><td><strong>Validator</strong></td><td>△ Protocol内</td><td>✅ 専用Validator</td></tr><tr><td><strong>依存層</strong></td><td>Protocol/Interactor</td><td>Repository</td></tr><tr><td><strong>トランザクション</strong></td><td><code>@Transaction</code></td><td><code>@Transaction</code></td></tr><tr><td><strong>設計思想</strong></td><td>OIDC仕様準拠処理</td><td>管理操作の完全制御</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="application層で避けるべきアンチパターン">Application層で避けるべきアンチパターン<a href="#application層で避けるべきアンチパターン" class="hash-link" aria-label="Application層で避けるべきアンチパターン への直接リンク" title="Application層で避けるべきアンチパターン への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-1-repository直接操作">❌ 1. Repository直接操作<a href="#-1-repository直接操作" class="hash-link" aria-label="❌ 1. Repository直接操作 への直接リンク" title="❌ 1. Repository直接操作 への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 悪い例: Repositoryを直接操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public OAuthRequestResponse request(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientConfiguration client = clientConfigurationQueryRepository.get(tenant, clientId);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ビジネスロジックをEntryServiceに実装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (client.isConfidential()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: Protocolに委譲</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public OAuthRequestResponse request(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OAuthRequest oAuthRequest = new OAuthRequest(tenant, params);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OAuthProtocol protocol = oAuthProtocols.get(tenant.authorizationProvider());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return protocol.request(oAuthRequest); // Protocol内で完結</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-2-管理api機能の混入">❌ 2. 管理API機能の混入<a href="#-2-管理api機能の混入" class="hash-link" aria-label="❌ 2. 管理API機能の混入 への直接リンク" title="❌ 2. 管理API機能の混入 への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 悪い例: 権限チェック・Audit Logを追加</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public OAuthRequestResponse request(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Application層に権限チェックは不要</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (!operator.hasPermission(&quot;OAUTH_REQUEST&quot;)) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return error();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Application層にAudit Logは不要</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  auditLogPublisher.publish(auditLog);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: シンプルな委譲のみ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public OAuthRequestResponse request(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Tenant tenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  OAuthProtocol protocol = oAuthProtocols.get(tenant.authorizationProvider());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return protocol.request(new OAuthRequest(tenant, params));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="application層-entryservice一覧">Application層 EntryService一覧<a href="#application層-entryservice一覧" class="hash-link" aria-label="Application層 EntryService一覧 への直接リンク" title="Application層 EntryService一覧 への直接リンク">​</a></h3>
<p><strong>情報源</strong>: <code>find libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/application -name &quot;*EntryService.java&quot;</code></p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="enduserエンドユーザー向け">enduser（エンドユーザー向け）<a href="#enduserエンドユーザー向け" class="hash-link" aria-label="enduser（エンドユーザー向け） への直接リンク" title="enduser（エンドユーザー向け） への直接リンク">​</a></h4>
<ul>
<li><code>OAuthFlowEntryService</code> - OAuth/OIDC認証・認可フロー</li>
<li><code>TokenEntryService</code> - トークンエンドポイント</li>
<li><code>UserinfoEntryService</code> - UserInfo API</li>
<li><code>CibaFlowEntryService</code> - CIBA（Client Initiated Backchannel Authentication）</li>
<li><code>IdentityVerificationApplicationEntryService</code> - 身元確認申込み</li>
<li><code>UserOperationEntryService</code> - ユーザー操作API</li>
<li><code>AuthenticationTransactionEntryService</code> - 認証トランザクション管理</li>
<li><code>AuthenticationMetaDataEntryService</code> - 認証メタデータ</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="relying_partyrp向け">relying_party（RP向け）<a href="#relying_partyrp向け" class="hash-link" aria-label="relying_party（RP向け） への直接リンク" title="relying_party（RP向け） への直接リンク">​</a></h4>
<ul>
<li><code>OidcMetaDataEntryService</code> - OIDC Discovery（.well-known）</li>
<li><code>SharedSignalsFrameworkMetaDataEntryService</code> - SSF Discovery</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="systemシステム内部">system（システム内部）<a href="#systemシステム内部" class="hash-link" aria-label="system（システム内部） への直接リンク" title="system（システム内部） への直接リンク">​</a></h4>
<ul>
<li><code>UserAuthenticationEntryService</code> - ユーザー認証処理</li>
<li><code>OrganizationUserAuthenticationEntryService</code> - 組織ユーザー認証</li>
<li><code>SecurityEventEntryService</code> - セキュリティイベント処理</li>
<li><code>UserLifecycleEventEntryService</code> - ユーザーライフサイクルイベント</li>
<li><code>AuditLogEntryService</code> - 監査ログ処理</li>
<li><code>TenantMetaDataEntryService</code> - テナントメタデータ</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="identity_verification_service身元確認サービス">identity_verification_service（身元確認サービス）<a href="#identity_verification_service身元確認サービス" class="hash-link" aria-label="identity_verification_service（身元確認サービス） への直接リンク" title="identity_verification_service（身元確認サービス） への直接リンク">​</a></h4>
<ul>
<li><code>IdentityVerificationEntryService</code> - 身元確認実行</li>
<li><code>IdentityVerificationCallbackEntryService</code> - 身元確認コールバック</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="tenant_invitatorテナント招待">tenant_invitator（テナント招待）<a href="#tenant_invitatorテナント招待" class="hash-link" aria-label="tenant_invitator（テナント招待） への直接リンク" title="tenant_invitator（テナント招待） への直接リンク">​</a></h4>
<ul>
<li><code>TenantInvitationMetaDataEntryService</code> - テナント招待メタデータ</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="control-plane層-entryservice-パターン">Control Plane層 EntryService パターン<a href="#control-plane層-entryservice-パターン" class="hash-link" aria-label="Control Plane層 EntryService パターン への直接リンク" title="Control Plane層 EntryService パターン への直接リンク">​</a></h2>
<p><strong>注意</strong>: 以下は**Control Plane層（管理API）**の実装パターンです。Application層とは異なります。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="システムレベル-vs-組織レベルapi">システムレベル vs 組織レベルAPI<a href="#システムレベル-vs-組織レベルapi" class="hash-link" aria-label="システムレベル vs 組織レベルAPI への直接リンク" title="システムレベル vs 組織レベルAPI への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="システムレベルapi">システムレベルAPI<a href="#システムレベルapi" class="hash-link" aria-label="システムレベルAPI への直接リンク" title="システムレベルAPI への直接リンク">​</a></h3>
<p><strong>メソッドシグネチャ</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Response method(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TenantIdentifier tenantIdentifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User operator,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OAuthToken oAuthToken,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Request request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RequestAttributes requestAttributes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean dryRun)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>特徴</strong>:</p>
<ul>
<li>テナント単位の操作</li>
<li><code>tenantIdentifier</code>が第一引数</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="組織レベルapi">組織レベルAPI<a href="#組織レベルapi" class="hash-link" aria-label="組織レベルAPI への直接リンク" title="組織レベルAPI への直接リンク">​</a></h3>
<p><strong>メソッドシグネチャ</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Response method(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OrganizationIdentifier organizationIdentifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    TenantIdentifier tenantIdentifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    User operator,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    OAuthToken oAuthToken,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    Request request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RequestAttributes requestAttributes,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    boolean dryRun)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>特徴</strong>:</p>
<ul>
<li>組織単位の操作（複数テナントを管理）</li>
<li><code>organizationIdentifier</code> → <code>tenantIdentifier</code>の順</li>
<li><strong>追加検証</strong>: 組織メンバーシップ・組織-テナント関係・権限検証</li>
</ul>
<p><strong>情報源</strong>: CLAUDE.md「組織レベルAPI設計」</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="組織アクセス制御フロー">組織アクセス制御フロー<a href="#組織アクセス制御フロー" class="hash-link" aria-label="組織アクセス制御フロー への直接リンク" title="組織アクセス制御フロー への直接リンク">​</a></h3>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/control_plane/organization_manager/OrgUserManagementEntryService.java#L150-L187">OrgUserManagementEntryService.java:150-187</a></p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 実際の実装パターン</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Phase 1: 権限取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AdminPermissions permissions = getRequiredPermissions(&quot;create&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Phase 2: Organization と Tenant 取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Organization organization = organizationRepository.get(organizationIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tenant targetTenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Phase 3: OrganizationAccessVerifier で統合検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OrganizationAccessVerifier organizationAccessVerifier = new OrganizationAccessVerifier();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OrganizationAccessControlResult accessResult =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    organizationAccessVerifier.verifyAccess(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        organization,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tenantIdentifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        permissions);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Phase 4: アクセス制御結果チェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (!accessResult.isSuccess()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Map&lt;String, Object&gt; response = new HashMap&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  response.put(&quot;error&quot;, &quot;access_denied&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  response.put(&quot;error_description&quot;, accessResult.getReason());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return new UserManagementResponse(UserManagementStatus.FORBIDDEN, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Phase 5: 以降のビジネスロジック実行</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コ  ピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>OrganizationAccessVerifier の検証内容</strong>:</p>
<ol>
<li>組織メンバーシップ検証（operatorが組織メンバーか）</li>
<li>テナントアクセス検証（tenantが組織に割り当てられているか）</li>
<li>組織-テナント関係検証（organization.assignedTenants()からチェック）</li>
<li>権限検証（必要な権限を持っているか）</li>
</ol>
<p><strong>情報源</strong>:</p>
<ul>
<li>CLAUDE.md「組織アクセス制御フロー」</li>
<li><a href="/idp-server/libs/idp-server-control-plane/src/main/java/org/idp/server/control_plane/organization/access/OrganizationAccessVerifier.java">OrganizationAccessVerifier.java</a></li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="context-creator-パターン">Context Creator パターン<a href="#context-creator-パターン" class="hash-link" aria-label="Context Creator パターン への直接リンク" title="Context Creator パターン への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="役割">役割<a href="#役割" class="hash-link" aria-label="役割 への直接リンク" title="役割 への直接リンク">​</a></h3>
<p>リクエストをドメインオブジェクトに変換し、Core層で使用可能なContextを構築。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="実装例">実装例<a href="#実装例" class="hash-link" aria-label="実装例 への直接リンク" title="実装例 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class ClientRegistrationContextCreator {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Tenant tenant;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientRegistrationRequest request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  boolean dryRun;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ClientRegistrationContextCreator(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      Tenant tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ClientRegistrationRequest request,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      boolean dryRun) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.tenant = tenant;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.request = request;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    this.dryRun = dryRun;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ClientRegistrationContext create() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ リクエストから値オブジェクトを構築</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientIdentifier clientIdentifier = new ClientIdentifier(request.clientId());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientName clientName = new ClientName(request.clientName());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    RedirectUris redirectUris = new RedirectUris(request.redirectUris());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ ClientConfigurationドメインオブジェクト構築</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientConfiguration configuration = ClientConfiguration.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .identifier(clientIdentifier)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .name(clientName)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .redirectUris(redirectUris)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // ✅ Contextを返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new ClientRegistrationContext(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tenant,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        configuration,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        dryRun);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要ポイント</strong>:</p>
<ul>
<li>✅ リクエストDTO → 値オブジェクト変換</li>
<li>✅ ドメインオブジェクト構築</li>
<li>✅ Contextカプセル化</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="audit-log-記録パターン">Audit Log 記録パターン<a href="#audit-log-記録パターン" class="hash-link" aria-label="Audit Log 記録パターン への直接リンク" title="Audit Log 記録パターン への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="auditlogcreator">AuditLogCreator<a href="#auditlogcreator" class="hash-link" aria-label="AuditLogCreator への直接リンク" title="AuditLogCreator への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">AuditLog auditLog = AuditLogCreator.create(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;ClientManagementApi.create&quot;,  // アクション名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tenant,                         // テナント</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    operator,                       // 操作者</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    oAuthToken,                     // アクセストークン</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    context,                        // コンテキスト（操作内容）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    requestAttributes);             // リクエスト属性（IP等）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auditLogPublisher.publish(auditLog);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="操作別audit-log">操作別Audit Log<a href="#操作別audit-log" class="hash-link" aria-label="操作別Audit Log への直接リンク" title="操作別Audit Log への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Create操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuditLogCreator.create(&quot;ClientManagementApi.create&quot;, ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Update操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuditLogCreator.create(&quot;ClientManagementApi.update&quot;, ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Delete操作</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuditLogCreator.create(&quot;ClientManagementApi.delete&quot;, ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Read操作（必要に応じて）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuditLogCreator.createOnRead(&quot;ClientManagementApi.get&quot;, ...)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>注意</strong>: <code>createOnRead()</code>で統一してエラー回避するのは<strong>アンチパターン</strong>。操作に応じて適切なメソッドを使用。</p>
<p><strong>情報源</strong>: CLAUDE.md「🚨 組織レベルAPI実装の重要注意事項」</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="トランザクション管理">トランザクション管理<a href="#トランザクション管理" class="hash-link" aria-label="トランザクション管理 への直接リンク" title="トランザクション管理 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="transaction-アノテーション">@Transaction アノテーション<a href="#transaction-アノテーション" class="hash-link" aria-label="@Transaction アノテーション への直接リンク" title="@Transaction アノテーション への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ デフォルト: 読み書きトランザクション</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">@Transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class ClientManagementEntryService implements ClientManagementApi {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ClientManagementResponse create(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // トランザクション内で実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 読み取り専用: パフォーマンス最適化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Override</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Transaction(readOnly = true)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ClientManagementResponse findList(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    // 読み取り専用トランザクション</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>効果</strong>:</p>
<ul>
<li>自動コミット/ロールバック</li>
<li>PostgreSQL Row Level Securityのための<code>app.tenant_id</code>設定</li>
<li>読み取り専用トランザクションでのパフォーマンス最適化</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="dry-run-パターン">Dry Run パターン<a href="#dry-run-パターン" class="hash-link" aria-label="Dry Run パターン への直接リンク" title="Dry Run パターン への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="目的">目的<a href="#目的" class="hash-link" aria-label="目的 への直接リンク" title="目的 への直接リンク">​</a></h3>
<p>実際の永続化を行わずに、検証結果のみを返却。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="実装">実装<a href="#実装" class="hash-link" aria-label="実装 への直接リンク" title="実装 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public Response create(..., boolean dryRun) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // Phase 1-7: 検証・Context構築・権限チェック</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ Dry Runの場合はここで返却</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  if (dryRun) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return context.toResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ Dry Runでない場合のみ永続化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository.register(tenant, context.configuration());</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return context.toResponse();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="レスポンス形式">レスポンス形式<a href="#レスポンス形式" class="hash-link" aria-label="レスポンス形式 への直接リンク" title="レスポンス形式 への直接リンク">​</a></h3>
<div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;dry_run&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean" style="color:#36acaa">true</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;result&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;generated-uuid&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;client_id&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;test-client&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;client_secret&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;generated-secret&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要</strong>: Dry Runでも<code>result</code>フィールド内に完全な結果を含める。</p>
<p><strong>情報源</strong>: CLAUDE.md「📝 レスポンス構造」</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="アンチパターン">アンチパターン<a href="#アンチパターン" class="hash-link" aria-label="アンチパターン への直接リンク" title="アンチパターン への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-1-context-creator軽視">❌ 1. Context Creator軽視<a href="#-1-context-creator軽視" class="hash-link" aria-label="❌ 1. Context Creator軽視 への直接リンク" title="❌ 1. Context Creator軽視 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 悪い例: TODOコメントで済ませる</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Response create(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // TODO: Context Creator実装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return new Response(Status.OK, &quot;適当なメッセージ&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: 必ずContext Creator使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Response create(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientRegistrationContextCreator contextCreator =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      new ClientRegistrationContextCreator(tenant, request, dryRun);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ClientRegistrationContext context = contextCreator.create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-2-audit-log手抜き">❌ 2. Audit Log手抜き<a href="#-2-audit-log手抜き" class="hash-link" aria-label="❌ 2. Audit Log手抜き への直接リンク" title="❌ 2. Audit Log手抜き への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 悪い例: createOnRead() で統一してエラー回避</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuditLog auditLog = AuditLogCreator.createOnRead(&quot;ClientManagementApi.create&quot;, ...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: 操作に応じた適切なメソッド</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuditLog auditLog = AuditLogCreator.create(&quot;ClientManagementApi.create&quot;, ...); // Create</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuditLog auditLog = AuditLogCreator.createOnUpdate(&quot;ClientManagementApi.update&quot;, ...); // Update</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuditLog auditLog = AuditLogCreator.createOnDelete(&quot;ClientManagementApi.delete&quot;, ...); // Delete</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-3-システムレベル実装の理解不足">❌ 3. システムレベル実装の理解不足<a href="#-3-システムレベル実装の理解不足" class="hash-link" aria-label="❌ 3. システムレベル実装の理解不足 への直接リンク" title="❌ 3. システムレベル実装の理解不足 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 悪い例: システムレベルを理解せずに組織レベル実装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Response orgMethod(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // システムレベルのパターンを理解せずに実装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // → Context Creator未使用、Audit Log不適切、権限チェック漏れ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: システムレベル実装を完全理解してから組織レベル実装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Response orgMethod(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 1. 組織メンバーシップ検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 2. テナントアクセス検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 3. 組織-テナント関係検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 4. 権限検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 5. システムレベルと同じパターンで実装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要教訓</strong>: 「組織レベル = システムレベル + 組織アクセス制御」であり、簡易版ではない。</p>
<p><strong>情報源</strong>: CLAUDE.md「❌ 致命的誤解（絶対回避）」</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="-4-たぶん適当に実装">❌ 4. 「たぶん」「適当に」実装<a href="#-4-たぶん適当に実装" class="hash-link" aria-label="❌ 4. 「たぶん」「適当に」実装 への直接リンク" title="❌ 4. 「たぶん」「適当に」実装 への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 悪い例: 推測実装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Response create(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // たぶんこれでいけるだろう（エラー依存判断）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository.register(configuration); // Tenant引数忘れ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 良い例: 既存実装パターンを参考</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public Response create(...) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // 既存のClientManagementEntryServiceと同じパターン</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  repository.register(tenant, configuration); // Tenant第一引数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>原則</strong>: 「不確実な実装より確実な設計確認を優先」</p>
<p><strong>情報源</strong>: CLAUDE.md「❌ 実装継続危険シグナル」</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="idpserverapplication---diコンテナ">IdpServerApplication - DIコンテナ<a href="#idpserverapplication---diコンテナ" class="hash-link" aria-label="IdpServerApplication - DIコンテナ への直接リンク" title="IdpServerApplication - DIコンテナ への直接リンク">​</a></h2>
<p><strong>情報源</strong>: <a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/IdpServerApplication.java">IdpServerApplication.java</a></p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="責務-1">責務<a href="#責務-1" class="hash-link" aria-label="責務 への直接リンク" title="責務 への直接リンク">​</a></h3>
<p>idp-server全体の依存性注入（DI）を管理する中央コンテナ。全てのAPI、Protocol、EntryService、Repositoryを組み立てる。</p>
<p><strong>規模</strong>: 1,288行、40以上のpublic APIメソッド</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要な役割">主要な役割<a href="#主要な役割" class="hash-link" aria-label="主要な役割 への直接リンク" title="主要な役割 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-application-api公開">1. Application API公開<a href="#1-application-api公開" class="hash-link" aria-label="1. Application API公開 への直接リンク" title="1. Application API公開 への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">public class IdpServerApplication {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ Application層API（エンドユーザー・RP向け）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public OAuthFlowApi oAuthFlowApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public TokenApi tokenAPi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public UserinfoApi userinfoApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public CibaFlowApi cibaFlowApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public AuthenticationTransactionApi authenticationApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public IdentityVerificationApplicationApi identityVerificationApplicationApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ システムレベルManagement API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public TenantManagementApi tenantManagementApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ClientManagementApi clientManagementApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public UserManagementApi userManagementAPi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public AuthorizationServerManagementApi authorizationServerManagementApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ... 約20個のManagement API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ 組織レベルManagement API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public OrgTenantManagementApi orgTenantManagementApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public OrgClientManagementApi orgClientManagementApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public OrgUserManagementApi orgUserManagementApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ... 約15個のOrg Management API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  // ✅ Admin API（システム管理）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public IdpServerStarterApi idpServerStarterApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public IdpServerOperationApi idpServerOperationApi() { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-entryservice組み立て--proxyラップ">2. EntryService組み立て + Proxyラップ<a href="#2-entryservice組み立て--proxyラップ" class="hash-link" aria-label="2. EntryService組み立て + Proxyラップ への直接リンク" title="2. EntryService組み立て + Proxyラップ への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// EntryService実装を生成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClientManagementEntryService entryService = new ClientManagementEntryService(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    tenantQueryRepository,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientConfigurationCommandRepository,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    clientConfigurationQueryRepository,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    auditLogPublisher</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ TenantAwareEntryServiceProxyでラップ（トランザクション自動管理）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClientManagementApi api = TenantAwareEntryServiceProxy.createProxy(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    entryService,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    ClientManagementApi.class,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    applicationDatabaseTypeProvider</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">return api;  // @Transactionアノテーション駆動で自動トランザクション管理</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-repositoryexecutorplugin組み立て">3. Repository・Executor・Plugin組み立て<a href="#3-repositoryexecutorplugin組み立て" class="hash-link" aria-label="3. Repository・Executor・Plugin組み立て への直接リンク" title="3. Repository・Executor・Plugin組み立て への直接リンク">​</a></h4>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// Repository組み立て</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TenantQueryRepository tenantQueryRepository = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">ClientConfigurationCommandRepository clientConfigurationCommandRepository = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// Plugin読み込み</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AuthenticationInteractors authenticationInteractors =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    AuthenticationInteractorPluginLoader.load(authenticationDependencyContainer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FederationInteractors federationInteractors =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    FederationInteractorPluginLoader.load(federationDependencyContainer);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// HttpRequestExecutor組み立て</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpClient httpClient = HttpClientFactory.create();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OAuthAuthorizationResolvers oauthResolvers = ...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">HttpRequestExecutor httpRequestExecutor = new HttpRequestExecutor(httpClient, oauthResolvers);</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="di階層構造">DI階層構造<a href="#di階層構造" class="hash-link" aria-label="DI階層構造 への直接リンク" title="DI階層構造 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">IdpServerApplication (DIコンテナ)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓ 組み立て</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">EntryService実装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓ Proxyラップ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TenantAwareEntryServiceProxy（@Transaction駆動）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓ 公開</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Management API / Application API</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ↓ 使用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Controller / Spring Boot</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要なdi対象">主要なDI対象<a href="#主要なdi対象" class="hash-link" aria-label="主要なDI対象 への直接リンク" title="主要なDI対象 への直接リンク">​</a></h3>
<table><thead><tr><th>カテゴリ</th><th>内容</th></tr></thead><tbody><tr><td><strong>Application API</strong></td><td>OAuth/Token/UserInfo/CIBA等（約10個）</td></tr><tr><td><strong>Management API</strong></td><td>System Level（約20個） + Organization Level（約15個）</td></tr><tr><td><strong>Admin API</strong></td><td>Starter/Operation（2個）</td></tr><tr><td><strong>Repository</strong></td><td>Query/Command（約50個）</td></tr><tr><td><strong>Protocol/Interactor</strong></td><td>Plugin読み込み・組み立て</td></tr><tr><td><strong>Executor</strong></td><td>HttpRequestExecutor, AuthenticationExecutors等</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="使用例spring-bootから">使用例（Spring Bootから）<a href="#使用例spring-bootから" class="hash-link" aria-label="使用例（Spring Bootから） への直接リン ク" title="使用例（Spring Bootから） への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class IdpServerConfiguration {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public IdpServerApplication idpServerApplication(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      DataSource dataSource,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      CacheStore cacheStore,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      // ... その他の依存関係</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return new IdpServerApplication(dataSource, cacheStore, ...);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  public ClientManagementApi clientManagementApi(IdpServerApplication app) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    return app.clientManagementApi();  // ✅ Proxyラップ済みのAPI取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要</strong>: Spring BootのControllerは、<code>IdpServerApplication</code>から取得したAPI（Proxyラップ済み）を使用する。</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="idp-server-use-cases-を理解するための8つのポイント">idp-server-use-cases を理解するための8つのポイント<a href="#idp-server-use-cases-を理解するための8つのポイント" class="hash-link" aria-label="idp-server-use-cases を理解するための8つのポイント への直接リンク" title="idp-server-use-cases を理解するための8つのポイント への直接リンク">​</a></h3>
<ol>
<li><strong>IdpServerApplication</strong>: 全体のDIコンテナ（1,288行、40以上のAPI）、Proxy統合の中心</li>
<li><strong>2  つのEntryService層</strong>: Application層（3-4フェーズ、Protocol委譲） vs Control Plane層（10フェーズ、完全制御）</li>
<li><strong>Application層パターン</strong>: Tenant取得 → Request構築 → Protocol実行 → Transaction管理</li>
<li><strong>Control Plane層10フェーズ</strong>: 権限取得 → Tenant取得 → Validator → Context Creator → Audit Log → 権限チェック → バリデーション → Dry Run → 永続化 → レスポンス</li>
<li><strong>Context Creator必須</strong>（Control Planeのみ）: TODOコメントで済ませず、必ず実装</li>
<li><strong>Audit Log適切化</strong>（Control Planeのみ）: 操作に応じたメソッド使用（create/update/delete別）</li>
<li><strong>システムレベル理解優先</strong>: 組織レベル実装前にシステムレベルを完全理解</li>
<li><strong>Tenant第一引数</strong>: Repository操作は必ずTenant第一引数（OrganizationRepository除く）</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="application層-vs-control-plane層-選択基準">Application層 vs Control Plane層 選択基準<a href="#application層-vs-control-plane層-選択基準" class="hash-link" aria-label="Application層 vs Control Plane層 選択基準 への直接リンク" title="Application層 vs Control Plane層 選択基準 への直接リンク">​</a></h3>
<table><thead><tr><th>質問</th><th>Application層</th><th>Control Plane層</th></tr></thead><tbody><tr><td>対象ユーザーは？</td><td>エンドユーザー/RP</td><td>管理者</td></tr><tr><td>ビジネスロジックはどこ？</td><td>Core層Protocol</td><td>EntryService内</td></tr><tr><td>権限チェックは必要？</td><td>❌ 不要</td><td>✅ 必須</td></tr><tr><td>Audit Logは必要？</td><td>❌ 不要</td><td>✅ 必須</td></tr><tr><td>Dry Runは必要？</td><td>❌ 不要</td><td>✅ 必須</td></tr><tr><td>OIDC仕様準拠？</td><td>✅ 厳密準拠</td><td>△ 管理操作</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="次のステップ">次のステップ<a href="#次のステップ" class="hash-link" aria-label="次のステップ への直接リンク" title="次のステップ への直接リンク">​</a></h3>
<ul>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-13-control-plane">idp-server-control-plane（管理API契約）</a> - API契約定義</li>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-21-core-adapter">idp-server-core-adapter（アダプター層）</a> - Repository実装</li>
<li><a href="/idp-server/docs/content_10_ai_developer/ai-22-database">idp-server-database（データベース層）</a> - スキーマ・マイグレーション</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="ドキュメント修正履歴">ドキュメント修正履歴<a href="#ドキュメント修正履歴" class="hash-link" aria-label="ドキュメント修正履歴 への直接リンク" title="ドキュメント修正履歴 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="2025-10-12-実装検証に基づく修正">2025-10-12: 実装検証に基づく修正<a href="#2025-10-12-実装検証に基づく修正" class="hash-link" aria-label="2025-10-12: 実装検証に基づく修正 への直接リンク" title="2025-10-12: 実装検証に基づく修正 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="修正1-組織アクセス制御フローの実装に合わせた修正-551-593行目">修正1: 組織アクセス制御フローの実装に合わせた修正 (551-593行目)<a href="#修正1-組織アクセス制御フローの実装に合わせた修正-551-593行目" class="hash-link" aria-label="修正1: 組織アクセス制御フローの実装に合わせた修正 (551-593行目) への直接リンク" title="修正1: 組織アクセス制御フローの実装に合わせた修正 (551-593行目) への直接リンク">​</a></h4>
<p><strong>問題</strong>: 存在しないRepositoryメソッドを使用した想像フロー</p>
<p><strong>修正前</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 存在しないメソッド</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OrganizationMember member = organizationMemberRepository.find(...);  // ❌ 存在しない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">AssignedTenant assignment = organizationRepository.findAssignment(...);  // ❌ 存在しない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ❌ 個別の検証ロジック（実際は統合されている）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (member == null) { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (assignment == null) { ... }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (!permissions.includesAll(...)) { ... }</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>修正後</strong>:</p>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ 実際の実装</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Organization organization = organizationRepository.get(organizationIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Tenant targetTenant = tenantQueryRepository.get(tenantIdentifier);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">// ✅ OrganizationAccessVerifier で統合検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OrganizationAccessVerifier organizationAccessVerifier = new OrganizationAccessVerifier();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">OrganizationAccessControlResult accessResult =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    organizationAccessVerifier.verifyAccess(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        organization,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        tenantIdentifier,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        operator,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        permissions);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">if (!accessResult.isSuccess()) {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  return new UserManagementResponse(UserManagementStatus.FORBIDDEN, response);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p><strong>重要な変更</strong>:</p>
<ul>
<li>個別検証 → <strong>OrganizationAccessVerifier</strong> による統合検証</li>
<li>存在しないメソッド削除（findMember, findAssignment）</li>
<li><code>OrganizationAccessControlResult</code> によるアクセス制御結果管理</li>
<li>4ステップの検証内容を説明として明記</li>
</ul>
<p><strong>検証</strong>:</p>
<ul>
<li><a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/control_plane/organization_manager/OrgUserManagementEntryService.java#L150-L187">OrgUserManagementEntryService.java:150-187</a></li>
<li><a href="/idp-server/libs/idp-server-control-plane/src/main/java/org/idp/server/control_plane/organization/access/OrganizationAccessVerifier.java">OrganizationAccessVerifier.java</a></li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="検証済み項目">検証済み項目<a href="#検証済み項目" class="hash-link" aria-label="検証済み項目 への直接リンク" title="検証済み項目 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-entryservice-10フェーズパターン">✅ EntryService 10フェーズパターン<a href="#-entryservice-10フェーズパターン" class="hash-link" aria-label="✅ EntryService 10フェーズパターン への直接リンク" title="✅ EntryService 10フェーズパターン への直接リンク">​</a></h4>
<ul>
<li><a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/control_plane/system_manager/ClientManagementEntryService.java#L47-L114">ClientManagementEntryService.java:47-114</a></li>
<li>全10フェーズが実装と完全一致</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-application層パターン">✅ Application層パターン<a href="#-application層パターン" class="hash-link" aria-label="✅ Application層パターン への直接リンク" title="✅ Application層パターン への直接リンク">​</a></h4>
<ul>
<li><a href="/idp-server/libs/idp-server-use-cases/src/main/java/org/idp/server/usecases/application/enduser/OAuthFlowEntryService.java#L117-L138">OAuthFlowEntryService.java:117-138</a></li>
<li>シンプルな委譲パターンが正確</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-transaction-アノテーション">✅ @Transaction アノテーション<a href="#-transaction-アノテーション" class="hash-link" aria-label="✅ @Transaction アノテーション への直接リンク" title="✅ @Transaction アノテーション への直接リンク">​</a></h4>
<ul>
<li>クラスレベル: <code>@Transaction</code></li>
<li>メソッドレベル: <code>@Transaction(readOnly = true)</code></li>
<li>実装と完全一致</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="-シ ステムレベル-vs-組織レベル">✅ システムレベル vs 組織レベル<a href="#-システムレベル-vs-組織レベル" class="hash-link" aria-label="✅ システムレベル vs 組織レベル への直接リンク" title="✅ システムレベル vs 組織レベル への直接リンク">​</a></h4>
<ul>
<li>メソッドシグネチャの違いが正確</li>
<li><code>OrganizationIdentifier</code> → <code>TenantIdentifier</code> の順序が正確</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="修正の原則">修正の原則<a href="#修正の原則" class="hash-link" aria-label="修正の原則 への直接リンク" title="修正の原則 への直接リンク">​</a></h3>
<p><strong>CLAUDE.md「想像ドキュメント作成防止」に基づく修正</strong>:</p>
<ol>
<li><strong>実装ファースト</strong>: 実際の組織レベルEntryServiceを確認</li>
<li><strong>統合検証パターン</strong>: OrganizationAccessVerifierの使用を正確に記載</li>
<li><strong>存在しないメソッド削除</strong>: findMember(), findAssignment()の削除</li>
<li><strong>情報源記録</strong>: 実装ファイルパス・行番号を明記</li>
</ol>
<hr>
<p><strong>情報源</strong>:</p>
<ul>
<li><code>libs/idp-server-use-cases/src/main/java/</code>配下の実装コード</li>
<li>CLAUDE.md「4層アーキテクチャ詳細」「組織レベルAPI設計」「🚨 組織レベルAPI実装の重要注意事項」</li>
<li><a href="/idp-server/assets/files/ClientManagementEntryService-ebaed311a2fd256dc6a40b4a3f4706df.java" target="_blank">ClientManagementEntryService.java</a></li>
<li><a href="/idp-server/assets/files/OrgUserManagementEntryService-d8887d01d7a94d8877a3e3a03cfb7201.java" target="_blank">OrgUserManagementEntryService.java</a></li>
<li><a href="/idp-server/assets/files/OrganizationAccessVerifier-e8391c6d3faebe817677d89bb0c1d718.java" target="_blank">OrganizationAccessVerifier.java</a></li>
</ul>
<p><strong>最終更新</strong>: 2025-10-12
<strong>確認方法</strong>: <code>find libs/idp-server-use-cases -type f -name &quot;*EntryService.java&quot; | head -15</code>
<strong>レビュー実施</strong>: 2025-10-12 - AI開発者向けドキュメント品質改善プロジェクト</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_10_ai_developer/ai-10-use-cases.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_10_ai_developer/ai-02-lessons-learned"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">AI開発者向けドキュメント作成ガイド</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_10_ai_developer/ai-11-core"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">idp-server-core - OAuth 2.0/OIDC準拠コアエンジン</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#モジュール概要" class="table-of-contents__link toc-highlight">モジュール概要</a><ul><li><a href="#責務" class="table-of-contents__link toc-highlight">責務</a></li><li><a href="#依存関係" class="table-of-contents__link toc-highlight">依存関係</a></li></ul></li><li><a href="#パッケージ構成" class="table-of-contents__link toc-highlight">パッケージ構成</a><ul><li><a href="#-application層-application" class="table-of-contents__link toc-highlight">🔷 Application層 (<code>application/</code>)</a></li><li><a href="#️-control-plane層-control_plane" class="table-of-contents__link toc-highlight">🎛️ Control Plane層 (<code>control_plane/</code>)</a></li></ul></li><li><a href="#entryservice-パターン" class="table-of-contents__link toc-highlight">EntryService パターン</a><ul><li><a href="#命名規則" class="table-of-contents__link toc-highlight">命名規則</a></li><li><a href="#実装パターン" class="table-of-contents__link toc-highlight">実装パターン</a></li></ul></li><li><a href="#entryserviceの10フェーズ" class="table-of-contents__link toc-highlight">EntryServiceの10フェーズ</a><ul><li><a href="#phase-1-権限取得" class="table-of-contents__link toc-highlight">Phase 1: 権限取得</a></li><li><a href="#phase-2-tenant取得" class="table-of-contents__link toc-highlight">Phase 2: Tenant取得</a></li><li><a href="#phase-3-validator---入力検証" class="table-of-contents__link toc-highlight">Phase 3: Validator - 入力検証</a></li><li><a href="#phase-4-context-creator---コンテキスト構築" class="table-of-contents__link toc-highlight">Phase 4: Context Creator - コンテキスト構築</a></li><li><a href="#phase-5-audit-log記録" class="table-of-contents__link toc-highlight">Phase 5: Audit Log記録</a></li><li><a href="#phase-6-権限チェック" class="table-of-contents__link toc-highlight">Phase 6: 権限チェック</a></li><li><a href="#phase-7-バリデーションエラーチェック" class="table-of-contents__link toc-highlight">Phase 7: バリデーションエラーチェック</a></li><li><a href="#phase-8-dry-run対応" class="table-of-contents__link toc-highlight">Phase 8: Dry Run対応</a></li><li><a href="#phase-9-永続化" class="table-of-contents__link toc-highlight">Phase 9: 永続化</a></li><li><a href="#phase-10-レスポンス返却" class="table-of-contents__link toc-highlight">Phase 10: レスポンス返却</a></li></ul></li><li><a href="#application層-entryservice-パターン" class="table-of-contents__link toc-highlight">Application層 EntryService パターン</a><ul><li><a href="#設計思想" class="table-of-contents__link toc-highlight">設計思想</a></li><li><a href="#application層の特徴" class="table-of-contents__link toc-highlight">Application層の特徴</a></li><li><a href="#実装パターン1-oauth認可フロー" class="table-of-contents__link toc-highlight">実装パターン1: OAuth認可フロー</a></li><li><a href="#実装パターン2-メタデータapi読み取り専用" class="table-of-contents__link toc-highlight">実装パターン2: メタデータAPI（読み取り専用）</a></li><li><a href="#application層の3-4フェーズ" class="table-of-contents__link toc-highlight">Application層の3-4フェーズ</a></li><li><a href="#application層-vs-control-plane層-比較" class="table-of-contents__link toc-highlight">Application層 vs Control Plane層 比較</a></li><li><a href="#application層で避けるべきアンチパターン" class="table-of-contents__link toc-highlight">Application層で避けるべきアンチパターン</a></li><li><a href="#application層-entryservice一覧" class="table-of-contents__link toc-highlight">Application層 EntryService一覧</a></li></ul></li><li><a href="#control-plane層-entryservice-パターン" class="table-of-contents__link toc-highlight">Control Plane層 EntryService パターン</a></li><li><a href="#システムレベル-vs-組織レベルapi" class="table-of-contents__link toc-highlight">システムレベル vs 組織レベルAPI</a><ul><li><a href="#システムレベルapi" class="table-of-contents__link toc-highlight">システムレベルAPI</a></li><li><a href="#組織レベルapi" class="table-of-contents__link toc-highlight">組織レベルAPI</a></li><li><a href="# 組織アクセス制御フロー" class="table-of-contents__link toc-highlight">組織アクセス制御フロー</a></li></ul></li><li><a href="#context-creator-パターン" class="table-of-contents__link toc-highlight">Context Creator パターン</a><ul><li><a href="#役割" class="table-of-contents__link toc-highlight">役割</a></li><li><a href="#実装例" class="table-of-contents__link toc-highlight">実装例</a></li></ul></li><li><a href="#audit-log-記録パターン" class="table-of-contents__link toc-highlight">Audit Log 記録パターン</a><ul><li><a href="#auditlogcreator" class="table-of-contents__link toc-highlight">AuditLogCreator</a></li><li><a href="#操作別audit-log" class="table-of-contents__link toc-highlight">操作別Audit Log</a></li></ul></li><li><a href="#トランザクション管理" class="table-of-contents__link toc-highlight">トランザクション管理</a><ul><li><a href="#transaction-アノテーション" class="table-of-contents__link toc-highlight">@Transaction アノテーション</a></li></ul></li><li><a href="#dry-run-パターン" class="table-of-contents__link toc-highlight">Dry Run パターン</a><ul><li><a href="#目的" class="table-of-contents__link toc-highlight">目的</a></li><li><a href="#実装" class="table-of-contents__link toc-highlight">実装</a></li><li><a href="#レスポンス形式" class="table-of-contents__link toc-highlight">レスポンス形式</a></li></ul></li><li><a href="#アンチパターン" class="table-of-contents__link toc-highlight">アンチパターン</a><ul><li><a href="#-1-context-creator軽視" class="table-of-contents__link toc-highlight">❌ 1. Context Creator軽視</a></li><li><a href="#-2-audit-log手抜き" class="table-of-contents__link toc-highlight">❌ 2. Audit Log手抜き</a></li><li><a href="#-3-システムレベル実装の理解不足" class="table-of-contents__link toc-highlight">❌ 3. システムレベル実装の理解不足</a></li><li><a href="#-4-たぶん適当に実装" class="table-of-contents__link toc-highlight">❌ 4. 「たぶん」「適当に」実装</a></li></ul></li><li><a href="#idpserverapplication---diコンテナ" class="table-of-contents__link toc-highlight">IdpServerApplication - DIコンテナ</a><ul><li><a href="#責務-1" class="table-of-contents__link toc-highlight">責務</a></li><li><a href="#主要な役割" class="table-of-contents__link toc-highlight">主要な役割</a></li><li><a href="#di階層構造" class="table-of-contents__link toc-highlight">DI階層構造</a></li><li><a href="#主要なdi対象" class="table-of-contents__link toc-highlight">主要なDI対象</a></li><li><a href="#使用例spring-bootから" class="table-of-contents__link toc-highlight">使用例（Spring Bootから）</a></li></ul></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a><ul><li><a href="#idp-server-use-cases-を理解するための8つのポイント" class="table-of-contents__link toc-highlight">idp-server-use-cases を理解するための8つのポイント</a></li><li><a href="#application層-vs-control-plane層-選択基準" class="table-of-contents__link toc-highlight">Application層 vs Control Plane層 選択基準</a></li><li><a href="#次のステップ" class="table-of-contents__link toc-highlight">次のステップ</a></li></ul></li><li><a href="#ドキュメント修正履歴" class="table-of-contents__link toc-highlight">ドキュメント修正履歴</a><ul><li><a href="#2025-10-12-実装検証に基づく修正" class="table-of-contents__link toc-highlight">2025-10-12: 実装検証に基づく修正</a></li><li><a href="#検証済み項目" class="table-of-contents__link toc-highlight">検証済み項目</a></li><li><a href="#修正の原則" class="table-of-contents__link toc-highlight">修正の原則</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>