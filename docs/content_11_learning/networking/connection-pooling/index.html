<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_11_learning/networking/connection-pooling" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">コネクションプーリング詳細 | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/networking/connection-pooling"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="コネクションプーリング詳細 | IdP-Server Documentation"><meta data-rh="true" name="description" content="所要時間"><meta data-rh="true" property="og:description" content="所要時間"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/networking/connection-pooling"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/networking/connection-pooling" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/networking/connection-pooling" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.a39ca812.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.c4bb6b3c.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">ドキュメントガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_03_concepts/foundation/concept-01-multi-tenant">コア概念</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認証・認可プロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_05_how-to/">How-to（設定・運用レシピ）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_06_developer-guide/">開発者ガイド</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_11_learning/identity-basics/identity-management-basics">学習（Learning）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/identity-basics/identity-management-basics">アイデンティティ管理の基礎</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-fundamentals/modern-web-authz-authn">OAuth 2.0の基礎</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-tokens/id-token-jwt">OAuth 2.0トークン</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/openid-connect/oauth-oidc-basics">OpenID Connect</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/fido-webauthn/fido2-architecture-rp-browser-authenticator">FIDO2/WebAuthn</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/security/glossary">セキュリティ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/multi-tenancy/multi-tenancy-basics">マルチテナント</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/advanced-protocols/ciba-basics">高度なプロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/http-rest/http-basics">HTTP/REST</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/jwt-jose/jwt-introduction">JWT/JOSE</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/">OAuth/OIDC RFC学習</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/verifiable-credentials/">Verifiable Credentials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/data-formats/">データフォーマット</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/session-management/web-session-basics">セッション管理</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/">PostgreSQL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/crypto/">暗号化</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/kubernetes/">コンテナ/Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/linux/">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_11_learning/networking/">ネットワーク</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/networking/">ネットワーク学習ガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/networking/tcp-fundamentals">プロトコル基礎</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/networking/dns-fundamentals">DNS</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_11_learning/networking/load-balancing">インフラストラクチャ</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/networking/load-balancing">ロードバランシング</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/networking/ssl-tls-certificates">SSL/TLS証明書管理</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/networking/https-termination">HTTPS終端（SSL/TLS Termination）</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/networking/web-server-architecture">Webサーバーアーキテクチャ</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_11_learning/networking/connection-pooling">コネクションプーリング詳細</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/networking/api-gateway-networking">リバースプロキシとAPI Gateway</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/networking/network-troubleshooting">トラブルシューティング</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/networking/column-speed-of-light">コラム</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/jvm/">JVM</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/java/">Java</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/os-fundamentals/">OS基礎</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/frameworks/">フレームワーク</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/sdk/">SDK</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/clean-architecture/">クリーンアーキテクチャ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/performance-tuning/">パフォーマンス・チューニング</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">学習（Learning）</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">  ネットワーク</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">インフラストラクチャ</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">コネクションプーリング詳細</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>コネクションプーリング詳細</h1></header>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="所要時間">所要時間<a href="#所要時間" class="hash-link" aria-label="所要時間 への直接リンク" title="所要時間 への直接リンク">​</a></h2>
<p>約45分</p>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="学べること">学べること<a href="#学べること" class="hash-link" aria-label="学べること への直接リンク" title="学べること への直接リンク">​</a></h2>
<ul>
<li>なぜコネクションプーリングが必要なのか</li>
<li>データベース接続プール（HikariCP）の仕組みと設定</li>
<li>HTTPクライアントのコネクションプール</li>
<li>Redis等のコネクションプール</li>
<li>適切なプールサイズの決め方</li>
<li>トラブルシューティング</li>
</ul>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="前提知識">前提知識<a href="#前提知識" class="hash-link" aria-label="前提知識 への直接リンク" title="前提知識 への直接リンク">​</a></h2>
<ul>
<li><a href="/idp-server/docs/content_11_learning/networking/tcp-fundamentals">09-tcp-fundamentals.md</a> - TCP基礎（3ウェイハンドシェイク、TIME_WAIT）</li>
<li><a href="/idp-server/docs/content_11_learning/networking/web-server-architecture">10-web-server-architecture.md</a> - Webサーバーアーキテクチャ</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-なぜコネクションプーリングが必要か">1. なぜコネクションプーリングが必要か<a href="#1-なぜコネクションプーリングが必要か" class="hash-link" aria-label="1. なぜコネクションプーリングが必要か への直接リンク" title="1. なぜコネクションプーリングが必要か への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-接続のコスト">1.1 接続のコスト<a href="#11-接続のコスト" class="hash-link" aria-label="1.1 接続のコスト への直接リンク" title="1.1 接続のコスト への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              TCP接続のオーバーヘッド                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【接続ごとに発生するコスト】                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. TCP 3ウェイハンドシェイク                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     Client ──SYN──────────► Server                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     Client ◄──SYN+ACK────── Server    ← 1 RTT              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     Client ──ACK──────────► Server                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. TLSハンドシェイク（HTTPS/TLS接続の場合）                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     追加で 1〜2 RTT                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. 認証（データベースの場合）                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ユーザー名/パスワード検証、セッション確立               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  4. 切断時の TIME_WAIT                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     切断後 60秒〜120秒 ソケットが残存                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【具体的な時間】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  同一データセンター内:                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - TCP接続: 0.5ms〜1ms                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - TLS追加: 1ms〜2ms                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - PostgreSQL認証: 5ms〜10ms                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  → 合計: 約10ms のオーバーヘッド                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  クロスリージョン（東京↔バージニア）:                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - RTT: 約150ms                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - TCP + TLS: 300ms〜450ms                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  → 合計: 数百ms のオーバーヘッド                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-プールなしの問題">1.2 プールなしの問題<a href="#12-プールなしの問題" class="hash-link" aria-label="1.2 プールなしの問題 への直接リンク" title="1.2 プールなしの問題 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              プールなしの動作                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  リクエストごとに接続・切断                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Request 1:                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    [接続 10ms][クエリ 2ms][切断] → 合計 12ms+               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Request 2:                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    [接続 10ms][クエリ 2ms][切断] → 合計 12ms+               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Request 3:                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    [接続 10ms][クエリ 2ms][切断] → 合計 12ms+               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  問題:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 接続オーバーヘッドがクエリ時間より長い                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - TIME_WAIT でソケット枯渇のリスク                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - DBサーバーへの接続数が制御できない                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 高負荷時にDB接続上限に達する                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-プールありの動作">1.3 プールありの動作<a href="#13-プールありの動作" class="hash-link" aria-label="1.3 プールありの動作 への直接リンク" title="1.3 プールありの動作 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              プールありの動作                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  起動時に接続を確立してプール                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────┐    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  Connection Pool                                    │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐               │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │Conn│ │Conn│ │Conn│ │Conn│ │Conn│  (idle)       │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ 1  │ │ 2  │ │ 3  │ │ 4  │ │ 5  │               │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  └────┘ └────┘ └────┘ └────┘ └────┘               │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────┘    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ↑                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       │ borrow                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       │                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Request 1:                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    [借用 0.01ms][クエリ 2ms][返却] → 合計 2ms               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Request 2:                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    [借用 0.01ms][クエリ 2ms][返却] → 合計 2ms               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  効果:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 接続オーバーヘッドがほぼゼロ                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - TIME_WAIT 問題なし（接続を維持するため）                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 接続数の上限を制御可能                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - DBサーバーへの負荷を予測可能                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-データベース接続プールhikaricp">2. データベース接続プール（HikariCP）<a href="#2-データベース接続プールhikaricp" class="hash-link" aria-label="2. データベース接続プ ール（HikariCP） への直接リンク" title="2. データベース接続プール（HikariCP） への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-hikaricp-の基本">2.1 HikariCP の基本<a href="#21-hikaricp-の基本" class="hash-link" aria-label="2.1 HikariCP の基本 への直接リンク" title="2.1 HikariCP の基本 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              HikariCP のアーキテクチャ                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Spring Boot Application                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       │                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ▼                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────┐    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  HikariDataSource                                   │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                                                     │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ┌───────────────────────────────────────────────┐  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  ConcurrentBag (コネクション管理)             │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │                                               │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  ┌────────────────────────────────────────┐   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  │ Connection[] (プール)                  │   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  │                                        │   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  │  [0] IDLE     ← 借用可能              │   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  │  [1] IN_USE   ← 使用中                │   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  │  [2] IDLE     ← 借用可能              │   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  │  [3] IN_USE   ← 使用中                │   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  │  [4] IDLE     ← 借用可能              │   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  │  ...                                   │   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  └────────────────────────────────────────┘   │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │                                               │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  HouseKeeper (定期メンテナンス)               │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  - アイドル接続の削除                         │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │  - 接続の有効性チェック                       │  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  └───────────────────────────────────────────────┘  │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                                                     │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────┘    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       │                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       │ TCP接続（維持）                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ▼                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  PostgreSQL / MySQL                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-hikaricp-設定spring-boot">2.2 HikariCP 設定（Spring Boot）<a href="#22-hikaricp-設定spring-boot" class="hash-link" aria-label="2.2 HikariCP 設定（Spring Boot） への直接リンク" title="2.2 HikariCP 設定（Spring Boot） への直接リンク">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datasource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jdbc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">postgresql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//localhost</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">5432/mydb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> myuser</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DB_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hikari</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># プールサイズ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">minimum-idle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># 最小アイドル接続数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">maximum-pool-size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic"># 最大接続数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># タイムアウト</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">connection-timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30000</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 接続取得タイムアウト (ms)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">idle-timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600000</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic"># アイドル接続の生存時間 (ms)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">max-lifetime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1800000</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic"># 接続の最大生存時間 (ms)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 検証</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">validation-timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic"># 接続検証タイムアウト (ms)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># その他</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">pool-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> MyAppPool           </span><span class="token comment" style="color:#999988;font-style:italic"># プール名（ログで識別用）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">auto-commit</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain">              </span><span class="token comment" style="color:#999988;font-style:italic"># 自動コミット</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-各設定の意味">2.3 各設定の意味<a href="#23-各設定の意味" class="hash-link" aria-label="2.3 各設定の意味 への直接リンク" title="2.3 各設定の意味 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              HikariCP 設定パラメータ詳細                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【maximum-pool-size】                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  プールが持てる最大接続数                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 全リクエストがこの数を超えると待機が発生                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - DBサーバーの max_connections も考慮必要                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - アプリ複数台の場合: 全アプリの合計 &lt; DB上限              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  例: アプリ5台 × pool-size 10 = 50接続                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      → PostgreSQL max_connections は 100 以上必要           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【minimum-idle】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  維持する最小アイドル接続数                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 負荷が低い時でもこの数は維持                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - コールドスタート回避（最初のリクエストが速い）           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - maximum-pool-size と同じにするのが HikariCP 推奨         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【connection-timeout】                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  プールから接続を取得するまでの最大待機時間                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - タイムアウトすると SQLException 発生                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 30秒がデフォルト                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 短すぎると高負荷時にエラー多発                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 長すぎるとリクエストがタイムアウト                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【max-lifetime】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  接続の最大生存時間                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - この時間を過ぎた接続は破棄→再作成                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - DBの wait_timeout より短くする                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - PostgreSQLデフォルト: 無制限                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - MySQL デフォルト: 8時間 (28800秒)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  推奨: DBの wait_timeout - 30秒                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【idle-timeout】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  アイドル接続が削除されるまでの時間                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - minimum-idle を下回らない範囲で削除                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - minimum-idle = maximum-pool-size なら無効                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-適切なプールサイズの決め方">2.4 適切なプールサイズの決め方<a href="#24-適切なプールサイズの決め方" class="hash-link" aria-label="2.4 適切なプールサイズの決め方 への直接リンク" title="2.4 適切なプールサイズの決め方 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              プールサイズの決め方                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【公式（HikariCP作者推奨）】                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  connections = (core_count * 2) + effective_spindle_count   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - core_count: CPUコア数                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - effective_spindle_count: HDDなら1、SSDなら0              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  例: 4コアCPU + SSD = (4 * 2) + 0 = 8接続                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【現実的な考え方】                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  スレッド数とのバランス:                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Tomcat max-threads: 200                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  DB pool-size: 10                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  → 200スレッドが同時にDB接続を要求すると                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    190スレッドが待機状態になる                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  対策:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. クエリを速くする（インデックス最適化）                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. プールサイズを適切に増やす                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. スレッド数を減らす                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  4. 非同期処理でDBアクセスを減らす                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【よくある設定例】                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  小規模アプリ（1台）:                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    maximum-pool-size: 10                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  中規模アプリ（5〜10台）:                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    maximum-pool-size: 10〜20                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ※ 全アプリ合計がDB上限を超えないこと                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  大規模（PgBouncer使用）:                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    アプリ側: 20〜50                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    PgBouncer で集約して DB へ                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────  ────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-コネクションプロキシpgbouncer">3. コネクションプロキシ（PgBouncer）<a href="#3-コネクションプロキシpgbouncer" class="hash-link" aria-label="3. コネクションプロキシ（PgBouncer） への直接リンク" title="3. コネクションプロキシ（PgBouncer） への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-なぜ必要か">3.1 なぜ必要か<a href="#31-なぜ必要か" class="hash-link" aria-label="3.1 なぜ必要か への直接リンク" title="3.1 なぜ必要か への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              PgBouncer の役割                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【問題: アプリ台数が増えると接続数が爆発】                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 1 (pool=20) ──┐                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 2 (pool=20) ──┼──► PostgreSQL (max_connections=100)   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 3 (pool=20) ──┤                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 4 (pool=20) ──┤    ← 80接続で余裕なし                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 5 (pool=20) ──┘    ← 100超えで接続エラー               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ────────────────────────────────────────────────────  ─────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【解決: PgBouncer で接続を集約】                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 1 (pool=20) ──┐                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 2 (pool=20) ──┤                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 3 (pool=20) ──┼──► PgBouncer ──► PostgreSQL           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 4 (pool=20) ──┤    (100接続)     (20接続)              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  App 5 (pool=20) ──┘                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  アプリ側: 100接続                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  DB側: 20接続 ← 大幅削減                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-プーリングモード">3.2 プーリングモード<a href="#32-プーリングモード" class="hash-link" aria-label="3.2 プーリングモード への直接リンク" title="3.2 プーリングモード への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              PgBouncer のプーリングモード                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────── ─────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【session モード】                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - クライアント接続中は同じDB接続を維持                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 効果は限定的（接続を共有しない）                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - PREPARE文、一時テーブルが使える                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【transaction モード】★推奨                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - トランザクション単位でDB接続を共有                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 効果が高い（1つのDB接続を複数クライアントで再利用）      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - PREPARE文、SET、一時テーブルは使えない                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【statement モード】                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - SQL文単位でDB接続を共有                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 最も効率的だがトランザクション不可                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 特殊なユースケースのみ                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-設定例">3.3 設定例<a href="#33-設定例" class="hash-link" aria-label="3.3 設定例 への直接リンク" title="3.3 設定例 への直接リンク">​</a></h3>
<div class="language-ini codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-ini codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># /etc/pgbouncer/pgbouncer.ini</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[databases]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">mydb = host=127.0.0.1 port=5432 dbname=mydb</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[pgbouncer]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listen_addr = 0.0.0.0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">listen_port = 6432</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth_type = md5</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">auth_file = /etc/pgbouncer/userlist.txt</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># プーリングモード</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">pool_mode = transaction</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接続数設定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">max_client_conn = 1000    # クライアントからの最大接続</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">default_pool_size = 20    # DB毎のデフォルトプールサイズ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">min_pool_size = 5         # 最小プールサイズ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">reserve_pool_size = 5     # 予備接続数</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-httpクライアントのコネクションプール">4. HTTPクライアントのコネクションプール<a href="#4-httpクライアントのコネクションプール" class="hash-link" aria-label="4. HTTPクライアントのコネクションプール への直接リンク" title="4. HTTPクライアントのコネクションプール への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-なぜhttpでもプールが必要か">4.1 なぜHTTPでもプールが必要か<a href="#41-なぜhttpでもプールが必要か" class="hash-link" aria-label="4.1 なぜHTTPでもプールが必要か への直接リンク" title="4.1 なぜHTTPでもプールが必要か への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              HTTPクライアント接続の問題                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【マイクロサービス間通信】                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Service A ──HTTP──► Service B                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  各リクエストで接続を作成すると:                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - TCP 3ウェイハンドシェイク: 0.5ms〜1ms                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - TLSハンドシェイク（HTTPS）: 1ms〜2ms                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 切断後の TIME_WAIT 蓄積                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1000 req/sec の場合:                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 1秒で1000回のTCP接続確立                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - TIME_WAIT が60秒残ると: 60,000ソケット滞留               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ポート枯渇のリスク                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【解決: HTTP Keep-Alive + コネクションプール】              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1つのTCP接続で複数のHTTPリクエスト/レスポンスをやり取り    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Connection: Keep-Alive                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Request 1 ──► Response 1                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Request 2 ──► Response 2   同じTCP接続を再利用             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Request 3 ──► Response 3                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-resttemplateレガシー">4.2 RestTemplate（レガシー）<a href="#42-resttemplateレガシー" class="hash-link" aria-label="4.2 RestTemplate（レガシー） への直接リンク" title="4.2 RestTemplate（レガシー） への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RestTemplateConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public RestTemplate restTemplate() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // コネクションプール設定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        PoolingHttpClientConnectionManager connectionManager =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new PoolingHttpClientConnectionManager();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connectionManager.setMaxTotal(100);           // 全体の最大接続数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        connectionManager.setDefaultMaxPerRoute(20);  // ホストごとの最大接続数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        CloseableHttpClient httpClient = HttpClients.custom()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .setConnectionManager(connectionManager)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .setKeepAliveStrategy((response, context) -&gt; 30_000)  // Keep-Alive 30秒</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .evictIdleConnections(60, TimeUnit.SECONDS)  // アイドル60秒で削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpComponentsClientHttpRequestFactory factory =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            new HttpComponentsClientHttpRequestFactory(httpClient);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setConnectTimeout(5000);      // 接続タイムアウト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        factory.setReadTimeout(30000);        // 読み取りタイムアウト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new RestTemplate(factory);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-webclient推奨">4.3 WebClient（推奨）<a href="#43-webclient推奨" class="hash-link" aria-label="4.3 WebClient（推奨） への直接リンク" title="4.3 WebClient（推奨） への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class WebClientConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public WebClient webClient() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // コネクションプール設定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConnectionProvider provider = ConnectionProvider.builder(&quot;myPool&quot;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .maxConnections(100)                    // 最大接続数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .maxIdleTime(Duration.ofSeconds(60))    // アイドルタイムアウト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .maxLifeTime(Duration.ofMinutes(5))     // 接続の最大生存時間</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .pendingAcquireTimeout(Duration.ofSeconds(30))  // 取得待ちタイムアウト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .evictInBackground(Duration.ofSeconds(30))      // バックグラウンド削除</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        HttpClient httpClient = HttpClient.create(provider)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .option(ChannelOption.CONNECT_TIMEOUT_MILLIS, 5000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .responseTimeout(Duration.ofSeconds(30));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return WebClient.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .clientConnector(new ReactorClientHttpConnector(httpClient))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="44-okhttp">4.4 OkHttp<a href="#44-okhttp" class="hash-link" aria-label="4.4 OkHttp への直接リンク" title="4.4 OkHttp への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class OkHttpConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public OkHttpClient okHttpClient() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ConnectionPool connectionPool = new ConnectionPool(</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            20,                         // 最大アイドル接続数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            5, TimeUnit.MINUTES         // Keep-Alive時間</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        );</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new OkHttpClient.Builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .connectionPool(connectionPool)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .connectTimeout(5, TimeUnit.SECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .readTimeout(30, TimeUnit.SECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .writeTimeout(30, TimeUnit.SECONDS)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-redis-コネクションプール">5. Redis コネクションプール<a href="#5-redis-コネクションプール" class="hash-link" aria-label="5. Redis コネクションプール への直接リンク" title="5. Redis コネクションプール への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-lettucespring-boot-デフォルト">5.1 Lettuce（Spring Boot デフォルト）<a href="#51-lettucespring-boot-デフォルト" class="hash-link" aria-label="5.1 Lettuce（Spring Boot デフォルト） への直接リンク" title="5.1 Lettuce（Spring Boot デフォルト） への直接リンク">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">redis</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">host</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> localhost</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">port</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">6379</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">lettuce</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">pool</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max-active</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 最大接続数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max-idle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 最大アイドル接続数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">min-idle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic"># 最小アイドル接続数</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">max-wait</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">-</span><span class="token plain">1ms     </span><span class="token comment" style="color:#999988;font-style:italic"># 接続取得タイムアウト（-1は無限）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class RedisConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public LettuceConnectionFactory redisConnectionFactory() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        RedisStandaloneConfiguration config = new RedisStandaloneConfiguration();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config.setHostName(&quot;localhost&quot;);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        config.setPort(6379);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // プール設定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        GenericObjectPoolConfig&lt;Object&gt; poolConfig = new GenericObjectPoolConfig&lt;&gt;();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolConfig.setMaxTotal(20);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolConfig.setMaxIdle(10);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolConfig.setMinIdle(5);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolConfig.setMaxWait(Duration.ofSeconds(10));</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        LettucePoolingClientConfiguration clientConfig =</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            LettucePoolingClientConfiguration.builder()</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .poolConfig(poolConfig)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .commandTimeout(Duration.ofSeconds(5))</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                .build();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new LettuceConnectionFactory(config, clientConfig);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-jedis">5.2 Jedis<a href="#52-jedis" class="hash-link" aria-label="5.2 Jedis への直接リンク" title="5.2 Jedis への直接リンク">​</a></h3>
<div class="language-java codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-java codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">@Configuration</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">public class JedisConfig {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    @Bean</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    public JedisPool jedisPool() {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        JedisPoolConfig poolConfig = new JedisPoolConfig();</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolConfig.setMaxTotal(20);          // 最大接続数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolConfig.setMaxIdle(10);           // 最大アイドル接続数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolConfig.setMinIdle(5);            // 最小アイドル接続数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolConfig.setMaxWait(Duration.ofSeconds(10));  // 取得タイムアウト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        // 接続検証（借用時にPINGを送信）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        poolConfig.setTestOnBorrow(true);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        return new JedisPool(poolConfig, &quot;localhost&quot;, 6379);</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    }</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-トラブルシューティング">6. トラブルシューティング<a href="#6-トラブルシューティング" class="hash-link" aria-label="6. トラブルシューティング への直接リンク" title="6. トラブルシューティング への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-よくある問題">6.1 よくある問題<a href="#61-よくある問題" class="hash-link" aria-label="6.1 よくある問題 への直接リンク" title="6.1 よくある問題 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              コネクションプールのトラブル                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【問題1: Connection pool exhausted】                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  原因:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - プールサイズが小さすぎる                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 接続が返却されていない（リーク）                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - クエリが遅すぎる                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  確認方法（HikariCP）:                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - Active connections が maximum-pool-size に張り付き       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - Pending threads が増加                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  対策:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - leak-detection-threshold を設定                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - スロークエリを特定して修正                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - プールサイズを増やす（根本解決ではない）                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【問題2: Connection leak detected】                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  原因:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - try-with-resources を使っていない                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 例外発生時に接続がクローズされていない                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  悪い例:                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Connection conn = dataSource.getConnection();               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  // 例外が発生すると conn がリークする                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Statement stmt = conn.createStatement();                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ResultSet rs = stmt.executeQuery(&quot;...&quot;);                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  conn.close();  // ← ここに到達しない可能性                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  良い例:                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  try (Connection conn = dataSource.getConnection();          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       Statement stmt = conn.createStatement();               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ResultSet rs = stmt.executeQuery(&quot;...&quot;)) {            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      // 処理                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  }  // ← 自動的にクローズ                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ─────────────────────────────────────────────────────────  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【問題3: Connection is closed / Connection reset】          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  原因:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - DBがアイドル接続を切断した                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - max-lifetime が DB の wait_timeout より長い              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ネットワーク不安定                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  対策:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - max-lifetime &lt; DB wait_timeout に設定                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - connection-test-query を設定（非推奨、JDBC4では不要）    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="62-hikaricp-のモニタリング設定">6.2 HikariCP のモニタリング設定<a href="#62-hikaricp-のモニタリング設定" class="hash-link" aria-label="6.2 HikariCP のモニタリング設定 への直接リンク" title="6.2 HikariCP のモニタリング設定 への直接リンク">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># application.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datasource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hikari</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># リーク検出（開発/テスト環境で有効に）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">leak-detection-threshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60000</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># 60秒以上借用でログ出力</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># メトリクス</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">register-mbeans</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic"># JMX MBean登録</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">logging</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">level</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">com.zaxxer.hikari</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> DEBUG  </span><span class="token comment" style="color:#999988;font-style:italic"># HikariCPのログを詳細に</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="63-メトリクス確認spring-boot-actuator">6.3 メトリクス確認（Spring Boot Actuator）<a href="#63-メトリクス確認spring-boot-actuator" class="hash-link" aria-label="6.3 メトリクス確認（Spring Boot Actuator） への直接リンク" title="6.3 メトリクス確認（Spring Boot Actuator） への直接リンク">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># application.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">management</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">endpoints</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">web</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">exposure</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token key atrule" style="color:#00a4db">include</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> health</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain">metrics</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">endpoint</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">health</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">show-details</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> always</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="language-bash codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-bash codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain"># アクティブ接続数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:8080/actuator/metrics/hikaricp.connections.active</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># アイドル接続数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:8080/actuator/metrics/hikaricp.connections.idle</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 待機スレ  ッド数</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:8080/actuator/metrics/hikaricp.connections.pending</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"># 接続取得時間</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">curl http://localhost:8080/actuator/metrics/hikaricp.connections.acquire</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-ベストプラクティス">7. ベストプラクティス<a href="#7-ベストプラクティス" class="hash-link" aria-label="7. ベストプラクティス への直接リンク" title="7. ベストプラクティス への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="71-設定のチェックリスト">7.1 設定のチェックリスト<a href="#71-設定のチェックリスト" class="hash-link" aria-label="7.1 設定のチェックリスト への直接リンク" title="7.1 設定のチェックリスト への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              コネクションプール設定チェックリスト            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  □ maximum-pool-size は適切か                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - アプリ全台の合計 &lt; DB max_connections                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - HikariCP推奨: (core_count * 2) + spindle_count         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  □ minimum-idle は maximum-pool-size と同じか               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - HikariCP作者の推奨                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 動的サイズ変更のオーバーヘッド回避                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  □ max-lifetime は DB wait_timeout より短いか               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - MySQL: 28800秒 (8時間)                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - PostgreSQL: 無制限（設定が必要）                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 推奨: wait_timeout - 30秒                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  □ connection-timeout は適切か                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - デフォルト 30秒は多くの場合で妥当                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 短すぎると高負荷時にエラー多発                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  □ leak-detection-threshold を設定しているか               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    -  開発/テスト環境では必須                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - 本番でも設定推奨（60秒〜）                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  □ メトリクスを収集しているか                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - Actuator + Prometheus/Grafana                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    - アクティブ接続数、待機数を監視                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└─────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="72-本番環境での設定例">7.2 本番環境での設定例<a href="#72-本番環境での設定例" class="hash-link" aria-label="7.2 本番環境での設定例 への直接リンク" title="7.2 本番環境での設定例 への直接リンク">​</a></h3>
<div class="language-yaml codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-yaml codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic"># production application.yml</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token key atrule" style="color:#00a4db">spring</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token key atrule" style="color:#00a4db">datasource</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">url</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> jdbc</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">postgresql</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">//$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DB_HOST</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain">5432/$</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DB_NAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">username</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DB_USERNAME</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">password</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> $</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">DB_PASSWORD</span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token key atrule" style="color:#00a4db">hikari</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">pool-name</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> ProdPool</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># サイズ（4コアサーバー想定）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">maximum-pool-size</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">minimum-idle</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># タイムアウト</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">connection-timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">30000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">idle-timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">600000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">max-lifetime</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1800000</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 30分（PostgreSQL wait_timeout未設定の場合）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># リーク検出</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">leak-detection-threshold</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">60000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># 検証</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">validation-timeout</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic"># JMX</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      </span><span class="token key atrule" style="color:#00a4db">register-mbeans</span><span class="token punctuation" style="color:#393A34">:</span><span class="token plain"> </span><span class="token boolean important" style="color:#36acaa">true</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="学んだこと">学んだこと<a href="#学んだこと" class="hash-link" aria-label="学んだこと への直接リンク" title="学んだこと への直接リンク">​</a></h3>
<ul>
<li>TCP接続のオーバーヘッドとプーリングによる解決</li>
<li>HikariCPの設定パラメータと適切な値の決め方</li>
<li>PgBouncerによる接続集約</li>
<li>HTTPクライアント、Redisのプール設定</li>
<li>トラブルシューティングの方法</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="重要なポイント">重要なポイント<a href="#重要なポイント" class="hash-link" aria-label="重要なポイント への直接リンク" title="重要なポイント への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">1. プールサイズは大きければ良いわけではない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - DBの max_connections を超えてはいけない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 適切なサイズは (core_count * 2) + spindle_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 接続リークを防ぐ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - try-with-resources を使う</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - leak-detection-threshold を設定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. max-lifetime に注意</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - DBのタイムアウトより短く設定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - そうしないと &quot;Connection is closed&quot; エラー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. メトリクスで監視</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - アクティブ接続数、待機数を監視</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 問題を早期発見</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="次のステップ">次のステップ<a href="#次のステップ" class="hash-link" aria-label="次のステップ への直接リンク" title="次のステップ への直接リンク">​</a></h3>
<ul>
<li><a href="/idp-server/docs/content_11_learning/networking/tcp-fundamentals">09-tcp-fundamentals.md</a> - TCP基礎（TIME_WAIT等）</li>
<li><a href="/idp-server/docs/content_11_learning/networking/web-server-architecture">10-web-server-architecture.md</a> - Webサーバーアーキテクチャ</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="参考リンク">参考リンク<a href="#参考リンク" class="hash-link" aria-label="参考リンク への直接リンク" title="参考リンク への直接リンク">​</a></h3>
<ul>
<li><a href="https://github.com/brettwooldridge/HikariCP" target="_blank" rel="noopener noreferrer">HikariCP GitHub</a></li>
<li><a href="https://github.com/brettwooldridge/HikariCP/wiki/About-Pool-Sizing" target="_blank" rel="noopener noreferrer">About Pool Sizing (HikariCP Wiki)</a></li>
<li><a href="https://www.pgbouncer.org/config.html" target="_blank" rel="noopener noreferrer">PgBouncer Documentation</a></li>
<li><a href="https://docs.spring.io/spring-boot/docs/current/reference/html/data.html#data.sql.datasource.connection-pool" target="_blank" rel="noopener noreferrer">Spring Boot - Connection Pooling</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_11_learning/15-networking/11-connection-pooling.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_11_learning/networking/web-server-architecture"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">Webサーバーアーキテクチャ</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_11_learning/networking/api-gateway-networking"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">リバースプロキシとAPI Gateway</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#所要時間" class="table-of-contents__link toc-highlight">所要時間</a></li><li><a href="#学べること" class="table-of-contents__link toc-highlight">学べること</a></li><li><a href="#前提知識" class="table-of-contents__link toc-highlight">前提知識</a></li><li><a href="#1-なぜコネクションプーリングが必要か" class="table-of-contents__link toc-highlight">1. なぜコネクションプーリングが必要か</a><ul><li><a href="#11-接続のコスト" class="table-of-contents__link toc-highlight">1.1 接続のコスト</a></li><li><a href="#12-プールなしの問題" class="table-of-contents__link toc-highlight">1.2 プールなしの問題</a></li><li><a href="#13-プールありの動作" class="table-of-contents__link toc-highlight">1.3 プールありの動作</a></li></ul></li><li><a href="#2-データベース接続プールhikaricp" class="table-of-contents__link toc-highlight">2. データベース接続プール（HikariCP）</a><ul><li><a href="#21-hikaricp-の基本" class="table-of-contents__link toc-highlight">2.1 HikariCP の基本</a></li><li><a href="#22-hikaricp-設定spring-boot" class="table-of-contents__link toc-highlight">2.2 HikariCP 設定（Spring Boot）</a></li><li><a href="#23-各設定の意味" class="table-of-contents__link toc-highlight">2.3 各設定の意味</a></li><li><a href="#24-適切なプールサイズの決め方" class="table-of-contents__link toc-highlight">2.4 適切なプールサイズの決め方</a></li></ul></li><li><a href="#3-コネクションプロキシpgbouncer" class="table-of-contents__link toc-highlight">3. コネクションプロキシ（PgBouncer）</a><ul><li><a href="#31-なぜ必要か" class="table-of-contents__link toc-highlight">3.1 なぜ必要か</a></li><li><a href="#32-プーリングモード" class="table-of-contents__link toc-highlight">3.2 プーリングモード</a></li><li><a href="#33-設定例" class="table-of-contents__link toc-highlight">3.3 設定例</a></li></ul></li><li><a href="#4-httpクライアントのコネクションプール" class="table-of-contents__link toc-highlight">4. HTTPクライアントのコネクションプール</a><ul><li><a href="#41-なぜhttpでもプールが必要か" class="table-of-contents__link toc-highlight">4.1 なぜHTTPでもプールが必要か</a></li><li><a href="#42-resttemplateレガシー" class="table-of-contents__link toc-highlight">4.2 RestTemplate（レガシー）</a></li><li><a href="#43-webclient推奨" class="table-of-contents__link toc-highlight">4.3 WebClient（推奨）</a></li><li><a href="#44-okhttp" class="table-of-contents__link toc-highlight">4.4 OkHttp</a></li></ul></li><li><a href="#5-redis-コネクションプール" class="table-of-contents__link toc-highlight">5. Redis コネクションプール</a><ul><li><a href="#51-lettucespring-boot-デフォルト" class="table-of-contents__link toc-highlight">5.1 Lettuce（Spring Boot デフォルト）</a></li><li><a href="#52-jedis" class="table-of-contents__link toc-highlight">5.2 Jedis</a></li></ul></li><li><a href="#6-トラブルシューティング" class="table-of-contents__link toc-highlight">6. トラブルシューティング</a><ul><li><a href="#61-よくある問題" class="table-of-contents__link toc-highlight">6.1 よくある問題</a></li><li><a href="#62-hikaricp-のモニタリング設定" class="table-of-contents__link toc-highlight">6.2 HikariCP のモニタリング設定</a></li><li><a href="#63-メトリクス確認spring-boot-actuator" class="table-of-contents__link toc-highlight">6.3 メトリクス確認（Spring Boot Actuator）</a></li></ul></li><li><a href="#7-ベストプラクティス" class="table-of-contents__link toc-highlight">7. ベストプラクティス</a><ul><li><a href="#71-設定のチェックリスト" class="table-of-contents__link toc-highlight">7.1 設定のチェックリスト</a></li><li><a href="#72-本番環境での設定例" class="table-of-contents__link toc-highlight">7.2 本番環境での設定例</a></li></ul></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a><ul><li><a href="#学んだこと" class="table-of-contents__link toc-highlight">学んだこと</a></li><li><a href="#重要なポイント" class="table-of-contents__link toc-highlight">重要なポイント</a></li><li><a href="#次のステップ" class="table-of-contents__link toc-highlight">次のステップ</a></li><li><a href="#参考リンク" class="table-of-contents__link toc-highlight">参考リンク</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>