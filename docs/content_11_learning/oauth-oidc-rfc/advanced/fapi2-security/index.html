<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_11_learning/oauth-oidc-rfc/advanced/fapi2-security" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">FAPI 2.0 Security Profile | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/fapi2-security"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="FAPI 2.0 Security Profile | IdP-Server Documentation"><meta data-rh="true" name="description" content="FAPI 2.0 Security Profile は、FAPI 1.0 の経験を活かして再設計された次世代のセキュリティプロファイルです。"><meta data-rh="true" property="og:description" content="FAPI 2.0 Security Profile は、FAPI 1.0 の経験を活かして再設計された次世代のセキュリティプロファイルです。"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/fapi2-security"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/fapi2-security" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/fapi2-security" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.2a8c149f.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.e8b245c1.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">ドキュメントガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_03_concepts/foundation/concept-01-multi-tenant">コア概念</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認証・認可プロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_05_how-to/">How-to（設定・運用レシピ）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_06_developer-guide/">開発者ガイド</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_11_learning/identity-basics/identity-management-basics">学習（Learning）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/identity-basics/identity-management-basics">アイデンティティ管理の基礎</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-fundamentals/modern-web-authz-authn">OAuth 2.0の基礎</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-tokens/id-token-jwt">OAuth 2.0トークン</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/openid-connect/oauth-oidc-basics">OpenID Connect</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/fido-webauthn/fido2-architecture-rp-browser-authenticator">FIDO2/WebAuthn</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/security/glossary">セキュリティ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/multi-tenancy/multi-tenancy-basics">マルチテナント</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/advanced-protocols/ciba-basics">高度なプロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/http-rest/http-basics">HTTP/REST</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/jwt-jose/jwt-introduction">JWT/JOSE</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/">OAuth/OIDC RFC学習</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/">OAuth 2.0 / OpenID Connect RFC 学習ガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/core/rfc6749-oauth2-core">基礎（OAuth 2.0 Core）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/jose/rfc7515-jws">JWT/JOSE（署名・暗号化）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/client-auth/rfc7521-assertion-framework">クライアント認証</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/extensions/rfc7009-revocation">OAuth 2.0 拡張</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/oidc/back-channel-logout">OpenID Connect</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/security/attack-patterns">セキュリティ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/fapi1-advanced">高度なプロトコル</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/fapi1-advanced">FAPI 1.0 Advanced Profile</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/fapi1-baseline">FAPI 1.0 Baseline Profile</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/fapi2-security">FAPI 2.0 Security Profile</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/grant-management">OAuth 2.0 Grant Management</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/oidc-ciba">OpenID Connect CIBA（Client-Initiated Backchannel Authentication）</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced-identity/oid4vci">Advanced Identity</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/verifiable-credentials/">Verifiable Credentials</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/data-formats/">データフォーマット</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/session-management/web-session-basics">セッション管理</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/">PostgreSQL</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/crypto/">暗号化</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/kubernetes/">コンテナ/Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/linux/">Linux</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/networking/">ネットワーク</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/jvm/">JVM</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">学習（Learning）</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">OAuth/OIDC RFC学習</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">高度なプロトコル</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">FAPI 2.0 Security Profile</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>FAPI 2.0 Security Profile</h1></header>
<p>FAPI 2.0 Security Profile は、FAPI 1.0 の経験を活かして再設計された次世代のセキュリティプロファイルです。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="目次">目次<a href="#目次" class="hash-link" aria-label="目次 への直接リンク" title="目次 への直接リンク">​</a></h2>
<ol>
<li><a href="#%E7%AC%AC1%E9%83%A8-%E6%A6%82%E8%A6%81%E7%B7%A8">第1部: 概要編</a></li>
<li><a href="#%E7%AC%AC2%E9%83%A8-%E8%A9%B3%E7%B4%B0%E7%B7%A8">第2部: 詳細編</a></li>
<li><a href="#%E7%AC%AC3%E9%83%A8-%E3%82%BB%E3%82%AD%E3%83%A5%E3%83%AA%E3%83%86%E3%82%A3">第3部: セキュリティ</a></li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="第1部-概要編">第1部: 概要編<a href="#第1部-概要編" class="hash-link" aria-label="第1部: 概要編 への直接リンク" title="第1部: 概要編 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fapi-20-とは">FAPI 2.0 とは？<a href="#fapi-20-とは" class="hash-link" aria-label="FAPI 2.0 とは？ への直接リンク" title="FAPI 2.0 とは？ への直接リンク">​</a></h3>
<p>FAPI 2.0 は、FAPI 1.0 を簡素化しつつ、より強力なセキュリティを提供する新しいプロファイルです。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FAPI 2.0 の特徴:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. 簡素化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Hybrid Flow 廃止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 認可コードフローのみ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 複雑なオプションを削減</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 強化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - PAR 必須</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Sender-Constrained Tokens 必須</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - JARM または iss パラメータ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 新機能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - RFC 9396 RAR サポート</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Grant Management サポート</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - DPoP サポート</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="なぜ-fapi-20-が必要なのか">なぜ FAPI 2.0 が必要なのか？<a href="#なぜ-fapi-20-が必要なのか" class="hash-link" aria-label="なぜ FAPI 2.0 が必要なのか？ への直接リンク" title="なぜ FAPI 2.0 が必要なのか？ への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="背景と歴史">背景と歴史<a href="#背景と歴史" class="hash-link" aria-label="背景と歴史 への直接リンク" title="背景と歴史 への直接リンク">​</a></h4>
<p>FAPI 1.0 は2017-2019年に策定され、世界中のオープンバンキングで採用されました。しかし、実装者から以下の課題が指摘されました：</p>
<table><thead><tr><th>FAPI 1.0 の課題</th><th>FAPI 2.0 の改善</th></tr></thead><tbody><tr><td>Hybrid Flow が複雑</td><td>認可コードフローのみに統一</td></tr><tr><td>Request Object の扱いが分かりにくい</td><td>PAR で統一、シンプル化</td></tr><tr><td>mTLS の導入障壁が高い</td><td>DPoP を代替手段として追加</td></tr><tr><td>細かい仕様の曖昧さ</td><td>明確化、実装しやすく</td></tr></tbody></table>
<p>FAPI 2.0 は 2021年から策定が始まり、2023年に Draft 仕様として公開されました。FAPI 1.0 との互換性はありませんが、<strong>より実装しやすく、より安全</strong>な設計となっています。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="脅威モデル">脅威モデル<a href="#脅威モデル" class="hash-link" aria-label="脅威モデル への直接リンク" title="脅威モデル への直接リンク">​</a></h4>
<p>FAPI 2.0 が対処する主な脅威：</p>
<ol>
<li>
<p><strong>認可リクエスト改ざん攻撃</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">攻撃シナリオ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. 攻撃者がブラウザのURLパラメータを改ざん</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /authorize?amount=100 → /authorize?amount=10000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. ユーザーが改ざんされた内容で認可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 攻撃者が不正な金額で取引実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">対策: PAR (Pushed Authorization Requests)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- すべてのパラメータをバックチャネルで送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ブラウザに機密情報が渡らない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- AS側でパラメータを保護</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><strong>トークン盗難攻撃</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">攻撃シナリオ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. 攻撃者がアクセストークンを盗難</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   (ネットワーク盗聴、マルウェア等)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 攻撃者が盗んだトークンでAPIにアクセス</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 成功（Bearer トークンは誰でも使用可能）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">対策: DPoP または mTLS</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- トークンを公開鍵/証明書にバインド</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 盗んだトークンだけでは使用不可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 秘密鍵/証明書も必要</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><strong>認可レスポンス改ざん攻撃</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">攻撃シナリオ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. 攻撃者が認可レスポンスのcodeを差し替え</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. クライアントが攻撃者のcodeでトークン取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 攻撃者のアカウントにアクセス</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">対策: JARM または iss パラメータ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- レスポンスの完全性を保証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 改ざんを検出可能</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
<li>
<p><strong>フィッシング攻撃</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">攻撃シナリオ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. 攻撃者が偽の認可サーバーを用意</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. ユーザーを誘導して認証情報を盗む</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 攻撃者がユーザーのアカウントにアクセス</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">対策:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- クライアント認証の強化（private_key_jwt）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- issパラメータでASを検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- PKCEでコード傍受を防止</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fapi-10-vs-fapi-20">FAPI 1.0 vs FAPI 2.0<a href="#fapi-10-vs-fapi-20" class="hash-link" aria-label="FAPI 1.0 vs FAPI 2.0 への直接リンク" title="FAPI 1.0 vs FAPI 2.0 への直接リンク">​</a></h3>
<table><thead><tr><th>項目</th><th>FAPI 1.0 Advanced</th><th>FAPI 2.0</th></tr></thead><tbody><tr><td><strong>レスポンスタイプ</strong></td><td>code, code id_token</td><td>code のみ</td></tr><tr><td><strong>PAR</strong></td><td>推奨</td><td>必須</td></tr><tr><td><strong>Request Object</strong></td><td>必須（JWT）</td><td>PAR で送信（JWTまたは平文）</td></tr><tr><td><strong>レスポンス保護</strong></td><td>JARM または Hybrid</td><td>JARM または iss パラメータ</td></tr><tr><td><strong>トークンバインディング</strong></td><td>mTLS のみ</td><td>mTLS または DPoP</td></tr><tr><td><strong>クライアント認証</strong></td><td>private_key_jwt/mTLS 必須</td><td>private_key_jwt/mTLS/DPoP 必須</td></tr><tr><td><strong>Grant Management</strong></td><td>なし</td><td>標準サポート</td></tr><tr><td><strong>RAR</strong></td><td>非標準</td><td>RFC 9396 サポート</td></tr><tr><td><strong>複雑度</strong></td><td>高</td><td>中（簡素化）</td></tr><tr><td><strong>モバイル対応</strong></td><td>mTLS困難</td><td>DPoPで容易</td></tr></tbody></table>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="実際のユースケース">実際のユースケース<a href="#実際のユースケース" class="hash-link" aria-label="実際のユースケース への直接リンク" title="実際のユースケース への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ユースケース1-オープンバンキング決済fapi-20">ユースケース1: オープンバンキング決済（FAPI 2.0）<a href="#ユースケース1-オープンバンキング決済fapi-20" class="hash-link" aria-label="ユースケース1: オープンバンキング決済（FAPI 2.0） への直接リンク" title="ユースケース1: オープンバンキング決済（FAPI 2.0） への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">シナリオ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - ユーザーがECサイトで決済</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - ECサイトが銀行APIで送金を実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 金額: 50,000円</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAPI 2.0 の利点:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1. PAR必須</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 認可リクエストをバックチャネルで送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - ブラウザに機密情報が渡らない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 金額等のパラメータが改ざん不可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. DPoP</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - mTLSよりも実装が容易</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - モバイルアプリでも使用可能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - PKIインフラ不要</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3. RAR (Rich Authorization Requests)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 決済の詳細情報を構造化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - スコープより柔軟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 金額、送金先、目的を明示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4. Grant Management</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - ユーザーが認可を管理可能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - GDPR対応が容易</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 取り消しが簡単</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ユースケース2-モバイル決済アプリ">ユースケース2: モバイル決済アプリ<a href="#ユースケース2-モバイル決済アプリ" class="hash-link" aria-label="ユースケース2: モバイル決済アプリ への直接リンク" title="ユースケース2: モバイル決済アプリ への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">シナリオ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - モバイルアプリで決済</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 証明書管理が困難</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">FAPI 2.0 の DPoP が最適:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1. PKIインフラ不要</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 証明書の発行・管理が不要</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - アプリ内で鍵ペアを生成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. 実装が容易</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 標準的な暗号ライブラリで実装可能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - mTLSより簡単</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3. セキュリティ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - トークンバインディング</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - リプレイ攻撃防止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - トークン盗難対策</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">従来のFAPI 1.0（mTLS）との比較:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - FAPI 1.0: 証明書管理が困難、モバイルに不向き</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - FAPI 2.0: DPoPで簡単、モバイル最適</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="ユースケース3-段階的な認可grant-management">ユースケース3: 段階的な認可（Grant Management）<a href="#ユースケース3-段階的な認可grant-management" class="hash-link" aria-label="ユースケース3: 段階的な認可（Grant Management） への直接リンク" title="ユースケース3: 段階的な認可（Grant Management） への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">シナリオ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 家計簿アプリの利用</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 最初は残高照会のみ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 後日、決済機能を追加</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">フロー:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1. 初回: scope=openid accounts:read</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     → Grant A 作成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. 決済機能追加時:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - grant_id=A を指定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - grant_management_action=merge</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - scope=openid accounts:read payments:write</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3. AS: 追加の同意のみ求める</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 既存のscopeは再同意不要</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 新しいscopeのみ同意</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  4. Grant A 更新</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - scope=openid accounts:read payments:write</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">メリット:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - ユーザー体験の向上（最小限の同意）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - セキュリティ（最小権限の原則）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 管理が容易（Grantの一覧・取り消し）</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="fapi-20-の規制対応">FAPI 2.0 の規制対応<a href="#fapi-20-の規制対応" class="hash-link" aria-label="FAPI 2.0 の規制対応 への直接リンク" title="FAPI 2.0 の規制対応 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="世界各国の動向">世界各国の動向<a href="#世界各国の動向" class="hash-link" aria-label="世界各国の動向 への直接リンク" title="世界各国の動向 への直接リンク">​</a></h4>
<table><thead><tr><th>地域/国</th><th>規制名</th><th>FAPI 2.0 採用</th><th>状況</th></tr></thead><tbody><tr><td><strong>英国</strong></td><td>Open Banking</td><td>検討中</td><td>FAPI 1.0から移行検討</td></tr><tr><td><strong>EU</strong></td><td>PSD2/PSD3</td><td>検討中</td><td>次期バージョンで採用の可能性</td></tr><tr><td><strong>ブラジル</strong></td><td>Open Banking Brasil</td><td>検討中</td><td>FAPI 2.0へのアップグレード計画</td></tr><tr><td><strong>オーストラリア</strong></td><td>CDR</td><td>検討中</td><td>将来的な採用を検討</td></tr><tr><td><strong>サウジアラビア</strong></td><td>Open Banking</td><td>✅</td><td>FAPI 2.0を採用予定</td></tr></tbody></table>
<p>FAPI 2.0 は新しい規格のため、まだ広く規制では採用されていませんが、今後の採用が期待されています。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="第2部-詳細編">第2部: 詳細編<a href="#第2部-詳細編" class="hash-link" aria-label="第2部: 詳細編 への直接リンク" title="第2部: 詳細編 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="par-pushed-authorization-requests">PAR (Pushed Authorization Requests)<a href="#par-pushed-authorization-requests" class="hash-link" aria-label="PAR (Pushed Authorization Requests) への直接リンク" title="PAR (Pushed Authorization Requests) への直接リンク">​</a></h3>
<p>FAPI 2.0 では、PAR が必須です。すべての認可リクエストは PAR 経由で行います。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="par-のフロー">PAR のフロー<a href="#par-のフロー" class="hash-link" aria-label="PAR のフロー への直接リンク" title="PAR のフロー への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PAR のフロー:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  ┌────────┐                      ┌────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │ Client │                      │   AS   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  └───┬────┘                      └───┬────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │  1. POST /par                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │     (認可パラメータ)          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├──────────────────────────────►│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │                               │ 検証・保存</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │  2. request_uri               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ◄──────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │     expires_in=90             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │  3. GET /authorize            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │     ?request_uri=urn:...      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ├──────────────────────────────►│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │                               │ ユーザー認証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │  4. code + state + iss        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      ◄──────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      │                               │</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="par-リクエストの詳細">PAR リクエストの詳細<a href="#par-リクエストの詳細" class="hash-link" aria-label="PAR リクエストの詳細 への直接リンク" title="PAR リクエストの詳細 への直接リンク">​</a></h4>
<div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /par HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: auth.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/x-www-form-urlencoded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Authorization: Basic czZCaGRSa3F0MzpnWDFmQmF0M2JW</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">response_type=code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;client_id=s6BhdRkqt3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;redirect_uri=https://client.example.com/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;scope=openid accounts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;state=af0ifjsldkj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;nonce=n-0S6_WzA2Mj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;code_challenge_method=S256</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;client_assertion=eyJhbGciOiJQUzI1NiIs...</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードを コピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>パラメータの詳細：</p>
<table><thead><tr><th>パラメータ</th><th>必須</th><th>説明</th><th>推奨値</th></tr></thead><tbody><tr><td><code>response_type</code></td><td>✅</td><td><code>code</code> 固定</td><td><code>code</code></td></tr><tr><td><code>client_id</code></td><td>✅</td><td>クライアント ID</td><td>登録されたID</td></tr><tr><td><code>redirect_uri</code></td><td>✅</td><td>リダイレクト URI</td><td>HTTPS URI（完全一致）</td></tr><tr><td><code>scope</code></td><td>✅</td><td>スコープ（openid 必須）</td><td><code>openid profile email</code></td></tr><tr><td><code>state</code></td><td>✅</td><td>CSRF 対策</td><td>128ビット以上のランダム値</td></tr><tr><td><code>nonce</code></td><td>✅</td><td>リプレイ防止</td><td>128ビット以上のランダム値</td></tr><tr><td><code>code_challenge</code></td><td>✅</td><td>PKCE</td><td>SHA256(code_verifier) の Base64URL</td></tr><tr><td><code>code_challenge_method</code></td><td>✅</td><td>PKCE メソッド</td><td><code>S256</code> 固定</td></tr><tr><td><code>client_assertion_type</code></td><td>✅</td><td>クライアント認証タイプ</td><td><code>urn:ietf:params:oauth:client-assertion-type:jwt-bearer</code></td></tr><tr><td><code>client_assertion</code></td><td>✅</td><td>クライアント認証JWT</td><td>private_key_jwt</td></tr><tr><td><code>authorization_details</code></td><td>△</td><td>RAR（Rich Authorization Requests）</td><td>JSON配列</td></tr><tr><td><code>acr_values</code></td><td>△</td><td>認証レベル</td><td><code>urn:example:acr:loa2</code></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="par-レスポンス">PAR レスポンス<a href="#par-レスポンス" class="hash-link" aria-label="PAR レスポンス への直接リンク" title="PAR レスポンス への直接リンク">​</a></h4>
<p>成功レスポンス:</p>
<div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 201 Created</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Cache-Control: no-store</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;request_uri&quot;: &quot;urn:ietf:params:oauth:request_uri:6esc_11ACC5bwc014ltc14eY22c&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;expires_in&quot;: 90</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>エラーレスポンス:</p>
<div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">HTTP/1.1 400 Bad Request</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;error&quot;: &quot;invalid_request&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  &quot;error_description&quot;: &quot;The code_challenge parameter is missing&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>主なエラーコード：</p>
<table><thead><tr><th>エラー</th><th>HTTP ステータス</th><th>説明</th><th>対処法</th></tr></thead><tbody><tr><td><code>invalid_request</code></td><td>400</td><td>リクエストパラメータが不正</td><td>パラメータを確認</td></tr><tr><td><code>invalid_client</code></td><td>401</td><td>クライアント認証が失敗</td><td>client_assertion を確認</td></tr><tr><td><code>invalid_scope</code></td><td>400</td><td>スコープが不正</td><td>サポートされるスコープを確認</td></tr><tr><td><code>unauthorized_client</code></td><td>400</td><td>クライアントが認可されていない</td><td>クライアント登録を確認</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="par-の利点">PAR の利点<a href="#par-の利点" class="hash-link" aria-label="PAR の利点 への直接リンク" title="PAR の利点 への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">PAR のメリット:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. セキュリティ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - ブラウザに機密情報が渡らない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - パラメータの改ざん防止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - リプレイ攻撃防止（短い有効期限）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. プライバシー</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 認可の詳細がブラウザ履歴に残らない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - URLパラメータが短くなる</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 互換性</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - URL長さ制限の問題を解決</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 大きなauthorization_detailsも送信可能</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 実装の簡素化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - Request Objectが不要（FAPI 1.0 Advancedと比較）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - クライアント認証を事前に実施</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="dpop-demonstrating-proof-of-possession">DPoP (Demonstrating Proof-of-Possession)<a href="#dpop-demonstrating-proof-of-possession" class="hash-link" aria-label="DPoP (Demonstrating Proof-of-Possession) への直接リンク" title="DPoP (Demonstrating Proof-of-Possession) への直接リンク">​</a></h3>
<p>FAPI 2.0 では、mTLS に加えて DPoP がサポートされます。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dpop-とは">DPoP とは？<a href="#dpop-とは" class="hash-link" aria-label="DPoP とは？ への直接リンク" title="DPoP とは？ への直接リンク">​</a></h4>
<p>DPoP は、アクセストークンを公開鍵にバインドする仕組みです。mTLS と異なり、PKI インフラが不要で、モバイルアプリでも使用できます。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">DPoP の仕組み:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. クライアントが鍵ペアを生成</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 秘密鍵: クライアントが保持（EC P-256推奨）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 公開鍵: JWK 形式</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. トークンリクエスト時に DPoP Proof を送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - DPoP ヘッダー: JWT（秘密鍵で署名）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - JWT に公開鍵を含める</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. AS がアクセストークンを発行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - cnf.jkt: 公開鍵のハッシュ（SHA-256）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. API アクセス時に DPoP Proof を送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 同じ秘密鍵で署名</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - athクレームにトークンのハッシュを含める</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. API が検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - DPoP Proof の署名を検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - cnf.jkt と一致するか確認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - athがトークンのハッシュと一致するか確認</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dpop-proof-の構造">DPoP Proof の構造<a href="#dpop-proof-の構造" class="hash-link" aria-label="DPoP Proof の構造 への直接リンク" title="DPoP Proof の構造 への直接リンク">​</a></h4>
<p>ヘッダー:</p>
<p>ペイロード（トークンリクエスト時）:</p>
<p>ペイロード（API アクセス時）:</p>
<p>クレームの詳細：</p>
<table><thead><tr><th>クレーム</th><th>必須</th><th>説明</th><th>生成方法</th></tr></thead><tbody><tr><td><code>jti</code></td><td>✅</td><td>JWT ID（リプレイ防止）</td><td>UUID v4 等のランダム値</td></tr><tr><td><code>htm</code></td><td>✅</td><td>HTTP メソッド（POST, GET等）</td><td>リクエストのメソッド</td></tr><tr><td><code>htu</code></td><td>✅</td><td>HTTP URI（エンドポイント URL）</td><td>リクエストのURL（クエリ・フラグメント除く）</td></tr><tr><td><code>iat</code></td><td>✅</td><td>発行時刻（UNIX タイムスタンプ）</td><td>現在時刻</td></tr><tr><td><code>ath</code></td><td>△</td><td>アクセストークンのハッシュ（API アクセス時のみ）</td><td>SHA-256(access_token) の Base64URL</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dpop-の実装例">DPoP の実装例<a href="#dpop-の実装例" class="hash-link" aria-label="DPoP の実装例 への直接リンク" title="DPoP の実装例 への直接リンク">​</a></h4>
<p>鍵ペアの生成:</p>
<p>DPoP を使ったトークンリクエスト:</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dpop-バインドされたアクセストークン">DPoP バインドされたアクセストークン<a href="#dpop-バインドされたアクセストークン" class="hash-link" aria-label="DPoP バインドされたアクセストークン への直接リンク" title="DPoP バインドされたアクセストークン への直接リンク">​</a></h4>
<p>ASが発行するアクセストークン（JWT形式の例）:</p>
<p><code>cnf.jkt</code> の計算:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="iss-パラメータrfc-9207">iss パラメータ（RFC 9207）<a href="#iss-パラメータrfc-9207" class="hash-link" aria-label="iss パラメータ（RFC 9207） への直接リンク" title="iss パラメータ（RFC 9207） への直接リンク">​</a></h3>
<p>FAPI 2.0 では、JARM の代わりに iss パラメータを使用できます。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">iss パラメータの目的:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - Mix-Up攻撃の防止</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 複数ASに対応するクライアントの保護</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - JARMより実装が簡単</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">認可レスポンス:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  GET /callback?</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    code=SplxlOBeZQQYbYS6WxSbIA</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;state=af0ifjsldkj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &amp;iss=https://auth.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">クライアントの検証:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  1. state を検証（CSRF防止）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  2. iss を検証（Mix-Up防止）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 期待するASのissと一致するか</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">     - 複数AS対応時は、どのASからのレスポンスか確認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  3. トークンリクエストを送信</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>Mix-Up攻撃のシナリオと対策:</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Mix-Up攻撃シナリオ（issパラメータなし）:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. クライアントが2つのAS（AS1, AS2）に対応</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. ユーザーがAS1を選択</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 攻撃者が悪意あるAS2を用意</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 認可レスポンスで攻撃者がAS2のcodeに差し替え</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. クライアントがAS2のcodeをAS1に送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → AS1がエラーを返すが、攻撃者が情報を取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">対策（issパラメータあり）:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. クライアントがAS1を選択</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. AS1が認可レスポンスに iss=https://as1.example.com を含める</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. クライアントがissを検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 期待値: https://as1.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 実際の値: https://as1.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 一致 → 検証成功</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. トークンリクエストをAS1に送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">攻撃を試みた場合:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 攻撃者がiss=https://as2.example.comに差し替え</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. クライアントがissを検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 期待値: https://as1.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 実際の値: https://as2.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 不一致 → 検証失敗、攻撃検出</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>実装例:</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="rich-authorization-requests-rar">Rich Authorization Requests (RAR)<a href="#rich-authorization-requests-rar" class="hash-link" aria-label="Rich Authorization Requests (RAR) への直接リンク" title="Rich Authorization Requests (RAR) への直接リンク">​</a></h3>
<p>RFC 9396 RAR は、スコープよりも柔軟な認可を実現します。</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="なぜ-rar-が必要か">なぜ RAR が必要か？<a href="#なぜ-rar-が必要か" class="hash-link" aria-label="なぜ RAR が必要か？ への直接リンク" title="なぜ RAR が必要か？ への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">スコープの限界:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">従来のスコープ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  scope=payments</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">問題点:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 金額が指定できない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 送金先が指定できない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 詳細な条件が指定できない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 複雑な認可要求を表現できない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RAR:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  authorization_details=[{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;type&quot;: &quot;payment_initiation&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;instructedAmount&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;amount&quot;: &quot;100.00&quot;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;currency&quot;: &quot;EUR&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;creditorAccount&quot;: {</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">      &quot;iban&quot;: &quot;DE89370400440532013000&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    },</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    &quot;remittanceInformationUnstructured&quot;: &quot;Payment for invoice 12345&quot;</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  }]</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">メリット:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 取引の詳細を構造化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - スコープより柔軟</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - 拡張性が高い</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - ユーザーに明確な情報を提示</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  - API側で詳細な検証が可能</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rar-の構造">RAR の構造<a href="#rar-の構造" class="hash-link" aria-label="RAR の構造 への直接リンク" title="RAR の構造 への直接リンク">​</a></h4>
<p>決済の例:</p>
<p>複数の認可要求:</p>
<p>フィールドの詳細：</p>
<table><thead><tr><th>フィールド</th><th>必須</th><th>説明</th><th>例</th></tr></thead><tbody><tr><td><code>type</code></td><td>✅</td><td>認可の種類</td><td><code>payment_initiation</code>, <code>account_information</code></td></tr><tr><td><code>actions</code></td><td>△</td><td>許可する操作</td><td><code>[&quot;read&quot;, &quot;write&quot;]</code></td></tr><tr><td><code>locations</code></td><td>△</td><td>アクセス先のURL</td><td><code>[&quot;https://api.example.com/accounts&quot;]</code></td></tr><tr><td><code>instructedAmount</code></td><td>△</td><td>金額（決済の場合）</td><td><code>{&quot;amount&quot;: &quot;100.00&quot;, &quot;currency&quot;: &quot;EUR&quot;}</code></td></tr><tr><td><code>creditorAccount</code></td><td>△</td><td>送金先口座</td><td><code>{&quot;iban&quot;: &quot;DE89...&quot;}</code></td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="rar-の使用例">RAR の使用例<a href="#rar-の使用例" class="hash-link" aria-label="RAR の使用例 への直接リンク" title="RAR の使用例 への直接リンク">​</a></h4>
<p>PARリクエストにRARを含める:</p>
<div class="language-http codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-http codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">POST /par HTTP/1.1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Host: auth.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Content-Type: application/x-www-form-urlencoded</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">response_type=code</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;client_id=s6BhdRkqt3</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;redirect_uri=https://client.example.com/callback</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;scope=openid</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;state=af0ifjsldkj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;nonce=n-0S6_WzA2Mj</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;authorization_details=%5B%7B%22type%22%3A%22payment_initiation%22%2C%22instructedAmount%22%3A%7B%22amount%22%3A%22100.00%22%2C%22currency%22%3A%22EUR%22%7D%2C%22creditorAccount%22%3A%7B%22iban%22%3A%22DE89370400440532013000%22%7D%7D%5D</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;code_challenge=E9Melhoa2OwvFrEMTJguCHaoeK1t8URWbuGJSstw-cM</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">&amp;code_challenge_method=S256</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>URLデコード後の <code>authorization_details</code>:</p>
<p>トークンレスポンスでRARを返す:</p>
<p>アクセストークンにRARを含める（JWT形式）:</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="第3部-セキュリティ">第3部: セキュリティ<a href="#第3部-  セキュリティ" class="hash-link" aria-label="第3部: セキュリティ への直接リンク" title="第3部: セキュリティ への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="脅威モデルと攻撃シナリオ">脅威モデルと攻撃シナリオ<a href="#脅威モデルと攻撃シナリオ" class="hash-link" aria-label="脅威モデルと攻撃シナリオ への直接リンク" title="脅威モデルと攻撃シナリオ への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-par-の必須化">1. PAR の必須化<a href="#1-par-の必須化" class="hash-link" aria-label="1. PAR の必須化 への直接リンク" title="1. PAR の必須化 への直接リンク">​</a></h4>
<p><strong>なぜ必要か？</strong></p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">攻撃シナリオ（PAR なし）:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. クライアントが認可リクエストをブラウザ経由で送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /authorize?amount=100&amp;...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. 攻撃者がブラウザのURLを改ざん</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /authorize?amount=10000&amp;...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. ユーザーが改ざんされた内容で認可</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 攻撃者が不正  な金額で取引実行</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">対策（PAR あり）:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. クライアントがPARでパラメータを送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   POST /par (amount=100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. AS が request_uri を返す</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. ブラウザには request_uri のみ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   /authorize?request_uri=urn:...</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. 攻撃者が改ざんできない</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">5. 攻撃失敗</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>実装のポイント:</p>
<ul>
<li>すべての認可リクエストをPAR経由にする</li>
<li>request_uriの有効期限を短く（90秒）</li>
<li>request_uriは一度のみ使用可能</li>
<li>クライアント認証を必須にする</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-dpop-vs-mtls">2. DPoP vs mTLS<a href="#2-dpop-vs-mtls" class="hash-link" aria-label="2. DPoP vs mTLS への直接リンク" title="2. DPoP vs mTLS への直接リンク">​</a></h4>
<table><thead><tr><th>項目</th><th>DPoP</th><th>mTLS</th></tr></thead><tbody><tr><td>実装難易度</td><td>低（標準的な暗号ライブラリ）</td><td>高（PKI、証明書管理）</td></tr><tr><td>モバイル対応</td><td>可（アプリ内で鍵生成）</td><td>困難（証明書の配布・管理）</td></tr><tr><td>セキュリティ</td><td>高（トークンバインディング）</td><td>非常に高（証明書ベース）</td></tr><tr><td>インフラ要件</td><td>なし</td><td>PKI必要</td></tr><tr><td>推奨用途</td><td>モバイル、一般的な用途</td><td>エンタープライズ、超高セキュリティ</td></tr><tr><td>コスト</td><td>低</td><td>高（証明書発行コスト）</td></tr></tbody></table>
<p><strong>DPoP推奨のシナリオ</strong>:</p>
<ul>
<li>モバイルアプリ</li>
<li>PKIインフラがない環境</li>
<li>証明書管理が困難な環境</li>
<li>迅速な実装が必要な場合</li>
</ul>
<p><strong>mTLS推奨のシナリオ</strong>:</p>
<ul>
<li>エンタープライズ環境</li>
<li>既存のPKIインフラがある</li>
<li>最高レベルのセキュリティが必要</li>
<li>証明書ベースの認証が要件</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-トークン有効期限の設定">3. トークン有効期限の設定<a href="#3-トークン有効期限の設定" class="hash-link" aria-label="3. トークン有効期限の設定 への直接リンク" title="3. トークン有効期限の設定 への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">FAPI 2.0 推奨値:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| トークン/コード | 推奨有効期限 | 理由 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">|----------------|------------|------|</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| 認可コード | 60秒 | 攻撃の時間窓を最小化 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| アクセストークン | 300秒（5分） | DPoP/mTLSでバインドされているため短く |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| リフレッシュトークン | 使用後にローテーション | 盗難時の影響を最小化 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| request_uri (PAR) | 90秒 | 一度のみ使用、短期間 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">| DPoP Proof | iat±60秒 | リプレイ攻撃防止 |</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">短い有効期限のメリット:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- トークン盗難時の被害を最小化</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- リプレイ攻撃の時間窓を削減</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- セキュリティインシデントの影 響範囲を限定</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">デメリットと対策:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- ユーザー体験の低下 → リフレッシュトークンで自動更新</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- API呼び出しの複雑化 → トークンリフレッシュの自動化</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-issパラメータの重要性">4. issパラメータの重要性<a href="#4-issパラメータの重要性" class="hash-link" aria-label="4. issパラメータの重要性 への直接リンク" title="4. issパラメータの重要性 への直接リンク">​</a></h4>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Mix-Up攻撃のシナリオ:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">前提: クライアントが2つのAS（AS1, AS2）に対応</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">攻撃手順:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. ユーザーがAS1を選択</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. クライアントがAS1に認可リクエスト</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 攻撃者が悪意あるAS2のレスポンスに差し替え</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   code=ATTACKER_CODE&amp;state=STATE（issなし）</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. クライアントがAS2のcodeをAS1に送信</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   → AS1がエラーを返すが、攻撃者が情報を取得</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">対策（issパラメータ）:</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">1. AS1が認可レスポンスに iss=https://as1.example.com を含める</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">2. クライアントがissを検証</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 期待値: https://as1.example.com</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">   - 実際の値を確認</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">3. 不一致の場合は拒否</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">4. Mix-Up攻撃を検出・防止</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<p>実装のポイント:</p>
<ul>
<li>すべての認可レスポンスにissパラメータを含める</li>
<li>クライアント側で必ずissを検証</li>
<li>複数AS対応時は特に重要</li>
<li>JARMを使う場合でもissパラメータを含める（二重保護）</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="よくあるfapi-20要件違反とエラー">よくあるFAPI 2.0要件違反とエラー<a href="#よくあるfapi-20要件違反とエラー" class="hash-link" aria-label="よくあるFAPI 2.0要件違反とエラー への直接リンク" title="よくあるFAPI 2.0要件違反とエラー への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="違反1-dpop-proof-の検証省略">違反1: DPoP Proof の検証省略<a href="#違反1-dpop-proof-の検証省略" class="hash-link" aria-label="違反1: DPoP Proof の検証省略 への直接リンク" title="違反1: DPoP Proof の検証省略 への直接リンク">​</a></h4>
<p><strong>エラー:</strong> <code>invalid_dpop_proof</code> またはトークンバインディング不  一致
<strong>セキュリティリスク:</strong> アクセストークン盗難時の不正利用、トークンバインディングの無効化
<strong>FAPI要件:</strong> DPoP使用時、リソースサーバーはDPoP Proofの署名、<code>htm</code>, <code>htu</code>, <code>iat</code>, <code>ath</code>クレームを検証し、トークンの<code>cnf.jkt</code>と一致することを確認しなければならない
<strong>対策:</strong> APIアクセス時にDPoP Proofを検証し、JWK Thumbprint（jkt）の一致、HTTPメソッド・URI・トークンハッシュの正当性を確認する</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="違反2-iss-パラメータの未検証">違反2: iss パラメータの未検証<a href="#違反2-iss-パラメータの未検証" class="hash-link" aria-label="違反2: iss パラメータの未検証 への直接リンク" title="違反2: iss パラメータの未検証 への直接リンク">​</a></h4>
<p><strong>エラー:</strong> なし（セキュリティ脅威のみ）
<strong>セキュリティリスク:</strong> Mix-Up攻撃、複数AS環境での認可サーバー誤認
<strong>FAPI要件:</strong> 認可レスポンスに含まれる<code>iss</code>パラメータを検証し、期待する認可サーバーからのレスポンスであることを確認しなければならない
<strong>対策:</strong> 認可リクエスト時に期待するissuer値を記録し、コールバック時に認可レスポンスの<code>iss</code>パラメータと一致することを確認する</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="違反3-pkce-plain-メソッドの許可">違反3: PKCE Plain メソッドの許可<a href="#違反3-pkce-plain-メソッドの許可" class="hash-link" aria-label="違反3: PKCE Plain メソッドの許可 への直接リンク" title="違反3: PKCE Plain メソッドの許可 への直接リンク">​</a></h4>
<p><strong>エラー:</strong> <code>invalid_request</code> または要件不適合
<strong>  セキュリティリスク:</strong> 認可コードインターセプション攻撃、code_verifierの盗聴
<strong>FAPI要件:</strong> PKCE S256メソッドのみが許可される。Plainメソッドは明示的に禁止
<strong>対策:</strong> <code>code_challenge_method</code>が<code>S256</code>であることを検証し、それ以外の値（<code>plain</code>含む）を拒否する</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="違反4-rich-authorization-requests-rar-の検証不足">違反4: Rich Authorization Requests (RAR) の検証不足<a href="#違反4-rich-authorization-requests-rar-の検証不足" class="hash-link" aria-label="違反4: Rich Authorization Requests (RAR) の検証不足 への直接リンク" title="違反4: Rich Authorization Requests (RAR) の検証不足 への直接リンク">​</a></h4>
<p><strong>エラー:</strong> <code>invalid_authorization_details</code>
<strong>セキュリティリスク:</strong> 不正な金額・送金先の許可、ビジネスロジックの脆弱性
<strong>FAPI要件:</strong> <code>authorization_details</code>パラメータ使用時、ASとRSは各要素の<code>type</code>、金額、アクションの妥当性を検証しなければならない
<strong>対策:</strong> <code>authorization_details</code>の構造検証、type値の確認、金額上限チェック、送金先の妥当性検証を実施する</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="セキュリティベストプラクティス">セキュリティベストプラクティス<a href="#セキュリティベストプラクティス" class="hash-link" aria-label="セキュリティベストプラクティス への直接リンク" title="セキュリティベストプラクティス への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="1-par-の適切な実装">1. PAR の適切な実装<a href="#1-par-の適切な実装" class="hash-link" aria-label="1. PAR の適切な実装 への直接リンク" title="1. PAR の適切な実装 への直接リンク">​</a></h4>
<p><strong>推奨事項:</strong></p>
<ul>
<li>すべての認可リクエストをPAR経由にする</li>
<li>request_uriの有効期限を90秒に設定</li>
<li>request_uriは一度のみ使用可能</li>
<li>クライアント認証を必須にする</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="2-dpop-の適切な実装">2. DPoP の適切な実装<a href="#2-dpop-の適切な実装" class="hash-link" aria-label="2. DPoP の適切な実装 への直接リンク" title="2. DPoP の適切な実装 への直接リンク">​</a></h4>
<p><strong>推奨事項:</strong></p>
<ul>
<li>EC P-256鍵を使用（高速・安全）</li>
<li>DPoP Proofの有効期限を60秒以内に</li>
<li>jtiのリプレイ検証を実装</li>
<li>athクレームを必ず含める（APIアクセス時）</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="3-トークン有効期限の最小化">3. トークン有効期限の最小化<a href="#3-トークン有効期限の最小化" class="hash-link" aria-label="3. トークン有効期限の最小化 への直接リンク" title="3. トークン有効期限の最小化 への直接リンク">​</a></h4>
<p><strong>FAPI 2.0推奨値:</strong></p>
<table><thead><tr><th>トークン/コード</th><th>推奨有効期限</th><th>理由</th></tr></thead><tbody><tr><td>認可コード</td><td>60秒</td><td>攻撃の時間窓を最小化</td></tr><tr><td>アクセストークン</td><td>300秒（5分）</td><td>DPoPバインディングで短くても安全</td></tr><tr><td>リフレッシュトークン</td><td>ローテーション</td><td>盗難時の影響を最小化</td></tr><tr><td>request_uri (PAR)</td><td>90秒</td><td>一度のみ使用、短期間</td></tr><tr><td>DPoP Proof</td><td>iat±60秒</td><td>リプレイ攻撃防止</td></tr></tbody></table>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="4-監査とログ">4. 監査とログ<a href="#4-監査とログ" class="hash-link" aria-label="4. 監査と ログ への直接リンク" title="4. 監査とログ への直接リンク">​</a></h4>
<p><strong>記録すべき項目:</strong></p>
<ul>
<li>PARリクエスト（成功・失敗）</li>
<li>DPoP Proof検証結果</li>
<li>issパラメータ検証結果</li>
<li>トークン発行・拒否</li>
<li>すべてのセキュリティエラー</li>
</ul>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="セキュリティ理解度チェック">セキュリティ理解度チェック<a href="#セキュリティ理解度チェック" class="hash-link" aria-label="セキュリティ理解度チェック への直接リンク" title="セキュリティ理解度チェック への直接リンク">​</a></h3>
<p>この章を学習した後、以下を理解できているか確認してください：</p>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="認可サーバーas">認可サーバー（AS）<a href="#認可サーバーas" class="hash-link" aria-label="認可サーバー（AS） への直接リンク" title="認可サーバー（AS） への直接リンク">​</a></h4>
<p>□ PAR（Pushed Authorization Requests）が必須な理由と、これが認可リクエスト改ざん攻撃を防ぐ仕組みを説明できる</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>解答例</summary><div><div class="collapsibleContent_i85q"><p><strong>攻撃シナリオ（PARなし）</strong>:</p><ol>
<li>クライアントが認可リクエストをブラウザ経由で送信
<code>/authorize?amount=100&amp;...</code></li>
<li>攻撃者がブラウザのURLを改ざん
<code>/authorize?amount=10000&amp;...</code></li>
<li>ユーザーが改ざんされた内容で認可</li>
<li>攻撃者が不正な金額で取引実行</li>
</ol><p><strong>対策（PARあり）</strong>:</p><ol>
<li>クライアントがPARでパラメータを送信
<code>POST /par (amount=100)</code></li>
<li>ASがrequest_uriを返す</li>
<li>ブラウザにはrequest_uriのみ
<code>/authorize?request_uri=urn:...</code></li>
<li>攻撃者が改ざんできない</li>
<li>攻撃失敗</li>
</ol><p><strong>FAPI 2.0要件</strong>:</p><ul>
<li>PAR必須（すべての認可リクエストをPAR経由）</li>
<li>request_uriの有効期限90秒</li>
<li>request_uriは一度のみ使用可能</li>
<li>クライアント認証必須</li>
</ul></div></div></details>
<p>□ DPoPがmTLSより実装が容易な理由と、DPoP Proofの構造を説明できる</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>解答例</summary><div><div class="collapsibleContent_i85q"><p><strong>DPoPがmTLSより容易な理由</strong>:</p><table><thead><tr><th>項目</th><th>DPoP</th><th>mTLS</th></tr></thead><tbody><tr><td>実装難易度</td><td>低（標準的な暗号ライブラリ）</td><td>高（PKI、証明書管理）</td></tr><tr><td>モバイル対応</td><td>可（アプリ内で鍵生成）</td><td>困難（証明書の配布・管理）</td></tr><tr><td>インフラ要件</td><td>なし</td><td>PKI必要</td></tr><tr><td>コスト</td><td>低</td><td>高（証明書発行コスト）</td></tr></tbody></table><p><strong>DPoP Proofの構造</strong>:</p><p>ヘッダー:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;typ&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;dpop+jwt&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;alg&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;ES256&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;jwk&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;kty&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;EC&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;crv&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;P-256&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;x&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;y&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;...&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ペイロード（トークンリクエスト時）:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;jti&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;unique-id-123&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;htm&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;POST&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;htu&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://auth.example.com/token&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;iat&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1704150000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>ペイロード（APIアクセス時）:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;jti&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;unique-id-456&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;htm&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;GET&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;htu&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;https://api.example.com/data&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;iat&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1704150000</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;ath&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;base64url(SHA-256(access_token))&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>FAPI 2.0推奨</strong>:</p><ul>
<li>DPoPまたはmTLS必須</li>
<li>モバイルアプリではDPoP推奨</li>
</ul></div></div></details>
<p>□ issパラメータがMix-Up攻撃を防ぐ仕組みと、複数AS対応時の重要性を説明できる</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>解答例</summary><div><div class="collapsibleContent_i85q"><p><strong>Mix-Up攻撃シナリオ（issパラメータなし）</strong>:</p><p>前提: クライアントが2つのAS（AS1, AS2）に対応</p><p>攻撃手順:</p><ol>
<li>ユーザーがAS1を選択</li>
<li>クライアントがAS1に認可リクエスト</li>
<li>攻撃者が悪意あるAS2のレスポンスに差し替え
<code>code=ATTACKER_CODE&amp;state=STATE</code>（issなし）</li>
<li>クライアントがAS2のcodeをAS1に送信
→ AS1がエラーを返すが、攻撃者が情報を取得</li>
</ol><p><strong>対策（issパラメータあり）</strong>:</p><ol>
<li>AS1が認可レスポンスに<code>iss=https://as1.example.com</code>を含める</li>
<li>クライアントがissを検証<!-- -->
<ul>
<li>期待値: <code>https://as1.example.com</code></li>
<li>実際の値を確認</li>
</ul>
</li>
<li>不一致の場合は拒否</li>
<li>Mix-Up攻撃を検出・防止</li>
</ol><p><strong>FAPI 2.0要件</strong>:</p><ul>
<li>JARMまたはissパラメータ必須</li>
<li>issパラメータの方が実装が簡単</li>
<li>複数AS対応時は特に重要</li>
</ul></div></div></details>
<p>□ RAR（Rich Authorization Requests）がスコープより優れている理由と、決済での使用例を説明できる</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>解答例</summary><div><div class="collapsibleContent_i85q"><p><strong>スコープの限界</strong>:</p><p>従来のスコープ:</p><div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">scope=payments</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p>問題点:</p><ul>
<li>金額が指定できない</li>
<li>送金先が指定できない</li>
<li>詳細な条件が指定できない</li>
<li>複雑な認可要求を表現できない</li>
</ul><p><strong>RAR（Rich Authorization Requests）</strong>:</p><p>決済の例:</p><div class="language-json codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-json codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;type&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;payment_initiation&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;instructedAmount&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;amount&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;100.00&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;currency&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;EUR&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;creditorAccount&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token property" style="color:#36acaa">&quot;iban&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;DE89370400440532013000&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token property" style="color:#36acaa">&quot;remittanceInformationUnstructured&quot;</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;Payment for invoice 12345&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div><p><strong>メリット</strong>:</p><ul>
<li>取引の詳細を構造化して表現</li>
<li>スコープより柔軟</li>
<li>拡張性が高い</li>
<li>ユーザーに明確な情報を提示</li>
<li>API側で詳細な検証が可能</li>
</ul><p><strong>FAPI 2.0サポート</strong>:</p><ul>
<li>RFC 9396 RARをサポート</li>
<li>authorization_detailsパラメータ</li>
<li>PAR経由で送信</li>
</ul></div></div></details>
<p>□ FAPI 2.0がFAPI 1.0 Advancedより簡素化された点を説明できる</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>解答例</summary><div><div class="collapsibleContent_i85q"><p><strong>FAPI 2.0の簡素化</strong>:</p><table><thead><tr><th>項目</th><th>FAPI 1.0 Advanced</th><th>FAPI 2.0</th></tr></thead><tbody><tr><td><strong>レスポンスタイプ</strong></td><td>code, code id_token（Hybrid）</td><td>code のみ</td></tr><tr><td><strong>PAR</strong></td><td>推奨</td><td>必須</td></tr><tr><td><strong>Request Object</strong></td><td>必須（JWT）</td><td>PAR で送信（JWTまたは平文）</td></tr><tr><td><strong>レスポンス保護</strong></td><td>JARM または Hybrid</td><td>JARM または iss パラメータ</td></tr><tr><td><strong>トークンバインディング</strong></td><td>mTLS のみ</td><td>mTLS または DPoP</td></tr></tbody></table><p><strong>簡素化のポイント</strong>:</p><ol>
<li>
<p><strong>Hybrid Flow廃止</strong></p>
<ul>
<li>認可コードフローのみに統一</li>
<li>実装の複雑度低減</li>
</ul>
</li>
<li>
<p><strong>Request Objectの扱い</strong></p>
<ul>
<li>FAPI 1.0: JWTで署名必須</li>
<li>FAPI 2.0: PAR経由で送信（平文でも可）</li>
<li>PARで保護されるため、必ずしも署名不要</li>
</ul>
</li>
<li>
<p><strong>DPoPサポート</strong></p>
<ul>
<li>mTLSより実装が容易</li>
<li>モバイルアプリに最適</li>
<li>PKIインフラ不要</li>
</ul>
</li>
<li>
<p><strong>issパラメータ</strong></p>
<ul>
<li>JARMより簡単</li>
<li>Mix-Up攻撃防止</li>
</ul>
</li>
</ol><p><strong>結果</strong>:</p><ul>
<li>より実装しやすい</li>
<li>モダンな設計</li>
<li>セキュリティは維持</li>
</ul></div></div></details>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="クライアントrp">クライアント（RP）<a href="#クライアントrp" class="hash-link" aria-label="クライアント（RP） への直接リンク" title="クライアント（RP） への直接リンク">​</a></h4>
<p>□ DPoP Proof生成時の必須クレーム（jti、htm、htu、iat、ath）の役割を説明できる</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>解答 例</summary><div><div class="collapsibleContent_i85q"><p><strong>必須クレームの役割</strong>:</p><ol>
<li>
<p><strong>jti（JWT ID）</strong></p>
<ul>
<li>役割: リプレイ攻撃防止</li>
<li>値: UUID v4等の一意な値</li>
<li>検証: ASとRSが使用済みjtiを記録し、重複使用を拒否</li>
</ul>
</li>
<li>
<p><strong>htm（HTTPメソッド）</strong></p>
<ul>
<li>役割: リクエストメソッドのバインディング</li>
<li>値: <code>POST</code>, <code>GET</code>, <code>PUT</code>, <code>DELETE</code>等</li>
<li>検証: 実際のHTTPメソッドと一致することを確認</li>
</ul>
</li>
<li>
<p><strong>htu（HTTP URI）</strong></p>
<ul>
<li>役割: エンドポイントURLのバインディング</li>
<li>値: リクエストのURL（クエリ・フラグメント除く）</li>
<li>検証: 実際のURLと一致することを確認</li>
</ul>
</li>
<li>
<p><strong>iat（発行時刻）</strong></p>
<ul>
<li>役割: 時間窓の制限</li>
<li>値: UNIXタイムスタンプ</li>
<li>検証: iat±60秒以内であることを確認</li>
</ul>
</li>
<li>
<p><strong>ath（アクセストークンハッシュ、APIアクセス時のみ）</strong></p>
<ul>
<li>役割: トークンとProofのバインディング</li>
<li>値: SHA-256(access_token)のBase64URL</li>
<li>検証: トークンをハッシュ化してathと一致することを確認</li>
</ul>
</li>
</ol><p><strong>リプレイ攻撃防止の仕組み</strong>:</p><ul>
<li>jti: 一度使用したProofは再利用不可</li>
<li>htm/htu: 別のエンドポイントへの転用不可</li>
<li>iat: 時間窓外のProofは無効</li>
<li>ath: 別のトークンへの転用不可</li>
</ul></div></div></details>
<p>□ トークン有効期限がFAPI 1.0 Advancedより短い理由（認可コード60秒、アクセストークン300秒）を説明できる</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>解答例</summary><div><div class="collapsibleContent_i85q"><p><strong>FAPI 2.0の推奨値</strong>:</p><table><thead><tr><th>トークン/コード</th><th>FAPI 1.0 Advanced</th><th>FAPI 2.0</th><th>理由</th></tr></thead><tbody><tr><td>認可コード</td><td>1分</td><td>60秒</td><td>同じ</td></tr><tr><td>アクセストークン</td><td>5-15分</td><td>300秒（5分）</td><td>DPoP/mTLSでバインドされているため短くても安全</td></tr><tr><td>request_uri (PAR)</td><td>90秒</td><td>90秒</td><td>同じ</td></tr></tbody></table><p><strong>短い有効期限が可能な理由</strong>:</p><ol>
<li>
<p><strong>トークンバインディング必須</strong></p>
<ul>
<li>DPoPまたはmTLSが必須</li>
<li>トークン盗難時も使用不可</li>
<li>短い有効期限でも安全性を維持</li>
</ul>
</li>
<li>
<p><strong>リフレッシュトークンローテーション</strong></p>
<ul>
<li>アクセストークンは短期間で失効</li>
<li>リフレッシュトークンで自動更新</li>
<li>ユーザー体験を損なわない</li>
</ul>
</li>
<li>
<p><strong>攻撃の時間窓を最小化</strong></p>
<ul>
<li>トークン盗難から使用までの時間を制限</li>
<li>セキュリティインシデントの影響範囲を限定</li>
</ul>
</li>
</ol><p><strong>実装のポイント</strong>:</p><ul>
<li>クライアントがトークンリフレッシュを自動化</li>
<li>有効期限切れエラーをハンドリング</li>
<li>リトライロジックの実装</li>
</ul></div></div></details>
<p>□ request_uriが一度のみ使用可能な理由と、有効期限が90秒に設定される理由を説明できる</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>解答例</summary><div><div class="collapsibleContent_i85q"><p><strong>一度のみ使用可能な理由</strong>:</p><ol>
<li>
<p><strong>リプレイ攻撃防止</strong></p>
<ul>
<li>攻撃者がrequest_uriを傍受しても再利用不可</li>
<li>正規のクライアントが使用後は無効化</li>
</ul>
</li>
<li>
<p><strong>認可の不正な再実行防止</strong></p>
<ul>
<li>同じrequest_uriで複数回認可できない</li>
<li>意図しない認可の重複を防止</li>
</ul>
</li>
</ol><p><strong>有効期限90秒の理由</strong>:</p><ol>
<li>
<p><strong>ユーザー体験</strong></p>
<ul>
<li>ユーザーがリダイレクトされてから認可画面にアクセスするまでの時間</li>
<li>通常は数秒だが、余裕を持たせて90秒</li>
</ul>
</li>
<li>
<p><strong>セキュリティ</strong></p>
<ul>
<li>攻撃の時間窓を制限</li>
<li>長期間有効なrequest_uriは攻撃リスク</li>
</ul>
</li>
<li>
<p><strong>リソース効率</strong></p>
<ul>
<li>AS側でのrequest_uri保存期間を最小化</li>
<li>自動クリーンアップが容易</li>
</ul>
</li>
</ol><p><strong>実装のポイント</strong>:</p><ul>
<li>AS側でrequest_uriと認可パラメータを一時保存</li>
<li>使用済みまたは期限切れのrequest_uriは拒否</li>
<li>エラー時はクライアントが再度PARリクエストを送信</li>
</ul></div></div></details>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="リソースサーバーapi">リソースサーバー（API）<a href="#リソースサーバーapi" class="hash-link" aria-label="リソースサーバー（API） への直接リンク" title="リソースサーバー（API） への直接リンク">​</a></h4>
<p>□ DPoP Proof検証の手順と、各検証項目が防ぐ攻撃を説明できる</p>
<details class="details_lb9f alert alert--info details_b_Ee" data-collapsed="true"><summary>解答例</summary><div><div class="collapsibleContent_i85q"><p><strong>DPoP Proof検証の手順</strong>:</p><ol>
<li>
<p><strong>DPoP Proofの取得</strong></p>
<ul>
<li>DPoPヘッダーからJWTを取得</li>
</ul>
</li>
<li>
<p><strong>JWT構造の検証</strong></p>
<ul>
<li>typが<code>dpop+jwt</code>であることを確認</li>
<li>algがES256等の許可されたアルゴリズムか確認</li>
<li>jwkが含まれることを確認</li>
</ul>
</li>
<li>
<p><strong>署名検証</strong></p>
<ul>
<li>jwkの公開鍵でJWTの署名を検証</li>
</ul>
</li>
<li>
<p><strong>クレーム検証</strong></p>
<ul>
<li><strong>htm</strong>: HTTPメソッドが一致するか</li>
<li><strong>htu</strong>: エンドポイントURLが一致するか（クエリ・フラグメント除く）</li>
<li><strong>iat</strong>: ±60秒以内か</li>
<li><strong>jti</strong>: 一意性（使用済みでないか）</li>
<li><strong>ath</strong>: SHA-256(access_token)と一致するか</li>
</ul>
</li>
<li>
<p><strong>トークンバインディング検証</strong></p>
<ul>
<li>アクセストークンのcnf.jktを取得</li>
<li>jwkのthumbprint（SHA-256ハッシュ）を計算</li>
<li>cnf.jktと一致することを確認</li>
</ul>
</li>
</ol><p><strong>各検証が防ぐ攻撃</strong>:</p><table><thead><tr><th>検証項目</th><th>防ぐ攻撃</th></tr></thead><tbody><tr><td>htm</td><td>別のHTTPメソッドへの転用</td></tr><tr><td>htu</td><td>別のエンドポイントへの転用</td></tr><tr><td>iat</td><td>時間窓外のProof使用</td></tr><tr><td>jti</td><td>リプレイ攻撃</td></tr><tr><td>ath</td><td>別のトークンへの転用</td></tr><tr><td>cnf.jkt</td><td>トークンとProofの紐付け確認</td></tr></tbody></table><p><strong>実装のポイント</strong>:</p><ul>
<li>jtiの使用済みリストをキャッシュ（Redis等）</li>
<li>iatの検証時はクロックスキューを考慮</li>
<li>athはアクセストークンからSHA-256ハッシュを計算して比較</li>
</ul></div></div></details>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="セキュリティ上の考慮事項">セキュリティ上の考慮事項<a href="#セキュリティ上の考慮事項" class="hash-link" aria-label="セキュリティ上の考慮事項 への直接リンク" title="セキュリティ上の考慮事項 への直接リンク">​</a></h3>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="dpop-vs-mtls-の選択">DPoP vs mTLS  の選択<a href="#dpop-vs-mtls-の選択" class="hash-link" aria-label="DPoP vs mTLS の選択 への直接リンク" title="DPoP vs mTLS の選択 への直接リンク">​</a></h4>
<p><strong>DPoP推奨のシナリオ:</strong></p>
<ul>
<li>モバイルアプリケーション</li>
<li>PKIインフラがない環境</li>
<li>証明書管理が困難な環境</li>
<li>迅速な実装が必要な場合</li>
</ul>
<p><strong>mTLS推奨のシナリオ:</strong></p>
<ul>
<li>エンタープライズ環境</li>
<li>既存のPKIインフラがある</li>
<li>最高レベルのセキュリティが必要</li>
<li>証明書ベースの認証が要件</li>
</ul>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="par-のセキュリティ利点">PAR のセキュリティ利点<a href="#par-のセキュリティ利点" class="hash-link" aria-label="PAR のセキュリティ利点 への直接リンク" title="PAR のセキュリティ利点 への直接リンク">​</a></h4>
<ol>
<li>
<p><strong>ブラウザに機密情報が渡らない</strong></p>
<ul>
<li>金額、送金先等がURL履歴に残らない</li>
<li>リファラーヘッダーで漏洩しない</li>
</ul>
</li>
<li>
<p><strong>パラメータ改ざん防止</strong></p>
<ul>
<li>バックチャネルで送信</li>
<li>ブラウザでの改ざん不可</li>
</ul>
</li>
<li>
<p><strong>URL長さ制限の回避</strong></p>
<ul>
<li>大きなauthorization_detailsも送信可能</li>
</ul>
</li>
</ol>
<h4 class="anchor anchorWithStickyNavbar_LWe7" id="issパラメータの重要性">issパラメータの重要性<a href="#issパラメータの重要性" class="hash-link" aria-label="issパラメータの重要性 への直接リンク" title="issパラメータの重要性 への直接リンク">​</a></h4>
<p><strong>Mix-Up攻撃の防止:</strong></p>
<ul>
<li>複数AS対応時に必須</li>
<li>認可レスポンスの発行元を検証</li>
<li>悪意あるASからのレスポンス拒否</li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考リンク">参考リンク<a href="#参考リンク" class="hash-link" aria-label="参考リンク への直接リンク" title="参考リンク への直接リンク">​</a></h2>
<ul>
<li><a href="https://openid.bitbucket.io/fapi/fapi-2_0-security-profile.html" target="_blank" rel="noopener noreferrer">FAPI 2.0 Security Profile</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc9449" target="_blank" rel="noopener noreferrer">RFC 9449 - DPoP</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc9396" target="_blank" rel="noopener noreferrer">RFC 9396 - RAR</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc9207" target="_blank" rel="noopener noreferrer">RFC 9207 - iss parameter</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc9126" target="_blank" rel="noopener noreferrer">RFC 9126 - PAR</a></li>
<li><a href="https://openid.bitbucket.io/fapi/fapi-2_0-message-signing.html" target="_blank" rel="noopener noreferrer">FAPI 2.0 Message Signing</a></li>
</ul>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2>
<p>FAPI 2.0は、FAPI 1.0を簡素化しつつ強化した次世代プロファイルです：</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="主要な改善点">主要な改善点<a href="#主要な改善点" class="hash-link" aria-label="主要な改善点 への直接リンク" title="主要な改善点 への直接リンク">​</a></h3>
<ol>
<li>
<p><strong>PAR必須</strong> - すべての認可リクエストをバックチャネル化</p>
<ul>
<li>URLパラメータの改ざん防止</li>
<li>機密情報の保護</li>
<li>URL長さ制限の解決</li>
</ul>
</li>
<li>
<p><strong>DPoPサポート</strong> - mTLSより実装が容易</p>
<ul>
<li>PKIインフラ不要</li>
<li>モバイルアプリに最適</li>
<li>トークンバインディング</li>
</ul>
</li>
<li>
<p><strong> 認可コードフローのみ</strong> - Hybrid Flow廃止で簡素化</p>
<ul>
<li>実装の複雑度低減</li>
<li>セキュリティの明確化</li>
</ul>
</li>
<li>
<p><strong>RAR/Grant Management</strong> - 最新仕様をサポート</p>
<ul>
<li>柔軟な認可表現</li>
<li>ユーザーによる認可管理</li>
</ul>
</li>
<li>
<p><strong>issパラメータ</strong> - Mix-Up攻撃防止</p>
<ul>
<li>JARMより簡単</li>
<li>複数AS対応</li>
</ul>
</li>
</ol>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="実装時の重要ポイント">実装時の重要ポイント<a href="#実装時の重要ポイント" class="hash-link" aria-label="実装時の重要ポイント への直接リンク" title="実装時の重要ポイント への直接リンク">​</a></h3>
<ul>
<li>PAR、PKCE（S256）、トークンバインディング（DPoP/mTLS）は必須</li>
<li>issパラメータで認可レスポンスを保護</li>
<li>短い有効期限（認可コード60秒、アクセストークン300秒）</li>
<li>DPoP Proofの正しい検証（htm, htu, iat, ath, jti）</li>
<li>RARで詳細な認可要求を表現</li>
</ul>
<p>FAPI 2.0は、FAPI 1.0よりも実装しやすく、モダンな設計となっています。特にモバイルアプリやPKIインフラのない環境での採用が期待されています。</p></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_11_learning/16-oauth-oidc-rfc/advanced/fapi2-security.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/fapi1-baseline"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">FAPI 1.0 Baseline Profile</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_11_learning/oauth-oidc-rfc/advanced/grant-management"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">OAuth 2.0 Grant Management</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#目次" class="table-of-contents__link toc-highlight">目次</a></li><li><a href="#第1部-概要編" class="table-of-contents__link toc-highlight">第1部: 概要編</a><ul><li><a href="#fapi-20-とは" class="table-of-contents__link toc-highlight">FAPI 2.0 とは？</a></li><li><a href="#なぜ-fapi-20-が必要なのか" class="table-of-contents__link toc-highlight">なぜ FAPI 2.0 が必要なのか？</a></li><li><a href="#fapi-10-vs-fapi-20" class="table-of-contents__link toc-highlight">FAPI 1.0 vs FAPI 2.0</a></li><li><a href="#実際のユースケース" class="table-of-contents__link toc-highlight">実際のユースケース</a></li><li><a href="#fapi-20-の規制対応" class="table-of-contents__link toc-highlight">FAPI 2.0 の規制対応</a></li></ul></li><li><a href="#第2部-詳細編" class="table-of-contents__link toc-highlight">第2部: 詳細編</a><ul><li><a href="#par-pushed-authorization-requests" class="table-of-contents__link toc-highlight">PAR (Pushed Authorization Requests)</a></li><li><a href="#dpop-demonstrating-proof-of-possession" class="table-of-contents__link toc-highlight">DPoP (Demonstrating Proof-of-Possession)</a></li><li><a href="#iss-パラメータrfc-9207" class="table-of-contents__link toc-highlight">iss パラメータ（RFC 9207）</a></li><li><a href="#rich-authorization-requests-rar" class="table-of-contents__link toc-highlight">Rich Authorization Requests (RAR)</a></li></ul></li><li><a href="#第3部-セキュリティ" class="table-of-contents__link toc-highlight">第3部: セキュリティ</a><ul><li><a href="#脅威モデルと攻撃シナリオ" class="table-of-contents__link toc-highlight">脅威モデルと攻撃シナリオ</a></li><li><a href="#よくあるfapi-20要件違反とエラー" class="table-of-contents__link toc-highlight">よくあるFAPI 2.0要件違反とエラー</a></li><li><a href="#セキュリティベストプラクティス" class="table-of-contents__link toc-highlight">セキュリティベストプラクティス</a></li><li><a href="#セキュリティ理解度チェック" class="table-of-contents__link toc-highlight">セキュリティ理解度チェック</a></li><li><a href="#セキュリティ上の考慮事項" class="table-of-contents__link toc-highlight">セキュリティ上の考慮事項</a></li></ul></li><li><a href="#参考リンク" class="table-of-contents__link toc-highlight">参考リンク</a></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a><ul><li><a href="#主要な改善点" class="table-of-contents__link toc-highlight">主要な改善点</a></li><li><a href="#実装時の重要ポイント" class="table-of-contents__link toc-highlight">実装時の重要ポイント</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>