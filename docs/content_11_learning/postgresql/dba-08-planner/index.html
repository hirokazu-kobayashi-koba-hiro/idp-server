<!doctype html>
<html lang="ja" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-content_11_learning/postgresql/dba-08-planner" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.7.0">
<title data-rh="true">PostgreSQL プランナー深掘りガイド | IdP-Server Documentation</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/postgresql/dba-08-planner"><meta data-rh="true" property="og:locale" content="ja"><meta data-rh="true" name="docusaurus_locale" content="ja"><meta data-rh="true" name="docsearch:language" content="ja"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="PostgreSQL プランナー深掘りガイド | IdP-Server Documentation"><meta data-rh="true" name="description" content="プランナー（クエリオプティマイザ）は、SQLを「どのように実行するか」を決定するPostgreSQLの頭脳です。このドキュメントでは、プランナーの内部動作を詳しく解説します。"><meta data-rh="true" property="og:description" content="プランナー（クエリオプティマイザ）は、SQLを「どのように実行するか」を決定するPostgreSQLの頭脳です。このドキュメントでは、プランナーの内部動作を詳しく解説します。"><link data-rh="true" rel="icon" href="/idp-server/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/postgresql/dba-08-planner"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/postgresql/dba-08-planner" hreflang="ja"><link data-rh="true" rel="alternate" href="https://hirokazu-kobayashi-koba-hiro.github.io/idp-server/docs/content_11_learning/postgresql/dba-08-planner" hreflang="x-default"><link rel="alternate" type="application/rss+xml" href="/idp-server/blog/rss.xml" title="IdP-Server Documentation RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/idp-server/blog/atom.xml" title="IdP-Server Documentation Atom Feed"><link rel="stylesheet" href="/idp-server/assets/css/styles.f434a3d5.css">
<script src="/idp-server/assets/js/runtime~main.d2bd5086.js" defer="defer"></script>
<script src="/idp-server/assets/js/main.11812140.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();t(null!==e?e:"light")}(),function(){try{const n=new URLSearchParams(window.location.search).entries();for(var[t,e]of n)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="メインコンテンツまでスキップ"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">メインコンテンツまでスキップ</a></div><nav aria-label="ナビゲーション" class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="ナビゲーションバーを開く" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/idp-server/"><div class="navbar__logo"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/idp-server/img/logo.svg" alt="My Site Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">IdP-Server</b></a><a class="navbar__item navbar__link" href="/idp-server/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/idp-server/docs/content_07_reference/api-reference">Api Reference</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/hirokazu-kobayashi-koba-hiro/idp-server" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="ダークモードを切り替える(現在はライトモード)" aria-label="ダークモードを切り替える(現在はライトモード)" aria-live="polite" aria-pressed="false"><svg viewBox="0 0 24 24" width="24" height="24" class="lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" class="darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="先頭へ戻る" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="ドキュメントのサイドバー" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/introduction">はじめに</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/idp-server/docs/document-index">ドキュメントガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_01_intro/intro-01-tech-overview">製品紹介</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_02_quickstart/quickstart-01-getting-started">クイックスタート</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_03_concepts/foundation/concept-01-multi-tenant">コア概念</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_04_protocols/protocol-01-authorization-code-flow">認証・認可プロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_05_how-to/">How-to（設定・運用レシピ）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_06_developer-guide/">開発者ガイド</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_07_reference/api-reference">リファレンス</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/idp-server/docs/content_11_learning/identity-basics/identity-management-basics">学習（Learning）</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/identity-basics/identity-management-basics">アイデンティティ管理の基礎</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-fundamentals/modern-web-authz-authn">OAuth 2.0の基礎</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/oauth-tokens/id-token-jwt">OAuth 2.0トークン</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/openid-connect/oauth-oidc-basics">OpenID Connect</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/fido-webauthn/fido2-architecture-rp-browser-authenticator">FIDO2/WebAuthn</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/security/oauth-security-threats">セキュリティ</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/multi-tenancy/multi-tenancy-basics">マルチテナント</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/advanced-protocols/ciba-basics">高度なプロトコル</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/http-rest/http-basics">HTTP/REST</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/jwt-jose/jwt-introduction">JWT/JOSE</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/">PostgreSQL</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-3 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/">PostgreSQL 学習ガイド</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/overview">概要</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-00-managed-vs-self-hosted">DBA向け</a></div><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-00-managed-vs-self-hosted">PostgreSQL: マネージドサービス vs セルフホスト比較ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-01-installation">PostgreSQL インストールと初期設定ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-02-backup-recovery">PostgreSQL バックアップとリカバリガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-03-replication-ha">PostgreSQL レプリケーションとHA構成ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-04-security">PostgreSQL セキュリティガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-05-monitoring">PostgreSQL 監視ガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-06-maintenance">PostgreSQL メンテナンスガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-07-partitioning">PostgreSQL パーティショニングガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-08-planner">PostgreSQL プランナー深掘りガイド</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-4 menu__list-item"><a class="menu__link" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dba-09-extensions">PostgreSQL 拡張機能（Extensions）ガイド</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-3 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/postgresql/dev-01-sql-basics">開発者向け</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/crypto/">暗号化</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/kubernetes/">コンテナ/Kubernetes</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-2 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" tabindex="0" href="/idp-server/docs/content_11_learning/linux/">Linux</a></div></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_08_ops/ops-01-test-strategy">運用（Ops）</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_09_project/project-01-faq">プロジェクト</a></div></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/idp-server/docs/content_10_ai_developer/ai-01-index">AI</a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="パンくずリストのナビゲーション"><ul class="breadcrumbs" itemscope="" itemtype="https://schema.org/BreadcrumbList"><li class="breadcrumbs__item"><a aria-label="ホームページ" class="breadcrumbs__link" href="/idp-server/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">学習（Learning）</span><meta itemprop="position" content="1"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">PostgreSQL</span><meta itemprop="position" content="2"></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">DBA 向け</span><meta itemprop="position" content="3"></li><li itemscope="" itemprop="itemListElement" itemtype="https://schema.org/ListItem" class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link" itemprop="name">PostgreSQL プランナー深掘りガイド</span><meta itemprop="position" content="4"></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">このページの見出し</button></div><div class="theme-doc-markdown markdown"><header><h1>PostgreSQL プランナー深掘りガイド</h1></header>
<p>プランナー（クエリオプティマイザ）は、SQLを「どのように実行するか」を決定するPostgreSQLの頭脳です。このドキュメントでは、プランナーの内部動作を詳しく解説します。</p>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="目次">目次<a href="#目次" class="hash-link" aria-label="目次 への直接リンク" title="目次 への直接リンク">​</a></h2>
<ol>
<li><a href="#1-%E3%83%97%E3%83%A9%E3%83%B3%E3%83%8A%E3%83%BC%E3%81%AE%E5%BD%B9%E5%89%B2%E3%81%A8%E5%85%A8%E4%BD%93%E5%83%8F">プランナーの役割と全体像</a></li>
<li><a href="#2-%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%81%AE%E4%BB%95%E7%B5%84%E3%81%BF">統計情報の仕組み</a></li>
<li><a href="#3-%E3%82%B3%E3%82%B9%E3%83%88%E8%A8%88%E7%AE%97%E3%83%A2%E3%83%87%E3%83%AB">コスト計算モデル</a></li>
<li><a href="#4-%E3%82%B9%E3%82%AD%E3%83%A3%E3%83%B3%E6%96%B9%E5%BC%8F%E3%81%AE%E9%81%B8%E6%8A%9E">スキャン方式の選択</a></li>
<li><a href="#5-%E7%B5%90%E5%90%88%E3%82%A2%E3%83%AB%E3%82%B4%E3%83%AA%E3%82%BA%E3%83%A0%E3%81%AE%E9%81%B8%E6%8A%9E">結合アルゴリズムの選択</a></li>
<li><a href="#6-%E7%B5%90%E5%90%88%E9%A0%86%E5%BA%8F%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96">結合順序の最適化</a></li>
<li><a href="#7-%E5%AE%9F%E8%A1%8C%E8%A8%88%E7%94%BB%E3%81%AE%E8%AA%AD%E3%81%BF%E6%96%B9">実行計画の読み方</a></li>
<li><a href="#8-%E3%83%97%E3%83%A9%E3%83%B3%E3%83%8A%E3%83%BC%E3%81%AE%E5%88%B6%E5%BE%A1%E3%81%A8%E3%83%81%E3%83%A5%E3%83%BC%E3%83%8B%E3%83%B3%E3%82%B0">プランナーの制御とチューニング</a></li>
<li><a href="#9-%E3%83%97%E3%83%A9%E3%83%B3%E3%83%8A%E3%83%BC%E3%81%8C%E8%8B%A6%E6%89%8B%E3%81%AA%E3%82%B1%E3%83%BC%E3%82%B9">プランナーが苦手なケース</a></li>
<li><a href="#10-%E5%AE%9F%E8%B7%B5%E7%9A%84%E3%81%AA%E3%83%88%E3%83%A9%E3%83%96%E3%83%AB%E3%82%B7%E3%83%A5%E3%83%BC%E3%83%86%E3%82%A3%E3%83%B3%E3%82%B0">実践的なトラブルシューティング</a></li>
</ol>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="1-プランナーの役割と全体像">1. プランナーの役割と全体像<a href="#1-プランナーの役割と全体像" class="hash-link" aria-label="1. プランナーの役割と全体像 への直接リンク" title="1. プランナーの役割と全体像 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="11-プランナーとは">1.1 プランナーとは<a href="#11-プランナーとは" class="hash-link" aria-label="1.1 プランナーとは への直接リンク" title="1.1 プランナーとは への直接リンク">​</a></h3>
<p>プランナーは、クエリ木（Query Tree）を受け取り、最適な実行計画（Plan Tree）を生成するコンポーネントです。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   プランナーの位置づけ                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   SQL文                                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ▼                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Parser (構文解析)                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ▼                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Analyzer (意味解析)                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ▼                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Rewriter (書き換え)                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ▼                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   ┌─────────────────────────────────────────────────────┐   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                    Planner                           │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                      │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │  入力: Query Tree (何を取得するか)                   │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │  出力: Plan Tree (どうやって取得するか)              │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │                                                      │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   │  「同じ結果を得る複数の方法」から最適なものを選ぶ     │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   └─────────────────────────────────────────────────────┘   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ▼                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   Executor (実行)                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="12-プランナーの処理フロー">1.2 プランナーの処理フロー<a href="#12-プランナーの処理フロー" class="hash-link" aria-label="1.2 プランナーの処理フロー への直接リンク" title="1.2 プランナーの処理フロー への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                  プランナー内部の処理フロー                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Query Tree                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      │                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ▼                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌────────────────────────────────────────┐                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  1. 前処理 (Preprocessing)             │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │     - サブクエ リの平坦化               │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │     - 定数の畳み込み                   │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │     - WHERE句の正規化                  │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └────────────────────┬───────────────────┘                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       ▼                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌────────────────────────────────────────┐                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  2. スキャンパスの生成                  │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │     - 各テーブルのアクセス方法を列挙    │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │     - Sequential Scan, Index Scan等    │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └────────────────────┬───────────────────┘                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       ▼                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌────────────────────────────────────────┐                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  3. 結合パスの生成                      │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │     - テーブルの結合方法を列挙          │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │     - Nested Loop, Hash Join等         │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └────────────────────┬───────────────────┘                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       ▼                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌────────────────────────────────────────┐                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  4. 最適パスの選択                      │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │     - コストが最小のパスを選択          │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └────────────────────┬───────────────────┘                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       ▼                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌────────────────────────────────────────┐                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  5. Plan Tree の生成                    │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │     - 選択したパスを実行計画に変換      │                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └────────────────────┬───────────────────┘                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       ▼                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Plan Tree                                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="13-パスとプラン">1.3 「パス」と「プラン」<a href="#13-パスとプラン" class="hash-link" aria-label="1.3 「パス」と「プラン」 への直接リンク" title="1.3 「パス」と「プラン」 への直接リンク">​</a></h3>
<p>プランナー内部では、まず複数の「パス (Path)」を生成し、最終的に最適なパスを「プラン (Plan)」に変換します。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">【パス (Path)】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 実行方法の候補</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- コスト見積もりを持つ</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 複数のパスが並行して検討される</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">【プラン (Plan)】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 最終的に採用された実行計画</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- Executorが実際に実行する</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="2-統計情報の仕組み">2. 統計情報の仕組み<a href="#2-統計情報の仕組み" class="hash-link" aria-label="2. 統計情報の仕組み への直接リンク" title="2. 統計情報の仕組み への直接リンク">​</a></h2>
<p>プランナーが適切な判断をするためには、テーブルの統計情報が不可欠です。</p>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="21-統計情報とは">2.1 統計情報とは<a href="#21-統計情報とは" class="hash-link" aria-label="2.1 統計情報とは への直接リンク" title="2.1 統計情報とは への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    統計情報の種類                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【テーブルレベル】pg_class                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ reltuples: 推定行数                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ relpages:  ページ数（8KBブロック数）                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─ relallvisible: 全可視ページ数                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【カラムレベル】pg_statistic / pg_stats                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ null_frac:      NULL値の割合                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ n_distinct:     ユニーク値の数（または割合）              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ most_common_vals:   最頻値リスト                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ most_common_freqs:  最頻値の出現頻度                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ histogram_bounds:   ヒストグラム境界値                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─ correlation:        物理順序との相関                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="22-統計情報の確認方法">2.2 統計情報の確認方法<a href="#22-統計情報の確認方法" class="hash-link" aria-label="2.2 統計情報の確認方法 への直接リンク" title="2.2 統計情報の確認方法 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- テーブルの基本統計</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    relname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    reltuples::</span><span class="token keyword" style="color:#00009f">bigint</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> estimated_rows</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    relpages </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> pages</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> pg_class </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> relname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;users&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- カラムの詳細統計</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    attname</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    null_frac</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    n_distinct</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    most_common_vals</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    most_common_freqs</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    histogram_bounds</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> pg_stats </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> tablename </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;users&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> attname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;status&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="23-n_distinct-の解釈">2.3 n_distinct の解釈<a href="#23-n_distinct-の解釈" class="hash-link" aria-label="2.3 n_distinct の解釈 への直接リンク" title="2.3 n_distinct の解釈 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   n_distinct の意味                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  正の値: ユニーク値の絶対数                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    例: n_distinct = 5 → 5種類の値がある                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  負の値: 行数に対する割合（絶対値）                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    例: n_distinct = -0.5 → ユニーク値は行数の50%              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         10000行なら約5000種類                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  -1: すべての値がユニーク（主キーなど）                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="24-ヒストグラム">2.4 ヒストグラム<a href="#24-ヒストグラム" class="hash-link" aria-label="2.4 ヒストグラム への直接リンク" title="2.4 ヒストグラム への直接リンク">​</a></h3>
<p>ヒストグラムは値の分布を表し、範囲検索の選択性を推定するのに使われます。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   ヒストグラムの例                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  histogram_bounds = {0, 20, 40, 60, 80, 100}                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  これは値を5つの等頻度バケットに分割:                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  [0-20), [20-40), [40-60), [60-80), [80-100]                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  各バケットには約20%のデータが含まれる                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  WHERE age BETWEEN 30 AND 50 の選択性推定:                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - [20-40) の一部 + [40-60) の一部                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 約 (10/20 × 20%) + (10/20 × 20%) = 20%                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│   頻度                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ▲                                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    │  ████  ████  ████  ████  ████                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    │  ████  ████  ████  ████  ████                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    └──────────────────────────────────▶ 値                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       0    20    40    60    80   100                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="25-相関-correlation">2.5 相関 (correlation)<a href="#25-相関-correlation" class="hash-link" aria-label="2.5 相関 (correlation) への直接リンク" title="2.5 相関 (correlation) への直接リンク">​</a></h3>
<p>物理的な行の並び順と、カラム値の論理的な順序の相関を示します。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    correlation の意味                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  correlation = 1.0:  完全に順序通り                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    物理順: 行1, 行2, 行3, 行4, 行5                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    値:     10,  20,  30,  40,  50                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → Index Scan が効率的（連続読み取り）                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  correlation = 0.0:  ランダム                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    物理順: 行1, 行2, 行3, 行4, 行5                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    値:     30,  10,  50,  20,  40                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → Index Scan はランダムI/Oが多発                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  correlation = -1.0: 完全に逆順                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    物理順: 行1, 行2, 行3, 行4, 行5                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    値:     50,  40,  30,  20,  10                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【Index Scan のコストに影響】                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  correlation が低い → ランダムI/O → コスト高                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  correlation が高い → シーケンシャルI/O → コスト低           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="26-統計情報の更新">2.6 統計情報の更新<a href="#26-統計情報の更新" class="hash-link" aria-label="2.6 統計情報の更新 への直接リンク" title="2.6 統計情報の更新 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 特定テーブルの統計情報を更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"> users</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 全テーブルの統計情報を更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 統計情報の精度を上げる（サンプル数を増やす）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">STATISTICS</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"> users</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- デフォルトは 100、最大 10000</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="27-拡張統計情報">2.7 拡張統計情報<a href="#27-拡張統計情報" class="hash-link" aria-label="2.7 拡張統計情報 への直接リンク" title="2.7 拡張統計情報 への直接リンク">​</a></h3>
<p>PostgreSQL 10以降では、複数カラム間の相関を記録できます。</p>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 複数カラムの相関統計を作成</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">STATISTICS</span><span class="token plain"> stats_city_zip </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> city</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> zip_code </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> addresses</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"> addresses</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> pg_statistic_ext </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> stxname </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;stats_city_zip&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                  拡張統計が必要なケース                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【問題】カラム間に相関があるのにプランナーが認識できない       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  例: addresses テーブル                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      city = &#x27;東京都&#x27; AND zip_code LIKE &#x27;1%&#x27;                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  通常の統計:                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    city = &#x27;東京都&#x27; の選択性: 10%                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    zip_code LIKE &#x27;1%&#x27; の選択性: 10%                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    推定選択性: 10% × 10% = 1% ← 独立と仮定                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  実際:                                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    東京都の郵便番号は1で始まる → 実際は10%                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  拡張統計を使うと正確に推定できる                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="3-コスト計算モデル">3. コスト計算モデル<a href="#3-コスト計算モデル" class="hash-link" aria-label="3. コスト計算モデル への直接リンク" title="3. コスト計算モデル への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="31-コス  トとは">3.1 コストとは<a href="#31-コストとは" class="hash-link" aria-label="3.1 コストとは への直接リンク" title="3.1 コストとは への直接リンク">​</a></h3>
<p>プランナーの「コスト」は、実行にかかるリソースの相対的な見積もりです。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    コストの構成要素                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  総コスト = I/Oコスト + CPUコスト                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【I/Oコスト】                                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ シーケンシャル読み取り (seq_page_cost = 1.0)             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─ ランダム読み取り (random_page_cost = 4.0)                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【CPUコスト】                                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ 行の処理 (cpu_tuple_cost = 0.01)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ├─ インデックスエントリの処理 (cpu_index_tuple_cost = 0.005)│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─ 演算子/関数の実行 (cpu_operator_cost = 0.0025)          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ※ 値はデフォルト。SSDならrandom_page_costを下げる等の調整可  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコー ドをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="32-explainで見るコスト">3.2 EXPLAINで見るコスト<a href="#32-explainで見るコスト" class="hash-link" aria-label="3.2 EXPLAINで見るコスト への直接リンク" title="3.2 EXPLAINで見るコスト への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コ ピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Index Scan using users_pkey on users  (cost=0.29..8.30 rows=1 width=100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                       ~~~~~ ~~~~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                         │     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              startup cost   total cost</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   コストの読み方                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  cost=0.29..8.30                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ~~~~  ~~~~                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        │     └─ total cost: 全行を取得するまでの総コスト     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        │                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        └─ startup cost: 最初の行を返すまでのコスト           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                         (ソートや集約では大きくなる)          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  rows=1     : 推定結果行数                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  width=100  : 1行あたりの推定バイト数                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="33-sequential-scan-のコスト計算">3.3 Sequential Scan のコスト計算<a href="#33-sequential-scan-のコスト計算" class="hash-link" aria-label="3.3 Sequential Scan のコスト計算 への直接リンク" title="3.3 Sequential Scan のコスト計算 への 直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              Sequential Scan のコスト計算式                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  total_cost = seq_page_cost × ページ数                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│             + cpu_tuple_cost × 行数                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│             + cpu_operator_cost × 行数 × WHERE条件数         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【例】users テーブル: 10000行, 500ページ                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        WHERE status = &#x27;active&#x27;                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  I/Oコスト  = 1.0 × 500 = 500                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  CPUコスト  = 0.01 × 10000 + 0.0025 × 10000 = 125            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  総コスト   = 625                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="34-index-scan-のコスト計算">3.4 Index Scan のコスト計算<a href="#34-index-scan-のコスト計算" class="hash-link" aria-label="3.4 Index Scan のコスト計算 への直接リンク" title="3.4 Index Scan のコスト計算 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│               Index Scan のコスト計算式                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  total_cost = インデックス探索コスト                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│             + random_page_cost × 読み取りページ数            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│             + cpu_index_tuple_cost × インデックス行数        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│             + cpu_tuple_cost × テーブル行数                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【重要】correlation が考慮される                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  correlation高い → ページ読み取りがシーケンシャルに近い       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                  → コストが下がる                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  correlation低い → ランダムI/Oが多い                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                  → コストが上がる                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【例】users.id にインデックス、id = 100 を検索               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│        推定1行、インデックス深さ3、correlation = 1.0          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  インデックス探索 = random_page_cost × 3 = 12                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  テーブル読み取り = random_page_cost × 1 = 4                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  CPU処理         = 約 0.03                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  総コスト        ≈ 16                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="35-コスト比較の例">3.5 コスト比較の例<a href="#35-コスト比較の例" class="hash-link" aria-label="3.5 コスト比較の例 への直接リンク" title="3.5 コスト比較の例 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 10000行のusersテーブル、statusカラムに5種類の値</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 1. 選択性が高い場合 (1行のみ)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- → Index Scan (cost ≈ 8)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 2. 選択性が中程度 (2000行 = 20%)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;active&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- → Index Scan または Bitmap Scan (cost比較で決定)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 3. 選択性が低い (8000行 = 80%)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">!=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;deleted&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- → Sequential Scan (cost ≈ 625) </span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- インデックスを使うより全件スキャンの方が効率的</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="36-コストパラメータのチューニング">3.6 コストパラメータのチューニング<a href="#36-コストパラメータのチューニング" class="hash-link" aria-label="3.6 コストパラメータのチューニング への直接リンク" title="3.6 コストパラメータのチューニング への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- SSDを使用している場合（ランダム読み取りが速い）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> random_page_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- デフォルト 4.0</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- メモリが潤沢でデータがキャッシュされている場合</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> effective_cache_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;8GB&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- OSキャッシュも含めた推定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 確認</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SHOW</span><span class="token plain"> random_page_cost</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SHOW</span><span class="token plain"> seq_page_cost</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="4-スキャン方式の選択">4. スキャン方式の選択<a href="#4-スキャン方式の選択" class="hash-link" aria-label="4. スキャン方式の選択 への直接リンク" title="4. スキャン方式の選択 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="41-  スキャン方式の一覧">4.1 スキャン方式の一覧<a href="#41-スキャン方式の一覧" class="hash-link" aria-label="4.1 スキャン方式の一覧 への直接リンク" title="4.1 スキャン方式の一覧 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    スキャン方式の種類                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────┐                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ Sequential Scan │  テーブル全体を先頭から順に読む         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────┘                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ↓ 選択性が低い場合に有利                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────┐                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │   Index Scan    │  インデックス→テーブルの順でアクセス    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────┘                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ↓ 選択性が高い場合に有利                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────┐                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │Index Only Scan  │  インデックスだけで完結（テーブル不要）  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────┘                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ↓ SELECT対象がインデックスに含まれる場合           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────┐                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  Bitmap Scan    │  複数条件をビットマップで効率化         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────┘                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ↓ 中程度の選択性、複数インデックス                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────┐                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │    TID Scan     │  直接行のTIDを指定してアクセス          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────┘                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│           ↓ WHERE ctid = &#x27;(0,1)&#x27; など特殊ケース             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="42-sequential-scan">4.2 Sequential Scan<a href="#42-sequential-scan" class="hash-link" aria-label="4.2 Sequential Scan への直接リンク" title="4.2 Sequential Scan への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   Sequential Scan                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────  ────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【動作】                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  テーブルの全ページを先頭から順番に読み、各行をチェック        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Page 0 → Page 1 → Page 2 → ... → Page N                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓        ↓        ↓              ↓                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  各行をWHERE条件でフィルタリング                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【選ばれる条件】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 取得行が全体の大部分を占める                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 適切なインデックスがない                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - テーブルが小さい                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - correlation が低くIndex Scanが非効率                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【パラレル実行】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  大きなテーブルでは複数ワーカーで並列実行可能                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  → Parallel Sequential Scan                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="43-index-scan">4.3 Index Scan<a href="#43-index-scan" class="hash-link" aria-label="4.3 Index Scan への直接リンク" title="4.3 Index Scan への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                      Index Scan                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【動作】                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Step 1: インデックスを探索して条件に合うエントリを見つける   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      B-tree Index                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│          │                                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│          ▼                                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      [Root] → [Internal] → [Leaf]                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                              │                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                         TID (0, 5)  ← 行の物理位置           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Step 2: TIDを使ってテーブルから行を取得                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      Table                                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      Page 0: [row1][row2][row3]...                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                              ↑                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                          ここを読む                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【選ばれる条件】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 選択性が高い（少数の行を取得）                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ORDER BYがインデックス順と一致                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - LIMITと組み合わせ                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="44-index-only-scan">4.4 Index Only Scan<a href="#44-index-only-scan" class="hash-link" aria-label="4.4 Index Only Scan への直接リンク" title="4.4 Index Only Scan への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    Index Only Scan                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【動作】                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  インデックスだけで必要なデータが揃う場合、テーブルを読まない  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  CREATE INDEX idx_users_email ON users(email);               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  SELECT email FROM users WHERE email LIKE &#x27;a%&#x27;;              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      Index (email)                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      ┌──────────────────────┐                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      │ alice@example.com    │ ← これだけで回答可能           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      │ anna@example.com     │                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      │ ...                  │                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      └──────────────────────┘                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              ↓                                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      テーブルアクセス不要！                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【条件】                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. SELECTするカラムが全てインデックスに含まれる              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. Visibility Map で行が「全可視」と分かっている             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     （VACUUMが適切に実行されている必要あり）                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【カバリングインデックス】                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  CREATE INDEX idx_covering ON users(email) INCLUDE (name);   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  → SELECT email, name FROM users WHERE email = &#x27;...&#x27;         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    もIndex Only Scanにできる                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="45-bitmap-scan">4.5 Bitmap Scan<a href="#45-bitmap-scan" class="hash-link" aria-label="4.5 Bitmap Scan への直接リンク" title="4.5 Bitmap Scan への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                      Bitmap Scan                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【動作】3段階のプロセス                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ① Bitmap Index Scan: インデックスから該当ページをビットマップ化│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     Index                    Bitmap                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ┌────────┐              ┌───────────────────┐           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │id = 5  │──→           │ Page 0: 1         │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │id = 12 │──→           │ Page 1: 0         │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │id = 15 │──→           │ Page 2: 1         │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     │id = 23 │──→           │ Page 3: 1         │           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     └────────┘              └───────────────────┘           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ② BitmapAnd / BitmapOr: 複数条件のビットマップを結合         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     WHERE status=&#x27;active&#x27; AND category=&#x27;A&#x27;                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     Bitmap(status)     Bitmap(category)     Result           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     [1,0,1,1,0]    AND [1,1,0,1,0]      =  [1,0,0,1,0]       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ③ Bitmap Heap Scan: ビットマップに基づいてテーブルを読む     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     Page 0, Page 3 のみ読み取り                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → ページ単位でまとめて読むのでランダムI/O削減             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【選ばれる条件】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 中程度の選択性（多すぎず少なすぎず）                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 複数の条件をOR/ANDで組み合わせる                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - correlation が低い（ランダムI/Oを減らしたい）             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="46-スキャン方式の選択基準">4.6 スキャン方式の選択基準<a href="#46-スキャン方式の選択基準" class="hash-link" aria-label="4.6 スキャン方式の選択基準 への直接リンク" title="4.6 スキャン方式の選択基準 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                 スキャン方式の選択フロー                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  適切なインデックスがある？                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         │                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    No   │   Yes                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    ↓    └────────────────┐                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Seq Scan                │                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    選択性は？                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    │     │      │                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                  高い  中程度  低い                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   │     │      │                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   ▼     ▼      ▼                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              Index   Bitmap   Seq                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              Scan    Scan     Scan                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                │                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         SELECT列がインデックスに                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         全て含まれる？                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              │     │                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│            Yes    No                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              │     │                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              ▼     ▼                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         Index    Index                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         Only     Scan                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│         Scan                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">【選択性の目安】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 高い: 全体の 1-5% 未満 → Index Scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 中程度: 5-20% → Bitmap Scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 低い: 20% 以上 → Sequential Scan</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">※ テーブルサイズ、correlation、effective_cache_size等で変動</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="5-結合アルゴリズムの選択">5. 結合アルゴリズムの選択<a href="#5-結合アルゴリズムの選択" class="hash-link" aria-label="5. 結合アルゴリズムの選択 への直接リンク" title="5. 結合アルゴリズムの選択 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="51-結合アルゴリズムの一覧">5.1 結合アルゴリズムの一覧<a href="#51-結合アルゴリズムの一覧" class="hash-link" aria-label="5.1 結合アルゴリズムの一覧 への直接リンク" title="5.1 結合アルゴリズムの一覧 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   結合アルゴリズム                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────┐    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                  Nested Loop Join                    │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  外側テーブルの各行に対し、内側テーブルを検索         │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────┘    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────┐    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                    Hash Join                         │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  一方のテーブルでハッシュテーブルを構築し  、           │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  もう一方をそれに照合                                │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────┘    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────┐    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                   Merge Join                         │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  両テーブルをソートしてマージ                        │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────┘    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label=" クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="52-nested-loop-join">5.2 Nested Loop Join<a href="#52-nested-loop-join" class="hash-link" aria-label="5.2 Nested Loop Join への直接リンク" title="5.2 Nested Loop Join への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    Nested Loop Join                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【アルゴリズム】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  for each row in outer_table:          # 外側ループ          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│      for each row in inner_table:      # 内側ループ          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│          if join_condition matches:                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              output combined row                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【図解】                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Outer (users)         Inner (orders)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌──────────┐          ┌──────────┐                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ id=1     │────┬────→│ user_id  │ 全件または              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ id=2     │────┼────→│ をスキャン│ インデックスで検索      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ id=3     │────┼────→│          │                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ ...      │    │     └──────────┘                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └──────────┘    │                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                  └─ 外側の各行に対して内側を検索             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【コスト】                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  O(N × M) ... ただし内側にインデックスがあれば O(N × log M) │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【適したケース】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 外側テーブルが小さい                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 内側テーブルにインデックスがある                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 非等価結合（&lt;, &gt;, BETWEEN など）                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - LIMIT と組み合わせ（早期終了できる）                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="53-hash-join">5.3 Hash Join<a href="#53-hash-join" class="hash-link" aria-label="5.3 Hash Join への直接リンク" title="5.3 Hash Join への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌─ ─────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       Hash Join                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【アルゴリズム】2フェーズ                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Phase 1: Build (ハッシュテーブル構築)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────┐    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  Inner Table (通常は小さい方)                        │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ┌────────────┐                                     │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ id=1, ...  │  ──→ hash(1) = bucket[3]             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ id=2, ...  │──→ hash(2) = bucket[7]             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  │ id=3, ...  │──→ hash(3) = bucket[3]             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  └────────────┘                                     │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                     Hash Table                       │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                     ┌─────────────────┐             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                     │ [0]:            │             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                     │ [1]:            │             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                     │ [2]:            │             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                     │ [3]: id=1, id=3 │             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                     │ ...             │             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                     │ [7]: id=2       │             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  │  │                     └─────────────────┘             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────┘    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Phase 2: Probe (照合)                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────┐    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  Outer Table の各行をハッシュテーブルで検索           │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                                                      │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  user_id=1 → hash(1) → bucket[3] → マッチ!          │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  user_id=5 → hash(5) → bucket[2] → なし             │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────┘    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【コスト】                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  O(N + M) ... ハッシュ構築O(M) + 照合O(N)                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【適したケース】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 等価結合 (=) のみ                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 両テーブルが比較的大きい                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - work_mem に収まるサイズ                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - インデックスがない場合                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【注意】                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ハッシュテーブルがwork_memを超えると一時ファイルに退避     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → 大幅に遅くなる                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="54-merge-join">5.4 Merge Join<a href="#54-merge-join" class="hash-link" aria-label="5.4 Merge Join への直接リンク" title="5.4 Merge Join への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       Merge Join                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【アルゴリズム】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  前提: 両テーブルが結合キーでソート済み                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Sorted Outer     Sorted Inner                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌──────────┐    ┌──────────┐                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ id=1     │←──→│ user_id=1│  マッチ!                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ id=2     │←──→│ user_id=2│  マッチ!                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ id=3     │    │ user_id=2│  (2と複数マッチ)               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ id=4     │←──→│ user_id=4│  マッチ!                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ id=5     │    │ user_id=6│  (5はスキップ)                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ id=6     │←──→│ user_id=6│  マッチ!                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └──────────┘    └──────────┘                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       ↓               ↓                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    同時に進める（マージ）                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【コスト】                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  O(N log N + M log M + N + M)                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ソート済みなら O(N + M)                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【適したケース】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 大きなテーブル同士の結合                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 既にソート済み（インデックスがある）                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ORDER BY が結合キーと同じ                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 等価結合だけでなく範囲結合も可能                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="55-結合アルゴリズムの選択基準">5.5 結合アルゴリズムの選択基準<a href="#55-結合アルゴリズムの選択基準" class="hash-link" aria-label="5.5 結合アルゴリズムの選択基準 への直接リンク" title="5.5 結合アルゴリズムの選択基準 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              結合アルゴリズムの選択フロー                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  結合条件は？                                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       │                                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌────┴────┐                                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │         │                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 等価(=)  非等価(&lt;,&gt;等)                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │         │                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │         └──→ Nested Loop (ほぼ唯一の選択肢)              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ▼                                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  テーブルサイズは？                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│       │                                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌────┼────────────┐                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │    │            │                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ 小×小 小×大      大×大                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │    │            │                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │    │     ┌──────┴──────┐                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │    │     │             │                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │    │   ソート済み？  ソートなし                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │    │     │             │                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ▼    ▼     ▼             ▼                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│ NL   NL   Merge         Hash                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│(idx) (idx) Join          Join                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">【判断の補足】</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 小さいテーブル: 数千行以下</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- 大きいテーブル: 数万行以上</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- インデックスの有無で Nested Loop の効率が大きく変わる</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">- work_mem のサイズで Hash Join の効率が変わる</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="56-実行計画での確認例">5.6 実行計画での確認例<a href="#56-実行計画での確認例" class="hash-link" aria-label="5.6 実行計画での確認例 への直接リンク" title="5.6 実行計画での確認例 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFERS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">total</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> orders o </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">user_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;active&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">-- Nested Loop の例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Nested Loop  (cost=0.29..125.35 rows=100 ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Index Scan using idx_users_status on users u  (...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Index Cond: (status = &#x27;active&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Index Scan using idx_orders_user_id on orders o  (...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Index Cond: (user_id = u.id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Hash Join の例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Hash Join  (cost=15.00..85.00 rows=1000 ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Hash Cond: (o.user_id = u.id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Seq Scan on orders o  (...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Hash  (...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on users u  (...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              Filter: (status = &#x27;active&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">-- Merge Join の例</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Merge Join  (cost=200.00..350.00 rows=1000 ...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Merge Cond: (u.id = o.user_id)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Index Scan using users_pkey on users u  (...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Sort  (...)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Sort Key: o.user_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  Seq Scan on orders o  (...)</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="6-結合順序の最適化">6. 結合順序の最適化<a href="#6-結合順序の最適化" class="hash-link" aria-label="6. 結合順序の最適化 への直接リンク" title="6. 結合順序の最適化 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="61-結合順序問題">6.1 結合順序問題<a href="#61-結合順序問題" class="hash-link" aria-label="6.1 結合順序問題 への直接リンク" title="6.1 結合順序問題 への直接リンク">​</a></h3>
<p>複数テーブルを結合する場合、順序によって性能が大きく変わります。</p>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   結合順序の重要性                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3テーブル結合: A ⋈ B ⋈ C                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  可能な順序:                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. (A ⋈ B) ⋈ C                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. (A ⋈ C) ⋈ B                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. (B ⋈ C) ⋈ A                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  4. A ⋈ (B ⋈ C)                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  5. B ⋈ (A ⋈ C)                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  6. C ⋈ (A ⋈ B)                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【例】                                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  A: 10行, B: 10000行, C: 100行                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  A ⋈ B: 1000行, B ⋈ C: 5000行, A ⋈ C: 100行                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  悪い順序: (B ⋈ C) ⋈ A                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → B ⋈ C で5000行の中間結果                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → 5000行 ⋈ A                                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  良い順序: (A ⋈ C) ⋈ B                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → A ⋈ C で100行の中間結果                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    → 100行 ⋈ B                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="62-結合順序の探索方法">6.2 結合順序の探索方法<a href="#62-結合順序の探索方法" class="hash-link" aria-label="6.2 結合順序の探索方法 への直接リンク" title="6.2 結合順序の探索方法 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                 結合順序の探索アルゴリズム                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  テーブル数が少ない場合 (≤ geqo_threshold, デフォルト12)      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌───────────  ──────────────────────────────────────────┐    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │              動的計画法 (Dynamic Programming)        │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                                                      │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  全ての組み合わせを評価して最適解を見つける            │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  計算量: O(n! × 2^n)                                 │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  → 確実に最適解が得られる                            │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────┘    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  テーブル数が多い場合 (&gt; geqo_threshold)                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌─────────────────────────────────────────────────────┐    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │              GEQO (遺伝的アルゴリズム)                │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │                                                      │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  ランダムな順序から始めて、進化的に改善              │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  計算量: 設定可能                                    │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │  → 最適解は保証されないが、現実的な時間で完了        │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └─────────────────────────────────────────────────────┘    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="63-結合順序に関する設定">6.3 結合順序に関する設定<a href="#63-結合順序に関する設定" class="hash-link" aria-label="6.3 結合順序に関する設定 への直接リンク" title="6.3 結合順序に関する設定 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 動的計画法を使うテーブル数の閾値</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SHOW</span><span class="token plain"> geqo_threshold</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- デフォルト 12</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- GEQOの動作を制御</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> geqo </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">                </span><span class="token comment" style="color:#999988;font-style:italic">-- GEQO を有効化</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> geqo_effort </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">          </span><span class="token comment" style="color:#999988;font-style:italic">-- 探索の努力度 (1-10)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> geqo_generations </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">-- 世代数 (0=自動)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> geqo_pool_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">-- 集団サイズ (0=自動)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 特定の結合順序を強制（デバッグ用）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> join_collapse_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- 明示的な順序を維持</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="64-from句の書き方による制御">6.4 FROM句の書き方による制御<a href="#64-from句の書き方による制御" class="hash-link" aria-label="6.4 FROM句の書き方による制御 への直接リンク" title="6.4 FROM句の書き方による制御 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 通常: プランナーが自由に順序を決定</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> c </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_id </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- CROSS JOIN LATERAL: 左から右への順序を強制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> a</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CROSS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> LATERAL </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> b </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> b</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CROSS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> LATERAL </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> c </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b_id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 明示的な括弧で順序をヒント</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> a </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">b </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> c </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> c</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">b_id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> a</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> b</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">a_id</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- join_collapse_limit = 1 の場合、この順序が維持される</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="7-実行計画の読み方">7. 実行計画の読み方<a href="#7-実行計画の読み方" class="hash-link" aria-label="7. 実行計画の読み方 への直接リンク" title="7. 実行計画の読み方 への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="71-explainの種類">7.1 EXPLAINの種類<a href="#71-explainの種類" class="hash-link" aria-label="7.1 EXPLAINの種類 への直接リンク" title="7.1 EXPLAINの種類 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 基本的な実行計画</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 実際の実行時間も表示</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- バッファ情報も表示</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFERS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 詳細情報</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFERS</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> VERBOSE</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- JSON形式で出力</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> FORMAT JSON</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="72-実行計画の読み方の基本">7.2 実行計画の読み方の基本<a href="#72-実行計画の読み方の基本" class="hash-link" aria-label="7.2 実行計画の読み方の基本 への直接リンク" title="7.2 実行計画の読み方の基本 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   実行計画の読み方                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  EXPLAIN ANALYZE の出力例:                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  HashAggregate  (cost=150..160 rows=100 width=8)            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                  (actual time=5.2..5.5 rows=95 loops=1)     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    Group Key: status                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    -&gt;  Hash Join  (cost=25..140 rows=1000 width=4)          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   (actual time=1.2..4.8 rows=980 loops=1)   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│          Hash Cond: (o.user_id = u.id)                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│          -&gt;  Seq Scan on orders o  (cost=0..50 rows=2000)   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                    (actual time=0.01..1.5)  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│          -&gt;  Hash  (cost=20..20 rows=500 width=4)           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                    (actual time=1.0..1.0 rows=490 loops=1)  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                -&gt;  Seq Scan on users u  (cost=0..20)        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                         (actual time=0.01..0.8)│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                      Filter: (status = &#x27;active&#x27;)             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                      Rows Removed by Filter: 510            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Planning Time: 0.5 ms                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Execution Time: 6.0 ms                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【読み方のポイント】                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. 下から上に読む（実行順序）                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. インデントが深いほど先に実行される                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. cost の actual と estimated を比較                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  4. rows の actual と estimated を比較                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="73-よく見るノードタイプ">7.3 よく見るノードタイプ<a href="#73-よく見るノードタイプ" class="hash-link" aria-label="7.3 よく見るノードタイプ への直接リンク" title="7.3 よく見るノードタイプ への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   主要なノードタイプ                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├─────  ─────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【スキャン系】                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Seq Scan          : 全件スキャン                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Index Scan        : インデックス使用                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Index Only Scan   : インデックスのみで完結                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Bitmap Heap Scan  : ビットマップスキャン                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【結合系】                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Nested Loop       : ネストループ結合                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Hash Join         : ハッシュ結合                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Merge Join        : マージ結合                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【集約系】                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Aggregate         : 集約 (COUNT, SUM等)                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  HashAggregate     : ハッシュを使った GROUP BY               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  GroupAggregate    : ソートを使った GROUP BY                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【ソート・制限】                                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Sort              : ソート処理                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Limit             : 結果行数の制限                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Unique            : 重複排除                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【その他】                                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Materialize       : 中間 結果の具体化                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Subquery Scan     : サブクエリのスキャン                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  CTE Scan          : WITH句のスキャン                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Append            : UNION ALL等の結合                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="74-推定値と実際の値のずれを見る">7.4 推定値と実際の値のずれを見る<a href="#74-推定値と実際の値のずれを見る" class="hash-link" aria-label="7.4 推定値と実際の値のずれを見る への直接リンク" title="7.4 推定値と実際の値のずれを見る への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;active&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                 推定 vs 実際 の比較                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Seq Scan on users  (cost=0.00..25.00 rows=500 width=100)   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                     (actual time=0.01..2.50 rows=2000 loops=1)│</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                 ~~~~       ~~~~              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                               推定500行   実際2000行         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【問題】4倍のずれ                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  原因の可能性:                                               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 統計情報が古い → ANALYZE を実行                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 複雑な条件で推定が難しい                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 相関のあるカラムの組み合わせ                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【影響】                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 行数の推定が大きくずれると、結合アルゴリズムや             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│    スキャン方式の選択を誤る可能性                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 中間結果のメモリ確保が不適切になる                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└────────────────────────────────────────  ──────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="75-buffers出力の読み方">7.5 BUFFERS出力の読み方<a href="#75-buffers出力の読み方" class="hash-link" aria-label="7.5 BUFFERS出力の読み方 への直接リンク" title="7.5 BUFFERS出力の読み方 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFERS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">100</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Index Scan using users_pkey on users  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (cost=0.29..8.30 rows=1 width=100) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  (actual time=0.05..0.06 rows=1 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Index Cond: (id = 100)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Buffers: shared hit=3          ← ここに注目!</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 0.1 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 0.1 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                   BUFFERS の読み方                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  shared hit=3      : 共有バッファ内で見つかった (キャッシュ)  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  shared read=5     : ディスクから読み込んだ                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  shared dirtied=2  : ダーティにしたページ数                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  shared written=1  : 書き込んだページ数                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  local hit/read/dirtied/written : 一時テーブル用             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  temp read/written : 一時ファイル (work_mem超過時)           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【パフォーマンス指標】                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - hit が多い = キャッシュ効率が良い                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - read が多い = I/Oが多い (遅い可能性)                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - temp が出現 = work_mem が不足                             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="8-プランナーの制御とチューニング">8. プランナーの制御とチューニング<a href="#8-プランナーの制御とチューニング" class="hash-link" aria-label="8. プランナーの制御とチューニング への直接リンク" title="8. プランナーの制御とチューニング への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="81-プランナー関連の主要パラメータ">8.1 プランナー関連の主要パラメータ<a href="#81-プランナー関連の主要パラメータ" class="hash-link" aria-label="8.1 プランナー関連の主要パラメータ への直接リンク" title="8.1 プランナー関連の主要パラメータ への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- コストモデル</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> seq_page_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">           </span><span class="token comment" style="color:#999988;font-style:italic">-- シーケンシャル読み取りコスト</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> random_page_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4.0</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">        </span><span class="token comment" style="color:#999988;font-style:italic">-- ランダム読み取りコスト (SSDなら 1.1-1.5)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> cpu_tuple_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">         </span><span class="token comment" style="color:#999988;font-style:italic">-- 行処理コスト</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> cpu_index_tuple_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.005</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- インデックスエントリ処理コスト</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> cpu_operator_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.0025</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- 演算子実行コスト</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- メモリ関連</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> effective_cache_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;4GB&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- OSキャッシュを含めた見積もり</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> work_mem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;64MB&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">             </span><span class="token comment" style="color:#999988;font-style:italic">-- ソート・ハッシュ用メモリ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 並列クエリ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> max_parallel_workers_per_gather </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> parallel_tuple_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> parallel_setup_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000.0</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="82-スキャン方式の制御">8.2 スキャン方式の制御<a href="#82-スキャン方式の制御" class="hash-link" aria-label="8.2 スキャン方式の制御 への直接リンク" title="8.2 スキャン方式の制御 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 特定のスキャン方式を無効化（デバッグ・検証用）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_seqscan </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">       </span><span class="token comment" style="color:#999988;font-style:italic">-- Sequential Scan を避ける</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_indexscan </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">-- Index Scan を避ける</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_indexonlyscan </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"> </span><span class="token comment" style="color:#999988;font-style:italic">-- Index Only Scan を避ける</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_bitmapscan </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">-- Bitmap Scan を避ける</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 実験例: Sequential Scan を避けた場合の計画を見る</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_seqscan </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;active&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_seqscan </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">on</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- 元に戻す</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="83-結合アルゴリズムの制御">8.3 結合アルゴリズムの制御<a href="#83-結合アルゴリズムの制御" class="hash-link" aria-label="8.3 結合アルゴリズムの制御 への直接リンク" title="8.3 結合アルゴリズムの制御 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 結合アルゴリズムを無効化（デバッグ・検証用）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_nestloop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">-- Nested Loop を避ける</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_hashjoin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">      </span><span class="token comment" style="color:#999988;font-style:italic">-- Hash Join を避ける</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_mergejoin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">     </span><span class="token comment" style="color:#999988;font-style:italic">-- Merge Join を避ける</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 実験例: Hash Join を強制</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_nestloop </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> enable_mergejoin </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">off</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users u </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> orders o </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">user_id</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="84-統計情報の調整">8.4 統計情報の調整<a href="#84-統計情報の調整" class="hash-link" aria-label="8.4 統計情報の調整 への直接リンク" title="8.4 統計情報の調整 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- カラムの統計精度を上げる</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">TABLE</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">COLUMN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">STATISTICS</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- デフォルト: 100, 最大: 10000</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 値が大きいほど詳細なヒストグラムが作成される</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- テーブル全体のデフォルト統計精度</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> default_statistics_target </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">200</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 拡張統計（複数カラムの相関）</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">CREATE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">STATISTICS</span><span class="token plain"> stats_name </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> col1</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> col2 </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> table_name</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 統計情報を更新</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"> users</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="85-実践的なチューニング例">8.5 実践的なチューニング例<a href="#85-実践的なチューニング例" class="hash-link" aria-label="8.5 実践的なチュー ニング例 への直接リンク" title="8.5 実践的なチューニング例 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 例1: SSDを使用している環境</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> random_page_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pg_reload_conf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 例2: メモリが潤沢な環境</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> effective_cache_size </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;12GB&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ALTER</span><span class="token plain"> SYSTEM </span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> work_mem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;256MB&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- 注意: 接続数 × work_mem が必要</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> pg_reload_conf</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 例3: 大規模な分析クエリ用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> work_mem </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;1GB&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- セッション単位で変更</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">複雑な集計クエリ</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">RESET work_mem</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- 元に戻す</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 例4: 並列クエリを活用</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> max_parallel_workers_per_gather </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">4</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> parallel_tuple_cost </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0.01</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- 並列処理のコストを下げる</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="9-プランナーが苦手なケース">9. プランナーが苦手なケース<a href="#9-プランナーが苦手なケース" class="hash-link" aria-label="9. プランナーが苦手なケース への直接リンク" title="9. プランナーが苦手なケース へ の直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="91-統計情報の問題">9.1 統計情報の問題<a href="#91-統計情報の問題" class="hash-link" aria-label="9.1 統計情報の問題 への直接リンク" title="9.1 統計情報の問題 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                統計情報が不正確なケース                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ① 大量のデータ変更後にANALYZEしていない                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → 古い統計情報で判断                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     解決: ANALYZE テーブル名;                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ② データの偏りが激しい                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     例: status = &#x27;active&#x27; が 99%, 他は 1%                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     most_common_vals に含まれていれば正確                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     解決: SET STATISTICS を増やす                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ③ 相関のあるカラム                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     例: city と zip_code は連動している                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     解決: CREATE STATISTICS で拡張統計を作成                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ④ 関数の結果                                                │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     例: WHERE LOWER(email) = &#x27;alice@example.com&#x27;             │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → 関数適用後の分布がわからない                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     解決: 式インデックス + ANALYZE                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="92-推定が難しい条件">9.2 推定が難しい条件<a href="#92-推定が難しい条件" class="hash-link" aria-label="9.2 推定が難しい条件 への直接リンク" title="9.2 推定が難しい条件 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- パターン1: パラメータ化されたクエリ (Prepared Statement)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">PREPARE</span><span class="token plain"> user_query </span><span class="token keyword" style="color:#00009f">AS</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">status</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> $</span><span class="token number" style="color:#36acaa">1</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXECUTE</span><span class="token plain"> user_query</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&#x27;active&#x27;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- → $1 の値がわからないので「平均的な」選択性を使う</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">--   generic plan と custom plan の切り替えに注意</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- パターン2: 複雑な式</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> orders </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> total </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1.1</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">AND</span><span class="token plain"> EXTRACT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">YEAR</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> created_at</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">2024</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- → 式の評価後の分布は推定困難</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- パターン3: サブクエリの結果</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> id </span><span class="token operator" style="color:#393A34">IN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> user_id </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> orders </span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> total </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">1000</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- → サブクエリの結果行数の推定が難しい</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- パターン4: OR条件</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> email </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;alice@example.com&#x27;</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">OR</span><span class="token plain"> phone </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;090-1234-5678&#x27;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- → 各条件の選択性を足し算するが、重複を過大評価しやすい</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="93-キャッシュ効果の見積もり">9.3 キャッシュ効果の見積もり<a href="#93-キャッシュ効果の見積もり" class="hash-link" aria-label="9.3 キャッシュ効果の見積もり への直接リンク" title="9.3 キャッシュ効果の見積もり への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              キャッシュ効果の推定の難しさ                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  プランナーは effective_cache_size を参考にするが...         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【実際は予測困難】                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - どのページがキャッシュに載っているか不明                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 同時に実行される他のクエリの影響                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - OSのメモリ圧力                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【結果】                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - 初回実行は遅く、2回目以降は速い（ウォームアップ効果）     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - EXPLAIN ANALYZE の結果と実運用で差が出ることがある        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  【対策】                                                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - pg_prewarm で事前にキャッシュに載せる                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - effective_cache_size を適切に設定                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="94-多テーブル結合の計画時間">9.4 多テーブル結合の計画時間<a href="#94-多テーブル結合の計画時間" class="hash-link" aria-label="9.4 多テーブル結合の計画時間 への直接リンク" title="9.4 多テーブル結合の計画時間 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 多数のテーブルを結合すると計画時間が長くなる</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">*</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> t1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> t2 </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> t1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t1_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> t3 </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> t2</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> t3</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">t2_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- ... 15テーブル以上</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 計画時間 &gt;&gt; 実行時間 になることも</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic">-- 対策</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> geqo_threshold </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- より早くGEQOに切り替え</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> from_collapse_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- サブクエリの平坦化を制限</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SET</span><span class="token plain"> join_collapse_limit </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">8</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain">  </span><span class="token comment" style="color:#999988;font-style:italic">-- 結合順序の探索を制限</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="10-実践的なトラブルシューティング">10. 実践的なトラブルシューティング<a href="#10-実践的なトラブルシューティング" class="hash-link" aria-label="10. 実践的なトラブルシューティング への直接リンク" title="10. 実践的なトラブルシューティング への直接リンク">​</a></h2>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="101-遅いクエリの分析手順">10.1 遅いクエリの分析手順<a href="#101-遅いクエリの分析手順" class="hash-link" aria-label="10.1 遅いクエリの 分析手順 への直接リンク" title="10.1 遅いクエリの分析手順 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                遅いクエリの分析フロー                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Step 1: EXPLAIN ANALYZE で実行計画を取得                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌──────────────────────────────────────────────────────┐   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ EXPLAIN (ANALYZE, BUFFERS, VERBOSE)                  │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ SELECT ...;                                          │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └──────────────────────────────────────────────────────┘   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       │                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       ▼                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Step 2: 推定 vs 実際 の乖離を確認                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌──────────────────────────────────────────────────────┐   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ rows=100 (推定) vs rows=50000 (実際)                 │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ → 統計情報が古いか、推定が難しい条件                 │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └──────────────────────────────────────────────────────┘   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       │                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       ▼                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Step 3: 最も時間がかかっているノードを特定                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  ┌──────────────────────────────────────────────────────┐   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ actual time=0.01..5000.00 ← ここが遅い               │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  │ → このノードの改善を検討                             │   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  └──────────────────────────────────────────────────────┘   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       │                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                       ▼                                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  Step 4: 改善策を実行                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - ANALYZE でstatistics更新                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - インデックスの追加/変更                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - クエリの書き換え                                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  - パラメータのチューニング                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="102-よくある問題と解決策">10.2 よくある問題と解決策<a href="#102-よくある問題と解決策" class="hash-link" aria-label="10.2 よくある問題と解決策 への直接リンク" title="10.2 よくある問題と解決策 への直接リンク">​</a></h3>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────  ────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              問題1: 不適切なスキャン方式                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  症状: インデックスがあるのに Seq Scan が選ばれる            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  原因と対策:                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. 選択性が低い → インデックスより Seq Scan が効率的        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → 意図通りならOK                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. 統計情報が古い                                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → ANALYZE テーブル名;                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. データ型の不一致                                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     WHERE int_column = &#x27;100&#x27; (文字列)                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → 暗黙の型変換でインデックスが使えない                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → WHERE int_column = 100 (数値)                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  4. 関数適用                                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     WHERE UPPER(name) = &#x27;ALICE&#x27;                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     → 式インデックスを作成                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     CREATE INDEX idx ON users (UPPER(name));                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└───────────────────────────────────── ─────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              問題2: 不適切な結合順序                          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  症状: 中間結果が巨大になり、メモリ不足やスワップ            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  確認方法:                                                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  EXPLAIN で各結合ステップの rows を確認                      │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  → 途中で行数が爆発していないか                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  対策:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. 統計情報の更新 (ANALYZE)                                 │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. 結合条件の追加（フィルタを早める）                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. サブクエリや CTE で順序を制御                            │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  4. join_collapse_limit を調整                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│              問題3: ソートやハッシュでのディスク使用          │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────  ────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  症状: BUFFERS に temp read/written が出現                   │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  原因: work_mem を超えたため一時ファイルを使用               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  対策:                                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. work_mem を増やす                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     SET work_mem = &#x27;256MB&#x27;;                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. クエリを分割して中間結果を減らす                         │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. インデックスを活用してソートを回避                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     ORDER BY に合わせたインデックスを作成                    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<h3 class="anchor anchorWithStickyNavbar_LWe7" id="103-実践的な-explain-分析例">10.3 実践的な EXPLAIN 分析例<a href="#103-実践的な-explain-分析例" class="hash-link" aria-label="10.3 実践的な EXPLAIN 分析例 への直接リンク" title="10.3 実践的な EXPLAIN 分析例 への直接リンク">​</a></h3>
<div class="language-sql codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-sql codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token comment" style="color:#999988;font-style:italic">-- 問題のあるクエリ</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">EXPLAIN</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword" style="color:#00009f">ANALYZE</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> BUFFERS</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">SELECT</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">COUNT</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">as</span><span class="token plain"> order_count</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">FROM</span><span class="token plain"> users u</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LEFT</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">JOIN</span><span class="token plain"> orders o </span><span class="token keyword" style="color:#00009f">ON</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> o</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">user_id</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">WHERE</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">created_at </span><span class="token operator" style="color:#393A34">&gt;</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&#x27;2024-01-01&#x27;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">GROUP</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">id</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> u</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">name</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">ORDER</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">BY</span><span class="token plain"> order_count </span><span class="token keyword" style="color:#00009f">DESC</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">LIMIT</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">10</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">Limit  (cost=5000..5000 rows=10 width=40) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">       (actual time=2500..2500 rows=10 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  Buffers: shared hit=100 read=5000, temp read=500 written=500</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      ~~~~~~~~~~~~~~~~~~~~~~~~~~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                      一時ファイル使用！</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  -&gt;  Sort  (cost=4900..5000 rows=50000 width=40) </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">            (actual time=2400..2400 rows=10 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Sort Key: (count(o.id)) DESC</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        Sort Method: external merge  Disk: 4000kB</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     ~~~~~~~~~~~~~~  ~~~~~~~~~~~</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                     ディスクソート！メモリ不足</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        -&gt;  HashAggregate  (cost=3000..4000 rows=50000 width=40)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                           (actual time=1800..2200 rows=50000 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">              -&gt;  Hash Left Join  (cost=1000..2500 rows=100000 width=36)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                  (actual time=500..1500 rows=100000 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -&gt;  Seq Scan on users u  (cost=0..500 rows=50000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                                             (actual time=0..200 rows=50000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          Filter: (created_at &gt; &#x27;2024-01-01&#x27;)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    -&gt;  Hash  (cost=800..800 rows=100000)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                              (actual time=400..400 rows=100000 loops=1)</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                          -&gt;  Seq Scan on orders o</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Planning Time: 1.0 ms</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Execution Time: 2550 ms</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<div class="codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_biex"><pre tabindex="0" class="prism-code language-text codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain">┌──────────────────────────────────────────────────────────────┐</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                     分析結果                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">├──────────────────────────────────────────────────────────────┤</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  問題点:                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. ディスクソートが発生 (Sort Method: external merge)       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. 50000行を集約した後にソート → 非効率                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. users.created_at にインデックスがない可能性              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  改善策:                                                     │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  1. work_mem を増やす                                        │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     SET work_mem = &#x27;128MB&#x27;;                                  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  2. インデックスを作成                                       │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     CREATE INDEX idx_users_created_at ON users(created_at);  │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│  3. LIMIT を活用した書き換え（トップNの最適化）               │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│     - 集約前にフィルタリングを強化                           │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">│                                                              │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">└──────────────────────────────────────────────────────────────┘</span><br></span></code></pre><div class="buttonGroup__atx"><button type="button" aria-label="クリップボードにコードをコピー" title="コピー" class="clean-btn"><span class="copyButtonIcons_eSgA" aria-hidden="true"><svg viewBox="0 0 24 24" class="copyButtonIcon_y97N"><path fill="currentColor" d="M19,21H8V7H19M19,5H8A2,2 0 0,0 6,7V21A2,2 0 0,0 8,23H19A2,2 0 0,0 21,21V7A2,2 0 0,0 19,5M16,1H4A2,2 0 0,0 2,3V17H4V3H16V1Z"></path></svg><svg viewBox="0 0 24 24" class="copyButtonSuccessIcon_LjdS"><path fill="currentColor" d="M21,7L9,19L3.5,13.5L4.91,12.09L9,16.17L19.59,5.59L21,7Z"></path></svg></span></button></div></div></div>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="まとめ">まとめ<a href="#まとめ" class="hash-link" aria-label="まとめ への直接リンク" title="まとめ への直接リンク">​</a></h2>
<p>プランナーを理解することで、以下のことができるようになります：</p>
<table><thead><tr><th>スキル</th><th>活用場面</th></tr></thead><tbody><tr><td>実行計画の読解</td><td>クエリのボトルネック特定</td></tr><tr><td>統計情報の管理</td><td>正確なコスト推定の維持</td></tr><tr><td>インデックス設計</td><td>適切なスキャン方式の選択</td></tr><tr><td>パラメータチューニング</td><td>環境に合わせた最適化</td></tr><tr><td>クエリ書き換え</td><td>プランナーの苦手ケースの回避</td></tr></tbody></table>
<hr>
<h2 class="anchor anchorWithStickyNavbar_LWe7" id="参考リンク">参考リンク<a href="#参考リンク" class="hash-link" aria-label="参考リンク への直接リンク" title="参考リンク への直接リンク">​</a></h2>
<ul>
<li><a href="https://www.postgresql.org/docs/current/sql-explain.html" target="_blank" rel="noopener noreferrer">PostgreSQL EXPLAIN ドキュメント</a></li>
<li><a href="https://www.postgresql.org/docs/current/planner-stats.html" target="_blank" rel="noopener noreferrer">プランナーの使用する統計情報</a></li>
<li><a href="https://www.postgresql.org/docs/current/runtime-config-query.html" target="_blank" rel="noopener noreferrer">クエリ計画</a></li>
<li><a href="https://www.interdb.jp/pg/pgsql03.html" target="_blank" rel="noopener noreferrer">The Internals of PostgreSQL - Query Processing</a></li>
</ul></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col"><a href="https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_11_learning/11-postgresql/dba-08-planner.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>このページを編集</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="ドキュメントページ"><a class="pagination-nav__link pagination-nav__link--prev" href="/idp-server/docs/content_11_learning/postgresql/dba-07-partitioning"><div class="pagination-nav__sublabel">前へ</div><div class="pagination-nav__label">PostgreSQL パーティショニングガイド</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/idp-server/docs/content_11_learning/postgresql/dba-09-extensions"><div class="pagination-nav__sublabel">次へ</div><div class="pagination-nav__label">PostgreSQL 拡張機能（Extensions）ガイド</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#目次" class="table-of-contents__link toc-highlight">目次</a></li><li><a href="#1-プランナーの役割と全体像" class="table-of-contents__link toc-highlight">1. プランナーの役割と全体像</a><ul><li><a href="#11-プランナーとは" class="table-of-contents__link toc-highlight">1.1 プランナーとは</a></li><li><a href="#12-プランナーの処理フロー" class="table-of-contents__link toc-highlight">1.2 プランナーの処理フロー</a></li><li><a href="#13-パスとプラン" class="table-of-contents__link toc-highlight">1.3 「パス」と「プラン」</a></li></ul></li><li><a href="#2-統計情報の仕組み" class="table-of-contents__link toc-highlight">2. 統計情報の仕組み</a><ul><li><a href="#21-統計情報とは" class="table-of-contents__link toc-highlight">2.1 統計情報とは</a></li><li><a href="#22-統計情報の確認方法" class="table-of-contents__link toc-highlight">2.2 統計情報の確認方法</a></li><li><a href="#23-n_distinct-の解釈" class="table-of-contents__link toc-highlight">2.3 n_distinct の解釈</a></li><li><a href="#24-ヒストグラム" class="table-of-contents__link toc-highlight">2.4 ヒストグラム</a></li><li><a href="#25-相関-correlation" class="table-of-contents__link toc-highlight">2.5 相関 (correlation)</a></li><li><a href="#26-統計情報の更新" class="table-of-contents__link toc-highlight">2.6 統計情報の更新</a></li><li><a href="#27-拡張統計情報" class="table-of-contents__link toc-highlight">2.7 拡張統計情報</a></li></ul></li><li><a href="#3-コスト計算モデル" class="table-of-contents__link toc-highlight">3. コスト計算モデル</a><ul><li><a href="#31-コストとは" class="table-of-contents__link toc-highlight">3.1 コストとは</a></li><li><a href="#32-explainで見るコスト" class="table-of-contents__link toc-highlight">3.2 EXPLAINで見るコスト</a></li><li><a href="#33-sequential-scan-のコスト計算" class="table-of-contents__link toc-highlight">3.3 Sequential Scan のコスト計算</a></li><li><a href="#34-index-scan-のコスト計算" class="table-of-contents__link toc-highlight">3.4 Index Scan のコスト計算</a></li><li><a href="#35-コスト比較の例" class="table-of-contents__link toc-highlight">3.5 コスト比較の例</a></li><li><a href="#36-コストパラメータのチューニング" class="table-of-contents__link toc-highlight">3.6 コストパラメータのチューニング</a></li></ul></li><li><a href="#4-スキャン方式の選択" class="table-of-contents__link toc-highlight">4. スキャン方式の選択</a><ul><li><a href="#41-スキャン方式の一覧" class="table-of-contents__link toc-highlight">4.1 スキャン方式の一覧</a></li><li><a href="#42-sequential-scan" class="table-of-contents__link toc-highlight">4.2 Sequential Scan</a></li><li><a href="#43-index-scan" class="table-of-contents__link toc-highlight">4.3 Index Scan</a></li><li><a href="#44-index-only-scan" class="table-of-contents__link toc-highlight">4.4 Index Only Scan</a></li><li><a href="#45-bitmap-scan" class="table-of-contents__link toc-highlight">4.5 Bitmap Scan</a></li><li><a href="#46-スキャン方式の選択基準" class="table-of-contents__link toc-highlight">4.6 スキャン方式の選択基準</a></li></ul></li><li><a href="#5-結合アルゴリズムの選択" class="table-of-contents__link toc-highlight">5. 結合アルゴリズムの選択</a><ul><li><a href="#51-結合アルゴリズムの一覧" class="table-of-contents__link toc-highlight">5.1 結合アルゴリズムの一覧</a></li><li><a href="#52-nested-loop-join" class="table-of-contents__link toc-highlight">5.2 Nested Loop Join</a></li><li><a href="#53-hash-join" class="table-of-contents__link toc-highlight">5.3 Hash Join</a></li><li><a href="#54-merge-join" class="table-of-contents__link toc-highlight">5.4 Merge Join</a></li><li><a href="#55-結合アルゴリズムの選択基準" class="table-of-contents__link toc-highlight">5.5 結合アルゴリズムの選択基準</a></li><li><a href="#56-実行計画での確認例" class="table-of-contents__link toc-highlight">5.6 実行計画での確認例</a></li></ul></li><li><a href="#6-結合順序の最適化" class="table-of-contents__link toc-highlight">6. 結合順序の最適化</a><ul><li><a href="#61-結合順序問題" class="table-of-contents__link toc-highlight">6.1 結合順序問題</a></li><li><a href="#62-結合順序の探索方法" class="table-of-contents__link toc-highlight">6.2 結合順序の探索方法</a></li><li><a href="#63-結合順序に関する設定" class="table-of-contents__link toc-highlight">6.3 結合順序に関する設定</a></li><li><a href="#64-from句の書き方による制御" class="table-of-contents__link toc-highlight">6.4 FROM句の書き方による制御</a></li></ul></li><li><a href="#7-実行計画の読み方" class="table-of-contents__link toc-highlight">7. 実行計画の読み方</a><ul><li><a href="#71-explainの種類" class="table-of-contents__link toc-highlight">7.1 EXPLAINの種類</a></li><li><a href="#72-実行計画の読み方の基本" class="table-of-contents__link toc-highlight">7.2 実行計画の読み方の基本</a></li><li><a href="#73-よく見るノードタイプ" class="table-of-contents__link toc-highlight">7.3 よく見るノードタイプ</a></li><li><a href="#74-推定値と実際の値のずれを見る" class="table-of-contents__link toc-highlight">7.4 推定値と実際の値のずれを見る</a></li><li><a href="#75-buffers出力の読み方" class="table-of-contents__link toc-highlight">7.5 BUFFERS出力の読み方</a></li></ul></li><li><a href="#8-プランナーの制御とチューニング" class="table-of-contents__link toc-highlight">8. プランナーの制御とチューニング</a><ul><li><a href="#81-プランナー関連の主要パラメータ" class="table-of-contents__link toc-highlight">8.1 プランナー関連の主要パラメータ</a></li><li><a href="#82-スキャン方式の制御" class="table-of-contents__link toc-highlight">8.2 スキャン方式の制御</a></li><li><a href="#83-結合アルゴリズムの制御" class="table-of-contents__link toc-highlight">8.3 結合アルゴリズムの制御</a></li><li><a href="#84-統計情報の調整" class="table-of-contents__link toc-highlight">8.4 統計情報の調整</a></li><li><a href="#85-実践的なチューニング例" class="table-of-contents__link toc-highlight">8.5 実践的なチューニング例</a></li></ul></li><li><a href="#9-プランナーが苦手なケース" class="table-of-contents__link toc-highlight">9. プランナーが苦手なケース</a><ul><li><a href="#91-統計情報の問題" class="table-of-contents__link toc-highlight">9.1 統計情報の問題</a></li><li><a href="#92-推定が難しい条件" class="table-of-contents__link toc-highlight">9.2 推定が難しい条件</a></li><li><a href="#93-キャッシュ効果の見積もり" class="table-of-contents__link toc-highlight">9.3 キャッシュ効果の見積もり</a></li><li><a href="#94-多テーブル結合の計画時間" class="table-of-contents__link toc-highlight">9.4 多テーブル結合の計画時間</a></li></ul></li><li><a href="#10-実践的なトラブルシューティング" class="table-of-contents__link toc-highlight">10. 実践的なトラブルシューティング</a><ul><li><a href="#101-遅いクエリの分析手順" class="table-of-contents__link toc-highlight">10.1 遅いクエリの分析手順</a></li><li><a href="#102-よくある問題と解決策" class="table-of-contents__link toc-highlight">10.2 よくある問題と解決策</a></li><li><a href="#103-実践的な-explain-分析例" class="table-of-contents__link toc-highlight">10.3 実践的な EXPLAIN 分析例</a></li></ul></li><li><a href="#まとめ" class="table-of-contents__link toc-highlight">まとめ</a></li><li><a href="#参考リンク" class="table-of-contents__link toc-highlight">参考リンク</a></li></ul></div></div></div></div></main></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/docs/introduction">Documentation</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://stackoverflow.com/questions/tagged/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Stack Overflow<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://discordapp.com/invite/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li><li class="footer__item"><a href="https://x.com/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">X<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/idp-server/blog">Blog</a></li><li class="footer__item"><a href="https://github.com/facebook/docusaurus" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_nPIU"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 My Project, Inc. Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>