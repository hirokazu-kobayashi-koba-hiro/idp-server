# èº«å…ƒç¢ºèªç”³è¾¼ã¿ å°å…¥ã‚¬ã‚¤ãƒ‰

## ğŸ¯ ã“ã®ã‚¬ã‚¤ãƒ‰ã®ç›®çš„

ã“ã®ã‚¬ã‚¤ãƒ‰ã¯ã€`idp-server` ã®èº«å…ƒç¢ºèªç”³è¾¼ã¿ï¼ˆidentity verification applicationï¼‰æ©Ÿèƒ½ã®å®Ÿè£…ãƒ»è¨­å®šãƒ»ãƒ‡ãƒãƒƒã‚°ã«é–¢ã‚ã‚‹é–‹ç™ºè€…ãŒã€
**æœ€çŸ­ã§ã€Œå…¨ä½“åƒã€ã¨ã€Œå®Ÿè£…ãƒã‚¤ãƒ³ãƒˆã€ã‚’æŠŠæ¡**ã—ã€è¿·ã‚ãšé–‹ç™ºã«ç€æ‰‹ã§ãã‚‹ã‚ˆã†ã«ã™ã‚‹ã“ã¨ã‚’ç›®çš„ã¨ã™ã‚‹ã€‚

---

## âœ… ã¾ãšæœ€åˆã«çŸ¥ã‚‹ã¹ãã“ã¨ï¼ˆ5ã¤ï¼‰

| è¦³ç‚¹                          | ä¸€è¨€ã§                                                                                      |
|-----------------------------|------------------------------------------------------------------------------------------|
| 1. **ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆé§†å‹•è¨­è¨ˆ**           | ç”³è¾¼ãƒ­ã‚¸ãƒƒã‚¯ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼ˆJSONï¼‰ã«æ›¸ã„ã¦åˆ¶å¾¡ã•ã‚Œã‚‹ã€‚ã‚³ãƒ¼ãƒ‰ã¯æ›¸ã‹ãªã„ã€‚                                                   |
| 2. **7ã¤ã®ãƒ•ã‚§ãƒ¼ã‚º**              | request / pre_hook / execution / post_hook / transition / store / response ã¨ã„ã†å‡¦ç†ãƒ•ã‚§ãƒ¼ã‚ºãŒã‚ã‚‹ã€‚ |
| 3. **APIã¯å‹•çš„ç”Ÿæˆ**             | `/v1/me/identity-verification/applications/{type}/{process}` ã®ãƒ‘ã‚¹ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¿œã˜ã¦å¤‰ã‚ã‚‹ã€‚          |
| 4. **verified_claimsã¯è‡ªå‹•ç”Ÿæˆ** | eKYCçµæœã«å¿œã˜ã¦IDãƒˆãƒ¼ã‚¯ãƒ³ãªã©ã«verified_claimsãŒå‡ºåŠ›ã•ã‚Œã‚‹ã€‚                                                |
| 5. **å®Ÿè£…ã¯ã€ŒMappingã¨ã®æˆ¦ã„ã€**     | å…¨ã¦ã®å‡¦ç†ã¯ `mapping_rules` ã¨ `transitionæ¡ä»¶` ã®è¨­å®šãŒã‚­ãƒ¢ã«ãªã‚‹ã€‚                                       |

---

## ğŸ—ï¸ æœ€ä½é™æŠŠæ¡ã—ã¦ãŠãæ§‹æˆå›³

```mermaid
graph TD
    subgraph ãƒ¦ãƒ¼ã‚¶ãƒ¼
        U[ãƒ¦ãƒ¼ã‚¶ãƒ¼]
    end
    subgraph ã‚¢ãƒ—ãƒª
        A[SPA or Mobile App]
    end
    subgraph idp-server
        IDP[èº«å…ƒç¢ºèªAPIç¾¤] --> P[ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ ç”³è¾¼ã‚¿ã‚¤ãƒ—ã”ã¨]
    end
    subgraph å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
        KYC[eKYCãƒ™ãƒ³ãƒ€ãƒ¼API]
    end

    U -->|ç”³è¾¼| A -->|APIå‘¼å‡º| IDP
    IDP -->|ä¸­ç¶™| KYC
    KYC -->|callback| IDP
    IDP -->|verified_claims ç™»éŒ²| IDP
    IDP -->|userinfo / id_tokenå‡ºåŠ›| A
```

---

## ğŸ’¡ æœ€åˆã«è§¦ã‚‹ã¹ããƒ•ã‚¡ã‚¤ãƒ«

| ãƒ•ã‚¡ã‚¤ãƒ«å                                                                                             | å½¹å‰²         | ç›®çš„                             |
|---------------------------------------------------------------------------------------------------|------------|--------------------------------|
| `E2Eãƒ†ã‚¹ãƒˆ e2e/src/tests/scenario/application/scenario-05-identity_verification-application.test.js` | å®Ÿè¡Œãƒ†ã‚¹ãƒˆ      | å®Ÿéš›ã®å‹•ä½œãƒ•ãƒ­ãƒ¼ã‚’ç¢ºèªã€‚ãƒ—ãƒ­ã‚»ã‚¹ã®é †ç•ªã‚„ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç¢ºèªã«ä¾¿åˆ© |
| `è¨­å®šãƒ•ã‚¡ã‚¤ãƒ« config-sample/local/admin-tenant/identity/investment-account-opening.json`                | èº«å…ƒç¢ºèªãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆ | èº«å…ƒç¢ºèªã®æµã‚Œãƒ»ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒ»ãƒ«ãƒ¼ãƒ«å…¨éƒ¨ã“ã“ã«æ›¸ã       |

---

## ğŸš¦ ã‚ˆãä½¿ã†é–‹ç™ºTips

### âœ… ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆãƒ»ä¿®æ­£ã®ãƒªãƒ­ãƒ¼ãƒ‰

```bash
# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆä½œæˆ
curl -X POST /v1/management/tenants/{tenant-id}/identity-verification-configurations \
-H "Authorization: Bearer ${ACCESS_TOKEN}" \
-H "Content-Type: application/json" \
-d @template.json

# ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°ï¼ˆHotReloadï¼‰
curl -X PUT /v1/management/tenants/{tenant-id}/identity-verification-configurations/{config-id} \
-H "Authorization: Bearer ${ACCESS_TOKEN}" \
-H "Content-Type: application/json" \
-d @template.json
```

ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’æ›´æ–°ã—ãŸã‚‰**å³æ™‚åæ˜ OKï¼ˆHotReloadï¼‰**ã€‚

---

### âœ… ãƒ­ãƒ¼ã‚«ãƒ«ãƒ­ã‚°ç¢ºèªã®ãƒã‚¤ãƒ³ãƒˆ

- `application_id` ã‚„ `process` ãŒãƒ­ã‚°ã«å‡ºã¦ã‚‹ â†’ è¿½ã„ã‚„ã™ã„
- `application_details` ã«å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æºæƒ…å ±ãŒæ ¼ç´ã•ã‚Œã‚‹ â†’ `external_application_id` ãªã©
- Hookã§å¤±æ•—ã—ãŸã‚‰ `verifications` ã®ä¸­èº«ã‚’è¦ãƒã‚§ãƒƒã‚¯

---

### âœ… ãƒ•ã‚§ãƒ¼ã‚ºã”ã¨ã®ãƒ‡ãƒãƒƒã‚°

| ãƒ•ã‚§ãƒ¼ã‚º         | ãƒã‚§ãƒƒã‚¯ãƒã‚¤ãƒ³ãƒˆ                                               |
|--------------|--------------------------------------------------------|
| `request`    | ã‚¹ã‚­ãƒ¼ãƒã«å¼•ã£ã‹ã‹ã£ã¦ãªã„ã‹ï¼ˆå‹ãƒ»requiredï¼‰                             |
| `pre_hook`   | externalãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¡ã‚ƒã‚“ã¨å–ã‚Œã¦ã‚‹ã‹ï¼ˆãƒ­ã‚°ã« `additional_parameters` å‡ºã‚‹ï¼‰ |
| `execution`  | å¤–éƒ¨APIå‘¼ã°ã‚Œã¦ã‚‹ï¼Ÿãƒ­ã‚° or Mockoonã§ç¢ºèª                            |
| `transition` | æ¡ä»¶ä¸€è‡´ã—ã¦ã‚‹ã‹ï¼Ÿã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒå¤‰ã‚ã£ã¦ã‚‹ï¼Ÿ                                  |
| `store`      | application_details ã«ä¿å­˜ã•ã‚Œã¨ã‚‹ï¼Ÿ                           |
| `response`   | æœŸå¾…ã—ãŸé …ç›®è¿”ã£ã¦ãã¨ã‚‹ï¼Ÿï¼ˆä¾‹ï¼šapplication_idï¼‰                        |

---

## ğŸ§ª é–‹ç™ºã«å…¥ã‚‹å‰ã®ã€Œæœ€çŸ­æº–å‚™ã‚¹ãƒ†ãƒƒãƒ—ã€

1. `POST /identity-verification-configurations` ã§ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’ç™»éŒ²
2. `POST /{tenant-id}/v1/me/identity-verification/applications/{type}/{process}` ã§ç”³è¾¼APIã‚’å®Ÿè¡Œ
   - ä¾‹: `POST /tenant-1/v1/me/identity-verification/applications/investment-account-opening/apply`
3. `Mockoon` ã¾ãŸã¯æ‰‹å‹•ã§ `callback` API ã‚’å©ã
4. ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»ã‚’ç¢ºèª (`GET /applications/{id}`)
5. `userinfo` or `id_token` ã« verified_claims ãŒå…¥ã£ã¦ã„ã‚‹ã‹ç¢ºèª

---

## ğŸ“š MappingRule ã®è¨˜è¼‰æ–¹æ³•

MappingRuleã¯ã€Œã©ã“ã‹ã‚‰ï¼ˆfromï¼‰ã€ã€Œã©ã“ã¸ï¼ˆtoï¼‰ã€ã‚’æŒ‡å®šã™ã‚‹ãƒ«ãƒ¼ãƒ«ã€‚  
pre_hookã€executionã€storeã€responseâ€¦ã‚ã‚‰ã‚†ã‚‹å ´æ‰€ã§å‡ºã¦ãã‚‹è¶…é‡è¦æ§‹æˆï¼

---

### âœ… åŸºæœ¬æ§‹æ–‡

```json
{
  "from": "$.request_body.email",
  "to": "user_email"
}
```

| é …ç›®å            | èª¬æ˜                                                                                                                                          |
|----------------|---------------------------------------------------------------------------------------------------------------------------------------------|
| `from`         | å–å¾—å…ƒã‚’ [JsonPath](https://github.com/json-path/JsonPath) ã§æŒ‡å®š                                                                                 |
| `to`           | ã‚»ãƒƒãƒˆå…ˆã‚­ãƒ¼åã€‚`.`åŒºåˆ‡ã‚Šã§ãƒã‚¹ãƒˆå¯èƒ½ã€`*`æŒ‡å®šã§ãƒãƒ¼ã‚¸å±•é–‹ã‚‚å¯èƒ½                                                                                                        |
| `static_value` | å®šæ•°ã‚’ä½¿ã„ãŸã„ã¨ãã«æŒ‡å®šï¼ˆfrom ã®ä»£ã‚ã‚Šã«ï¼‰                                                                                                                   |
| `functions`    | å€¤å¤‰æ›é–¢æ•°ã®ãƒªã‚¹ãƒˆã€‚`convert_type`é–¢æ•°ã§å‹å¤‰æ›å¯èƒ½ã€‚<br />ã‚µãƒãƒ¼ãƒˆå‹: `string`, `integer`, `long`, `double`, `boolean`, `datetime` |

> ğŸ’¡ `from` or `static_value` ã®ã©ã¡ã‚‰ã‹ã¯å¿…é ˆã€‚ä¸¡æ–¹æœªæŒ‡å®šã¯ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ï¼

---

### ğŸ§ª ä¾‹1ï¼šãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰ãã®ã¾ã¾è»¢é€

```json
{
  "from": "$.request_body.given_name",
  "to": "claims.given_name"
}
```

---

### ğŸ§ª ä¾‹2ï¼šå®šæ•°ã‚’ã‚»ãƒƒãƒˆï¼ˆstatic_valueï¼‰

```json
{
  "static_value": "jp_aml",
  "to": "verification.trust_framework"
}
```

---

### ğŸ§ª ä¾‹3ï¼šãƒã‚¹ãƒˆã•ã‚ŒãŸé…åˆ—è¦ç´ ã‚’æŒ‡å®š

```json
{
  "from": "$.request_body.verification.evidence[0].type",
  "to": "verification.evidence.0.type"
}
```

---

### ğŸ§ª ä¾‹4ï¼šãƒãƒ¼ã‚¸ã—ã¦å±•é–‹ï¼ˆ`*`ï¼‰

```json
{
  "from": "$.request_body",
  "to": "*"
}
```

â†’ request_body ã®ä¸­èº«ã‚’ãƒ•ãƒ©ãƒƒãƒˆã«ãƒãƒ¼ã‚¸ã—ã¦å…¨é …ç›®å±•é–‹ï¼

---

### ğŸ§ª ä¾‹5ï¼šå‹å¤‰æ›ã‚’æŒ‡å®š

```json
{
  "from": "$.application.application_details.score",
  "to": "risk_score",
  "functions": [
    {
      "name": "convert_type",
      "args": {
        "type": "integer"
      }
    }
  ]
}
```

---

### ğŸ§­ ã‚ˆãä½¿ã†ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«å‚ç…§å…ƒ

| å‚ç…§å…ƒã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå              | èª¬æ˜                                  |
|-------------------------|-------------------------------------|
| `request_body`          | ç”»é¢ã‹ã‚‰æ¥ãŸç”³è«‹ãƒ‡ãƒ¼ã‚¿                         |
| `request_attributes`    | ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚ã®ãƒ˜ãƒƒãƒ€ãƒ¼ã‚„èªè¨¼æƒ…å ±ãªã©                  |
| `user`                  | ç¾åœ¨ã®ãƒ­ã‚°ã‚¤ãƒ³ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®å±æ€§æƒ…å ±ï¼ˆ`sub`, `email` ãªã©ï¼‰ |
| `application`           | ç¾åœ¨é€²è¡Œä¸­ã®ç”³è¾¼ãƒ‡ãƒ¼ã‚¿ï¼ˆéå»ã®å…¥åŠ›å†…å®¹ï¼‰                |
| `additional_parameters` | pre_hook ã‚„ post_hook ã§å–å¾—ã—ãŸå€¤         |
| `response_body`         | executionã§å¤–éƒ¨APIå‘¼ã‚“ã æ™‚ã®æˆ»ã‚Šå€¤             |

---

### ğŸ§© MappingãŒä½¿ã‚ã‚Œã‚‹ä»£è¡¨ãƒ•ã‚§ãƒ¼ã‚º

| ãƒ•ã‚§ãƒ¼ã‚ºå       | ç”¨é€”                                   |
|-------------|--------------------------------------|
| `pre_hook`  | å–å¾—ã—ãŸå¤–éƒ¨ãƒ‡ãƒ¼ã‚¿ã®æ•´å½¢                         |
| `execution` | å¤–éƒ¨APIã«é€ã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®ç”Ÿæˆ                     |
| `store`     | application_details ã®æ§‹ç¯‰              |
| `response`  | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã«è¿”ã™ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ                     |
| `result`    | verified_claims / source_details ã®ç”Ÿæˆ |

---

### ğŸ“ è£œè¶³Tips

- `from` ã¨ `to` ã®å€¤ã®å‹ãŒåˆã£ã¦ãªã„ã¨ã€å®Ÿè¡Œæ™‚ã«ã‚¯ãƒ©ãƒƒã‚·ãƒ¥ã™ã‚‹ã“ã¨ãŒã‚ã‚‹
- `convert_type` ã‚’å¿˜ã‚Œã‚‹ã¨ `"123"`ï¼ˆæ–‡å­—åˆ—ï¼‰â†’ `123`ï¼ˆæ•°å€¤ï¼‰ã«ãªã‚‰ãšã«ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹
- `to` ã« `"*"` ã‚’ä½¿ã†ã¨ãƒãƒ¼ã‚¸ã•ã‚Œã‚‹ãŒã€ã‚­ãƒ¼åãŒã‹ã¶ã‚‹ã¨ **å¾Œå‹ã¡ï¼ˆä¸Šæ›¸ãï¼‰**

## ğŸ ãŠã¾ã‘ï¼šç†è§£åº¦ãƒã‚§ãƒƒã‚¯

- [ ] `processes` ã«å®šç¾©ã•ã‚Œã‚‹7ãƒ•ã‚§ãƒ¼ã‚ºã‚’ã™ãè¨€ãˆã‚‹ï¼Ÿ
- [ ] `from` â†’ `to` ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«æ›¸ã‘ã‚‹ï¼Ÿ
- [ ] ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆæ›´æ–°æ™‚ã®HotReloadæ–¹æ³•ã‚ã‹ã‚‹ï¼Ÿ
- [ ] `callback-result` ã§ verified_claims ã«ç¹‹ãŒã‚‹æ¡ä»¶ã‚ã‹ã‚‹ï¼Ÿ
- [ ] ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ `applying` â†’ `examination_processing` â†’ `approved` ã®æµã‚Œã‚ã‹ã‚‹ï¼Ÿ
