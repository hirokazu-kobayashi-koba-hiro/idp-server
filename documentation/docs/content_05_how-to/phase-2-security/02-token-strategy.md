# トークン有効期限パターン

## このドキュメントの目的

**トークン有効期限の戦略を理解し、サービスに適したパターンを選択・設定する**ことが目標です。

### 学べること

✅ **トークン戦略の基礎**
- 4つのトークン有効期限パターンの違い
- セキュリティと利便性のトレードオフ
- 各パターンの推奨ユースケース

✅ **実践的な知識**
- Management APIでの設定方法
- デフォルト設定の理解

### 所要時間
⏱️ **約10分**

### 前提条件
- [how-to-02](../phase-1-foundation/03-tenant-setup.md)でテナント作成完了
- 認可サーバー設定の基本理解

---

## トークン有効期限パターンの概要

アクセストークンおよびリフレッシュトークンの有効期限管理には、主に以下の4つのパターンがあります。それぞれの特徴は、セキュリティと利便性のバランスに応じて選択してください。

| パターン        | 概要                                 | 推奨度   |
|:------------|:-----------------------------------|:------|
| ローテーション＋固定  | セキュリティ重視。長期利用は不可。**セキュアな実装のため推奨**。 | ◎ 推奨  |
| ローテーション＋延長  | セキュリティ・利便性ともに高い。                   | ○ 選択可 |
| 非ローテーション＋固定 | 利便性重視。ただし、セキュリティリスクがある。                  | △ 注意  |
| 非ローテーション＋延長 | 利便性重視。ただし、セキュリティリスクがある。             | △ 注意  |

---

## 各パターンの詳細

アクセストークン（AT）有効期限：30分
リフレッシュトークン（RT）有効期限：60分
における各パターンの有効期限の詳細を説明します。

### 1. ローテーション＋固定パターン（◎ 推奨）

リフレッシュトークンはローテーションされますが、有効期限は「初回発行時点から固定」で延長されません。  
セキュリティを最重視したい場合に推奨される実装パターンです。

```mermaid
gantt
    title ローテーション＋固定（リフレッシュトークン都度発行）
    dateFormat HH:mm
    axisFormat %H:%M
    section アクセストークン
        AT-1 (初回発行): a1, 00:00, 30m
        AT-2 (RT-1より発行): a2, 00:30, 30m
        AT-3 (RT-2より発行): a3, 01:00, 30m
    section リフレッシュトークン
        RT-1: r1, 00:00, 60m
        RT-2: r2, 00:30, 30m
        RT-3: r3, 01:00, 00m
```

- リフレッシュトークン自体の有効期限は延長されない
- 有効期間満了後は再認証が必要
- セキュリティを最重視するサービスに最適

---

### 2. ローテーション＋延長パターン（○ 選択可）

リフレッシュトークンを使ってトークンを再発行するたびに、新しいリフレッシュトークンが発行され、その有効期限も「今」から再度延長されます。  
セッションが続く限り、ログイン状態を長期間維持できます。FAPI等で採用例あり。

```mermaid
gantt
    title ローテーション＋延長（リフレッシュトークン都度発行）
    dateFormat HH:mm
    axisFormat %H:%M
    section アクセストークン
        AT-1 (初回発行): a1, 00:00, 30m
        AT-2 (RT-1より発行): a2, 00:30, 30m
        AT-3 (RT-2より発行): a3, 01:00, 30m
    section リフレッシュトークン
        RT-1: r1, 00:00, 60m
        RT-2: r2, 00:30, 60m
        RT-3: r3, 01:00, 60m
```

- リフレッシュトークンを使うたび、有効期限が「今」から再延長される
- 古いトークンセット（アクセストークン・リフレッシュトークン）は無効化される

---

### 3. 非ローテーション＋固定パターン（△ 注意）

リフレッシュトークンはローテーションせず、かつ有効期限も「初回発行時点から固定」です。

```mermaid
gantt
    title 非ローテーション＋固定パターン
    dateFormat HH:mm
    axisFormat %H:%M
    section アクセストークン
        AT-1 (初回発行): a1, 00:00, 30m
        AT-2 (RT-1より発行): a2, 00:30, 30m
        AT-3 (RT-1より発行): a3, 01:00, 30m
    section リフレッシュトークン
        RT-1: r1, 00:00, 60m
        RT-1: r2, 00:30, 30m
        RT-1: r3, 01:00, 00m
```

- リフレッシュトークンはずっと同じで、有効期限も初回発行時から変わらない
- 有効期限切れ後は再認証が必須
- セキュリティリスクが比較的高い

---

### 4. 非ローテーション＋延長パターン（△ 注意）

リフレッシュトークン自体はローテーションせず、最初に発行されたものをずっと使い続けます。  
ただし、トークンを再発行するたびにリフレッシュトークンの有効期限が延長されます。

```mermaid
gantt
    title 非ローテーション×有効期限延長パターン
    dateFormat HH:mm
    axisFormat %H:%M
    section アクセストークン
        AT-1 (初回発行): a1, 00:00, 30m
        AT-2 (RT-1より発行): a2, 00:30, 30m
        AT-3 (RT-1より発行): a3, 01:00, 30m
    section リフレッシュトークン
        RT-1: r1, 00:00, 60m
        RT-1: r2, 00:30, 60m
        RT-1: r3, 01:00, 60m
```

- 使うリフレッシュトークンは常に同じ
- トークン再発行のたびにそのリフレッシュトークンの有効期限が延長される
- セキュリティリスクが比較的高い

---

## 設定方法

各パターンは以下の2つの設定項目で制御します：

| 設定項目                    | 説明                         | 設定値                      | デフォルト    |
|:------------------------|:---------------------------|:-------------------------|:---------|
| `refresh_token_strategy` | リフレッシュトークンの有効期限戦略          | `"FIXED"` / `"EXTENDS"`  | `"FIXED"` |
| `rotate_refresh_token`   | リフレッシュトークンのローテーション有無 | `true` / `false`         | `true`    |

### パターン別設定

| パターン           | `refresh_token_strategy` | `rotate_refresh_token` |
|:---------------|:-------------------------|:-----------------------|
| ローテーション＋固定（◎推奨） | `"FIXED"`                | `true`                 |
| ローテーション＋延長     | `"EXTENDS"`              | `true`                 |
| 非ローテーション＋固定    | `"FIXED"`                | `false`                |
| 非ローテーション＋延長    | `"EXTENDS"`              | `false`                |

### Management API での設定例

```bash
curl -X PUT https://idp-server/v1/management/tenants/{tenant-id}/authorization-server \
  -H "Content-Type: application/json" \
  -d '{
    "extension": {
      "refresh_token_strategy": "FIXED",
      "rotate_refresh_token": true,
      "refresh_token_duration": 3600
    }
  }'
```

### デフォルト設定

設定を省略した場合、最もセキュアな **ローテーション＋固定パターン** が適用されます：
- `refresh_token_strategy`: `"FIXED"`
- `rotate_refresh_token`: `true`

---

## まとめ

要件やセキュリティレベルに応じて、最適なトークン管理方式を選択してください。
**特にセキュリティを重視する場合、「ローテーション＋固定」パターンを強く推奨します。**