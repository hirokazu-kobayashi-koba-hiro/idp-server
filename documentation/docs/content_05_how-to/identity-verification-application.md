# èº«å…ƒç¢ºèªç”³è¾¼ã¿

## æ¦‚è¦

`idp-server` ã¯èº«å…ƒç¢ºèªæ¸ˆã¿IDï¼ˆverified IDï¼‰ã‚’æä¾›ã™ã‚‹ã«ã‚ãŸã‚Šã€ **ç”³è¾¼ã¿ãƒ»å¯©æŸ»ãƒ»å®Œäº†ç™»éŒ²**ã®ä¸€é€£ã®ç”³è¾¼ã¿ã‚’ç®¡ç†ã§ãã¾ã™ã€‚
å¤–éƒ¨ã®ã‚µãƒ¼ãƒ“ã‚¹ã¨é€£æºã‚‚å¯èƒ½ã§ã™ã€‚

ç”³è¾¼ã¿æ©Ÿèƒ½ã¯ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆå½¢å¼ã§æŸ”è»Ÿã«å®šç¾©å¯èƒ½ã§ã€ç”³è¾¼ã¿ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ»å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æºãƒ»ãƒ‡ãƒ¼ã‚¿å¤‰æ›ãªã©ã«å¯¾å¿œã—ã¦ã„ã¾ã™ã€‚

## åˆ©ç”¨æ–¹æ³•

1. `Control Plane API` ã‚’ä½¿ã£ã¦ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚’äº‹å‰ã«ç™»éŒ²ã™ã‚‹ã€‚
2. ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¿œã˜ã¦èº«å…ƒç¢ºèªAPIãŒåˆ©ç”¨å¯èƒ½ã«ãªã‚‹ã€‚
3. ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç”³è¾¼ã¿æ“ä½œã‚’å®Ÿè¡Œã™ã‚‹ã¨ã€å®šç¾©æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¾“ã£ã¦ç”³è¾¼ã¿å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
4. å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚‚åŒæ§˜ã«ã€å®šç¾©æ¸ˆã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã«å¾“ã£ã¦å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹ã€‚
5. èº«å…ƒç¢ºèªãŒå®Œäº†ã™ã‚‹ã¨ `verified_claims` ã‚’ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ã‘ã¦æ°¸ç¶šåŒ–ã™ã‚‹ã€‚
6. IDãƒˆãƒ¼ã‚¯ãƒ³ã‚„UserInfoã« `verified_claims` ã‚’å«ã‚ã‚‹ã“ã¨ãŒã§ãã‚‹ã€‚

â€» å¤–éƒ¨èº«å…ƒç¢ºèªã‚µãƒ¼ãƒ“ã‚¹ã®APIä»•æ§˜ã«åˆã‚ã›ã¦ã€æŸ”è»Ÿã« `idp-server` ã®å„ç”³è¾¼ã®ãƒ—ãƒ­ã‚»ã‚¹ã®è¨­å®šã‚’è¨­å®šã™ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚

## ç”³è¾¼ã¿ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®è¨­å®šé …ç›®

| é …ç›®           | å†…å®¹                                          | å¿…é ˆ |
|--------------|---------------------------------------------|----|
| `id`         | ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®UUID                                 | âœ…ï¸ |
| `type`       | ç”³è¾¼ã¿ç¨®åˆ¥ï¼ˆä¾‹: `investment-account-opening`ï¼‰      | âœ…ï¸ |
| `common`     | å…±é€šè¨­å®šã€‚å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã€‚å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ç”³è¾¼ID             | -  |
| `processes`  | ç”³è¾¼ã¿ãƒ—ãƒ­ã‚»ã‚¹ã€‚ä¸€é€£ã®èº«å…ƒç¢ºèªã®ãƒ—ãƒ­ã‚»ã‚¹ã‚’å®šç¾©ã™ã‚‹ã€‚è¤‡æ•°ç™»éŒ²å¯èƒ½            | âœ…ï¸ |
| `result`     | `verified_claims` `source_details` ã®ãƒãƒƒãƒ”ãƒ³ã‚°å®šç¾© | -  |
| `attributes` | ç”³è¾¼å‚ç…§APIã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã«å«ã‚ã‚‹å±æ€§æƒ…å ±ã€‚                      | -  |

## ç”³è¾¼ã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹

èº«å…ƒç¢ºèªç”³è¾¼ã¿ã¯ã€ç”³è«‹ã®å—ä»˜ã‹ã‚‰æ‰¿èªãƒ»å¦èªã«è‡³ã‚‹ã¾ã§è¤‡æ•°ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’çµŒç”±ã—ã¾ã™ã€‚
æœ¬é …ã§ã¯ã€å„ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã®æ„å‘³ã¨ä»£è¡¨çš„ãªåˆ©ç”¨ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã«ã¤ã„ã¦è§£èª¬ã—ã¾ã™ã€‚

ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã¯ã€ç”³è¾¼ã¿å‡¦ç†ã®é€²è¡ŒçŠ¶æ³ã‚’è¡¨ã™ã‚‚ã®ã§ã‚ã‚Šã€ç”³è¾¼ã¿ä¸€è¦§ç”»é¢ã‚„è©³ç´°ç”»é¢ã§ã®è¡¨ç¤ºãªã©ã§ã”åˆ©ç”¨ã—ã¦ãã ã•ã„ã€‚

ä»¥ä¸‹ã¯ã€ç”³è¾¼ã¿ã«ãŠã‘ã‚‹ä»£è¡¨çš„ãªã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ä¸€è¦§ã¨ãã®èª¬æ˜ã§ã™ã€‚

| ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹å                   | èª¬æ˜                                                             |
|--------------------------|----------------------------------------------------------------|
| `requested`              | ç”³è«‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãŒæ­£å¸¸ã«å—ç†ã•ã‚ŒãŸç›´å¾Œã®çŠ¶æ…‹ã§ã™ã€‚                                       |
| `applying`               | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯å¤–éƒ¨ã‚·ã‚¹ãƒ†ãƒ ãŒå¿…è¦ãªæƒ…å ±ã‚’å…¥åŠ›ãƒ»åé›†ä¸­ã®çŠ¶æ…‹ã§ã™ã€‚ãƒ•ã‚©ãƒ¼ãƒ å…¥åŠ›ä¸­ã‚„è¿½åŠ æ›¸é¡ã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾…ã¡ãªã©ãŒè©²å½“ã—ã¾ã™ã€‚ |
| `examination_processing` | ç”³è«‹å†…å®¹ã«å¯¾ã™ã‚‹å¯©æŸ»ãŒå®Ÿæ–½ã•ã‚Œã¦ã„ã‚‹çŠ¶æ…‹ã§ã™ã€‚å¤–éƒ¨eKYCã‚µãƒ¼ãƒ“ã‚¹ã¨ã®é€£æºã‚„äººæ‰‹ã«ã‚ˆã‚‹å¯©æŸ»ãŒè¡Œã‚ã‚Œã¦ã„ã‚‹å ´åˆã‚‚å«ã¾ã‚Œã¾ã™ã€‚  |
| `approved`               | å¯©æŸ»ã®çµæœã€ç”³è«‹ãŒæ‰¿èªã•ã‚ŒãŸçŠ¶æ…‹ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èº«å…ƒç¢ºèªãŒå®Œäº†ã—ã€æ¤œè¨¼æ¸ˆã¿ã‚¯ãƒ¬ãƒ¼ãƒ ã®ç™»éŒ²ãªã©ãŒè¡Œã‚ã‚Œã¾ã™ã€‚          |
| `rejected`               | å¯©æŸ»ã®çµæœã€ç”³è«‹ãŒå´ä¸‹ã•ã‚ŒãŸçŠ¶æ…‹ã§ã™ã€‚å¿…è¦ã«å¿œã˜ã¦ç†ç”±ã®æç¤ºã‚„å†ç”³è«‹ã®å°ç·šæç¤ºãŒæ¨å¥¨ã•ã‚Œã¾ã™ã€‚                |
| `expired`                | æœ‰åŠ¹æœŸé™åˆ‡ã‚Œãªã©ã«ã‚ˆã‚Šã€ç”³è«‹ãŒç„¡åŠ¹ã¨ãªã£ãŸçŠ¶æ…‹ã§ã™ã€‚ä¸€å®šæœŸé–“æ“ä½œãŒè¡Œã‚ã‚Œãªã‹ã£ãŸå ´åˆãªã©ã«è‡ªå‹•çš„ã«é·ç§»ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚  |
| `cancelled`              | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ç®¡ç†è€…ã«ã‚ˆã£ã¦ç”³è«‹ãŒä»»æ„ã«ä¸­æ–­ã•ã‚ŒãŸçŠ¶æ…‹ã§ã™ã€‚å–ã‚Šä¸‹ã’ã‚„ã‚­ãƒ£ãƒ³ã‚»ãƒ«æ“ä½œãªã©ãŒè©²å½“ã—ã¾ã™ã€‚            |
| `unknown`                | çŠ¶æ…‹ãŒç‰¹å®šã§ããªã„ä¸æ˜ãªçŠ¶æ…‹ã§ã™ã€‚ç§»è¡Œä¸­ã‚„ãƒ‡ãƒ¼ã‚¿ä¸æ•´åˆã€ãƒãƒ¼ã‚¸ãƒ§ãƒ³å·®ç•°ç­‰ã«ã‚ˆã‚Šä¾‹å¤–çš„ã«ç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚       |

## ç”³è¾¼APIã®ãƒ‘ã‚¹ã®å‹•çš„è¨­å®š

èº«å…ƒç¢ºèªç”³è¾¼ã¿APIã¯ã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®processeså®šç¾©ã®åŸºã¥ã„ã¦ã€ãƒ†ãƒŠãƒ³ãƒˆå˜ä½ã§å‹•çš„ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã•ã‚Œã‚‹ä»•çµ„ã¿ã«ãªã£ã¦ã„ã¾ã™ã€‚

APIã®ãƒ‘ã‚¹ã® verification-type ã¨ process ãŒã€ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã® "type" ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã¨ "processes"
ã«å®šç¾©ã•ã‚ŒãŸã‚­ãƒ¼ã«ã‚ˆã‚Šçµ„ã¿ç«‹ã¦ã‚‰ã‚Œã¾ã™ã€‚

â€»ãƒ†ãƒŠãƒ³ãƒˆé–“ã§è¨­å®šã¯å…±æœ‰ã•ã‚Œã¾ã›ã‚“ã€‚ãŸã ã—ã€åˆ¥ãƒ†ãƒŠãƒ³ãƒˆã«åŒä¸€ã®è¨­å®šã‚’é©ç”¨ã™ã‚‹ã“ã¯å¯èƒ½ã€‚

**ã‚¢ãƒ—ãƒªã‹ã‚‰ã®ç”³è¾¼ã¿ç”¨API**

```
åˆå›ç”³è¾¼ã¿
POST /{tenant-id}/v1/me/identity-verification/applications/{verification-type}/{process}
â€»ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦

å¾Œç¶šå‡¦ç†
POST /{tenant-id}/v1/me/identity-verification/applications/{verification-type}/{id}/{process}
â€»ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦

ç”³è¾¼ã¿ä¸€è¦§å–å¾—
GET /{tenant-id}/v1/me/identity-verification/applications
â€»ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦
â€»ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿: type, status, limit, offset

ç”³è¾¼ã¿å‰Šé™¤
DELETE /{tenant-id}/v1/me/identity-verification/applications/{verification-type}/{id}
â€»ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦

æ¤œè¨¼çµæœå–å¾—
GET /{tenant-id}/v1/me/identity-verification/results
â€»ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ãŒå¿…è¦
â€»æ¤œè¨¼æ¸ˆã¿ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆverified_claimsï¼‰ã®å–å¾—
```

### APIã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆè©³ç´°

#### ç”³è¾¼ã¿ä¸€è¦§å–å¾— API
- **ãƒ‘ã‚¹**: `GET /{tenant-id}/v1/me/identity-verification/applications`
- **èªè¨¼**: ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å¿…é ˆ
- **ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿**:
  - `type` (optional): ç”³è¾¼ã¿ç¨®åˆ¥ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
  - `status` (optional): ç”³è¾¼ã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã§ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°ï¼ˆrequested, applying, examination_processing, approved, rejected, expired, cancelledï¼‰
  - `limit` (optional): å–å¾—ä»¶æ•°åˆ¶é™ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 20ï¼‰
  - `offset` (optional): å–å¾—é–‹å§‹ä½ç½®ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 0ï¼‰

#### ç”³è¾¼ã¿å‰Šé™¤ API
- **ãƒ‘ã‚¹**: `DELETE /{tenant-id}/v1/me/identity-verification/applications/{verification-type}/{id}`
- **èªè¨¼**: ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å¿…é ˆ
- **èª¬æ˜**: ç”³è¾¼ã¿ã®å‰Šé™¤ã¾ãŸã¯å–ã‚Šä¸‹ã’å‡¦ç†ã€‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ãŒcancelledã«å¤‰æ›´ã•ã‚Œã‚‹

#### æ¤œè¨¼çµæœå–å¾— API
- **ãƒ‘ã‚¹**: `GET /{tenant-id}/v1/me/identity-verification/results`
- **èªè¨¼**: ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³å¿…é ˆ
- **ãƒ¬ã‚¹ãƒãƒ³ã‚¹**: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«ç´ã¥ãæ¤œè¨¼æ¸ˆã¿ã‚¯ãƒ¬ãƒ¼ãƒ ï¼ˆverified_claimsï¼‰ã¨ãã®è©³ç´°æƒ…å ±

[ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ç”¨ã®APIä»•æ§˜ï¼ˆèº«å…ƒç¢ºèªé–¢é€£ã®ç”³è¾¼ã¿APIã‚’å«ã‚€ï¼‰](api-resource-owner-ja)

**å¯©æŸ»çµæœã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯API**

```
å¯©æŸ»çµæœã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
POST /{tenant-id}/internal/v1/identity-verification/callback/{verification-type}/{process}
â€»ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã®commonã¸ã®è¨­å®šãŠã‚ˆã³ã€ç”³è¾¼ã¿è©³ç´°(application_details)ã‹ã‚‰ç”³è¾¼ã¿ã‚’ç‰¹å®šã§ãã‚‹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å«ã‚ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

{
 "id": "UUID",
 "type": "investment-account-opening"
 "common": {
    "external_service": "mocky",
    "callback_application_id_param": "application_id"
  },
  "processes": {},
  "result: {}
}

å¯©æŸ»çµæœã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯
POST /{tenant-id}/internal/v1/identity-verification/callback/{verification-type}/{id}/{process}

```

[å¤–éƒ¨ã‚¹ãƒ†ãƒ é€£æºç”¨ã‚¤ãƒ³ã‚¿ãƒ¼ãƒŠãƒ«APIä»•æ§˜ï¼ˆèº«å…ƒç¢ºèªé–¢é€£ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯APIã‚’å«ã‚€ï¼‰](api-internal-ja)

## æ¡ä»¶ä»˜ãå®Ÿè¡Œæ©Ÿèƒ½ (Conditional Execution)

èº«å…ƒç¢ºèªã®pre_hookã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆï¼ˆæ¤œè¨¼ã¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è§£æ±ºï¼‰ã«æ¡ä»¶ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã«å¿œã˜ã¦å®Ÿè¡Œã‚’åˆ¶å¾¡ã§ãã¾ã™ã€‚

### æ¦‚è¦

æ¡ä»¶ä»˜ãå®Ÿè¡Œæ©Ÿèƒ½ã«ã‚ˆã‚Šã€ä»¥ä¸‹ã®åˆ©ç‚¹ãŒã‚ã‚Šã¾ã™ï¼š

- **ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æœ€é©åŒ–**: ä¸è¦ãªå‡¦ç†ã‚’ã‚¹ã‚­ãƒƒãƒ—
- **æŸ”è»Ÿãªåˆ¶å¾¡**: ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã‚„ç”³è¾¼ã¿å†…å®¹ã«å¿œã˜ãŸå‹•çš„ãªå‡¦ç†
- **ã‚³ã‚¹ãƒˆå‰Šæ¸›**: å¤–éƒ¨APIå‘¼ã³å‡ºã—ã®æœ€é©åŒ–
- **ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Š**: ãƒªã‚¹ã‚¯ãƒ™ãƒ¼ã‚¹ã®èªè¨¼åˆ¶å¾¡

### è¨­å®šæ–¹æ³•

pre_hookã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã« `condition` ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ ã—ã¾ã™ï¼š

```json
{
  "pre_hook": {
    "verifications": [
      {
        "type": "user_claim",
        "details": { ... },
        "condition": {
          "operation": "eq",
          "path": "$.user.role",
          "value": "admin"
        }
      }
    ],
    "additional_parameters": [
      {
        "type": "http_request",
        "details": { ... },
        "condition": {
          "operation": "gte",
          "path": "$.request.amount",
          "value": 10000
        }
      }
    ]
  }
}
```

### æ¡ä»¶æ¼”ç®—å­

| æ¼”ç®—å­ | èª¬æ˜ | ä¾‹ |
|-------|------|---|
| `eq` | ç­‰ã—ã„ | `{"operation": "eq", "path": "$.user.role", "value": "admin"}` |
| `ne` | ç­‰ã—ããªã„ | `{"operation": "ne", "path": "$.user.status", "value": "suspended"}` |
| `gt` | ã‚ˆã‚Šå¤§ãã„ | `{"operation": "gt", "path": "$.request.amount", "value": 1000}` |
| `gte` | ä»¥ä¸Š | `{"operation": "gte", "path": "$.user.age", "value": 18}` |
| `lt` | ã‚ˆã‚Šå°ã•ã„ | `{"operation": "lt", "path": "$.risk_score", "value": 50}` |
| `lte` | ä»¥ä¸‹ | `{"operation": "lte", "path": "$.retry_count", "value": 3}` |
| `in` | å«ã¾ã‚Œã‚‹ | `{"operation": "in", "path": "$.user.region", "value": ["US", "EU"]}` |
| `nin` | å«ã¾ã‚Œãªã„ | `{"operation": "nin", "path": "$.user.status", "value": ["banned", "suspended"]}` |
| `exists` | å­˜åœ¨ã™ã‚‹ | `{"operation": "exists", "path": "$.user.verified"}` |
| `missing` | å­˜åœ¨ã—ãªã„ | `{"operation": "missing", "path": "$.user.temp_flag"}` |
| `contains` | æ–‡å­—åˆ—ã‚’å«ã‚€ | `{"operation": "contains", "path": "$.user.email", "value": "@company.com"}` |
| `regex` | æ­£è¦è¡¨ç¾ | `{"operation": "regex", "path": "$.user.phone", "value": "^\\+81"}` |

### è¤‡åˆæ¼”ç®—å­ã«ã‚ˆã‚‹æ¡ä»¶ã®çµ„ã¿åˆã‚ã›

`allOf`ã¨`anyOf`ã¯**è¤‡åˆæ¼”ç®—å­**ã§ã™ï¼š

| æ¼”ç®—å­ | èª¬æ˜ | ä½¿ç”¨ä¾‹ |
|---------|------------|---------|
| `allOf` | ã™ã¹ã¦ã®æ¡ä»¶ã‚’æº€ãŸã™ï¼ˆANDï¼‰ | `{"operation": "allOf", "value": [condition1, condition2]}` |
| `anyOf` | ã„ãšã‚Œã‹ã®æ¡ä»¶ã‚’æº€ãŸã™ï¼ˆORï¼‰ | `{"operation": "anyOf", "value": [condition1, condition2]}` |

**ä¾‹1ï¼šallOfï¼ˆrole==admin AND verified==trueï¼‰**

```json
{
  "operation": "allOf",
  "value": [
    {"operation": "eq", "path": "$.user.role", "value": "admin"},
    {"operation": "eq", "path": "$.user.verified", "value": true}
  ]
}
```

**ä¾‹2ï¼šanyOfï¼ˆrole==admin OR role==editorï¼‰**

```json
{
  "operation": "anyOf",
  "value": [
    {"operation": "eq", "path": "$.user.role", "value": "admin"},
    {"operation": "eq", "path": "$.user.role", "value": "editor"}
  ]
}
```

**ä¾‹3ï¼šãƒã‚¹ãƒˆã—ãŸè¤‡åˆæ¡ä»¶ï¼ˆ(role==admin AND verified==true) OR age>=21ï¼‰**

```json
{
  "operation": "anyOf",
  "value": [
    {
      "operation": "allOf",
      "value": [
        {"operation": "eq", "path": "$.user.role", "value": "admin"},
        {"operation": "eq", "path": "$.user.verified", "value": true}
      ]
    },
    {"operation": "gte", "path": "$.user.age", "value": 21}
  ]
}
```

### ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿

æ¡ä»¶è©•ä¾¡ã§åˆ©ç”¨å¯èƒ½ãªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ï¼ˆå®Ÿè¡Œæ™‚ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã¨åŒä¸€å½¢å¼ï¼‰ï¼š

```json
{
  "user": {
    "sub": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ID",
    "role": "admin",
    "verified": true,
    "age": 25
  },
  "application": {
    "id": "ç”³è¾¼ã¿ID",
    "type": "ç”³è¾¼ã¿ç¨®åˆ¥",
    "process": "ãƒ—ãƒ­ã‚»ã‚¹ç¨®åˆ¥",
    "status": "ç”³è¾¼ã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹"
  },
  "request_body": {
    "user_id": "ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿",
    "amount": 50000
  },
  "request_attributes": {
    "ip": "ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIP",
    "user_agent": "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆ"
  }
}
```

### å®Ÿç”¨ä¾‹

#### 1. ç®¡ç†è€…ã®ã¿å®Ÿè¡Œ

```json
{
  "type": "enhanced_verification",
  "details": { ... },
  "condition": {
    "operation": "eq",
    "path": "$.user.role",
    "value": "admin"
  }
}
```

#### 2. é«˜é¡å–å¼•æ™‚ã®ã¿å®Ÿè¡Œ

```json
{
  "type": "additional_risk_check",
  "details": { ... },
  "condition": {
    "operation": "gte",
    "path": "$.request_body.amount",
    "value": 100000
  }
}
```

#### 3. è¤‡åˆæ¡ä»¶

```json
{
  "type": "premium_verification",
  "details": { ... },
  "condition": {
    "operation": "allOf",
    "value": [
      {
        "operation": "eq",
        "path": "$.user.tier",
        "value": "premium"
      },
      {
        "operation": "gte",
        "path": "$.user.age",
        "value": 18
      }
    ]
  }
}
```

#### 4. åœ°åŸŸãƒ™ãƒ¼ã‚¹ã®æ¡ä»¶

```json
{
  "type": "geo_compliance_check",
  "details": { ... },
  "condition": {
    "operation": "in",
    "path": "$.user.country",
    "value": ["US", "CA", "GB"]
  }
}
```

### å¾Œæ–¹äº’æ›æ€§

- æ—¢å­˜è¨­å®šï¼ˆconditionæœªæŒ‡å®šï¼‰ã¯å¤‰æ›´ãªãå‹•ä½œ
- æ–°è¦è¨­å®šã®ã¿conditionãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’è¿½åŠ 
- æ®µéšçš„ãªç§»è¡ŒãŒå¯èƒ½

## ç”³è¾¼ã¿ãƒ•ãƒ­ãƒ¼ä¾‹

1. ã‚¢ãƒ—ãƒªã‹ã‚‰èº«å…ƒç¢ºèªã®ç”³è¾¼ã¿ã‚’è¡Œã„ã€idp-serverçµŒç”±ã§å¤–éƒ¨èº«å…ƒç¢ºèªã‚µãƒ¼ãƒ“ã‚¹ã«é€£æºã™ã‚‹
2. ã‚¢ãƒ—ãƒªã§eKYCã®å®Ÿæ–½ã—ã€idp-serverçµŒç”±ã§çµæœã‚’å¤–éƒ¨èº«å…ƒç¢ºèªã‚µãƒ¼ãƒ“ã‚¹ã«é€£æºã™ã‚‹
3. å¤–éƒ¨èº«å…ƒç¢ºèªã‚µãƒ¼ãƒ“ã‚¹ã§ã®å¯©æŸ»
4. idp-serverãŒå¤–éƒ¨èº«å…ƒç¢ºèªã‚µãƒ¼ãƒ“ã‚¹ã‹ã‚‰å¯©æŸ»çµæœã‚’å—ä¿¡ã™ã‚‹
5. å¯©æŸ»çµæœã«å¿œã˜ã¦ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œè¨¼æ¸ˆã¿ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ›´æ–°ã™ã‚‹

### ä¾‹ã«å¯¾å¿œã™ã‚‹`process` å®šç¾©

- `apply`ï¼šç”³è«‹ãƒ‡ãƒ¼ã‚¿ã®é€ä¿¡
- `ekyc`ï¼šeKYCå®Ÿæ–½
- `callback-examination`ï¼šå¯©æŸ»çŠ¶æ…‹ã®é€šçŸ¥ï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
- `callback-result`ï¼šverified_claims ç™»éŒ²ç”¨ãƒ‡ãƒ¼ã‚¿ã®å—ä¿¡ï¼ˆã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰

### ä¾‹ã«å¯¾å¿œã™ã‚‹ã‚·ãƒ¼ã‚±ãƒ³ã‚¹

```mermaid
sequenceDiagram
    participant App as ğŸ§‘â€ğŸ’» ã‚¢ãƒ—ãƒª
    participant IdP as ğŸ” idp-server
    participant EKYC as ğŸ›° å¤–éƒ¨èº«å…ƒç¢ºèªã‚µãƒ¼ãƒ“ã‚¹
    Note over App, EKYC: eKYCé€£æºãƒ•ãƒ­ãƒ¼
    App ->> IdP: èº«å…ƒç¢ºèªã®ç”³è¾¼ã¿
    IdP ->> EKYC: å¤–éƒ¨èº«å…ƒç¢ºèªã‚µãƒ¼ãƒ“ã‚¹ã¸ç”³è¾¼ã¿æƒ…å ±é€£æº
    EKYC ->> EKYC: ç”³è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
    EKYC -->> IdP: ç”³è¾¼ã¿IDã‚’è¿”å´
    IdP ->> IdP: è¨­å®šã«å¿œã˜ã¦æœ€å°é™ã®ç”³è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
    IdP -->> App: ç”³è¾¼ã¿IDãªã©ã‚’è¿”å´
    App ->> App: eKYCã®å®Ÿæ–½
    App ->> IdP: eKYCçµæœã®é€ä¿¡ï¼ˆä¾‹ï¼šæœ¬äººç¢ºèªæ›¸é¡ï¼‹é¡”å†™çœŸï¼‰
    IdP ->> EKYC: eKYCçµæœã‚’ä¸­ç¶™
    EKYC ->> EKYC: eKYCçµæœã‚’è¨˜éŒ²
    EKYC -->> IdP: ç”³è¾¼ã¿IDã‚’è¿”å´
    IdP ->> IdP: è¨­å®šã«å¿œã˜ã¦æœ€å°é™ã®ãƒ‡ãƒ¼ã‚¿ã‚’è¨˜éŒ²
    IdP -->> App: ç”³è¾¼ã¿IDãªã©ã‚’è¿”å´
    EKYC ->> EKYC: å¯©æŸ»å‡¦ç†
    EKYC -->> IdP: å¯©æŸ»çµæœã‚’é€šçŸ¥ï¼ˆéåŒæœŸã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
    IdP ->> IdP: æˆåŠŸ/å¤±æ•— æ¡ä»¶ã®åˆ¤å®š
    IdP ->> IdP: å¯©æŸ»çµæœã«å¿œã˜ã¦ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ¤œè¨¼æ¸ˆã¿ã‚¯ãƒ¬ãƒ¼ãƒ ã‚’æ›´æ–°ã™ã‚‹
    IdP -->> App: çµæœé€šçŸ¥ or ãƒ‡ãƒ¼ã‚¿å–å¾—
    Note over IdP: å¯©æŸ»çµæœã«å¿œã˜ã¦IDãƒˆãƒ¼ã‚¯ãƒ³ã¸<br/>verified_claimsç­‰ã‚’åæ˜ ã§ãã‚‹

```

### ä¾‹ã«å¯¾å¿œã™ã‚‹ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»

```mermaid
stateDiagram-v2
    [*] --> requested
    requested --> applying: ãƒ¦ãƒ¼ã‚¶ãƒ¼å…¥åŠ›ä¸­
    applying --> examination_processing: å…¥åŠ›å®Œäº†â†’eKYCé€ä¿¡
    examination_processing --> approved: å¯©æŸ»æ‰¿èª
    examination_processing --> rejected: å¯©æŸ»å¦èª
    requested --> cancelled: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ
    applying --> cancelled: ãƒ¦ãƒ¼ã‚¶ãƒ¼æ“ä½œ
```

---

## processè©³ç´°

èº«å…ƒç¢ºèªç”³è¾¼ã¿APIã®å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯ã¯ã€7ã¤ã®ä¸»è¦ãªãƒ•ã‚§ãƒ¼ã‚ºã§æ§‹æˆã•ã‚Œã¦ã„ã¾ã™ã€‚

ã“ã‚Œã‚‰ã®ãƒ•ã‚§ãƒ¼ã‚ºã«ã‚ˆã‚Šã€æŸ”è»Ÿã§æ‹¡å¼µå¯èƒ½ãªç”³è¾¼ã¿å‡¦ç†ã‚’å®Ÿç¾ã—ã¦ã„ã¾ã™ã€‚

### ãƒ•ã‚§ãƒ¼ã‚ºä¸€è¦§

| ãƒ•ã‚§ãƒ¼ã‚ºå             | å½¹å‰²ãƒ»ç›®çš„                      | ä¸»ãªè¨­å®šé …ç›®                                                    | å¿…é ˆ |
|-------------------|----------------------------|-----------------------------------------------------------|----|
| **1. request**    | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ§‹é€ ãƒ»å½¢å¼ã‚’æ¤œè¨¼             | `schema`ï¼ˆJSON Schemaï¼‰                                     | -  |
| **2. pre_hook**   | å®Ÿè¡Œå‰ã®äº‹å‰æ¤œè¨¼ãƒ»å¤–éƒ¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ãƒ»å¤–éƒ¨APIå®Ÿè¡Œ | `verifications`, `additional_parameters`                  | -  |
| **3. execution**  | ãƒ¡ã‚¤ãƒ³æ¥­å‹™å‡¦ç†ï¼ˆå¤–éƒ¨é€£æº or å†…éƒ¨å‡¦ç†ï¼‰      | `type`, `http_request`, `mock`, `no_action` ãªã©ï¼ˆå‡¦ç†ã‚¿ã‚¤ãƒ—ã«å¿œã˜ã¦ï¼‰ | âœ…  |
| **4. post_hook**  | å®Ÿè¡Œå¾Œã®æ¤œè¨¼ãƒ»å¤–éƒ¨APIå®Ÿè¡Œ             | `verifications` `additional_parameters`                   | -  |
| **5. transition** | ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»                    | `approved` `rejected` `canceled`                          | -  |
| **6. store**      | å‡¦ç†çµæœã‚„ç”³è«‹å†…å®¹ã®æ°¸ç¶šåŒ–              | `application_details_mapping_rules`                       | -  |
| **7. response**   | ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ç”Ÿæˆ            | `body_mapping_rules`                                      | -  |

### ãƒ—ãƒ­ã‚»ã‚¹å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯

```mermaid
sequenceDiagram
    participant App as ã‚¢ãƒ—ãƒª
    participant IdP as IdP Server
    participant External as å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹
    App ->> IdP: POST /apply
    Note right of IdP: 1. Request ãƒ•ã‚§ãƒ¼ã‚º
    IdP ->> IdP: JsonSchemaã«ã‚ˆã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®æ¤œè¨¼
    Note right of IdP: 2. Pre Hook ãƒ•ã‚§ãƒ¼ã‚º
    IdP ->> IdP: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ å¤–éƒ¨APIå®Ÿè¡Œã‚„ãƒ¦ãƒ¼ã‚¶ãƒ¼å±æ€§ã¨ã®ä¸€è‡´æ¤œè¨¼ãªã©ï¼‰
    Note right of IdP: 3. Execution ãƒ•ã‚§ãƒ¼ã‚º
    IdP ->> External: POST /apply
    External -->> IdP: ãƒ¬ã‚¹ãƒãƒ³ã‚¹
    Note right of IdP: 4. Post Hook Phase
    IdP ->> IdP: ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œã€‚å¤–éƒ¨APIå®Ÿè¡Œãªã©
    Note right of IdP: 5. Transition ãƒ•ã‚§ãƒ¼ã‚º
    IdP ->> IdP: ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹é·ç§»åˆ¤å®š
    Note right of IdP: 6. Store ãƒ•ã‚§ãƒ¼ã‚º
    IdP ->> IdP: application detailsã®çµ„ã¿ç«‹ã¦
    IdP ->> IdP: ç”³è¾¼ã¿ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
    Note right of IdP: 7. Response ãƒ•ã‚§ãƒ¼ã‚º
    IdP ->> IdP: ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®çµ„ã¿ç«‹ã¦
    IdP -->> App: Response
```

### è©³ç´°å‡¦ç†ãƒ•ãƒ­ãƒ¼

```mermaid
flowchart TD
    A[ãƒªã‚¯ã‚¨ã‚¹ãƒˆå—ä¿¡] --> B{Requestæ¤œè¨¼}
    B -->|OK| C[Pre Hookå®Ÿè¡Œ]
    B -->|NG| Z[ã‚¨ãƒ©ãƒ¼ãƒ¬ã‚¹ãƒãƒ³ã‚¹]
    C --> D{Pre HookæˆåŠŸ?}
    D -->|Yes| E[Executionå®Ÿè¡Œ]
    D -->|No| Z
    E --> F{ExecutionæˆåŠŸ?}
    F -->|Yes| G[Post Hookå®Ÿè¡Œ]
    F -->|No| Z
    G --> H{Post HookæˆåŠŸ?}
    H -->|Yes| I[Storeå®Ÿè¡Œ]
    H -->|No| Z
    I -->|Yes| K[Responseæ§‹ç¯‰]
    K --> L[ãƒ¬ã‚¹ãƒãƒ³ã‚¹é€ä¿¡]
    Z --> L
```

## å„ãƒ•ã‚§ãƒ¼ã‚ºã®è©³ç´°è¨­å®š

### 1. Request ãƒ•ã‚§ãƒ¼ã‚º

**ç›®çš„**: ãƒªã‚¯ã‚¨ã‚¹ãƒˆã®å—ä¿¡ã¨åŸºæœ¬æ¤œè¨¼

**ä¸»ãªæ©Ÿèƒ½**:

- ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
    - å¿…é ˆãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒã‚§ãƒƒã‚¯
    - ãƒ‡ãƒ¼ã‚¿å‹ãƒ»å½¢å¼æ¤œè¨¼
- èªè¨¼æƒ…å ±ç¢ºèª

**è¨­å®šä¾‹**:

```json
{
  "request": {
    "schema": {
      "type": "object",
      "required": [
        "last_name",
        "first_name",
        "email_address"
      ],
      "properties": {
        "last_name": {
          "type": "string",
          "maxLength": 255
        },
        "email_address": {
          "type": "string",
          "pattern": "^[\\w\\.-]+@[\\w\\.-]+\\.[a-zA-Z]{2,}$"
        }
      }
    }
  },
  "pre_hook": {},
  "execution": {},
  "post_hook": {},
  "transition": {},
  "store": {},
  "response": {}
}
```

**å‡¦ç†å†…å®¹**:

1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®JSONã‚¹ã‚­ãƒ¼ãƒæ¤œè¨¼
2. å¿…é ˆãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã®å­˜åœ¨ç¢ºèª
3. ãƒ‡ãƒ¼ã‚¿å½¢å¼ã®å¦¥å½“æ€§ãƒã‚§ãƒƒã‚¯
4. æ–‡å­—æ•°åˆ¶é™ãªã©ã®åˆ¶ç´„ç¢ºèª

**è¨­å®šé …ç›®**:

| é …ç›®å           | å‹         | èª¬æ˜                                                      |
|---------------|-----------|---------------------------------------------------------|
| `type`        | string    | åŸºæœ¬ã¯ `"object"`ã€‚ãƒ«ãƒ¼ãƒˆã®ãƒ‡ãƒ¼ã‚¿å‹ã‚’å®šç¾©ã€‚                             |
| `required`    | string\[] | å¿…é ˆé …ç›®åã®ãƒªã‚¹ãƒˆã€‚ãƒªã‚¯ã‚¨ã‚¹ãƒˆã«ã“ã®é …ç›®ãŒå­˜åœ¨ã—ãªã„ã¨ã‚¨ãƒ©ãƒ¼ã«ãªã‚‹ã€‚                      |
| `properties`  | object    | å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã®ãƒãƒªãƒ‡ãƒ¼ã‚·ãƒ§ãƒ³å®šç¾©ã‚’å«ã‚€ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã€‚                              |
| â”” `<key>`     | object    | å„ãƒ—ãƒ­ãƒ‘ãƒ†ã‚£ã«å¯¾ã™ã‚‹åˆ¶ç´„ï¼ˆå‹ã€é•·ã•ã€ãƒ‘ã‚¿ãƒ¼ãƒ³ãªã©ï¼‰ã€‚                              |
| â””â””`type`      | string    | `"string"`, `"integer"`, `"boolean"`, `"object"` ãªã©ã‚’æŒ‡å®šã€‚ |
| â””â””`format`    | string    | `"date"`, `"date-time"` ãªã©ã€ç‰¹å®šãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã®æ¤œè¨¼ã«ä½¿ç”¨ã€‚              |
| â””â””`pattern`   | string    | æ­£è¦è¡¨ç¾ã«ã‚ˆã‚‹æ–‡å­—åˆ—ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒã‚§ãƒƒã‚¯ã€‚ä¾‹: ãƒ¡ãƒ¼ãƒ«ã‚¢ãƒ‰ãƒ¬ã‚¹ã€‚                          |
| â””â””`minLength` | integer   | æ–‡å­—åˆ—ã®æœ€å°æ–‡å­—æ•°ã€‚                                              |
| â””â””`maxLength` | integer   | æ–‡å­—åˆ—ã®æœ€å¤§æ–‡å­—æ•°ã€‚                                              |
| â””â””`minimum`   | integer   | æ•°å€¤ã®æœ€å°å€¤ã€‚                                                 |
| â””â””`maximum`   | integer   | æ•°å€¤ã®æœ€å¤§å€¤ã€‚                                                 |

---

### 2. Pre Hook ãƒ•ã‚§ãƒ¼ã‚º

**ç›®çš„**: ãƒ¡ã‚¤ãƒ³å‡¦ç†å®Ÿè¡Œå‰ã®æº–å‚™ãƒ»æ¤œè¨¼

**ä¸»ãªæ©Ÿèƒ½**:

- ç”³è¾¼ã¿ã«å¯¾ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼ï¼ˆè¤‡æ•°æŒ‡å®šã§ãã‚‹ã€‚è¨­å®šé †ã«å®Ÿè¡Œã™ã‚‹ï¼‰
    - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒ¬ãƒ¼ãƒ ã®æ¤œè¨¼
    - é‡è¤‡ç”³è¾¼ã¿æ¤œè¨¼
    - ãã®ä»–ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚‚è¿½åŠ äºˆå®š
- è¿½åŠ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—ï¼ˆè¤‡æ•°æŒ‡å®šã§ãã‚‹ã€‚è¨­å®šé †ã«å®Ÿè¡Œã™ã‚‹ï¼‰
    - å¤–éƒ¨APIå®Ÿè¡Œ
    - ãã®ä»–ã®ãƒ­ã‚¸ãƒƒã‚¯ã‚‚è¿½åŠ äºˆå®š

**è¨­å®šä¾‹**:

```json
{
  "request": {},
  "pre_hook": {
    "verifications": [],
    "additional_parameters": []
  },
  "execution": {},
  "post_hook": {},
  "transition": {},
  "store": {},
  "response": {}
}
```

**å‡¦ç†å†…å®¹**:

1. ç”³è¾¼ã¿ã«å¯¾ã™ã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯æ¤œè¨¼
2. è¿½åŠ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—

ã®é †ã§å®Ÿè¡Œã•ã‚Œã‚‹ã€‚

#### verifications: ãƒ“ã‚¸ãƒã‚¹æ¤œè¨¼å‡¦ç†ç¾¤

ç”³è«‹å‰ã«ç¢ºèªã™ã¹ããƒã‚§ãƒƒã‚¯ï¼ˆä¾‹ï¼šãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã¨ã®ä¸€è‡´ã€é‡è¤‡ç”³è«‹ã€å¤–éƒ¨ãƒ–ãƒ©ãƒƒã‚¯ãƒªã‚¹ãƒˆç…§ä¼šãªã©ï¼‰ã‚’å®šç¾©ã™ã‚‹ã€‚

```json
{
  "pre_hook": {
    "verifications": [
      {
        "type": "user_claim",
        "details": {}
      }
    ],
    "additional_parameters": []
  }
}
```

**type ä¸€è¦§**

| type                          | æ¦‚è¦                     |
|-------------------------------|------------------------|
| `user_claim`                  | ãƒªã‚¯ã‚¨ã‚¹ãƒˆå†…å®¹ã¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒ¬ãƒ¼ãƒ ã®ä¸€è‡´ç¢ºèªã€‚ |
| `application_limitation` ï¼ˆäºˆå®šï¼‰ | ç”³è¾¼ã¿å¯èƒ½æ•°ãƒã‚§ãƒƒã‚¯ã€‚            |
| `duplicate_application` ï¼ˆäºˆå®šï¼‰  | éå»ã®ç”³è«‹ã¨é‡è¤‡ãŒãªã„ã‹ã‚’ãƒã‚§ãƒƒã‚¯ã€‚     |
| `http_request`ï¼ˆäºˆå®šï¼‰            | å¤–éƒ¨APIã¨é€£æºã—ã¦æ¤œè¨¼ã‚’è¡Œã†ã€‚       |

**user_claim ã®è©³ç´°æ§‹é€ **

```json
{
  "type": "user_claim",
  "details": {
    "verification_parameters": [
      {
        "request_json_path": "$.mobile_phone_number",
        "user_claim_json_path": "phone_number"
      },
      {
        "request_json_path": "$.request_body.email",
        "user_claim_json_path": "email"
      }
    ]
  }
}
```

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰                  | å‹      | èª¬æ˜                                                                      |
|------------------------|--------|-------------------------------------------------------------------------|
| `request_json_path`    | string | ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰å€¤ã‚’å–å¾—ã™ã‚‹JSONPathã€€[JsonPath](https://github.com/json-path/JsonPath) |
| `user_claim_json_path` | string | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚¯ãƒ¬ãƒ¼ãƒ ã‹ã‚‰å€¤ã‚’å–å¾—ã™ã‚‹ã‚­ãƒ¼ï¼ˆãƒã‚¹ãƒˆå¯¾å¿œï¼‰                                               |

#### additional_parameters: å‹•çš„ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å–å¾—

ç”³è¾¼ã¿ã«å¿…è¦ãªæƒ…å ±ã‚’å¤–éƒ¨ã‚„ä»–ã‚½ãƒ¼ã‚¹ã‹ã‚‰äº‹å‰ã«å–å¾—ã™ã‚‹æ©Ÿæ§‹ã€‚

```json
{
  "pre_hook": {
    "verifications": [
      {
        "type": "http_request",
        "details": {}
      }
    ],
    "additional_parameters": []
  }
}
```

| type           | èª¬æ˜                    |
|----------------|-----------------------|
| `http_request` | å¤–éƒ¨APIã‚’å©ã„ã¦è¿½åŠ ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—ã™ã‚‹ |

```json
{
  "type": "http_request",
  "details": {
    "url": "http://localhost:5000/{{external_application_id}}/resolve",
    "method": "POST",
    "path_mapping_rules": [
      {
        "from": "$.application.application_details.external_application_id",
        "to": "external_application_id"
      }
    ],
    "header_mapping_rules": [
      {
        "from": "$.request_attributes.headers.token",
        "to": "x-token"
      }
    ],
    "body_mapping_rules": [
      {
        "from": "$.request_body",
        "to": "*"
      }
    ]
  }
}

```

##### http_requestã®è¨­å®š

| JSONã‚­ãƒ¼å                | å‹               | èª¬æ˜                                                        | å¿…é ˆ |
|------------------------|-----------------|-----------------------------------------------------------|----|
| `url`                  | `string`        | ãƒ™ãƒ¼ã‚¹ã¨ãªã‚‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆURLï¼ˆä¾‹ï¼š`https://example.com/users/{{user_id}}`ï¼‰ | âœ…  |
| `method`               | `string`        | HTTPãƒ¡ã‚½ãƒƒãƒ‰ï¼ˆä¾‹ï¼š`GET`, `POST` ãªã©ï¼‰                              | âœ…  |
| `auth_type`            | `string`        | èªè¨¼æ–¹å¼ï¼ˆ`none`, `oauth2`, `hmac_sha256`ï¼‰                     | âœ…  |
| `oauth_authorization`  | `object`        | OAuth2èªè¨¼ã®è¨­å®šï¼ˆ`auth_type = "oauth2"` ã®ã¨ãã«å¿…è¦ï¼‰                | â–³  |
| `hmac_authentication`  | `object`        | HMACèªè¨¼ã®è¨­å®šï¼ˆ`auth_type = "hmac_sha256"` ã®ã¨ãã«å¿…è¦ï¼‰             | â–³  |
| `path_mapping_rules`   | `array<object>` | URLãƒ‘ã‚¹ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ä¸€è¦§                                          | -  |
| `header_mapping_rules` | `array<object>` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ä¸€è¦§                                      | -  |
| `body_mapping_rules`   | `array<object>` | ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ä¸€è¦§                                       | -  |
| `query_mapping_rules`  | `array<object>` | GETãƒ¡ã‚½ãƒƒãƒ‰ç”¨ã®ã‚¯ã‚¨ãƒªãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ä¸€è¦§                               | -  |

å‡¡ä¾‹ï¼š

- âœ…ï¼šå¸¸ã«å¿…é ˆ
- â–³ï¼šæ¡ä»¶ä»˜ãå¿…é ˆï¼ˆauth_type ã«ã‚ˆã‚‹ï¼‰
- -ï¼šä»»æ„

**mapping_rules é…åˆ—å†…ã®ãƒ«ãƒ¼ãƒ«æ§‹é€ **

| ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰          | å‹        | èª¬æ˜                                                                                    | å¿…é ˆ    |
|----------------|----------|---------------------------------------------------------------------------------------|-------|
| `from`         | `string` | æŠ½å‡ºå…ƒï¼ˆ[JsonPath](https://github.com/json-path/JsonPath)ï¼‰ä¾‹: `$.request_body.customer_id` | â–³ï¼ˆâ€»1ï¼‰ |
| `to`           | `string` | å¤‰æ›å…ˆã‚­ãƒ¼ï¼ˆä¾‹: `resolved.customer_id`, `*`ï¼‰`.`å½¢å¼ã§ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ãƒã‚¹ãƒˆãŒå¯èƒ½ã€‚`â€»`ã‚’æŒ‡å®šã™ã‚‹ã¨ãƒˆãƒƒãƒ—éšå±¤ã«ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå±•é–‹ã•ã‚Œã‚‹ã€‚ | âœ…     |
| `static_value` | `any`    | é™çš„ãªå€¤ï¼ˆJSONPathã‚’ä½¿ã‚ãšå›ºå®šå€¤ã‚’è¨­å®šã—ãŸã„å ´åˆã«ä½¿ç”¨ï¼‰                                                      | â–³ï¼ˆâ€»1ï¼‰ |
| `convert_type` | `string` | çœç•¥å¯ã€‚å‹å¤‰æ›ãŒå¿…è¦ãªå ´åˆã«æŒ‡å®šï¼ˆ`string`, `int`, `boolean`, `datetime`ï¼‰                              | -     |

è£œè¶³

- â€»1ï¼šã€Œfromã€orã€Œstatic_valueã€ã®ã©ã¡ã‚‰ã‹ä¸€æ–¹ã¯å¿…é ˆ
- ä¸¡æ–¹ãŒæœªæŒ‡å®šã®å ´åˆã€ç„¡åŠ¹ãªãƒãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ã¨ã—ã¦æ‰±ã‚ã‚Œã‚‹

**mapping_rules fromã®æŒ‡å®šæ–¹æ³•**

from ã§å‚ç…§ã§ãã‚‹ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šï¼š

| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå              | å†…å®¹                                |
|----------------------|-----------------------------------|
| `request_body`       | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ç”³è«‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆç”»é¢å…¥åŠ›å€¤ãªã©ï¼‰        |
| `request_attributes` | èªè¨¼æƒ…å ±ã‚„HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±æ€§       |
| `user`               | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆ`sub`, `email`, `name` ãªã©ï¼‰ |
| `application`        | ç¾åœ¨ã®ç”³è¾¼ã¿æƒ…å ±                          |

**æ³¨æ„ç‚¹**

- JSONPathã®ãƒ—ãƒ¬ãƒ•ã‚£ãƒƒã‚¯ã‚¹ $ ã¯ çœç•¥ä¸å¯
- ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆãŒå­˜åœ¨ã—ãªã„å ´åˆã€å€¤ã¯ null ã¨ãªã‚‹
- from ã¾ãŸã¯ static_value ã¯ã„ãšã‚Œã‹ å¿…é ˆï¼ˆä¸¡æ–¹æœªæŒ‡å®šã¯ã‚¨ãƒ©ãƒ¼ï¼‰
- to ã« "*" ã‚’ä½¿ã†ã¨ã€æŒ‡å®šã—ãŸã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã®ä¸­èº«ã‚’ãƒˆãƒƒãƒ—éšå±¤ã«å±•é–‹ã§ãã‚‹ï¼ˆç«¶åˆæ™‚ã®æŒ™å‹•ã«ã¯æ³¨æ„ï¼‰

---

### 3. Execution ãƒ•ã‚§ãƒ¼ã‚º

**ç›®çš„**: ãƒ¡ã‚¤ãƒ³ã¨ãªã‚‹ãƒ“ã‚¸ãƒã‚¹ãƒ­ã‚¸ãƒƒã‚¯ã®å®Ÿè¡Œ

**æ©Ÿèƒ½**:

- å¤–éƒ¨APIå‘¼ã³å‡ºã—
- ä½•ã‚‚ã—ãªã„
- Mockï¼ˆäºˆå®šï¼‰
- å†…éƒ¨ãƒ­ã‚¸ãƒƒã‚¯å®Ÿè¡Œï¼ˆäºˆå®šï¼‰

**å¤–éƒ¨APIå‘¼ã³å‡ºã—ã®è¨­å®šä¾‹**:

```json
{
  "request": {},
  "pre_hook": {},
  "execution": {
    "type": "http_request",
    "http_request": {
      "url": "http://localhost:5000/{{external_application_id}}/process",
      "method": "POST",
      "auth_type": "oauth2",
      "oauth_authorization": {
        "type": "password",
        "token_endpoint": "http://localhost:5000/token",
        "client_id": "your-client-id",
        "username": "username",
        "password": "password",
        "scope": "application"
      },
      "static_headers": {
        "Content-Type": "application/json",
        "Authorization": "Bearer dummy-token"
      },
      "path_mapping_rules": [
        {
          "from": "$.application.application_details.external_application_id",
          "to": "external_application_id"
        }
      ],
      "body_mapping_rules": [
        {
          "from": "$.request_body.trust_framework",
          "to": "trust_framework"
        },
        {
          "from": "$.request_body.evidence_document_type",
          "to": "evidence_document_type"
        },
        {
          "from": "$.additional_parameters.resolve_body",
          "to": "*"
        }
      ]
    }
  },
  "post_hook": {},
  "transition": {},
  "store": {},
  "response": {}
}
```

**å¤–éƒ¨APIå‘¼ã³å‡ºã—ã®å‡¦ç†å†…å®¹**:

1. OAuthã«ã‚ˆã‚‹ã‚¢ã‚¯ã‚»ã‚¹ãƒˆãƒ¼ã‚¯ãƒ³ã®å–å¾—(å¿…è¦ãªå ´åˆ)
2. URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®å‹•çš„ç½®æ›(å¿…è¦ãªå ´åˆ)
3. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ»å¤‰æ›(å¿…è¦ãªå ´åˆ)
4. å¤–éƒ¨APIã¸ã®HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆé€ä¿¡

**mapping_rules fromã®æŒ‡å®šæ–¹æ³•**

from ã§å‚ç…§ã§ãã‚‹ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šï¼š

| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå                 | å†…å®¹                                |
|-------------------------|-----------------------------------|
| `request_body`          | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ç”³è«‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆç”»é¢å…¥åŠ›å€¤ãªã©ï¼‰        |
| `request_attributes`    | èªè¨¼æƒ…å ±ã‚„HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±æ€§       |
| `user`                  | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆ`sub`, `email`, `name` ãªã©ï¼‰ |
| `application`           | ç¾åœ¨ã®ç”³è¾¼ã¿æƒ…å ±                          |
| `additional_parameters` | pre_hookã§è¿½åŠ ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿                |

---

### 4. Post Hook ãƒ•ã‚§ãƒ¼ã‚º

**ç›®çš„**: ãƒ¡ã‚¤ãƒ³å‡¦ç†å¾Œã®çµæœæ¤œè¨¼ãƒ»å¤‰æ›

**ä¸»ãªæ©Ÿèƒ½**:

- å¤–éƒ¨APIå‘¼ã³å‡ºã—

**è¨­å®šä¾‹**:

```json
{
  "request": {},
  "pre_hook": {},
  "execution": {},
  "post_hook": {
    "transformations": [
      {
        "type": "data_validation",
        "rules": [
          {
            "path": "$.response_body.status",
            "expected": "success"
          }
        ]
      },
      {
        "type": "data_mapping",
        "mapping_rules": [
          {
            "from": "$.response_body.external_id",
            "to": "application_id"
          }
        ]
      }
    ]
  },
  "transition": {},
  "store": {},
  "response": {}
}
```

**å‡¦ç†å†…å®¹**:

1. å®Ÿè¡Œçµæœã®å¦¥å½“æ€§æ¤œè¨¼
2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›ãƒ»æ­£è¦åŒ–
3. æ¬¡ã®ãƒ•ã‚§ãƒ¼ã‚ºã«å‘ã‘ãŸãƒ‡ãƒ¼ã‚¿æº–å‚™
4. ã‚¨ãƒ©ãƒ¼çŠ¶æ…‹ã®æ¤œçŸ¥ãƒ»å‡¦ç†

**mapping_rules fromã®æŒ‡å®šæ–¹æ³•**

from ã§å‚ç…§ã§ãã‚‹ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šï¼š

| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå                 | å†…å®¹                                    |
|-------------------------|---------------------------------------|
| `request_body`          | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ç”³è«‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆç”»é¢å…¥åŠ›å€¤ãªã©ï¼‰            |
| `request_attributes`    | èªè¨¼æƒ…å ±ã‚„HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±æ€§           |
| `user`                  | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆ`sub`, `email`, `name` ãªã©ï¼‰     |
| `application`           | ç¾åœ¨ã®ç”³è¾¼ã¿æƒ…å ±                              |
| `additional_parameters` | pre_hookã§è¿½åŠ ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿                    |
| `response_status_code`  | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã€‚ |
| `response_headers`      | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã€‚      |
| `response_body`         | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸå ´åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒœãƒ‡ã‚£ãƒ¼ã€‚    |

---

### 5. transition ãƒ•ã‚§ãƒ¼ã‚º

ç›®çš„: å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ã‚„äº‹å‰æ¡ä»¶ã«åŸºã¥ã„ã¦ã€ç”³è¾¼ã¿ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’å‹•çš„ã«é·ç§»ã•ã›ã‚‹ãŸã‚ã®æ¡ä»¶ã‚’åˆ¤å®šã™ã‚‹ã€‚

ä¸»ãªæ©Ÿèƒ½:

- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ã‚„ç”³è¾¼ã¿å‡¦ç†ã®çµæœã‚’ã‚‚ã¨ã«ã€ç”³è«‹ã‚’ approved / rejected / cancelled ã®ã„ãšã‚Œã‹ã®çŠ¶æ…‹ã«æ›´æ–°ã™ã‚‹

**å„é·ç§»ã‚¿ã‚¤ãƒ—ã®å®šç¾©**

| é·ç§»ã‚¿ã‚¤ãƒ—       | æ„å‘³                                         |
|-------------|--------------------------------------------|
| `approved`  | æ‰¿èªã•ã‚ŒãŸå ´åˆã®é·ç§»æ¡ä»¶ã€‚é€šå¸¸ã¯æœ¬äººç¢ºèªãŒæˆåŠŸã—ã€æ¤œè¨¼æ¸ˆã¿ã‚¯ãƒ¬ãƒ¼ãƒ ã®ç™ºè¡Œå¯¾è±¡ã¨ãªã‚‹ã€‚ |
| `rejected`  | å´ä¸‹ã•ã‚ŒãŸå ´åˆã®é·ç§»æ¡ä»¶ã€‚eKYCã®ä¸ä¸€è‡´ã‚„å¯©æŸ»NGã®å ´åˆãªã©ã€‚           |
| `cancelled` | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã¾ãŸã¯ç®¡ç†è€…ã«ã‚ˆã£ã¦æ˜ç¤ºçš„ã«ã‚­ãƒ£ãƒ³ã‚»ãƒ«ã•ã‚ŒãŸå ´åˆã®é·ç§»æ¡ä»¶ã€‚         |

**é·ç§»æ¡ä»¶**

ä¸‹è¨˜ã®3ç¨®ã®æ¡ä»¶ã‚’è¨­å®šã™ã‚‹ã“ã¨ã§ã€å¯¾å¿œã™ã‚‹çŠ¶æ…‹ã¸é·ç§»ã™ã‚‹:

* `approved`: æ‰¿èª
* `rejected`: å¦èª
* `cancelled`: ã‚­ãƒ£ãƒ³ã‚»ãƒ«

**æ¡ä»¶ã®åŸºæœ¬æ§‹é€ **

```json
{
  "path": "$.application.type",
  "type": "string",
  "operation": "equals",
  "value": "investment-account-opening"
}

```

| é …ç›®          | èª¬æ˜                                                                        |
|-------------|---------------------------------------------------------------------------|
| `path`      | JSONPathã§è©•ä¾¡å¯¾è±¡ã‚’æŒ‡å®šã€‚ä¾‹ï¼š`$.request_body.xxx`ã€`$.processes.apply.success_count` |
| `type`      | å€¤ã®å‹ï¼š`string`, `integer`, `boolean`                                        |
| `operation` | æ¯”è¼ƒæ¼”ç®—å­ï¼š`equals`, `not_equals`, `exists`, `in`, `gte`, `lte`, ãªã©            |
| `value`     | æ¯”è¼ƒå¯¾è±¡ã®å€¤ï¼ˆæ–‡å­—åˆ—ãƒ»æ•°å€¤ãƒ»çœŸå½å€¤ï¼‰                                                        |

**æ¡ä»¶ã®çµ„ã¿åˆã‚ã›æ§‹æ–‡**

```
"transition": {
  "approved": {
    "any_of": [
      [ æ¡ä»¶A1, æ¡ä»¶A2 ], // A1 AND A2
      [ æ¡ä»¶B1 ]          // OR B1
    ]
  }
}

```

- å¤–å´é…åˆ—ï¼šORæ¡ä»¶
- å†…å´é…åˆ—ï¼šANDæ¡ä»¶

**è¨­å®šä¾‹**

```json
{
  "request": {},
  "pre_hook": {},
  "execution": {},
  "post_hook": {},
  "transition": {
    "approved": {
      "any_of": [
        [
          {
            "path": "$.request_body.application_id",
            "type": "string",
            "operation": "exists",
            "value": true
          },
          {
            "path": "$.processes.callback-result.status",
            "type": "string",
            "operation": "equals",
            "value": "success"
          }
        ]
      ]
    },
    "rejected": {
      "any_of": [
        {
          "path": "$.processes.callback-result.status",
          "type": "string",
          "operation": "equals",
          "value": "rejected"
        }
      ]
    },
    "cancelled": {
      "any_of": [
        [
          {
            "path": "$.processes.apply.success_count",
            "type": "integer",
            "operation": "gte",
            "value": 1
          }
        ]
      ]
    }
  },
  "store": {},
  "response": {}
}
```

**è©•ä¾¡ãƒ«ãƒ¼ãƒ«ï¼ˆãƒ­ã‚¸ãƒƒã‚¯ï¼‰**

- transition ã«å®šç¾©ã•ã‚ŒãŸçŠ¶æ…‹ã”ã¨ã«æ¡ä»¶ã‚’è©•ä¾¡
- å„çŠ¶æ…‹ã® any_of â†’ ã©ã‚Œã‹1ã‚°ãƒ«ãƒ¼ãƒ—ãŒã™ã¹ã¦æˆç«‹ã™ã‚Œã°OK
- æœ€åˆã«æˆç«‹ã—ãŸçŠ¶æ…‹ã«é·ç§»ã™ã‚‹
- æ¡ä»¶ãŒç©ºã€ã¾ãŸã¯ã©ã‚Œã‚‚æˆç«‹ã—ãªã‘ã‚Œã°é·ç§»ã—ãªã„

**pathã®æŒ‡å®šæ–¹æ³•**

| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå                 | å†…å®¹                                    |
|-------------------------|---------------------------------------|
| `request_body`          | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ç”³è«‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆç”»é¢å…¥åŠ›å€¤ãªã©ï¼‰            |
| `request_attributes`    | èªè¨¼æƒ…å ±ã‚„HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±æ€§           |
| `application`           | ç¾åœ¨ã®ç”³è¾¼ã¿æƒ…å ±                              |
| `additional_parameters` | pre_hookã§è¿½åŠ ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿                    |
| `response_status_code`  | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã€‚ |
| `response_headers`      | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã€‚      |
| `response_body`         | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸå ´åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒœãƒ‡ã‚£ãƒ¼ã€‚    |

### 6. Store ãƒ•ã‚§ãƒ¼ã‚º

**ç›®çš„**: å‡¦ç†çµæœã®æ°¸ç¶šåŒ–

**ä¸»ãªæ©Ÿèƒ½**:

- ç”³è¾¼ã¿ã®è©³ç´°ã¨ã—ã¦ä¿å­˜ã™ã‚‹å¯¾è±¡ã®ãƒãƒƒãƒ”ãƒ³ã‚°

**è¨­å®šä¾‹**:

```json
{
  "request": {},
  "pre_hook": {},
  "execution": {},
  "post_hook": {},
  "transition": {},
  "store": {
    "application_details_mapping_rules": [
      {
        "from": "$.request_body",
        "to": "*"
      },
      {
        "from": "$.response_body.application_id",
        "to": "application_id"
      },
      {
        "from": "$.response_body.application_id",
        "to": "external_application_id"
      },
      {
        "from": "$.response_body.status",
        "to": "process_status"
      },
      {
        "from": "$.request_attributes.headers",
        "to": "*"
      }
    ]
  },
  "response": {}
}
```

**å‡¦ç†å†…å®¹**:

1. ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜
2. ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿ã®ä¿å­˜

**mapping_rules fromã®æŒ‡å®šæ–¹æ³•**

from ã§å‚ç…§ã§ãã‚‹ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šï¼š

| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå                 | å†…å®¹                                    |
|-------------------------|---------------------------------------|
| `request_body`          | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ç”³è«‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆç”»é¢å…¥åŠ›å€¤ãªã©ï¼‰            |
| `request_attributes`    | èªè¨¼æƒ…å ±ã‚„HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±æ€§           |
| `user`                  | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆ`sub`, `email`, `name` ãªã©ï¼‰     |
| `application`           | ç¾åœ¨ã®ç”³è¾¼ã¿æƒ…å ±                              |
| `additional_parameters` | pre_hookãƒ»post_hookã§è¿½åŠ ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿          |
| `response_status_code`  | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã€‚ |
| `response_headers`      | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã€‚      |
| `response_body`         | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸå ´åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒœãƒ‡ã‚£ãƒ¼ã€‚    |

---

### 7. Response ãƒ•ã‚§ãƒ¼ã‚º

**ç›®çš„**: ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹æ§‹ç¯‰

**ä¸»ãªæ©Ÿèƒ½**:

- ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ‡ãƒ¼ã‚¿æ§‹ç¯‰

**è¨­å®šä¾‹**:

```json
{
  "request": {},
  "pre_hook": {},
  "execution": {},
  "post_hook": {},
  "transition": {},
  "store": {},
  "response": {
    "body_mapping_rules": [
      {
        "from": "$.response_body.application_id",
        "to": "application_id"
      },
      {
        "from": "$.response_body.status",
        "to": "status"
      },
      {
        "from": "$.response_body.message",
        "to": "message"
      }
    ]
  }
}
```

**å‡¦ç†å†…å®¹**:

1. å¿…è¦ãªãƒ‡ãƒ¼ã‚¿ã®ãƒãƒƒãƒ”ãƒ³ã‚°

**mapping_rules fromã®æŒ‡å®šæ–¹æ³•**

from ã§å‚ç…§ã§ãã‚‹ãƒˆãƒƒãƒ—ãƒ¬ãƒ™ãƒ«ã®ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã¯ä»¥ä¸‹ã®é€šã‚Šï¼š

| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå                 | å†…å®¹                                    |
|-------------------------|---------------------------------------|
| `request_body`          | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ç”³è«‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆç”»é¢å…¥åŠ›å€¤ãªã©ï¼‰            |
| `request_attributes`    | èªè¨¼æƒ…å ±ã‚„HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±æ€§           |
| `user`                  | ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ï¼ˆ`sub`, `email`, `name` ãªã©ï¼‰     |
| `application`           | ç¾åœ¨ã®ç”³è¾¼ã¿æƒ…å ±                              |
| `additional_parameters` | pre_hookãƒ»post_hookã§è¿½åŠ ã—ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿          |
| `response_status_code`  | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚³ãƒ¼ãƒ‰ã€‚ |
| `response_headers`      | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸéš›ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã€‚      |
| `response_body`         | executionã§å¤–éƒ¨APIã‚’åˆ©ç”¨ã—ãŸå ´åˆã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ãƒœãƒ‡ã‚£ãƒ¼ã€‚    |

## èº«å…ƒç¢ºèªçµæœ

èº«å…ƒç¢ºèªãŒå®Œäº†å¾Œã«ä¿å­˜ã™ã‚‹ `verified_claims`ã¨ `source_details` ã®ãƒãƒƒãƒ”ãƒ³ã‚°ãƒ«ãƒ¼ãƒ«ã‚’å®šç¾©ã—ã¾ã™ã€‚

**ä¾‹**

```json
{
  "result": {
    "verified_claims_mapping_rules": [
      {
        "static_value": "jp_aml",
        "to": "verification.trust_framework"
      },
      {
        "from": "$.request_body.verification.evidence[0].type",
        "to": "verification.evidence.0.type"
      },
      {
        "from": "$.request_body.verification.evidence[0].check_details[0].check_method",
        "to": "verification.evidence.0.check_details.0.check_method"
      },
      {
        "from": "$.request_body.verification.evidence[0].check_details[0].organization",
        "to": "verification.evidence.0.check_details.0.organization"
      },
      {
        "from": "$.request_body.claims.given_name",
        "to": "claims.given_name"
      },
      {
        "from": "$.request_body.claims.address.postal_code",
        "to": "claims.address.postal_code"
      }
    ]
  },
  "source_details_mapping_rules": [
    {
      "from": "$.application.application_details",
      "to": "*"
    }
  ]
}
```

| ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆå              | å†…å®¹                          |
|----------------------|-----------------------------|
| `request_body`       | ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ç”³è«‹ãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒœãƒ‡ã‚£ï¼ˆç”»é¢å…¥åŠ›å€¤ãªã©ï¼‰  |
| `request_attributes` | èªè¨¼æƒ…å ±ã‚„HTTPãƒªã‚¯ã‚¨ã‚¹ãƒˆãƒ˜ãƒƒãƒ€ãƒ¼ç­‰ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆå±æ€§ |
| `application`        | ç”³è¾¼ã¿æƒ…å ±                       |

### verified_claimsã‚¹ã‚­ãƒ¼ãƒã®ä¾‹

```json
{
  "verification": {
    "trust_framework": "idv",
    "time": "2025-06-01T00:00:00Z"
  },
  "claims": {
    "given_name": "ä¸€éƒ",
    "family_name": "ä¼Šè—¤",
    "birthdate": "1990-01-01",
    "email": "ichiro@example.com"
  }
}
```

- verified_claimsã¯å‹•çš„ãªJSONæ§‹é€ ã§ä¿å­˜ã•ã‚Œã€èªè¨¼ãƒ•ãƒ­ãƒ¼å†…ã§IDãƒˆãƒ¼ã‚¯ãƒ³ã‚„userinfoã«åæ˜ ã€‚
- ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãŒãã®ã¾ã¾ä½¿ãˆãªã„å ´åˆã§ã‚‚ã€mapping_rulesã‚’ä½¿ã£ã¦æ§‹é€ ã‚’å¤‰æ›å¯èƒ½ã€‚
- nested arrayã‚„objectã®ãƒãƒƒãƒ”ãƒ³ã‚°ã«ã‚‚å¯¾å¿œã€‚

## è¨¼åˆ¸å£åº§é–‹è¨­ã‚’æƒ³å®šã—ãŸè¨­å®šä¾‹

```json
{
  "id": "666bae10-bc0d-41ce-92b4-53359b2f8439",
  "type": "investment-account-opening",
  "common": {
    "external_service": "mocky",
    "callback_application_id_param": "application_id"
  },
  "processes": {
    "apply": {
      "request": {
        "schema": {
          "type": "object",
          "required": [
            "last_name",
            "first_name",
            "last_name_kana",
            "first_name_kana",
            "birthdate",
            "nationality",
            "email_address",
            "mobile_phone_number",
            "address"
          ],
          "properties": {
            "last_name": {
              "type": "string",
              "maxLength": 255
            },
            "first_name": {
              "type": "string",
              "maxLength": 255
            },
            "last_name_kana": {
              "type": "string",
              "maxLength": 255
            },
            "first_name_kana": {
              "type": "string",
              "maxLength": 255
            },
            "birthdate": {
              "type": "string",
              "format": "date"
            },
            "nationality": {
              "type": "string",
              "maxLength": 255
            },
            "email_address": {
              "type": "string",
              "maxLength": 255,
              "pattern": "^[\\w\\.-]+@[\\w\\.-]+\\.[a-zA-Z]{2,}$"
            },
            "mobile_phone_number": {
              "type": "string",
              "maxLength": 11,
              "pattern": "^[0-9]{10,11}$"
            },
            "address": {
              "type": "object",
              "properties": {
                "street_address": {
                  "type": "string",
                  "maxLength": 255
                },
                "locality": {
                  "type": "string",
                  "maxLength": 255
                },
                "region": {
                  "type": "string",
                  "maxLength": 255
                },
                "postal_code": {
                  "type": "string",
                  "maxLength": 255
                },
                "country": {
                  "type": "string",
                  "maxLength": 255
                }
              }
            }
          }
        }
      },
      "pre_hook": {
        "verifications": [
          {
            "type": "user_claim",
            "details": {
              "verification_parameters": [
                {
                  "request_json_path": "$.mobile_phone_number",
                  "user_claim_json_path": "phone_number"
                }
              ]
            }
          }
        ],
        "additional_parameters": [
          {
            "type": "http_request",
            "details": {
              "url": "http://mockoon:4000/apply",
              "method": "POST",
              "static_headers": {
                "Content-Type": "application/json",
                "Authorization": "Bearer dummy-token"
              },
              "body_mapping_rules": [
                {
                  "from": "$.request_body",
                  "to": "*"
                }
              ],
              "response_schema": {
                "type": "object",
                "required": [
                  "application_id"
                ],
                "properties": {
                  "application_id": {
                    "type": "string"
                  }
                }
              }
            }
          }
        ]
      },
      "execution": {
        "type": "http_request",
        "http_request": {
          "url": "http://mockoon:4000/apply",
          "method": "POST",
          "header_mapping_rules": [
            {
              "static_value": "application/json",
              "to": "Content-Type"
            },
            {
              "static_value": "Bearer dummy-token",
              "to": "Authorization"
            }
          ],
          "body_mapping_rules": [
            {
              "from": "$.request_body",
              "to": "*"
            }
          ]
        }
      },
      "post_hook": {},
      "store": {
        "application_details_mapping_rules": [
          {
            "from": "$.request_body",
            "to": "*"
          },
          {
            "from": "$.response_body.application_id",
            "to": "application_id"
          },
          {
            "from": "$.response_body.application_id",
            "to": "external_application_id"
          }
        ]
      },
      "response": {
        "body_mapping_rules": [
          {
            "from": "$.response_body",
            "to": "*"
          },
          {
            "from": "$.response_body.application_id",
            "to": "external_application_id"
          }
        ]
      }
    },
    "request-ekyc": {
      "request_schema": {
        "type": "object",
        "required": [
          "trust_framework",
          "evidence_document_type"
        ],
        "properties": {
          "trust_framework": {
            "type": "string",
            "maxLength": 100
          },
          "evidence_document_type": {
            "type": "string",
            "maxLength": 50
          }
        }
      },
      "execution": {
        "type": "http_request",
        "http_request": {
          "url": "http://mockoon:4000/{{external_application_id}}/request-ekyc",
          "method": "POST",
          "header_mapping_rules": [
            {
              "static_value": "application/json",
              "to": "Content-Type"
            },
            {
              "static_value": "Bearer dummy-token",
              "to": "Authorization"
            }
          ],
          "path_mapping_rules": [
            {
              "from": "$.application.application_details.external_application_id",
              "to": "external_application_id"
            }
          ],
          "body_mapping_rules": [
            {
              "from": "$.request_body.trust_framework",
              "to": "trust_framework"
            },
            {
              "from": "$.request_body.evidence_document_type",
              "to": "evidence_document_type"
            }
          ]
        }
      },
      "store": {
        "application_details_mapping_rules": [
          {
            "from": "$.request_body",
            "to": "*"
          }
        ]
      },
      "response": {
        "body_mapping_rules": [
          {
            "from": "$.response_body",
            "to": "*"
          }
        ]
      }
    },
    "complete-ekyc": {
      "request_schema": {
        "type": "object",
        "required": [],
        "properties": {},
        "additionalProperties": false
      },
      "execution": {
        "type": "http_request",
        "http_request": {
          "url": "http://mockoon:4000/{{external_application_id}}/complete-ekyc",
          "method": "POST",
          "header_mapping_rules": [
            {
              "static_value": "application/json",
              "to": "Content-Type"
            },
            {
              "static_value": "Bearer dummy-token",
              "to": "Authorization"
            }
          ],
          "path_mapping_rules": [
            {
              "from": "$.application.application_details.external_application_id",
              "to": "external_application_id"
            }
          ],
          "body_mapping_rules": [
            {
              "from": "$.request_body",
              "to": "*"
            }
          ]
        }
      },
      "store": {
        "application_details_mapping_rules": [
          {
            "from": "$.request_body",
            "to": "*"
          },
          {
            "from": "$.response_body",
            "to": "*"
          }
        ]
      },
      "response": {
        "body_mapping_rules": [
          {
            "from": "$.response_body",
            "to": "*"
          }
        ]
      }
    },
    "crm-registration": {
      "request_schema": {
        "type": "object",
        "required": [],
        "properties": {}
      },
      "execution": {
        "type": "http_request",
        "http_request": {
          "url": "http://mockoon:4000/crm-registration",
          "method": "POST",
          "auth_type": "hmac_sha256",
          "hmac_authentication": {
            "api_key": "abcdef123456",
            "secret": "super-secret-key",
            "signature_format": "HmacSHA256={signature}",
            "signing_fields": [
              "method",
              "path",
              "timestamp",
              "body"
            ]
          },
          "header_mapping_rules": [
            {
              "static_value": "application/json",
              "to": "Content-Type"
            }
          ],
          "body_mapping_rules": [
            {
              "from": "$.request_body",
              "to": "*"
            }
          ]
        }
      },
      "store": {
        "application_details_mapping_rules": [
          {
            "from": "$.request_body",
            "to": "*"
          },
          {
            "from": "$.response_body",
            "to": "*"
          }
        ]
      },
      "response": {
        "body_mapping_rules": [
          {
            "from": "$.response_body",
            "to": "*"
          }
        ]
      }
    },
    "callback-examination": {
      "type": "callback",
      "request": {
        "basic_auth": {
          "username": "test_user",
          "password": "test_user001"
        },
        "schema": {
          "type": "object",
          "required": [
            "application_id"
          ],
          "properties": {
            "application_id": {
              "type": "string"
            },
            "step": {
              "type": "string"
            },
            "comment": {
              "type": "string"
            },
            "rejected": {
              "type": "boolean"
            }
          }
        }
      }
    },
    "cancel": {
      "execution": {
        "type": "no_action"
      },
      "transition": {
        "canceled": {
          "any_of": [
            [
              {
                "path": "$.application.processes.apply.success_count",
                "type": "integer",
                "operation": "gte",
                "value": 1
              }
            ]
          ]
        }
      }
    },
    "callback-result": {
      "request": {
        "basic_auth": {
          "username": "test_user",
          "password": "test_user001"
        },
        "schema": {
          "type": "object",
          "required": [
            "application_id",
            "verification",
            "claims"
          ],
          "properties": {
            "application_id": {
              "type": "string"
            },
            "verification": {
              "type": "object"
            },
            "claims": {
              "type": "object"
            }
          }
        }
      },
      "transition": {
        "approved": {
          "any_of": [
            [
              {
                "path": "$.request_body.application_id",
                "type": "string",
                "operation": "exists",
                "value": true
              },
              {
                "path": "$.application.processes.apply.success_count",
                "type": "integer",
                "operation": "gte",
                "value": 1
              },
              {
                "path": "$.application.processes.callback-examination.success_count",
                "type": "integer",
                "operation": "gte",
                "value": 1
              }
            ]
          ]
        }
      }
    }
  },
  "result": {
    "verified_claims_mapping_rules": [
      {
        "static_value": "jp_aml",
        "to": "verification.trust_framework"
      },
      {
        "from": "$.request_body.verification.evidence[0].type",
        "to": "verification.evidence.0.type"
      },
      {
        "from": "$.request_body.verification.evidence[0].check_details[0].check_method",
        "to": "verification.evidence.0.check_details.0.check_method"
      },
      {
        "from": "$.request_body.verification.evidence[0].check_details[0].organization",
        "to": "verification.evidence.0.check_details.0.organization"
      },
      {
        "from": "$.request_body.verification.evidence[0].check_details[0].txn",
        "to": "verification.evidence.0.check_details.0.txn"
      },
      {
        "from": "$.request_body.verification.evidence[0].time",
        "to": "verification.evidence.0.time"
      },
      {
        "from": "$.request_body.verification.evidence[0].record.type",
        "to": "verification.evidence.0.record.type"
      },
      {
        "from": "$.request_body.verification.evidence[0].record.source.name",
        "to": "verification.evidence.0.record.source.name"
      },
      {
        "from": "$.request_body.verification.evidence[1].type",
        "to": "verification.evidence.1.type"
      },
      {
        "from": "$.request_body.verification.evidence[1].check_details[0].check_method",
        "to": "verification.evidence.1.check_details.0.check_method"
      },
      {
        "from": "$.request_body.verification.evidence[1].check_details[0].organization",
        "to": "verification.evidence.1.check_details.0.organization"
      },
      {
        "from": "$.request_body.verification.evidence[1].check_details[0].txn",
        "to": "verification.evidence.1.check_details.1.txn"
      },
      {
        "from": "$.request_body.verification.evidence[1].time",
        "to": "verification.evidence.1.time"
      },
      {
        "from": "$.request_body.verification.evidence[1].record.type",
        "to": "verification.evidence.1.record.type"
      },
      {
        "from": "$.request_body.verification.evidence[1].record.source.name",
        "to": "verification.evidence.1.record.source.name"
      },
      {
        "from": "$.request_body.claims.given_name",
        "to": "claims.given_name"
      },
      {
        "from": "$.request_body.claims.family_name",
        "to": "claims.family_name"
      },
      {
        "from": "$.request_body.claims.birthdate",
        "to": "claims.birthdate"
      },
      {
        "from": "$.request_body.claims.place_of_birth.country",
        "to": "claims.place_of_birth.country"
      },
      {
        "from": "$.request_body.claims.address.locality",
        "to": "claims.address.locality"
      },
      {
        "from": "$.request_body.claims.address.postal_code",
        "to": "claims.address.postal_code"
      },
      {
        "from": "$.request_body.claims.address.country",
        "to": "claims.address.country"
      },
      {
        "from": "$.request_body.claims.address.street_address",
        "to": "claims.address.street_address"
      }
    ],
    "source_details_mapping_rules": [
      {
        "from": "$.application.application_details",
        "to": "*"
      }
    ]
  }
}
```

## é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆ

èº«å…ƒç¢ºèªç”³è¾¼ã¿æ©Ÿèƒ½ã‚’åŠ¹æœçš„ã«åˆ©ç”¨ã™ã‚‹ãŸã‚ã«ã€ä»¥ä¸‹ã®é–¢é€£ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã‚‚ã”å‚ç…§ãã ã•ã„ï¼š

### APIä»•æ§˜æ›¸
- [ãƒªã‚½ãƒ¼ã‚¹ã‚ªãƒ¼ãƒŠãƒ¼ç”¨APIä»•æ§˜](/docs/content_07_reference/api-resource-owner-ja/) - èº«å…ƒç¢ºèªé–¢é€£ã®ç”³è¾¼ã¿APIã®è©³ç´°ä»•æ§˜
- [ç®¡ç†ç”¨APIä»•æ§˜](/docs/content_07_reference/control-plane-api-ja/) - ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆè¨­å®šç”¨ã®ç®¡ç†APIä»•æ§˜
- [å†…éƒ¨ã‚·ã‚¹ãƒ†ãƒ é€£æºAPIä»•æ§˜](/docs/content_07_reference/api-internal-ja/) - å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æºç”¨ã®ã‚³ãƒ¼ãƒ«ãƒãƒƒã‚¯APIä»•æ§˜