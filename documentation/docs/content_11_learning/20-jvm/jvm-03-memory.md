# メモリ管理

## はじめに

JVMのメモリ管理を理解することは、アプリケーションのパフォーマンス最適化とトラブルシューティングに不可欠です。この章では、JVMの各メモリ領域の役割と特徴を解説します。

---

## JVMメモリ構造の全体像

```
┌─────────────────────────────────────────────────────────────────────┐
│                           JVM Process                                │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                         Heap                                    │ │
│  │  ┌─────────────────────────┐  ┌─────────────────────────────┐  │ │
│  │  │      Young Generation    │  │       Old Generation        │  │ │
│  │  │  ┌─────┐ ┌────┐ ┌────┐  │  │                             │  │ │
│  │  │  │Eden │ │ S0 │ │ S1 │  │  │   Long-lived objects        │  │ │
│  │  │  └─────┘ └────┘ └────┘  │  │                             │  │ │
│  │  └─────────────────────────┘  └─────────────────────────────┘  │ │
│  │                      -Xms / -Xmx                                │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                        Metaspace                                │ │
│  │  クラスメタデータ、定数プール、メソッド情報                     │ │
│  │                   -XX:MaxMetaspaceSize                          │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  ┌───────────────────┐  ┌───────────────────┐  ┌─────────────────┐ │
│  │   Thread Stacks   │  │   Code Cache      │  │  Direct Memory  │ │
│  │   -Xss            │  │   JIT compiled    │  │  NIO buffers    │ │
│  └───────────────────┘  └───────────────────┘  └─────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## ヒープ（Heap）

### 概要

ヒープは、オブジェクトインスタンスと配列が格納される領域です。GC（ガベージコレクション）の対象となります。

### 世代別構成

```
┌─────────────────────────────────────────────────────────────────────┐
│                           Heap                                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Young Generation（若い世代）                                        │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │  ┌──────────────────────────────┐                              │ │
│  │  │           Eden               │  新しいオブジェクトはここに   │ │
│  │  │                              │  割り当てられる               │ │
│  │  └──────────────────────────────┘                              │ │
│  │                                                                 │ │
│  │  ┌────────────────┐  ┌────────────────┐                        │ │
│  │  │  Survivor 0    │  │  Survivor 1    │  Eden から生き残った    │ │
│  │  │   (From)       │  │    (To)        │  オブジェクトがコピー   │ │
│  │  └────────────────┘  └────────────────┘                        │ │
│  │                                                                 │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  Old Generation（古い世代）                                          │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                                                                 │ │
│  │  長期間生存したオブジェクト                                     │ │
│  │  （Survivor を何度か経由したもの）                              │ │
│  │                                                                 │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### オブジェクトのライフサイクル

```
1. new Object()
       │
       ↓
   Eden に割り当て
       │
       ↓ (Minor GC発生)
       │
   ┌───┴───┐
   │       │
 生存    死亡 → 回収
   │
   ↓
 Survivor へコピー
   (年齢 +1)
       │
       ↓ (Minor GC繰り返し)
       │
 年齢が閾値に達する
   (デフォルト: 15)
       │
       ↓
  Old Generation へ昇格
       │
       ↓ (Major GC発生)
       │
   ┌───┴───┐
   │       │
 生存    死亡 → 回収
```

### ヒープサイズの設定

```bash
# 初期ヒープサイズと最大ヒープサイズ
java -Xms512m -Xmx2g -jar app.jar

# 同じ値に設定するのが推奨（動的リサイズのオーバーヘッド回避）
java -Xms2g -Xmx2g -jar app.jar
```

| オプション | 説明 | 推奨設定 |
|-----------|------|---------|
| `-Xms` | 初期ヒープサイズ | `-Xmx`と同じ値 |
| `-Xmx` | 最大ヒープサイズ | 物理メモリの50-70% |
| `-Xmn` | Young Generationサイズ | 通常は自動調整に任せる |

### 世代別サイズ比率

```bash
# Young Generation の割合を指定
java -XX:NewRatio=2 -jar app.jar  # Old:Young = 2:1

# Survivor の割合を指定
java -XX:SurvivorRatio=8 -jar app.jar  # Eden:S0:S1 = 8:1:1
```

---

## スタック（Stack）

### 概要

各スレッドには専用のスタックがあり、メソッド呼び出しごとにスタックフレームが積まれます。

```
┌─────────────────────────────────────────────────────────────────────┐
│                        Thread Stack                                  │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                    Stack Frame (methodC)                        │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐   │ │
│  │  │ローカル変数   │ │オペランド    │ │フレームデータ        │   │ │
│  │  │テーブル       │ │スタック      │ │(戻りアドレス等)      │   │ │
│  │  └──────────────┘ └──────────────┘ └──────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                    Stack Frame (methodB)                        │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐   │ │
│  │  │ローカル変数   │ │オペランド    │ │フレームデータ        │   │ │
│  │  │テーブル       │ │スタック      │ │                      │   │ │
│  │  └──────────────┘ └──────────────┘ └──────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                    Stack Frame (methodA)                        │ │
│  │  ┌──────────────┐ ┌──────────────┐ ┌──────────────────────┐   │ │
│  │  │ローカル変数   │ │オペランド    │ │フレームデータ        │   │ │
│  │  │テーブル       │ │スタック      │ │                      │   │ │
│  │  └──────────────┘ └──────────────┘ └──────────────────────┘   │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│                              ↓ スタックの成長方向                    │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### スタックフレームの構成

| 要素 | 内容 |
|-----|------|
| ローカル変数テーブル | メソッドの引数とローカル変数 |
| オペランドスタック | 演算の中間結果 |
| フレームデータ | 戻りアドレス、例外ハンドラ情報 |

### スタックサイズの設定

```bash
# スレッドスタックサイズ（デフォルト: 1MB on Linux 64-bit）
java -Xss512k -jar app.jar
```

### StackOverflowError

スタックが溢れると `StackOverflowError` が発生します。

```java
// 無限再帰
public void infiniteRecursion() {
    infiniteRecursion();  // StackOverflowError
}

// 深い再帰
public long factorial(int n) {
    if (n <= 1) return 1;
    return n * factorial(n - 1);  // 大きな n で StackOverflowError
}
```

---

## Metaspace

### 概要

Java 8以降、クラスメタデータはヒープ外の Metaspace に格納されます（Java 7 以前は PermGen）。

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Metaspace                                    │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌────────────────────────────────────────────────────────────────┐ │
│  │                    Class Metadata                               │ │
│  │  ・クラス構造（フィールド、メソッド情報）                       │ │
│  │  ・バイトコード                                                 │ │
│  │  ・定数プール                                                   │ │
│  │  ・アノテーション                                               │ │
│  └────────────────────────────────────────────────────────────────┘ │
│                                                                      │
│  特徴:                                                               │
│  ・ネイティブメモリ（ヒープ外）に配置                               │
│  ・デフォルトでは無制限（OSのメモリまで使用可能）                   │
│  ・クラスローダーがGCされるとアンロード                            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### PermGen との違い

| 項目 | PermGen (Java 7以前) | Metaspace (Java 8以降) |
|-----|---------------------|----------------------|
| 配置場所 | ヒープ内 | ネイティブメモリ |
| デフォルトサイズ | 固定（64MB等） | 無制限 |
| 拡張 | 固定サイズ | 動的に拡張 |
| GC | Full GC時 | ClassLoaderがGC時 |

### サイズ設定

```bash
# 最大Metaspaceサイズを制限
java -XX:MaxMetaspaceSize=256m -jar app.jar

# 初期サイズを設定
java -XX:MetaspaceSize=128m -jar app.jar
```

### Metaspace 監視

```bash
# jstat でMetaspaceを監視
jstat -gcmetacapacity <pid> 1000

# jcmd で詳細確認
jcmd <pid> VM.metaspace
```

---

## Code Cache

### 概要

JITコンパイラが生成したネイティブコードが格納される領域です。

```
┌─────────────────────────────────────────────────────────────────────┐
│                         Code Cache                                   │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌───────────────────┐ ┌───────────────────┐ ┌──────────────────┐  │
│  │  Non-method       │ │  Profiled Code    │ │  Non-profiled    │  │
│  │  Code             │ │  (C1 compiled)    │ │  Code            │  │
│  │                   │ │                   │ │  (C2 compiled)   │  │
│  │  JVM内部コード    │ │  軽度最適化       │ │  高度最適化      │  │
│  └───────────────────┘ └───────────────────┘ └──────────────────┘  │
│                                                                      │
│  デフォルト: 240MB (64-bit JVM)                                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

### サイズ設定

```bash
# Code Cacheサイズ設定
java -XX:ReservedCodeCacheSize=256m -jar app.jar

# 初期サイズ
java -XX:InitialCodeCacheSize=64m -jar app.jar
```

### Code Cache が満杯になると

Code Cacheが満杯になると、JITコンパイルが停止し、パフォーマンスが低下します。

```
Java HotSpot(TM) 64-Bit Server VM warning: CodeCache is full.
Compiler has been disabled.
```

---

## Direct Memory

### 概要

NIO（New I/O）で使用されるオフヒープメモリです。`ByteBuffer.allocateDirect()` で確保されます。

```java
// Direct Bufferの確保
ByteBuffer buffer = ByteBuffer.allocateDirect(1024 * 1024);  // 1MB
```

### 特徴

| 項目 | Heap Buffer | Direct Buffer |
|-----|-------------|---------------|
| 配置場所 | ヒープ内 | ネイティブメモリ |
| GC対象 | はい | 間接的（参照がなくなった時） |
| I/O効率 | コピーが必要 | ゼロコピー可能 |
| 確保コスト | 低い | 高い |

### サイズ設定

```bash
# Direct Memoryの最大サイズ（デフォルト: -Xmx と同じ）
java -XX:MaxDirectMemorySize=512m -jar app.jar
```

---

## メモリ領域のサマリー

```
┌─────────────────────────────────────────────────────────────────────┐
│                        JVMメモリ領域一覧                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  領域              設定オプション              デフォルト            │
│  ─────────────────────────────────────────────────────────────────  │
│  Heap              -Xms, -Xmx                  物理メモリの1/4       │
│  Metaspace         -XX:MaxMetaspaceSize        無制限                │
│  Thread Stack      -Xss                        1MB                   │
│  Code Cache        -XX:ReservedCodeCacheSize   240MB                 │
│  Direct Memory     -XX:MaxDirectMemorySize     -Xmxと同じ            │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘
```

---

## メモリ使用量の確認

### jcmd

```bash
# ネイティブメモリトラッキング有効化
java -XX:NativeMemoryTracking=summary -jar app.jar

# メモリサマリー表示
jcmd <pid> VM.native_memory summary

# 詳細表示
jcmd <pid> VM.native_memory detail
```

出力例:
```
Native Memory Tracking:

Total: reserved=5GB, committed=1GB

-                 Java Heap (reserved=4GB, committed=512MB)
                            (mmap: reserved=4GB, committed=512MB)

-                     Class (reserved=1GB, committed=50MB)
                            (classes #10000)
                            (malloc=5MB #50000)
                            (mmap: reserved=1GB, committed=45MB)

-                    Thread (reserved=100MB, committed=100MB)
                            (thread #100)
                            (stack: reserved=100MB, committed=100MB)
```

### jstat

```bash
# ヒープ使用状況を1秒間隔で表示
jstat -gc <pid> 1000

# 出力列の意味
# S0C   S0U   S1C   S1U   EC     EU     OC      OU      MC     MU
# 容量  使用  容量  使用  Eden   Eden   Old     Old     Meta   Meta
#             Survivor     容量   使用   容量    使用    容量   使用
```

### VisualVM / JConsole

GUIツールでリアルタイムにメモリ使用量を可視化できます。

```bash
# JConsole起動
jconsole

# VisualVM起動（別途インストール）
visualvm
```

---

## OutOfMemoryError の種類

| エラーメッセージ | 原因 | 対処 |
|-----------------|------|------|
| `Java heap space` | ヒープ不足 | `-Xmx`増加、メモリリーク調査 |
| `Metaspace` | クラスメタデータ領域不足 | `-XX:MaxMetaspaceSize`増加 |
| `GC overhead limit exceeded` | GCに時間がかかりすぎ | ヒープ増加、アプリ改善 |
| `unable to create new native thread` | スレッド作成不可 | `-Xss`減少、スレッド数削減 |
| `Direct buffer memory` | Direct Memory不足 | `-XX:MaxDirectMemorySize`増加 |

---

## 本番環境の推奨設定

```bash
java \
  # ヒープ（同一サイズで固定）
  -Xms4g -Xmx4g \

  # Metaspace（上限設定）
  -XX:MaxMetaspaceSize=256m \

  # スタック（スレッド多い場合は小さく）
  -Xss512k \

  # Direct Memory
  -XX:MaxDirectMemorySize=512m \

  # OOM時にヒープダンプ
  -XX:+HeapDumpOnOutOfMemoryError \
  -XX:HeapDumpPath=/var/log/app/ \

  # Native Memory Tracking（デバッグ用）
  -XX:NativeMemoryTracking=summary \

  -jar app.jar
```

---

## まとめ

| 領域 | 格納内容 | GC対象 |
|-----|---------|-------|
| Heap | オブジェクトインスタンス、配列 | はい |
| Metaspace | クラスメタデータ、定数プール | ClassLoader経由 |
| Stack | ローカル変数、メソッド呼び出し情報 | いいえ（自動解放） |
| Code Cache | JITコンパイル済みコード | 部分的 |
| Direct Memory | NIO バッファ | 間接的 |

---

## 次のステップ

- [ガベージコレクション](jvm-04-gc.md) - ヒープの自動管理メカニズム
- [GCチューニング](jvm-05-gc-tuning.md) - 本番環境での最適化
