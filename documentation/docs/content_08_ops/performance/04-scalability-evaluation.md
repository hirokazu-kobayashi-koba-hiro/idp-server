# スケーラビリティ評価

本ドキュメントでは、idp-server のスケーラビリティについて評価・分析する。

---

## 評価観点

### 1. 水平スケーラビリティ
- インスタンス追加時のスループット向上率
- ロードバランサ配下での負荷分散効率

### 2. マルチテナントスケーラビリティ
- テナント数増加に伴う性能変化
- テナント間のリソース分離

### 3. データスケーラビリティ
- ユーザー数増加に伴う性能変化
- データベースクエリのスケール特性

---

## 水平スケーラビリティ

### テスト構成

| 構成 | インスタンス数 | CPU | メモリ |
|-----|--------------|-----|-------|
| 1インスタンス | 1 | 2コア | 2GB |
| 2インスタンス | 2 | 各2コア | 各2GB |

### 結果

| 構成 | TPS | p95 | スケール効率 |
|-----|-----|-----|------------|
| 1インスタンス | 約800 | 300ms | - |
| 2インスタンス | 約1,400 | 250ms | 87.5% |

### スケール効率計算

```
スケール効率 = (2インスタンスTPS / 1インスタンスTPS) / 2
             = (1400 / 800) / 2
             = 0.875 (87.5%)
```

### 考察

- **87.5%のスケール効率**は非常に良好
- ステートレス設計により効率的な負荷分散が可能
- ロードバランサのオーバーヘッドは最小限

:::tip
3インスタンス以上へのスケールアウトも線形に近い性能向上が期待できる。
:::

---

## マルチテナントスケーラビリティ

### テスト構成

マルチテナント環境でのCIBAフローを評価。

| テナント数 | 各テナント負荷 | 合計負荷 |
|-----------|--------------|---------|
| 1 | 20 iters/s | 20 iters/s |
| 5 | 20 iters/s | 100 iters/s |

### 結果

| テナント数 | 成功率 | 合計TPS | p95 | 1テナントあたりTPS |
|-----------|-------|--------|-----|------------------|
| 1 | 100.00% | 180 | 5.2ms | 180 |
| 5 | 99.90% | 493 | 1.19s | 98.6 |

### テナント効率

```
テナント効率 = 5テナント時の1テナントあたりTPS / 1テナント時のTPS
            = 98.6 / 180
            = 0.548 (54.8%)
```

### 考察

- テナント数増加に伴い1テナントあたりの処理能力は低下
- これはリソース共有に起因する正常な挙動
- Row Level Security (RLS) のオーバーヘッドも影響
- 高負荷時はテナント間でリソース競合が発生

### 改善策

1. **テナント別リソース制限**: QoS設定によるフェアシェアリング
2. **テナント別インスタンス**: 大規模テナントには専用インスタンス
3. **キャッシュ戦略強化**: テナント別キャッシュの最適化

---

## データスケーラビリティ

### ユーザー数とクエリ性能

| ユーザー数 | 認証デバイス検索 (旧) | 認証デバイス検索 (新) | 改善率 |
|----------|---------------------|---------------------|-------|
| 10万 | 約100ms | 約10ms | 10倍 |
| 100万 | 約1,700ms | 約0.11ms | 15,000倍 |

### インデックス最適化の効果

#### 旧方式（JSONB GINインデックス）

```sql
-- 実行計画
Parallel Seq Scan on idp_user  (cost=0.00..xxxxx rows=xxx)
  Filter: ((authentication_devices @> '[{"id": "..."}]'::jsonb))
```

- **問題**: RLS環境下でGINインデックスが無効化
- **結果**: O(n) のフルテーブルスキャン

#### 新方式（BTree PKインデックス）

```sql
-- 実行計画
Index Scan using idp_user_authentication_devices_pkey
  (cost=0.xx..8.xx rows=1 width=xxx)
```

- **改善**: インデックスが有効に機能
- **結果**: O(log n) の効率的な検索

### データ量増加シミュレーション

| ユーザー数 | 推定p95 | 推奨構成 |
|----------|--------|---------|
| 10万 | 100ms | 2インスタンス |
| 100万 | 500ms | 4インスタンス |
| 1000万 | 1s | 8インスタンス + DB分離 |

---

## スケーラビリティ限界

### アプリケーション層

| ボトルネック | 影響 | 対策 |
|------------|-----|-----|
| JVMヒープ | メモリ不足でOOM | ヒープサイズ増加 |
| スレッドプール | リクエスト待ち | maxThreads増加 |
| GCポーズ | レイテンシスパイク | GC戦略調整 |

### データベース層

| ボトルネック | 影響 | 対策 |
|------------|-----|-----|
| コネクションプール | 接続待ち | プールサイズ増加 |
| ロック競合 | デッドロック | トランザクション最適化 |
| I/O | クエリ遅延 | SSD、インデックス最適化 |

### キャッシュ層

| ボトルネック | 影響 | 対策 |
|------------|-----|-----|
| Redisメモリ | エビクション | メモリ増加、TTL調整 |
| ネットワーク | レイテンシ | ローカルキャッシュ併用 |

---

## 推奨スケール戦略

### 負荷レベル別構成

#### 小規模（〜100 req/s）

```yaml
services:
  idp-server:
    replicas: 2
    resources:
      limits:
        cpus: '2'
        memory: 2G
  postgresql:
    resources:
      limits:
        cpus: '2'
        memory: 4G
```

#### 中規模（〜1,000 req/s）

```yaml
services:
  idp-server:
    replicas: 4
    resources:
      limits:
        cpus: '4'
        memory: 4G
  postgresql:
    resources:
      limits:
        cpus: '4'
        memory: 8G
  redis:
    resources:
      limits:
        memory: 4G
```

#### 大規模（〜10,000 req/s）

```yaml
# Kubernetes構成
apiVersion: apps/v1
kind: Deployment
metadata:
  name: idp-server
spec:
  replicas: 10
  template:
    spec:
      containers:
      - name: idp-server
        resources:
          requests:
            cpu: "4"
            memory: "8Gi"
          limits:
            cpu: "8"
            memory: "16Gi"
---
# DBはマネージドサービス推奨
# - Amazon RDS (db.r5.xlarge以上)
# - Cloud SQL (db-custom-4-15360以上)
```

---

## スケーラビリティ改善ロードマップ

### 短期（現状で対応可能）

1. インスタンス追加によるスケールアウト
2. JVM/Tomcat設定の最適化
3. インデックス追加による DB最適化

### 中期

1. リードレプリカの導入
2. キャッシュ階層の強化
3. 非同期処理の拡大

### 長期

1. マイクロサービス化
2. イベントソーシング導入
3. グローバル分散配置

---

## 結論

idp-server は以下のスケーラビリティ特性を持つ：

| 観点 | 評価 | コメント |
|-----|-----|---------|
| 水平スケール | 優良 | 87.5%のスケール効率 |
| マルチテナント | 良好 | 5テナントで99.9%成功率 |
| データスケール | 優良 | 100万ユーザーでp95 < 500ms |

**総合評価**: 中規模（〜1,000 req/s）の本番環境に対応可能。
大規模環境では追加の最適化とインフラ投資が必要。

---

## 関連ドキュメント

- [テスト環境](./01-test-environment.md)
- [ストレステスト結果](./02-stress-test-results.md)
- [チューニングガイド](./05-tuning-guide.md)
