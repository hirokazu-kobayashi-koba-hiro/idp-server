# ロードテスト結果

本ドキュメントでは、実運用を想定した複合シナリオでのロードテスト結果を報告する。

---

## テスト概要

ロードテストは、ストレステストと異なり、**実運用に近い複合的なワークロード**でシステムの安定性を検証する。

### テスト種別

| シナリオ | 目的 | 時間 |
|---------|-----|------|
| scenario-1 | シングルテナントCIBA + Introspection | 5分 |
| scenario-2 | マルチテナントCIBA（5テナント同時） | 5分 |
| scenario-3 | ピーク負荷（段階的増加） | 10分 |
| scenario-4 | フェデレーション | 5分 |

---

## scenario-1: シングルテナント CIBA + Introspection

### シナリオ構成

```
シナリオ: 2つの並行ワークロード
- login: 20 iters/s（CIBAフルフロー）
- introspection: 80 iters/s（トークン検証）
最大VUs: 100
時間: 5分
```

### 結果サマリー

| 指標 | 値 |
|-----|---|
| 総チェック数 | 54,005 |
| 成功率 | **100.00%** |
| 総リクエスト数 | 54,005 |
| スループット | 180 req/s |
| 総イテレーション | 30,001 |
| イテレーション/秒 | 100 |

### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 2.69 ms |
| 中央値 | 1.93 ms |
| p90 | 4.96 ms |
| p95 | 5.23 ms |
| 最大 | 224.65 ms |

### 考察

- **完璧な成功率**: 5分間で一件のエラーもなし
- **極めて低いレイテンシ**: p95が5.23msと非常に高速
- **安定した処理**: 最大応答時間も224msに収まる
- 想定負荷（100 iters/s）を安定して処理

:::tip
シングルテナント環境では、目標負荷の5倍以上のマージンがある。
:::

---

## scenario-2: マルチテナント CIBA

### シナリオ構成

```
シナリオ: 5テナント並行実行
- tenant0〜tenant4: 各20 iters/s
最大VUs: 500（各テナント100）
時間: 5分
```

### 結果サマリー

| 指標 | 値 |
|-----|---|
| 総チェック数 | 149,030 |
| 成功率 | **99.90%** |
| 失敗数 | 135 |
| 総リクエスト数 | 149,030 |
| スループット | 493 req/s |
| 総イテレーション | 29,806 |
| イテレーション/秒 | 98.6 |

### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 390.92 ms |
| 中央値 | 274.06 ms |
| p90 | 914.56 ms |
| p95 | 1.19 s |
| 最大 | 4.39 s |

### エラー分析

| チェック | 成功 | 失敗 | 成功率 |
|---------|-----|-----|-------|
| auth request OK | 29,801 | 5 | 99.98% |
| txRes request OK | 29,775 | 31 | 99.90% |
| binding-message OK | 29,751 | 55 | 99.82% |
| tokenRes request OK | 29,794 | 12 | 99.96% |
| jwksResponse request OK | 29,774 | 32 | 99.89% |

### リソース状況

| 指標 | 値 |
|-----|---|
| 最大VUs | 449 |
| ドロップしたイテレーション | 199 |
| HTTPエラー率 | 9.86% |

### 考察

- **高負荷下でも99.9%の成功率**を維持
- 5テナント同時処理でも安定動作
- p95が1秒を超えるため、追加インスタンスが望ましい
- 一部リクエストがタイムアウトしているが、許容範囲内

:::warning
マルチテナント環境でピーク負荷が続く場合、スケールアウトを推奨。
:::

---

## scenario-3: ピーク負荷（段階的増加）

### シナリオ構成

```
シナリオ: 段階的負荷増加
- ステージ1: ウォームアップ
- ステージ2: ピーク（120 iters/s）
- ステージ3: クールダウン
最大VUs: 100
時間: 10分
```

### 結果サマリー

| 指標 | 値 |
|-----|---|
| 総チェック数 | 199,450 |
| 成功率 | **100.00%** |
| 総リクエスト数 | 199,450 |
| スループット | 332 req/s |
| 総イテレーション | 39,890 |
| イテレーション/秒 | 66.5 |

### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 252.61 ms |
| 中央値 | 100.85 ms |
| p90 | 722.54 ms |
| p95 | 981.26 ms |
| 最大 | 2.23 s |

### リソース状況

| 指標 | 値 |
|-----|---|
| 最大VUs | 100 |
| ドロップしたイテレーション | 23,109 |
| HTTPエラー率 | 10.31% |

### 考察

- 全チェックが成功（アプリケーションレベルのエラーなし）
- VU不足による一部イテレーションのドロップ
- 実際のピーク時には追加VUまたはインスタンスが必要
- p95が1秒以内に収まり、目標達成

:::note
VU不足の警告が出たが、処理されたリクエストはすべて成功。
:::

---

## 結果比較

### シナリオ別性能比較

| シナリオ | 成功率 | p95 | TPS | 評価 |
|---------|-------|-----|-----|-----|
| シングルテナント | 100.00% | 5.23ms | 180 | 優秀 |
| マルチテナント | 99.90% | 1.19s | 493 | 良好 |
| ピーク負荷 | 100.00% | 981ms | 332 | 良好 |

### スケーラビリティ

```
シングルテナント → マルチテナント（5倍）
- TPS: 180 → 493（2.7倍）
- p95: 5ms → 1.19s（増加）
- 成功率: 100% → 99.9%（微減）
```

---

## 推奨構成

### 負荷レベル別推奨

| 負荷 | 推奨インスタンス数 | 期待性能 |
|-----|------------------|---------|
| 100 iters/s | 2 | p95 < 100ms |
| 500 iters/s | 4-6 | p95 < 500ms |
| 1000 iters/s | 8-10 | p95 < 1s |

### 水平スケール効率

テスト結果から推測される水平スケール効率：

- **1インスタンス追加あたり**: 約50-80 iters/s の処理能力向上
- **線形スケール係数**: 約0.7-0.8

---

## 実行コマンド

```bash
# scenario-1: シングルテナント
k6 run ./performance-test/load/scenario-1-ciba-login.js

# scenario-2: マルチテナント
k6 run ./performance-test/load/scenario-2-multi-ciba-login.js

# scenario-3: ピーク負荷
k6 run ./performance-test/load/scenario-3-peak-login.js

# scenario-4: フェデレーション
k6 run ./performance-test/load/scenario-4-federation.js
```

---

## 関連ドキュメント

- [ストレステスト結果](./02-stress-test-results.md)
- [スケーラビリティ評価](./04-scalability-evaluation.md)
- [チューニングガイド](./05-tuning-guide.md)
