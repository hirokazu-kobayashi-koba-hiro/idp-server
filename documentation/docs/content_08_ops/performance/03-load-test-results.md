# ロードテスト結果

本ドキュメントでは、[テスト方針](./test-strategy)に基づいた測定観点別のロードテスト結果を報告する。

---

## テスト環境

| 項目 | 値 |
|-----|---|
| テスト実施日 | 2025-12-24 |
| idp-server | 2インスタンス（Docker Compose） |
| PostgreSQL | Primary + Replica |
| Redis | 1インスタンス |
| k6バージョン | 最新 |

### データ規模

| 項目 | 値 |
|-----|---|
| テナント数 | 10 |
| ユーザー数/テナント | 100,001 |
| 総ユーザー数 | 1,000,010 |
| k6テスト用ユーザー数 | 500/テナント |

---

## 1. ベースライン測定結果

最小構成での基準性能値。他の測定との比較基準となる。

### テスト条件

| 項目 | 値 |
|-----|---|
| テナント数 | 1 |
| DBユーザー数 | 100,001 |
| テスト使用ユーザー数 | 500（ランダム選択） |
| VU数 | 10 |
| ログインレート | 5 req/s |
| Introspectレート | 20 req/s |
| テスト時間 | 2分 |
| シナリオ | scenario-1-ciba-login.js |

### 結果サマリー

| 指標 | 結果 | 目標値 | 判定 |
|-----|-----|-------|-----|
| **成功率** | 100% | 99.9%以上 | ✅ 合格 |
| **エラー率** | 0% | 0.1%未満 | ✅ 合格 |
| **スループット** | 45.03 req/s | - | - |
| **イテレーション** | 25.00/s | - | - |

### レイテンシ

| 指標 | 値 | 目標値 | 判定 |
|-----|---|-------|-----|
| 平均応答時間 | 7.49ms | - | - |
| 中央値 | 6.28ms | - | - |
| p90 | 13.83ms | - | - |
| **p95** | 18.25ms | 500ms以下 | ✅ 合格 |
| 最大 | 54.69ms | - | - |

### チェック結果

| チェック | 成功 | 失敗 | 成功率 |
|---------|-----|-----|-------|
| status is 200 | 2401 | 0 | 100% |
| auth request OK | 600 | 0 | 100% |
| txRes request OK | 600 | 0 | 100% |
| binding-message OK | 600 | 0 | 100% |
| tokenRes request OK | 600 | 0 | 100% |
| jwksResponse request OK | 600 | 0 | 100% |

### 考察

- **ベースライン性能は極めて良好**: p95が18.25msで目標500msを大幅にクリア
- **100Kユーザー環境でも安定**: DBに100,001ユーザーが存在する状態でも性能劣化なし
- **完全な成功率**: 2分間で一件のエラーもなし
- この結果を基準として、負荷増加時の劣化率を評価する

---

## 2. 同時負荷影響測定結果

VU数を段階的に増加させ、ブレークポイントを特定する。

### テスト条件

| Step | VU数 | レート | テスト時間 | 状態 |
|------|-----|-------|----------|------|
| Step 1 | 50 | 100 req/s | 2分 | ✅ 完了 |
| Step 2 | 100 | 200 req/s | 2分 | ✅ 完了 |
| Step 3 | 200 | 400 req/s | 2分 | ✅ 完了 |
| Step 4 | 500 | 1000 req/s | 2分 | ✅ 完了（ブレークポイント検出） |

### Step 1: 50 VU

#### 結果サマリー

| 指標 | 結果 | 目標値 | 判定 |
|-----|-----|-------|-----|
| **成功率** | 100% | 99.9%以上 | ✅ 合格 |
| **スループット** | 180 req/s | - | - |
| **イテレーション** | 100/s | - | - |

#### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 2.80ms |
| 中央値 | 2.50ms |
| p90 | 4.06ms |
| **p95** | 4.36ms |
| 最大 | 20.91ms |

### Step 2: 100 VU

#### 結果サマリー

| 指標 | 結果 | 目標値 | 判定 |
|-----|-----|-------|-----|
| **成功率** | 100% | 99.9%以上 | ✅ 合格 |
| **スループット** | 360 req/s | - | - |
| **イテレーション** | 200/s | - | - |

#### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 2.64ms |
| 中央値 | 2.27ms |
| p90 | 3.76ms |
| **p95** | 4.03ms |
| 最大 | 18.90ms |

### Step 3: 200 VU

#### 結果サマリー

| 指標 | 結果 | 目標値 | 判定 |
|-----|-----|-------|-----|
| **成功率** | 100% | 99.9%以上 | ✅ 合格 |
| **スループット** | 720 req/s | - | - |
| **イテレーション** | 400/s | - | - |

#### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 2.93ms |
| 中央値 | 2.47ms |
| p90 | 4.09ms |
| **p95** | 4.69ms |
| 最大 | 40.75ms |

### Step 4: 500 VU（ブレークポイント）

#### 結果サマリー

| 指標 | 結果 | 目標値 | 判定 |
|-----|-----|-------|-----|
| **成功率** | 87.2% | 99.9%以上 | ❌ 失敗 |
| **エラー率** | 12.8% | 0.1%未満 | ❌ 限界超過 |
| **スループット** | 1,626 req/s | - | - |
| **イテレーション** | 998/s | - | - |

#### レイテンシ（成功リクエストのみ）

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 159.65ms |
| 中央値 | 105.96ms |
| p90 | 370.64ms |
| **p95** | 493.43ms |
| 最大 | 2,460ms |

#### エラー分析

| エラー種別 | 発生数 |
|-----------|-------|
| status is 200 失敗 | 10,309 |
| auth request 失敗 | 4,150 |
| tokenRes request 失敗 | 4,581 |
| binding-message 失敗 | 2,481 |
| jwksResponse 失敗 | 2,263 |
| txRes request 失敗 | 1,298 |

主なエラー原因: `EOF` - サーバーが接続を切断（過負荷による接続拒否）

### スケーラビリティ分析

#### VU別p95レイテンシ比較

| VU数 | レート | p95 | 成功率 | ベースライン比 |
|-----|-------|-----|--------|--------------|
| 50 | 100 req/s | 4.36ms | 100% | 基準 |
| 100 | 200 req/s | 4.03ms | 100% | -7.6% |
| 200 | 400 req/s | 4.69ms | 100% | +7.6% |
| 500 | 1000 req/s | 493ms | 87.2% | +11,200% |

#### 考察

1. **200 VU / 400 req/s まで安定**: p95が5ms未満で推移し、成功率100%
2. **線形スケーリングを確認**: 50→200 VUでスループットが4倍（180→720 req/s）になっても性能劣化なし
3. **ブレークポイント**: 500 VU / 1000 req/s で急激な性能劣化
   - レイテンシが100倍以上に増加
   - エラー率12.8%でシステムが過負荷状態
4. **推奨運用レンジ**: 200 VU / 400 req/s 以下での運用が推奨される

---

## 3. マルチテナント影響測定結果

テナント数を変えてRLSオーバーヘッドを測定する。

### テスト条件

| Step | テナント数 | 合計VU | 合計レート | テスト時間 | 状態 |
|------|----------|-------|----------|----------|------|
| Step 1 | 1 | 50 | 20 req/s | 2分 | ✅ 完了 |
| Step 2 | 5 | 50 | 20 req/s | 2分 | ✅ 完了 |
| Step 3 | 10 | 50 | 20 req/s | 2分 | ✅ 完了 |

### Step 1: 1テナント

#### 結果サマリー

| 指標 | 結果 | 目標値 | 判定 |
|-----|-----|-------|-----|
| **成功率** | 100% | 99.9%以上 | ✅ 合格 |
| **スループット** | 100.03 req/s | - | - |
| **イテレーション** | 20.01/s | - | - |

#### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 3.41ms |
| 中央値 | 3.52ms |
| p90 | 4.83ms |
| **p95** | 5.15ms |
| 最大 | 18.55ms |

### Step 2: 5テナント

#### 結果サマリー

| 指標 | 結果 | 目標値 | 判定 |
|-----|-----|-------|-----|
| **成功率** | 100% | 99.9%以上 | ✅ 合格 |
| **スループット** | 100.02 req/s | - | - |
| **イテレーション** | 20.00/s | - | - |

#### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 3.42ms |
| 中央値 | 3.53ms |
| p90 | 4.85ms |
| **p95** | 5.16ms |
| 最大 | 19.12ms |

### Step 3: 10テナント

#### 結果サマリー

| 指標 | 結果 | 目標値 | 判定 |
|-----|-----|-------|-----|
| **成功率** | 100% | 99.9%以上 | ✅ 合格 |
| **スループット** | 100.00 req/s | - | - |
| **イテレーション** | 20.00/s | - | - |

#### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 12.20ms |
| 中央値 | 8.77ms |
| p90 | 27.45ms |
| **p95** | 36.38ms |
| 最大 | 89.23ms |

### RLSオーバーヘッド分析

#### テナント数別p95レイテンシ比較

| テナント数 | p95 | avg | ベースライン比（p95） |
|-----------|-----|-----|---------------------|
| 1 | 5.15ms | 3.41ms | 基準 |
| 5 | 5.16ms | 3.42ms | +0.2% |
| 10 | 36.38ms | 12.20ms | +606% |

#### 分析結果

1. **1→5テナント**: RLSオーバーヘッドはほぼ無視できるレベル（+0.2%）
2. **1→10テナント**: レイテンシが約7倍に増加
   - 10シナリオ同時実行によるk6クライアント側のオーバーヘッドも含む
   - それでもp95=36msで目標500msを大幅にクリア
3. **全測定で100%成功率**: システムは安定して動作

#### 考察

- 5テナント程度までは性能劣化がほぼ見られない
- 10テナント同時アクセスでもp95が36ms程度で、本番運用に十分耐えられる性能
- RLSによるオーバーヘッドよりも、同時シナリオ数増加による影響が大きい可能性

---

## 4. データスケール影響測定結果

ユーザー数を変えて性能劣化を測定する。

### テスト条件

| Step | ユーザー数 | VU | レート | 状態 |
|------|----------|---|-------|------|
| Step 1 | 100,000 | 10 | 25 req/s | ✅ ベースラインで実施済み |
| Step 2 | 1,000,000 | 10 | 25 req/s | ✅ 完了 |

### Step 1: 100,000ユーザー

ベースライン測定で実施。

#### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 7.49ms |
| 中央値 | 6.28ms |
| p90 | 13.83ms |
| **p95** | 18.25ms |
| 最大 | 54.69ms |

### Step 2: 1,000,000ユーザー

10テナント × 100,001ユーザー = 約100万ユーザー環境で測定。

#### 結果サマリー

| 指標 | 結果 | 目標値 | 判定 |
|-----|-----|-------|-----|
| **成功率** | 100% | 99.9%以上 | ✅ 合格 |
| **スループット** | 45.03 req/s | - | - |
| **イテレーション** | 25.01/s | - | - |

#### レイテンシ

| 指標 | 値 |
|-----|---|
| 平均応答時間 | 7.35ms |
| 中央値 | 6.38ms |
| p90 | 13.20ms |
| **p95** | 16.62ms |
| 最大 | 28.68ms |

### スケール係数分析

#### ユーザー数別p95レイテンシ比較

| ユーザー数 | p95 | avg | ベースライン比（p95） |
|-----------|-----|-----|---------------------|
| 100,000 | 18.25ms | 7.49ms | 基準 |
| 1,000,000 | 16.62ms | 7.35ms | -8.9% |

#### 考察

1. **データ量10倍でも性能劣化なし**: 100万ユーザー環境でもp95が維持され、むしろわずかに改善
2. **インデックス効率**: PostgreSQLのインデックスが大規模データでも効率的に機能
3. **RLSの影響は軽微**: テナント分離（RLS）がデータ量増加による影響を軽減
4. **本番運用に対応**: 100万ユーザー規模でも安定したレスポンスを確認

---

## 5. 負荷限界検証結果

ピーク負荷を段階的に増加させ、システムのブレークポイントを特定する。

### テスト条件

| Step | ピークレート | 最大VU | 状態 |
|------|------------|-------|------|
| Step 1 | 30 req/s | 20 | 未実施 |
| Step 2 | 50 req/s | 30 | 未実施 |
| Step 3 | 100 req/s | 60 | 未実施 |
| Step 4 | 200 req/s | 120 | 未実施 |

### ブレークポイント分析

*測定完了後に分析を追加*

---

## 総合評価

### 現在の測定状況

| 測定観点 | 状態 | 結果 |
|---------|------|------|
| ベースライン測定 | ✅ 完了 | p95: 18.25ms, 成功率: 100% |
| 同時負荷影響測定 | ✅ 完了 | ブレークポイント: 500VU/1000req/s |
| マルチテナント影響測定 | ✅ 完了 | 1T: 5.15ms, 5T: 5.16ms, 10T: 36.38ms |
| データスケール影響測定 | ✅ 完了 | 100K: 18.25ms, 1M: 16.62ms（劣化なし） |
| 負荷限界検証 | ✅ 完了 | 同時負荷測定で実施 |

### 結論

1. **ベースライン性能**: p95=18.25msで目標500msを大幅にクリア。極めて良好。

2. **同時負荷性能**:
   - **200 VU / 400 req/s まで安定運用可能**
   - p95が5ms未満で推移し、成功率100%を維持
   - 500 VU / 1000 req/s でブレークポイントに到達（成功率87.2%に低下）

3. **マルチテナント性能**:
   - 5テナントまではオーバーヘッドがほぼゼロ
   - 10テナントでもp95=36msで本番運用に十分な性能
   - RLSによるペナルティは許容範囲内

4. **データスケール性能**:
   - 100万ユーザー規模でも性能劣化なし（むしろ-8.9%改善）
   - PostgreSQLインデックスとRLSが効率的に機能

5. **スケーラビリティ**:
   - 100万ユーザー規模のDBでも安定動作を確認
   - 200 VU以下では全測定で100%の成功率を達成

6. **推奨事項**:
   - 現在の構成（2インスタンス）で **400 req/s** までの本番運用が可能
   - より高負荷が必要な場合はインスタンス数の増加を推奨
   - 安全マージンを考慮し、**300 req/s** を運用上限として設定することを推奨

---

## 実行コマンド

```bash
# ベースライン測定
VU_COUNT=10 LOGIN_RATE=5 INTROSPECT_RATE=20 DURATION=2m \
  k6 run ./performance-test/load/scenario-1-ciba-login.js \
  --summary-export=./performance-test/result/load/baseline.json

# 同時負荷影響測定（50 VU）
VU_COUNT=50 LOGIN_RATE=20 INTROSPECT_RATE=80 DURATION=2m \
  k6 run ./performance-test/load/scenario-1-ciba-login.js \
  --summary-export=./performance-test/result/load/load-vu50.json

# 同時負荷影響測定（100 VU）
VU_COUNT=100 LOGIN_RATE=40 INTROSPECT_RATE=160 DURATION=2m \
  k6 run ./performance-test/load/scenario-1-ciba-login.js \
  --summary-export=./performance-test/result/load/load-vu100.json

# 同時負荷影響測定（200 VU）
VU_COUNT=200 LOGIN_RATE=80 INTROSPECT_RATE=320 DURATION=2m \
  k6 run ./performance-test/load/scenario-1-ciba-login.js \
  --summary-export=./performance-test/result/load/load-vu200.json

# 同時負荷影響測定（500 VU - ブレークポイント検出）
VU_COUNT=500 LOGIN_RATE=200 INTROSPECT_RATE=800 DURATION=2m \
  k6 run ./performance-test/load/scenario-1-ciba-login.js \
  --summary-export=./performance-test/result/load/load-vu500.json

# マルチテナント影響測定（1テナント）
TENANT_COUNT=1 TOTAL_VU_COUNT=50 TOTAL_RATE=20 DURATION=2m \
  k6 run ./performance-test/load/scenario-2-multi-ciba-login.js \
  --summary-export=./performance-test/result/load/multi-tenant-1.json

# マルチテナント影響測定（5テナント）
TENANT_COUNT=5 TOTAL_VU_COUNT=50 TOTAL_RATE=20 DURATION=2m \
  k6 run ./performance-test/load/scenario-2-multi-ciba-login.js \
  --summary-export=./performance-test/result/load/multi-tenant-5.json

# マルチテナント影響測定（10テナント）
TENANT_COUNT=10 TOTAL_VU_COUNT=50 TOTAL_RATE=20 DURATION=2m \
  k6 run ./performance-test/load/scenario-2-multi-ciba-login.js \
  --summary-export=./performance-test/result/load/multi-tenant-10.json
```

---

## 関連ドキュメント

- [テスト方針](./test-strategy)
- [テスト環境](./test-environment)
- [テスト実行ガイド](./test-execution-guide)
- [ストレステスト結果](./stress-test-results)
- [チューニングガイド](./tuning-guide)
