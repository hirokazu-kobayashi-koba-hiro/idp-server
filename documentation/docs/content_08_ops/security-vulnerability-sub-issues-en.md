# OWASP Top 10 2025 Security Assessment - Sub-Issue Breakdown

**Target**: idp-server (OAuth 2.0/OIDC/CIBA/FAPI Compliant Identity Platform)  
**Assessment Date**: 2025-10-09  
**Standard**: OWASP Top 10 2025  
**Overall Security Score**: 73.5/100 (Good, requires improvements)  
**Parent Issue**: #[Main Issue Number]

---

## üìã Sub-Issue Classification

### üî¥ Phase 1: Critical Issues (Immediate Action Required - Within 1 Week)

#### Issue #1: [A03] Fix TransactionManager SQL Injection Vulnerability
**Priority**: üî¥ Critical  
**CVSS**: 9.8  
**Effort**: 2 days  
**Owner**: Senior Security Engineer

**Problem Details**:
- **File**: `libs/idp-server-platform/src/main/java/org/idp/server/platform/datasource/TransactionManager.java:132`
- **Vulnerability**: String concatenation in PostgreSQL RLS configuration
- **Impact**: Tenant isolation bypass, data deletion/tampering risk

**Current Code**:
```java
stmt.execute("SET app.tenant_id = '" + tenantIdentifier.value() + "'");  // ‚Üê Vulnerable
```

**Fix Implementation**:
```java
private static void setTenantId(Connection conn, TenantIdentifier tenantIdentifier) {
  log.debug("[RLS] SET app.tenant_id: tenant={}", tenantIdentifier.value());
  
  try {
    UUID tenantUuid = tenantIdentifier.valueAsUuid();  // UUID validation
    try (var stmt = conn.prepareStatement("SELECT set_config('app.tenant_id', ?::text, false)")) {
      stmt.setString(1, tenantUuid.toString());
      stmt.execute();
    }
  } catch (SQLException e) {
    throw new SqlRuntimeException("Failed to set tenant_id", e);
  }
}
```

**Verification Items**:
- [ ] Verify UUID validation works correctly
- [ ] Confirm PreparedStatement prevents SQL injection
- [ ] Run all E2E tests (especially multi-tenant related)
- [ ] Manually attempt SQL injection attacks and verify blocking
- [ ] Confirm performance impact is acceptable

---

#### Issue #2: [A06] Upgrade Nimbus JOSE + JWT Library
**Priority**: üî¥ Critical  
**CVSS**: 7.5  
**Effort**: 1 day + 2 days verification  
**Owner**: Backend Developer + QA Engineer

**Problem Details**:
- **Current Version**: 9.30.2
- **Fixed Version**: 10.5+
- **CVEs**:
  - CVE-2025-53864 (CVSS 5.8): DoS via deeply nested JSON
  - CVE-2024-31214 (CVSS 7.5): DoS via large JWE p2c values
- **Impact**: JWT processing is core to OIDC/OAuth 2.0

**Fix Implementation**:
```gradle
// File: libs/idp-server-platform/build.gradle
-implementation 'com.nimbusds:nimbus-jose-jwt:9.30.2'
+implementation 'com.nimbusds:nimbus-jose-jwt:10.5'
```

**Verification Items**:
- [ ] Verify Gradle build succeeds
- [ ] Run all unit tests (JWT related)
- [ ] Run all E2E tests (OIDC authentication flows)
- [ ] Verify JWT signature verification works correctly
- [ ] Verify Authorization Code Flow, CIBA Flow, FAPI Flow
- [ ] Confirm compatibility with existing JWT generation/verification logic
- [ ] Run performance tests

---

#### Issue #3: [A06] Update Docker Base Image and Security Hardening
**Priority**: üî¥ Critical  
**CVSS**: 7.5  
**Effort**: 1 day  
**Owner**: DevOps Engineer

**Problem Details**:
- **Current Image**: `openjdk:21-slim`
- **CVEs**:
  - CVE-2025-32988, CVE-2025-32989: GnuTLS vulnerabilities
  - CVE-2025-6020: Linux PAM privilege escalation
- **Solution**: Migrate to more secure `eclipse-temurin:21-jre-alpine`

**Fix Implementation**:
```dockerfile
# File: Dockerfile
-FROM gradle:8.5-jdk21 AS builder
+FROM gradle:8.14-jdk21-alpine AS builder

-FROM openjdk:21-slim AS runtime
+FROM eclipse-temurin:21-jre-alpine AS runtime

+# Run as non-root user
+RUN addgroup -S idpserver && \
+    adduser -S idpserver -G idpserver && \
+    chown -R idpserver:idpserver /app
+USER idpserver
```

**Verification Items**:
- [ ] Verify Docker build succeeds
- [ ] Verify container starts correctly
- [ ] Verify running as non-root user (`docker exec ... whoami`)
- [ ] Verify application functions correctly
- [ ] Compare image sizes (optimization check)
- [ ] Run Trivy scan to confirm no vulnerabilities

---

#### Issue #4: [A05] Remove Default Credentials
**Priority**: üî¥ Critical  
**CVSS**: 9.8  
**Effort**: 1 day  
**Owner**: DevOps Engineer

**Problem Details**:
- **Files**: 
  - `app/src/main/resources/application.yaml:17-18, 25-26`
  - `libs/idp-server-database/postgresql/operation/01-create-users.sh:9-10`
  - `.env.local:4-5, 13, 17`
- **Vulnerability**: `idpserver/idpserver` hardcoded as default password
- **Impact**: Risk of misuse in production environments

**Fix Implementation**:
```yaml
# File: app/src/main/resources/application.yaml
# Remove default values, require environment variables
-username: "${CONTROL_PLANE_DB_WRITER_USER_NAME:idpserver}"
-password: "${CONTROL_PLANE_DB_WRITER_PASSWORD:idpserver}"
+username: "${CONTROL_PLANE_DB_WRITER_USER_NAME}"
+password: "${CONTROL_PLANE_DB_WRITER_PASSWORD}"
```

```bash
# File: libs/idp-server-database/postgresql/operation/01-create-users.sh
# Remove default password, require environment variable
-: "${IDP_DB_ADMIN_PASSWORD:=idp_admin_user}"
+: "${IDP_DB_ADMIN_PASSWORD:?IDP_DB_ADMIN_PASSWORD is required}"
```

**Verification Items**:
- [ ] Verify application fails to start without environment variables
- [ ] Verify normal startup with environment variables set
- [ ] Verify `.env.local` is excluded from Git
- [ ] Update documentation (environment variable setup)
- [ ] Verify CI/CD pipeline environment variable configuration

---

### üü† Phase 2: High Priority Issues (Within 2 Weeks)

#### Issue #5: [A10] Implement HttpRequestExecutor SSRF Protection
**Priority**: üü† High  
**CVSS**: 7.5  
**Effort**: 3 days  
**Owner**: Security Engineer

**Problem Details**:
- **File**: `libs/idp-server-platform/src/main/java/org/idp/server/platform/http/HttpRequestExecutor.java`
- **Vulnerability**: Lack of private IP validation
- **Impact**: 
  - Internal network access via webhook transmission
  - SSRF in Identity Verification external API calls
  - Attack surface in OIDC Federation well-known URL fetching

**Implementation**:
Create new `HttpUrlValidator` class:
```java
// File: libs/idp-server-platform/src/main/java/org/idp/server/platform/http/HttpUrlValidator.java
package org.idp.server.platform.http;

import java.net.InetAddress;
import java.net.URI;
import java.net.UnknownHostException;
import java.util.List;

public class HttpUrlValidator {
    private static final List<String> PRIVATE_IP_RANGES = List.of(
        "127.0.0.0/8",    // Loopback
        "10.0.0.0/8",     // Private Class A
        "172.16.0.0/12",  // Private Class B
        "192.168.0.0/16", // Private Class C
        "169.254.0.0/16", // Link-local
        "::1/128",        // IPv6 Loopback
        "fc00::/7",       // IPv6 Unique Local
        "fe80::/10"       // IPv6 Link-local
    );

    public void validateUrl(URI uri) throws SsrfException {
        try {
            InetAddress address = InetAddress.getByName(uri.getHost());
            if (isPrivateNetwork(address) || address.isLoopbackAddress()) {
                throw new SsrfException(
                    "Access to private network is forbidden: " + uri.getHost()
                );
            }
        } catch (UnknownHostException e) {
            throw new SsrfException("Invalid hostname: " + uri.getHost(), e);
        }
    }

    private boolean isPrivateNetwork(InetAddress address) {
        // RFC 1918, RFC 4193 implementation
        byte[] addr = address.getAddress();
        // Implementation details...
    }
}
```

**Verification Items**:
- [ ] Verify private IP address access is blocked
- [ ] Verify loopback address access is blocked
- [ ] Verify IPv6 private address access is blocked
- [ ] Verify legitimate external URLs work correctly
- [ ] Verify protection against DNS rebinding attacks
- [ ] Create unit tests (positive and negative cases)
- [ ] Run E2E tests (Webhook, Identity Verification)

---

#### Issue #6: [A01] Fix CORS Origin Validation
**Priority**: üü† High  
**CVSS**: 6.5  
**Effort**: 1 day  
**Owner**: Backend Developer

**Problem Details**:
- **File**: `libs/idp-server-springboot-adapter/src/main/java/org/idp/server/adapters/springboot/DynamicCorsFilter.java:61-64`
- **Vulnerability**: Partial match validation using `contains()`
- **Impact**: Origin Validation Bypass, subdomain takeover attack risk

**Current Code**:
```java
String allowOrigin = allowOrigins.stream()
    .filter(allow -> allow.contains(origin))  // ‚Üê Dangerous
    .findFirst()
    .orElse(tenant.domain().value());
```

**Fix Implementation**:
```java
String allowOrigin = allowOrigins.stream()
    .filter(allow -> allow.equals(origin))  // Change to exact match
    .findFirst()
    .orElse("null");  // Change default to "null"
```

**Verification Items**:
- [ ] Verify legitimate origins are allowed
- [ ] Verify partial match origins are rejected
- [ ] Verify protection against subdomain takeover attacks
- [ ] Run E2E tests (CORS related)
- [ ] Create unit tests

---

#### Issue #7: [A04] Implement Rate Limiting Mechanism
**Priority**: üü† High  
**CVSS**: 6.5  
**Effort**: 5 days  
**Owner**: Backend Developer + DevOps Engineer

**Problem Details**:
- **Affected Endpoints**: 
  - Token Endpoint
  - CIBA Backchannel Authentication Endpoint
  - Authorization Endpoint
- **Risk**: Brute force attacks, DoS attacks, token generation overload

**Implementation**:
Create new `RedisRateLimiter` class:
```java
// File: libs/idp-server-platform/src/main/java/org/idp/server/platform/ratelimit/RedisRateLimiter.java
package org.idp.server.platform.ratelimit;

import java.time.Duration;
import org.springframework.data.redis.core.RedisTemplate;
import org.springframework.stereotype.Component;

@Component
public class RedisRateLimiter {
    private final RedisTemplate<String, String> redisTemplate;

    public boolean allowRequest(String key, int maxRequests, Duration window) {
        String script =
            "local current = redis.call('incr', KEYS[1]) " +
            "if current == 1 then redis.call('expire', KEYS[1], ARGV[1]) end " +
            "return current <= tonumber(ARGV[2])";
        
        Long result = redisTemplate.execute(
            // Execute Lua script
        );
        return result != null && result == 1L;
    }
}
```

**Verification Items**:
- [ ] Verify rate limiting works correctly
- [ ] Verify appropriate error is returned when limit exceeded
- [ ] Verify independent counting for different client IDs
- [ ] Verify reset after window period expires
- [ ] Verify performance impact is acceptable
- [ ] Create E2E tests (rate limiting tests)

---

#### Issue #8: [A06] Upgrade Spring Boot Version
**Priority**: üü† High  
**CVSS**: 6.1  
**Effort**: 1 day + 2 days verification  
**Owner**: Backend Developer

**Problem Details**:
- **Current Version**: 3.4.2
- **Fixed Version**: 3.4.5+
- **CVE**: CVE-2025-22235 (Actuator endpoint incorrect matcher)

**Fix Implementation**:
```gradle
// File: app/build.gradle
-id 'org.springframework.boot' version '3.4.2'
+id 'org.springframework.boot' version '3.4.5'
```

**Verification Items**:
- [ ] Verify Gradle build succeeds
- [ ] Run all unit tests
- [ ] Run all E2E tests
- [ ] Verify Spring Boot Actuator endpoints work correctly
- [ ] Verify compatibility with existing features

---

### üü° Phase 3: Medium Priority Issues (Within 1 Month)

#### Issue #9: [A05] Implement Security Headers
**Priority**: üü° Medium  
**CVSS**: 5.3  
**Effort**: 2 days  
**Owner**: Backend Developer

**Problem Details**:
- **Missing Headers**:
  - `X-Frame-Options`: Clickjacking attack risk
  - `X-Content-Type-Options`: MIME sniffing attack
  - `Strict-Transport-Security`: No HTTPS enforcement
  - `Content-Security-Policy`: No XSS mitigation

**Implementation**:
Create new Filter:
```java
// File: libs/idp-server-springboot-adapter/src/main/java/org/idp/server/adapters/springboot/SecurityHeadersFilter.java
package org.idp.server.adapters.springboot;

import jakarta.servlet.*;
import jakarta.servlet.http.HttpServletResponse;
import java.io.IOException;
import org.springframework.stereotype.Component;

@Component
public class SecurityHeadersFilter implements Filter {
    @Override
    public void doFilter(ServletRequest request, ServletResponse response, FilterChain chain)
            throws IOException, ServletException {
        HttpServletResponse httpResponse = (HttpServletResponse) response;
        
        httpResponse.setHeader("X-Frame-Options", "DENY");
        httpResponse.setHeader("X-Content-Type-Options", "nosniff");
        httpResponse.setHeader("X-XSS-Protection", "1; mode=block");
        httpResponse.setHeader("Strict-Transport-Security", 
            "max-age=31536000; includeSubDomains");
        httpResponse.setHeader("Content-Security-Policy", 
            "default-src 'self'");
        
        chain.doFilter(request, response);
    }
}
```

**Verification Items**:
- [ ] Verify each header is included in responses
- [ ] Verify browser behavior
- [ ] Run E2E tests
- [ ] Verify performance impact is acceptable

---

#### Issue #10: [A07] Implement Account Lockout Mechanism
**Priority**: üü° Medium  
**CVSS**: 5.3  
**Effort**: 3 days  
**Owner**: Backend Developer

**Problem Details**:
- **Risk**: Vulnerable to brute force attacks, password spray attacks

**Implementation**:
```java
// File: libs/idp-server-core/src/main/java/org/idp/server/core/authentication/AccountLockoutManager.java
package org.idp.server.core.authentication;

import java.time.Duration;
import org.springframework.stereotype.Component;

@Component
public class AccountLockoutManager {
    private static final int MAX_FAILED_ATTEMPTS = 5;
    private static final Duration LOCKOUT_DURATION = Duration.ofMinutes(15);

    public void recordFailedAttempt(User user) {
        // Record counter in Redis/DB
        // Implement exponential backoff
    }

    public boolean isLocked(User user) {
        // Check lock status
    }

    public void reset(User user) {
        // Reset on success
    }
}
```

**Verification Items**:
- [ ] Verify failed attempts are counted correctly
- [ ] Verify lockout works correctly
- [ ] Verify unlock after lockout period expires
- [ ] Create E2E tests

---

#### Issue #11: [A07] Implement Password Policy Engine
**Priority**: üü° Medium  
**CVSS**: 5.3  
**Effort**: 2 days  
**Owner**: Backend Developer

**Problem Details**:
- **Current State**: Validation logic exists only in test code
- **Required Features**:
  - Minimum length 12 characters
  - Complexity requirements (uppercase, lowercase, numbers, symbols)
  - Password history management

**Implementation**:
```java
// File: libs/idp-server-core/src/main/java/org/idp/server/core/password/PasswordPolicy.java
package org.idp.server.core.password;

import java.util.List;

public class PasswordPolicy {
    private static final int MIN_LENGTH = 12;
    
    public ValidationResult validate(String password, List<String> previousHashes) {
        // Check minimum length
        // Check complexity
        // Check history
    }
}
```

**Verification Items**:
- [ ] Verify each policy rule works correctly
- [ ] Create unit tests
- [ ] Run E2E tests

---

#### Issue #12: [A01] Fix URL Pattern Matching
**Priority**: üü° Medium  
**CVSS**: 5.3  
**Effort**: 1 day  
**Owner**: Backend Developer

**Problem Details**:
- **Files**: 
  - `ManagementApiFilter.java:110-113`
  - `DynamicCorsFilter.java:94`
- **Vulnerability**: URL validation using `contains()`, Path Traversal attack risk

**Current Code**:
```java
if (request.getRequestURI().contains("/management/organizations/")) {
    return true;  // Attack example: /malicious/management/../../admin
}
```

**Fix Implementation**:
```java
if (request.getRequestURI().startsWith("/management/organizations/")) {
    return true;
}
```

**Verification Items**:
- [ ] Verify protection against Path Traversal attacks
- [ ] Verify legitimate URL patterns work correctly
- [ ] Create unit tests

---

#### Issue #13: [A01] Implement ControlPlaneAuthorizer Authorization
**Priority**: üü° Medium  
**CVSS**: 7.5  
**Effort**: 3 days  
**Owner**: Security Engineer

**Problem Details**:
- **File**: `libs/idp-server-control-plane/src/main/java/org/idp/server/control_plane/base/authorizer/ControlPlaneAuthorizer.java:21-23`
- **Vulnerability**: `authorize()` method always returns `true`

**Current Code**:
```java
public boolean authorize(String authorizationHeader) {
    return true;  // ‚Üê Complete authorization check bypass
}
```

**Implementation**:
- JWT verification implementation
- Administrator permission check
- Tenant access verification

**Verification Items**:
- [ ] Verify authorization logic works correctly
- [ ] Verify invalid tokens are rejected
- [ ] Create unit tests
- [ ] Run E2E tests

---

### üîµ Phase 4: Low Priority Issues (Within 3 Months)

#### Issue #14: [A08] Integrate Gradle Dependency Verification
**Priority**: üîµ Low  
**Effort**: 2 days  
**Owner**: DevOps Engineer

**Implementation**:
```bash
./gradlew --write-verification-metadata sha256
```

**Verification Items**:
- [ ] Verify dependency verification works
- [ ] Integrate into CI/CD pipeline

---

#### Issue #15: [A02] Deprecate SHA-1/MD5
**Priority**: üîµ Low  
**Effort**: 1 day  
**Owner**: Backend Developer

**Implementation**:
```java
// File: libs/idp-server-platform/src/main/java/org/idp/server/platform/hash/HashAlgorithm.java
@Deprecated(since = "2025-10", forRemoval = true)
MD5,
@Deprecated(since = "2025-10", forRemoval = true)
SHA1,
```

**Verification Items**:
- [ ] Verify deprecation warnings are displayed
- [ ] Create migration plan to UUID v4

---

#### Issue #16: [A09] Explicitly Scrub Security Logs
**Priority**: üîµ Low  
**Effort**: 1 day  
**Owner**: Backend Developer

**Implementation**:
Explicit sensitive information filtering implementation

**Verification Items**:
- [ ] Verify sensitive information is not output to logs

---

#### Issue #17: [A10] Webhook URL Whitelist Mechanism
**Priority**: üîµ Low  
**Effort**: 2 days  
**Owner**: Backend Developer

**Implementation**:
Domain whitelist mechanism implementation

**Verification Items**:
- [ ] Verify whitelist validation works

---

#### Issue #18: Introduce Continuous Security Scanning
**Priority**: üîµ Low  
**Effort**: 3 days  
**Owner**: DevOps Engineer

**Implementation**:
- OWASP Dependency-Check integration
- GitHub Actions integration
- Renovate Bot configuration
- Trivy container scanning

**Verification Items**:
- [ ] Verify automated scanning works
- [ ] Configure notifications for vulnerability detection

**Implementation Example**:
```gradle
// build.gradle (root)
plugins {
    id 'org.owasp.dependencycheck' version '10.0.4'
}

dependencyCheck {
    format = 'ALL'
    failBuildOnCVSS = 7
}
```

```yaml
# .github/workflows/security.yml
name: Security Scan
on: [push, pull_request]
jobs:
  dependency-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Run OWASP Dependency Check
        run: ./gradlew dependencyCheckAggregate
```

---

## üìä Implementation Priority Summary

### Classification by Urgency

| Phase | Priority | Issues | Estimated Effort | Timeline |
|-------|----------|--------|------------------|----------|
| **Phase 1** | üî¥ Critical | 4 | 5-7 business days | 1 week |
| **Phase 2** | üü† High | 4 | 8-10 business days | 2 weeks |
| **Phase 3** | üü° Medium | 6 | 6-8 business days | 1 month |
| **Phase 4** | üîµ Low | 4 | 5-7 business days | 3 months |
| **Total** | | **18** | **24-32 business days** | **3 months** |

---

## üéØ Expected Impact

### Security Score Improvement Projection

| Phase Completion | Score | Improvement | Status |
|------------------|-------|-------------|--------|
| **Current** | 73.5/100 | - | Good (needs improvement) |
| **Phase 1 Complete** | 85/100 | +11.5 | Excellent |
| **Phase 2 Complete** | 90/100 | +5 | Outstanding |
| **Phase 3 Complete** | 93/100 | +3 | Outstanding |
| **Phase 4 Complete** | 95/100 | +2 | World-class |

---

## üìù Sub-Issue Creation Template

Use the following template when creating each sub-issue:

```markdown
# [Category] Issue Title

**Priority**: üî¥/üü†/üü°/üîµ  
**CVSS**: X.X  
**Effort**: X days  
**Owner**: Role  
**Parent Issue**: #[Main Issue Number]

## Problem Details

### Affected Area
- File: `path/to/file.java`
- Feature: Feature name

### Vulnerability Description
[Detailed explanation]

### CVE Information (if applicable)
- CVE-XXXX-XXXXX: Description

## Fix Implementation

### Files to Change
- [ ] `path/to/file1.java`
- [ ] `path/to/file2.java`

### Code Example
```java
// Before
[Current code]

// After
[Fixed code]
```

## Verification Items

- [ ] Verify feature works correctly
- [ ] Create unit tests
- [ ] Run E2E tests
- [ ] Run security tests
- [ ] Verify performance impact
- [ ] Update documentation

## Related Issues

- Depends on: #XXX
- Related to: #YYY

## References

- [Links to RFC/CVE/Documentation]
```

---

## üîó Related Documentation

- [OWASP Top 10 2025](https://owasp.org/www-project-top-ten/)
- [idp-server Security Policy](../SECURITY.md)
- [Deployment Guide](content_05_how-to/deployment.md)
- [Unit Testing Strategy](content_09_project/unit-testing-strategy-by-module.md)

---

**Created**: 2025-10-09  
**Last Updated**: 2025-10-09  
**Approved by**: Security Assessment Team
