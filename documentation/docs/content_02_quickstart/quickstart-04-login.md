# ログイン

[← ユースケース一覧に戻る](./quickstart-03-common-use-cases.md)

---

## できること

### ログイン方式

**複数のログイン方式を組み合わせて提供**できます。ユーザーに合わせた柔軟な認証を実現します。

- **パスワード認証**: メールアドレス/ユーザー名 + パスワード
- **Socialログイン**: SNSアカウント、エンタープライズアカウント等で手軽にログイン
- **両方を併用**: ユーザーが好きな方法を選択

### セキュリティ機能

**不正アクセスを防ぐ仕組み**が標準で組み込まれています。

- **アカウントロック**: ログイン失敗回数でアカウントを一時ロック
- **パスワードポリシー**: 文字数、複雑さ、有効期限、履歴管理
- **失敗回数のリセット**: 成功時または時間経過でリセット

### ユーザー管理

**ユーザー登録から削除まで**を一元管理できます。

- **新規ユーザー登録**: メールアドレス確認、利用規約同意の管理
- **プロフィール管理**: ユーザー情報の登録・更新
- **パスワードリセット**: セキュアなパスワード再設定フロー
- **アカウント削除**: ユーザーによる退会処理

### マルチテナント対応

**組織ごとに異なるログイン設定**を提供できます。

- テナントAは「パスワードのみ」
- テナントBは「Socialログイン必須」
- テナントCは「パスワード + MFA」

このように、同じidp-serverで複数の組織・サービスを運用できます。

### セッション管理

**ログイン状態の維持と制御**ができます。

- **シングルサインオン（SSO）**: 1回ログインすれば複数アプリで使える
- **セッション有効期限**: 一定時間後に自動ログアウト
- **セッション延長**: アクティブなユーザーは期限を延長
- **ログアウト**: ユーザーによる明示的なログアウト
- **強制ログアウト**: 管理者が特定ユーザーをログアウトさせる

**SSO（シングルサインオン）の例**:
```
ユーザーがアプリAでログイン
  ↓
セッション作成（idp-server）
  ↓
同じユーザーがアプリBにアクセス
  ↓
既存セッションを使用（再ログイン不要）
```

---

## 導入時に決めること

### 1. どの方法でログインさせるか

| 選択肢 | 説明                      | 向いているケース |
|-------|-------------------------|----------------|
| **パスワード認証のみ** | メールアドレス/ユーザー名 + パスワード   | 社内システム、独自サービス |
| **外部サービスログイン** | SNS、エンタープライズのアカウントでログイン | 一般消費者向けサービス |
| **両方を併用** | ユーザーが選択可能               | 幅広いユーザー層のサービス |

**idp-serverでの設定**:
- 認証ポリシーで利用可能な認証方式を定義
- 外部サービスログイン用の外部IdP連携設定を追加

### 2. パスワードの強度をどうするか

| 決めること | 選択肢の例 |
|-----------|-----------|
| **最小文字数** | 8文字以上、12文字以上 |
| **必須文字種** | 英数字必須、記号必須 |
| **パスワード有効期限** | なし、90日、180日 |
| **過去パスワードの再利用** | 禁止しない、直近3回禁止、直近5回禁止 |

**idp-serverでの設定**:
- パスワードポリシーで文字数、複雑さの要件を設定
- 有効期限、履歴管理のルールを設定

### 3. ログイン失敗時の挙動

| 決めること | 選択肢の例 |
|-----------|-----------|
| **アカウントロック条件** | 5回失敗でロック、10回失敗でロック |
| **ロック期間** | 30分、1時間、管理者が解除するまで |
| **失敗回数のリセット** | 成功したらリセット、24時間後にリセット |

**idp-serverでの設定**:
- 認証ポリシーでロック条件（失敗回数、期間）を設定
- リセット条件を設定

### 4. ユーザー登録時に何を入力させるか

| 決めること | 選択肢の例 |
|-----------|-----------|
| **必須項目** | メールアドレスのみ、氏名も必須、電話番号も必須 |
| **メール確認** | する、しない |
| **利用規約への同意** | 必須、任意 |

**idp-serverでの設定**:
- ユーザースキーマで必須項目を定義
- メール確認フローの有効化/無効化
- 同意管理の設定

### 5. セッション管理

#### 5-1. セッション有効期限

| 決めること | 選択肢の例 |
|-----------|-----------|
| **有効期限** | 30分、1時間、24時間、無期限 |
| **アイドルタイムアウト** | 15分、30分、なし |
| **セッション延長** | アクティブ時に自動延長、延長しない |

**idp-serverでの設定**:
- デフォルトのセッション有効期限（default_max_age）
- クライアント別のmax_age設定

#### 5-2. SSO（シングルサインオン）の範囲

| 選択肢 | 説明 |
|-------|------|
| **同一テナント内** | 同じテナントの複数アプリでSSO |
| **セッション共有しない** | アプリごとに個別ログイン |

**idp-serverでの設定**:
- テナント設定でSSOの有効化
- セッション共有ポリシー

### 6. 外部サービスログイン

#### 6-1. どの種類の外部サービスログインを使うか

| 選択肢 | 説明 | 向いているケース |
|-------|------|----------------|
| **SNSアカウント** | 高普及率、ユーザーが使い慣れている | 一般消費者向けサービス |
| **エンタープライズアカウント** | 法人利用に強い | 企業向けサービス |
| **複数併用** | ユーザーが選択可能 | 幅広いユーザー層 |

**idp-serverでの設定**:
- 各サービスのClient ID/Secretを登録
- 認証ポリシーで利用可能なサービスを定義

#### 6-2. ログイン時のユーザー情報の取得範囲

| 決めること | 選択肢の例 |
|-----------|-----------|
| **基本情報** | 氏名・メールアドレス必須、プロフィール画像任意 |
| **追加情報** | 誕生日、性別、電話番号等 |
| **権限スコープ** | 最小限のみ、必要な情報全て |

**idp-serverでの設定**:
- ログイン時に要求する情報の範囲を設定
- 取得した情報のマッピングルールを定義

#### 6-3. 既存アカウントとの紐付け

外部サービスログインでは、常に新規アカウントとして作成されます。

**動作**:
- 外部サービスごとに別々のアカウントとして扱われる
- 既存のパスワード認証アカウントとの自動紐付けは行われない

---

## まとめ

ログイン機能を導入する際の重要なポイント:

### 必ず決めること
1. **認証方式**: パスワードのみ、Socialログインのみ、または両方
2. **セキュリティレベル**: パスワード強度、ロック条件、失敗時の挙動
3. **ユーザー登録フロー**: 必須項目、メール確認、同意管理
4. **セッション管理**: 有効期限、アイドルタイムアウト、SSOの範囲

### idp-serverが提供すること
- OAuth 2.0/OpenID Connect標準準拠のログイン機能
- パスワードポリシー（文字数、複雑さ、有効期限、履歴管理）
- アカウントロック機能（失敗回数、ロック期間、リセット条件）
- セッション管理（SSO、有効期限、アイドルタイムアウト、強制ログアウト）
- 外部IdP連携（Socialログイン）
- マルチテナント対応（組織ごとの設定分離）

### 自分で実装すること
- ログイン画面（UI）
- ユーザー登録画面（UI）
- パスワードリセット画面（UI）
- Socialログインボタンの配置

### セキュリティの注意点
- パスワードポリシーは厳しすぎず、ユーザー体験とのバランスを取る
- アカウントロックは攻撃者によるDoS攻撃にも使われる可能性があるので注意
- Socialログインは外部サービス依存なので、パスワード認証も併用推奨

---

## 関連ドキュメント

- [How-to: ユーザー登録・パスワード認証](../content_05_how-to/phase-1-foundation/05-user-registration.md)
- [How-to: 認証ポリシー設定](../content_05_how-to/phase-1-foundation/07-authentication-policy.md)
- [How-to: 外部IdP連携](../content_05_how-to/phase-3-advanced/01-federation-setup.md)

---

**最終更新**: 2026-01-27
