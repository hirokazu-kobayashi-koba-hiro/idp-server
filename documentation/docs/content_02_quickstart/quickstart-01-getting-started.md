# Getting-Started

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€**idp-server** ã‚’åˆã‚ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦å®Ÿè¡Œã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## å‰ææ¡ä»¶

| ãƒ„ãƒ¼ãƒ« | å¿…é ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ¨å¥¨ | å‚™è€ƒ |
|-------|-------------|------|------|
| **Java** | 21+ | Java 21 | |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | PostgreSQL 14+ ã¾ãŸã¯ MySQL 8.0+ | **PostgreSQL 14+** | Primary/Replica æ§‹æˆå¯¾å¿œ |
| **Node.js** | 18.0+ | 20.x LTS | E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¿…è¦ |
| **Docker** | 20.10+ | Docker Desktop æœ€æ–°ç‰ˆ | Compose V2 å¯¾å¿œ |

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é¸æŠã‚¬ã‚¤ãƒ‰
- **PostgreSQL**: âœ… æ¨å¥¨ï¼ˆPrimary/Replica å¯¾å¿œã€æœ¬ç•ªç’°å¢ƒå‘ã‘ï¼‰
- **MySQL**: âš ï¸ åŸºæœ¬æ©Ÿèƒ½ã®ã¿ï¼ˆé–‹ç™ºãƒ»æ¤œè¨¼ç’°å¢ƒå‘ã‘ï¼‰

## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒæ§‹æˆ

ã“ã®å›³ã¯ã€docker-compose ã‚’ä½¿ã£ã¦æ§‹ç¯‰ã•ã‚Œã‚‹ idp-server ã®ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®å…¨ä½“æ§‹æˆã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

```mermaid
flowchart TD
subgraph Frontend["Frontend (*.local.dev)"]
app_view[ğŸ–¥ï¸ app-view<br>auth.local.dev<br>èªå¯UI]
sample_web[ğŸŒ sample-web<br>sample.local.dev<br>ã‚µãƒ³ãƒ—ãƒ«RP]
end

subgraph Nginx["Nginx Reverse Proxy"]
nginx[ğŸ”€ nginx<br>api.local.dev:443<br>mtls.api.local.dev:443]
end

subgraph App["App Cluster"]
idp1[ğŸ”¥ idp-server-1<br>:8081]
idp2[ğŸ”¥ idp-server-2<br>:8082]
end

subgraph Data["Data Layer"]
subgraph PostgreSQL["PostgreSQL Cluster"]
pg_primary[ğŸ§  Primary<br>:5432]
pg_replica[ğŸ“– Replica<br>:5433]
pg_primary -.->|WAL| pg_replica
end
redis[âš¡ Redis<br>:6379]
end

subgraph External["External Services"]
mockoon[ğŸ§ª Mockoon<br>:3010]
end

app_view --> nginx
sample_web --> nginx
nginx --> idp1
nginx --> idp2

idp1 --> pg_primary
idp1 -.->|Read| pg_replica
idp1 --> redis
idp1 --> mockoon

idp2 --> pg_primary
idp2 -.->|Read| pg_replica
idp2 --> redis
idp2 --> mockoon
```

### ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ§‹æˆ

| ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ | ã‚µãƒ¼ãƒ“ã‚¹ | èª¬æ˜ |
|------------|---------|------|
| `api.local.dev` | nginx â†’ idp-server | IDP Server API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆ |
| `mtls.api.local.dev` | nginx â†’ idp-server | mTLSã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸æ¤œè¨¼ã€sender-constrainedãƒˆãƒ¼ã‚¯ãƒ³ï¼‰ |
| `auth.local.dev` | app-view | èªå¯UIï¼ˆãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ç­‰ï¼‰ |
| `sample.local.dev` | sample-web | ã‚µãƒ³ãƒ—ãƒ«RPã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ |

### å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ | èª¬æ˜ |
|---------------|------|
| ğŸ”€ **nginx** | ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ã€‚`api.local.dev` / `mtls.api.local.dev` ã¸ã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’ idp-server ã‚¯ãƒ©ã‚¹ã‚¿ã«ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ã€‚mTLSãƒ‰ãƒ¡ã‚¤ãƒ³ã§ã¯ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆè¨¼æ˜æ›¸ã‚’æ¤œè¨¼ãƒ»è»¢é€ |
| ğŸ”¥ **idp-server-1/2** | idp-server æœ¬ä½“ã€‚ã‚¯ãƒ©ã‚¹ã‚¿æ§‹æˆã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãƒ»å†—é•·æ€§ã‚’ç¢ºèªï¼ˆãƒãƒ¼ãƒˆ 8081/8082ï¼‰ |
| ğŸ–¥ï¸ **app-view** | Next.jsè£½ã®èªå¯UIã€‚ãƒ­ã‚°ã‚¤ãƒ³ãƒ»åŒæ„ç”»é¢ãªã©ã‚’æä¾› |
| ğŸŒ **sample-web** | ã‚µãƒ³ãƒ—ãƒ«RPã‚¢ãƒ—ãƒªã€‚OIDCé€£æºã®ãƒ‡ãƒ¢ãƒ»ãƒ†ã‚¹ãƒˆç”¨ |
| ğŸ§  **PostgreSQL Primary** | ãƒ¡ã‚¤ãƒ³DBï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªï¼‰ã€‚æ›¸ãè¾¼ã¿ãƒ»èª­ã¿è¾¼ã¿æ“ä½œã‚’å‡¦ç†ï¼ˆãƒãƒ¼ãƒˆ: 5432ï¼‰ |
| ğŸ“– **PostgreSQL Replica** | èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¬ãƒ—ãƒªã‚«DBã€‚ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã§åŒæœŸï¼ˆãƒãƒ¼ãƒˆ: 5433ï¼‰ |
| âš¡ **Redis** | ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ãƒ»ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ãƒˆã‚¢ï¼ˆãƒãƒ¼ãƒˆ: 6379ï¼‰ |
| ğŸ§ª **Mockoon** | å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æºã‚’æ¨¡æ“¬ã™ã‚‹ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ï¼ˆeKYC/é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ç­‰ï¼‰ |

### ç‰¹å¾´
- **ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ§‹æˆ**: æœ¬ç•ªç’°å¢ƒã«è¿‘ã„ `*.local.dev` ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³æ§‹æˆ
- **è¤‡æ•°å°æ§‹æˆï¼ˆHAãƒ†ã‚¹ãƒˆå¯ï¼‰**: 2å°ã® idp-server ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ã§èµ·å‹•ã—ã€nginx çµŒç”±ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- **PostgreSQL Primary/Replica**: ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹èª­ã¿æ›¸ãåˆ†é›¢
- **Redis ã‚»ãƒƒã‚·ãƒ§ãƒ³/ã‚­ãƒ£ãƒƒã‚·ãƒ¥**: é«˜é€Ÿãªã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥
- **ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰çµ±åˆ**: èªå¯UIï¼ˆapp-viewï¼‰ã¨ã‚µãƒ³ãƒ—ãƒ«RPï¼ˆsample-webï¼‰ã‚’å«ã‚€
- **ãƒ¢ãƒƒã‚¯ç’°å¢ƒå®Œå‚™**: Mockoon ã«ã‚ˆã‚‹å¤–éƒ¨é€£æºæ¨¡æ“¬ã§E2Eè©¦é¨“ã‚‚å¯èƒ½

> **Note**: MySQL ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã¯ `docker-compose-mysql.yaml` ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †

### 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³

```bash
git clone https://github.com/hirokazu-kobayashi-koba-hiro/idp-server.git
cd idp-server
```

### 2. ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³è¨­å®šï¼ˆåˆå›ã®ã¿ï¼‰

ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã§ `*.local.dev` ã‚µãƒ–ãƒ‰ãƒ¡ã‚¤ãƒ³ã‚’ä½¿ç”¨ã™ã‚‹ãŸã‚ã€ä»¥ä¸‹ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼š

```shell
./scripts/setup-local-subdomain.sh
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’è¨­å®šã—ã¾ã™ï¼š
- dnsmasq ã«ã‚ˆã‚‹ `*.local.dev` ã®ãƒ­ãƒ¼ã‚«ãƒ«DNSè§£æ±º
- mkcert ã«ã‚ˆã‚‹ãƒ­ãƒ¼ã‚«ãƒ«SSLè¨¼æ˜æ›¸ã®ç”Ÿæˆ

> **Note**: macOS ã‚’å‰æã¨ã—ã¦ã„ã¾ã™ã€‚ä»–ã®OSã§ã¯æ‰‹å‹•è¨­å®šãŒå¿…è¦ã§ã™ï¼ˆä¸‹è¨˜å‚ç…§ï¼‰ã€‚

#### è¨­å®šã®ç¢ºèª

ã‚¹ã‚¯ãƒªãƒ—ãƒˆå®Ÿè¡Œå¾Œã€ä»¥ä¸‹ã®ã‚³ãƒãƒ³ãƒ‰ã§DNSè§£æ±ºãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ç¢ºèªã—ã¾ã™ï¼š

```shell
# DNSè§£æ±ºã®ç¢ºèª
ping -c 1 api.local.dev
ping -c 1 auth.local.dev

# ã¾ãŸã¯ nslookup ã§ç¢ºèª
nslookup api.local.dev
```

`127.0.0.1` ãŒè¿”ã•ã‚Œã‚Œã°æ­£å¸¸ã§ã™ã€‚

#### æ‰‹å‹•è¨­å®šï¼ˆä»–ã®OS / dnsmasqãŒä½¿ãˆãªã„å ´åˆï¼‰

dnsmasqã‚’ä½¿ç”¨ã§ããªã„ç’°å¢ƒã§ã¯ã€`/etc/hosts` ã«ç›´æ¥è¿½è¨˜ã™ã‚‹ã“ã¨ã§ä»£æ›¿ã§ãã¾ã™ï¼š

```shell
# Linux / macOS
sudo sh -c 'echo "127.0.0.1 api.local.dev mtls.api.local.dev auth.local.dev sample.local.dev" >> /etc/hosts'

# Windows (ç®¡ç†è€…æ¨©é™ã®PowerShell)
Add-Content -Path C:\Windows\System32\drivers\etc\hosts -Value "127.0.0.1 api.local.dev mtls.api.local.dev auth.local.dev sample.local.dev"
```

#### ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°

| å•é¡Œ | åŸå›  | è§£æ±ºç­– |
|------|------|--------|
| `ping api.local.dev` ãŒå¤±æ•— | dnsmasq ãŒå‹•ä½œã—ã¦ã„ãªã„ | `brew services restart dnsmasq` ã‚’å®Ÿè¡Œã€ã¾ãŸã¯ `/etc/hosts` ã§æ‰‹å‹•è¨­å®š |
| DNSè§£æ±ºãŒ `127.0.0.1` ä»¥å¤–ã‚’è¿”ã™ | ä»–ã®DNSãƒªã‚¾ãƒ«ãƒãŒå„ªå…ˆã•ã‚Œã¦ã„ã‚‹ | `/etc/resolver/local.dev` ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã™ã‚‹ã‹ç¢ºèª |
| SSLè¨¼æ˜æ›¸ã‚¨ãƒ©ãƒ¼ | mkcert ã®ãƒ«ãƒ¼ãƒˆCAãŒæœªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ« | `mkcert -install` ã‚’å®Ÿè¡Œ |

### 3. ç’°å¢ƒå¤‰æ•°ã®è¨­å®š

#### ã‚·ãƒ³ãƒ—ãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆå›ºå®šIDä½¿ç”¨ãƒ»æ¨å¥¨ï¼‰

`config/examples/` é…ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«è¨­å®šã¨äº’æ›æ€§ã®ã‚ã‚‹å›ºå®šIDã‚’ä½¿ç”¨ã™ã‚‹å ´åˆï¼š

```shell
# ã‚µãƒ³ãƒ—ãƒ«ç’°å¢ƒå¤‰æ•°ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚³ãƒ”ãƒ¼
cp ./.env.example .env

# å¿…è¦ãªå€¤ã‚’è¨­å®šï¼ˆä»¥ä¸‹ã¯ä¾‹ï¼‰
# IDP_SERVER_API_KEY, IDP_SERVER_API_SECRET, ENCRYPTION_KEY,
# POSTGRES_PASSWORD, DB_OWNER_PASSWORD, IDP_DB_ADMIN_PASSWORD, IDP_DB_APP_PASSWORD
# ãªã©ã‚’è¨­å®šã—ã¦ãã ã•ã„
```

#### ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ–°ã—ã„IDã‚’ç”Ÿæˆï¼‰

æ–°ã—ã„ãƒ©ãƒ³ãƒ€ãƒ IDã‚’ç”Ÿæˆã™ã‚‹å ´åˆï¼š

```shell
./init-generate-env.sh postgresql
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã‚’ç”Ÿæˆã—ã¾ã™ï¼š
- `.env` ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆå…¨ã¦ã®ç’°å¢ƒå¤‰æ•°ï¼‰
- `config/secrets/local/` é…ä¸‹ã®ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆãƒ•ã‚¡ã‚¤ãƒ«

> **æ³¨æ„**: æ–°ã—ã„IDã‚’ç”Ÿæˆã™ã‚‹ã¨ã€`config/examples/` é…ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«è¨­å®šã¨ã®äº’æ›æ€§ãŒå¤±ã‚ã‚Œã¾ã™ã€‚

### 4. Dockerèµ·å‹•

```shell
# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ“ãƒ«ãƒ‰
docker compose build

# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚‚è‡ªå‹•å®Ÿè¡Œï¼‰
docker compose up -d
```

ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™ï¼š
- PostgreSQL Primary/Replicaãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆ
- ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯

### 5. ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèª

ã‚µãƒ¼ãƒ“ã‚¹ã®å¥å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯ï¼š

```shell
curl -v https://api.local.dev/actuator/health
```

PostgreSQLãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¢ºèªï¼š

```shell
./scripts/verify-replication.sh
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
- ãƒ—ãƒ©ã‚¤ãƒãƒªã¨ãƒ¬ãƒ—ãƒªã‚«ã®çŠ¶æ…‹ç¢ºèª
- ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ­ãƒƒãƒˆã®ç¢ºèª
- ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªã«æ›¸ãè¾¼ã¿ã€ãƒ¬ãƒ—ãƒªã‚«ã‹ã‚‰èª­ã¿å–ã‚Šï¼‰
- ãƒ¬ãƒ—ãƒªã‚«ã¸ã®æ›¸ãè¾¼ã¿åˆ¶é™ç¢ºèª
- æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆãƒãƒ¼ãƒˆ 5432: ãƒ—ãƒ©ã‚¤ãƒãƒªã€ãƒãƒ¼ãƒˆ 5433: ãƒ¬ãƒ—ãƒªã‚«ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰

ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå¿…è¦ãªå ´åˆã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’å€‹åˆ¥ã«é–‹å§‹ï¼š

```shell
# 1. ã¾ãšãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èµ·å‹•
docker compose up -d postgres-primary postgres-replica redis

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
docker compose up flyway-migrator

# 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
docker compose up -d idp-server-1 idp-server-2 nginx app-view sample-web
```

### 6. è¨­å®šã®é©ç”¨

#### admin-tenant ã®åˆæœŸåŒ–

admin-tenant ã®è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç”Ÿæˆï¼š

```shell
./init-admin-tenant-config.sh
```

admin-tenant ã‚’åˆæœŸåŒ–ï¼š

```shell
./setup.sh
```

#### E2Eãƒ†ã‚¹ãƒˆç”¨ãƒ‡ãƒ¼ã‚¿ã®è¨­å®š

E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã™ã‚‹ãŸã‚ã®ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ã‚’è¨­å®šï¼š

```shell
./config/scripts/e2e-test-data.sh
```

### 7. ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆE2Eï¼‰

è¨­å®šã®é©ç”¨ãŒå®Œäº†ã—ãŸã‚‰ã€E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦IdPã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

#### ãƒ†ã‚¹ãƒˆæ§‹æˆ

ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã¯3ã¤ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«åˆ†ã‹ã‚Œã¦ã„ã¾ã™ï¼š

| ã‚«ãƒ†ã‚´ãƒªãƒ¼ | èª¬æ˜ |
|-----------|------|
| ğŸ“˜ **scenario/** | ç¾å®Ÿçš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã€SSOãƒ­ã‚°ã‚¤ãƒ³ã€CIBAãƒ•ãƒ­ãƒ¼ã€MFAç™»éŒ²ãªã©ï¼‰ |
| ğŸ“• **spec/** | OpenID Connectã€FAPIã€JARMã€Verifiable Credentialsã«åŸºã¥ãä»•æ§˜æº–æ‹ ãƒ†ã‚¹ãƒˆ |
| ğŸ’ **monkey/** | éšœå®³æ³¨å…¥ã¨ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®æ¤œè¨¼ï¼ˆæ„å›³çš„ã«ç„¡åŠ¹ãªã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«é•åï¼‰ |

#### å®Ÿè¡Œ

```shell
cd e2e
npm install
npm test
```

ç´„800ã‚±ãƒ¼ã‚¹ã®ãƒ†ã‚¹ãƒˆãŒå®Ÿè¡Œã•ã‚Œã€æ­£å¸¸ã«å‹•ä½œã™ã‚‹ã“ã¨ãŒç¢ºèªã§ãã¾ã™ã€‚

## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã®ãƒªã‚½ãƒ¼ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§è² è·ãƒ†ã‚¹ãƒˆã‚„ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹æ¤œè¨¼ã‚’è¡Œã†å ´åˆã€ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆè¨­å®šã§ã¯ååˆ†ãªã‚¹ãƒ«ãƒ¼ãƒ—ãƒƒãƒˆãŒå¾—ã‚‰ã‚Œãªã„ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚
ä»¥ä¸‹ã®è¨­å®šã‚’èª¿æ•´ã™ã‚‹ã“ã¨ã§ã€ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã§ã‚‚ã‚ˆã‚Šé«˜ã„è² è·ã«å¯¾å¿œã§ãã¾ã™ã€‚

### Docker ãƒªã‚½ãƒ¼ã‚¹å‰²ã‚Šå½“ã¦

`docker-compose.yaml` ã§å„ã‚³ãƒ³ãƒ†ãƒŠã®ãƒªã‚½ãƒ¼ã‚¹åˆ¶é™ã‚’è¨­å®šã§ãã¾ã™ã€‚

```yaml
services:
  idp-server-1:
    deploy:
      resources:
        limits:
          cpus: '2.0'    # CPUåˆ¶é™ï¼ˆã‚³ã‚¢æ•°ï¼‰
          memory: 2048M  # ãƒ¡ãƒ¢ãƒªåˆ¶é™
```

**æ¨å¥¨è¨­å®šï¼ˆè² è·ãƒ†ã‚¹ãƒˆç”¨ï¼‰**:
- idp-server: CPU 2.0ã€œ3.0ã‚³ã‚¢ã€ãƒ¡ãƒ¢ãƒª 2GB
- PostgreSQL: CPU 2.0ã‚³ã‚¢ã€ãƒ¡ãƒ¢ãƒª 2GB
- nginx: CPU 1.0ã‚³ã‚¢ã€ãƒ¡ãƒ¢ãƒª 512MB

> **Note**: Docker Desktop ã®è¨­å®šã§ååˆ†ãªãƒªã‚½ãƒ¼ã‚¹ãŒå‰²ã‚Šå½“ã¦ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã‚’ç¢ºèªã—ã¦ãã ã•ã„ï¼ˆæ¨å¥¨: 6ã‚³ã‚¢ä»¥ä¸Šã€8GBä»¥ä¸Šã®ãƒ¡ãƒ¢ãƒªï¼‰ã€‚

### PostgreSQL ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

`docker-compose.yaml` ã® PostgreSQL ã‚³ãƒãƒ³ãƒ‰ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’èª¿æ•´ã§ãã¾ã™ã€‚

```yaml
postgres-primary:
  command:
    - "postgres"
    - "-c"
    - "shared_buffers=1GB"           # å…±æœ‰ãƒãƒƒãƒ•ã‚¡ï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 128MBï¼‰
    - "-c"
    - "work_mem=64MB"                # ä½œæ¥­ãƒ¡ãƒ¢ãƒªï¼ˆãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ: 4MBï¼‰
    - "-c"
    - "effective_cache_size=2GB"     # å®ŸåŠ¹ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚µã‚¤ã‚º
    - "-c"
    - "max_parallel_workers_per_gather=4"  # ä¸¦åˆ—ãƒ¯ãƒ¼ã‚«ãƒ¼æ•°
```

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | æ¨å¥¨å€¤ | èª¬æ˜ |
|-----------|----------|--------|------|
| `shared_buffers` | 128MB | 1GB | PostgreSQLãŒä½¿ç”¨ã™ã‚‹å…±æœ‰ãƒ¡ãƒ¢ãƒª |
| `work_mem` | 4MB | 64MB | ã‚½ãƒ¼ãƒˆãƒ»ãƒãƒƒã‚·ãƒ¥æ“ä½œç”¨ãƒ¡ãƒ¢ãƒª |
| `effective_cache_size` | - | 2GB | OSã‚­ãƒ£ãƒƒã‚·ãƒ¥è¦‹ç©ã‚‚ã‚Šï¼ˆãƒ—ãƒ©ãƒ³ãƒŠãƒ¼ç”¨ï¼‰ |
| `max_parallel_workers_per_gather` | 2 | 4 | ä¸¦åˆ—ã‚¯ã‚¨ãƒªãƒ¯ãƒ¼ã‚«ãƒ¼æ•° |

> **Note**: è¨­å®šå¤‰æ›´å¾Œã¯ `docker compose up -d postgres-primary` ã§ã‚³ãƒ³ãƒ†ãƒŠã‚’å†ä½œæˆã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ï¼ˆ`restart` ã§ã¯åæ˜ ã•ã‚Œã¾ã›ã‚“ï¼‰ã€‚

### HikariCPï¼ˆã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«ï¼‰è¨­å®š

`application.yaml` ã§ HikariCP ã®ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³ãƒ—ãƒ¼ãƒ«è¨­å®šã‚’ç’°å¢ƒå¤‰æ•°ã§èª¿æ•´ã§ãã¾ã™ã€‚

```yaml
idp:
  datasource:
    app:
      writer:
        hikari:
          connection-timeout: ${DB_WRITER_TIMEOUT:30000}      # æ¥ç¶šå–å¾—ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆmsï¼‰
          maximum-pool-size: ${DB_WRITER_MAX_POOL_SIZE:30}    # æœ€å¤§ãƒ—ãƒ¼ãƒ«æ•°
          minimum-idle: ${DB_WRITER_MIN_IDLE:10}              # æœ€å°ã‚¢ã‚¤ãƒ‰ãƒ«æ¥ç¶šæ•°
          idle-timeout: ${DB_WRITER_IDLE_TIMEOUT:600000}      # ã‚¢ã‚¤ãƒ‰ãƒ«ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆmsï¼‰
          max-lifetime: ${DB_WRITER_MAX_LIFETIME:1800000}     # æ¥ç¶šæœ€å¤§ç”Ÿå­˜æ™‚é–“ï¼ˆmsï¼‰
          keepalive-time: ${DB_WRITER_KEEPALIVE_TIME:180000}  # ã‚­ãƒ¼ãƒ—ã‚¢ãƒ©ã‚¤ãƒ–é–“éš”ï¼ˆmsï¼‰
          validation-timeout: ${DB_WRITER_VALIDATION_TIMEOUT:5000}  # æ¤œè¨¼ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆï¼ˆmsï¼‰
```

| ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ | ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ | èª¬æ˜ |
|-----------|----------|------|
| `connection-timeout` | 30000ms | ãƒ—ãƒ¼ãƒ«ã‹ã‚‰æ¥ç¶šã‚’å–å¾—ã™ã‚‹æœ€å¤§å¾…æ©Ÿæ™‚é–“ |
| `maximum-pool-size` | 30 | æœ€å¤§ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æ•° |
| `minimum-idle` | 10 | ã‚¢ã‚¤ãƒ‰ãƒ«æ™‚ã«ç¶­æŒã™ã‚‹æœ€å°ã‚³ãƒã‚¯ã‚·ãƒ§ãƒ³æ•° |
| `keepalive-time` | 180000ms | DBæ¥ç¶šã®ã‚­ãƒ¼ãƒ—ã‚¢ãƒ©ã‚¤ãƒ–é–“éš”ï¼ˆAuroraç­‰ã®tcp_keepalive_idleæœªæº€ã«è¨­å®šï¼‰ |
| `validation-timeout` | 5000ms | æ¥ç¶šæ¤œè¨¼ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆ |

### nginx ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°

`docker/nginx/nginx.conf` ã§nginxã®ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’èª¿æ•´ã§ãã¾ã™ã€‚

```nginx
worker_processes auto;

events {
    worker_connections 4096;  # ãƒ¯ãƒ¼ã‚«ãƒ¼ã‚ãŸã‚Šã®æœ€å¤§æ¥ç¶šæ•°
    multi_accept on;          # è¤‡æ•°æ¥ç¶šã®åŒæ™‚å—ä»˜
    use epoll;                # ã‚¤ãƒ™ãƒ³ãƒˆé§†å‹•ãƒ¢ãƒ‡ãƒ«ï¼ˆLinuxï¼‰
}

http {
    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    keepalive_requests 10000;  # ã‚­ãƒ¼ãƒ—ã‚¢ãƒ©ã‚¤ãƒ–ã‚ãŸã‚Šã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ•°

    upstream idp_backend {
        keepalive 100;  # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã¸ã®ã‚­ãƒ¼ãƒ—ã‚¢ãƒ©ã‚¤ãƒ–æ¥ç¶šæ•°
        server idp-server-1:8080;
        server idp-server-2:8080;
    }
}
```

### ãƒªã‚½ãƒ¼ã‚¹ãƒ¢ãƒ‹ã‚¿ãƒªãƒ³ã‚°

è² è·ãƒ†ã‚¹ãƒˆä¸­ã¯ `docker stats` ã§ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨çŠ¶æ³ã‚’ç›£è¦–ã—ã€ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã‚’ç‰¹å®šã—ã¾ã™ã€‚

```bash
docker stats --format "table {{.Name}}\t{{.CPUPerc}}\t{{.MemUsage}}"
```

**å…¸å‹çš„ãªãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãƒ‘ã‚¿ãƒ¼ãƒ³**:

| ç—‡çŠ¶ | åŸå›  | å¯¾ç­– |
|------|------|------|
| PostgreSQL CPU > 100% | DBãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ | shared_buffers/work_memå¢—åŠ ã€ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ç¢ºèª |
| idp-server CPU > 100% | JVMå‡¦ç†é™ç•Œ | CPUå‰²ã‚Šå½“ã¦å¢—åŠ ã€ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹è¿½åŠ  |
| nginx CPUé«˜è² è· | æ¥ç¶šå‡¦ç†é™ç•Œ | worker_connectionså¢—åŠ  |
| ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡é«˜ | ãƒ’ãƒ¼ãƒ—ä¸è¶³ | ã‚³ãƒ³ãƒ†ãƒŠãƒ¡ãƒ¢ãƒªåˆ¶é™å¢—åŠ  |

> **Tip**: è©³ç´°ãªãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°ã‚¬ã‚¤ãƒ‰ã¯ [ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒãƒ¥ãƒ¼ãƒ‹ãƒ³ã‚°](../content_11_learning/26-performance-tuning/) ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

## æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—

ã‚¯ã‚¤ãƒƒã‚¯ã‚¹ã‚¿ãƒ¼ãƒˆã¯ã“ã‚Œã§å®Œäº†ã§ã™ã€‚æ¬¡ã®ã‚¹ãƒ†ãƒƒãƒ—ã¨ã—ã¦ä»¥ä¸‹ã‚’å‚ç…§ã—ã¦ãã ã•ã„ï¼š

- [ã‚³ãƒ³ã‚»ãƒ—ãƒˆ](../content_03_concepts/) - idp-server ã®è¨­è¨ˆæ€æƒ³ã¨ä¸»è¦æ¦‚å¿µ
- [ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«](../content_04_tutorials/) - å…·ä½“çš„ãªãƒ¦ãƒ¼ã‚¹ã‚±ãƒ¼ã‚¹åˆ¥ã®å®Ÿè£…ã‚¬ã‚¤ãƒ‰
- [é–‹ç™ºè€…ã‚¬ã‚¤ãƒ‰](../content_06_developer-guide/) - è©³ç´°ãªå®Ÿè£…ãƒªãƒ•ã‚¡ãƒ¬ãƒ³ã‚¹
