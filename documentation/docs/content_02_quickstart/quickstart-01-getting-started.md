# Getting-Started

ã“ã®ã‚¬ã‚¤ãƒ‰ã§ã¯ã€**idp-server** ã‚’åˆã‚ã¦ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã—ã¦å®Ÿè¡Œã™ã‚‹æ‰‹é †ã‚’èª¬æ˜ã—ã¾ã™ã€‚

## å‰ææ¡ä»¶

| ãƒ„ãƒ¼ãƒ« | å¿…é ˆãƒãƒ¼ã‚¸ãƒ§ãƒ³ | æ¨å¥¨ | å‚™è€ƒ |
|-------|-------------|------|------|
| **Java** | 21+ | Java 21 | |
| **ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹** | PostgreSQL 14+ ã¾ãŸã¯ MySQL 8.0+ | **PostgreSQL 14+** | Primary/Replica æ§‹æˆå¯¾å¿œ |
| **Node.js** | 18.0+ | 20.x LTS | E2E ãƒ†ã‚¹ãƒˆå®Ÿè¡Œã«å¿…è¦ |
| **Docker** | 20.10+ | Docker Desktop æœ€æ–°ç‰ˆ | Compose V2 å¯¾å¿œ |

### ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹é¸æŠã‚¬ã‚¤ãƒ‰
- **PostgreSQL**: âœ… æ¨å¥¨ï¼ˆPrimary/Replica å¯¾å¿œã€æœ¬ç•ªç’°å¢ƒå‘ã‘ï¼‰
- **MySQL**: âš ï¸ åŸºæœ¬æ©Ÿèƒ½ã®ã¿ï¼ˆé–‹ç™ºãƒ»æ¤œè¨¼ç’°å¢ƒå‘ã‘ï¼‰

## ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒæ§‹æˆ

ã“ã®å›³ã¯ã€docker-compose ã‚’ä½¿ã£ã¦æ§‹ç¯‰ã•ã‚Œã‚‹ idp-server ã®ãƒ­ãƒ¼ã‚«ãƒ«é–‹ç™ºç’°å¢ƒã®å…¨ä½“æ§‹æˆã‚’ç¤ºã—ã¦ã„ã¾ã™ã€‚

```mermaid
flowchart TD
subgraph Nginx LB
nginx[ğŸŒ nginx<br>ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼]
end

subgraph App Cluster
idp1[ğŸ”¥ idp-server-1]
idp2[ğŸ”¥ idp-server-2]
end

subgraph Database
subgraph PostgreSQL Cluster
pg_primary[ğŸ§  PostgreSQL Primary<br>Write/Read]
pg_replica[ğŸ“– PostgreSQL Replica<br>Read-Only]
pg_primary -.->|Streaming WAL| pg_replica
end
mysql[ğŸ—„ï¸ MySQL]
redis[âš¡ Redis]
end

subgraph External Services
mockoon[ğŸ§ª Mockoon]
end

nginx --> idp1
nginx --> idp2

idp1 --> pg_primary
idp1 -.->|Read| pg_replica
idp1 --> mysql
idp1 --> redis
idp1 --> mockoon

idp2 --> pg_primary
idp2 -.->|Read| pg_replica
idp2 --> mysql
idp2 --> redis
idp2 --> mockoon

```

### å„ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆã®å½¹å‰²

| ã‚³ãƒ³ãƒãƒ¼ãƒãƒ³ãƒˆ               | èª¬æ˜                                                                    |
|-----------------------|-----------------------------------------------------------------------|
| ğŸŒ **nginx**          | `idp-server-1`, `idp-server-2` ã«ãƒªãƒãƒ¼ã‚¹ãƒ—ãƒ­ã‚­ã‚·ï¼ãƒ­ãƒ¼ãƒ‰ãƒãƒ©ãƒ³ã‚µãƒ¼ã¨ã—ã¦ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ï¼ˆãƒãƒ¼ãƒˆ: 8080ï¼‰ |
| ğŸ”¥ **idp-server-1/2** | `idp-server` ã®æœ¬ä½“ã€‚ã‚¯ãƒ©ã‚¹ã‚¿æ§‹æˆã§ã‚¹ã‚±ãƒ¼ãƒ©ãƒ“ãƒªãƒ†ã‚£ãƒ»å†—é•·æ€§ã‚’ç¢ºèªã§ãã‚‹ã‚ˆã†ã«ã—ã¦ã‚ã‚‹ï¼ˆãã‚Œãã‚Œãƒãƒ¼ãƒˆ8081 / 8082ï¼‰ |
| ğŸ§  **PostgreSQL Primary** | ãƒ¡ã‚¤ãƒ³ã®æ°¸ç¶šåŒ–DBï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªï¼‰ã€‚æ›¸ãè¾¼ã¿ãƒ»èª­ã¿è¾¼ã¿æ“ä½œã‚’å‡¦ç†ï¼ˆãƒãƒ¼ãƒˆ: 5432ï¼‰ |
| ğŸ“– **PostgreSQL Replica** | èª­ã¿å–ã‚Šå°‚ç”¨ãƒ¬ãƒ—ãƒªã‚«DBã€‚ã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã£ã¦ãƒ—ãƒ©ã‚¤ãƒãƒªã¨åŒæœŸï¼ˆãƒãƒ¼ãƒˆ: 5433ï¼‰ |
| ğŸ—„ï¸ **MySQL**         | å°†æ¥çš„ãªã‚µãƒãƒ¼ãƒˆã«å‘ã‘ãŸè©•ä¾¡ç”¨ã€‚PostgreSQLã¨ã®åˆ‡æ›¿äº’æ›æ€§ã‚’æƒ³å®šã—ã¦å°å…¥                              |
| âš¡ **Redis**           | ã‚»ãƒƒã‚·ãƒ§ãƒ³æƒ…å ±ã‚„ä¸€æ™‚ãƒ‡ãƒ¼ã‚¿ã®ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚¹ãƒˆã‚¢ã¨ã—ã¦åˆ©ç”¨                                           |
| ğŸ§ª **Mockoon**        | å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹é€£æºã‚’æ¨¡æ“¬ã™ã‚‹ãƒ¢ãƒƒã‚¯ã‚µãƒ¼ãƒãƒ¼ï¼ˆeKYC / é€šçŸ¥ã‚µãƒ¼ãƒ“ã‚¹ãªã©ã®ãƒ†ã‚¹ãƒˆã«ä½¿ç”¨ï¼‰                          |


### ç‰¹å¾´
- è¤‡æ•°å°æ§‹æˆï¼ˆHAãƒ†ã‚¹ãƒˆå¯ï¼‰ï¼š2å°ã® idp-server ã‚’ã‚¯ãƒ©ã‚¹ã‚¿ã§èµ·å‹•ã—ã€nginx çµŒç”±ã§ãƒ«ãƒ¼ãƒ†ã‚£ãƒ³ã‚°
- PostgreSQL Primary/Replicaæ§‹æˆï¼šã‚¹ãƒˆãƒªãƒ¼ãƒŸãƒ³ã‚°ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã«ã‚ˆã‚‹èª­ã¿æ›¸ãåˆ†é›¢ã§ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆå¯èƒ½
- æŸ”è»ŸãªDBæ¥ç¶šï¼šPostgreSQL Primary/Replicaãƒ¡ã‚¤ãƒ³ã€MySQLã‚‚é¸æŠå¯èƒ½ãªæ§‹æˆ
- Redisã«ã‚ˆã‚‹é«˜é€Ÿã‚­ãƒ£ãƒƒã‚·ãƒ¥ï¼šãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ãƒ†ã‚¹ãƒˆã‚„ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã«æœ€é©
- ãƒ¢ãƒƒã‚¯ç’°å¢ƒå®Œå‚™ï¼šMockoon ã«ã‚ˆã‚‹å¤–éƒ¨é€£æºæ¨¡æ“¬ã§E2Eè©¦é¨“ã‚‚å¯èƒ½

## ã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«æ‰‹é †

### 1. ãƒªãƒã‚¸ãƒˆãƒªã®ã‚¯ãƒ­ãƒ¼ãƒ³

```bash
git clone https://github.com/hirokazu-kobayashi-koba-hiro/idp-server.git
cd idp-server
```

### ã‚·ãƒ³ãƒ—ãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆæ¨å¥¨ï¼‰

idp-serverã‚’ãŸã£ãŸ2ã¤ã®ã‚³ãƒãƒ³ãƒ‰ã§èµ·å‹•ã§ãã¾ã™ï¼š

```shell
# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’ãƒ“ãƒ«ãƒ‰
docker compose build

# å…¨ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•ï¼ˆãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹åˆæœŸåŒ–ã‚‚è‡ªå‹•å®Ÿè¡Œï¼‰
docker compose up -d
```

ã“ã‚Œã§å®Œäº†ã§ã™ï¼ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã«ã¯ä»¥ä¸‹ãŒå«ã¾ã‚Œã¾ã™ï¼š
- âœ… è‡ªå‹•ã‚¤ãƒ¡ãƒ¼ã‚¸ãƒ“ãƒ«ãƒ‰
- âœ… PostgreSQL Primary/Replicaãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³æ§‹æˆ
- âœ… ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
- âœ… å…¨ã‚µãƒ¼ãƒ“ã‚¹ã®ãƒ˜ãƒ«ã‚¹ãƒã‚§ãƒƒã‚¯
- âœ… ã‚µãƒ³ãƒ—ãƒ«è¨­å®šç”¨ã®å›ºå®šIDï¼ˆãƒ†ãƒŠãƒ³ãƒˆID: `67e7eae6-62b0-4500-9eff-87459f63fc66`ï¼‰

**æ³¨æ„:** ã“ã®ã‚·ãƒ³ãƒ—ãƒ«ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã§ã¯ã€`config/examples/` é…ä¸‹ã®ã‚µãƒ³ãƒ—ãƒ«è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã¨ä¸€è‡´ã™ã‚‹å›ºå®šIDã‚’ä½¿ç”¨ã—ã¾ã™ã€‚`./init.sh` ã‚’å®Ÿè¡Œã™ã‚‹ã¨æ–°ã—ã„ãƒ©ãƒ³ãƒ€ãƒ IDãŒç”Ÿæˆã•ã‚Œã‚‹ãŸã‚ã€ã‚µãƒ³ãƒ—ãƒ«è¨­å®šã¨ã®äº’æ›æ€§ãŒå¤±ã‚ã‚Œã¾ã™ã€‚

### ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ç¢ºèª

ã‚µãƒ¼ãƒ“ã‚¹ã®å¥å…¨æ€§ã‚’ãƒã‚§ãƒƒã‚¯ï¼š

```shell
curl -v http://localhost:8080/actuator/health
```

PostgreSQLãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®ç¢ºèªï¼š

```shell
./scripts/verify-replication.sh
```

ã“ã®ã‚¹ã‚¯ãƒªãƒ—ãƒˆã¯ä»¥ä¸‹ã®ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¾ã™ï¼š
- ãƒ—ãƒ©ã‚¤ãƒãƒªã¨ãƒ¬ãƒ—ãƒªã‚«ã®çŠ¶æ…‹ç¢ºèª
- ãƒ¬ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚¹ãƒ­ãƒƒãƒˆã®ç¢ºèª
- ãƒ‡ãƒ¼ã‚¿åŒæœŸãƒ†ã‚¹ãƒˆï¼ˆãƒ—ãƒ©ã‚¤ãƒãƒªã«æ›¸ãè¾¼ã¿ã€ãƒ¬ãƒ—ãƒªã‚«ã‹ã‚‰èª­ã¿å–ã‚Šï¼‰
- ãƒ¬ãƒ—ãƒªã‚«ã¸ã®æ›¸ãè¾¼ã¿åˆ¶é™ç¢ºèª
- æ¥ç¶šãƒ†ã‚¹ãƒˆï¼ˆãƒãƒ¼ãƒˆ 5432: ãƒ—ãƒ©ã‚¤ãƒãƒªã€ãƒãƒ¼ãƒˆ 5433: ãƒ¬ãƒ—ãƒªã‚«ï¼‰

### ã‚¹ãƒ†ãƒƒãƒ—ãƒã‚¤ã‚¹ãƒ†ãƒƒãƒ—ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆãƒ‡ãƒãƒƒã‚°ç”¨ï¼‰

ãƒˆãƒ©ãƒ–ãƒ«ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãŒå¿…è¦ãªå ´åˆã¯ã€ã‚µãƒ¼ãƒ“ã‚¹ã‚’å€‹åˆ¥ã«é–‹å§‹ï¼š

```shell
# 1. ã¾ãšãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã‚’èµ·å‹•
docker compose up -d postgres-primary postgres-replica mysql redis

# 2. ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ãƒã‚¤ã‚°ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³å®Ÿè¡Œ
docker compose up flyway-migrator

# 3. ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã‚µãƒ¼ãƒ“ã‚¹ã‚’èµ·å‹•
docker compose up -d idp-server-1 idp-server-2 nginx
```

### è¨­å®šã®é©ç”¨

```shell
./setup.sh
```

* admin-tenant

```shell
./config/scripts/test-data.sh
```

* test-tenant

```shell
./config/scripts/test-tenant-data.sh -t 1e68932e-ed4a-43e7-b412-460665e42df3
```

### ã‚¨ãƒ³ãƒ‰ãƒ„ãƒ¼ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆï¼ˆE2Eï¼‰

è¨­å®šã®é©ç”¨ãŒå®Œäº†ã—ãŸã‚‰ã€ã™ãã«E2Eãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œã—ã¦IdPã‚µãƒ¼ãƒãƒ¼ãŒæ­£å¸¸ã«å‹•ä½œã—ã¦ã„ã‚‹ã‹ã‚’ç¢ºèªã§ãã¾ã™ã€‚

#### ãƒ†ã‚¹ãƒˆæ§‹æˆ
ãƒ†ã‚¹ãƒˆã‚¹ã‚¤ãƒ¼ãƒˆã¯3ã¤ã®ã‚«ãƒ†ã‚´ãƒªãƒ¼ã«åˆ†ã‹ã‚Œã¦ã„ã¾ã™ï¼š

* ğŸ“˜ scenario/: ç¾å®Ÿçš„ãªãƒ¦ãƒ¼ã‚¶ãƒ¼ã¨ã‚·ã‚¹ãƒ†ãƒ ã®å‹•ä½œ â€” ãƒ¦ãƒ¼ã‚¶ãƒ¼ç™»éŒ²ã€SSOãƒ­ã‚°ã‚¤ãƒ³ã€CIBAãƒ•ãƒ­ãƒ¼ã€MFAç™»éŒ²ãªã©
* ğŸ“• spec/: OpenID Connectã€FAPIã€JARMã€Verifiable Credentialsã«åŸºã¥ãä»•æ§˜æº–æ‹ ãƒ†ã‚¹ãƒˆ
* ğŸ’ monkey/: éšœå®³æ³¨å…¥ã¨ã‚¨ãƒƒã‚¸ã‚±ãƒ¼ã‚¹ã®æ¤œè¨¼ â€” æ„å›³çš„ã«ç„¡åŠ¹ãªã‚·ãƒ¼ã‚±ãƒ³ã‚¹ã€ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã€ãƒ—ãƒ­ãƒˆã‚³ãƒ«é•å

#### å®Ÿè¡Œ

```shell
cd e2e
npm install
npm test
```

---

## ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ï¼ˆä¸Šç´šè€…å‘ã‘ï¼‰

æ–°ã—ã„ãƒ©ãƒ³ãƒ€ãƒ IDã§ç’°å¢ƒã‚’æ§‹ç¯‰ã—ãŸã„å ´åˆï¼š

### 1. æ–°ã—ã„ã‚·ãƒ¼ã‚¯ãƒ¬ãƒƒãƒˆã¨IDã®ç”Ÿæˆ

```shell
./init.sh
```

ã“ã‚Œã«ã‚ˆã‚Šä»¥ä¸‹ãŒç”Ÿæˆã•ã‚Œã¾ã™ï¼š
- `config/secrets/local/encryption-keys.json` - æ–°ã—ã„APIã‚­ãƒ¼ãƒ»æš—å·åŒ–ã‚­ãƒ¼
- `config/secrets/local/client-secrets.json` - æ–°ã—ã„ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆèªè¨¼æƒ…å ±
- `.env` - æ–°ã—ã„ãƒ†ãƒŠãƒ³ãƒˆIDãƒ»ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDå«ã‚€ç’°å¢ƒå¤‰æ•°

### 2. JWKSã®æŠ½å‡º

```shell
# ã‚µãƒ³ãƒ—ãƒ«ã‹ã‚‰JWKSã‚’æŠ½å‡ºï¼ˆæœ¬ç•ªç’°å¢ƒã§ã¯ç‹¬è‡ªã®JWKSã‚’ç”Ÿæˆã™ã‚‹ã“ã¨ï¼‰
jq -r '.authorization_server.jwks' config/examples/local/organizer-tenant/initial.json | \
  python3 -c "import sys, json; jwks_str = sys.stdin.read(); jwks = json.loads(jwks_str); print(json.dumps(jwks, indent=2))" \
  > config/secrets/local/jwks.json
```

### 3. ã‚«ã‚¹ã‚¿ãƒ è¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã®ä½œæˆ

æ–°ã—ã„IDã«åˆã‚ã›ã¦ `config/examples/local/admin-tenant/initial.json` ã‚’ã‚³ãƒ”ãƒ¼ã—ã¦ç·¨é›†ï¼š

```shell
cp config/examples/local/admin-tenant/initial.json config/examples/local/custom-tenant/initial.json
# ãƒ†ãƒŠãƒ³ãƒˆIDã€ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆIDã€ãƒ¦ãƒ¼ã‚¶ãƒ¼IDãªã©ã‚’ .env ã®å€¤ã«åˆã‚ã›ã¦æ‰‹å‹•ç·¨é›†
```

### 4. ã‚µãƒ¼ãƒ“ã‚¹èµ·å‹•ã¨åˆæœŸåŒ–

```shell
docker compose up -d

# ã‚«ã‚¹ã‚¿ãƒ è¨­å®šã§åˆæœŸåŒ–
curl -X POST "${IDP_SERVER_DOMAIN}v1/admin/initialization" \
  -u "${IDP_SERVER_API_KEY}:${IDP_SERVER_API_SECRET}" \
  -H "Content-Type:application/json" \
  --data @./config/examples/local/custom-tenant/initial.json | jq
```

**æ³¨æ„:** ã‚«ã‚¹ã‚¿ãƒ ã‚»ãƒƒãƒˆã‚¢ãƒƒãƒ—ã‚’ä½¿ç”¨ã™ã‚‹å ´åˆã€E2Eãƒ†ã‚¹ãƒˆã¯å›ºå®šIDã‚’å‰æã¨ã—ã¦ã„ã‚‹ãŸã‚ã€ãã®ã¾ã¾ã§ã¯å‹•ä½œã—ã¾ã›ã‚“ã€‚`e2e/src/tests/testConfig.js` ã® `DEFAULT_TENANT_ID` ã‚’æ–°ã—ã„ãƒ†ãƒŠãƒ³ãƒˆIDã«å¤‰æ›´ã™ã‚‹å¿…è¦ãŒã‚ã‚Šã¾ã™ã€‚

---