# テナント統計管理

idp-serverのテナント統計機能の概要について説明します。

## テナント統計とは

**テナント統計（Tenant Statistics）** とは、各テナントのユーザー活動やシステム利用状況を集計・可視化するための機能です。

### 主な目的

- **利用状況の可視化**: DAU/MAU/YAU、ログイン数などの把握
- **容量計画**: テナントごとのリソース使用状況の追跡
- **課金基盤**: MAU/YAUベースの従量課金データ提供
- **セキュリティ監視**: 異常なアクティビティの検知

---

## 収集されるメトリクス

### アクティブユーザー数

| メトリクス | 説明 | 集計レベル |
|:---|:---|:---|
| **DAU** (Daily Active Users) | 日次アクティブユーザー数 | 日次 |
| **MAU** (Monthly Active Users) | 月次アクティブユーザー数 | 月次 |
| **YAU** (Yearly Active Users) | 年次アクティブユーザー数 | 年次 |

### イベントカウント

| メトリクス | 説明 |
|:---|:---|
| `login_success` | ログイン成功回数 |
| `issue_token_success` | トークン発行成功回数 |
| `refresh_token_success` | トークンリフレッシュ成功回数 |
| `inspect_token_success` | トークン検証成功回数 |
| その他セキュリティイベント | イベント種別ごとにカウント |

### アクティブユーザーとしてカウントされるイベント

以下のイベントが発生したユーザーがアクティブユーザーとしてカウントされます：

- `login_success` - ログイン成功
- `issue_token_success` - トークン発行成功
- `refresh_token_success` - トークンリフレッシュ成功
- `inspect_token_success` - トークン検証成功

---

## ユースケース

### 1. ダッシュボード表示

テナント管理者が自テナントの利用状況を可視化します。

**表示項目例**:
- DAU/MAU/YAU トレンドグラフ
- 認証成功率
- トークン発行数推移

### 2. MAU/YAUベース課金

月次・年次アクティブユーザー数に基づく従量課金に利用できます。

### 3. セキュリティ監視

異常なアクティビティを検知します。

**検知パターン例**:
- DAUの急増（ボット攻撃の可能性）
- ログイン失敗率の急上昇
- 特定時間帯への集中

---

## データ保持期間

| データ種別 | 保持期間 |
|:---|:---|
| 日次統計（DAU詳細） | 90日 |
| 月次統計（MAU詳細） | 13ヶ月（YoY比較用） |
| 年次統計（YAU詳細） | 5年 |

---

## 統計更新のタイミング

統計データは**リアルタイム**で更新されます。セキュリティイベント（ログイン成功など）が発生するたびに、対応する統計値が増分更新されます。

バッチ処理による遅延はありません。

---

## 関連ドキュメント

- [統計機能 実装ガイド](../../content_06_developer-guide/08-reference/tenant-statistics-implementation.md) - データモデル、実装パターン、パーティショニング詳細
- [セキュリティイベント](../06-security-extensions/concept-17-security-events.md) - イベント駆動アーキテクチャ
- [マルチテナント](../01-foundation/concept-01-multi-tenant.md) - テナント分離の基本概念
