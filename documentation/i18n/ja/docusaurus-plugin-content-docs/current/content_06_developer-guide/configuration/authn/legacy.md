# レガシーIDサービス認証

このドキュメントは、`legacy-id-service-authentication` 方式による外部のレガシーなIDサービスと連携した認証処理の `概要`・
`設定`・`利用方法`について説明します。

---

## 概要

レガシーIDサービス認証は、既存の社内・外部のID基盤と連携し、認証およびユーザー情報取得を行う方式です。
以下の2段階の外部HTTPリクエストによって認証とユーザー情報の取得を行います：

1. **認証API**：ユーザー入力（例：ID/パスワード）に対して認証処理を実施
2. **ユーザー情報API**：認証に成功したユーザーの属性情報を取得

これにより、既存のシステムと疎結合なまま認証連携が可能になります。

---

## 設定

設定は `AuthenticationConfiguration` として、以下の2つのセクションに分かれます：

| セクション名           | 説明                            |
|------------------|-------------------------------|
| `authentication` | 認証リクエストのAPI定義（外部サービスへのPOSTなど） |
| `userinfo`       | 認証成功後に呼び出すユーザー情報取得APIの定義      |

### 各セクションの構成項目

| 項目                       | 内容                           |
|--------------------------|------------------------------|
| `url`                    | 外部APIのエンドポイントURL             |
| `method`                 | HTTPメソッド（通常はPOST）            |
| `headers`                | 認証ヘッダやContent-Type等の指定       |
| `dynamic_body_keys`      | リクエストボディに含める動的キー（ユーザー入力に基づく） |
| `static_body`            | リクエストボディに含める固定項目（例：サービスコード）  |
| `userinfo_mapping_rules` | ユーザー情報の属性マッピング定義（userinfoのみ） |

---

## 利用方法

1. クライアントがログインフォームなどで入力した情報を使い、`/authorizations/{id}/legacy-id-service-authentication` にPOST
2. 認証APIにリクエストを送り、認証結果を受け取る
3. 認証成功時、ユーザー情報APIにリクエストを送り、属性を取得
4. Userオブジェクトを構成し、既存ユーザーとの照合・生成を行う
5. 成功レスポンスとして `user` / `authentication` を返却

---

## 備考

* 認証処理とユーザー属性取得は完全に分離されており、柔軟な外部連携が可能です
* providerベースでユーザーを一意に特定し、subの付与・再利用が可能です
