# 設計原則とガイドライン

## 1. 設計原則

idp-server の中心的な設計理念は、**OIDC の世界観を尊重すること** です。

### 1.1 プロトコルの妥当性

* 相互運用性と明確性を確保するため、OAuth 2.0 および OIDC 仕様に厳密に準拠する
* 標準からの逸脱は厳格に禁止する（拡張機能はカプセル化する必要がある）

### 1.2 拡張性と互換性のバランス

* CIBA、FAPI、OID4IDA などの拡張仕様の柔軟な実装をサポートする
* 拡張機能は標準フローにシームレスに統合する必要がある

### 1.3 抽象化による実装の自由度

* 認証方式とデータ保存メカニズムは実装依存である
* OIDCの仕様でカバーされていない部分（認証、永続化、通知など）は、プラグイン可能な設計となっている

---

## 2. 設計ガイドライン

### 2.1 クラスと責務の設計

* **コントローラ**: リクエスト/レスポンスのフォーマットのみを処理する
* **ユースケース**: ユースケースごとのコアビジネスロジックを含むDTO に依存
* **リポジトリ**: データアクセスを抽象化し、DB や外部サービスから分離

### 2.2 モジュール構造

* コア、ユースケース、アダプタ、Springboot アダプタを明確に分離
* プロトコル層 (OAuth、OIDC) とドメイン層を区別

### 2.3 命名と型設計

* 仕様に基づいた意味のある名前を使用する (例: IdToken、Grant、Subject)
* 意味のある型で値のセマンティクスを表す (例: ClientId、AcrValue)

### 2.4 拡張ポイント

* AuthenticationInteractor や FederationInteractor などのコンポーネントを使用してフローの分岐を分離
* 生の `Map<String, Object>` や JSON の使用は避ける強く型付けされた拡張モデルを優先する

### 2.5 テスト戦略

* ユースケースの単体テストと、REST API 経由の E2E テストを組み合わせる
* プロトコル準拠を確保するための適合性テストを自動化する

---

## 4. まとめ

idp-server は、OIDC 標準に忠実でありながら、拡張性と実装の柔軟性を確保することで、持続可能で秩序あるオープンソースプロジェクトとして成長することを目指しています。