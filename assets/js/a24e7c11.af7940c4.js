"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[34203],{16142:(n,e,t)=>{t.r(e),t.d(e,{assets:()=>r,contentTitle:()=>l,default:()=>o,frontMatter:()=>i,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"content_11_learning/postgresql/dba-05-monitoring","title":"PostgreSQL \u76e3\u8996\u30ac\u30a4\u30c9","description":"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001PostgreSQL\u306e\u76e3\u8996\u65b9\u6cd5\u3068\u30a2\u30e9\u30fc\u30c8\u8a2d\u8a08\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002","source":"@site/docs/content_11_learning/11-postgresql/dba-05-monitoring.md","sourceDirName":"content_11_learning/11-postgresql","slug":"/content_11_learning/postgresql/dba-05-monitoring","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-05-monitoring","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_11_learning/11-postgresql/dba-05-monitoring.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"PostgreSQL \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-04-security"},"next":{"title":"PostgreSQL \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-06-maintenance"}}');var a=t(74848),_=t(28453);const i={},l="PostgreSQL \u76e3\u8996\u30ac\u30a4\u30c9",r={},c=[{value:"\u76ee\u6b21",id:"\u76ee\u6b21",level:2},{value:"1. \u76e3\u8996\u306e\u6982\u8981",id:"1-\u76e3\u8996\u306e\u6982\u8981",level:2},{value:"1.1 \u76e3\u8996\u306e\u76ee\u7684",id:"11-\u76e3\u8996\u306e\u76ee\u7684",level:3},{value:"1.2 \u76e3\u8996\u306e\u8a2d\u5b9a",id:"12-\u76e3\u8996\u306e\u8a2d\u5b9a",level:3},{value:"2. \u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc (pg_stat_*)",id:"2-\u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc-pg_stat_",level:2},{value:"2.1 \u4e3b\u8981\u306a\u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc",id:"21-\u4e3b\u8981\u306a\u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc",level:3},{value:"2.2 pg_stat_activity",id:"22-pg_stat_activity",level:3},{value:"2.3 pg_stat_database",id:"23-pg_stat_database",level:3},{value:"2.4 pg_stat_user_tables",id:"24-pg_stat_user_tables",level:3},{value:"2.5 pg_stat_user_indexes",id:"25-pg_stat_user_indexes",level:3},{value:"2.6 pg_statio_user_tables",id:"26-pg_statio_user_tables",level:3},{value:"3. \u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u76e3\u8996",id:"3-\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u76e3\u8996",level:2},{value:"3.1 \u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387",id:"31-\u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387",level:3},{value:"3.2 \u30ed\u30c3\u30af\u76e3\u8996",id:"32-\u30ed\u30c3\u30af\u76e3\u8996",level:3},{value:"3.3 \u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u76e3\u8996",id:"33-\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u76e3\u8996",level:3},{value:"3.4 WAL\u7d71\u8a08",id:"34-wal\u7d71\u8a08",level:3},{value:"4. \u30ea\u30bd\u30fc\u30b9\u76e3\u8996",id:"4-\u30ea\u30bd\u30fc\u30b9\u76e3\u8996",level:2},{value:"4.1 \u63a5\u7d9a\u6570\u76e3\u8996",id:"41-\u63a5\u7d9a\u6570\u76e3\u8996",level:3},{value:"4.2 \u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u91cf\u76e3\u8996",id:"42-\u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u91cf\u76e3\u8996",level:3},{value:"4.3 \u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u76e3\u8996",id:"43-\u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u76e3\u8996",level:3},{value:"4.4 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u76e3\u8996",id:"44-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u76e3\u8996",level:3},{value:"5. pg_stat_statements",id:"5-pg_stat_statements",level:2},{value:"5.1 \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7",id:"51-\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7",level:3},{value:"5.2 \u30b9\u30ed\u30fc\u30af\u30a8\u30ea\u306e\u5206\u6790",id:"52-\u30b9\u30ed\u30fc\u30af\u30a8\u30ea\u306e\u5206\u6790",level:3},{value:"5.3 I/O\u96c6\u7d04\u7684\u306a\u30af\u30a8\u30ea",id:"53-io\u96c6\u7d04\u7684\u306a\u30af\u30a8\u30ea",level:3},{value:"5.4 \u7d71\u8a08\u60c5\u5831\u306e\u30ea\u30bb\u30c3\u30c8",id:"54-\u7d71\u8a08\u60c5\u5831\u306e\u30ea\u30bb\u30c3\u30c8",level:3},{value:"6. \u30a2\u30e9\u30fc\u30c8\u8a2d\u8a08",id:"6-\u30a2\u30e9\u30fc\u30c8\u8a2d\u8a08",level:2},{value:"6.1 \u30a2\u30e9\u30fc\u30c8\u306e\u512a\u5148\u5ea6",id:"61-\u30a2\u30e9\u30fc\u30c8\u306e\u512a\u5148\u5ea6",level:3},{value:"6.2 \u76e3\u8996\u30af\u30a8\u30ea\u96c6",id:"62-\u76e3\u8996\u30af\u30a8\u30ea\u96c6",level:3},{value:"6.3 \u30a2\u30e9\u30fc\u30c8\u8a2d\u5b9a\u4f8b (Prometheus\u5f62\u5f0f)",id:"63-\u30a2\u30e9\u30fc\u30c8\u8a2d\u5b9a\u4f8b-prometheus\u5f62\u5f0f",level:3},{value:"7. \u76e3\u8996\u30c4\u30fc\u30eb\u3068\u306e\u9023\u643a",id:"7-\u76e3\u8996\u30c4\u30fc\u30eb\u3068\u306e\u9023\u643a",level:2},{value:"7.1 postgres_exporter (Prometheus)",id:"71-postgres_exporter-prometheus",level:3},{value:"7.2 \u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9",id:"72-\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9",level:3},{value:"7.3 Grafana\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9",id:"73-grafana\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9",level:3},{value:"7.4 \u76e3\u8996\u30b9\u30af\u30ea\u30d7\u30c8\u4f8b",id:"74-\u76e3\u8996\u30b9\u30af\u30ea\u30d7\u30c8\u4f8b",level:3},{value:"\u53c2\u8003\u30ea\u30f3\u30af",id:"\u53c2\u8003\u30ea\u30f3\u30af",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,_.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"postgresql-\u76e3\u8996\u30ac\u30a4\u30c9",children:"PostgreSQL \u76e3\u8996\u30ac\u30a4\u30c9"})}),"\n",(0,a.jsx)(e.p,{children:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001PostgreSQL\u306e\u76e3\u8996\u65b9\u6cd5\u3068\u30a2\u30e9\u30fc\u30c8\u8a2d\u8a08\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002"}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"\u76ee\u6b21",children:"\u76ee\u6b21"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#1-%E7%9B%A3%E8%A6%96%E3%81%AE%E6%A6%82%E8%A6%81",children:"\u76e3\u8996\u306e\u6982\u8981"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#2-%E7%B5%B1%E8%A8%88%E6%83%85%E5%A0%B1%E3%83%93%E3%83%A5%E3%83%BC-pg_stat_",children:"\u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc (pg_stat_*)"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#3-%E3%83%91%E3%83%95%E3%82%A9%E3%83%BC%E3%83%9E%E3%83%B3%E3%82%B9%E7%9B%A3%E8%A6%96",children:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u76e3\u8996"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#4-%E3%83%AA%E3%82%BD%E3%83%BC%E3%82%B9%E7%9B%A3%E8%A6%96",children:"\u30ea\u30bd\u30fc\u30b9\u76e3\u8996"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#5-pg_stat_statements",children:"pg_stat_statements"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#6-%E3%82%A2%E3%83%A9%E3%83%BC%E3%83%88%E8%A8%AD%E8%A8%88",children:"\u30a2\u30e9\u30fc\u30c8\u8a2d\u8a08"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#7-%E7%9B%A3%E8%A6%96%E3%83%84%E3%83%BC%E3%83%AB%E3%81%A8%E3%81%AE%E9%80%A3%E6%90%BA",children:"\u76e3\u8996\u30c4\u30fc\u30eb\u3068\u306e\u9023\u643a"})}),"\n"]}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"1-\u76e3\u8996\u306e\u6982\u8981",children:"1. \u76e3\u8996\u306e\u6982\u8981"}),"\n",(0,a.jsx)(e.h3,{id:"11-\u76e3\u8996\u306e\u76ee\u7684",children:"1.1 \u76e3\u8996\u306e\u76ee\u7684"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                       \u76e3\u8996\u306e\u76ee\u7684                              \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u53ef\u7528\u6027\u76e3\u8996\u3011                                              \u2502\n\u2502  - PostgreSQL\u30d7\u30ed\u30bb\u30b9\u304c\u7a3c\u50cd\u3057\u3066\u3044\u308b\u304b                        \u2502\n\u2502  - \u63a5\u7d9a\u3092\u53d7\u3051\u4ed8\u3051\u3066\u3044\u308b\u304b                                    \u2502\n\u2502  - \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u6b63\u5e38\u304b                                  \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u76e3\u8996\u3011                                      \u2502\n\u2502  - \u30af\u30a8\u30ea\u306e\u5fdc\u7b54\u6642\u9593                                          \u2502\n\u2502  - \u30b9\u30ed\u30fc\u30af\u30a8\u30ea\u306e\u767a\u751f                                        \u2502\n\u2502  - \u30ed\u30c3\u30af\u7af6\u5408                                                \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30ea\u30bd\u30fc\u30b9\u76e3\u8996\u3011                                            \u2502\n\u2502  - \u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u91cf                                            \u2502\n\u2502  - \u63a5\u7d9a\u6570                                                    \u2502\n\u2502  - \u30e1\u30e2\u30ea\u4f7f\u7528\u72b6\u6cc1                                            \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30ad\u30e3\u30d1\u30b7\u30c6\u30a3\u30d7\u30e9\u30f3\u30cb\u30f3\u30b0\u3011                                \u2502\n\u2502  - \u30c7\u30fc\u30bf\u5897\u52a0\u50be\u5411                                            \u2502\n\u2502  - \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u6570\u306e\u63a8\u79fb                                  \u2502\n\u2502  - \u30ea\u30bd\u30fc\u30b9\u4f7f\u7528\u7387\u306e\u30c8\u30ec\u30f3\u30c9                                  \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"12-\u76e3\u8996\u306e\u8a2d\u5b9a",children:"1.2 \u76e3\u8996\u306e\u8a2d\u5b9a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf\n\n# \u7d71\u8a08\u60c5\u5831\u53ce\u96c6\u3092\u6709\u52b9\u5316\ntrack_activities = on           # pg_stat_activity\ntrack_counts = on               # pg_stat_*_tables, pg_stat_*_indexes\ntrack_io_timing = on            # I/O\u6642\u9593\u8a08\u6e2c (\u82e5\u5e72\u306e\u30aa\u30fc\u30d0\u30fc\u30d8\u30c3\u30c9)\ntrack_wal_io_timing = on        # WAL I/O\u6642\u9593\u8a08\u6e2c\ntrack_functions = all           # \u95a2\u6570\u306e\u7d71\u8a08 (none, pl, all)\n\n# \u7d71\u8a08\u60c5\u5831\u306e\u66f4\u65b0\u983b\u5ea6\nstats_fetch_consistency = cache # none, cache, snapshot\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"2-\u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc-pg_stat_",children:"2. \u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc (pg_stat_*)"}),"\n",(0,a.jsx)(e.h3,{id:"21-\u4e3b\u8981\u306a\u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc",children:"2.1 \u4e3b\u8981\u306a\u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    \u4e3b\u8981\u306a\u7d71\u8a08\u60c5\u5831\u30d3\u30e5\u30fc                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u30a2\u30af\u30c6\u30a3\u30d3\u30c6\u30a3\u3011                                          \u2502\n\u2502  pg_stat_activity      : \u73fe\u5728\u306e\u63a5\u7d9a\u3068\u30af\u30a8\u30ea                  \u2502\n\u2502  pg_stat_progress_*    : \u9577\u6642\u9593\u64cd\u4f5c\u306e\u9032\u6357                    \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3011                                            \u2502\n\u2502  pg_stat_database      : \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5168\u4f53\u306e\u7d71\u8a08              \u2502\n\u2502  pg_stat_database_conflicts : \u30b9\u30bf\u30f3\u30d0\u30a4\u3067\u306e\u7af6\u5408             \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30c6\u30fc\u30d6\u30eb/\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3011                                   \u2502\n\u2502  pg_stat_user_tables   : \u30c6\u30fc\u30d6\u30eb\u306e\u7d71\u8a08                      \u2502\n\u2502  pg_stat_user_indexes  : \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u7d71\u8a08                  \u2502\n\u2502  pg_statio_user_tables : \u30c6\u30fc\u30d6\u30eb\u306eI/O\u7d71\u8a08                   \u2502\n\u2502  pg_statio_user_indexes: \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306eI/O\u7d71\u8a08               \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u30d7\u30ed\u30bb\u30b9\u3011                                \u2502\n\u2502  pg_stat_bgwriter      : \u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u30e9\u30a4\u30bf\u30fc            \u2502\n\u2502  pg_stat_wal           : WAL\u7d71\u8a08                             \u2502\n\u2502  pg_stat_archiver      : \u30a2\u30fc\u30ab\u30a4\u30d0                          \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3011                                        \u2502\n\u2502  pg_stat_replication   : \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b                \u2502\n\u2502  pg_stat_wal_receiver  : WAL\u30ec\u30b7\u30fc\u30d0\u30fc (\u30b9\u30bf\u30f3\u30d0\u30a4)          \u2502\n\u2502  pg_replication_slots  : \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8            \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"22-pg_stat_activity",children:"2.2 pg_stat_activity"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u73fe\u5728\u306e\u30a2\u30af\u30c6\u30a3\u30d6\u30bb\u30c3\u30b7\u30e7\u30f3\nSELECT\n    pid,\n    usename,\n    datname,\n    client_addr,\n    state,\n    wait_event_type,\n    wait_event,\n    query_start,\n    now() - query_start AS query_duration,\n    LEFT(query, 100) AS query\nFROM pg_stat_activity\nWHERE state != 'idle'\nORDER BY query_start;\n\n-- \u72b6\u614b\u5225\u306e\u63a5\u7d9a\u6570\nSELECT\n    state,\n    count(*) AS count\nFROM pg_stat_activity\nGROUP BY state;\n\n-- \u9577\u6642\u9593\u5b9f\u884c\u4e2d\u306e\u30af\u30a8\u30ea\nSELECT\n    pid,\n    usename,\n    datname,\n    now() - query_start AS duration,\n    state,\n    query\nFROM pg_stat_activity\nWHERE state = 'active'\n  AND now() - query_start > interval '1 minute'\nORDER BY query_start;\n\n-- \u30ed\u30c3\u30af\u5f85\u3061\u306e\u30bb\u30c3\u30b7\u30e7\u30f3\nSELECT\n    pid,\n    usename,\n    wait_event_type,\n    wait_event,\n    query\nFROM pg_stat_activity\nWHERE wait_event_type = 'Lock';\n"})}),"\n",(0,a.jsx)(e.h3,{id:"23-pg_stat_database",children:"2.3 pg_stat_database"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u7d71\u8a08\nSELECT\n    datname,\n    numbackends AS connections,\n    xact_commit AS commits,\n    xact_rollback AS rollbacks,\n    blks_read,\n    blks_hit,\n    ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) AS cache_hit_ratio,\n    tup_returned,\n    tup_fetched,\n    tup_inserted,\n    tup_updated,\n    tup_deleted,\n    conflicts,\n    deadlocks,\n    temp_files,\n    pg_size_pretty(temp_bytes) AS temp_bytes,\n    stats_reset\nFROM pg_stat_database\nWHERE datname NOT LIKE 'template%';\n\n-- \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u6570 (\u30b3\u30df\u30c3\u30c8 + \u30ed\u30fc\u30eb\u30d0\u30c3\u30af)\nSELECT\n    datname,\n    xact_commit + xact_rollback AS total_transactions,\n    xact_commit,\n    xact_rollback,\n    ROUND(100.0 * xact_rollback / NULLIF(xact_commit + xact_rollback, 0), 2) AS rollback_ratio\nFROM pg_stat_database\nWHERE datname = current_database();\n"})}),"\n",(0,a.jsx)(e.h3,{id:"24-pg_stat_user_tables",children:"2.4 pg_stat_user_tables"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30c6\u30fc\u30d6\u30eb\u7d71\u8a08\nSELECT\n    schemaname,\n    relname,\n    seq_scan,\n    seq_tup_read,\n    idx_scan,\n    idx_tup_fetch,\n    n_tup_ins,\n    n_tup_upd,\n    n_tup_del,\n    n_live_tup,\n    n_dead_tup,\n    ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_tuple_ratio,\n    last_vacuum,\n    last_autovacuum,\n    last_analyze,\n    last_autoanalyze\nFROM pg_stat_user_tables\nORDER BY n_dead_tup DESC\nLIMIT 20;\n\n-- \u30b7\u30fc\u30b1\u30f3\u30b7\u30e3\u30eb\u30b9\u30ad\u30e3\u30f3\u304c\u591a\u3044\u30c6\u30fc\u30d6\u30eb (\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u8ffd\u52a0\u306e\u5019\u88dc)\nSELECT\n    schemaname,\n    relname,\n    seq_scan,\n    idx_scan,\n    CASE WHEN idx_scan > 0 THEN\n        ROUND(seq_scan::numeric / idx_scan, 2)\n    ELSE\n        seq_scan\n    END AS seq_to_idx_ratio,\n    pg_size_pretty(pg_relation_size(schemaname || '.' || relname)) AS size\nFROM pg_stat_user_tables\nWHERE seq_scan > 100\nORDER BY seq_scan DESC\nLIMIT 20;\n\n-- \u6700\u8fd1VACUUM\u3055\u308c\u3066\u3044\u306a\u3044\u30c6\u30fc\u30d6\u30eb\nSELECT\n    schemaname,\n    relname,\n    n_dead_tup,\n    last_vacuum,\n    last_autovacuum,\n    GREATEST(last_vacuum, last_autovacuum) AS last_vacuumed\nFROM pg_stat_user_tables\nWHERE n_dead_tup > 1000\nORDER BY GREATEST(last_vacuum, last_autovacuum) NULLS FIRST\nLIMIT 20;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"25-pg_stat_user_indexes",children:"2.5 pg_stat_user_indexes"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u7d71\u8a08\nSELECT\n    schemaname,\n    relname,\n    indexrelname,\n    idx_scan,\n    idx_tup_read,\n    idx_tup_fetch,\n    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size\nFROM pg_stat_user_indexes\nORDER BY idx_scan DESC\nLIMIT 20;\n\n-- \u4f7f\u7528\u3055\u308c\u3066\u3044\u306a\u3044\u30a4\u30f3\u30c7\u30c3\u30af\u30b9 (\u524a\u9664\u5019\u88dc)\nSELECT\n    schemaname,\n    relname,\n    indexrelname,\n    idx_scan,\n    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size\nFROM pg_stat_user_indexes\nWHERE idx_scan = 0\n  AND indexrelname NOT LIKE '%_pkey'  -- \u4e3b\u30ad\u30fc\u306f\u9664\u5916\nORDER BY pg_relation_size(indexrelid) DESC;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"26-pg_statio_user_tables",children:"2.6 pg_statio_user_tables"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30c6\u30fc\u30d6\u30eb\u306eI/O\u7d71\u8a08\nSELECT\n    schemaname,\n    relname,\n    heap_blks_read,\n    heap_blks_hit,\n    ROUND(100.0 * heap_blks_hit / NULLIF(heap_blks_hit + heap_blks_read, 0), 2) AS heap_hit_ratio,\n    idx_blks_read,\n    idx_blks_hit,\n    ROUND(100.0 * idx_blks_hit / NULLIF(idx_blks_hit + idx_blks_read, 0), 2) AS idx_hit_ratio,\n    toast_blks_read,\n    toast_blks_hit\nFROM pg_statio_user_tables\nORDER BY heap_blks_read DESC\nLIMIT 20;\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"3-\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u76e3\u8996",children:"3. \u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u76e3\u8996"}),"\n",(0,a.jsx)(e.h3,{id:"31-\u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387",children:"3.1 \u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5168\u4f53\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387\nSELECT\n    datname,\n    blks_read,\n    blks_hit,\n    ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) AS cache_hit_ratio\nFROM pg_stat_database\nWHERE datname = current_database();\n\n-- \u76ee\u5b89:\n-- 99% \u4ee5\u4e0a: \u826f\u597d\n-- 95-99%: \u8a31\u5bb9\u7bc4\u56f2\n-- 95% \u672a\u6e80: shared_buffers \u306e\u5897\u52a0\u3092\u691c\u8a0e\n\n-- \u30c6\u30fc\u30d6\u30eb\u5225\u306e\u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387\nSELECT\n    schemaname,\n    relname,\n    heap_blks_read + idx_blks_read AS total_reads,\n    heap_blks_hit + idx_blks_hit AS total_hits,\n    ROUND(100.0 * (heap_blks_hit + idx_blks_hit) /\n        NULLIF(heap_blks_hit + idx_blks_hit + heap_blks_read + idx_blks_read, 0), 2) AS hit_ratio\nFROM pg_statio_user_tables\nWHERE heap_blks_read + idx_blks_read > 0\nORDER BY total_reads DESC\nLIMIT 20;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"32-\u30ed\u30c3\u30af\u76e3\u8996",children:"3.2 \u30ed\u30c3\u30af\u76e3\u8996"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u73fe\u5728\u306e\u30ed\u30c3\u30af\u72b6\u6cc1\nSELECT\n    pg_locks.pid,\n    pg_stat_activity.usename,\n    pg_locks.locktype,\n    pg_locks.mode,\n    pg_locks.granted,\n    pg_class.relname,\n    pg_stat_activity.query\nFROM pg_locks\nLEFT JOIN pg_class ON pg_locks.relation = pg_class.oid\nLEFT JOIN pg_stat_activity ON pg_locks.pid = pg_stat_activity.pid\nWHERE NOT pg_locks.granted\nORDER BY pg_locks.pid;\n\n-- \u30ed\u30c3\u30af\u306e\u7af6\u5408 (\u8ab0\u304c\u8ab0\u3092\u5f85\u305f\u305b\u3066\u3044\u308b\u304b)\nSELECT\n    blocked.pid AS blocked_pid,\n    blocked.usename AS blocked_user,\n    blocking.pid AS blocking_pid,\n    blocking.usename AS blocking_user,\n    blocked.query AS blocked_query,\n    blocking.query AS blocking_query,\n    blocked.wait_event\nFROM pg_stat_activity AS blocked\nJOIN pg_stat_activity AS blocking\n    ON blocking.pid = ANY(pg_blocking_pids(blocked.pid))\nWHERE blocked.wait_event_type = 'Lock';\n\n-- \u30c7\u30c3\u30c9\u30ed\u30c3\u30af\u6570\nSELECT deadlocks FROM pg_stat_database WHERE datname = current_database();\n"})}),"\n",(0,a.jsx)(e.h3,{id:"33-\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u76e3\u8996",children:"3.3 \u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u76e3\u8996"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u7d71\u8a08\nSELECT\n    checkpoints_timed,      -- \u6642\u9593\u7d4c\u904e\u306b\u3088\u308b\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\n    checkpoints_req,        -- \u8981\u6c42\u306b\u3088\u308b\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8 (WAL\u6e80\u676f\u306a\u3069)\n    checkpoint_write_time,  -- \u66f8\u304d\u8fbc\u307f\u6642\u9593 (ms)\n    checkpoint_sync_time,   -- \u540c\u671f\u6642\u9593 (ms)\n    buffers_checkpoint,     -- \u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u3067\u66f8\u304d\u8fbc\u307e\u308c\u305f\u30d0\u30c3\u30d5\u30a1\n    buffers_clean,          -- \u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u30e9\u30a4\u30bf\u30fc\u3067\u66f8\u304d\u8fbc\u307e\u308c\u305f\u30d0\u30c3\u30d5\u30a1\n    buffers_backend,        -- \u30d0\u30c3\u30af\u30a8\u30f3\u30c9\u3067\u76f4\u63a5\u66f8\u304d\u8fbc\u307e\u308c\u305f\u30d0\u30c3\u30d5\u30a1\n    buffers_alloc,          -- \u5272\u308a\u5f53\u3066\u3089\u308c\u305f\u30d0\u30c3\u30d5\u30a1\n    stats_reset\nFROM pg_stat_bgwriter;\n\n-- buffers_backend \u304c\u591a\u3044\u5834\u5408:\n-- \u2192 shared_buffers \u304c\u4e0d\u8db3\u3057\u3066\u3044\u308b\u53ef\u80fd\u6027\n-- \u2192 checkpoint_completion_target \u3092\u8abf\u6574\n"})}),"\n",(0,a.jsx)(e.h3,{id:"34-wal\u7d71\u8a08",children:"3.4 WAL\u7d71\u8a08"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- WAL\u7d71\u8a08 (PostgreSQL 14+)\nSELECT\n    wal_records,\n    wal_fpi,            -- \u30d5\u30eb\u30da\u30fc\u30b8\u30a4\u30e1\u30fc\u30b8\u6570\n    wal_bytes,\n    pg_size_pretty(wal_bytes) AS wal_size,\n    wal_buffers_full,\n    wal_write,\n    wal_sync,\n    wal_write_time,     -- \u66f8\u304d\u8fbc\u307f\u6642\u9593 (ms)\n    wal_sync_time,      -- \u540c\u671f\u6642\u9593 (ms)\n    stats_reset\nFROM pg_stat_wal;\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"4-\u30ea\u30bd\u30fc\u30b9\u76e3\u8996",children:"4. \u30ea\u30bd\u30fc\u30b9\u76e3\u8996"}),"\n",(0,a.jsx)(e.h3,{id:"41-\u63a5\u7d9a\u6570\u76e3\u8996",children:"4.1 \u63a5\u7d9a\u6570\u76e3\u8996"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u73fe\u5728\u306e\u63a5\u7d9a\u6570\nSELECT count(*) AS total_connections FROM pg_stat_activity;\n\n-- \u6700\u5927\u63a5\u7d9a\u6570\nSHOW max_connections;\n\n-- \u63a5\u7d9a\u6570\u306e\u5272\u5408\nSELECT\n    count(*) AS current_connections,\n    current_setting('max_connections')::int AS max_connections,\n    ROUND(100.0 * count(*) / current_setting('max_connections')::int, 2) AS usage_percent\nFROM pg_stat_activity;\n\n-- \u30e6\u30fc\u30b6\u30fc\u5225\u63a5\u7d9a\u6570\nSELECT\n    usename,\n    count(*) AS connections\nFROM pg_stat_activity\nGROUP BY usename\nORDER BY connections DESC;\n\n-- \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5225\u63a5\u7d9a\u6570\nSELECT\n    datname,\n    count(*) AS connections\nFROM pg_stat_activity\nGROUP BY datname\nORDER BY connections DESC;\n\n-- \u30af\u30e9\u30a4\u30a2\u30f3\u30c8IP\u5225\u63a5\u7d9a\u6570\nSELECT\n    client_addr,\n    count(*) AS connections\nFROM pg_stat_activity\nWHERE client_addr IS NOT NULL\nGROUP BY client_addr\nORDER BY connections DESC;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"42-\u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u91cf\u76e3\u8996",children:"4.2 \u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u91cf\u76e3\u8996"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30b5\u30a4\u30ba\nSELECT\n    datname,\n    pg_size_pretty(pg_database_size(datname)) AS size\nFROM pg_database\nORDER BY pg_database_size(datname) DESC;\n\n-- \u30c6\u30fc\u30d6\u30eb\u30b5\u30a4\u30ba (TOP 20)\nSELECT\n    schemaname,\n    relname,\n    pg_size_pretty(pg_total_relation_size(schemaname || '.' || relname)) AS total_size,\n    pg_size_pretty(pg_relation_size(schemaname || '.' || relname)) AS table_size,\n    pg_size_pretty(pg_indexes_size(schemaname || '.' || relname)) AS indexes_size\nFROM pg_stat_user_tables\nORDER BY pg_total_relation_size(schemaname || '.' || relname) DESC\nLIMIT 20;\n\n-- \u30c6\u30fc\u30d6\u30eb\u30b9\u30da\u30fc\u30b9\u4f7f\u7528\u91cf\nSELECT\n    spcname,\n    pg_size_pretty(pg_tablespace_size(spcname)) AS size\nFROM pg_tablespace;\n\n-- WAL\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u30b5\u30a4\u30ba\nSELECT pg_size_pretty(sum(size)) AS wal_size\nFROM pg_ls_waldir();\n"})}),"\n",(0,a.jsx)(e.h3,{id:"43-\u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u76e3\u8996",children:"4.3 \u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u76e3\u8996"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u80a5\u5927\u5316\u3057\u305f\u30c6\u30fc\u30d6\u30eb\u306e\u691c\u51fa (pgstattuple\u62e1\u5f35\u304c\u5fc5\u8981)\nCREATE EXTENSION IF NOT EXISTS pgstattuple;\n\nSELECT\n    schemaname || '.' || relname AS table_name,\n    pg_size_pretty(pg_relation_size(schemaname || '.' || relname)) AS size,\n    n_live_tup,\n    n_dead_tup,\n    ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_tuple_percent\nFROM pg_stat_user_tables\nWHERE n_dead_tup > 10000\nORDER BY n_dead_tup DESC;\n\n-- \u8a73\u7d30\u306a\u80a5\u5927\u5316\u60c5\u5831 (\u5927\u304d\u306a\u30c6\u30fc\u30d6\u30eb\u3067\u306f\u6642\u9593\u304c\u304b\u304b\u308b)\nSELECT * FROM pgstattuple('your_table_name');\n"})}),"\n",(0,a.jsx)(e.h3,{id:"44-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u76e3\u8996",children:"4.4 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u76e3\u8996"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b (\u30d7\u30e9\u30a4\u30de\u30ea\u3067\u5b9f\u884c)\nSELECT\n    client_addr,\n    state,\n    sent_lsn,\n    write_lsn,\n    flush_lsn,\n    replay_lsn,\n    pg_wal_lsn_diff(sent_lsn, replay_lsn) AS replay_lag_bytes,\n    pg_size_pretty(pg_wal_lsn_diff(sent_lsn, replay_lsn)) AS replay_lag,\n    sync_state,\n    reply_time\nFROM pg_stat_replication;\n\n-- \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\nSELECT\n    slot_name,\n    slot_type,\n    active,\n    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS retained_wal\nFROM pg_replication_slots;\n\n-- WAL\u30ec\u30b7\u30fc\u30d0\u30fc\u72b6\u614b (\u30b9\u30bf\u30f3\u30d0\u30a4\u3067\u5b9f\u884c)\nSELECT\n    status,\n    received_lsn,\n    latest_end_lsn,\n    last_msg_send_time,\n    last_msg_receipt_time,\n    conninfo\nFROM pg_stat_wal_receiver;\n\n-- \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e9\u30b0 (\u79d2\u3001\u30b9\u30bf\u30f3\u30d0\u30a4\u3067\u5b9f\u884c)\nSELECT\n    CASE\n        WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0\n        ELSE EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()))\n    END AS lag_seconds;\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"5-pg_stat_statements",children:"5. pg_stat_statements"}),"\n",(0,a.jsx)(e.h3,{id:"51-\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7",children:"5.1 \u30bb\u30c3\u30c8\u30a2\u30c3\u30d7"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf\nshared_preload_libraries = 'pg_stat_statements'\n\npg_stat_statements.max = 10000\npg_stat_statements.track = all\npg_stat_statements.track_utility = on\npg_stat_statements.track_planning = on\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u62e1\u5f35\u306e\u4f5c\u6210\nCREATE EXTENSION pg_stat_statements;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"52-\u30b9\u30ed\u30fc\u30af\u30a8\u30ea\u306e\u5206\u6790",children:"5.2 \u30b9\u30ed\u30fc\u30af\u30a8\u30ea\u306e\u5206\u6790"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u7dcf\u5b9f\u884c\u6642\u9593\u304c\u9577\u3044\u30af\u30a8\u30ea TOP 20\nSELECT\n    queryid,\n    calls,\n    ROUND(total_exec_time::numeric, 2) AS total_time_ms,\n    ROUND(mean_exec_time::numeric, 2) AS mean_time_ms,\n    ROUND(stddev_exec_time::numeric, 2) AS stddev_time_ms,\n    rows,\n    ROUND(100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0), 2) AS hit_ratio,\n    LEFT(query, 100) AS query\nFROM pg_stat_statements\nORDER BY total_exec_time DESC\nLIMIT 20;\n\n-- \u5e73\u5747\u5b9f\u884c\u6642\u9593\u304c\u9577\u3044\u30af\u30a8\u30ea TOP 20\nSELECT\n    queryid,\n    calls,\n    ROUND(mean_exec_time::numeric, 2) AS mean_time_ms,\n    ROUND(max_exec_time::numeric, 2) AS max_time_ms,\n    rows / NULLIF(calls, 0) AS avg_rows,\n    LEFT(query, 100) AS query\nFROM pg_stat_statements\nWHERE calls > 100  -- \u3042\u308b\u7a0b\u5ea6\u547c\u3070\u308c\u3066\u3044\u308b\u30af\u30a8\u30ea\nORDER BY mean_exec_time DESC\nLIMIT 20;\n\n-- \u547c\u3073\u51fa\u3057\u56de\u6570\u304c\u591a\u3044\u30af\u30a8\u30ea TOP 20\nSELECT\n    queryid,\n    calls,\n    ROUND(total_exec_time::numeric, 2) AS total_time_ms,\n    ROUND(mean_exec_time::numeric, 2) AS mean_time_ms,\n    LEFT(query, 100) AS query\nFROM pg_stat_statements\nORDER BY calls DESC\nLIMIT 20;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"53-io\u96c6\u7d04\u7684\u306a\u30af\u30a8\u30ea",children:"5.3 I/O\u96c6\u7d04\u7684\u306a\u30af\u30a8\u30ea"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- I/O\u304c\u591a\u3044\u30af\u30a8\u30ea\nSELECT\n    queryid,\n    calls,\n    shared_blks_read,\n    shared_blks_hit,\n    shared_blks_dirtied,\n    shared_blks_written,\n    ROUND(100.0 * shared_blks_hit / NULLIF(shared_blks_hit + shared_blks_read, 0), 2) AS hit_ratio,\n    LEFT(query, 100) AS query\nFROM pg_stat_statements\nWHERE shared_blks_read > 1000\nORDER BY shared_blks_read DESC\nLIMIT 20;\n\n-- \u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u3092\u4f7f\u7528\u3057\u3066\u3044\u308b\u30af\u30a8\u30ea\nSELECT\n    queryid,\n    calls,\n    temp_blks_read,\n    temp_blks_written,\n    LEFT(query, 100) AS query\nFROM pg_stat_statements\nWHERE temp_blks_written > 0\nORDER BY temp_blks_written DESC\nLIMIT 20;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"54-\u7d71\u8a08\u60c5\u5831\u306e\u30ea\u30bb\u30c3\u30c8",children:"5.4 \u7d71\u8a08\u60c5\u5831\u306e\u30ea\u30bb\u30c3\u30c8"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u5168\u7d71\u8a08\u3092\u30ea\u30bb\u30c3\u30c8\nSELECT pg_stat_statements_reset();\n\n-- \u7279\u5b9a\u306e\u30af\u30a8\u30ea\u306e\u7d71\u8a08\u3092\u30ea\u30bb\u30c3\u30c8 (PostgreSQL 14+)\nSELECT pg_stat_statements_reset(userid, dbid, queryid);\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"6-\u30a2\u30e9\u30fc\u30c8\u8a2d\u8a08",children:"6. \u30a2\u30e9\u30fc\u30c8\u8a2d\u8a08"}),"\n",(0,a.jsx)(e.h3,{id:"61-\u30a2\u30e9\u30fc\u30c8\u306e\u512a\u5148\u5ea6",children:"6.1 \u30a2\u30e9\u30fc\u30c8\u306e\u512a\u5148\u5ea6"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    \u30a2\u30e9\u30fc\u30c8\u512a\u5148\u5ea6\u306e\u8a2d\u8a08                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010Critical - \u5373\u6642\u5bfe\u5fdc\u5fc5\u8981\u3011                                 \u2502\n\u2502  - PostgreSQL\u30c0\u30a6\u30f3                                          \u2502\n\u2502  - \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u505c\u6b62                                      \u2502\n\u2502  - \u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u7387 > 95%                                      \u2502\n\u2502  - \u63a5\u7d9a\u6570 > \u6700\u5927\u63a5\u7d9a\u6570\u306e95%                                  \u2502\n\u2502  - \u30c7\u30c3\u30c9\u30ed\u30c3\u30af\u767a\u751f                                          \u2502\n\u2502                                                              \u2502\n\u2502  \u3010Warning - \u6570\u6642\u9593\u4ee5\u5185\u306b\u5bfe\u5fdc\u3011                              \u2502\n\u2502  - \u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u7387 > 80%                                      \u2502\n\u2502  - \u63a5\u7d9a\u6570 > \u6700\u5927\u63a5\u7d9a\u6570\u306e80%                                  \u2502\n\u2502  - \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e9\u30b0 > 30\u79d2                               \u2502\n\u2502  - \u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387 < 95%                                  \u2502\n\u2502  - \u9577\u6642\u9593\u30af\u30a8\u30ea > 10\u5206                                       \u2502\n\u2502  - Autovacuum \u304c24\u6642\u9593\u4ee5\u4e0a\u672a\u5b9f\u884c                             \u2502\n\u2502                                                              \u2502\n\u2502  \u3010Info - \u5b9a\u671f\u78ba\u8a8d\u3011                                         \u2502\n\u2502  - \u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u7387 > 70%                                      \u2502\n\u2502  - \u63a5\u7d9a\u6570 > \u6700\u5927\u63a5\u7d9a\u6570\u306e60%                                  \u2502\n\u2502  - \u672a\u4f7f\u7528\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u5b58\u5728                                  \u2502\n\u2502  - \u80a5\u5927\u5316\u30c6\u30fc\u30d6\u30eb\u306e\u5b58\u5728                                      \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"62-\u76e3\u8996\u30af\u30a8\u30ea\u96c6",children:"6.2 \u76e3\u8996\u30af\u30a8\u30ea\u96c6"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- [Critical] \u63a5\u7d9a\u53ef\u5426\u30c1\u30a7\u30c3\u30af\nSELECT 1;\n\n-- [Critical] \u63a5\u7d9a\u6570\u306e\u78ba\u8a8d\nSELECT\n    CASE\n        WHEN count(*) > current_setting('max_connections')::int * 0.95 THEN 'CRITICAL'\n        WHEN count(*) > current_setting('max_connections')::int * 0.80 THEN 'WARNING'\n        ELSE 'OK'\n    END AS status,\n    count(*) AS current_connections,\n    current_setting('max_connections') AS max_connections\nFROM pg_stat_activity;\n\n-- [Critical] \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\nSELECT\n    CASE\n        WHEN count(*) = 0 THEN 'CRITICAL'  -- \u30ec\u30d7\u30ea\u30ab\u306a\u3057\n        WHEN max(pg_wal_lsn_diff(sent_lsn, replay_lsn)) > 1073741824 THEN 'CRITICAL'  -- 1GB\u4ee5\u4e0a\u9045\u5ef6\n        WHEN max(pg_wal_lsn_diff(sent_lsn, replay_lsn)) > 104857600 THEN 'WARNING'  -- 100MB\u4ee5\u4e0a\u9045\u5ef6\n        ELSE 'OK'\n    END AS status,\n    count(*) AS replica_count,\n    max(pg_wal_lsn_diff(sent_lsn, replay_lsn)) AS max_lag_bytes\nFROM pg_stat_replication;\n\n-- [Warning] \u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387\nSELECT\n    CASE\n        WHEN ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) < 95 THEN 'WARNING'\n        ELSE 'OK'\n    END AS status,\n    ROUND(100.0 * blks_hit / NULLIF(blks_hit + blks_read, 0), 2) AS cache_hit_ratio\nFROM pg_stat_database\nWHERE datname = current_database();\n\n-- [Warning] \u9577\u6642\u9593\u5b9f\u884c\u30af\u30a8\u30ea\nSELECT\n    count(*) AS long_running_queries,\n    CASE\n        WHEN count(*) > 0 THEN 'WARNING'\n        ELSE 'OK'\n    END AS status\nFROM pg_stat_activity\nWHERE state = 'active'\n  AND now() - query_start > interval '10 minutes'\n  AND query NOT LIKE '%pg_stat_activity%';\n\n-- [Warning] \u30c7\u30c3\u30c9\u30ed\u30c3\u30af\u691c\u51fa\nSELECT\n    CASE\n        WHEN deadlocks > 0 THEN 'WARNING'\n        ELSE 'OK'\n    END AS status,\n    deadlocks\nFROM pg_stat_database\nWHERE datname = current_database();\n\n-- [Warning] Autovacuum \u78ba\u8a8d\nSELECT\n    schemaname || '.' || relname AS table_name,\n    n_dead_tup,\n    last_autovacuum,\n    CASE\n        WHEN last_autovacuum IS NULL THEN 'NEVER'\n        WHEN now() - last_autovacuum > interval '24 hours' THEN 'WARNING'\n        ELSE 'OK'\n    END AS status\nFROM pg_stat_user_tables\nWHERE n_dead_tup > 10000\nORDER BY n_dead_tup DESC\nLIMIT 10;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"63-\u30a2\u30e9\u30fc\u30c8\u8a2d\u5b9a\u4f8b-prometheus\u5f62\u5f0f",children:"6.3 \u30a2\u30e9\u30fc\u30c8\u8a2d\u5b9a\u4f8b (Prometheus\u5f62\u5f0f)"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:'groups:\n  - name: postgresql\n    rules:\n      - alert: PostgreSQLDown\n        expr: pg_up == 0\n        for: 1m\n        labels:\n          severity: critical\n        annotations:\n          summary: "PostgreSQL is down"\n\n      - alert: PostgreSQLTooManyConnections\n        expr: pg_stat_activity_count / pg_settings_max_connections > 0.8\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: "PostgreSQL connections above 80%"\n\n      - alert: PostgreSQLReplicationLag\n        expr: pg_replication_lag_seconds > 30\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: "PostgreSQL replication lag is high"\n\n      - alert: PostgreSQLDiskSpaceLow\n        expr: pg_database_size_bytes / node_filesystem_size_bytes > 0.8\n        for: 5m\n        labels:\n          severity: warning\n        annotations:\n          summary: "PostgreSQL disk space usage above 80%"\n\n      - alert: PostgreSQLCacheHitRatioLow\n        expr: pg_stat_database_blks_hit / (pg_stat_database_blks_hit + pg_stat_database_blks_read) < 0.95\n        for: 10m\n        labels:\n          severity: warning\n        annotations:\n          summary: "PostgreSQL cache hit ratio below 95%"\n'})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"7-\u76e3\u8996\u30c4\u30fc\u30eb\u3068\u306e\u9023\u643a",children:"7. \u76e3\u8996\u30c4\u30fc\u30eb\u3068\u306e\u9023\u643a"}),"\n",(0,a.jsx)(e.h3,{id:"71-postgres_exporter-prometheus",children:"7.1 postgres_exporter (Prometheus)"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:'# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\nwget https://github.com/prometheus-community/postgres_exporter/releases/download/v0.15.0/postgres_exporter-0.15.0.linux-amd64.tar.gz\ntar xvf postgres_exporter-0.15.0.linux-amd64.tar.gz\n\n# \u74b0\u5883\u5909\u6570\u8a2d\u5b9a\nexport DATA_SOURCE_NAME="postgresql://postgres:password@localhost:5432/postgres?sslmode=disable"\n\n# \u8d77\u52d5\n./postgres_exporter\n'})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# prometheus.yml\nscrape_configs:\n  - job_name: 'postgresql'\n    static_configs:\n      - targets: ['localhost:9187']\n"})}),"\n",(0,a.jsx)(e.h3,{id:"72-\u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9",children:"7.2 \u30ab\u30b9\u30bf\u30e0\u30e1\u30c8\u30ea\u30af\u30b9"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:'# queries.yaml (postgres_exporter\u7528)\npg_replication:\n  query: |\n    SELECT\n      client_addr,\n      pg_wal_lsn_diff(sent_lsn, replay_lsn) as replication_lag_bytes\n    FROM pg_stat_replication\n  metrics:\n    - client_addr:\n        usage: "LABEL"\n        description: "Client address"\n    - replication_lag_bytes:\n        usage: "GAUGE"\n        description: "Replication lag in bytes"\n\npg_long_running_queries:\n  query: |\n    SELECT\n      count(*) as count\n    FROM pg_stat_activity\n    WHERE state = \'active\'\n      AND now() - query_start > interval \'5 minutes\'\n  metrics:\n    - count:\n        usage: "GAUGE"\n        description: "Number of long running queries"\n'})}),"\n",(0,a.jsx)(e.h3,{id:"73-grafana\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9",children:"7.3 Grafana\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                 \u63a8\u5968Grafana\u30c0\u30c3\u30b7\u30e5\u30dc\u30fc\u30c9                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u6982\u8981\u30d1\u30cd\u30eb\u3011                                              \u2502\n\u2502  - PostgreSQL\u30d0\u30fc\u30b8\u30e7\u30f3                                      \u2502\n\u2502  - \u7a3c\u50cd\u6642\u9593                                                  \u2502\n\u2502  - \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30b5\u30a4\u30ba                                        \u2502\n\u2502  - \u63a5\u7d9a\u6570/\u6700\u5927\u63a5\u7d9a\u6570                                         \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u30d1\u30cd\u30eb\u3011                                    \u2502\n\u2502  - \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3/\u79d2                                       \u2502\n\u2502  - \u30af\u30a8\u30ea/\u79d2                                                 \u2502\n\u2502  - \u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387                                        \u2502\n\u2502  - \u5e73\u5747\u30af\u30a8\u30ea\u6642\u9593                                            \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30ea\u30bd\u30fc\u30b9\u30d1\u30cd\u30eb\u3011                                          \u2502\n\u2502  - \u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u91cf                                            \u2502\n\u2502  - WAL\u30b5\u30a4\u30ba                                                 \u2502\n\u2502  - \u4e00\u6642\u30d5\u30a1\u30a4\u30eb\u4f7f\u7528\u91cf                                        \u2502\n\u2502  - \u63a5\u7d9a\u6570\u63a8\u79fb                                                \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30d1\u30cd\u30eb\u3011                                  \u2502\n\u2502  - \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e9\u30b0                                      \u2502\n\u2502  - WAL\u9001\u4fe1/\u53d7\u4fe1\u91cf                                            \u2502\n\u2502  - \u30b9\u30ed\u30c3\u30c8\u4f7f\u7528\u72b6\u6cc1                                          \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30c6\u30fc\u30d6\u30eb\u30d1\u30cd\u30eb\u3011                                          \u2502\n\u2502  - TOP 10 \u5927\u304d\u3044\u30c6\u30fc\u30d6\u30eb                                     \u2502\n\u2502  - TOP 10 \u30a2\u30af\u30bb\u30b9\u6570                                         \u2502\n\u2502  - \u80a5\u5927\u5316\u30c6\u30fc\u30d6\u30eb                                            \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"74-\u76e3\u8996\u30b9\u30af\u30ea\u30d7\u30c8\u4f8b",children:"7.4 \u76e3\u8996\u30b9\u30af\u30ea\u30d7\u30c8\u4f8b"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# pg_health_check.sh\n\nPGHOST="${PGHOST:-localhost}"\nPGPORT="${PGPORT:-5432}"\nPGUSER="${PGUSER:-postgres}"\nPGDATABASE="${PGDATABASE:-postgres}"\n\nexport PGPASSWORD="${PGPASSWORD}"\n\n# \u63a5\u7d9a\u30c1\u30a7\u30c3\u30af\nif ! psql -h $PGHOST -p $PGPORT -U $PGUSER -d $PGDATABASE -c "SELECT 1" > /dev/null 2>&1; then\n    echo "CRITICAL: Cannot connect to PostgreSQL"\n    exit 2\nfi\n\n# \u63a5\u7d9a\u6570\u30c1\u30a7\u30c3\u30af\nCONN_RESULT=$(psql -h $PGHOST -p $PGPORT -U $PGUSER -d $PGDATABASE -t -c "\nSELECT\n    count(*) AS current,\n    current_setting(\'max_connections\')::int AS max,\n    ROUND(100.0 * count(*) / current_setting(\'max_connections\')::int) AS pct\nFROM pg_stat_activity;\n")\n\nCONN_PCT=$(echo $CONN_RESULT | awk \'{print $3}\')\nif [ "$CONN_PCT" -gt 95 ]; then\n    echo "CRITICAL: Connection usage at ${CONN_PCT}%"\n    exit 2\nelif [ "$CONN_PCT" -gt 80 ]; then\n    echo "WARNING: Connection usage at ${CONN_PCT}%"\n    exit 1\nfi\n\n# \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30c1\u30a7\u30c3\u30af\nREPL_LAG=$(psql -h $PGHOST -p $PGPORT -U $PGUSER -d $PGDATABASE -t -c "\nSELECT COALESCE(max(pg_wal_lsn_diff(sent_lsn, replay_lsn)), 0)\nFROM pg_stat_replication;\n")\n\nif [ "$REPL_LAG" -gt 1073741824 ]; then  # 1GB\n    echo "CRITICAL: Replication lag is ${REPL_LAG} bytes"\n    exit 2\nelif [ "$REPL_LAG" -gt 104857600 ]; then  # 100MB\n    echo "WARNING: Replication lag is ${REPL_LAG} bytes"\n    exit 1\nfi\n\necho "OK: PostgreSQL is healthy"\nexit 0\n'})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"\u53c2\u8003\u30ea\u30f3\u30af",children:"\u53c2\u8003\u30ea\u30f3\u30af"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/monitoring-stats.html",children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 - \u7d71\u8a08\u60c5\u5831\u30b3\u30ec\u30af\u30bf\u30fc"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/pgstatstatements.html",children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 - pg_stat_statements"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://github.com/prometheus-community/postgres_exporter",children:"postgres_exporter"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://github.com/CrunchyData/pgmonitor",children:"pgMonitor"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://github.com/dalibo/pg_activity",children:"pg_activity"})}),"\n"]})]})}function o(n={}){const{wrapper:e}={...(0,_.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(d,{...n})}):d(n)}},28453:(n,e,t)=>{t.d(e,{R:()=>i,x:()=>l});var s=t(96540);const a={},_=s.createContext(a);function i(n){const e=s.useContext(_);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:i(n.components),s.createElement(_.Provider,{value:e},n.children)}}}]);