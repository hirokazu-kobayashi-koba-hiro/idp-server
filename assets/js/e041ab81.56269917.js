"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[5134],{28200:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>t,contentTitle:()=>c,default:()=>j,frontMatter:()=>l,metadata:()=>d,toc:()=>h});const d=JSON.parse('{"id":"content_08_ops/ops-03-authentication-device-search-performance","title":"\u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u691c\u7d22\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6539\u5584\u30ec\u30dd\u30fc\u30c8","description":"\u672c\u30ec\u30dd\u30fc\u30c8\u306f\u3001Issue #964\u300c\u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u691c\u7d22\u30af\u30a8\u30ea\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6539\u5584\u300d\u306b\u95a2\u3059\u308b\u8ca0\u8377\u8a66\u9a13\u7d50\u679c\u3068\u305d\u306e\u8003\u5bdf\u3092\u307e\u3068\u3081\u305f\u3082\u306e\u3067\u3042\u308b\u3002","source":"@site/docs/content_08_ops/ops-03-authentication-device-search-performance.md","sourceDirName":"content_08_ops","slug":"/content_08_ops/ops-03-authentication-device-search-performance","permalink":"/idp-server/docs/content_08_ops/ops-03-authentication-device-search-performance","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_08_ops/ops-03-authentication-device-search-performance.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"\u30b9\u30c8\u30ec\u30b9\u30c6\u30b9\u30c8\u7d50\u679c","permalink":"/idp-server/docs/content_08_ops/ops-02-performance-test"},"next":{"title":"\u6027\u80fd\u691c\u8a3c\u6982\u8981","permalink":"/idp-server/docs/content_08_ops/performance/overview"}}');var i=s(74848),r=s(28453);const l={},c="\u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u691c\u7d22\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6539\u5584\u30ec\u30dd\u30fc\u30c8",t={},h=[{value:"\u80cc\u666f\u3068\u8ab2\u984c",id:"\u80cc\u666f\u3068\u8ab2\u984c",level:2},{value:"\u554f\u984c",id:"\u554f\u984c",level:3},{value:"\u539f\u56e0",id:"\u539f\u56e0",level:3},{value:"\u89e3\u6c7a\u7b56",id:"\u89e3\u6c7a\u7b56",level:3},{value:"\u5b9f\u65bd\u74b0\u5883",id:"\u5b9f\u65bd\u74b0\u5883",level:2},{value:"\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u30fbOS\u60c5\u5831",id:"\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2os\u60c5\u5831",level:3},{value:"\u30b3\u30f3\u30c6\u30ca\u69cb\u6210\uff08Docker Compose\uff09",id:"\u30b3\u30f3\u30c6\u30ca\u69cb\u6210docker-compose",level:3},{value:"\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf",id:"\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf",level:3},{value:"\u30c6\u30b9\u30c8\u7d50\u679c",id:"\u30c6\u30b9\u30c8\u7d50\u679c",level:2},{value:"k6 \u8ca0\u8377\u8a66\u9a13\u7d50\u679c",id:"k6-\u8ca0\u8377\u8a66\u9a13\u7d50\u679c",level:3},{value:"pg_stat_statements \u306b\u3088\u308b\u30af\u30a8\u30ea\u7d71\u8a08",id:"pg_stat_statements-\u306b\u3088\u308b\u30af\u30a8\u30ea\u7d71\u8a08",level:3},{value:"\u30af\u30a8\u30ea\u5b9f\u884c\u8a08\u753b\u6bd4\u8f03",id:"\u30af\u30a8\u30ea\u5b9f\u884c\u8a08\u753b\u6bd4\u8f03",level:3},{value:"\u65e7\u65b9\u5f0f\uff08JSONB GIN\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\uff09",id:"\u65e7\u65b9\u5f0fjsonb-gin\u30a4\u30f3\u30c7\u30c3\u30af\u30b9",level:4},{value:"\u65b0\u65b9\u5f0f\uff08Option C: \u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f\uff09",id:"\u65b0\u65b9\u5f0foption-c-\u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f",level:4},{value:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03",id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03",level:3},{value:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u8a2d\u8a08",id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u8a2d\u8a08",level:2},{value:"Option C: \u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f",id:"option-c-\u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f",level:3},{value:"\u7279\u5fb4",id:"\u7279\u5fb4",level:3},{value:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u4f7f\u7528\u72b6\u6cc1",id:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u4f7f\u7528\u72b6\u6cc1",level:2},{value:"\u30c6\u30fc\u30d6\u30eb\u7d71\u8a08",id:"\u30c6\u30fc\u30d6\u30eb\u7d71\u8a08",level:2},{value:"\u8003\u5bdf",id:"\u8003\u5bdf",level:2},{value:"\u6539\u5584\u30dd\u30a4\u30f3\u30c8",id:"\u6539\u5584\u30dd\u30a4\u30f3\u30c8",level:3},{value:"\u9054\u6210\u3057\u305f\u76ee\u6a19",id:"\u9054\u6210\u3057\u305f\u76ee\u6a19",level:3},{value:"\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5",id:"\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5",level:3},{value:"\u7d50\u8ad6",id:"\u7d50\u8ad6",level:2},{value:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:2}];function x(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"\u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u691c\u7d22\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6539\u5584\u30ec\u30dd\u30fc\u30c8",children:"\u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u691c\u7d22\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6539\u5584\u30ec\u30dd\u30fc\u30c8"})}),"\n",(0,i.jsx)(n.p,{children:"\u672c\u30ec\u30dd\u30fc\u30c8\u306f\u3001Issue #964\u300c\u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u691c\u7d22\u30af\u30a8\u30ea\u306e\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6539\u5584\u300d\u306b\u95a2\u3059\u308b\u8ca0\u8377\u8a66\u9a13\u7d50\u679c\u3068\u305d\u306e\u8003\u5bdf\u3092\u307e\u3068\u3081\u305f\u3082\u306e\u3067\u3042\u308b\u3002"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u80cc\u666f\u3068\u8ab2\u984c",children:"\u80cc\u666f\u3068\u8ab2\u984c"}),"\n",(0,i.jsx)(n.h3,{id:"\u554f\u984c",children:"\u554f\u984c"}),"\n",(0,i.jsxs)(n.p,{children:["CIBA\u30d5\u30ed\u30fc\u306b\u304a\u3051\u308b ",(0,i.jsx)(n.code,{children:"selectByDeviceId"})," \u30af\u30a8\u30ea\u304c\u3001100\u4e07\u30e6\u30fc\u30b6\u30fc\u74b0\u5883\u3067\u5e73\u57471717ms\u3092\u8981\u3057\u3066\u3044\u305f\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"\u539f\u56e0",children:"\u539f\u56e0"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"idp_user.authentication_devices"})," (JSONB) \u306b\u5bfe\u3059\u308bGIN\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304cRLS (Row Level Security) \u74b0\u5883\u4e0b\u3067\u6709\u52b9\u6d3b\u7528\u3055\u308c\u306a\u3044"]}),"\n",(0,i.jsx)(n.li,{children:"\u6bce\u56de\u30d5\u30eb\u30c6\u30fc\u30d6\u30eb\u30b9\u30ad\u30e3\u30f3\u304c\u767a\u751f\u3057\u3001O(n) \u306e\u691c\u7d22\u6642\u9593"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u89e3\u6c7a\u7b56",children:"\u89e3\u6c7a\u7b56"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"idp_user_authentication_devices"})," \u30c6\u30fc\u30d6\u30eb\u3092\u65b0\u8a2d"]}),"\n",(0,i.jsx)(n.li,{children:"BTree PK\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306b\u3088\u308bO(log n) \u691c\u7d22\u3092\u5b9f\u73fe"}),"\n",(0,i.jsx)(n.li,{children:"\u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f\uff08Option C\uff09\u306b\u3088\u308a\u3001JSONB\u30ab\u30e9\u30e0\u3078\u306e\u4f9d\u5b58\u3092\u6392\u9664"}),"\n",(0,i.jsx)(n.li,{children:"\u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u60c5\u5831\u306f\u5c02\u7528\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u53d6\u5f97\uff08\u5c06\u6765\u7684\u306aJSONB\u30ab\u30e9\u30e0\u5ec3\u6b62\u304c\u53ef\u80fd\uff09"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u5b9f\u65bd\u74b0\u5883",children:"\u5b9f\u65bd\u74b0\u5883"}),"\n",(0,i.jsx)(n.h3,{id:"\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2os\u60c5\u5831",children:"\u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u30fbOS\u60c5\u5831"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"MacBook Pro 14\u30a4\u30f3\u30c1 (2023)"}),"\n",(0,i.jsx)(n.li,{children:"\u30c1\u30c3\u30d7: Apple M2 Max"}),"\n",(0,i.jsx)(n.li,{children:"\u30e1\u30e2\u30ea: 64 GB"}),"\n",(0,i.jsx)(n.li,{children:"OS: macOS 15.0.1 (24A348)"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u30b3\u30f3\u30c6\u30ca\u69cb\u6210docker-compose",children:"\u30b3\u30f3\u30c6\u30ca\u69cb\u6210\uff08Docker Compose\uff09"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:"Nginx \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u3092\u4f7f\u7528\u3057\u3001idp-server \u30922\u53f0\u69cb\u6210\u3067\u8d77\u52d5"}),"\n",(0,i.jsxs)(n.li,{children:["\u5404 ",(0,i.jsx)(n.code,{children:"idp-server"})," \u306b CPU 2\u30b3\u30a2\u30fb\u30e1\u30e2\u30ea 2GB \u306e\u30ea\u30df\u30c3\u30c8\u8a2d\u5b9a"]}),"\n",(0,i.jsx)(n.li,{children:"PostgreSQL\u3001Redis\u3001Mockoon \u3092\u8d77\u52d5"}),"\n",(0,i.jsx)(n.li,{children:"Redis\u30ad\u30e3\u30c3\u30b7\u30e5\u306f\u6709\u52b9\u5316"}),"\n",(0,i.jsx)(n.li,{children:"k6\u306f\u30db\u30b9\u30c8\u30de\u30b7\u30f3\u304b\u3089\u76f4\u63a5\u5b9f\u884c"}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf",children:"\u30c6\u30b9\u30c8\u30c7\u30fc\u30bf"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u9805\u76ee"}),(0,i.jsx)(n.th,{children:"\u4ef6\u6570"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u7dcf\u30e6\u30fc\u30b6\u30fc\u6570"}),(0,i.jsx)(n.td,{children:"1,000,949"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u6570"}),(0,i.jsx)(n.td,{children:"1,000,278"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u30c6\u30b9\u30c8\u7d50\u679c",children:"\u30c6\u30b9\u30c8\u7d50\u679c"}),"\n",(0,i.jsx)(n.h3,{id:"k6-\u8ca0\u8377\u8a66\u9a13\u7d50\u679c",children:"k6 \u8ca0\u8377\u8a66\u9a13\u7d50\u679c"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u9805\u76ee"}),(0,i.jsx)(n.th,{children:"\u5024"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"VU\u6570"}),(0,i.jsx)(n.td,{children:"120"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u671f\u9593"}),(0,i.jsx)(n.td,{children:"30\u79d2"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u7dcf\u30ea\u30af\u30a8\u30b9\u30c8\u6570"}),(0,i.jsx)(n.td,{children:"27,030"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u30a4\u30c6\u30ec\u30fc\u30b7\u30e7\u30f3"}),(0,i.jsx)(n.td,{children:"5,406"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u5e73\u5747\u30ec\u30b9\u30dd\u30f3\u30b9\u6642\u9593"}),(0,i.jsx)(n.td,{children:"134.3 ms"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u4e2d\u592e\u5024"}),(0,i.jsx)(n.td,{children:"89.03 ms"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"P90\u30ec\u30b9\u30dd\u30f3\u30b9\u6642\u9593"}),(0,i.jsx)(n.td,{children:"317.47 ms"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"P95\u30ec\u30b9\u30dd\u30f3\u30b9\u6642\u9593"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"426.41 ms"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u76ee\u6a19\u5024"}),(0,i.jsx)(n.td,{children:"500 ms\u4ee5\u4e0b"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u30a8\u30e9\u30fc\u7387"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"0.00%"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u30b9\u30eb\u30fc\u30d7\u30c3\u30c8"}),(0,i.jsx)(n.td,{children:"886 req/s"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"pg_stat_statements-\u306b\u3088\u308b\u30af\u30a8\u30ea\u7d71\u8a08",children:"pg_stat_statements \u306b\u3088\u308b\u30af\u30a8\u30ea\u7d71\u8a08"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u9805\u76ee"}),(0,i.jsx)(n.th,{children:"\u5024"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u5408\u8a08\u5b9f\u884c\u6642\u9593"}),(0,i.jsx)(n.td,{children:"569.21 ms"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u5e73\u5747\u5b9f\u884c\u6642\u9593"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"0.11 ms"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u6700\u5c0f\u5b9f\u884c\u6642\u9593"}),(0,i.jsx)(n.td,{children:"0.03 ms"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u6700\u5927\u5b9f\u884c\u6642\u9593"}),(0,i.jsx)(n.td,{children:"13.94 ms"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u5b9f\u884c\u56de\u6570"}),(0,i.jsx)(n.td,{children:"5,406 \u56de"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8"}),(0,i.jsx)(n.td,{children:"68,588"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u30c7\u30a3\u30b9\u30af\u8aad\u8fbc"}),(0,i.jsx)(n.td,{children:"1,690"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u30ad\u30e3\u30c3\u30b7\u30e5\u30d2\u30c3\u30c8\u7387"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"97.6%"})})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"\u30af\u30a8\u30ea\u5b9f\u884c\u8a08\u753b\u6bd4\u8f03",children:"\u30af\u30a8\u30ea\u5b9f\u884c\u8a08\u753b\u6bd4\u8f03"}),"\n",(0,i.jsx)(n.h4,{id:"\u65e7\u65b9\u5f0fjsonb-gin\u30a4\u30f3\u30c7\u30c3\u30af\u30b9",children:"\u65e7\u65b9\u5f0f\uff08JSONB GIN\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\uff09"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"EXPLAIN ANALYZE\nSELECT u.id, u.name, u.email\nFROM idp_user u,\n     jsonb_array_elements(u.authentication_devices) AS device\nWHERE device->>'id' = 'e87f1eeb-ef08-400b-9590-b8ebd0f7944f';\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u7d50\u679c:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Parallel Seq Scan"})," (\u30d5\u30eb\u30c6\u30fc\u30d6\u30eb\u30b9\u30ad\u30e3\u30f3)"]}),"\n",(0,i.jsxs)(n.li,{children:["\u5b9f\u884c\u6642\u9593: ",(0,i.jsx)(n.strong,{children:"656.2 ms"})]}),"\n"]}),"\n",(0,i.jsx)(n.h4,{id:"\u65b0\u65b9\u5f0foption-c-\u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f",children:"\u65b0\u65b9\u5f0f\uff08Option C: \u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f\uff09"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"EXPLAIN ANALYZE\nSELECT\n    idp_user.*,\n    (SELECT JSON_AGG(JSON_BUILD_OBJECT(\n        'id', d.id,\n        'os', d.os,\n        'model', d.model,\n        'platform', d.platform,\n        'locale', d.locale,\n        'app_name', d.app_name,\n        'priority', d.priority,\n        'available_methods', d.available_methods,\n        'notification_token', d.notification_token,\n        'notification_channel', d.notification_channel\n    )) FROM idp_user_authentication_devices d WHERE d.user_id = idp_user.id) AS authentication_devices,\n    COALESCE(JSON_AGG(...) FILTER (...), '[]') AS roles,\n    COALESCE(JSON_AGG(...) FILTER (...), '[]') AS permissions\nFROM idp_user\nLEFT JOIN idp_user_roles ON idp_user.id = idp_user_roles.user_id\nLEFT JOIN role ON idp_user_roles.role_id = role.id\nLEFT JOIN role_permission ON role.id = role_permission.role_id\nLEFT JOIN permission ON role_permission.permission_id = permission.id\nWHERE idp_user.id = (\n    SELECT user_id FROM idp_user_authentication_devices\n    WHERE id = ?::uuid AND tenant_id = ?::uuid\n)\nGROUP BY idp_user.id;\n"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u7d50\u679c:"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Index Scan using idx_user_auth_device_tenant_user"})," (\u30b5\u30d6\u30af\u30a8\u30ea)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Index Scan using idp_user_pkey"})," (\u30e6\u30fc\u30b6\u30fc\u53d6\u5f97)"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Index Scan using idx_user_auth_device_user_id"})," (\u30c7\u30d0\u30a4\u30b9\u60c5\u5831\u53d6\u5f97)"]}),"\n",(0,i.jsxs)(n.li,{children:["\u5b9f\u884c\u6642\u9593: ",(0,i.jsx)(n.strong,{children:"~1.0 ms"})," (EXPLAIN ANALYZE)"]}),"\n",(0,i.jsxs)(n.li,{children:["\u5b9f\u884c\u6642\u9593: ",(0,i.jsx)(n.strong,{children:"0.11 ms"})," (pg_stat_statements \u5e73\u5747)"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03",children:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u6bd4\u8f03"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u65b9\u5f0f"}),(0,i.jsx)(n.th,{children:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9"}),(0,i.jsx)(n.th,{children:"\u5b9f\u884c\u6642\u9593"}),(0,i.jsx)(n.th,{children:"\u6539\u5584\u7387"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u65e7\u65b9\u5f0f (JSONB)"}),(0,i.jsx)(n.td,{children:"GIN (\u672a\u4f7f\u7528)"}),(0,i.jsx)(n.td,{children:"656.2 ms"}),(0,i.jsx)(n.td,{children:"-"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u65b0\u65b9\u5f0f (Option C)"}),(0,i.jsx)(n.td,{children:"BTree PK + \u30b5\u30d6\u30af\u30a8\u30ea"}),(0,i.jsx)(n.td,{children:"0.11 ms"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u7d046,000\u500d"})})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u8a2d\u8a08",children:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u8a2d\u8a08"}),"\n",(0,i.jsx)(n.h3,{id:"option-c-\u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f",children:"Option C: \u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      selectSql                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502  SELECT idp_user.*, ...                                 \u2502\n\u2502  (SELECT JSON_AGG(...) FROM idp_user_authentication_   \u2502\n\u2502   devices d WHERE d.user_id = idp_user.id)             \u2502\n\u2502   AS authentication_devices                             \u2502\n\u2502  FROM idp_user                                          \u2502\n\u2502  WHERE idp_user.id = (                                  \u2502\n\u2502      SELECT user_id FROM idp_user_authentication_devices\u2502\n\u2502      WHERE id = ? AND tenant_id = ?                     \u2502\n\u2502  )                                                      \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u7279\u5fb4",children:"\u7279\u5fb4"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"SQL\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u7d71\u4e00"}),": ",(0,i.jsx)(n.code,{children:"selectSql"}),"\u306b\u7d71\u5408\u3001",(0,i.jsx)(n.code,{children:"selectByDeviceSql"}),"\u306f\u524a\u9664"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"JSONB\u30ab\u30e9\u30e0\u4e0d\u8981"}),": \u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u60c5\u5831\u306f\u5c02\u7528\u30c6\u30fc\u30d6\u30eb\u304b\u3089\u30b5\u30d6\u30af\u30a8\u30ea\u3067\u53d6\u5f97"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5c06\u6765\u6027"}),": ",(0,i.jsx)(n.code,{children:"idp_user.authentication_devices"}),"\u30ab\u30e9\u30e0\u306e\u5ec3\u6b62\u304c\u53ef\u80fd"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u4f7f\u7528\u72b6\u6cc1",children:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u4f7f\u7528\u72b6\u6cc1"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT\n    indexrelname as index_name,\n    idx_scan as index_scans,\n    idx_tup_read as tuples_read\nFROM pg_stat_user_indexes\nWHERE relname = 'idp_user_authentication_devices';\n"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u540d"}),(0,i.jsx)(n.th,{children:"\u30b9\u30ad\u30e3\u30f3\u56de\u6570"}),(0,i.jsx)(n.th,{children:"\u7528\u9014"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"idp_user_authentication_devices_pkey"}),(0,i.jsx)(n.td,{children:"1,024,014"}),(0,i.jsx)(n.td,{children:"\u30c7\u30d0\u30a4\u30b9ID\u691c\u7d22"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"idx_user_auth_device_user_id"}),(0,i.jsx)(n.td,{children:"17,070"}),(0,i.jsx)(n.td,{children:"\u30e6\u30fc\u30b6\u30fcID\u306b\u3088\u308b\u30c7\u30d0\u30a4\u30b9\u53d6\u5f97"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"idx_user_auth_device_tenant_user"}),(0,i.jsx)(n.td,{children:"513"}),(0,i.jsx)(n.td,{children:"\u30c6\u30ca\u30f3\u30c8+\u30e6\u30fc\u30b6\u30fc\u8907\u5408\u691c\u7d22"})]})]})]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u30c6\u30fc\u30d6\u30eb\u7d71\u8a08",children:"\u30c6\u30fc\u30d6\u30eb\u7d71\u8a08"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"SELECT relname, n_live_tup, seq_scan, idx_scan\nFROM pg_stat_user_tables\nWHERE relname IN ('idp_user', 'idp_user_authentication_devices');\n"})}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u30c6\u30fc\u30d6\u30eb"}),(0,i.jsx)(n.th,{children:"\u30ec\u30b3\u30fc\u30c9\u6570"}),(0,i.jsx)(n.th,{children:"Seq Scan"}),(0,i.jsx)(n.th,{children:"Index Scan"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"idp_user"}),(0,i.jsx)(n.td,{children:"1,000,949"}),(0,i.jsx)(n.td,{children:"52"}),(0,i.jsx)(n.td,{children:"1,072,669"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"idp_user_authentication_devices"}),(0,i.jsx)(n.td,{children:"1,000,278"}),(0,i.jsx)(n.td,{children:"609"}),(0,i.jsx)(n.td,{children:"1,041,597"})]})]})]}),"\n",(0,i.jsx)(n.p,{children:"Index Scan\u304c\u5727\u5012\u7684\u306b\u591a\u304f\u3001\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u52b9\u679c\u7684\u306b\u4f7f\u7528\u3055\u308c\u3066\u3044\u308b\u3002"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u8003\u5bdf",children:"\u8003\u5bdf"}),"\n",(0,i.jsx)(n.h3,{id:"\u6539\u5584\u30dd\u30a4\u30f3\u30c8",children:"\u6539\u5584\u30dd\u30a4\u30f3\u30c8"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u52b9\u7387"}),": BTree PK\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306b\u3088\u308a\u3001O(n) \u2192 O(log n) \u306e\u691c\u7d22\u52b9\u7387\u3092\u5b9f\u73fe"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"RLS\u5bfe\u5fdc"}),": \u65b0\u30c6\u30fc\u30d6\u30eb\u306fRLS\u74b0\u5883\u4e0b\u3067\u3082\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u6709\u52b9\u6d3b\u7528\u3055\u308c\u308b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30af\u30a8\u30ea\u7d71\u4e00"}),": \u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f\u306b\u3088\u308a\u3001",(0,i.jsx)(n.code,{children:"selectSql"}),"\u306b\u7d71\u5408\u3057\u91cd\u8907\u30b3\u30fc\u30c9\u3092\u524a\u9664"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5c06\u6765\u6027"}),": JSONB\u30ab\u30e9\u30e0\u3078\u306e\u4f9d\u5b58\u3092\u6392\u9664\u3057\u3001\u5c06\u6765\u7684\u306a\u30ab\u30e9\u30e0\u5ec3\u6b62\u304c\u53ef\u80fd"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u9054\u6210\u3057\u305f\u76ee\u6a19",children:"\u9054\u6210\u3057\u305f\u76ee\u6a19"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u76ee\u6a19"}),(0,i.jsx)(n.th,{children:"\u7d50\u679c"}),(0,i.jsx)(n.th,{children:"\u5224\u5b9a"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"p(95) 500ms\u4ee5\u4e0b"}),(0,i.jsx)(n.td,{children:"426.41 ms"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u9054\u6210"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u30a8\u30e9\u30fc\u7387 0%"}),(0,i.jsx)(n.td,{children:"0.00%"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u9054\u6210"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:"\u30af\u30a8\u30ea\u5b9f\u884c\u6642\u9593 1ms\u4ee5\u4e0b"}),(0,i.jsx)(n.td,{children:"0.11 ms"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"\u9054\u6210"})})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5",children:"\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30b9\u30c8\u30ec\u30fc\u30b8\u5897\u52a0"}),": \u65b0\u30c6\u30fc\u30d6\u30eb\u5206\u306e\u30b9\u30c8\u30ec\u30fc\u30b8\u304c\u8ffd\u52a0"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u4e8c\u91cd\u66f8\u304d\u8fbc\u307f"}),": insert/update\u6642\u306b\u4e21\u65b9\u306e\u30c6\u30fc\u30d6\u30eb\u306b\u66f8\u304d\u8fbc\u307f\uff08\u305f\u3060\u3057\u3001\u30c7\u30d0\u30a4\u30b9\u6570\u306f\u901a\u5e381-3\u500b\u7a0b\u5ea6\u306e\u305f\u3081\u5f71\u97ff\u306f\u8efd\u5fae\uff09"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u4f5c\u696d"}),": \u65e2\u5b58\u30c7\u30fc\u30bf\u306e\u79fb\u884c\u304c\u5fc5\u8981"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u7d50\u8ad6",children:"\u7d50\u8ad6"}),"\n",(0,i.jsxs)(n.p,{children:["100\u4e07\u30e6\u30fc\u30b6\u30fc\u74b0\u5883\u306b\u304a\u3044\u3066\u3001\u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u691c\u7d22\u306ep(95)\u30ec\u30b9\u30dd\u30f3\u30b9\u30bf\u30a4\u30e0\u3092 ",(0,i.jsx)(n.strong,{children:"1717ms \u2192 426.41ms"})," \u306b\u6539\u5584\u3057\u3001\u76ee\u6a19\u306e500ms\u4ee5\u4e0b\u3092\u9054\u6210\u3057\u305f\u3002"]}),"\n",(0,i.jsxs)(n.p,{children:["\u30af\u30a8\u30ea\u5358\u4f53\u306e\u5b9f\u884c\u6642\u9593\u306f ",(0,i.jsx)(n.strong,{children:"656ms \u2192 0.11ms\uff08\u7d046,000\u500d\u306e\u6539\u5584\uff09"})," \u3068\u306a\u308a\u3001CIBA\u30d5\u30ed\u30fc\u306e\u5168\u4f53\u7684\u306a\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u5411\u4e0a\u306b\u5927\u304d\u304f\u8ca2\u732e\u3057\u3066\u3044\u308b\u3002"]}),"\n",(0,i.jsx)(n.p,{children:"Option C\uff08\u30b5\u30d6\u30af\u30a8\u30ea\u65b9\u5f0f\uff09\u306e\u63a1\u7528\u306b\u3088\u308a\u3001SQL\u30c6\u30f3\u30d7\u30ec\u30fc\u30c8\u306e\u7d71\u4e00\u3068JSONB\u30ab\u30e9\u30e0\u3078\u306e\u4f9d\u5b58\u6392\u9664\u3092\u5b9f\u73fe\u3057\u3001\u5c06\u6765\u7684\u306a\u4fdd\u5b88\u6027\u3082\u5411\u4e0a\u3057\u305f\u3002"}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://github.com/hirokazu-kobayashi-koba-hiro/idp-server/issues/964",children:"Issue #964: \u8a8d\u8a3c\u30c7\u30d0\u30a4\u30b9\u30c6\u30fc\u30d6\u30eb\u5206\u96e2"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"../../../scripts/migration/README.md",children:"\u30c7\u30fc\u30bf\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u30b9\u30af\u30ea\u30d7\u30c8"})}),"\n"]})]})}function j(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(x,{...e})}):x(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>l,x:()=>c});var d=s(96540);const i={},r=d.createContext(i);function l(e){const n=d.useContext(r);return d.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:l(e.components),d.createElement(r.Provider,{value:n},e.children)}}}]);