"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[6152],{9442:(n,e,s)=>{s.r(e),s.d(e,{assets:()=>t,contentTitle:()=>p,default:()=>i,frontMatter:()=>c,metadata:()=>a,toc:()=>d});const a=JSON.parse('{"id":"content_11_learning/postgresql/dba-02-backup-recovery","title":"PostgreSQL \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u30ea\u30ab\u30d0\u30ea\u30ac\u30a4\u30c9","description":"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001PostgreSQL\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u3068\u30ea\u30ab\u30d0\u30ea\u624b\u9806\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002","source":"@site/docs/content_11_learning/11-postgresql/dba-02-backup-recovery.md","sourceDirName":"content_11_learning/11-postgresql","slug":"/content_11_learning/postgresql/dba-02-backup-recovery","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-02-backup-recovery","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_11_learning/11-postgresql/dba-02-backup-recovery.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"PostgreSQL \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3068\u521d\u671f\u8a2d\u5b9a\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-01-installation"},"next":{"title":"PostgreSQL \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068HA\u69cb\u6210\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-03-replication-ha"}}');var r=s(74848),l=s(28453);const c={},p="PostgreSQL \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u30ea\u30ab\u30d0\u30ea\u30ac\u30a4\u30c9",t={},d=[{value:"\u76ee\u6b21",id:"\u76ee\u6b21",level:2},{value:"1. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u306e\u6982\u8981",id:"1-\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u306e\u6982\u8981",level:2},{value:"1.1 \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u65b9\u5f0f\u306e\u6bd4\u8f03",id:"11-\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u65b9\u5f0f\u306e\u6bd4\u8f03",level:3},{value:"1.2 RPO\u3068RTO",id:"12-rpo\u3068rto",level:3},{value:"2. \u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (pg_dump/pg_dumpall)",id:"2-\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7-pg_dumppg_dumpall",level:2},{value:"2.1 pg_dump \u306e\u57fa\u672c",id:"21-pg_dump-\u306e\u57fa\u672c",level:3},{value:"2.2 pg_dump \u306e\u30aa\u30d7\u30b7\u30e7\u30f3",id:"22-pg_dump-\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",level:3},{value:"2.3 pg_dumpall",id:"23-pg_dumpall",level:3},{value:"2.4 \u30ea\u30b9\u30c8\u30a2 (pg_restore)",id:"24-\u30ea\u30b9\u30c8\u30a2-pg_restore",level:3},{value:"2.5 pg_restore \u306e\u30aa\u30d7\u30b7\u30e7\u30f3",id:"25-pg_restore-\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",level:3},{value:"2.6 \u9078\u629e\u7684\u30ea\u30b9\u30c8\u30a2",id:"26-\u9078\u629e\u7684\u30ea\u30b9\u30c8\u30a2",level:3},{value:"3. \u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (pg_basebackup)",id:"3-\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7-pg_basebackup",level:2},{value:"3.1 pg_basebackup \u306e\u57fa\u672c",id:"31-pg_basebackup-\u306e\u57fa\u672c",level:3},{value:"3.2 pg_basebackup \u306e\u30aa\u30d7\u30b7\u30e7\u30f3",id:"32-pg_basebackup-\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",level:3},{value:"3.3 \u524d\u63d0\u6761\u4ef6\u306e\u8a2d\u5b9a",id:"33-\u524d\u63d0\u6761\u4ef6\u306e\u8a2d\u5b9a",level:3},{value:"3.4 \u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304b\u3089\u306e\u30ea\u30b9\u30c8\u30a2",id:"34-\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304b\u3089\u306e\u30ea\u30b9\u30c8\u30a2",level:3},{value:"4. WAL\u30a2\u30fc\u30ab\u30a4\u30d6",id:"4-wal\u30a2\u30fc\u30ab\u30a4\u30d6",level:2},{value:"4.1 WAL\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u8a2d\u5b9a",id:"41-wal\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u8a2d\u5b9a",level:3},{value:"4.2 \u30a2\u30fc\u30ab\u30a4\u30d6\u5148\u306e\u30d0\u30ea\u30a8\u30fc\u30b7\u30e7\u30f3",id:"42-\u30a2\u30fc\u30ab\u30a4\u30d6\u5148\u306e\u30d0\u30ea\u30a8\u30fc\u30b7\u30e7\u30f3",level:3},{value:"4.3 \u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u76e3\u8996",id:"43-\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u76e3\u8996",level:3},{value:"5. PITR (Point-In-Time Recovery)",id:"5-pitr-point-in-time-recovery",level:2},{value:"5.1 PITR\u306e\u6982\u5ff5",id:"51-pitr\u306e\u6982\u5ff5",level:3},{value:"5.2 PITR\u306e\u6e96\u5099",id:"52-pitr\u306e\u6e96\u5099",level:3},{value:"5.3 PITR\u306e\u5b9f\u884c",id:"53-pitr\u306e\u5b9f\u884c",level:3},{value:"5.4 \u5fa9\u65e7\u30bf\u30fc\u30b2\u30c3\u30c8\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",id:"54-\u5fa9\u65e7\u30bf\u30fc\u30b2\u30c3\u30c8\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",level:3},{value:"5.5 \u5fa9\u65e7\u306e\u78ba\u8a8d\u3068\u5b8c\u4e86",id:"55-\u5fa9\u65e7\u306e\u78ba\u8a8d\u3068\u5b8c\u4e86",level:3},{value:"5.6 \u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306e\u7406\u89e3",id:"56-\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306e\u7406\u89e3",level:3},{value:"6. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c",id:"6-\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c",level:2},{value:"6.1 \u691c\u8a3c\u306e\u91cd\u8981\u6027",id:"61-\u691c\u8a3c\u306e\u91cd\u8981\u6027",level:3},{value:"6.2 \u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c",id:"62-\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c",level:3},{value:"6.3 \u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c",id:"63-\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c",level:3},{value:"6.4 \u81ea\u52d5\u691c\u8a3c\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb",id:"64-\u81ea\u52d5\u691c\u8a3c\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb",level:3},{value:"7. \u904b\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u4f8b",id:"7-\u904b\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u4f8b",level:2},{value:"7.1 \u65e5\u6b21\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b9\u30af\u30ea\u30d7\u30c8",id:"71-\u65e5\u6b21\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b9\u30af\u30ea\u30d7\u30c8",level:3},{value:"7.2 \u65e5\u6b21\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b9\u30af\u30ea\u30d7\u30c8",id:"72-\u65e5\u6b21\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b9\u30af\u30ea\u30d7\u30c8",level:3},{value:"7.3 cron\u3067\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u8a2d\u5b9a",id:"73-cron\u3067\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u8a2d\u5b9a",level:3},{value:"8. \u30af\u30e9\u30a6\u30c9\u74b0\u5883\u3067\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7",id:"8-\u30af\u30e9\u30a6\u30c9\u74b0\u5883\u3067\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7",level:2},{value:"8.1 AWS S3\u3078\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7",id:"81-aws-s3\u3078\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7",level:3},{value:"8.2 pgBackRest\u306e\u4f7f\u7528",id:"82-pgbackrest\u306e\u4f7f\u7528",level:3},{value:"8.3 \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u306e\u307e\u3068\u3081",id:"83-\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u306e\u307e\u3068\u3081",level:3},{value:"\u53c2\u8003\u30ea\u30f3\u30af",id:"\u53c2\u8003\u30ea\u30f3\u30af",level:2}];function o(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"postgresql-\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u30ea\u30ab\u30d0\u30ea\u30ac\u30a4\u30c9",children:"PostgreSQL \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u30ea\u30ab\u30d0\u30ea\u30ac\u30a4\u30c9"})}),"\n",(0,r.jsx)(e.p,{children:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001PostgreSQL\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u3068\u30ea\u30ab\u30d0\u30ea\u624b\u9806\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\u76ee\u6b21",children:"\u76ee\u6b21"}),"\n",(0,r.jsxs)(e.ol,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"#1-%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E6%88%A6%E7%95%A5%E3%81%AE%E6%A6%82%E8%A6%81",children:"\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u306e\u6982\u8981"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"#2-%E8%AB%96%E7%90%86%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97-pg_dumppg_dumpall",children:"\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (pg_dump/pg_dumpall)"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"#3-%E7%89%A9%E7%90%86%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97-pg_basebackup",children:"\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (pg_basebackup)"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"#4-wal%E3%82%A2%E3%83%BC%E3%82%AB%E3%82%A4%E3%83%96",children:"WAL\u30a2\u30fc\u30ab\u30a4\u30d6"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"#5-pitr-point-in-time-recovery",children:"PITR (Point-In-Time Recovery)"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"#6-%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97%E3%81%AE%E6%A4%9C%E8%A8%BC",children:"\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"#7-%E9%81%8B%E7%94%A8%E3%82%B9%E3%82%AF%E3%83%AA%E3%83%97%E3%83%88%E4%BE%8B",children:"\u904b\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u4f8b"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"#8-%E3%82%AF%E3%83%A9%E3%82%A6%E3%83%89%E7%92%B0%E5%A2%83%E3%81%A7%E3%81%AE%E3%83%90%E3%83%83%E3%82%AF%E3%82%A2%E3%83%83%E3%83%97",children:"\u30af\u30e9\u30a6\u30c9\u74b0\u5883\u3067\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7"})}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"1-\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u306e\u6982\u8981",children:"1. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u306e\u6982\u8981"}),"\n",(0,r.jsx)(e.h3,{id:"11-\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u65b9\u5f0f\u306e\u6bd4\u8f03",children:"1.1 \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u65b9\u5f0f\u306e\u6bd4\u8f03"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u65b9\u5f0f\u306e\u6bd4\u8f03                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3011pg_dump / pg_dumpall                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 \u2705 \u7279\u5b9a\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9/\u30c6\u30fc\u30d6\u30eb\u306e\u307f\u53ef\u80fd                \u2502   \u2502\n\u2502  \u2502 \u2705 \u7570\u306a\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u9593\u3067\u30ea\u30b9\u30c8\u30a2\u53ef\u80fd                   \u2502   \u2502\n\u2502  \u2502 \u2705 \u53ef\u8aad\u306aSQL\u307e\u305f\u306f\u30ab\u30b9\u30bf\u30e0\u5f62\u5f0f                        \u2502   \u2502\n\u2502  \u2502 \u274c \u5927\u898f\u6a21DB\u3067\u306f\u6642\u9593\u304c\u304b\u304b\u308b                           \u2502   \u2502\n\u2502  \u2502 \u274c PITR\u4e0d\u53ef                                           \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3011pg_basebackup / \u30d5\u30a1\u30a4\u30eb\u30b7\u30b9\u30c6\u30e0        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 \u2705 \u9ad8\u901f\uff08\u30d5\u30a1\u30a4\u30eb\u30b3\u30d4\u30fc\uff09                             \u2502   \u2502\n\u2502  \u2502 \u2705 \u30af\u30e9\u30b9\u30bf\u5168\u4f53\u3092\u4e00\u62ec\u30d0\u30c3\u30af\u30a2\u30c3\u30d7                     \u2502   \u2502\n\u2502  \u2502 \u2705 PITR\u304c\u53ef\u80fd\uff08WAL\u30a2\u30fc\u30ab\u30a4\u30d6\u3068\u7d44\u307f\u5408\u308f\u305b\uff09            \u2502   \u2502\n\u2502  \u2502 \u274c \u540c\u4e00\u30d0\u30fc\u30b8\u30e7\u30f3\u3067\u306e\u307f\u30ea\u30b9\u30c8\u30a2                       \u2502   \u2502\n\u2502  \u2502 \u274c \u7279\u5b9a\u30c6\u30fc\u30d6\u30eb\u306e\u307f\u306e\u30ea\u30b9\u30c8\u30a2\u4e0d\u53ef                     \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u63a8\u5968\u3011\u4e21\u65b9\u3092\u7d44\u307f\u5408\u308f\u305b\u308b                                  \u2502\n\u2502  - \u65e5\u6b21: pg_basebackup + WAL\u30a2\u30fc\u30ab\u30a4\u30d6 (PITR\u7528)             \u2502\n\u2502  - \u9031\u6b21: pg_dump (\u500b\u5225\u30ea\u30b9\u30c8\u30a2\u7528\u3001\u9577\u671f\u4fdd\u5b58\u7528)               \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h3,{id:"12-rpo\u3068rto",children:"1.2 RPO\u3068RTO"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    RPO \u3068 RTO \u306e\u6982\u5ff5                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010RPO\u3011Recovery Point Objective (\u76ee\u6a19\u5fa9\u65e7\u6642\u70b9)              \u2502\n\u2502  - \u3069\u3053\u307e\u3067\u53e4\u3044\u30c7\u30fc\u30bf\u3092\u8a31\u5bb9\u3067\u304d\u308b\u304b                          \u2502\n\u2502  - \u30c7\u30fc\u30bf\u640d\u5931\u306e\u8a31\u5bb9\u91cf                                        \u2502\n\u2502                                                              \u2502\n\u2502       \u969c\u5bb3\u767a\u751f                                               \u2502\n\u2502          \u2193                                                   \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25cf\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500                   \u2502\n\u2502      \u2190\u2500\u2500\u2500\u2192                                                   \u2502\n\u2502       RPO (\u4f8b: 1\u6642\u9593\u5206\u306e\u30c7\u30fc\u30bf\u640d\u5931\u307e\u3067\u8a31\u5bb9)                  \u2502\n\u2502                                                              \u2502\n\u2502  \u3010RTO\u3011Recovery Time Objective (\u76ee\u6a19\u5fa9\u65e7\u6642\u9593)               \u2502\n\u2502  - \u5fa9\u65e7\u307e\u3067\u306b\u3069\u308c\u3060\u3051\u6642\u9593\u3092\u304b\u3051\u3089\u308c\u308b\u304b                      \u2502\n\u2502  - \u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u306e\u8a31\u5bb9\u91cf                                      \u2502\n\u2502                                                              \u2502\n\u2502       \u969c\u5bb3\u767a\u751f              \u5fa9\u65e7\u5b8c\u4e86                         \u2502\n\u2502          \u2193                     \u2193                             \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25cf\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25cf\u2500\u2500\u2500\u2500                         \u2502\n\u2502          \u2190\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192                              \u2502\n\u2502            RTO (\u4f8b: 4\u6642\u9593\u4ee5\u5185\u306b\u5fa9\u65e7)                         \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u65b9\u5f0f\u3068\u306e\u95a2\u4fc2\u3011                                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u2502\n\u2502  \u2502 \u65b9\u5f0f               \u2502 RPO      \u2502 RTO      \u2502              \u2502\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524              \u2502\n\u2502  \u2502 \u65e5\u6b21pg_dump        \u2502 \u6700\u592724\u6642\u9593\u2502 \u5927       \u2502              \u2502\n\u2502  \u2502 pg_basebackup+WAL  \u2502 \u307b\u307c\u30bc\u30ed \u2502 \u4e2d       \u2502              \u2502\n\u2502  \u2502 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3    \u2502 \u30bc\u30ed     \u2502 \u5c0f       \u2502              \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"2-\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7-pg_dumppg_dumpall",children:"2. \u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (pg_dump/pg_dumpall)"}),"\n",(0,r.jsx)(e.h3,{id:"21-pg_dump-\u306e\u57fa\u672c",children:"2.1 pg_dump \u306e\u57fa\u672c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\npg_dump -h localhost -U postgres -d mydb > mydb_backup.sql\n\n# \u30ab\u30b9\u30bf\u30e0\u5f62\u5f0f (\u63a8\u5968: \u5727\u7e2e\u3001\u4e26\u5217\u30ea\u30b9\u30c8\u30a2\u53ef\u80fd)\npg_dump -h localhost -U postgres -Fc -d mydb -f mydb_backup.dump\n\n# \u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5f62\u5f0f (\u4e26\u5217\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53ef\u80fd)\npg_dump -h localhost -U postgres -Fd -j 4 -d mydb -f mydb_backup_dir\n\n# \u5727\u7e2e\u30ec\u30d9\u30eb\u6307\u5b9a\npg_dump -h localhost -U postgres -Fc -Z 9 -d mydb -f mydb_backup.dump\n"})}),"\n",(0,r.jsx)(e.h3,{id:"22-pg_dump-\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",children:"2.2 pg_dump \u306e\u30aa\u30d7\u30b7\u30e7\u30f3"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    pg_dump \u4e3b\u8981\u30aa\u30d7\u30b7\u30e7\u30f3                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u51fa\u529b\u5f62\u5f0f\u3011                                                \u2502\n\u2502  -F, --format=FORMAT                                         \u2502\n\u2502      p: plain (SQL\u6587\u3001\u30c7\u30d5\u30a9\u30eb\u30c8)                            \u2502\n\u2502      c: custom (\u30ab\u30b9\u30bf\u30e0\u5f62\u5f0f\u3001\u5727\u7e2e\u5bfe\u5fdc\u3001\u63a8\u5968)                \u2502\n\u2502      d: directory (\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u5f62\u5f0f\u3001\u4e26\u5217\u5bfe\u5fdc)               \u2502\n\u2502      t: tar (tar\u5f62\u5f0f)                                        \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u5727\u7e2e\u3011                                                    \u2502\n\u2502  -Z, --compress=LEVEL                                        \u2502\n\u2502      0-9 (0=\u306a\u3057, 9=\u6700\u5927)                                    \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u4e26\u5217\u51e6\u7406\u3011                                                \u2502\n\u2502  -j, --jobs=NUM                                              \u2502\n\u2502      \u4e26\u5217\u30ef\u30fc\u30ab\u30fc\u6570 (directory\u5f62\u5f0f\u306e\u307f)                      \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u5bfe\u8c61\u6307\u5b9a\u3011                                                \u2502\n\u2502  -n, --schema=SCHEMA      \u7279\u5b9a\u30b9\u30ad\u30fc\u30de\u306e\u307f                   \u2502\n\u2502  -N, --exclude-schema     \u7279\u5b9a\u30b9\u30ad\u30fc\u30de\u3092\u9664\u5916                 \u2502\n\u2502  -t, --table=TABLE        \u7279\u5b9a\u30c6\u30fc\u30d6\u30eb\u306e\u307f                   \u2502\n\u2502  -T, --exclude-table      \u7279\u5b9a\u30c6\u30fc\u30d6\u30eb\u3092\u9664\u5916                 \u2502\n\u2502  --exclude-table-data     \u30c7\u30fc\u30bf\u3092\u9664\u5916 (\u30b9\u30ad\u30fc\u30de\u306e\u307f)        \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u305d\u306e\u4ed6\u3011                                                  \u2502\n\u2502  -s, --schema-only        \u30b9\u30ad\u30fc\u30de\u306e\u307f (\u30c7\u30fc\u30bf\u306a\u3057)          \u2502\n\u2502  -a, --data-only          \u30c7\u30fc\u30bf\u306e\u307f (\u30b9\u30ad\u30fc\u30de\u306a\u3057)          \u2502\n\u2502  --no-owner               \u6240\u6709\u8005\u60c5\u5831\u3092\u542b\u3081\u306a\u3044               \u2502\n\u2502  --no-privileges          \u6a29\u9650\u60c5\u5831\u3092\u542b\u3081\u306a\u3044                 \u2502\n\u2502  -v, --verbose            \u8a73\u7d30\u51fa\u529b                           \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h3,{id:"23-pg_dumpall",children:"2.3 pg_dumpall"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u5168\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9 + \u30b0\u30ed\u30fc\u30d0\u30eb\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\npg_dumpall -h localhost -U postgres > full_backup.sql\n\n# \u30b0\u30ed\u30fc\u30d0\u30eb\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306e\u307f (\u30ed\u30fc\u30eb\u3001\u30c6\u30fc\u30d6\u30eb\u30b9\u30da\u30fc\u30b9)\npg_dumpall -h localhost -U postgres --globals-only > globals.sql\n\n# \u30ed\u30fc\u30eb\u306e\u307f\npg_dumpall -h localhost -U postgres --roles-only > roles.sql\n"})}),"\n",(0,r.jsx)(e.h3,{id:"24-\u30ea\u30b9\u30c8\u30a2-pg_restore",children:"2.4 \u30ea\u30b9\u30c8\u30a2 (pg_restore)"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u30ab\u30b9\u30bf\u30e0\u5f62\u5f0f\u304b\u3089\u30ea\u30b9\u30c8\u30a2\npg_restore -h localhost -U postgres -d mydb mydb_backup.dump\n\n# \u65b0\u898f\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\u3057\u3066\u30ea\u30b9\u30c8\u30a2\ncreatedb -h localhost -U postgres mydb_restored\npg_restore -h localhost -U postgres -d mydb_restored mydb_backup.dump\n\n# \u4e26\u5217\u30ea\u30b9\u30c8\u30a2\npg_restore -h localhost -U postgres -d mydb -j 4 mydb_backup.dump\n\n# \u7279\u5b9a\u30c6\u30fc\u30d6\u30eb\u306e\u307f\u30ea\u30b9\u30c8\u30a2\npg_restore -h localhost -U postgres -d mydb -t users mydb_backup.dump\n\n# \u30af\u30ea\u30fc\u30f3\u30ea\u30b9\u30c8\u30a2 (\u65e2\u5b58\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u524a\u9664\u3057\u3066\u304b\u3089)\npg_restore -h localhost -U postgres -d mydb -c mydb_backup.dump\n\n# \u30d7\u30ec\u30fc\u30f3SQL\u5f62\u5f0f\u306e\u5834\u5408\npsql -h localhost -U postgres -d mydb < mydb_backup.sql\n"})}),"\n",(0,r.jsx)(e.h3,{id:"25-pg_restore-\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",children:"2.5 pg_restore \u306e\u30aa\u30d7\u30b7\u30e7\u30f3"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  pg_restore \u4e3b\u8981\u30aa\u30d7\u30b7\u30e7\u30f3                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  -d, --dbname=DBNAME      \u30ea\u30b9\u30c8\u30a2\u5148\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9             \u2502\n\u2502  -j, --jobs=NUM           \u4e26\u5217\u30ef\u30fc\u30ab\u30fc\u6570                     \u2502\n\u2502  -c, --clean              \u65e2\u5b58\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u524a\u9664             \u2502\n\u2502  --if-exists              DROP\u6642\u306b\u5b58\u5728\u30c1\u30a7\u30c3\u30af               \u2502\n\u2502  -C, --create             CREATE DATABASE\u542b\u3080                \u2502\n\u2502  -n, --schema=SCHEMA      \u7279\u5b9a\u30b9\u30ad\u30fc\u30de\u306e\u307f                   \u2502\n\u2502  -t, --table=TABLE        \u7279\u5b9a\u30c6\u30fc\u30d6\u30eb\u306e\u307f                   \u2502\n\u2502  -s, --schema-only        \u30b9\u30ad\u30fc\u30de\u306e\u307f                       \u2502\n\u2502  -a, --data-only          \u30c7\u30fc\u30bf\u306e\u307f                         \u2502\n\u2502  --no-owner               \u6240\u6709\u8005\u3092\u8a2d\u5b9a\u3057\u306a\u3044                 \u2502\n\u2502  --no-privileges          \u6a29\u9650\u3092\u8a2d\u5b9a\u3057\u306a\u3044                   \u2502\n\u2502  -l, --list               \u5185\u5bb9\u4e00\u89a7\u3092\u8868\u793a                     \u2502\n\u2502  -L, --use-list=FILE      \u30ea\u30b9\u30c8\u30a2\u3059\u308b\u9805\u76ee\u3092\u6307\u5b9a             \u2502\n\u2502  -v, --verbose            \u8a73\u7d30\u51fa\u529b                           \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h3,{id:"26-\u9078\u629e\u7684\u30ea\u30b9\u30c8\u30a2",children:"2.6 \u9078\u629e\u7684\u30ea\u30b9\u30c8\u30a2"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u5185\u5bb9\u3092\u78ba\u8a8d\npg_restore -l mydb_backup.dump > backup_contents.txt\n\n# backup_contents.txt \u3092\u7de8\u96c6\u3057\u3066\u4e0d\u8981\u306a\u884c\u3092\u30b3\u30e1\u30f3\u30c8\u30a2\u30a6\u30c8\n# \u4f8b: \u7279\u5b9a\u306e\u30c6\u30fc\u30d6\u30eb\u3060\u3051\u3092\u6b8b\u3059\n\n# \u7de8\u96c6\u3057\u305f\u30ea\u30b9\u30c8\u3067\u30ea\u30b9\u30c8\u30a2\npg_restore -h localhost -U postgres -d mydb -L backup_contents.txt mydb_backup.dump\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"3-\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7-pg_basebackup",children:"3. \u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 (pg_basebackup)"}),"\n",(0,r.jsx)(e.h3,{id:"31-pg_basebackup-\u306e\u57fa\u672c",children:"3.1 pg_basebackup \u306e\u57fa\u672c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u57fa\u672c\u7684\u306a\u4f7f\u3044\u65b9\npg_basebackup -h localhost -U postgres -D /backup/base -Fp -Xs -P\n\n# tar\u5f62\u5f0f\u3067\u5727\u7e2e\npg_basebackup -h localhost -U postgres -D /backup/base -Ft -z -Xs -P\n\n# \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u3092\u4f7f\u7528\npg_basebackup -h localhost -U postgres -D /backup/base -Fp -Xs -P -S backup_slot\n"})}),"\n",(0,r.jsx)(e.h3,{id:"32-pg_basebackup-\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",children:"3.2 pg_basebackup \u306e\u30aa\u30d7\u30b7\u30e7\u30f3"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                pg_basebackup \u4e3b\u8981\u30aa\u30d7\u30b7\u30e7\u30f3                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u63a5\u7d9a\u3011                                                    \u2502\n\u2502  -h, --host=HOSTNAME      \u30db\u30b9\u30c8\u540d                           \u2502\n\u2502  -p, --port=PORT          \u30dd\u30fc\u30c8\u756a\u53f7                         \u2502\n\u2502  -U, --username=NAME      \u30e6\u30fc\u30b6\u30fc\u540d                         \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u51fa\u529b\u3011                                                    \u2502\n\u2502  -D, --pgdata=DIRECTORY   \u51fa\u529b\u30c7\u30a3\u30ec\u30af\u30c8\u30ea                   \u2502\n\u2502  -F, --format=FORMAT                                         \u2502\n\u2502      p: plain (\u30c7\u30d5\u30a9\u30eb\u30c8\u3001\u30d5\u30a1\u30a4\u30eb\u305d\u306e\u307e\u307e)                 \u2502\n\u2502      t: tar\u5f62\u5f0f                                              \u2502\n\u2502  -z, --gzip               tar\u5f62\u5f0f\u3092\u5727\u7e2e                      \u2502\n\u2502  -Z, --compress=LEVEL     \u5727\u7e2e\u30ec\u30d9\u30eb (0-9)                   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010WAL\u3011                                                     \u2502\n\u2502  -X, --wal-method=METHOD                                     \u2502\n\u2502      n: none (WAL\u3092\u542b\u3081\u306a\u3044)                                 \u2502\n\u2502      f: fetch (\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u5f8c\u306b\u53d6\u5f97)                         \u2502\n\u2502      s: stream (\u4e26\u884c\u3057\u3066\u30b9\u30c8\u30ea\u30fc\u30e0\u3001\u63a8\u5968)                    \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8\u3011                                        \u2502\n\u2502  -c, --checkpoint=MODE                                       \u2502\n\u2502      fast: \u5373\u5ea7\u306b\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8 (\u63a8\u5968)                     \u2502\n\u2502      spread: \u901a\u5e38\u306e\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8                          \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u305d\u306e\u4ed6\u3011                                                  \u2502\n\u2502  -P, --progress           \u9032\u6357\u8868\u793a                           \u2502\n\u2502  -v, --verbose            \u8a73\u7d30\u51fa\u529b                           \u2502\n\u2502  -S, --slot=SLOT          \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u4f7f\u7528       \u2502\n\u2502  --no-verify-checksums    \u30c1\u30a7\u30c3\u30af\u30b5\u30e0\u691c\u8a3c\u3092\u30b9\u30ad\u30c3\u30d7         \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h3,{id:"33-\u524d\u63d0\u6761\u4ef6\u306e\u8a2d\u5b9a",children:"3.3 \u524d\u63d0\u6761\u4ef6\u306e\u8a2d\u5b9a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf\nwal_level = replica                 # \u307e\u305f\u306f logical\nmax_wal_senders = 10                # \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u7528\u306e\u63a5\u7d9a\u3092\u78ba\u4fdd\nmax_replication_slots = 10          # \u30b9\u30ed\u30c3\u30c8\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# pg_hba.conf\n# \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u63a5\u7d9a\u3092\u8a31\u53ef\nhost    replication     backup_user     192.168.1.0/24    scram-sha-256\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u7528\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210\nCREATE ROLE backup_user WITH\n    LOGIN\n    REPLICATION\n    PASSWORD 'backup_password';\n"})}),"\n",(0,r.jsx)(e.h3,{id:"34-\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304b\u3089\u306e\u30ea\u30b9\u30c8\u30a2",children:"3.4 \u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304b\u3089\u306e\u30ea\u30b9\u30c8\u30a2"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# 1. PostgreSQL\u3092\u505c\u6b62\nsudo systemctl stop postgresql-16\n\n# 2. \u65e2\u5b58\u30c7\u30fc\u30bf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u9000\u907f\nsudo mv /var/lib/pgsql/16/data /var/lib/pgsql/16/data.old\n\n# 3. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u30ea\u30b9\u30c8\u30a2\nsudo cp -r /backup/base /var/lib/pgsql/16/data\n\n# 4. \u6240\u6709\u8005\u3092\u5909\u66f4\nsudo chown -R postgres:postgres /var/lib/pgsql/16/data\n\n# 5. PostgreSQL\u3092\u8d77\u52d5\nsudo systemctl start postgresql-16\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"4-wal\u30a2\u30fc\u30ab\u30a4\u30d6",children:"4. WAL\u30a2\u30fc\u30ab\u30a4\u30d6"}),"\n",(0,r.jsx)(e.h3,{id:"41-wal\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u8a2d\u5b9a",children:"4.1 WAL\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u8a2d\u5b9a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   WAL\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u4ed5\u7d44\u307f                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  PostgreSQL                       \u30a2\u30fc\u30ab\u30a4\u30d6\u5148               \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510              \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510       \u2502\n\u2502  \u2502    pg_wal/      \u2502   archive    \u2502  /archive/      \u2502       \u2502\n\u2502  \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502   command    \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502       \u2502\n\u2502  \u2502 \u2502 00000001... \u2502 \u2502 \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192  \u2502 \u2502 00000001... \u2502 \u2502       \u2502\n\u2502  \u2502 \u2502 00000001... \u2502 \u2502              \u2502 \u2502 00000001... \u2502 \u2502       \u2502\n\u2502  \u2502 \u2502 00000001... \u2502 \u2502              \u2502 \u2502 00000001... \u2502 \u2502       \u2502\n\u2502  \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502              \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502       \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518              \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518       \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u6d41\u308c\u3011                                                    \u2502\n\u2502  1. WAL\u30bb\u30b0\u30e1\u30f3\u30c8\u304c\u5b8c\u4e86 (16MB\u5230\u9054\u307e\u305f\u306f\u5207\u308a\u66ff\u3048)             \u2502\n\u2502  2. archive_command\u304c\u5b9f\u884c\u3055\u308c\u308b                              \u2502\n\u2502  3. \u6210\u529f\u3059\u308c\u3070\u30bb\u30b0\u30e1\u30f3\u30c8\u306f\u30a2\u30fc\u30ab\u30a4\u30d6\u6e08\u307f\u3068\u30de\u30fc\u30af             \u2502\n\u2502  4. \u5931\u6557\u3059\u308c\u3070\u30ea\u30c8\u30e9\u30a4                                       \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf\n\n# \u30a2\u30fc\u30ab\u30a4\u30d6\u30e2\u30fc\u30c9\u3092\u6709\u52b9\u5316\narchive_mode = on\n\n# \u30a2\u30fc\u30ab\u30a4\u30d6\u30b3\u30de\u30f3\u30c9\n# %p = WAL\u30d5\u30a1\u30a4\u30eb\u306e\u30d5\u30eb\u30d1\u30b9\n# %f = WAL\u30d5\u30a1\u30a4\u30eb\u540d\u306e\u307f\narchive_command = 'cp %p /var/lib/pgsql/archive/%f'\n\n# \u30bf\u30a4\u30e0\u30a2\u30a6\u30c8 (\u79d2\u30010=\u7121\u52b9)\narchive_timeout = 300    # 5\u5206\u3054\u3068\u306b\u5f37\u5236\u7684\u306bWAL\u5207\u308a\u66ff\u3048\n"})}),"\n",(0,r.jsx)(e.h3,{id:"42-\u30a2\u30fc\u30ab\u30a4\u30d6\u5148\u306e\u30d0\u30ea\u30a8\u30fc\u30b7\u30e7\u30f3",children:"4.2 \u30a2\u30fc\u30ab\u30a4\u30d6\u5148\u306e\u30d0\u30ea\u30a8\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u30ed\u30fc\u30ab\u30eb\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306b\u30b3\u30d4\u30fc\narchive_command = 'cp %p /var/lib/pgsql/archive/%f'\n\n# rsync \u3067\u30ea\u30e2\u30fc\u30c8\u306b\u30b3\u30d4\u30fc\narchive_command = 'rsync -a %p backup_server:/archive/%f'\n\n# S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\narchive_command = 'aws s3 cp %p s3://my-bucket/wal/%f'\n\n# GCS\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\narchive_command = 'gsutil cp %p gs://my-bucket/wal/%f'\n\n# pgBackRest\u3092\u4f7f\u7528\narchive_command = 'pgbackrest --stanza=main archive-push %p'\n\n# \u8907\u6570\u306e\u5834\u6240\u306b\u30b3\u30d4\u30fc (\u5168\u3066\u6210\u529f\u3067\u6210\u529f)\narchive_command = 'cp %p /archive/%f && rsync -a %p remote:/archive/%f'\n"})}),"\n",(0,r.jsx)(e.h3,{id:"43-\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u76e3\u8996",children:"4.3 \u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u76e3\u8996"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u6700\u5f8c\u306b\u30a2\u30fc\u30ab\u30a4\u30d6\u3055\u308c\u305fWAL\nSELECT * FROM pg_stat_archiver;\n\n-- \u30a2\u30fc\u30ab\u30a4\u30d6\u5f85\u3061\u306eWAL\u6570\nSELECT count(*) FROM pg_ls_dir('pg_wal')\nWHERE pg_ls_dir ~ '^[0-9A-F]{24}$';\n\n-- \u73fe\u5728\u306eWAL\u4f4d\u7f6e\nSELECT pg_current_wal_lsn(), pg_walfile_name(pg_current_wal_lsn());\n"})}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# \u30a2\u30fc\u30ab\u30a4\u30d6\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u306e\u78ba\u8a8d\nls -la /var/lib/pgsql/archive/\n\n# \u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u5bb9\u91cf\u78ba\u8a8d\ndu -sh /var/lib/pgsql/archive/\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"5-pitr-point-in-time-recovery",children:"5. PITR (Point-In-Time Recovery)"}),"\n",(0,r.jsx)(e.h3,{id:"51-pitr\u306e\u6982\u5ff5",children:"5.1 PITR\u306e\u6982\u5ff5"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    PITR\u306e\u4ed5\u7d44\u307f                               \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u6642\u9593\u8ef8                                                      \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192      \u2502\n\u2502                                                              \u2502\n\u2502  \u30d9\u30fc\u30b9\u30d0\u30c3\u30af\u30a2\u30c3\u30d7      \u8aa4\u64cd\u4f5c        \u969c\u5bb3\u767a\u751f             \u2502\n\u2502        \u2193                  \u2193              \u2193                  \u2502\n\u2502        \u25cf\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25cf\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25cf                   \u2502\n\u2502        \u2502                  \u2502                                  \u2502\n\u2502        \u2502  WAL\u30a2\u30fc\u30ab\u30a4\u30d6   \u2502                                  \u2502\n\u2502        \u2502\u25c6\u25c6\u25c6\u25c6\u25c6\u25c6\u25c6\u25c6\u25c6\u25c6\u25c6\u25c6\u25c6\u25c6\u2502                                  \u2502\n\u2502        \u2502                  \u2502                                  \u2502\n\u2502        \u2502                  \u2193                                  \u2502\n\u2502        \u2502            \u3053\u3053\u306b\u5fa9\u65e7\uff01                             \u2502\n\u2502        \u2502                                                     \u2502\n\u2502        \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192 \u30d9\u30fc\u30b9\u30d0\u30c3\u30af\u30a2\u30c3\u30d7 + WAL\u9069\u7528\u3067\u5fa9\u65e7        \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u624b\u9806\u3011                                                    \u2502\n\u2502  1. \u30d9\u30fc\u30b9\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u30ea\u30b9\u30c8\u30a2                             \u2502\n\u2502  2. recovery.signal \u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210                           \u2502\n\u2502  3. postgresql.conf \u306b\u5fa9\u65e7\u8a2d\u5b9a\u3092\u8a18\u8ff0                         \u2502\n\u2502  4. PostgreSQL\u3092\u8d77\u52d5 \u2192 WAL\u3092\u9069\u7528\u3057\u3066\u5fa9\u65e7                     \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h3,{id:"52-pitr\u306e\u6e96\u5099",children:"5.2 PITR\u306e\u6e96\u5099"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# 1. \u30d9\u30fc\u30b9\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u53d6\u5f97\npg_basebackup -h localhost -U backup_user -D /backup/base_$(date +%Y%m%d) \\\n    -Fp -Xs -P -c fast\n\n# 2. WAL\u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u6b63\u5e38\u306b\u52d5\u4f5c\u3057\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d\nls -la /var/lib/pgsql/archive/\n\n# 3. \u5fa9\u65e7\u30dd\u30a4\u30f3\u30c8\u3092\u8a18\u9332\u3057\u3066\u304a\u304f\uff08\u4efb\u610f\uff09\npsql -c \"SELECT pg_create_restore_point('before_migration');\"\n"})}),"\n",(0,r.jsx)(e.h3,{id:"53-pitr\u306e\u5b9f\u884c",children:"5.3 PITR\u306e\u5b9f\u884c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# 1. PostgreSQL\u3092\u505c\u6b62\nsudo systemctl stop postgresql-16\n\n# 2. \u73fe\u5728\u306e\u30c7\u30fc\u30bf\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u9000\u907f\nsudo mv /var/lib/pgsql/16/data /var/lib/pgsql/16/data_damaged\n\n# 3. \u30d9\u30fc\u30b9\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u30ea\u30b9\u30c8\u30a2\nsudo cp -r /backup/base_20240101 /var/lib/pgsql/16/data\n\n# 4. \u6240\u6709\u8005\u3092\u5909\u66f4\nsudo chown -R postgres:postgres /var/lib/pgsql/16/data\n\n# 5. recovery.signal \u30d5\u30a1\u30a4\u30eb\u3092\u4f5c\u6210\nsudo touch /var/lib/pgsql/16/data/recovery.signal\nsudo chown postgres:postgres /var/lib/pgsql/16/data/recovery.signal\n\n# 6. postgresql.conf \u306b\u5fa9\u65e7\u8a2d\u5b9a\u3092\u8ffd\u52a0\nsudo -u postgres cat >> /var/lib/pgsql/16/data/postgresql.conf << 'EOF'\n\n# \u30ea\u30ab\u30d0\u30ea\u8a2d\u5b9a\nrestore_command = 'cp /var/lib/pgsql/archive/%f %p'\nrecovery_target_time = '2024-01-15 14:30:00+09'\nrecovery_target_action = 'promote'\nEOF\n\n# 7. PostgreSQL\u3092\u8d77\u52d5\nsudo systemctl start postgresql-16\n\n# 8. \u30ed\u30b0\u3092\u78ba\u8a8d\nsudo tail -f /var/lib/pgsql/16/data/log/postgresql-*.log\n"})}),"\n",(0,r.jsx)(e.h3,{id:"54-\u5fa9\u65e7\u30bf\u30fc\u30b2\u30c3\u30c8\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",children:"5.4 \u5fa9\u65e7\u30bf\u30fc\u30b2\u30c3\u30c8\u306e\u30aa\u30d7\u30b7\u30e7\u30f3"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf\n\n# \u6642\u523b\u3092\u6307\u5b9a\nrecovery_target_time = '2024-01-15 14:30:00+09'\n\n# \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3ID\u3092\u6307\u5b9a\nrecovery_target_xid = '12345678'\n\n# \u30ea\u30b9\u30c8\u30a2\u30dd\u30a4\u30f3\u30c8\u540d\u3092\u6307\u5b9a\nrecovery_target_name = 'before_migration'\n\n# LSN (Log Sequence Number) \u3092\u6307\u5b9a\nrecovery_target_lsn = '0/1234ABCD'\n\n# \u6307\u5b9a\u30dd\u30a4\u30f3\u30c8\u3092\u542b\u3080\u304b\nrecovery_target_inclusive = true   # \u30c7\u30d5\u30a9\u30eb\u30c8\n\n# \u5fa9\u65e7\u5b8c\u4e86\u5f8c\u306e\u30a2\u30af\u30b7\u30e7\u30f3\nrecovery_target_action = 'pause'    # \u4e00\u6642\u505c\u6b62 (\u78ba\u8a8d\u7528)\nrecovery_target_action = 'promote'  # \u901a\u5e38\u904b\u7528\u306b\u6607\u683c\nrecovery_target_action = 'shutdown' # \u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\n"})}),"\n",(0,r.jsx)(e.h3,{id:"55-\u5fa9\u65e7\u306e\u78ba\u8a8d\u3068\u5b8c\u4e86",children:"5.5 \u5fa9\u65e7\u306e\u78ba\u8a8d\u3068\u5b8c\u4e86"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u5fa9\u65e7\u72b6\u614b\u306e\u78ba\u8a8d (pause\u306e\u5834\u5408)\nSELECT pg_is_in_recovery();\n\n-- \u5fa9\u65e7\u3092\u5b8c\u4e86\u3057\u3066\u901a\u5e38\u904b\u7528\u306b\u79fb\u884c\nSELECT pg_wal_replay_resume();\n\n-- \u307e\u305f\u306f pg_promote() \u3067\u6607\u683c\nSELECT pg_promote();\n"})}),"\n",(0,r.jsx)(e.h3,{id:"56-\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306e\u7406\u89e3",children:"5.6 \u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306e\u7406\u89e3"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   \u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306e\u5206\u5c90                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  Timeline 1 (\u5143\u306e\u5c65\u6b74)                                       \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25cf\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192 (\u969c\u5bb3)        \u2502\n\u2502                                \u2502                             \u2502\n\u2502                           \u5fa9\u65e7\u30dd\u30a4\u30f3\u30c8                       \u2502\n\u2502                                \u2502                             \u2502\n\u2502                                \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192             \u2502\n\u2502                           Timeline 2 (\u65b0\u3057\u3044\u5c65\u6b74)            \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u3011                                            \u2502\n\u2502  - PITR\u3092\u884c\u3046\u3068\u65b0\u3057\u3044\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u304c\u4f5c\u6210\u3055\u308c\u308b                \u2502\n\u2502  - WAL\u30d5\u30a1\u30a4\u30eb\u540d: {\u30bf\u30a4\u30e0\u30e9\u30a4\u30f3ID}{LSN}                      \u2502\n\u2502  - \u4f8b: 00000002000000000000001A (\u30bf\u30a4\u30e0\u30e9\u30a4\u30f32)              \u2502\n\u2502                                                              \u2502\n\u2502  \u3010.history \u30d5\u30a1\u30a4\u30eb\u3011                                       \u2502\n\u2502  - \u30bf\u30a4\u30e0\u30e9\u30a4\u30f3\u306e\u5206\u5c90\u5c65\u6b74\u3092\u8a18\u9332                              \u2502\n\u2502  - \u4f8b: 00000002.history                                      \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"6-\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c",children:"6. \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c"}),"\n",(0,r.jsx)(e.h3,{id:"61-\u691c\u8a3c\u306e\u91cd\u8981\u6027",children:"6.1 \u691c\u8a3c\u306e\u91cd\u8981\u6027"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u691c\u8a3c\u306e\u5fc5\u8981\u6027                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u300c\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306f\u53d6\u3063\u3066\u3044\u305f\u304c\u3001\u30ea\u30b9\u30c8\u30a2\u3067\u304d\u306a\u304b\u3063\u305f\u300d        \u2502\n\u2502  \u3068\u3044\u3046\u4e8b\u6545\u306f\u5b9f\u969b\u306b\u8d77\u304d\u3066\u3044\u308b                                \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u3088\u304f\u3042\u308b\u5931\u6557\u3011                                            \u2502\n\u2502  - \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30d5\u30a1\u30a4\u30eb\u304c\u7834\u640d                                \u2502\n\u2502  - \u5fc5\u8981\u306aWAL\u30d5\u30a1\u30a4\u30eb\u304c\u6b20\u843d                                   \u2502\n\u2502  - \u30a2\u30fc\u30ab\u30a4\u30d6\u304c\u5931\u6557\u3057\u3066\u3044\u305f                                  \u2502\n\u2502  - \u30ea\u30b9\u30c8\u30a2\u624b\u9806\u3092\u8ab0\u3082\u77e5\u3089\u306a\u3044                                \u2502\n\u2502  - \u30ea\u30b9\u30c8\u30a2\u5148\u306e\u5bb9\u91cf\u4e0d\u8db3                                      \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u5b9a\u671f\u7684\u306b\u691c\u8a3c\u3059\u3079\u304d\u3053\u3068\u3011                                  \u2502\n\u2502  \u25a1 \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u304b\u3089\u30ea\u30b9\u30c8\u30a2\u3067\u304d\u308b\u304b                         \u2502\n\u2502  \u25a1 \u30ea\u30b9\u30c8\u30a2\u306b\u304b\u304b\u308b\u6642\u9593 (RTO\u5185\u304b)                           \u2502\n\u2502  \u25a1 \u30c7\u30fc\u30bf\u306e\u6574\u5408\u6027                                           \u2502\n\u2502  \u25a1 \u624b\u9806\u66f8\u304c\u6b63\u78ba\u304b                                           \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h3,{id:"62-\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c",children:"6.2 \u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"#!/bin/bash\n# backup_verify_logical.sh\n\nBACKUP_FILE=\"/backup/mydb_$(date +%Y%m%d).dump\"\nTEST_DB=\"mydb_verify_$(date +%Y%m%d)\"\n\n# \u30c6\u30b9\u30c8\u7528\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u4f5c\u6210\ncreatedb -h localhost -U postgres $TEST_DB\n\n# \u30ea\u30b9\u30c8\u30a2\npg_restore -h localhost -U postgres -d $TEST_DB $BACKUP_FILE\n\n# \u691c\u8a3c\u30af\u30a8\u30ea\npsql -h localhost -U postgres -d $TEST_DB << 'EOF'\n-- \u30c6\u30fc\u30d6\u30eb\u6570\u306e\u78ba\u8a8d\nSELECT count(*) AS table_count FROM information_schema.tables\nWHERE table_schema NOT IN ('pg_catalog', 'information_schema');\n\n-- \u5404\u30c6\u30fc\u30d6\u30eb\u306e\u884c\u6570\nSELECT schemaname, relname, n_live_tup\nFROM pg_stat_user_tables\nORDER BY n_live_tup DESC;\n\n-- \u4e3b\u8981\u30c6\u30fc\u30d6\u30eb\u306e\u30c1\u30a7\u30c3\u30af\u30b5\u30e0 (\u4f8b)\nSELECT md5(string_agg(id::text || email, '')) FROM users ORDER BY id;\nEOF\n\n# \u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\ndropdb -h localhost -U postgres $TEST_DB\n\necho \"Verification completed successfully\"\n"})}),"\n",(0,r.jsx)(e.h3,{id:"63-\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c",children:"6.3 \u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u691c\u8a3c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# backup_verify_physical.sh\n\nBACKUP_DIR="/backup/base_$(date +%Y%m%d)"\nVERIFY_DIR="/tmp/pg_verify"\nVERIFY_PORT="5433"\n\n# \u691c\u8a3c\u7528\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u3092\u4f5c\u6210\nrm -rf $VERIFY_DIR\ncp -r $BACKUP_DIR $VERIFY_DIR\n\n# \u8a2d\u5b9a\u3092\u8abf\u6574 (\u30dd\u30fc\u30c8\u5909\u66f4)\nsed -i "s/^port = .*/port = $VERIFY_PORT/" $VERIFY_DIR/postgresql.conf\n\n# \u30ea\u30ab\u30d0\u30ea\u306a\u3057\u3067\u8d77\u52d5 (recovery.signal\u3092\u4f5c\u6210\u3057\u306a\u3044)\n# \u307e\u305f\u306f\u3001\u6700\u65b0\u307e\u3067\u5fa9\u65e7\ntouch $VERIFY_DIR/recovery.signal\necho "restore_command = \'cp /var/lib/pgsql/archive/%f %p\'" >> $VERIFY_DIR/postgresql.conf\necho "recovery_target_action = \'promote\'" >> $VERIFY_DIR/postgresql.conf\n\n# \u8d77\u52d5\npg_ctl start -D $VERIFY_DIR -o "-p $VERIFY_PORT" -w\n\n# \u691c\u8a3c\npsql -h localhost -p $VERIFY_PORT -U postgres -c "SELECT count(*) FROM users;"\n\n# \u505c\u6b62\u3068\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\npg_ctl stop -D $VERIFY_DIR -m fast\nrm -rf $VERIFY_DIR\n\necho "Physical backup verification completed"\n'})}),"\n",(0,r.jsx)(e.h3,{id:"64-\u81ea\u52d5\u691c\u8a3c\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb",children:"6.4 \u81ea\u52d5\u691c\u8a3c\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# /etc/cron.d/pg_backup_verify\n\n# \u6bce\u9031\u65e5\u66dc\u65e5\u306e\u6df1\u591c2\u6642\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u691c\u8a3c\n0 2 * * 0 postgres /opt/scripts/backup_verify_physical.sh >> /var/log/pg_backup_verify.log 2>&1\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"7-\u904b\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u4f8b",children:"7. \u904b\u7528\u30b9\u30af\u30ea\u30d7\u30c8\u4f8b"}),"\n",(0,r.jsx)(e.h3,{id:"71-\u65e5\u6b21\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b9\u30af\u30ea\u30d7\u30c8",children:"7.1 \u65e5\u6b21\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b9\u30af\u30ea\u30d7\u30c8"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# /opt/scripts/pg_backup_logical.sh\n\nset -e\n\n# \u8a2d\u5b9a\nBACKUP_DIR="/backup/logical"\nRETENTION_DAYS=7\nPG_HOST="localhost"\nPG_USER="backup_user"\nDATABASES="myapp_prod"\n\n# \u65e5\u4ed8\nDATE=$(date +%Y%m%d_%H%M%S)\nLOG_FILE="/var/log/pg_backup/logical_${DATE}.log"\n\n# \u30ed\u30b0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\nmkdir -p $(dirname $LOG_FILE)\nmkdir -p $BACKUP_DIR\n\nexec > >(tee -a $LOG_FILE) 2>&1\n\necho "=== Logical Backup Started: $(date) ==="\n\nfor DB in $DATABASES; do\n    BACKUP_FILE="${BACKUP_DIR}/${DB}_${DATE}.dump"\n\n    echo "Backing up database: $DB"\n\n    pg_dump -h $PG_HOST -U $PG_USER \\\n        -Fc -Z 6 \\\n        -d $DB \\\n        -f $BACKUP_FILE\n\n    # \u30b5\u30a4\u30ba\u78ba\u8a8d\n    ls -lh $BACKUP_FILE\n\n    echo "Completed: $DB"\ndone\n\n# \u53e4\u3044\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u524a\u9664\necho "Cleaning up old backups (older than $RETENTION_DAYS days)"\nfind $BACKUP_DIR -name "*.dump" -mtime +$RETENTION_DAYS -delete\n\necho "=== Logical Backup Completed: $(date) ==="\n'})}),"\n",(0,r.jsx)(e.h3,{id:"72-\u65e5\u6b21\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b9\u30af\u30ea\u30d7\u30c8",children:"7.2 \u65e5\u6b21\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b9\u30af\u30ea\u30d7\u30c8"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# /opt/scripts/pg_backup_physical.sh\n\nset -e\n\n# \u8a2d\u5b9a\nBACKUP_BASE_DIR="/backup/physical"\nARCHIVE_DIR="/var/lib/pgsql/archive"\nRETENTION_DAYS=3\nPG_HOST="localhost"\nPG_USER="backup_user"\n\n# \u65e5\u4ed8\nDATE=$(date +%Y%m%d_%H%M%S)\nBACKUP_DIR="${BACKUP_BASE_DIR}/base_${DATE}"\nLOG_FILE="/var/log/pg_backup/physical_${DATE}.log"\n\n# \u30ed\u30b0\u30c7\u30a3\u30ec\u30af\u30c8\u30ea\u4f5c\u6210\nmkdir -p $(dirname $LOG_FILE)\nmkdir -p $BACKUP_BASE_DIR\n\nexec > >(tee -a $LOG_FILE) 2>&1\n\necho "=== Physical Backup Started: $(date) ==="\n\n# \u30d9\u30fc\u30b9\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97\necho "Starting pg_basebackup..."\npg_basebackup -h $PG_HOST -U $PG_USER \\\n    -D $BACKUP_DIR \\\n    -Fp -Xs -P \\\n    -c fast \\\n    --checkpoint=fast \\\n    --label="backup_${DATE}"\n\n# \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u30b5\u30a4\u30ba\ndu -sh $BACKUP_DIR\n\n# \u30a2\u30fc\u30ab\u30a4\u30d6WAL\u306e\u78ba\u8a8d\necho "Archive WAL files: $(ls $ARCHIVE_DIR | wc -l)"\n\n# \u53e4\u3044\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u306e\u524a\u9664\necho "Cleaning up old backups (older than $RETENTION_DAYS days)"\nfind $BACKUP_BASE_DIR -maxdepth 1 -name "base_*" -type d -mtime +$RETENTION_DAYS -exec rm -rf {} \\;\n\n# \u53e4\u3044WAL\u30a2\u30fc\u30ab\u30a4\u30d6\u306e\u524a\u9664 (\u6700\u65b0\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3088\u308a\u53e4\u3044\u3082\u306e)\n# pg_archivecleanup\u3092\u4f7f\u7528\nif [ -f "${BACKUP_DIR}/backup_label" ]; then\n    START_WAL=$(grep "START WAL LOCATION" ${BACKUP_DIR}/backup_label | awk \'{print $6}\' | tr -d \')\')\n    echo "Cleaning WAL archives older than: $START_WAL"\n    pg_archivecleanup $ARCHIVE_DIR $START_WAL\nfi\n\necho "=== Physical Backup Completed: $(date) ==="\n'})}),"\n",(0,r.jsx)(e.h3,{id:"73-cron\u3067\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u8a2d\u5b9a",children:"7.3 cron\u3067\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u8a2d\u5b9a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# /etc/cron.d/pg_backup\n\n# \u6bce\u65e5\u5348\u524d2\u6642\u306b\u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n0 2 * * * postgres /opt/scripts/pg_backup_physical.sh\n\n# \u6bce\u65e5\u5348\u524d3\u6642\u306b\u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\n0 3 * * * postgres /opt/scripts/pg_backup_logical.sh\n\n# \u6bce\u9031\u65e5\u66dc\u65e5\u306e\u5348\u524d4\u6642\u306b\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u691c\u8a3c\n0 4 * * 0 postgres /opt/scripts/pg_backup_verify.sh\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"8-\u30af\u30e9\u30a6\u30c9\u74b0\u5883\u3067\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7",children:"8. \u30af\u30e9\u30a6\u30c9\u74b0\u5883\u3067\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7"}),"\n",(0,r.jsx)(e.h3,{id:"81-aws-s3\u3078\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7",children:"8.1 AWS S3\u3078\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# pg_backup_to_s3.sh\n\nS3_BUCKET="s3://my-pg-backups"\nDATE=$(date +%Y%m%d_%H%M%S)\n\n# \u8ad6\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092S3\u3078\npg_dump -h localhost -U postgres -Fc mydb | \\\n    aws s3 cp - ${S3_BUCKET}/logical/mydb_${DATE}.dump\n\n# \u7269\u7406\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092S3\u3078 (tar\u5f62\u5f0f)\npg_basebackup -h localhost -U backup_user -Ft -z -D - | \\\n    aws s3 cp - ${S3_BUCKET}/physical/base_${DATE}.tar.gz\n'})}),"\n",(0,r.jsx)(e.h3,{id:"82-pgbackrest\u306e\u4f7f\u7528",children:"8.2 pgBackRest\u306e\u4f7f\u7528"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-bash",children:"# pgBackRest\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb (RHEL\u7cfb)\nsudo dnf install pgbackrest\n\n# /etc/pgbackrest/pgbackrest.conf\n[global]\nrepo1-path=/var/lib/pgbackrest\nrepo1-retention-full=2\nrepo1-retention-diff=7\n\n[main]\npg1-path=/var/lib/pgsql/16/data\n\n# postgresql.conf\narchive_command = 'pgbackrest --stanza=main archive-push %p'\n\n# \u30b9\u30c6\u30f3\u30b6\u306e\u521d\u671f\u5316\nsudo -u postgres pgbackrest --stanza=main stanza-create\n\n# \u30d5\u30eb\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\nsudo -u postgres pgbackrest --stanza=main --type=full backup\n\n# \u5dee\u5206\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\nsudo -u postgres pgbackrest --stanza=main --type=diff backup\n\n# \u30ea\u30b9\u30c8\u30a2\nsudo -u postgres pgbackrest --stanza=main restore\n\n# PITR\nsudo -u postgres pgbackrest --stanza=main --type=time \\\n    --target=\"2024-01-15 14:30:00\" restore\n"})}),"\n",(0,r.jsx)(e.h3,{id:"83-\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u306e\u307e\u3068\u3081",children:"8.3 \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565\u306e\u307e\u3068\u3081"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  \u63a8\u5968\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u6226\u7565                         \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u5c0f\u898f\u6a21 (\u301c100GB)\u3011                                        \u2502\n\u2502  - \u65e5\u6b21: pg_dump (\u30ab\u30b9\u30bf\u30e0\u5f62\u5f0f)                              \u2502\n\u2502  - \u4fdd\u6301: 7\u65e5\u9593                                               \u2502\n\u2502  - \u30aa\u30d5\u30b5\u30a4\u30c8: S3/GCS\u306b\u30b3\u30d4\u30fc                                \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u4e2d\u898f\u6a21 (100GB\u301c1TB)\u3011                                     \u2502\n\u2502  - \u65e5\u6b21: pg_basebackup + WAL\u30a2\u30fc\u30ab\u30a4\u30d6                       \u2502\n\u2502  - \u9031\u6b21: pg_dump (\u9577\u671f\u4fdd\u5b58\u7528)                                \u2502\n\u2502  - \u4fdd\u6301: \u7269\u74063\u65e5\u3001\u8ad6\u74064\u9031\u9593                                  \u2502\n\u2502  - PITR: \u5bfe\u5fdc                                                \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u5927\u898f\u6a21 (1TB\u301c)\u3011                                          \u2502\n\u2502  - pgBackRest\u307e\u305f\u306fBarman\u4f7f\u7528                                \u2502\n\u2502  - \u5897\u5206/\u5dee\u5206\u30d0\u30c3\u30af\u30a2\u30c3\u30d7                                     \u2502\n\u2502  - \u4e26\u5217\u30d0\u30c3\u30af\u30a2\u30c3\u30d7/\u30ea\u30b9\u30c8\u30a2                                 \u2502\n\u2502  - S3/GCS\u3078\u306e\u76f4\u63a5\u30d0\u30c3\u30af\u30a2\u30c3\u30d7                                \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u5171\u901a\u3011                                                    \u2502\n\u2502  - \u5b9a\u671f\u7684\u306a\u30ea\u30b9\u30c8\u30a2\u691c\u8a3c                                      \u2502\n\u2502  - \u76e3\u8996\u3068\u30a2\u30e9\u30fc\u30c8                                            \u2502\n\u2502  - \u624b\u9806\u66f8\u306e\u6574\u5099                                              \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\u53c2\u8003\u30ea\u30f3\u30af",children:"\u53c2\u8003\u30ea\u30f3\u30af"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/backup.html",children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 - \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u30ea\u30b9\u30c8\u30a2"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/app-pgdump.html",children:"pg_dump"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/app-pgbasebackup.html",children:"pg_basebackup"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/continuous-archiving.html",children:"WAL\u30a2\u30fc\u30ab\u30a4\u30d6"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://pgbackrest.org/",children:"pgBackRest"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.pgbarman.org/",children:"Barman"})}),"\n"]})]})}function i(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(o,{...n})}):o(n)}},28453:(n,e,s)=>{s.d(e,{R:()=>c,x:()=>p});var a=s(96540);const r={},l=a.createContext(r);function c(n){const e=a.useContext(l);return a.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function p(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:c(n.components),a.createElement(l.Provider,{value:e},n.children)}}}]);