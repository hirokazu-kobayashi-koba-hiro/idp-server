"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[7178],{66792:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>a,contentTitle:()=>c,default:()=>p,frontMatter:()=>d,metadata:()=>l,toc:()=>t});const l=JSON.parse('{"id":"content_08_ops/commercial-deployment/database","title":"PostgreSQL \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a","description":"idp-server \u306e\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u74b0\u5883\u3067\u5fc5\u8981\u306aPostgreSQL\u8a2d\u5b9a\u306e\u624b\u9806\u3068\u52d5\u4f5c\u78ba\u8a8d\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002","source":"@site/docs/content_08_ops/commercial-deployment/03-database.md","sourceDirName":"content_08_ops/commercial-deployment","slug":"/content_08_ops/commercial-deployment/database","permalink":"/idp-server/docs/content_08_ops/commercial-deployment/database","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_08_ops/commercial-deployment/03-database.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"docs","previous":{"title":"\u74b0\u5883\u5909\u6570\u30fb\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30d1\u30e9\u30e1\u30fc\u30bf\u8a2d\u5b9a","permalink":"/idp-server/docs/content_08_ops/commercial-deployment/environment-variables"},"next":{"title":"\u521d\u671f\u8a2d\u5b9a\u30fb\u30e6\u30fc\u30b6\u30fc\u30fb\u30ed\u30fc\u30eb\u7ba1\u7406","permalink":"/idp-server/docs/content_08_ops/commercial-deployment/initial-configuration"}}');var i=s(74848),r=s(28453);const d={},c="PostgreSQL \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a",a={},t=[{value:"\u624b\u9806\u6982\u8981",id:"\u624b\u9806\u6982\u8981",level:2},{value:"\ud83d\udee1\ufe0f \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30e6\u30fc\u30b6\u30fc\u8a2d\u5b9a",id:"\ufe0f-\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30e6\u30fc\u30b6\u30fc\u8a2d\u5b9a",level:2},{value:"1. \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",id:"1-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",level:3},{value:"\u26a0\ufe0f \u91cd\u8981: BYPASSRLS \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u306e\u8981\u4ef6",id:"\ufe0f-\u91cd\u8981-bypassrls-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u306e\u8981\u4ef6",level:4},{value:"2. \u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d",id:"2-\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d",level:3},{value:"3. \u63a5\u7d9a\u30c6\u30b9\u30c8",id:"3-\u63a5\u7d9a\u30c6\u30b9\u30c8",level:3},{value:"\u7ba1\u7406\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d",id:"\u7ba1\u7406\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d",level:4},{value:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d",id:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d",level:4},{value:"\ud83d\udee0\ufe0f Flyway\u306b\u3088\u308bDDL\u9069\u7528",id:"\ufe0f-flyway\u306b\u3088\u308bddl\u9069\u7528",level:2},{value:"\u30b9\u30ad\u30fc\u30de\u521d\u671f\u5316\u30fb\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",id:"\u30b9\u30ad\u30fc\u30de\u521d\u671f\u5316\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",level:3},{value:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u78ba\u8a8d",id:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u78ba\u8a8d",level:3},{value:"\ud83d\udd0d RLS\u8a2d\u5b9a\u78ba\u8a8d",id:"-rls\u8a2d\u5b9a\u78ba\u8a8d",level:2},{value:"1. RLS\u6709\u52b9\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d",id:"1-rls\u6709\u52b9\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d",level:3},{value:"2. RLS\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d",id:"2-rls\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d",level:3},{value:"\u2705 \u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u52d5\u4f5c\u78ba\u8a8d",id:"-\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u52d5\u4f5c\u78ba\u8a8d",level:2},{value:"1. \u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d",id:"1-\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d",level:3},{value:"\u7ba1\u7406\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d",id:"\u7ba1\u7406\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d-1",level:4},{value:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d",id:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d-1",level:4},{value:"3. \u52d5\u4f5c\u78ba\u8a8d\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8",id:"3-\u52d5\u4f5c\u78ba\u8a8d\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8",level:3},{value:"\ud83d\udd27 \u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",id:"-\u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",level:2},{value:"\u5fc5\u9808\u8a2d\u5b9a\u9805\u76ee",id:"\u5fc5\u9808\u8a2d\u5b9a\u9805\u76ee",level:3},{value:"\u63a5\u7d9a\u72b6\u6cc1\u78ba\u8a8d",id:"\u63a5\u7d9a\u72b6\u6cc1\u78ba\u8a8d",level:3},{value:"\u3088\u304f\u3042\u308b\u554f\u984c\u306e\u78ba\u8a8d",id:"\u3088\u304f\u3042\u308b\u554f\u984c\u306e\u78ba\u8a8d",level:3},{value:"\ud83d\udd17 \u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"-\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",input:"input",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,r.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"postgresql-\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a",children:"PostgreSQL \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a"})}),"\n",(0,i.jsx)(n.p,{children:"idp-server \u306e\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u74b0\u5883\u3067\u5fc5\u8981\u306aPostgreSQL\u8a2d\u5b9a\u306e\u624b\u9806\u3068\u52d5\u4f5c\u78ba\u8a8d\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002"}),"\n",(0,i.jsx)(n.h2,{id:"\u624b\u9806\u6982\u8981",children:"\u624b\u9806\u6982\u8981"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:["ControlPlane\u7528\u306eAdmin\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\uff08",(0,i.jsx)(n.code,{children:"idp_admin_user"})," - RLS BYPASS\u6a29\u9650\uff09"]}),"\n",(0,i.jsxs)(n.li,{children:["\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u306e\u30a2\u30d7\u30ea\u30e6\u30fc\u30b6\u30fc\uff08",(0,i.jsx)(n.code,{children:"idp_app_user"})," - RLS\u9069\u7528\uff09"]}),"\n"]}),"\n"]}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"Flyway\u306b\u3088\u308bDDL\u9069\u7528"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.strong,{children:"RLS\u52d5\u4f5c\u78ba\u8a8d"})}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30e6\u30fc\u30b6\u30fc\u8a2d\u5b9a",children:"\ud83d\udee1\ufe0f \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30e6\u30fc\u30b6\u30fc\u8a2d\u5b9a"}),"\n",(0,i.jsx)(n.h3,{id:"1-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",children:"1. \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u30fc\uff1a"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"idp_admin_user"}),": RLS BYPASS\u6a29\u9650\u4ed8\u304d\uff08\u30c6\u30ca\u30f3\u30c8\u6a2a\u65ad\u64cd\u4f5c\u53ef\u80fd\uff09"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"idp_app_user"}),": \u901a\u5e38\u6a29\u9650\uff08RLS\u9069\u7528\u3001\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\uff09"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a"}),"\n\u203b\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"export IDP_DB_ADMIN_USER=idp_admin_user\nexport IDP_DB_ADMIN_PASSWORD=idp_admin_user\nexport IDP_DB_APP_USER=idp_app_user\nexport IDP_DB_APP_PASSWORD=idp_app_user\nexport IDP_DB_HOST=localhost\nexport IDP_DB_PORT=5432\nexport IDP_DB_NAME=idpserver\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"PostgreSQL\u8a8d\u8a3c\u8a2d\u5b9a\uff08\u63a8\u5968\uff09"}),"\n\u30d1\u30b9\u30ef\u30fc\u30c9\u81ea\u52d5\u8a8d\u8a3c\u306e\u305f\u3081",(0,i.jsx)(n.code,{children:".pgpass"}),"\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u5b9a\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"cat > ~/.pgpass << 'EOF'\nlocalhost:5432:idpserver:idp_admin_user:idp_admin_user\nlocalhost:5432:idpserver:idp_app_user:idp_app_user\nEOF\nchmod 600 ~/.pgpass\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u30d5\u30a9\u30fc\u30de\u30c3\u30c8"}),": ",(0,i.jsx)(n.code,{children:"hostname:port:database:username:password"})]}),"\n",(0,i.jsx)(n.h4,{id:"\ufe0f-\u91cd\u8981-bypassrls-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u306e\u8981\u4ef6",children:"\u26a0\ufe0f \u91cd\u8981: BYPASSRLS \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u306e\u8981\u4ef6"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsxs)(n.strong,{children:["BYPASSRLS\u6a29\u9650\u3092\u6301\u3064\u30e6\u30fc\u30b6\u30fc\uff08",(0,i.jsx)(n.code,{children:"idp_admin_user"}),"\uff09\u3092\u4f5c\u6210\u3059\u308b\u306b\u306f\u3001\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u304c\u5fc5\u8981\u3067\u3059\u3002"]})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u30aa\u30f3\u30d7\u30ec\u30df\u30b9/Docker\u74b0\u5883"}),": PostgreSQL\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u30fc\uff08\u4f8b: ",(0,i.jsx)(n.code,{children:"postgres"}),", ",(0,i.jsx)(n.code,{children:"idpserver"}),"\uff09\u3067\u5b9f\u884c"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"AWS RDS\u74b0\u5883"}),": \u30de\u30b9\u30bf\u30fc\u30e6\u30fc\u30b6\u30fc\uff08",(0,i.jsx)(n.code,{children:"rds_superuser"}),"\u30ed\u30fc\u30eb\u3092\u6301\u3064\u30e6\u30fc\u30b6\u30fc\uff09\u3067\u5b9f\u884c"]}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u7406\u7531"}),": PostgreSQL\u3067\u306f\u3001BYPASSRLS\u306f\u5f37\u529b\u306a\u6a29\u9650\u3067\u3042\u308a\u3001Row Level Security\uff08RLS\uff09\u30dd\u30ea\u30b7\u30fc\u3092\u56de\u907f\u3067\u304d\u308b\u305f\u3081\u3001\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u30fc\u306e\u307f\u304c\u4ed8\u4e0e\u53ef\u80fd\u3067\u3059\u3002"]}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"\u30b9\u30af\u30ea\u30d7\u30c8\u3092\u4f7f\u7528\u3057\u3066\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\uff1a"})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# \u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u30fc/\u30de\u30b9\u30bf\u30fc\u30e6\u30fc\u30b6\u30fc\u3067\u5b9f\u884c\npsql -h $IDP_DB_HOST -p $IDP_DB_PORT -U <superuser> -d $IDP_DB_NAME -f ./libs/idp-server-database/postgresql/operation/01-create-users.sh\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Docker\u74b0\u5883\u306e\u5834\u5408"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"# postgres-user-init\u30b5\u30fc\u30d3\u30b9\u304c\u81ea\u52d5\u5b9f\u884c\uff08\u5185\u90e8\u3067\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u30fc\u8a8d\u8a3c\uff09\ndocker-compose up postgres-user-init\n"})}),"\n",(0,i.jsx)(n.h3,{id:"2-\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d",children:"2. \u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_ADMIN_USER -d $IDP_DB_NAME -f ./libs/idp-server-database/postgresql/operation/select-user-role.sql\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u203b ",(0,i.jsx)(n.code,{children:".pgpass"}),"\u8a2d\u5b9a\u6e08\u307f\u306e\u5834\u5408\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u306f\u4e0d\u8981"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"    rolname     | rolsuper | rolbypassrls | rolconnlimit\n----------------+----------+--------------+--------------\n idp_admin_user | f        | t            |           25\n idp_app_user   | f        | f            |           50\n(2 rows)\n"})}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"idp_admin_user"}),": ",(0,i.jsx)(n.code,{children:"rolbypassrls=t"})," \u3067RLS BYPASS\u6a29\u9650\u3042\u308a"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.code,{children:"idp_app_user"}),": ",(0,i.jsx)(n.code,{children:"rolbypassrls=f"})," \u3067RLS\u9069\u7528\u5bfe\u8c61"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"3-\u63a5\u7d9a\u30c6\u30b9\u30c8",children:"3. \u63a5\u7d9a\u30c6\u30b9\u30c8"}),"\n",(0,i.jsx)(n.h4,{id:"\u7ba1\u7406\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d",children:"\u7ba1\u7406\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_ADMIN_USER -d $IDP_DB_NAME -c "SELECT current_user, session_user;"\n'})}),"\n",(0,i.jsx)(n.h4,{id:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d",children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_APP_USER -d $IDP_DB_NAME -c "SELECT current_user, session_user;"\n'})}),"\n",(0,i.jsxs)(n.p,{children:["\u203b ",(0,i.jsx)(n.code,{children:".pgpass"}),"\u8a2d\u5b9a\u6e08\u307f\u306e\u5834\u5408\u3001\u30d1\u30b9\u30ef\u30fc\u30c9\u5165\u529b\u306f\u4e0d\u8981"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"# \u7ba1\u7406\u7528\u30e6\u30fc\u30b6\u30fc\n current_user   | session_user\n----------------+---------------\n idp_admin_user | idp_admin_user\n\n# \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\n current_user | session_user\n--------------+--------------\n idp_app_user | idp_app_user\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\ufe0f-flyway\u306b\u3088\u308bddl\u9069\u7528",children:"\ud83d\udee0\ufe0f Flyway\u306b\u3088\u308bDDL\u9069\u7528"}),"\n",(0,i.jsx)(n.h3,{id:"\u30b9\u30ad\u30fc\u30de\u521d\u671f\u5316\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",children:"\u30b9\u30ad\u30fc\u30de\u521d\u671f\u5316\u30fb\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"DB_TYPE=postgresql ./gradlew flywayClean flywayMigrate\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u78ba\u8a8d",children:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.p,{children:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5c65\u6b74\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:"./gradlew flywayInfo\n"})}),"\n",(0,i.jsx)(n.p,{children:'\u5168\u3066\u306eState\u304c "Success" \u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d'}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-rls\u8a2d\u5b9a\u78ba\u8a8d",children:"\ud83d\udd0d RLS\u8a2d\u5b9a\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.h3,{id:"1-rls\u6709\u52b9\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d",children:"1. RLS\u6709\u52b9\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_ADMIN_USER -d $IDP_DB_NAME -f ./libs/idp-server-database/postgresql/operation/select-rls-table.sql\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),": \u4ee5\u4e0b\u306e\u30c6\u30fc\u30d6\u30eb\u304c ",(0,i.jsx)(n.code,{children:"rls_enabled=true"})," \u3067\u8868\u793a\u3055\u308c\u308b"]}),"\n",(0,i.jsx)(n.h3,{id:"2-rls\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d",children:"2. RLS\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:"psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_ADMIN_USER -d $IDP_DB_NAME -f ./libs/idp-server-database/postgresql/operation/select-rls-policy.sql\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),": \u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u306e\u30dd\u30ea\u30b7\u30fc\u304c\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:" schemaname |       tablename        |      policyname       |        policy_condition\n------------+------------------------+-----------------------+------------------------------\n public     | client_configuration   | tenant_isolation_policy | (tenant_id = current_setting('app.tenant_id'::text))\n(29 rows)\n"})}),"\n",(0,i.jsxs)(n.p,{children:["\u5168\u30c6\u30fc\u30d6\u30eb\u3067 ",(0,i.jsx)(n.code,{children:"app.tenant_id"})," \u8a2d\u5b9a\u5024\u306b\u3088\u308b\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u304c\u5b9f\u88c5\u3055\u308c\u3066\u3044\u308b\u3053\u3068\u3092\u78ba\u8a8d"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u52d5\u4f5c\u78ba\u8a8d",children:"\u2705 \u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u52d5\u4f5c\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.h3,{id:"1-\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d",children:"1. \u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.h4,{id:"\u7ba1\u7406\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d-1",children:"\u7ba1\u7406\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_ADMIN_USER -d $IDP_DB_NAME -c "SELECT COUNT(*) FROM client_configuration;"\n'})}),"\n",(0,i.jsx)(n.h4,{id:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d-1",children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u63a5\u7d9a\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-shell",children:'psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_APP_USER -d $IDP_DB_NAME -c "SELECT COUNT(*) FROM client_configuration"\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),": \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u306fRLS\u9069\u7528\u306e\u305f\u3081\u3001\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u306b\u5fdc\u3058\u305f\u30c7\u30fc\u30bf\u306e\u307f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u306a\u3057\nSELECT COUNT(*) FROM tenant_invitation;\n-- \u7d50\u679c: count = 0 \u307e\u305f\u306f ERROR: app.tenant_id is not set\n\n-- \u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u3042\u308a (\u4f8b: \u30c6\u30ca\u30f3\u30c8A\u306eUUID\u8a2d\u5b9a)\nSET app.tenant_id = 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee';\nSELECT COUNT(*) FROM tenant_invitation;\n-- \u7d50\u679c: count = 3 (\u30c6\u30ca\u30f3\u30c8A\u306e\u30c7\u30fc\u30bf\u306e\u307f)\n\n-- \u7570\u306a\u308b\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a (\u4f8b: \u30c6\u30ca\u30f3\u30c8B\u306eUUID\u8a2d\u5b9a)\nSET app.tenant_id = 'bbbbbbbb-cccc-dddd-eeee-ffffffffffff';\nSELECT COUNT(*) FROM tenant_invitation;\n-- \u7d50\u679c: count = 5 (\u30c6\u30ca\u30f3\u30c8B\u306e\u30c7\u30fc\u30bf\u306e\u307f)\n"})}),"\n",(0,i.jsx)(n.h3,{id:"3-\u52d5\u4f5c\u78ba\u8a8d\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8",children:"3. \u52d5\u4f5c\u78ba\u8a8d\u30c1\u30a7\u30c3\u30af\u30dd\u30a4\u30f3\u30c8"}),"\n",(0,i.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc"}),": \u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u306b\u95a2\u4fc2\u306a\u304f\u5168\u30c7\u30fc\u30bf\u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc"}),": \u30c6\u30ca\u30f3\u30c8ID\u3092\u5909\u66f4\u3059\u308b\u3068\u3001\u898b\u3048\u308b\u30c7\u30fc\u30bf\u304c\u5909\u308f\u308b"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc"}),": \u30c6\u30ca\u30f3\u30c8ID\u672a\u8a2d\u5b9a\u6642\u306f\u30a8\u30e9\u30fc\u307e\u305f\u306f0\u4ef6"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc"}),": \u4ed6\u30c6\u30ca\u30f3\u30c8\u306e\u30c7\u30fc\u30bf\u306b\u30a2\u30af\u30bb\u30b9\u3067\u304d\u306a\u3044"]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-\u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",children:"\ud83d\udd27 \u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8"}),"\n",(0,i.jsx)(n.h3,{id:"\u5fc5\u9808\u8a2d\u5b9a\u9805\u76ee",children:"\u5fc5\u9808\u8a2d\u5b9a\u9805\u76ee"}),"\n",(0,i.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u5b8c\u4e86"}),": ",(0,i.jsx)(n.code,{children:"idp_admin_user"}),", ",(0,i.jsx)(n.code,{children:"idp_app_user"})," \u4f5c\u6210\u6e08\u307f"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"\u6a29\u9650\u8a2d\u5b9a\u5b8c\u4e86"}),": \u7ba1\u7406\u7528(DDL) vs \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528(DML) \u6a29\u9650\u5206\u96e2"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"\u63a5\u7d9a\u30c6\u30b9\u30c8\u6210\u529f"}),": \u5404\u30e6\u30fc\u30b6\u30fc\u3067\u6b63\u5e38\u63a5\u7d9a\u78ba\u8a8d"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"Flyway\u5b9f\u884c\u5b8c\u4e86"}),": ",(0,i.jsx)(n.code,{children:"flywayClean"})," \u2192 ",(0,i.jsx)(n.code,{children:"flywayMigrate"})," \u6b63\u5e38\u5b8c\u4e86"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"RLS\u78ba\u8a8d\u5b8c\u4e86"}),": \u4e3b\u8981\u30c6\u30fc\u30d6\u30eb\u3067RLS\u6709\u52b9\u5316\u78ba\u8a8d"]}),"\n",(0,i.jsxs)(n.li,{className:"task-list-item",children:[(0,i.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,i.jsx)(n.strong,{children:"\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u78ba\u8a8d"}),": \u7570\u306a\u308b\u30c6\u30ca\u30f3\u30c8ID\u3067\u30c7\u30fc\u30bf\u5206\u96e2\u78ba\u8a8d"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u63a5\u7d9a\u72b6\u6cc1\u78ba\u8a8d",children:"\u63a5\u7d9a\u72b6\u6cc1\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u73fe\u5728\u306e\u63a5\u7d9a\u72b6\u6cc1\nSELECT\n  datname,\n  usename,\n  client_addr,\n  state,\n  query_start\nFROM pg_stat_activity\nWHERE datname = 'idpserver'\nORDER BY query_start DESC;\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u3088\u304f\u3042\u308b\u554f\u984c\u306e\u78ba\u8a8d",children:"\u3088\u304f\u3042\u308b\u554f\u984c\u306e\u78ba\u8a8d"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-sql",children:"-- \u30e6\u30fc\u30b6\u30fc\u5b58\u5728\u78ba\u8a8d\nSELECT usename, usesuper, usecreatedb\nFROM pg_user\nWHERE usename IN ('idp_admin_user', 'idp_app_user');\n\n-- \u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d\nSELECT grantee, table_name, privilege_type\nFROM information_schema.table_privileges\nWHERE grantee IN ('idp_admin_user', 'idp_app_user')\nORDER BY grantee, table_name;\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u30e6\u30fc\u30b6\u30fc\u5b58\u5728\u78ba\u8a8d"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"   usename     | usesuper | usecreatedb\n---------------+----------+-------------\n idp_admin_user| f        | f\n idp_app_user  | f        | f\n(2 rows)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d"}),": \u4e21\u30e6\u30fc\u30b6\u30fc\u304c\u5168\u30c6\u30fc\u30d6\u30eb\u306b\u5bfe\u3057\u3066SELECT, INSERT, UPDATE, DELETE\u6a29\u9650\u3092\u6301\u3063\u3066\u3044\u308b\u3053\u3068"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"    grantee     |       table_name       | privilege_type\n----------------+------------------------+----------------\n idp_admin_user | client_configuration   | SELECT\n idp_admin_user | client_configuration   | INSERT\n idp_admin_user | client_configuration   | UPDATE\n idp_admin_user | client_configuration   | DELETE\n idp_app_user   | client_configuration   | SELECT\n idp_app_user   | client_configuration   | INSERT\n (\u7d9a\u304f...)\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"-\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"\ud83d\udd17 \u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/idp-server/docs/content_08_ops/commercial-deployment/overview",children:"\u30c7\u30d7\u30ed\u30a4\u6982\u8981"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/idp-server/docs/content_08_ops/commercial-deployment/environment-variables",children:"\u74b0\u5883\u5909\u6570\u8a2d\u5b9a"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/idp-server/docs/content_08_ops/commercial-deployment/initial-configuration",children:"\u521d\u671f\u8a2d\u5b9a\u30fb\u30e6\u30fc\u30b6\u30fc\u30fb\u30ed\u30fc\u30eb"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/idp-server/docs/content_08_ops/commercial-deployment/operational-guidance",children:"\u904b\u7528\u30ac\u30a4\u30c0\u30f3\u30b9"})}),"\n"]})]})}function p(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(o,{...e})}):o(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>d,x:()=>c});var l=s(96540);const i={},r=l.createContext(i);function d(e){const n=l.useContext(r);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:d(e.components),l.createElement(r.Provider,{value:n},e.children)}}}]);