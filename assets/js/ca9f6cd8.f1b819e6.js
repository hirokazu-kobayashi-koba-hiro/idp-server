"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[8059],{49672:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>l,default:()=>h,frontMatter:()=>t,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"content_06_developer-guide/application-plane/userinfo","title":"UserInfo\u5b9f\u88c5\u30ac\u30a4\u30c9","description":"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u76ee\u7684","source":"@site/docs/content_06_developer-guide/03-application-plane/05-userinfo.md","sourceDirName":"content_06_developer-guide/03-application-plane","slug":"/content_06_developer-guide/application-plane/userinfo","permalink":"/idp-server/docs/content_06_developer-guide/application-plane/userinfo","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_06_developer-guide/03-application-plane/05-userinfo.md","tags":[],"version":"current","sidebarPosition":5,"frontMatter":{},"sidebar":"docs","previous":{"title":"\u8a8d\u8a3c\u5b9f\u88c5\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_06_developer-guide/application-plane/authentication"},"next":{"title":"CIBA Flow\u5b9f\u88c5\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_06_developer-guide/application-plane/ciba-flow"}}');var i=r(74848),o=r(28453);const t={},l="UserInfo\u5b9f\u88c5\u30ac\u30a4\u30c9",c={},d=[{value:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u76ee\u7684",id:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u76ee\u7684",level:2},{value:"\u6240\u8981\u6642\u9593",id:"\u6240\u8981\u6642\u9593",level:3},{value:"\u524d\u63d0\u77e5\u8b58",id:"\u524d\u63d0\u77e5\u8b58",level:3},{value:"UserInfo\u3068\u306f",id:"userinfo\u3068\u306f",level:2},{value:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u5168\u4f53\u50cf",id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u5168\u4f53\u50cf",level:2},{value:"30\u79d2\u3067\u7406\u89e3\u3059\u308b\u5168\u4f53\u50cf",id:"30\u79d2\u3067\u7406\u89e3\u3059\u308b\u5168\u4f53\u50cf",level:3},{value:"\u4e3b\u8981\u30af\u30e9\u30b9\u306e\u8cac\u52d9",id:"\u4e3b\u8981\u30af\u30e9\u30b9\u306e\u8cac\u52d9",level:3},{value:"Delegate\u30d1\u30bf\u30fc\u30f3",id:"delegate\u30d1\u30bf\u30fc\u30f3",level:3},{value:"\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8",id:"\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8",level:2},{value:"\u30d5\u30ed\u30fc",id:"\u30d5\u30ed\u30fc",level:2},{value:"EntryService\u5b9f\u88c5",id:"entryservice\u5b9f\u88c5",level:2},{value:"UserinfoDelegate \u30d1\u30bf\u30fc\u30f3",id:"userinfodelegate-\u30d1\u30bf\u30fc\u30f3",level:2},{value:"Core\u5c64\u304b\u3089\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af",id:"core\u5c64\u304b\u3089\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af",level:3},{value:"Scope\u5225\u306e\u8fd4\u5374Claims",id:"scope\u5225\u306e\u8fd4\u5374claims",level:2},{value:"Access Token\u691c\u8a3c",id:"access-token\u691c\u8a3c",level:2},{value:"\u691c\u8a3c\u9805\u76ee",id:"\u691c\u8a3c\u9805\u76ee",level:3},{value:"\u691c\u8a3c\u30a8\u30e9\u30fc",id:"\u691c\u8a3c\u30a8\u30e9\u30fc",level:3},{value:"Claims\u62bd\u51fa\u30ed\u30b8\u30c3\u30af",id:"claims\u62bd\u51fa\u30ed\u30b8\u30c3\u30af",level:2},{value:"Scope \u2192 Claims \u30de\u30c3\u30d4\u30f3\u30b0",id:"scope--claims-\u30de\u30c3\u30d4\u30f3\u30b0",level:3},{value:"\u6700\u5c0f\u9650\u306e\u30ec\u30b9\u30dd\u30f3\u30b9",id:"\u6700\u5c0f\u9650\u306e\u30ec\u30b9\u30dd\u30f3\u30b9",level:3},{value:"\u3088\u304f\u3042\u308b\u30a8\u30e9\u30fc",id:"\u3088\u304f\u3042\u308b\u30a8\u30e9\u30fc",level:2},{value:"\u30a8\u30e9\u30fc1: <code>invalid_token</code> - \u7121\u52b9\u306aAccess Token",id:"\u30a8\u30e9\u30fc1-invalid_token---\u7121\u52b9\u306aaccess-token",level:3},{value:"\u30a8\u30e9\u30fc2: Claims\u304c\u8fd4\u5374\u3055\u308c\u306a\u3044",id:"\u30a8\u30e9\u30fc2-claims\u304c\u8fd4\u5374\u3055\u308c\u306a\u3044",level:3},{value:"\u6b21\u306e\u30b9\u30c6\u30c3\u30d7",id:"\u6b21\u306e\u30b9\u30c6\u30c3\u30d7",level:2},{value:"\ud83d\udcd6 \u6b21\u306b\u8aad\u3080\u3079\u304d\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"-\u6b21\u306b\u8aad\u3080\u3079\u304d\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:3},{value:"\ud83d\udd17 \u8a73\u7d30\u60c5\u5831",id:"-\u8a73\u7d30\u60c5\u5831",level:3}];function a(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,o.R)(),...e.components};return(0,i.jsxs)(i.Fragment,{children:[(0,i.jsx)(n.header,{children:(0,i.jsx)(n.h1,{id:"userinfo\u5b9f\u88c5\u30ac\u30a4\u30c9",children:"UserInfo\u5b9f\u88c5\u30ac\u30a4\u30c9"})}),"\n",(0,i.jsx)(n.h2,{id:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u76ee\u7684",children:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u76ee\u7684"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"UserInfo\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8"}),"\uff08\u30e6\u30fc\u30b6\u30fc\u60c5\u5831\u53d6\u5f97\uff09\u306e\u5b9f\u88c5\u3092\u7406\u89e3\u3059\u308b\u3053\u3068\u304c\u76ee\u6a19\u3067\u3059\u3002"]}),"\n",(0,i.jsx)(n.h3,{id:"\u6240\u8981\u6642\u9593",children:"\u6240\u8981\u6642\u9593"}),"\n",(0,i.jsxs)(n.p,{children:["\u23f1\ufe0f ",(0,i.jsx)(n.strong,{children:"\u7d0420\u5206"})]}),"\n",(0,i.jsx)(n.h3,{id:"\u524d\u63d0\u77e5\u8b58",children:"\u524d\u63d0\u77e5\u8b58"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"/idp-server/docs/content_06_developer-guide/application-plane/token-endpoint",children:"03. Token Flow"})}),"\n",(0,i.jsx)(n.li,{children:"OpenID Connect\u57fa\u790e\u77e5\u8b58"}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"userinfo\u3068\u306f",children:"UserInfo\u3068\u306f"}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"Access Token\u3092\u4f7f\u3063\u3066\u30e6\u30fc\u30b6\u30fc\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8"})}),"\n",(0,i.jsx)(n.p,{children:(0,i.jsx)(n.strong,{children:"OpenID Connect Core 1.0 Section 5.3\u6e96\u62e0"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u5168\u4f53\u50cf",children:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u5168\u4f53\u50cf"}),"\n",(0,i.jsx)(n.h3,{id:"30\u79d2\u3067\u7406\u89e3\u3059\u308b\u5168\u4f53\u50cf",children:"30\u79d2\u3067\u7406\u89e3\u3059\u308b\u5168\u4f53\u50cf"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"HTTP\u30ea\u30af\u30a8\u30b9\u30c8\uff08Access Token\uff09\n    \u2193\nController (UserinfoV1Api) - HTTP\u51e6\u7406\n    \u2193\nEntryService (UserinfoEntryService) - \u30aa\u30fc\u30b1\u30b9\u30c8\u30ec\u30fc\u30b7\u30e7\u30f3\n    \u251c\u2500 Tenant\u53d6\u5f97\n    \u251c\u2500 UserinfoRequest\u4f5c\u6210\n    \u251c\u2500 UserinfoProtocol.request()\uff08Delegate\u6e21\u3057\uff09\n    \u2514\u2500 \u30a4\u30d9\u30f3\u30c8\u767a\u884c\n    \u2193\nCore\u5c64 (UserinfoProtocol)\n    \u251c\u2500 Access Token\u691c\u8a3c\uff08\u7f72\u540d\u30fb\u671f\u9650\u30fb\u5931\u52b9\u30c1\u30a7\u30c3\u30af\uff09\n    \u251c\u2500 Subject\u62bd\u51fa\n    \u251c\u2500 Delegate.findUser() \u547c\u3073\u51fa\u3057\n    \u251c\u2500 Scope\u5225Claims\u62bd\u51fa\n    \u2514\u2500 \u30ec\u30b9\u30dd\u30f3\u30b9\u751f\u6210\n    \u2193\nUseCase\u5c64 (UserinfoDelegate.findUser())\n    \u2514\u2500 UserQueryRepository.get()\n    \u2193\n\u30e6\u30fc\u30b6\u30fc\u60c5\u5831\u8fd4\u5374\n"})}),"\n",(0,i.jsx)(n.h3,{id:"\u4e3b\u8981\u30af\u30e9\u30b9\u306e\u8cac\u52d9",children:"\u4e3b\u8981\u30af\u30e9\u30b9\u306e\u8cac\u52d9"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"\u30af\u30e9\u30b9"}),(0,i.jsx)(n.th,{children:"\u5c64"}),(0,i.jsx)(n.th,{children:"\u5f79\u5272"}),(0,i.jsx)(n.th,{children:"\u5b9f\u88c5"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"UserinfoV1Api"})}),(0,i.jsx)(n.td,{children:"Controller"}),(0,i.jsx)(n.td,{children:"HTTP\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(83126).A+"",children:"UserinfoV1Api.java"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"UserinfoEntryService"})}),(0,i.jsx)(n.td,{children:"UseCase"}),(0,i.jsx)(n.td,{children:"\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u30fbDelegate\u5b9f\u88c5"}),(0,i.jsx)(n.td,{children:(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(28062).A+"#L62-L114",children:"UserinfoEntryService.java:62-114"})})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"UserinfoProtocol"})}),(0,i.jsx)(n.td,{children:"Core"}),(0,i.jsx)(n.td,{children:"Access Token\u691c\u8a3c\u30fbClaims\u62bd\u51fa"}),(0,i.jsx)(n.td,{children:"Core"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"UserinfoDelegate"})}),(0,i.jsx)(n.td,{children:"Interface"}),(0,i.jsx)(n.td,{children:"Core\u5c64\u2192UseCase\u5c64\u30b3\u30fc\u30eb\u30d0\u30c3\u30af"}),(0,i.jsx)(n.td,{children:"Core"})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.strong,{children:"OAuthToken"})}),(0,i.jsx)(n.td,{children:"Core"}),(0,i.jsx)(n.td,{children:"Access Token\u60c5\u5831\uff08subject/scope\uff09"}),(0,i.jsx)(n.td,{children:"Core Domain"})]})]})]}),"\n",(0,i.jsx)(n.h3,{id:"delegate\u30d1\u30bf\u30fc\u30f3",children:"Delegate\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u91cd\u8981"}),": Core\u5c64\u306fRepository\u306b\u76f4\u63a5\u4f9d\u5b58\u3057\u306a\u3044\u8a2d\u8a08"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"Core\u5c64 (UserinfoProtocol)\n    \u2193 Delegate\u7d4c\u7531\nUseCase\u5c64 (UserinfoEntryService.findUser())\n    \u2193\nRepository\u5c64 (UserQueryRepository)\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u7406\u7531"}),": Hexagonal Architecture\u306e\u539f\u5247\uff08Core\u5c64\u306e\u72ec\u7acb\u6027\u7dad\u6301\uff09"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8",children:"\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:"GET /{tenant-id}/v1/userinfo\nAuthorization: Bearer eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9...\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u5b9f\u88c5"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(83126).A+"",children:"UserinfoV1Api.java"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(28062).A+"",children:"UserinfoEntryService.java"})}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u30d5\u30ed\u30fc",children:"\u30d5\u30ed\u30fc"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'1. [\u30af\u30e9\u30a4\u30a2\u30f3\u30c8] Access Token\u53d6\u5f97\u6e08\u307f\n   \u2193\n2. [\u30af\u30e9\u30a4\u30a2\u30f3\u30c8] UserInfo\u30ea\u30af\u30a8\u30b9\u30c8\nGET /{tenant-id}/v1/userinfo\nAuthorization: Bearer eyJ...\n   \u2193\n3. [UserinfoEntryService] \u30ea\u30af\u30a8\u30b9\u30c8\u53d7\u4fe1\n   \u2193\n4. [UserinfoProtocol] Access Token\u691c\u8a3c\n   \u2193\n5. [UserQueryRepository] \u30e6\u30fc\u30b6\u30fc\u60c5\u5831\u53d6\u5f97\n   \u2193\n6. [Scope\u691c\u8a3c] \u8fd4\u5374\u53ef\u80fd\u306aClaims\u3092\u30d5\u30a3\u30eb\u30bf\n   \u2193\n7. [\u30ec\u30b9\u30dd\u30f3\u30b9] \u30e6\u30fc\u30b6\u30fc\u60c5\u5831\u8fd4\u5374\n{\n  "sub": "user-12345",\n  "name": "John Doe",\n  "email": "john@example.com",\n  "email_verified": true\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"entryservice\u5b9f\u88c5",children:"EntryService\u5b9f\u88c5"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u5b9f\u88c5"}),": ",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(28062).A+"#L62",children:"UserinfoEntryService.java:62"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"@Transaction(readOnly = true)  // \u2705 \u8aad\u307f\u53d6\u308a\u5c02\u7528\npublic class UserinfoEntryService implements UserinfoApi, UserinfoDelegate {\n\n  UserinfoProtocols userinfoProtocols;\n  UserQueryRepository userQueryRepository;\n  TenantQueryRepository tenantQueryRepository;\n  UserEventPublisher eventPublisher;\n\n  @Override\n  public UserinfoRequestResponse request(\n      TenantIdentifier tenantIdentifier,\n      String authorizationHeader,\n      String clientCert,\n      RequestAttributes requestAttributes) {\n\n    // 1. Tenant\u53d6\u5f97\n    Tenant tenant = tenantQueryRepository.get(tenantIdentifier);\n\n    // 2. UserinfoRequest\u4f5c\u6210\n    UserinfoRequest userinfoRequest = new UserinfoRequest(tenant, authorizationHeader);\n    userinfoRequest.setClientCert(clientCert);  // MTLS\u5bfe\u5fdc\n\n    // 3. Core\u5c64\u306b\u59d4\u8b72\n    UserinfoProtocol userinfoProtocol = userinfoProtocols.get(tenant.authorizationProvider());\n    UserinfoRequestResponse result = userinfoProtocol.request(userinfoRequest, this);\n\n    // 4. \u30a4\u30d9\u30f3\u30c8\u767a\u884c\uff08\u6210\u529f\u6642\uff09\n    if (result.isOK()) {\n      eventPublisher.publish(\n          tenant,\n          result.oAuthToken(),\n          DefaultSecurityEventType.userinfo_success,\n          requestAttributes);\n    }\n\n    return result;\n  }\n\n  // \u2705 Delegate\u5b9f\u88c5: Core\u5c64\u304b\u3089\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\n  @Override\n  public User findUser(Tenant tenant, Subject subject) {\n    UserIdentifier userIdentifier = new UserIdentifier(subject.value());\n    return userQueryRepository.get(tenant, userIdentifier);\n  }\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u30dd\u30a4\u30f3\u30c8"}),":"]}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsxs)(n.li,{children:["\u2705 ",(0,i.jsx)(n.code,{children:"@Transaction(readOnly = true)"}),": \u8aad\u307f\u53d6\u308a\u5c02\u7528\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3"]}),"\n",(0,i.jsxs)(n.li,{children:["\u2705 ",(0,i.jsx)(n.code,{children:"UserinfoDelegate"}),"\u5b9f\u88c5: Core\u5c64\u3078\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af\u63d0\u4f9b"]}),"\n",(0,i.jsxs)(n.li,{children:["\u2705 \u30a4\u30d9\u30f3\u30c8\u767a\u884c: ",(0,i.jsx)(n.code,{children:"userinfo_success"})]}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"userinfodelegate-\u30d1\u30bf\u30fc\u30f3",children:"UserinfoDelegate \u30d1\u30bf\u30fc\u30f3"}),"\n",(0,i.jsx)(n.h3,{id:"core\u5c64\u304b\u3089\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af",children:"Core\u5c64\u304b\u3089\u306e\u30b3\u30fc\u30eb\u30d0\u30c3\u30af"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:"public interface UserinfoDelegate {\n  /**\n   * Core\u5c64\u304c\u30e6\u30fc\u30b6\u30fc\u60c5\u5831\u3092\u53d6\u5f97\u3059\u308b\u969b\u306b\u547c\u3073\u51fa\u3059\n   */\n  User findUser(Tenant tenant, Subject subject);\n}\n"})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u5b9f\u88c5\u4f8b\uff08Core\u5c64\uff09"}),":"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u5b9f\u88c5"}),": ",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(13613).A+"#L58-L90",children:"UserinfoHandler.java:58-90"})]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-java",children:'public class UserinfoHandler {\n\n  OAuthTokenQueryRepository oAuthTokenQueryRepository;\n  AuthorizationServerConfigurationQueryRepository authorizationServerConfigurationQueryRepository;\n  ClientConfigurationQueryRepository clientConfigurationQueryRepository;\n  UserinfoCustomIndividualClaimsCreators userinfoCustomIndividualClaimsCreators;\n\n  public UserinfoRequestResponse handle(UserinfoRequest request, UserinfoDelegate delegate) {\n\n    // 1. Validator: \u5165\u529b\u5f62\u5f0f\u30c1\u30a7\u30c3\u30af\n    AccessTokenEntity accessTokenEntity = request.toAccessToken();\n    Tenant tenant = request.tenant();\n\n    UserinfoValidator validator = new UserinfoValidator(request);\n    validator.validate();\n\n    // 2. Access Token\u53d6\u5f97\n    OAuthToken oAuthToken = oAuthTokenQueryRepository.find(tenant, accessTokenEntity);\n\n    if (!oAuthToken.exists()) {\n      throw new TokenInvalidException("not found token");\n    }\n\n    // 3. \u8a2d\u5b9a\u53d6\u5f97\n    AuthorizationServerConfiguration authorizationServerConfiguration =\n        authorizationServerConfigurationQueryRepository.get(tenant);\n    ClientConfiguration clientConfiguration =\n        clientConfigurationQueryRepository.get(tenant, oAuthToken.requestedClientId());\n\n    // 4. Delegate\u7d4c\u7531\u3067\u30e6\u30fc\u30b6\u30fc\u53d6\u5f97\n    User user = delegate.findUser(tenant, oAuthToken.subject());\n\n    // 5. Verifier: \u30d3\u30b8\u30cd\u30b9\u30eb\u30fc\u30eb\u691c\u8a3c\n    UserinfoVerifier verifier = new UserinfoVerifier(oAuthToken, request.toClientCert(), user);\n    verifier.verify();\n\n    // 6. Claims\u62bd\u51fa\uff08Scope\u5225\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\uff09\n    UserinfoClaimsCreator claimsCreator =\n        new UserinfoClaimsCreator(\n            user,\n            oAuthToken.authorizationGrant(),\n            authorizationServerConfiguration,\n            clientConfiguration,\n            userinfoCustomIndividualClaimsCreators);\n    Map<String, Object> claims = claimsCreator.createClaims();\n\n    // 7. \u30ec\u30b9\u30dd\u30f3\u30b9\u751f\u6210\n    UserinfoResponse userinfoResponse = new UserinfoResponse(user, claims);\n    return new UserinfoRequestResponse(UserinfoRequestStatus.OK, oAuthToken, userinfoResponse);\n  }\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u51e6\u7406\u306e7\u30b9\u30c6\u30c3\u30d7"}),":"]}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsx)(n.li,{children:"Validator: \u5165\u529b\u5f62\u5f0f\u30c1\u30a7\u30c3\u30af"}),"\n",(0,i.jsx)(n.li,{children:"Access Token\u53d6\u5f97\uff08OAuthTokenQueryRepository\uff09"}),"\n",(0,i.jsx)(n.li,{children:"\u8a2d\u5b9a\u53d6\u5f97\uff08AuthorizationServerConfiguration/ClientConfiguration\uff09"}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Delegate\u7d4c\u7531\u3067\u30e6\u30fc\u30b6\u30fc\u53d6\u5f97"})," \u2190 UseCase\u5c64\u3078\u306e\u4f9d\u5b58\u6ce8\u5165"]}),"\n",(0,i.jsx)(n.li,{children:"Verifier: \u30d3\u30b8\u30cd\u30b9\u30eb\u30fc\u30eb\u691c\u8a3c\uff08\u30c8\u30fc\u30af\u30f3\u6709\u52b9\u6027\u30fbMTLS\u7b49\uff09"}),"\n",(0,i.jsx)(n.li,{children:"Claims\u62bd\u51fa\uff08UserinfoClaimsCreator\uff09"}),"\n",(0,i.jsx)(n.li,{children:"\u30ec\u30b9\u30dd\u30f3\u30b9\u751f\u6210"}),"\n"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"Delegate\u30d1\u30bf\u30fc\u30f3\u306e\u7406\u7531"}),": Core\u5c64\u306fRepository\u306b\u76f4\u63a5\u4f9d\u5b58\u305b\u305a\u3001UseCase\u5c64\u7d4c\u7531\u3067\u30c7\u30fc\u30bf\u53d6\u5f97\uff08Hexagonal Architecture\u539f\u5247\uff09"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"scope\u5225\u306e\u8fd4\u5374claims",children:"Scope\u5225\u306e\u8fd4\u5374Claims"}),"\n",(0,i.jsxs)(n.table,{children:[(0,i.jsx)(n.thead,{children:(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.th,{children:"Scope"}),(0,i.jsx)(n.th,{children:"\u8fd4\u5374\u3055\u308c\u308bClaims"})]})}),(0,i.jsxs)(n.tbody,{children:[(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"openid"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"sub"}),"\uff08\u5fc5\u9808\uff09"]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"profile"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"name"}),", ",(0,i.jsx)(n.code,{children:"family_name"}),", ",(0,i.jsx)(n.code,{children:"given_name"}),", ",(0,i.jsx)(n.code,{children:"middle_name"}),", ",(0,i.jsx)(n.code,{children:"nickname"}),", ",(0,i.jsx)(n.code,{children:"picture"}),", ",(0,i.jsx)(n.code,{children:"website"}),", ",(0,i.jsx)(n.code,{children:"gender"}),", ",(0,i.jsx)(n.code,{children:"birthdate"}),", ",(0,i.jsx)(n.code,{children:"zoneinfo"}),", ",(0,i.jsx)(n.code,{children:"locale"}),", ",(0,i.jsx)(n.code,{children:"updated_at"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"email"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"email"}),", ",(0,i.jsx)(n.code,{children:"email_verified"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"phone"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"phone_number"}),", ",(0,i.jsx)(n.code,{children:"phone_number_verified"})]})]}),(0,i.jsxs)(n.tr,{children:[(0,i.jsx)(n.td,{children:(0,i.jsx)(n.code,{children:"address"})}),(0,i.jsxs)(n.td,{children:[(0,i.jsx)(n.code,{children:"address"})," (JSON)"]})]})]})]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u4f8b"}),":"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'Access Token scope: openid profile email\n\nUserInfo\u30ec\u30b9\u30dd\u30f3\u30b9:\n{\n  "sub": "user-12345",\n  "name": "John Doe",\n  "email": "john@example.com",\n  "email_verified": true\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"access-token\u691c\u8a3c",children:"Access Token\u691c\u8a3c"}),"\n",(0,i.jsx)(n.h3,{id:"\u691c\u8a3c\u9805\u76ee",children:"\u691c\u8a3c\u9805\u76ee"}),"\n",(0,i.jsx)(n.p,{children:"UserInfo\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u3067\u306f\u3001\u4ee5\u4e0b\u3092\u691c\u8a3c\u3057\u307e\u3059\uff1a"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"JWT\u7f72\u540d\u691c\u8a3c"}),": Access Token\u306eJWT\u7f72\u540d\u304c\u6b63\u5f53\u304b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u6709\u52b9\u671f\u9650\u30c1\u30a7\u30c3\u30af"}),": ",(0,i.jsx)(n.code,{children:"exp"}),"\u30af\u30ec\u30fc\u30e0\u304c\u671f\u9650\u5185\u304b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"\u5931\u52b9\u30c1\u30a7\u30c3\u30af"}),": \u30c8\u30fc\u30af\u30f3\u304c\u5931\u52b9\uff08revoke\uff09\u3055\u308c\u3066\u3044\u306a\u3044\u304b"]}),"\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.strong,{children:"Audience\u691c\u8a3c"}),": \u30c8\u30fc\u30af\u30f3\u306e\u7528\u9014\u304c\u6b63\u3057\u3044\u304b"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"\u691c\u8a3c\u30a8\u30e9\u30fc",children:"\u691c\u8a3c\u30a8\u30e9\u30fc"}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# \u7121\u52b9\u306a\u30c8\u30fc\u30af\u30f3\nGET /{tenant-id}/v1/userinfo\nAuthorization: Bearer invalid-token\n\n\u2192 HTTP 401 Unauthorized\n{\n  "error": "invalid_token",\n  "error_description": "The access token is invalid"\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# \u671f\u9650\u5207\u308c\u30c8\u30fc\u30af\u30f3\nGET /{tenant-id}/v1/userinfo\nAuthorization: Bearer eyJ...\uff08\u671f\u9650\u5207\u308c\uff09\n\n\u2192 HTTP 401 Unauthorized\n{\n  "error": "invalid_token",\n  "error_description": "The access token has expired"\n}\n'})}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-bash",children:'# \u5931\u52b9\u6e08\u307f\u30c8\u30fc\u30af\u30f3\nGET /{tenant-id}/v1/userinfo\nAuthorization: Bearer eyJ...\uff08\u5931\u52b9\u6e08\u307f\uff09\n\n\u2192 HTTP 401 Unauthorized\n{\n  "error": "invalid_token",\n  "error_description": "The access token has been revoked"\n}\n'})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"claims\u62bd\u51fa\u30ed\u30b8\u30c3\u30af",children:"Claims\u62bd\u51fa\u30ed\u30b8\u30c3\u30af"}),"\n",(0,i.jsx)(n.h3,{id:"scope--claims-\u30de\u30c3\u30d4\u30f3\u30b0",children:"Scope \u2192 Claims \u30de\u30c3\u30d4\u30f3\u30b0"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u5b9f\u88c5"}),": Core\u5c64\u3067Scope\u306b\u57fa\u3065\u3044\u3066Claims\u3092\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{children:'Access Token:\n  - subject: "user-12345"\n  - scopes: ["openid", "profile", "email"]\n\nUser\uff08DB\uff09:\n  - sub: "user-12345"\n  - name: "John Doe"\n  - email: "john@example.com"\n  - phone_number: "+81-90-1234-5678"  \u2190 phone\u30b9\u30b3\u30fc\u30d7\u306a\u3057\n  - address: {...}  \u2190 address\u30b9\u30b3\u30fc\u30d7\u306a\u3057\n\n\u2193 Scope\u5225\u306b\u30d5\u30a3\u30eb\u30bf\u30ea\u30f3\u30b0\n\nUserInfo\u30ec\u30b9\u30dd\u30f3\u30b9:\n  {\n    "sub": "user-12345",       \u2190 openid\u30b9\u30b3\u30fc\u30d7\n    "name": "John Doe",        \u2190 profile\u30b9\u30b3\u30fc\u30d7\n    "email": "john@example.com", \u2190 email\u30b9\u30b3\u30fc\u30d7\n    "email_verified": true     \u2190 email\u30b9\u30b3\u30fc\u30d7\n  }\n  \u203b phone_number, address \u306f\u542b\u307e\u308c\u306a\u3044\uff08\u30b9\u30b3\u30fc\u30d7\u306a\u3057\uff09\n'})}),"\n",(0,i.jsx)(n.h3,{id:"\u6700\u5c0f\u9650\u306e\u30ec\u30b9\u30dd\u30f3\u30b9",children:"\u6700\u5c0f\u9650\u306e\u30ec\u30b9\u30dd\u30f3\u30b9"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"openid"}),"\u30b9\u30b3\u30fc\u30d7\u306e\u307f"]}),"\u306e\u5834\u5408\uff1a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-json",children:'{\n  "sub": "user-12345"\n}\n'})}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsxs)(n.strong,{children:[(0,i.jsx)(n.code,{children:"sub"}),"\u306f\u5e38\u306b\u8fd4\u5374"]}),"\u3055\u308c\u307e\u3059\uff08OpenID Connect\u4ed5\u69d8\uff09\u3002"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u3088\u304f\u3042\u308b\u30a8\u30e9\u30fc",children:"\u3088\u304f\u3042\u308b\u30a8\u30e9\u30fc"}),"\n",(0,i.jsxs)(n.h3,{id:"\u30a8\u30e9\u30fc1-invalid_token---\u7121\u52b9\u306aaccess-token",children:["\u30a8\u30e9\u30fc1: ",(0,i.jsx)(n.code,{children:"invalid_token"})," - \u7121\u52b9\u306aAccess Token"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u539f\u56e0"}),": \u671f\u9650\u5207\u308c\u30fb\u4e0d\u6b63\u306a\u30c8\u30fc\u30af\u30f3"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u89e3\u6c7a\u7b56"}),": \u65b0\u3057\u3044Access Token\u3092\u53d6\u5f97"]}),"\n",(0,i.jsx)(n.h3,{id:"\u30a8\u30e9\u30fc2-claims\u304c\u8fd4\u5374\u3055\u308c\u306a\u3044",children:"\u30a8\u30e9\u30fc2: Claims\u304c\u8fd4\u5374\u3055\u308c\u306a\u3044"}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u539f\u56e0"}),": Scope\u304c\u4e0d\u8db3"]}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u89e3\u6c7a\u7b56"}),": \u30c8\u30fc\u30af\u30f3\u53d6\u5f97\u6642\u306b\u5fc5\u8981\u306aScope\u3092\u6307\u5b9a"]}),"\n",(0,i.jsx)(n.pre,{children:(0,i.jsx)(n.code,{className:"language-javascript",children:"// \u2705 \u6b63\u3057\u3044\nscope: 'openid profile email'  // profile, email\u30b9\u30b3\u30fc\u30d7\u8ffd\u52a0\n"})}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsx)(n.h2,{id:"\u6b21\u306e\u30b9\u30c6\u30c3\u30d7",children:"\u6b21\u306e\u30b9\u30c6\u30c3\u30d7"}),"\n",(0,i.jsx)(n.p,{children:"\u2705 UserInfo\u306e\u5b9f\u88c5\u3092\u7406\u89e3\u3057\u305f\uff01"}),"\n",(0,i.jsx)(n.h3,{id:"-\u6b21\u306b\u8aad\u3080\u3079\u304d\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"\ud83d\udcd6 \u6b21\u306b\u8aad\u3080\u3079\u304d\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,i.jsxs)(n.ol,{children:["\n",(0,i.jsxs)(n.li,{children:[(0,i.jsx)(n.a,{href:"/idp-server/docs/content_06_developer-guide/application-plane/ciba-flow",children:"06. CIBA Flow\u5b9f\u88c5"})," - \u30d0\u30c3\u30af\u30c1\u30e3\u30cd\u30eb\u8a8d\u8a3c"]}),"\n"]}),"\n",(0,i.jsx)(n.h3,{id:"-\u8a73\u7d30\u60c5\u5831",children:"\ud83d\udd17 \u8a73\u7d30\u60c5\u5831"}),"\n",(0,i.jsxs)(n.ul,{children:["\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"../../../content_10_ai_developer/ai-11-core.md#userinfo---userinfo%E3%82%A8%E3%83%B3%E3%83%89%E3%83%9D%E3%82%A4%E3%83%B3%E3%83%88",children:"AI\u958b\u767a\u8005\u5411\u3051: Core - UserInfo"})}),"\n",(0,i.jsx)(n.li,{children:(0,i.jsx)(n.a,{href:"https://openid.net/specs/openid-connect-core-1_0.html#UserInfo",children:"OpenID Connect Core 1.0 Section 5.3"})}),"\n"]}),"\n",(0,i.jsx)(n.hr,{}),"\n",(0,i.jsxs)(n.p,{children:[(0,i.jsx)(n.strong,{children:"\u60c5\u5831\u6e90"}),": ",(0,i.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(28062).A+"",children:"UserinfoEntryService.java"}),"\n",(0,i.jsx)(n.strong,{children:"\u6700\u7d42\u66f4\u65b0"}),": 2025-10-12"]})]})}function h(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,i.jsx)(n,{...e,children:(0,i.jsx)(a,{...e})}):a(e)}},13613:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/files/UserinfoHandler-45afedbfeeb65b8d56cfa7717b96d793.java"},83126:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/files/UserinfoV1Api-939b731e219c2ce4e3729379db140bc2.java"},28062:(e,n,r)=>{r.d(n,{A:()=>s});const s=r.p+"assets/files/UserinfoEntryService-d071ac1ea6a43732fa126fd4ce6b6548.java"},28453:(e,n,r)=>{r.d(n,{R:()=>t,x:()=>l});var s=r(96540);const i={},o=s.createContext(i);function t(e){const n=s.useContext(o);return s.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function l(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(i):e.components||i:t(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);