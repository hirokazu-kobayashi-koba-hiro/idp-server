"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[6921],{92101:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>r,default:()=>x,frontMatter:()=>d,metadata:()=>s,toc:()=>a});const s=JSON.parse('{"id":"content_06_developer-guide/reference/tenant-statistics-implementation","title":"\u30c6\u30ca\u30f3\u30c8\u7d71\u8a08\u6a5f\u80fd \u5b9f\u88c5\u30ac\u30a4\u30c9","description":"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001\u30c6\u30ca\u30f3\u30c8\u7d71\u8a08\u6a5f\u80fd\u306e\u5b9f\u88c5\u8a73\u7d30\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\u6982\u8981\u306b\u3064\u3044\u3066\u306f \u30c6\u30ca\u30f3\u30c8\u7d71\u8a08\u7ba1\u7406 \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002","source":"@site/docs/content_06_developer-guide/08-reference/tenant-statistics-implementation.md","sourceDirName":"content_06_developer-guide/08-reference","slug":"/content_06_developer-guide/reference/tenant-statistics-implementation","permalink":"/idp-server/docs/content_06_developer-guide/reference/tenant-statistics-implementation","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_06_developer-guide/08-reference/tenant-statistics-implementation.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30a4\u30d9\u30f3\u30c8 \u30a2\u30fc\u30ab\u30a4\u30d6\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_06_developer-guide/reference/security-event-archive-guide"},"next":{"title":"\u521d\u7d1a\u30e9\u30fc\u30cb\u30f3\u30b0\u30d1\u30b9\uff081-2\u9031\u9593\uff09","permalink":"/idp-server/docs/content_06_developer-guide/learning-paths/beginner"}}');var l=n(74848),i=n(28453);const d={},r="\u30c6\u30ca\u30f3\u30c8\u7d71\u8a08\u6a5f\u80fd \u5b9f\u88c5\u30ac\u30a4\u30c9",c={},a=[{value:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u9078\u629e",id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u9078\u629e",level:2},{value:"\u30a4\u30d9\u30f3\u30c8\u99c6\u52d5 vs \u30d0\u30c3\u30c1\u51e6\u7406",id:"\u30a4\u30d9\u30f3\u30c8\u99c6\u52d5-vs-\u30d0\u30c3\u30c1\u51e6\u7406",level:3},{value:"\u30c7\u30fc\u30bf\u30e2\u30c7\u30eb",id:"\u30c7\u30fc\u30bf\u30e2\u30c7\u30eb",level:2},{value:"ER\u56f3",id:"er\u56f3",level:3},{value:"\u30c6\u30fc\u30d6\u30eb\u69cb\u9020",id:"\u30c6\u30fc\u30d6\u30eb\u69cb\u9020",level:3},{value:"\u96c6\u8a08\u30c6\u30fc\u30d6\u30eb\uff08\u975e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff09",id:"\u96c6\u8a08\u30c6\u30fc\u30d6\u30eb\u975e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3",level:4},{value:"\u30e6\u30fc\u30b6\u30fc\u30c8\u30e9\u30c3\u30ad\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\uff08\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff09",id:"\u30e6\u30fc\u30b6\u30fc\u30c8\u30e9\u30c3\u30ad\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3",level:4},{value:"\u30ab\u30e9\u30e0\u8a73\u7d30",id:"\u30ab\u30e9\u30e0\u8a73\u7d30",level:3},{value:"statistics_monthly",id:"statistics_monthly",level:4},{value:"statistics_yearly",id:"statistics_yearly",level:4},{value:"\u7d71\u8a08\u66f4\u65b0\u30d5\u30ed\u30fc",id:"\u7d71\u8a08\u66f4\u65b0\u30d5\u30ed\u30fc",level:2},{value:"SecurityEventHandler\u306b\u3088\u308b\u7d71\u8a08\u53ce\u96c6",id:"securityeventhandler\u306b\u3088\u308b\u7d71\u8a08\u53ce\u96c6",level:3},{value:"\u30a2\u30af\u30c6\u30a3\u30d6\u30e6\u30fc\u30b6\u30fc\u30a4\u30d9\u30f3\u30c8\u306e\u5224\u5b9a",id:"\u30a2\u30af\u30c6\u30a3\u30d6\u30e6\u30fc\u30b6\u30fc\u30a4\u30d9\u30f3\u30c8\u306e\u5224\u5b9a",level:3},{value:"\u7d71\u8a08\u66f4\u65b0\u51e6\u7406\u306e\u8a73\u7d30",id:"\u7d71\u8a08\u66f4\u65b0\u51e6\u7406\u306e\u8a73\u7d30",level:3},{value:"\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u51e6\u7406",id:"\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u51e6\u7406",level:2},{value:"\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5b9f\u88c5",id:"\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5b9f\u88c5",level:2},{value:"PostgreSQL vs MySQL",id:"postgresql-vs-mysql",level:3},{value:"UPSERT \u306b\u3088\u308b\u5897\u5206\u66f4\u65b0",id:"upsert-\u306b\u3088\u308b\u5897\u5206\u66f4\u65b0",level:3},{value:"\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3",id:"\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3",level:2},{value:"LocalDate\u578b\u306e\u4f7f\u7528",id:"localdate\u578b\u306e\u4f7f\u7528",level:3},{value:"\u4f1a\u8a08\u5e74\u5ea6\u306e\u8a08\u7b97",id:"\u4f1a\u8a08\u5e74\u5ea6\u306e\u8a08\u7b97",level:3},{value:"\u4f1a\u8a08\u5e74\u5ea6\u306e\u8a2d\u5b9a",id:"\u4f1a\u8a08\u5e74\u5ea6\u306e\u8a2d\u5b9a",level:3},{value:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3067\u306e\u65b0\u898f\u30ec\u30b3\u30fc\u30c9\u691c\u51fa",id:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3067\u306e\u65b0\u898f\u30ec\u30b3\u30fc\u30c9\u691c\u51fa",level:3},{value:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u6226\u7565",id:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u6226\u7565",level:2},{value:"pg_partman\u306b\u3088\u308b\u81ea\u52d5\u7ba1\u7406",id:"pg_partman\u306b\u3088\u308b\u81ea\u52d5\u7ba1\u7406",level:3},{value:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u306e\u30e1\u30ea\u30c3\u30c8",id:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u306e\u30e1\u30ea\u30c3\u30c8",level:3},{value:"\u30a2\u30fc\u30ab\u30a4\u30d6\u65b9\u5f0f",id:"\u30a2\u30fc\u30ab\u30a4\u30d6\u65b9\u5f0f",level:3},{value:"\u904b\u7528\u30ab\u30b9\u30bf\u30de\u30a4\u30ba",id:"\u904b\u7528\u30ab\u30b9\u30bf\u30de\u30a4\u30ba",level:3},{value:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u8003\u616e\u4e8b\u9805",id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u8003\u616e\u4e8b\u9805",level:2},{value:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u6226\u7565",id:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u6226\u7565",level:3},{value:"\u5897\u5206\u66f4\u65b0\u306b\u3088\u308b\u8ca0\u8377\u8efd\u6e1b",id:"\u5897\u5206\u66f4\u65b0\u306b\u3088\u308b\u8ca0\u8377\u8efd\u6e1b",level:3},{value:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0",id:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0",level:2},{value:"\u7d71\u8a08\u66f4\u65b0\u30a8\u30e9\u30fc\u306e\u6319\u52d5",id:"\u7d71\u8a08\u66f4\u65b0\u30a8\u30e9\u30fc\u306e\u6319\u52d5",level:3},{value:"\u76e3\u8996\u3059\u3079\u304d\u6307\u6a19",id:"\u76e3\u8996\u3059\u3079\u304d\u6307\u6a19",level:3},{value:"\u30c7\u30fc\u30bf\u4fdd\u6301\u3068\u79fb\u884c",id:"\u30c7\u30fc\u30bf\u4fdd\u6301\u3068\u79fb\u884c",level:2},{value:"\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u95a2\u6570",id:"\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u95a2\u6570",level:3},{value:"\u904e\u53bb\u30c7\u30fc\u30bf\u306e\u96c6\u8a08",id:"\u904e\u53bb\u30c7\u30fc\u30bf\u306e\u96c6\u8a08",level:3},{value:"\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8",id:"\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8",level:2},{value:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:2}];function h(e){const t={a:"a",blockquote:"blockquote",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(t.header,{children:(0,l.jsx)(t.h1,{id:"\u30c6\u30ca\u30f3\u30c8\u7d71\u8a08\u6a5f\u80fd-\u5b9f\u88c5\u30ac\u30a4\u30c9",children:"\u30c6\u30ca\u30f3\u30c8\u7d71\u8a08\u6a5f\u80fd \u5b9f\u88c5\u30ac\u30a4\u30c9"})}),"\n",(0,l.jsxs)(t.p,{children:["\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001\u30c6\u30ca\u30f3\u30c8\u7d71\u8a08\u6a5f\u80fd\u306e\u5b9f\u88c5\u8a73\u7d30\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\u6982\u8981\u306b\u3064\u3044\u3066\u306f ",(0,l.jsx)(t.a,{href:"/idp-server/docs/content_03_concepts/operations/concept-03-tenant-statistics",children:"\u30c6\u30ca\u30f3\u30c8\u7d71\u8a08\u7ba1\u7406"})," \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u9078\u629e",children:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u9078\u629e"}),"\n",(0,l.jsx)(t.h3,{id:"\u30a4\u30d9\u30f3\u30c8\u99c6\u52d5-vs-\u30d0\u30c3\u30c1\u51e6\u7406",children:"\u30a4\u30d9\u30f3\u30c8\u99c6\u52d5 vs \u30d0\u30c3\u30c1\u51e6\u7406"}),"\n",(0,l.jsxs)(t.p,{children:["idp-server\u3067\u306f\u3001\u30d0\u30c3\u30c1\u51e6\u7406\u3067\u306f\u306a\u304f",(0,l.jsx)(t.strong,{children:"\u30a4\u30d9\u30f3\u30c8\u99c6\u52d5\u306b\u3088\u308b\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u7d71\u8a08\u66f4\u65b0"}),"\u3092\u63a1\u7528\u3057\u3066\u3044\u307e\u3059\u3002"]}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30a2\u30d7\u30ed\u30fc\u30c1"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u7279\u5fb4"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30e1\u30ea\u30c3\u30c8"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30c7\u30e1\u30ea\u30c3\u30c8"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.strong,{children:"\u30d0\u30c3\u30c1\u51e6\u7406"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u5b9a\u671f\u7684\u306b\u904e\u53bb\u30c7\u30fc\u30bf\u3092\u96c6\u8a08"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30b7\u30f3\u30d7\u30eb"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30c7\u30fc\u30bf\u9045\u5ef6\u3001\u9ad8\u8ca0\u8377"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.strong,{children:"\u30a4\u30d9\u30f3\u30c8\u99c6\u52d5"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30a4\u30d9\u30f3\u30c8\u767a\u751f\u6642\u306b\u5897\u5206\u66f4\u65b0"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u3001\u4f4e\u8ca0\u8377"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u5b9f\u88c5\u8907\u96d1"})]})]})]}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u30a4\u30d9\u30f3\u30c8\u99c6\u52d5\u3092\u9078\u629e\u3057\u305f\u7406\u7531"}),":"]}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsx)(t.li,{children:"\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30a4\u30d9\u30f3\u30c8\u306f\u65e2\u306b\u767a\u884c\u3055\u308c\u3066\u3044\u308b\uff08\u8ffd\u52a0\u30b3\u30b9\u30c8\u5c0f\uff09"}),"\n",(0,l.jsx)(t.li,{children:"\u30ea\u30a2\u30eb\u30bf\u30a4\u30e0\u306a\u53ef\u8996\u5316\u304c\u53ef\u80fd"}),"\n",(0,l.jsx)(t.li,{children:"\u5897\u5206\u66f4\u65b0\u306e\u305f\u3081\u8a08\u7b97\u30b3\u30b9\u30c8\u304c\u4f4e\u3044"}),"\n",(0,l.jsx)(t.li,{children:"\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u6574\u5408\u6027\u3092\u4fdd\u8a3c\u3067\u304d\u308b"}),"\n"]}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u30c8\u30ec\u30fc\u30c9\u30aa\u30d5"}),":"]}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsx)(t.li,{children:"\u30a4\u30d9\u30f3\u30c8\u30cf\u30f3\u30c9\u30e9\u30fc\u306e\u8907\u96d1\u6027\u5897\u52a0"}),"\n",(0,l.jsx)(t.li,{children:"\u7d71\u8a08\u66f4\u65b0\u5931\u6557\u6642\u306e\u30a8\u30e9\u30fc\u30cf\u30f3\u30c9\u30ea\u30f3\u30b0\u5fc5\u8981"}),"\n",(0,l.jsx)(t.li,{children:"\u305f\u3060\u3057\u3001\u8a8d\u8a3c\u30d5\u30ed\u30fc\u3068\u7d71\u8a08\u66f4\u65b0\u306f\u758e\u7d50\u5408\uff08\u7d71\u8a08\u5931\u6557\u3067\u3082\u8a8d\u8a3c\u306f\u6210\u529f\uff09"}),"\n"]}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u30c7\u30fc\u30bf\u30e2\u30c7\u30eb",children:"\u30c7\u30fc\u30bf\u30e2\u30c7\u30eb"}),"\n",(0,l.jsx)(t.h3,{id:"er\u56f3",children:"ER\u56f3"}),"\n",(0,l.jsx)(t.mermaid,{value:'erDiagram\n    statistics_monthly ||--o{ statistics_daily_users : "tracks DAU"\n    statistics_monthly ||--o{ statistics_monthly_users : "tracks MAU"\n    statistics_yearly ||--o{ statistics_yearly_users : "tracks YAU"\n    statistics_monthly {\n        uuid id PK\n        uuid tenant_id\n        date stat_month\n        jsonb monthly_summary\n        jsonb daily_metrics\n        timestamp created_at\n        timestamp updated_at\n    }\n    statistics_yearly {\n        uuid id PK\n        uuid tenant_id\n        date stat_year\n        jsonb yearly_summary\n        timestamp created_at\n        timestamp updated_at\n    }\n    statistics_daily_users {\n        uuid tenant_id PK\n        date stat_date PK\n        uuid user_id PK\n        timestamp last_used_at\n        timestamp created_at\n    }\n    statistics_monthly_users {\n        uuid tenant_id PK\n        date stat_month PK\n        uuid user_id PK\n        timestamp last_used_at\n        timestamp created_at\n    }\n    statistics_yearly_users {\n        uuid tenant_id PK\n        date stat_year PK\n        uuid user_id PK\n        timestamp last_used_at\n        timestamp created_at\n    }'}),"\n",(0,l.jsx)(t.h3,{id:"\u30c6\u30fc\u30d6\u30eb\u69cb\u9020",children:"\u30c6\u30fc\u30d6\u30eb\u69cb\u9020"}),"\n",(0,l.jsx)(t.h4,{id:"\u96c6\u8a08\u30c6\u30fc\u30d6\u30eb\u975e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3",children:"\u96c6\u8a08\u30c6\u30fc\u30d6\u30eb\uff08\u975e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff09"}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30c6\u30fc\u30d6\u30eb"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u7528\u9014"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"statistics_monthly"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u6708\u6b21\u96c6\u8a08\u30e1\u30c8\u30ea\u30af\u30b9"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u306a\u3057"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"statistics_yearly"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u5e74\u6b21\u96c6\u8a08\u30e1\u30c8\u30ea\u30af\u30b9"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u306a\u3057"})]})]})]}),"\n",(0,l.jsx)(t.h4,{id:"\u30e6\u30fc\u30b6\u30fc\u30c8\u30e9\u30c3\u30ad\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3",children:"\u30e6\u30fc\u30b6\u30fc\u30c8\u30e9\u30c3\u30ad\u30f3\u30b0\u30c6\u30fc\u30d6\u30eb\uff08\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff09"}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30c6\u30fc\u30d6\u30eb"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u7528\u9014"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u9593\u9694"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u4fdd\u6301\u671f\u9593"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u5099\u8003"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"statistics_daily_users"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"DAU\u91cd\u8907\u6392\u9664"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u65e5\u5225"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"90\u65e5"}),(0,l.jsx)(t.td,{style:{textAlign:"left"}})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"statistics_monthly_users"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"MAU\u91cd\u8907\u6392\u9664"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u6708\u5225"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"13\u30f6\u6708"}),(0,l.jsx)(t.td,{style:{textAlign:"left"}})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"statistics_yearly_users"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"YAU\u91cd\u8907\u6392\u9664"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u6708\u5225"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"60\u30f6\u6708"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u4f1a\u8a08\u5e74\u5ea6\u5bfe\u5fdc"})]})]})]}),"\n",(0,l.jsxs)(t.blockquote,{children:["\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"Note"}),": ",(0,l.jsx)(t.code,{children:"statistics_yearly_users"})," \u306f\u4f1a\u8a08\u5e74\u5ea6\u5bfe\u5fdc\u306e\u305f\u3081\u6708\u5358\u4f4d\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n",(0,l.jsx)(t.code,{children:"stat_year"})," \u306b\u306f\u4f1a\u8a08\u5e74\u5ea6\u958b\u59cb\u65e5\uff08\u4f8b: 2025-04-01 = 4\u6708\u958b\u59cb\u306e2025\u5e74\u5ea6\uff09\u304c\u683c\u7d0d\u3055\u308c\u307e\u3059\u3002"]}),"\n"]}),"\n",(0,l.jsx)(t.h3,{id:"\u30ab\u30e9\u30e0\u8a73\u7d30",children:"\u30ab\u30e9\u30e0\u8a73\u7d30"}),"\n",(0,l.jsx)(t.h4,{id:"statistics_monthly",children:"statistics_monthly"}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30ab\u30e9\u30e0"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u578b"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u8aac\u660e"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"id"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"UUID"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u7d71\u8a08\u30ec\u30b3\u30fc\u30c9ID"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"tenant_id"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"UUID"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30c6\u30ca\u30f3\u30c8\u8b58\u5225\u5b50"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"stat_month"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"DATE"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u7d71\u8a08\u5bfe\u8c61\u6708\uff08\u6708\u521d\u65e5\u3001\u4f8b: 2025-01-01\uff09"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"monthly_summary"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"JSONB"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u6708\u6b21\u96c6\u8a08\u30e1\u30c8\u30ea\u30af\u30b9"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"daily_metrics"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"JSONB"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u65e5\u5225\u30e1\u30c8\u30ea\u30af\u30b9\uff08\u30ad\u30fc: YYYY-MM-DD\u5f62\u5f0f\uff09"})]})]})]}),"\n",(0,l.jsxs)(t.blockquote,{children:["\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"Note"}),": ",(0,l.jsx)(t.code,{children:"stat_month"}),"\u306fDATE\u578b\u3067\u6708\u521d\u65e5\uff081\u65e5\uff09\u3092\u683c\u7d0d\u3057\u307e\u3059\u3002pg_partman\u5bfe\u5fdc\u306e\u305f\u3081\u3001CHAR(7)\u304b\u3089DATE\u578b\u306b\u5909\u66f4\u3055\u308c\u307e\u3057\u305f\u3002"]}),"\n"]}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"monthly_summary \u306e\u4f8b"}),":"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-json",children:'{\n  "mau": 5000,\n  "login_success": 45000,\n  "dau": 3200,\n  "issue_token_success": 12000\n}\n'})}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"daily_metrics \u306e\u4f8b"}),":"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-json",children:'{\n  "2025-01-01": {"dau": 100, "login_success": 1500},\n  "2025-01-02": {"dau": 110, "login_success": 1600}\n}\n'})}),"\n",(0,l.jsx)(t.h4,{id:"statistics_yearly",children:"statistics_yearly"}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30ab\u30e9\u30e0"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u578b"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u8aac\u660e"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"id"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"UUID"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u7d71\u8a08\u30ec\u30b3\u30fc\u30c9ID"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"tenant_id"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"UUID"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30c6\u30ca\u30f3\u30c8\u8b58\u5225\u5b50"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"stat_year"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"DATE"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u7d71\u8a08\u5bfe\u8c61\u5e74\uff08\u5e74\u521d\u65e5\u3001\u4f8b: 2025-01-01\uff09"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"yearly_summary"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"JSONB"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u5e74\u6b21\u96c6\u8a08\u30e1\u30c8\u30ea\u30af\u30b9"})]})]})]}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"yearly_summary \u306e\u4f8b"}),":"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-json",children:'{\n  "yau": 15000,\n  "total_logins": 500000,\n  "total_login_failures": 5000,\n  "new_users": 2000\n}\n'})}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u7d71\u8a08\u66f4\u65b0\u30d5\u30ed\u30fc",children:"\u7d71\u8a08\u66f4\u65b0\u30d5\u30ed\u30fc"}),"\n",(0,l.jsx)(t.h3,{id:"securityeventhandler\u306b\u3088\u308b\u7d71\u8a08\u53ce\u96c6",children:"SecurityEventHandler\u306b\u3088\u308b\u7d71\u8a08\u53ce\u96c6"}),"\n",(0,l.jsxs)(t.p,{children:["\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30a4\u30d9\u30f3\u30c8\u767a\u884c\u6642\u306b\u3001",(0,l.jsx)(t.code,{children:"SecurityEventHandler"}),"\u304c\u7d71\u8a08\u3092\u540c\u671f\u7684\u306b\u66f4\u65b0\u3057\u307e\u3059\u3002"]}),"\n",(0,l.jsx)(t.mermaid,{value:"sequenceDiagram\n    participant Auth as \u8a8d\u8a3c\u51e6\u7406\n    participant Handler as SecurityEventHandler\n    participant Log as \u30ed\u30b0\u30b5\u30fc\u30d3\u30b9\n    participant Stats as \u7d71\u8a08\u66f4\u65b0\n    participant Hook as \u30d5\u30c3\u30af\u5b9f\u884c\n\n    Auth->>Handler: handle(tenant, securityEvent)\n    Handler->>Log: logEvent()\n    Handler->>Stats: updateStatistics()\n    Stats--\x3e>Handler: \u5b8c\u4e86\n    Handler->>Hook: \u30d5\u30c3\u30af\u5b9f\u884c\uff08\u975e\u540c\u671f\uff09\n    Handler--\x3e>Auth: \u5b8c\u4e86"}),"\n",(0,l.jsx)(t.h3,{id:"\u30a2\u30af\u30c6\u30a3\u30d6\u30e6\u30fc\u30b6\u30fc\u30a4\u30d9\u30f3\u30c8\u306e\u5224\u5b9a",children:"\u30a2\u30af\u30c6\u30a3\u30d6\u30e6\u30fc\u30b6\u30fc\u30a4\u30d9\u30f3\u30c8\u306e\u5224\u5b9a"}),"\n",(0,l.jsxs)(t.p,{children:["\u4ee5\u4e0b\u306e\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30a4\u30d9\u30f3\u30c8\u304c\u30a2\u30af\u30c6\u30a3\u30d6\u30e6\u30fc\u30b6\u30fc\u30a4\u30d9\u30f3\u30c8\u3068\u3057\u3066\u5224\u5b9a\u3055\u308c\u307e\u3059\uff08",(0,l.jsx)(t.code,{children:"DefaultSecurityEventType.isActiveUserEvent()"}),"\uff09:"]}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30a4\u30d9\u30f3\u30c8\u30bf\u30a4\u30d7"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u8aac\u660e"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"login_success"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30ed\u30b0\u30a4\u30f3\u6210\u529f"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"issue_token_success"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30c8\u30fc\u30af\u30f3\u767a\u884c\u6210\u529f"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"refresh_token_success"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30c8\u30fc\u30af\u30f3\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5\u6210\u529f"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"inspect_token_success"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30c8\u30fc\u30af\u30f3\u691c\u8a3c\u6210\u529f"})]})]})]}),"\n",(0,l.jsx)(t.h3,{id:"\u7d71\u8a08\u66f4\u65b0\u51e6\u7406\u306e\u8a73\u7d30",children:"\u7d71\u8a08\u66f4\u65b0\u51e6\u7406\u306e\u8a73\u7d30"}),"\n",(0,l.jsx)(t.mermaid,{value:"flowchart TD\n    EVENT[\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30a4\u30d9\u30f3\u30c8] --\x3e CHECK{\u30a2\u30af\u30c6\u30a3\u30d6\u30e6\u30fc\u30b6\u30fc<br/>\u30a4\u30d9\u30f3\u30c8?}\n    CHECK --\x3e|Yes| DAU_CHECK{DAU\u30c6\u30fc\u30d6\u30eb\u306b<br/>\u5b58\u5728\u3059\u308b?}\n    CHECK --\x3e|No| INCREMENT[\u30e1\u30c8\u30ea\u30af\u30b9 +1]\n\n    DAU_CHECK --\x3e|No| ADD_DAU[DAU\u30c6\u30fc\u30d6\u30eb\u306b\u8ffd\u52a0]\n    DAU_CHECK --\x3e|Yes| MAU_CHECK{MAU\u30c6\u30fc\u30d6\u30eb\u306b<br/>\u5b58\u5728\u3059\u308b?}\n\n    ADD_DAU --\x3e INCREMENT_DAU[dau +1]\n    INCREMENT_DAU --\x3e MAU_CHECK\n\n    MAU_CHECK --\x3e|No| ADD_MAU[MAU\u30c6\u30fc\u30d6\u30eb\u306b\u8ffd\u52a0]\n    MAU_CHECK --\x3e|Yes| YAU_CHECK{YAU\u30c6\u30fc\u30d6\u30eb\u306b<br/>\u5b58\u5728\u3059\u308b?}\n\n    ADD_MAU --\x3e INCREMENT_MAU[mau +1]\n    INCREMENT_MAU --\x3e YAU_CHECK\n\n    YAU_CHECK --\x3e|No| ADD_YAU[YAU\u30c6\u30fc\u30d6\u30eb\u306b\u8ffd\u52a0]\n    YAU_CHECK --\x3e|Yes| LOGIN_COUNT[login_success_count +1]\n\n    ADD_YAU --\x3e INCREMENT_YAU[yau +1]\n    INCREMENT_YAU --\x3e LOGIN_COUNT\n\n    INCREMENT --\x3e END[\u5b8c\u4e86]\n    LOGIN_COUNT --\x3e END"}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u51e6\u7406\u30d5\u30ed\u30fc"}),":"]}),"\n",(0,l.jsxs)(t.ol,{children:["\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u30a4\u30d9\u30f3\u30c8\u7a2e\u5225\u5224\u5b9a"}),": ",(0,l.jsx)(t.code,{children:"DefaultSecurityEventType.isActiveUserEvent()"})," \u3067\u30a2\u30af\u30c6\u30a3\u30d6\u30e6\u30fc\u30b6\u30fc\u30a4\u30d9\u30f3\u30c8\u304b\u5224\u5b9a"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u5909\u63db"}),": UTC\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u3092\u30c6\u30ca\u30f3\u30c8\u306e\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u306b\u5909\u63db\u3057\u3066\u65e5\u4ed8\u3092\u6c7a\u5b9a"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"DAU\u51e6\u7406"}),": ",(0,l.jsx)(t.code,{children:"statistics_daily_users"})," \u30c6\u30fc\u30d6\u30eb\u3067\u30e6\u30fc\u30b6\u30fc\u306e\u521d\u56de\u30a2\u30af\u30c6\u30a3\u30d3\u30c6\u30a3\u3092\u691c\u51fa"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"MAU\u51e6\u7406"}),": ",(0,l.jsx)(t.code,{children:"statistics_monthly_users"})," \u30c6\u30fc\u30d6\u30eb\u3067\u30e6\u30fc\u30b6\u30fc\u306e\u6708\u521d\u30a2\u30af\u30c6\u30a3\u30d3\u30c6\u30a3\u3092\u691c\u51fa"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"YAU\u51e6\u7406"}),": ",(0,l.jsx)(t.code,{children:"statistics_yearly_users"})," \u30c6\u30fc\u30d6\u30eb\u3067\u30e6\u30fc\u30b6\u30fc\u306e\u5e74\u521d\u30a2\u30af\u30c6\u30a3\u30d3\u30c6\u30a3\u3092\u691c\u51fa"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u30e1\u30c8\u30ea\u30af\u30b9\u66f4\u65b0"}),": \u65e5\u6b21\u30fb\u6708\u6b21\u30fb\u5e74\u6b21\u30e1\u30c8\u30ea\u30af\u30b9\u3092JSONB\u3067\u5897\u5206\u66f4\u65b0"]}),"\n"]}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u51e6\u7406",children:"\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u51e6\u7406"}),"\n",(0,l.jsx)(t.p,{children:"\u30b0\u30ed\u30fc\u30d0\u30eb\u306a\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u74b0\u5883\u3067\u306f\u3001\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u51e6\u7406\u304c\u91cd\u8981\u3067\u3059\u3002"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-java",children:"// SecurityEventHandler.updateStatistics() \u3088\u308a\nLocalDate eventDate = securityEvent\n    .createdAt()\n    .value()\n    .atZone(ZoneOffset.UTC)\n    .withZoneSameInstant(tenant.timezone())\n    .toLocalDate();\n"})}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u539f\u5247"}),":"]}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsx)(t.li,{children:"\u30a4\u30d9\u30f3\u30c8\u306e\u30bf\u30a4\u30e0\u30b9\u30bf\u30f3\u30d7\u306fUTC\u3067\u8a18\u9332"}),"\n",(0,l.jsx)(t.li,{children:"\u7d71\u8a08\u65e5\u4ed8\u306f\u30c6\u30ca\u30f3\u30c8\u306e\u30bf\u30a4\u30e0\u30be\u30fc\u30f3\u3067\u8a08\u7b97"}),"\n",(0,l.jsx)(t.li,{children:"\u4f8b: \u6771\u4eac\u306e\u30c6\u30ca\u30f3\u30c8\uff08JST +9\uff09\u306e23:30 UTC \u2192 \u7fcc\u65e508:30 JST \u3068\u3057\u3066\u96c6\u8a08"}),"\n"]}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5b9f\u88c5",children:"\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5b9f\u88c5"}),"\n",(0,l.jsx)(t.h3,{id:"postgresql-vs-mysql",children:"PostgreSQL vs MySQL"}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u6a5f\u80fd"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"PostgreSQL"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"MySQL"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"UUID\u751f\u6210"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"gen_random_uuid()"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"UUID()"})})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"JSON\u578b"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"JSONB"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"JSON"})})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"JSON\u30d1\u30b9\u66f4\u65b0"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"jsonb_set()"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"JSON_SET()"})})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"UPSERT"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"ON CONFLICT ... DO UPDATE"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"ON DUPLICATE KEY UPDATE"})})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u884c\u30ec\u30d9\u30eb\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"RLS\u30dd\u30ea\u30b7\u30fc"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u306a\u3057\uff08\u30a2\u30d7\u30ea\u5c64\u3067\u5236\u5fa1\uff09"})]})]})]}),"\n",(0,l.jsx)(t.h3,{id:"upsert-\u306b\u3088\u308b\u5897\u5206\u66f4\u65b0",children:"UPSERT \u306b\u3088\u308b\u5897\u5206\u66f4\u65b0"}),"\n",(0,l.jsx)(t.p,{children:"\u30a2\u30c8\u30df\u30c3\u30af\u306a\u5897\u5206\u66f4\u65b0\u306b\u3088\u308a\u3001\u540c\u6642\u5b9f\u884c\u5236\u5fa1\u3092\u5b9f\u73fe\u3057\u3066\u3044\u307e\u3059\u3002"}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"PostgreSQL\u4f8b"}),":"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-sql",children:"INSERT INTO statistics_monthly (...)\nVALUES (...)\nON CONFLICT (tenant_id, stat_month)\nDO UPDATE SET\n    daily_metrics = jsonb_set(\n        COALESCE(statistics_monthly.daily_metrics, '{}'::jsonb),\n        ARRAY[?::text],\n        jsonb_set(\n            COALESCE(statistics_monthly.daily_metrics->?::text, '{}'::jsonb),\n            ARRAY[?::text],\n            to_jsonb(COALESCE((statistics_monthly.daily_metrics->?::text->>?::text)::int, 0) + ?::int)\n        )\n    ),\n    updated_at = now()\n"})}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u30e1\u30ea\u30c3\u30c8"}),":"]}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsx)(t.li,{children:"\u30ed\u30c3\u30af\u4e0d\u8981"}),"\n",(0,l.jsx)(t.li,{children:"\u30c7\u30c3\u30c9\u30ed\u30c3\u30af\u56de\u907f"}),"\n",(0,l.jsx)(t.li,{children:"\u9ad8\u30b9\u30eb\u30fc\u30d7\u30c3\u30c8"}),"\n"]}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3",children:"\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,l.jsx)(t.h3,{id:"localdate\u578b\u306e\u4f7f\u7528",children:"LocalDate\u578b\u306e\u4f7f\u7528"}),"\n",(0,l.jsxs)(t.p,{children:["\u7d71\u8a08\u6a5f\u80fd\u3067\u306f\u3001\u65e5\u4ed8\u30d1\u30e9\u30e1\u30fc\u30bf\u306b",(0,l.jsx)(t.code,{children:"java.time.LocalDate"}),"\u578b\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-java",children:'// SecurityEventHandler.updateStatistics() \u3088\u308a\nLocalDate eventDate = securityEvent\n    .createdAt()\n    .value()\n    .atZone(ZoneOffset.UTC)\n    .withZoneSameInstant(tenant.timezone())\n    .toLocalDate();\n\n// \u6708\u521d\u65e5\u306e\u8a08\u7b97\nLocalDate monthStart = eventDate.withDayOfMonth(1);\n\n// \u4f1a\u8a08\u5e74\u5ea6\u958b\u59cb\u65e5\u306e\u8a08\u7b97\uff08\u30c6\u30ca\u30f3\u30c8\u56fa\u6709\u306e\u4f1a\u8a08\u5e74\u5ea6\u306b\u5bfe\u5fdc\uff09\nLocalDate yearStart = calculateFiscalYearStart(eventDate, tenant.fiscalYearStartMonth());\n\n// Repository\u547c\u3073\u51fa\u3057\nstatisticsRepository.incrementDailyMetric(tenant.identifier(), monthStart, day, "dau", 1);\nyearlyStatisticsRepository.incrementYau(tenant.identifier(), yearStart, 1);\n'})}),"\n",(0,l.jsx)(t.h3,{id:"\u4f1a\u8a08\u5e74\u5ea6\u306e\u8a08\u7b97",children:"\u4f1a\u8a08\u5e74\u5ea6\u306e\u8a08\u7b97"}),"\n",(0,l.jsx)(t.p,{children:"\u30c6\u30ca\u30f3\u30c8\u3054\u3068\u306b\u8a2d\u5b9a\u3055\u308c\u305f\u4f1a\u8a08\u5e74\u5ea6\u958b\u59cb\u6708\u306b\u57fa\u3065\u3044\u3066\u3001\u4f1a\u8a08\u5e74\u5ea6\u958b\u59cb\u65e5\u3092\u8a08\u7b97\u3057\u307e\u3059\u3002"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-java",children:"/**\n * \u4f1a\u8a08\u5e74\u5ea6\u958b\u59cb\u65e5\u3092\u8a08\u7b97\n *\n * \u4f8b: startMonth = 4\uff084\u6708\u958b\u59cb\uff09\u306e\u5834\u5408\n *   2025-06-15 \u2192 2025-04-01\n *   2025-02-15 \u2192 2024-04-01\n *   2025-04-01 \u2192 2025-04-01\n *   2025-03-31 \u2192 2024-04-01\n */\nprivate LocalDate calculateFiscalYearStart(LocalDate date, int startMonth) {\n    LocalDate candidateStart = date.withMonth(startMonth).withDayOfMonth(1);\n    if (date.isBefore(candidateStart)) {\n        return candidateStart.minusYears(1);\n    }\n    return candidateStart;\n}\n"})}),"\n",(0,l.jsx)(t.h3,{id:"\u4f1a\u8a08\u5e74\u5ea6\u306e\u8a2d\u5b9a",children:"\u4f1a\u8a08\u5e74\u5ea6\u306e\u8a2d\u5b9a"}),"\n",(0,l.jsxs)(t.p,{children:["\u30c6\u30ca\u30f3\u30c8\u306e\u4f1a\u8a08\u5e74\u5ea6\u958b\u59cb\u6708\u306f ",(0,l.jsx)(t.code,{children:"TenantAttributes"})," \u3067\u8a2d\u5b9a\u3057\u307e\u3059:"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-json",children:'{\n  "attributes": {\n    "fiscal_year_start_month": 4\n  }\n}\n'})}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u8a2d\u5b9a\u5024"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u4f1a\u8a08\u5e74\u5ea6"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u4f8b"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsxs)(t.td,{style:{textAlign:"left"},children:[(0,l.jsx)(t.code,{children:"1"})," (\u30c7\u30d5\u30a9\u30eb\u30c8)"]}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"1\u6708\u301c12\u6708"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u30ab\u30ec\u30f3\u30c0\u30fc\u5e74"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"4"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"4\u6708\u301c\u7fcc3\u6708"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u65e5\u672c\u4f01\u696d\u306e\u4e00\u822c\u7684\u306a\u4f1a\u8a08\u5e74\u5ea6"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"10"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"10\u6708\u301c\u7fcc9\u6708"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u4e00\u90e8\u306e\u7c73\u56fd\u4f01\u696d"})]})]})]}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u8a2d\u8a08\u539f\u5247"}),":"]}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsxs)(t.li,{children:["API\u5c64\uff08",(0,l.jsx)(t.code,{children:"TenantStatisticsQueries"}),"\uff09\u3067\u306f",(0,l.jsx)(t.code,{children:"String"}),'\u578b\uff08"YYYY-MM"\u5f62\u5f0f\uff09\u3067\u30d1\u30e9\u30e1\u30fc\u30bf\u3092\u53d7\u3051\u53d6\u308b']}),"\n",(0,l.jsxs)(t.li,{children:["\u30af\u30a8\u30ea\u5b9f\u884c\u6642\u306b",(0,l.jsx)(t.code,{children:"LocalDate"}),"\u306b\u5909\u63db\uff08",(0,l.jsx)(t.code,{children:"fromAsLocalDate()"}),", ",(0,l.jsx)(t.code,{children:"toAsLocalDate()"}),"\uff09"]}),"\n",(0,l.jsxs)(t.li,{children:["\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5c64\u3067\u306f",(0,l.jsx)(t.code,{children:"LocalDate"}),"\u3092\u76f4\u63a5\u4f7f\u7528\uff08JDBC\u304c\u81ea\u52d5\u5909\u63db\uff09"]}),"\n"]}),"\n",(0,l.jsx)(t.h3,{id:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3067\u306e\u65b0\u898f\u30ec\u30b3\u30fc\u30c9\u691c\u51fa",children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3067\u306e\u65b0\u898f\u30ec\u30b3\u30fc\u30c9\u691c\u51fa"}),"\n",(0,l.jsxs)(t.p,{children:["PostgreSQL\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3067\u306f\u3001\u30b7\u30b9\u30c6\u30e0\u30ab\u30e9\u30e0",(0,l.jsx)(t.code,{children:"xmax"}),"\u3092\u4f7f\u7528\u3057\u305f\u65b0\u898f\u30ec\u30b3\u30fc\u30c9\u691c\u51fa\u304c\u3067\u304d\u307e\u305b\u3093\u3002"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-sql",children:"-- \u274c \u8aa4\u308a: \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u3067\u306f\u4f7f\u7528\u4e0d\u53ef\nINSERT INTO statistics_yearly_users (...)\nON CONFLICT (...) DO UPDATE SET last_used_at = NOW()\nRETURNING (xmax = 0) AS is_new\n\n-- \u2705 \u6b63\u89e3: RETURNING + DO NOTHING \u30d1\u30bf\u30fc\u30f3\nINSERT INTO statistics_yearly_users (...)\nON CONFLICT (...) DO NOTHING\nRETURNING user_id\n"})}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u5224\u5b9a\u30ed\u30b8\u30c3\u30af"}),":"]}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.code,{children:"RETURNING"}),"\u3067\u884c\u304c\u8fd4\u308b = \u65b0\u898fINSERT\u6210\u529f\uff08\u65b0\u898f\u30e6\u30fc\u30b6\u30fc\uff09"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.code,{children:"RETURNING"}),"\u3067\u884c\u304c\u8fd4\u3089\u306a\u3044 = CONFLICT\u767a\u751f\uff08\u65e2\u5b58\u30e6\u30fc\u30b6\u30fc\uff09"]}),"\n"]}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u6226\u7565",children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u6226\u7565"}),"\n",(0,l.jsx)(t.h3,{id:"pg_partman\u306b\u3088\u308b\u81ea\u52d5\u7ba1\u7406",children:"pg_partman\u306b\u3088\u308b\u81ea\u52d5\u7ba1\u7406"}),"\n",(0,l.jsx)(t.p,{children:"\u7d71\u8a08\u30e6\u30fc\u30b6\u30fc\u30c6\u30fc\u30d6\u30eb\u306f pg_partman \u62e1\u5f35\u3092\u4f7f\u7528\u3057\u305f\u81ea\u52d5\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u7ba1\u7406\u3092\u884c\u3044\u307e\u3059\u3002"}),"\n",(0,l.jsxs)(t.table,{children:[(0,l.jsx)(t.thead,{children:(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30c6\u30fc\u30d6\u30eb"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u9593\u9694"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u4fdd\u6301\u671f\u9593"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"premake"}),(0,l.jsx)(t.th,{style:{textAlign:"left"},children:"\u5099\u8003"})]})}),(0,l.jsxs)(t.tbody,{children:[(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"statistics_daily_users"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u65e5\u5225"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"90\u65e5"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"90"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"DAU\u8ffd\u8de1\uff08\u30c7\u30fc\u30bf\u91cf\u6700\u5927\uff09"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"statistics_monthly_users"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u6708\u5225"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"13\u30f6\u6708"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"13"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"MAU\u8ffd\u8de1\uff08YoY\u6bd4\u8f03\u7528\uff09"})]}),(0,l.jsxs)(t.tr,{children:[(0,l.jsx)(t.td,{style:{textAlign:"left"},children:(0,l.jsx)(t.code,{children:"statistics_yearly_users"})}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"\u6708\u5225"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"60\u30f6\u6708"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"60"}),(0,l.jsx)(t.td,{style:{textAlign:"left"},children:"YAU\u8ffd\u8de1\uff08\u4f1a\u8a08\u5e74\u5ea6\u5bfe\u5fdc\uff09"})]})]})]}),"\n",(0,l.jsxs)(t.blockquote,{children:["\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u4f1a\u8a08\u5e74\u5ea6\u5bfe\u5fdc"}),": ",(0,l.jsx)(t.code,{children:"statistics_yearly_users"})," \u306f\u6708\u5358\u4f4d\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u4f7f\u7528\u3057\u307e\u3059\u3002\n\u3053\u308c\u306b\u3088\u308a\u3001\u30c6\u30ca\u30f3\u30c8\u3054\u3068\u306b\u7570\u306a\u308b\u4f1a\u8a08\u5e74\u5ea6\u958b\u59cb\u6708\uff081\u6708\u30014\u6708\u300110\u6708\u306a\u3069\uff09\u306b\u5bfe\u5fdc\u3067\u304d\u307e\u3059\u3002\n\u4f8b: 4\u6708\u958b\u59cb\u30c6\u30ca\u30f3\u30c8\u306f ",(0,l.jsx)(t.code,{children:"partition_2025_04"}),"\u300110\u6708\u958b\u59cb\u30c6\u30ca\u30f3\u30c8\u306f ",(0,l.jsx)(t.code,{children:"partition_2025_10"})," \u306b\u683c\u7d0d\u3055\u308c\u307e\u3059\u3002"]}),"\n"]}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"DDL\u53c2\u7167"}),": ",(0,l.jsx)(t.code,{children:"V0_9_21_2__statistics.sql"})]}),"\n",(0,l.jsx)(t.h3,{id:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u306e\u30e1\u30ea\u30c3\u30c8",children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u306e\u30e1\u30ea\u30c3\u30c8"}),"\n",(0,l.jsxs)(t.ol,{children:["\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u30af\u30a8\u30ea\u6027\u80fd\u5411\u4e0a"}),": \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30d7\u30eb\u30fc\u30cb\u30f3\u30b0\u306b\u3088\u308a\u3001\u7279\u5b9a\u671f\u9593\u306e\u30af\u30a8\u30ea\u304c\u9ad8\u901f\u5316"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u52b9\u7387\u5316"}),": \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u5358\u4f4d\u3067\u306e\u7ba1\u7406\u304c\u53ef\u80fd"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.strong,{children:"\u81ea\u52d5\u7ba1\u7406"}),": pg_partman\u304c\u65b0\u898f\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u81ea\u52d5\u4f5c\u6210\u30fb\u53e4\u3044\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3092\u81ea\u52d5\u30a2\u30fc\u30ab\u30a4\u30d6"]}),"\n"]}),"\n",(0,l.jsx)(t.h3,{id:"\u30a2\u30fc\u30ab\u30a4\u30d6\u65b9\u5f0f",children:"\u30a2\u30fc\u30ab\u30a4\u30d6\u65b9\u5f0f"}),"\n",(0,l.jsxs)(t.p,{children:["\u53e4\u3044\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u306f\u524a\u9664\u305b\u305a\u3001",(0,l.jsx)(t.code,{children:"archive"}),"\u30b9\u30ad\u30fc\u30de\u306b\u79fb\u52d5\u3057\u307e\u3059\u3002"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-sql",children:"-- pg_partman\u8a2d\u5b9a\nretention_schema = 'archive'\nretention_keep_table = true\nretention_keep_index = true\n"})}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u30e1\u30ea\u30c3\u30c8"}),":"]}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsx)(t.li,{children:"\u76e3\u67fb\u30fb\u30b3\u30f3\u30d7\u30e9\u30a4\u30a2\u30f3\u30b9\u8981\u4ef6\u3078\u306e\u5bfe\u5fdc"}),"\n",(0,l.jsx)(t.li,{children:"\u5fc5\u8981\u6642\u306b\u30a2\u30fc\u30ab\u30a4\u30d6\u30c7\u30fc\u30bf\u3078\u306e\u30a2\u30af\u30bb\u30b9\u304c\u53ef\u80fd"}),"\n",(0,l.jsx)(t.li,{children:"\u8aa4\u524a\u9664\u306e\u30ea\u30b9\u30af\u8efd\u6e1b"}),"\n"]}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u30a2\u30fc\u30ab\u30a4\u30d6\u30c7\u30fc\u30bf\u306e\u53c2\u7167"}),":"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-sql",children:"-- \u30a2\u30fc\u30ab\u30a4\u30d6\u3055\u308c\u305fDAU\u30c7\u30fc\u30bf\u3092\u53c2\u7167\nSELECT * FROM archive.statistics_daily_users_p2024_01_01;\n"})}),"\n",(0,l.jsx)(t.h3,{id:"\u904b\u7528\u30ab\u30b9\u30bf\u30de\u30a4\u30ba",children:"\u904b\u7528\u30ab\u30b9\u30bf\u30de\u30a4\u30ba"}),"\n",(0,l.jsxs)(t.p,{children:["\u4fdd\u6301\u671f\u9593\u3084\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u306e\u5909\u66f4\u65b9\u6cd5\u306f ",(0,l.jsx)(t.a,{href:"/idp-server/docs/content_06_developer-guide/reference/database-partitioning-guide#12-%E9%81%8B%E7%94%A8%E3%82%AB%E3%82%B9%E3%82%BF%E3%83%9E%E3%82%A4%E3%82%BA",children:"database-partitioning-guide.md"})," \u3092\u53c2\u7167\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u8003\u616e\u4e8b\u9805",children:"\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u8003\u616e\u4e8b\u9805"}),"\n",(0,l.jsx)(t.h3,{id:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u6226\u7565",children:"\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u6226\u7565"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-sql",children:"-- \u6642\u7cfb\u5217\u30af\u30a8\u30ea\u7528\uff08\u6700\u983b\u51fa\uff09\nCREATE INDEX idx_statistics_monthly_tenant_month\n    ON statistics_monthly (tenant_id, stat_month DESC);\n\nCREATE INDEX idx_statistics_yearly_tenant_year\n    ON statistics_yearly (tenant_id, stat_year DESC);\n\n-- DAU/MAU/YAU\u30ab\u30a6\u30f3\u30c8\u30af\u30a8\u30ea\u7528\nCREATE INDEX idx_statistics_daily_users_tenant_date\n    ON statistics_daily_users (tenant_id, stat_date);\n\nCREATE INDEX idx_statistics_monthly_users_tenant_month\n    ON statistics_monthly_users (tenant_id, stat_month);\n\nCREATE INDEX idx_statistics_yearly_users_tenant_year\n    ON statistics_yearly_users (tenant_id, stat_year);\n\n-- \u975e\u30a2\u30af\u30c6\u30a3\u30d6\u30e6\u30fc\u30b6\u30fc\u691c\u7d22\u7528\nCREATE INDEX idx_statistics_yearly_users_last_used\n    ON statistics_yearly_users (tenant_id, last_used_at);\n"})}),"\n",(0,l.jsx)(t.h3,{id:"\u5897\u5206\u66f4\u65b0\u306b\u3088\u308b\u8ca0\u8377\u8efd\u6e1b",children:"\u5897\u5206\u66f4\u65b0\u306b\u3088\u308b\u8ca0\u8377\u8efd\u6e1b"}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u907f\u3051\u308b\u3079\u304d\u30d1\u30bf\u30fc\u30f3"}),":"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{children:"\u274c \u6bce\u56de\u5168\u30ec\u30b3\u30fc\u30c9\u3092\u518d\u8a08\u7b97\uff08\u9ad8\u30b3\u30b9\u30c8\uff09\n   statistics = load_all_events_today()\n   recalculate(statistics)\n"})}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u63a8\u5968\u30d1\u30bf\u30fc\u30f3"}),":"]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{children:"\u2705 \u5897\u5206\u66f4\u65b0\u306e\u307f\uff08\u4f4e\u30b3\u30b9\u30c8\uff09\n   incrementDailyMetric(tenant, month, day, metric, +1)\n"})}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0",children:"\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0"}),"\n",(0,l.jsx)(t.h3,{id:"\u7d71\u8a08\u66f4\u65b0\u30a8\u30e9\u30fc\u306e\u6319\u52d5",children:"\u7d71\u8a08\u66f4\u65b0\u30a8\u30e9\u30fc\u306e\u6319\u52d5"}),"\n",(0,l.jsx)(t.p,{children:"\u7d71\u8a08\u66f4\u65b0\u30a8\u30e9\u30fc\u306f\u8a8d\u8a3c\u30d5\u30ed\u30fc\u3092\u505c\u6b62\u3057\u307e\u305b\u3093\uff08\u758e\u7d50\u5408\u8a2d\u8a08\uff09\u3002"}),"\n",(0,l.jsx)(t.mermaid,{value:"flowchart TD\n    ERROR[\u7d71\u8a08\u66f4\u65b0\u30a8\u30e9\u30fc] --\x3e|\u30ed\u30b0\u8a18\u9332| LOG[\u30a8\u30e9\u30fc\u30ed\u30b0]\n    ERROR --\x3e|\u7d99\u7d9a| AUTH[\u8a8d\u8a3c\u30d5\u30ed\u30fc\u306f\u7d99\u7d9a]\n    LOG --\x3e|\u76e3\u8996| ALERT[\u30a2\u30e9\u30fc\u30c8\u767a\u706b]"}),"\n",(0,l.jsx)(t.h3,{id:"\u76e3\u8996\u3059\u3079\u304d\u6307\u6a19",children:"\u76e3\u8996\u3059\u3079\u304d\u6307\u6a19"}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsx)(t.li,{children:"\u7d71\u8a08\u66f4\u65b0\u306e\u6210\u529f\u7387"}),"\n",(0,l.jsx)(t.li,{children:"DAU/MAU\u306e\u6025\u6fc0\u306a\u5909\u52d5"}),"\n",(0,l.jsx)(t.li,{children:"\u30e1\u30c8\u30ea\u30af\u30b9\u66f4\u65b0\u306e\u30ec\u30a4\u30c6\u30f3\u30b7"}),"\n",(0,l.jsx)(t.li,{children:"pg_cron\u30b8\u30e7\u30d6\u306e\u5b9f\u884c\u72b6\u614b"}),"\n"]}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u30c7\u30fc\u30bf\u4fdd\u6301\u3068\u79fb\u884c",children:"\u30c7\u30fc\u30bf\u4fdd\u6301\u3068\u79fb\u884c"}),"\n",(0,l.jsx)(t.h3,{id:"\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u95a2\u6570",children:"\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u95a2\u6570"}),"\n",(0,l.jsx)(t.p,{children:"\u975e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u7528\u306e\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\u95a2\u6570\u304c\u63d0\u4f9b\u3055\u308c\u3066\u3044\u307e\u3059:"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-sql",children:"-- \u6708\u6b21\u7d71\u8a08\u30c7\u30fc\u30bf\u306e\u524a\u9664\uff08\u6307\u5b9a\u6708\u6570\u3088\u308a\u53e4\u3044\u30c7\u30fc\u30bf\uff09\nSELECT cleanup_old_statistics_monthly(25);  -- 25\u30f6\u6708\u3088\u308a\u53e4\u3044\u30c7\u30fc\u30bf\u3092\u524a\u9664\n\n-- \u5e74\u6b21\u7d71\u8a08\u30c7\u30fc\u30bf\u306e\u524a\u9664\uff08\u6307\u5b9a\u5e74\u6570\u3088\u308a\u53e4\u3044\u30c7\u30fc\u30bf\uff09\nSELECT cleanup_old_statistics_yearly(5);  -- 5\u5e74\u3088\u308a\u53e4\u3044\u30c7\u30fc\u30bf\u3092\u524a\u9664\n"})}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u30c6\u30fc\u30d6\u30eb\u306e\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7"}),": pg_partman \u304c ",(0,l.jsx)(t.code,{children:"retention"})," \u8a2d\u5b9a\u306b\u57fa\u3065\u3044\u3066\u81ea\u52d5\u524a\u9664\u3057\u307e\u3059\u3002"]}),"\n",(0,l.jsx)(t.h3,{id:"\u904e\u53bb\u30c7\u30fc\u30bf\u306e\u96c6\u8a08",children:"\u904e\u53bb\u30c7\u30fc\u30bf\u306e\u96c6\u8a08"}),"\n",(0,l.jsxs)(t.p,{children:["\u65e2\u5b58\u306e ",(0,l.jsx)(t.code,{children:"security_event"})," \u30c7\u30fc\u30bf\u304b\u3089\u7d71\u8a08\u3092\u518d\u69cb\u7bc9\u3059\u308b\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u63d0\u4f9b\u3055\u308c\u3066\u3044\u307e\u3059:"]}),"\n",(0,l.jsxs)(t.p,{children:[(0,l.jsx)(t.strong,{children:"\u53c2\u7167"}),": ",(0,l.jsx)(t.code,{children:"libs/idp-server-database/postgresql/operation/aggregate_historical_statistics.sql"})]}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-bash",children:"# \u57fa\u672c\u5b9f\u884c\uff08\u904e\u53bb12\u30f6\u6708\uff09\npsql -h <host> -U <user> -d <database> -f aggregate_historical_statistics.sql\n\n# \u65e5\u4ed8\u7bc4\u56f2\u6307\u5b9a\npsql -h <host> -U <user> -d <database> \\\n  -v start_date=\"'2024-01-01'\" \\\n  -v end_date=\"'2024-12-31'\" \\\n  -f aggregate_historical_statistics.sql\n"})}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8",children:"\u691c\u8a3c\u30b9\u30af\u30ea\u30d7\u30c8"}),"\n",(0,l.jsx)(t.p,{children:"pg_partman\u691c\u8a3c\u7528\u306e\u30b9\u30af\u30ea\u30d7\u30c8\u304c\u7528\u610f\u3055\u308c\u3066\u3044\u307e\u3059:"}),"\n",(0,l.jsx)(t.pre,{children:(0,l.jsx)(t.code,{className:"language-bash",children:"# pg_partman\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7\n./scripts/pg_partman/setup-pg_partman.sh\n\n# \u7d71\u8a08\u30e6\u30fc\u30b6\u30fc\u30c6\u30fc\u30d6\u30eb\u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u8a2d\u5b9a\n./scripts/pg_partman/statistics-users-pg_partman.sh\n\n# \u52d5\u4f5c\u691c\u8a3c\n./scripts/pg_partman/verify-pg_partman.sh\n\n# \u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\n./scripts/pg_partman/cleanup-pg_partman.sh\n"})}),"\n",(0,l.jsx)(t.hr,{}),"\n",(0,l.jsx)(t.h2,{id:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,l.jsxs)(t.ul,{children:["\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.a,{href:"/idp-server/docs/content_03_concepts/operations/concept-03-tenant-statistics",children:"\u30c6\u30ca\u30f3\u30c8\u7d71\u8a08\u7ba1\u7406"})," - \u6982\u5ff5\u30fbAPI\u4ed5\u69d8"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.a,{href:"/idp-server/docs/content_06_developer-guide/reference/database-partitioning-guide",children:"\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u30ac\u30a4\u30c9"})," - \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u8a73\u7d30"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.a,{href:"/idp-server/docs/content_06_developer-guide/reference/pg-partman-operations-guide",children:"pg_partman\u904b\u7528\u30ac\u30a4\u30c9"})," - pg_partman\u904b\u7528\u8a73\u7d30"]}),"\n",(0,l.jsxs)(t.li,{children:[(0,l.jsx)(t.a,{href:"/idp-server/docs/content_03_concepts/security-extensions/concept-01-security-events",children:"\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30a4\u30d9\u30f3\u30c8\u30fb\u30d5\u30c3\u30af"})," - \u30a4\u30d9\u30f3\u30c8\u99c6\u52d5\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3"]}),"\n"]})]})}function x(e={}){const{wrapper:t}={...(0,i.R)(),...e.components};return t?(0,l.jsx)(t,{...e,children:(0,l.jsx)(h,{...e})}):h(e)}},28453:(e,t,n)=>{n.d(t,{R:()=>d,x:()=>r});var s=n(96540);const l={},i=s.createContext(l);function d(e){const t=s.useContext(i);return s.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function r(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:d(e.components),s.createElement(i.Provider,{value:t},e.children)}}}]);