"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[1097],{845:(n,e,a)=>{a.r(e),a.d(e,{assets:()=>u,contentTitle:()=>c,default:()=>o,frontMatter:()=>t,metadata:()=>s,toc:()=>d});const s=JSON.parse('{"id":"content_11_learning/postgresql/dba-06-maintenance","title":"PostgreSQL \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30ac\u30a4\u30c9","description":"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001PostgreSQL\u306e\u5b9a\u671f\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3068\u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u5bfe\u7b56\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002","source":"@site/docs/content_11_learning/11-postgresql/dba-06-maintenance.md","sourceDirName":"content_11_learning/11-postgresql","slug":"/content_11_learning/postgresql/dba-06-maintenance","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-06-maintenance","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_11_learning/11-postgresql/dba-06-maintenance.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"PostgreSQL \u76e3\u8996\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-05-monitoring"},"next":{"title":"PostgreSQL \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-07-partitioning"}}');var l=a(74848),r=a(28453);const t={},c="PostgreSQL \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30ac\u30a4\u30c9",u={},d=[{value:"\u76ee\u6b21",id:"\u76ee\u6b21",level:2},{value:"1. \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u6982\u8981",id:"1-\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u6982\u8981",level:2},{value:"1.1 \u306a\u305c\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u304c\u5fc5\u8981\u304b",id:"11-\u306a\u305c\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u304c\u5fc5\u8981\u304b",level:3},{value:"1.2 \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4f5c\u696d\u306e\u4e00\u89a7",id:"12-\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4f5c\u696d\u306e\u4e00\u89a7",level:3},{value:"2. VACUUM",id:"2-vacuum",level:2},{value:"2.1 VACUUM\u306e\u7a2e\u985e",id:"21-vacuum\u306e\u7a2e\u985e",level:3},{value:"2.2 VACUUM\u306e\u5b9f\u884c",id:"22-vacuum\u306e\u5b9f\u884c",level:3},{value:"2.3 VACUUM\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",id:"23-vacuum\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",level:3},{value:"2.4 VACUUM\u306e\u9032\u6357\u78ba\u8a8d",id:"24-vacuum\u306e\u9032\u6357\u78ba\u8a8d",level:3},{value:"2.5 Freeze\u3068\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5468\u56de\u554f\u984c",id:"25-freeze\u3068\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5468\u56de\u554f\u984c",level:3},{value:"3. ANALYZE",id:"3-analyze",level:2},{value:"3.1 ANALYZE\u306e\u5f79\u5272",id:"31-analyze\u306e\u5f79\u5272",level:3},{value:"3.2 ANALYZE\u306e\u5b9f\u884c",id:"32-analyze\u306e\u5b9f\u884c",level:3},{value:"3.3 \u7d71\u8a08\u60c5\u5831\u306e\u78ba\u8a8d\u3068\u8abf\u6574",id:"33-\u7d71\u8a08\u60c5\u5831\u306e\u78ba\u8a8d\u3068\u8abf\u6574",level:3},{value:"3.4 ANALYZE\u306e\u9032\u6357\u78ba\u8a8d",id:"34-analyze\u306e\u9032\u6357\u78ba\u8a8d",level:3},{value:"4. REINDEX",id:"4-reindex",level:2},{value:"4.1 REINDEX\u304c\u5fc5\u8981\u306a\u5834\u5408",id:"41-reindex\u304c\u5fc5\u8981\u306a\u5834\u5408",level:3},{value:"4.2 REINDEX\u306e\u5b9f\u884c",id:"42-reindex\u306e\u5b9f\u884c",level:3},{value:"4.3 REINDEX CONCURRENTLY",id:"43-reindex-concurrently",level:3},{value:"4.4 \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u80a5\u5927\u5316\u306e\u78ba\u8a8d",id:"44-\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u80a5\u5927\u5316\u306e\u78ba\u8a8d",level:3},{value:"5. \u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u5bfe\u7b56",id:"5-\u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u5bfe\u7b56",level:2},{value:"5.1 \u80a5\u5927\u5316\u306e\u691c\u51fa",id:"51-\u80a5\u5927\u5316\u306e\u691c\u51fa",level:3},{value:"5.2 VACUUM FULL vs pg_repack",id:"52-vacuum-full-vs-pg_repack",level:3},{value:"5.3 pg_repack\u306e\u4f7f\u7528",id:"53-pg_repack\u306e\u4f7f\u7528",level:3},{value:"5.4 CLUSTER\u30b3\u30de\u30f3\u30c9",id:"54-cluster\u30b3\u30de\u30f3\u30c9",level:3},{value:"6. Autovacuum\u306e\u6700\u9069\u5316",id:"6-autovacuum\u306e\u6700\u9069\u5316",level:2},{value:"6.1 Autovacuum\u306e\u4ed5\u7d44\u307f",id:"61-autovacuum\u306e\u4ed5\u7d44\u307f",level:3},{value:"6.2 Autovacuum\u8a2d\u5b9a",id:"62-autovacuum\u8a2d\u5b9a",level:3},{value:"6.3 \u30c6\u30fc\u30d6\u30eb\u5358\u4f4d\u306e\u8a2d\u5b9a",id:"63-\u30c6\u30fc\u30d6\u30eb\u5358\u4f4d\u306e\u8a2d\u5b9a",level:3},{value:"6.4 Autovacuum\u306e\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0",id:"64-autovacuum\u306e\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0",level:3},{value:"6.5 Autovacuum\u306e\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0",id:"65-autovacuum\u306e\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0",level:3},{value:"7. \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb",id:"7-\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb",level:2},{value:"7.1 \u65e5\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9",id:"71-\u65e5\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9",level:3},{value:"7.2 \u9031\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9",id:"72-\u9031\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9",level:3},{value:"7.3 \u6708\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9",id:"73-\u6708\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9",level:3},{value:"7.4 cron\u3067\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb",id:"74-cron\u3067\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb",level:3},{value:"\u53c2\u8003\u30ea\u30f3\u30af",id:"\u53c2\u8003\u30ea\u30f3\u30af",level:2}];function i(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,r.R)(),...n.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(e.header,{children:(0,l.jsx)(e.h1,{id:"postgresql-\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30ac\u30a4\u30c9",children:"PostgreSQL \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30ac\u30a4\u30c9"})}),"\n",(0,l.jsx)(e.p,{children:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001PostgreSQL\u306e\u5b9a\u671f\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3068\u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u5bfe\u7b56\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002"}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"\u76ee\u6b21",children:"\u76ee\u6b21"}),"\n",(0,l.jsxs)(e.ol,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"#1-%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%81%AE%E6%A6%82%E8%A6%81",children:"\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u6982\u8981"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"#2-vacuum",children:"VACUUM"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"#3-analyze",children:"ANALYZE"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"#4-reindex",children:"REINDEX"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"#5-%E3%83%86%E3%83%BC%E3%83%96%E3%83%AB%E8%82%A5%E5%A4%A7%E5%8C%96%E5%AF%BE%E7%AD%96",children:"\u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u5bfe\u7b56"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"#6-autovacuum%E3%81%AE%E6%9C%80%E9%81%A9%E5%8C%96",children:"Autovacuum\u306e\u6700\u9069\u5316"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"#7-%E3%83%A1%E3%83%B3%E3%83%86%E3%83%8A%E3%83%B3%E3%82%B9%E3%82%B9%E3%82%B1%E3%82%B8%E3%83%A5%E3%83%BC%E3%83%AB",children:"\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb"})}),"\n"]}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"1-\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u6982\u8981",children:"1. \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u306e\u6982\u8981"}),"\n",(0,l.jsx)(e.h3,{id:"11-\u306a\u305c\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u304c\u5fc5\u8981\u304b",children:"1.1 \u306a\u305c\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u304c\u5fc5\u8981\u304b"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u304c\u5fc5\u8981\u306a\u7406\u7531                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010MVCC\u306b\u3088\u308b\u6b7b\u3093\u3060\u884c\u306e\u84c4\u7a4d\u3011                                \u2502\n\u2502                                                              \u2502\n\u2502  UPDATE\u6587\u306e\u52d5\u4f5c:                                             \u2502\n\u2502  1. \u65e2\u5b58\u884c\u3092\u300c\u524a\u9664\u6e08\u307f\u300d\u3068\u3057\u3066\u30de\u30fc\u30af (xmax\u3092\u8a2d\u5b9a)            \u2502\n\u2502  2. \u65b0\u3057\u3044\u884c\u3092\u633f\u5165                                           \u2502\n\u2502  \u2192 \u53e4\u3044\u884c\u304c\u300c\u6b7b\u3093\u3060\u884c (dead tuple)\u300d\u3068\u3057\u3066\u6b8b\u308b              \u2502\n\u2502                                                              \u2502\n\u2502  DELETE\u6587\u306e\u52d5\u4f5c:                                             \u2502\n\u2502  1. \u884c\u3092\u300c\u524a\u9664\u6e08\u307f\u300d\u3068\u3057\u3066\u30de\u30fc\u30af                             \u2502\n\u2502  \u2192 \u5b9f\u969b\u306b\u306f\u524a\u9664\u3055\u308c\u305a\u3001\u6b7b\u3093\u3060\u884c\u3068\u3057\u3066\u6b8b\u308b                   \u2502\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502\n\u2502  \u2502  \u30c6\u30fc\u30d6\u30eb                                              \u2502  \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2510           \u2502  \u2502\n\u2502  \u2502  \u2502Live \u2502 \u2502Dead \u2502 \u2502Live \u2502 \u2502Dead \u2502 \u2502Dead \u2502 ...       \u2502  \u2502\n\u2502  \u2502  \u2502Tuple\u2502 \u2502Tuple\u2502 \u2502Tuple\u2502 \u2502Tuple\u2502 \u2502Tuple\u2502           \u2502  \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2518           \u2502  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u554f\u984c\u3011                                                    \u2502\n\u2502  - \u30c7\u30a3\u30b9\u30af\u4f7f\u7528\u91cf\u306e\u5897\u52a0                                      \u2502\n\u2502  - \u30c6\u30fc\u30d6\u30eb\u30b9\u30ad\u30e3\u30f3\u306e\u52b9\u7387\u4f4e\u4e0b                                \u2502\n\u2502  - \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u80a5\u5927\u5316                                      \u2502\n\u2502  - \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3ID\u306e\u5468\u56de\u554f\u984c                              \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u89e3\u6c7a\u7b56\u3011                                                  \u2502\n\u2502  - VACUUM: \u6b7b\u3093\u3060\u884c\u306e\u9818\u57df\u3092\u518d\u5229\u7528\u53ef\u80fd\u306b\u3059\u308b                  \u2502\n\u2502  - ANALYZE: \u7d71\u8a08\u60c5\u5831\u3092\u66f4\u65b0\u3057\u3066\u30af\u30a8\u30ea\u30d7\u30e9\u30f3\u3092\u6700\u9069\u5316           \u2502\n\u2502  - REINDEX: \u80a5\u5927\u5316\u3057\u305f\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u518d\u69cb\u7bc9                   \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.h3,{id:"12-\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4f5c\u696d\u306e\u4e00\u89a7",children:"1.2 \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4f5c\u696d\u306e\u4e00\u89a7"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u4f5c\u696d\u4e00\u89a7                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502\n\u2502  \u2502 \u4f5c\u696d           \u2502 \u76ee\u7684                                   \u2502\u2502\n\u2502  \u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\u2502\n\u2502  \u2502 VACUUM         \u2502 \u6b7b\u3093\u3060\u884c\u306e\u9818\u57df\u3092\u518d\u5229\u7528\u53ef\u80fd\u306b\u3059\u308b       \u2502\u2502\n\u2502  \u2502 VACUUM FULL    \u2502 \u30c6\u30fc\u30d6\u30eb\u3092\u5b8c\u5168\u306b\u518d\u69cb\u7bc9 (\u6392\u4ed6\u30ed\u30c3\u30af)    \u2502\u2502\n\u2502  \u2502 ANALYZE        \u2502 \u7d71\u8a08\u60c5\u5831\u3092\u66f4\u65b0                         \u2502\u2502\n\u2502  \u2502 REINDEX        \u2502 \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u518d\u69cb\u7bc9                   \u2502\u2502\n\u2502  \u2502 CLUSTER        \u2502 \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u9806\u306b\u30c6\u30fc\u30d6\u30eb\u3092\u518d\u914d\u7f6e       \u2502\u2502\n\u2502  \u2502 pg_repack      \u2502 \u30aa\u30f3\u30e9\u30a4\u30f3\u3067\u30c6\u30fc\u30d6\u30eb/\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u518d\u69cb\u7bc9\u2502\u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"2-vacuum",children:"2. VACUUM"}),"\n",(0,l.jsx)(e.h3,{id:"21-vacuum\u306e\u7a2e\u985e",children:"2.1 VACUUM\u306e\u7a2e\u985e"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      VACUUM\u306e\u7a2e\u985e                             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010VACUUM (\u901a\u5e38)\u3011                                           \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 - \u6b7b\u3093\u3060\u884c\u3092\u300c\u518d\u5229\u7528\u53ef\u80fd\u300d\u3068\u3057\u3066\u30de\u30fc\u30af                \u2502   \u2502\n\u2502  \u2502 - \u30c7\u30a3\u30b9\u30af\u5bb9\u91cf\u306fOS\u306b\u8fd4\u3055\u306a\u3044                          \u2502   \u2502\n\u2502  \u2502 - \u30c6\u30fc\u30d6\u30eb\u3092\u30ed\u30c3\u30af\u3057\u306a\u3044 (\u540c\u6642\u306b\u8aad\u307f\u66f8\u304d\u53ef\u80fd)         \u2502   \u2502\n\u2502  \u2502 - \u6bd4\u8f03\u7684\u9ad8\u901f                                          \u2502   \u2502\n\u2502  \u2502 - \u65e5\u5e38\u7684\u306b\u4f7f\u7528 (Autovacuum\u3067\u81ea\u52d5\u5b9f\u884c)                 \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010VACUUM FULL\u3011                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 - \u30c6\u30fc\u30d6\u30eb\u3092\u5b8c\u5168\u306b\u518d\u69cb\u7bc9                              \u2502   \u2502\n\u2502  \u2502 - \u30c7\u30a3\u30b9\u30af\u5bb9\u91cf\u3092OS\u306b\u8fd4\u3059                              \u2502   \u2502\n\u2502  \u2502 - \u6392\u4ed6\u30ed\u30c3\u30af (ACCESS EXCLUSIVE) \u304c\u5fc5\u8981               \u2502   \u2502\n\u2502  \u2502 - \u4f5c\u696d\u4e2d\u306f\u30a2\u30af\u30bb\u30b9\u4e0d\u53ef                                \u2502   \u2502\n\u2502  \u2502 - \u6642\u9593\u304c\u304b\u304b\u308b                                        \u2502   \u2502\n\u2502  \u2502 - \u672c\u5f53\u306b\u5fc5\u8981\u306a\u5834\u5408\u306e\u307f\u4f7f\u7528                            \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010VACUUM ANALYZE\u3011                                          \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 - VACUUM + ANALYZE \u3092\u540c\u6642\u5b9f\u884c                         \u2502   \u2502\n\u2502  \u2502 - \u65e5\u5e38\u7684\u306b\u63a8\u5968                                        \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.h3,{id:"22-vacuum\u306e\u5b9f\u884c",children:"2.2 VACUUM\u306e\u5b9f\u884c"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u5168\u30c6\u30fc\u30d6\u30eb\u3092VACUUM\nVACUUM;\n\n-- \u7279\u5b9a\u30c6\u30fc\u30d6\u30eb\u3092VACUUM\nVACUUM users;\n\n-- VACUUM + ANALYZE\nVACUUM ANALYZE users;\n\n-- \u8a73\u7d30\u51fa\u529b\u4ed8\u304d\nVACUUM VERBOSE users;\n\n-- VACUUM FULL (\u6392\u4ed6\u30ed\u30c3\u30af\u3001\u6ce8\u610f\u304c\u5fc5\u8981)\nVACUUM FULL users;\n\n-- \u4e26\u5217VACUUM (PostgreSQL 13+)\nVACUUM (PARALLEL 4) users;\n"})}),"\n",(0,l.jsx)(e.h3,{id:"23-vacuum\u306e\u30aa\u30d7\u30b7\u30e7\u30f3",children:"2.3 VACUUM\u306e\u30aa\u30d7\u30b7\u30e7\u30f3"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- PostgreSQL 12+ \u306e\u69cb\u6587\nVACUUM (\n    FULL false,           -- \u901a\u5e38VACUUM\n    FREEZE false,         -- \u5f37\u5236\u7684\u306bFreeze\n    VERBOSE true,         -- \u8a73\u7d30\u51fa\u529b\n    ANALYZE true,         -- \u7d71\u8a08\u60c5\u5831\u3082\u66f4\u65b0\n    DISABLE_PAGE_SKIPPING false,  -- \u5168\u30da\u30fc\u30b8\u3092\u30b9\u30ad\u30e3\u30f3\n    SKIP_LOCKED false,    -- \u30ed\u30c3\u30af\u3055\u308c\u305f\u30c6\u30fc\u30d6\u30eb\u3092\u30b9\u30ad\u30c3\u30d7\n    INDEX_CLEANUP auto,   -- \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u30af\u30ea\u30fc\u30f3\u30a2\u30c3\u30d7\n    PROCESS_TOAST true,   -- TOAST\u30c6\u30fc\u30d6\u30eb\u3082\u51e6\u7406\n    TRUNCATE true,        -- \u672b\u5c3e\u306e\u7a7a\u30da\u30fc\u30b8\u3092\u5207\u308a\u8a70\u3081\n    PARALLEL 4            -- \u4e26\u5217\u30ef\u30fc\u30ab\u30fc\u6570\n) users;\n"})}),"\n",(0,l.jsx)(e.h3,{id:"24-vacuum\u306e\u9032\u6357\u78ba\u8a8d",children:"2.4 VACUUM\u306e\u9032\u6357\u78ba\u8a8d"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- VACUUM \u306e\u9032\u6357\u72b6\u6cc1\nSELECT\n    p.pid,\n    p.datname,\n    p.relid::regclass AS table_name,\n    p.phase,\n    p.heap_blks_total,\n    p.heap_blks_scanned,\n    p.heap_blks_vacuumed,\n    ROUND(100.0 * p.heap_blks_vacuumed / NULLIF(p.heap_blks_total, 0), 2) AS progress_pct,\n    p.index_vacuum_count,\n    p.max_dead_tuples,\n    p.num_dead_tuples\nFROM pg_stat_progress_vacuum p;\n\n-- Autovacuum\u306e\u5b9f\u884c\u72b6\u6cc1\nSELECT\n    pid,\n    datname,\n    relid::regclass AS table_name,\n    phase,\n    heap_blks_total,\n    heap_blks_scanned\nFROM pg_stat_progress_vacuum\nWHERE datname = current_database();\n"})}),"\n",(0,l.jsx)(e.h3,{id:"25-freeze\u3068\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5468\u56de\u554f\u984c",children:"2.5 Freeze\u3068\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5468\u56de\u554f\u984c"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502               \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3ID\u5468\u56de\u554f\u984c                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u554f\u984c\u3011                                                    \u2502\n\u2502  - \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3ID (XID) \u306f32\u30d3\u30c3\u30c8 (\u7d0442\u5104)             \u2502\n\u2502  - \u4f7f\u3044\u5207\u308b\u3068\u5468\u56de\u3059\u308b                                        \u2502\n\u2502  - \u53e4\u3044XID\u3068\u65b0\u3057\u3044XID\u306e\u533a\u5225\u304c\u3064\u304b\u306a\u304f\u306a\u308b                   \u2502\n\u2502  \u2192 \u30c7\u30fc\u30bf\u304c\u300c\u672a\u6765\u300d\u306e\u30c7\u30fc\u30bf\u3068\u3057\u3066\u898b\u3048\u306a\u304f\u306a\u308b               \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u5bfe\u7b56: Freeze\u51e6\u7406\u3011                                        \u2502\n\u2502  - VACUUM\u304c\u53e4\u3044XID\u3092\u300cFrozenXID\u300d\u306b\u7f6e\u304d\u63db\u3048                 \u2502\n\u2502  - FrozenXID\u306f\u300c\u5168\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u304b\u3089\u898b\u3048\u308b\u300d\u7279\u5225\u306aID       \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0\u3011                                            \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 SELECT datname, age(datfrozenxid) FROM pg_database;  \u2502   \u2502\n\u2502  \u2502                                                      \u2502   \u2502\n\u2502  \u2502 age() \u306e\u5024\u304c\u5927\u304d\u3044\u307b\u3069\u5371\u967a                           \u2502   \u2502\n\u2502  \u2502 - 10\u5104\u672a\u6e80: \u6b63\u5e38                                     \u2502   \u2502\n\u2502  \u2502 - 10\u5104-15\u5104: \u6ce8\u610f                                    \u2502   \u2502\n\u2502  \u2502 - 15\u5104-20\u5104: \u8b66\u544a\u3001VACUUM FREEZE\u3092\u691c\u8a0e              \u2502   \u2502\n\u2502  \u2502 - 20\u5104\u306b\u8fd1\u3044: \u7dca\u6025\u5bfe\u5fdc\u304c\u5fc5\u8981                         \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u30d5\u30ea\u30fc\u30ba\u5e74\u9f62\u3092\u78ba\u8a8d\nSELECT\n    datname,\n    age(datfrozenxid) AS age,\n    datfrozenxid\nFROM pg_database\nORDER BY age DESC;\n\n-- \u30c6\u30fc\u30d6\u30eb\u306e\u30d5\u30ea\u30fc\u30ba\u5e74\u9f62\u3092\u78ba\u8a8d\nSELECT\n    schemaname,\n    relname,\n    age(relfrozenxid) AS age,\n    relfrozenxid\nFROM pg_stat_user_tables\nORDER BY age DESC\nLIMIT 20;\n\n-- \u5f37\u5236\u7684\u306bFreeze\nVACUUM FREEZE users;\nVACUUM (FREEZE) users;\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"3-analyze",children:"3. ANALYZE"}),"\n",(0,l.jsx)(e.h3,{id:"31-analyze\u306e\u5f79\u5272",children:"3.1 ANALYZE\u306e\u5f79\u5272"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                     ANALYZE\u306e\u5f79\u5272                             \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u76ee\u7684\u3011                                                    \u2502\n\u2502  \u30c6\u30fc\u30d6\u30eb\u306e\u7d71\u8a08\u60c5\u5831\u3092\u53ce\u96c6\u3057\u3001                                \u2502\n\u2502  \u30d7\u30e9\u30f3\u30ca\u30fc\u304c\u6700\u9069\u306a\u5b9f\u884c\u8a08\u753b\u3092\u7acb\u3066\u3089\u308c\u308b\u3088\u3046\u306b\u3059\u308b            \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u53ce\u96c6\u3055\u308c\u308b\u60c5\u5831\u3011                                          \u2502\n\u2502  - \u884c\u6570 (reltuples)                                         \u2502\n\u2502  - \u30da\u30fc\u30b8\u6570 (relpages)                                      \u2502\n\u2502  - NULL\u5024\u306e\u5272\u5408 (null_frac)                                 \u2502\n\u2502  - \u30e6\u30cb\u30fc\u30af\u5024\u306e\u6570 (n_distinct)                              \u2502\n\u2502  - \u6700\u983b\u5024 (most_common_vals)                                \u2502\n\u2502  - \u30d2\u30b9\u30c8\u30b0\u30e9\u30e0 (histogram_bounds)                          \u2502\n\u2502  - \u76f8\u95a2 (correlation)                                       \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u3044\u3064\u5b9f\u884c\u3059\u3079\u304d\u304b\u3011                                        \u2502\n\u2502  - \u5927\u91cf\u306eINSERT/UPDATE/DELETE\u5f8c                             \u2502\n\u2502  - \u30c6\u30fc\u30d6\u30eb\u4f5c\u6210\u5f8c                                            \u2502\n\u2502  - \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u4f5c\u6210\u5f8c                                        \u2502\n\u2502  - \u30af\u30a8\u30ea\u306e\u5b9f\u884c\u8a08\u753b\u304c\u6700\u9069\u3067\u306a\u3044\u5834\u5408                          \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.h3,{id:"32-analyze\u306e\u5b9f\u884c",children:"3.2 ANALYZE\u306e\u5b9f\u884c"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u5168\u30c6\u30fc\u30d6\u30eb\u3092ANALYZE\nANALYZE;\n\n-- \u7279\u5b9a\u30c6\u30fc\u30d6\u30eb\u3092ANALYZE\nANALYZE users;\n\n-- \u7279\u5b9a\u30ab\u30e9\u30e0\u306e\u307f\nANALYZE users (email, status);\n\n-- \u8a73\u7d30\u51fa\u529b\u4ed8\u304d\nANALYZE VERBOSE users;\n\n-- VACUUM ANALYZE (\u63a8\u5968)\nVACUUM ANALYZE users;\n"})}),"\n",(0,l.jsx)(e.h3,{id:"33-\u7d71\u8a08\u60c5\u5831\u306e\u78ba\u8a8d\u3068\u8abf\u6574",children:"3.3 \u7d71\u8a08\u60c5\u5831\u306e\u78ba\u8a8d\u3068\u8abf\u6574"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u30c6\u30fc\u30d6\u30eb\u306e\u57fa\u672c\u7d71\u8a08\nSELECT\n    relname,\n    reltuples::bigint AS estimated_rows,\n    relpages\nFROM pg_class\nWHERE relname = 'users';\n\n-- \u30ab\u30e9\u30e0\u306e\u7d71\u8a08\u60c5\u5831\nSELECT\n    attname,\n    null_frac,\n    n_distinct,\n    most_common_vals,\n    most_common_freqs,\n    histogram_bounds\nFROM pg_stats\nWHERE tablename = 'users' AND attname = 'status';\n\n-- \u7d71\u8a08\u30b5\u30f3\u30d7\u30eb\u6570\u306e\u5909\u66f4 (\u3088\u308a\u6b63\u78ba\u306a\u7d71\u8a08\u304c\u5fc5\u8981\u306a\u5834\u5408)\nALTER TABLE users ALTER COLUMN status SET STATISTICS 500;\n-- \u30c7\u30d5\u30a9\u30eb\u30c8: 100, \u6700\u5927: 10000\n\nANALYZE users;\n"})}),"\n",(0,l.jsx)(e.h3,{id:"34-analyze\u306e\u9032\u6357\u78ba\u8a8d",children:"3.4 ANALYZE\u306e\u9032\u6357\u78ba\u8a8d"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- ANALYZE \u306e\u9032\u6357\u72b6\u6cc1 (PostgreSQL 13+)\nSELECT\n    pid,\n    datname,\n    relid::regclass AS table_name,\n    phase,\n    sample_blks_total,\n    sample_blks_scanned,\n    ROUND(100.0 * sample_blks_scanned / NULLIF(sample_blks_total, 0), 2) AS progress_pct\nFROM pg_stat_progress_analyze;\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"4-reindex",children:"4. REINDEX"}),"\n",(0,l.jsx)(e.h3,{id:"41-reindex\u304c\u5fc5\u8981\u306a\u5834\u5408",children:"4.1 REINDEX\u304c\u5fc5\u8981\u306a\u5834\u5408"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  REINDEX\u304c\u5fc5\u8981\u306a\u5834\u5408                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u80a5\u5927\u5316\u3011                                    \u2502\n\u2502  - \u5927\u91cf\u306eUPDATE/DELETE\u3067\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u80a5\u5927\u5316                \u2502\n\u2502  - \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u30b5\u30a4\u30ba\u304c\u30c6\u30fc\u30d6\u30eb\u3088\u308a\u5927\u304d\u304f\u306a\u308b\u3053\u3068\u3082        \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u7834\u640d\u3011                                      \u2502\n\u2502  - \u30cf\u30fc\u30c9\u30a6\u30a7\u30a2\u969c\u5bb3                                          \u2502\n\u2502  - \u30bd\u30d5\u30c8\u30a6\u30a7\u30a2\u30d0\u30b0                                          \u2502\n\u2502  - amcheck \u3067\u691c\u51fa\u53ef\u80fd                                        \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u52a3\u5316\u3011                                      \u2502\n\u2502  - \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30b9\u30ad\u30e3\u30f3\u304c\u9045\u304f\u306a\u3063\u305f                          \u2502\n\u2502  - explain \u3067\u9ad8\u30b3\u30b9\u30c8\u3092\u793a\u3057\u3066\u3044\u308b                            \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.h3,{id:"42-reindex\u306e\u5b9f\u884c",children:"4.2 REINDEX\u306e\u5b9f\u884c"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u7279\u5b9a\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u518d\u69cb\u7bc9\nREINDEX INDEX idx_users_email;\n\n-- \u30c6\u30fc\u30d6\u30eb\u306e\u5168\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u518d\u69cb\u7bc9\nREINDEX TABLE users;\n\n-- \u30b9\u30ad\u30fc\u30de\u306e\u5168\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u518d\u69cb\u7bc9\nREINDEX SCHEMA public;\n\n-- \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306e\u5168\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u518d\u69cb\u7bc9\nREINDEX DATABASE mydb;\n\n-- \u30b7\u30b9\u30c6\u30e0\u30ab\u30bf\u30ed\u30b0\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3082\u518d\u69cb\u7bc9\nREINDEX SYSTEM mydb;\n"})}),"\n",(0,l.jsx)(e.h3,{id:"43-reindex-concurrently",children:"4.3 REINDEX CONCURRENTLY"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u30aa\u30f3\u30e9\u30a4\u30f3\u3067\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u518d\u69cb\u7bc9 (PostgreSQL 12+)\n-- \u66f8\u304d\u8fbc\u307f\u3092\u30d6\u30ed\u30c3\u30af\u3057\u306a\u3044\nREINDEX INDEX CONCURRENTLY idx_users_email;\n\nREINDEX TABLE CONCURRENTLY users;\n\n-- \u6ce8\u610f\u70b9:\n-- - \u901a\u5e38\u306eREINDEX\u3088\u308a\u6642\u9593\u304c\u304b\u304b\u308b\n-- - \u4e00\u6642\u7684\u306b\u30c7\u30a3\u30b9\u30af\u5bb9\u91cf\u304c2\u500d\u5fc5\u8981\n-- - \u5931\u6557\u3059\u308b\u3068\u7121\u52b9\u306a\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u6b8b\u308b\u53ef\u80fd\u6027\n"})}),"\n",(0,l.jsx)(e.h3,{id:"44-\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u80a5\u5927\u5316\u306e\u78ba\u8a8d",children:"4.4 \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u80a5\u5927\u5316\u306e\u78ba\u8a8d"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u30b5\u30a4\u30ba\u3068\u30c6\u30fc\u30d6\u30eb\u30b5\u30a4\u30ba\u306e\u6bd4\u8f03\nSELECT\n    schemaname,\n    relname AS table_name,\n    indexrelname AS index_name,\n    pg_size_pretty(pg_relation_size(indexrelid)) AS index_size,\n    pg_size_pretty(pg_relation_size(relid)) AS table_size,\n    ROUND(100.0 * pg_relation_size(indexrelid) / NULLIF(pg_relation_size(relid), 0), 2) AS idx_to_tbl_ratio\nFROM pg_stat_user_indexes\nORDER BY pg_relation_size(indexrelid) DESC\nLIMIT 20;\n\n-- pgstattuple\u3067\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u80a5\u5927\u5316\u3092\u78ba\u8a8d\nCREATE EXTENSION IF NOT EXISTS pgstattuple;\n\nSELECT * FROM pgstatindex('idx_users_email');\n-- leaf_fragmentation \u304c\u9ad8\u3044\u5834\u5408\u306f\u80a5\u5927\u5316\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"5-\u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u5bfe\u7b56",children:"5. \u30c6\u30fc\u30d6\u30eb\u80a5\u5927\u5316\u5bfe\u7b56"}),"\n",(0,l.jsx)(e.h3,{id:"51-\u80a5\u5927\u5316\u306e\u691c\u51fa",children:"5.1 \u80a5\u5927\u5316\u306e\u691c\u51fa"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u6b7b\u3093\u3060\u884c\u304c\u591a\u3044\u30c6\u30fc\u30d6\u30eb\nSELECT\n    schemaname,\n    relname,\n    n_live_tup,\n    n_dead_tup,\n    ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) AS dead_ratio,\n    pg_size_pretty(pg_total_relation_size(schemaname || '.' || relname)) AS total_size,\n    last_vacuum,\n    last_autovacuum\nFROM pg_stat_user_tables\nWHERE n_dead_tup > 10000\nORDER BY n_dead_tup DESC;\n\n-- pgstattuple\u3067\u8a73\u7d30\u78ba\u8a8d (\u6642\u9593\u304c\u304b\u304b\u308b)\nSELECT * FROM pgstattuple('users');\n\n-- \u7d50\u679c\u306e\u898b\u65b9:\n-- dead_tuple_percent: \u6b7b\u3093\u3060\u884c\u306e\u5272\u5408\n-- free_percent: \u7a7a\u304d\u9818\u57df\u306e\u5272\u5408\n-- \u4e21\u65b9\u304c\u9ad8\u3044\u5834\u5408\u306f\u80a5\u5927\u5316\n"})}),"\n",(0,l.jsx)(e.h3,{id:"52-vacuum-full-vs-pg_repack",children:"5.2 VACUUM FULL vs pg_repack"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              VACUUM FULL vs pg_repack                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010VACUUM FULL\u3011                                             \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 \u2705 \u6a19\u6e96\u6a5f\u80fd                                           \u2502   \u2502\n\u2502  \u2502 \u2705 \u78ba\u5b9f\u306b\u30c7\u30a3\u30b9\u30af\u9818\u57df\u3092\u89e3\u653e                           \u2502   \u2502\n\u2502  \u2502 \u274c \u6392\u4ed6\u30ed\u30c3\u30af (\u30c6\u30fc\u30d6\u30eb\u306b\u30a2\u30af\u30bb\u30b9\u4e0d\u53ef)               \u2502   \u2502\n\u2502  \u2502 \u274c \u9577\u6642\u9593\u304b\u304b\u308b                                       \u2502   \u2502\n\u2502  \u2502 \u274c \u4f5c\u696d\u4e2d\u306f\u8ffd\u52a0\u306e\u30c7\u30a3\u30b9\u30af\u5bb9\u91cf\u304c\u5fc5\u8981                   \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010pg_repack\u3011                                               \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 \u2705 \u30aa\u30f3\u30e9\u30a4\u30f3\u3067\u5b9f\u884c\u53ef\u80fd (\u8aad\u307f\u66f8\u304d\u53ef\u80fd)               \u2502   \u2502\n\u2502  \u2502 \u2705 \u6700\u5c0f\u9650\u306e\u30ed\u30c3\u30af\u6642\u9593                                 \u2502   \u2502\n\u2502  \u2502 \u2705 \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3082\u540c\u6642\u306b\u518d\u69cb\u7bc9                         \u2502   \u2502\n\u2502  \u2502 \u274c \u62e1\u5f35\u6a5f\u80fd\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u304c\u5fc5\u8981                       \u2502   \u2502\n\u2502  \u2502 \u274c \u4e00\u6642\u7684\u306b\u30c7\u30a3\u30b9\u30af\u5bb9\u91cf\u304c2\u500d\u5fc5\u8981                      \u2502   \u2502\n\u2502  \u2502 \u274c \u4e3b\u30ad\u30fc\u307e\u305f\u306f\u30e6\u30cb\u30fc\u30af\u5236\u7d04\u304c\u5fc5\u8981                     \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u63a8\u5968\u3011                                                    \u2502\n\u2502  - \u672c\u756a\u74b0\u5883: pg_repack                                      \u2502\n\u2502  - \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30a6\u30a3\u30f3\u30c9\u30a6\u3042\u308a: VACUUM FULL                  \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.h3,{id:"53-pg_repack\u306e\u4f7f\u7528",children:"5.3 pg_repack\u306e\u4f7f\u7528"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# \u30a4\u30f3\u30b9\u30c8\u30fc\u30eb (RHEL\u7cfb)\nsudo dnf install pg_repack_16\n\n# \u57fa\u672c\u7684\u306a\u4f7f\u7528\u6cd5\npg_repack -d mydb -t users\n\n# \u5168\u30c6\u30fc\u30d6\u30eb\npg_repack -d mydb\n\n# \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u307f\npg_repack -d mydb -t users --only-indexes\n\n# \u4e26\u5217\u5b9f\u884c\npg_repack -d mydb -t users -j 4\n\n# \u30c9\u30e9\u30a4\u30e9\u30f3\npg_repack -d mydb -t users --dry-run\n"})}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u62e1\u5f35\u306e\u4f5c\u6210\nCREATE EXTENSION pg_repack;\n"})}),"\n",(0,l.jsx)(e.h3,{id:"54-cluster\u30b3\u30de\u30f3\u30c9",children:"5.4 CLUSTER\u30b3\u30de\u30f3\u30c9"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u9806\u306b\u30c6\u30fc\u30d6\u30eb\u3092\u7269\u7406\u7684\u306b\u518d\u914d\u7f6e\n-- \u6392\u4ed6\u30ed\u30c3\u30af\u304c\u5fc5\u8981\nCLUSTER users USING idx_users_created_at;\n\n-- \u4ee5\u524d\u306bCLUSTER\u3057\u305f\u30c6\u30fc\u30d6\u30eb\u3092\u518dCLUSTER\nCLUSTER users;\n\n-- \u5168\u30c6\u30fc\u30d6\u30eb\nCLUSTER;\n\n-- \u6ce8\u610f:\n-- - INSERT\u5f8c\u306f\u9806\u5e8f\u304c\u5d29\u308c\u308b\n-- - \u5b9a\u671f\u7684\u306a\u518dCLUSTER\u304c\u5fc5\u8981\n-- - pg_repack --order-by \u3067\u4ee3\u66ff\u53ef\u80fd\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"6-autovacuum\u306e\u6700\u9069\u5316",children:"6. Autovacuum\u306e\u6700\u9069\u5316"}),"\n",(0,l.jsx)(e.h3,{id:"61-autovacuum\u306e\u4ed5\u7d44\u307f",children:"6.1 Autovacuum\u306e\u4ed5\u7d44\u307f"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   Autovacuum\u306e\u4ed5\u7d44\u307f                          \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                                       \u2502\n\u2502  \u2502 Autovacuum        \u2502 \u2190 autovacuum_naptime (60\u79d2) \u3054\u3068\u306b   \u2502\n\u2502  \u2502 Launcher          \u2502   \u30c6\u30fc\u30d6\u30eb\u3092\u30c1\u30a7\u30c3\u30af                  \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                                       \u2502\n\u2502            \u2502 \u6761\u4ef6\u3092\u6e80\u305f\u3059\u30c6\u30fc\u30d6\u30eb\u306b\u5bfe\u3057\u3066                    \u2502\n\u2502            \u25bc                                                 \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                \u2502\n\u2502  \u2502 Autovacuum        \u2502 \u2502 Autovacuum        \u2502 ...            \u2502\n\u2502  \u2502 Worker 1          \u2502 \u2502 Worker 2          \u2502                 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                \u2502\n\u2502                                                              \u2502\n\u2502  \u3010VACUUM\u8d77\u52d5\u6761\u4ef6\u3011                                          \u2502\n\u2502  dead tuples > vacuum_threshold + vacuum_scale_factor \xd7 rows \u2502\n\u2502  \u30c7\u30d5\u30a9\u30eb\u30c8: 50 + 0.2 \xd7 \u30c6\u30fc\u30d6\u30eb\u884c\u6570                         \u2502\n\u2502                                                              \u2502\n\u2502  \u4f8b: 10,000\u884c\u306e\u30c6\u30fc\u30d6\u30eb                                      \u2502\n\u2502      50 + 0.2 \xd7 10,000 = 2,050                              \u2502\n\u2502      \u2192 2,050\u4ef6\u306e\u6b7b\u3093\u3060\u884c\u3067VACUUM\u8d77\u52d5                        \u2502\n\u2502                                                              \u2502\n\u2502  \u3010ANALYZE\u8d77\u52d5\u6761\u4ef6\u3011                                         \u2502\n\u2502  modified rows > analyze_threshold + analyze_scale_factor \xd7 rows\u2502\n\u2502  \u30c7\u30d5\u30a9\u30eb\u30c8: 50 + 0.1 \xd7 \u30c6\u30fc\u30d6\u30eb\u884c\u6570                         \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.h3,{id:"62-autovacuum\u8a2d\u5b9a",children:"6.2 Autovacuum\u8a2d\u5b9a"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf\n\n# Autovacuum\u306e\u6709\u52b9\u5316\nautovacuum = on\n\n# \u30ef\u30fc\u30ab\u30fc\u6570\nautovacuum_max_workers = 3      # \u540c\u6642\u5b9f\u884c\u6570\n\n# \u30c1\u30a7\u30c3\u30af\u9593\u9694\nautovacuum_naptime = 60         # \u79d2\n\n# VACUUM\u8d77\u52d5\u95be\u5024\nautovacuum_vacuum_threshold = 50\nautovacuum_vacuum_scale_factor = 0.2\n\n# ANALYZE\u8d77\u52d5\u95be\u5024\nautovacuum_analyze_threshold = 50\nautovacuum_analyze_scale_factor = 0.1\n\n# \u30b3\u30b9\u30c8\u5236\u9650 (I/O\u8ca0\u8377\u5236\u5fa1)\nautovacuum_vacuum_cost_delay = 2ms\nautovacuum_vacuum_cost_limit = 200\n\n# Freeze\u8a2d\u5b9a\nautovacuum_freeze_max_age = 200000000\nvacuum_freeze_table_age = 150000000\nvacuum_freeze_min_age = 50000000\n"})}),"\n",(0,l.jsx)(e.h3,{id:"63-\u30c6\u30fc\u30d6\u30eb\u5358\u4f4d\u306e\u8a2d\u5b9a",children:"6.3 \u30c6\u30fc\u30d6\u30eb\u5358\u4f4d\u306e\u8a2d\u5b9a"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- \u5927\u91cf\u66f4\u65b0\u304c\u3042\u308b\u30c6\u30fc\u30d6\u30eb: \u3088\u308a\u983b\u7e41\u306bVACUUM\nALTER TABLE high_update_table SET (\n    autovacuum_vacuum_scale_factor = 0.05,  -- 5%\u3067\u8d77\u52d5\n    autovacuum_analyze_scale_factor = 0.02,\n    autovacuum_vacuum_cost_limit = 1000     -- \u3088\u308a\u7a4d\u6975\u7684\u306b\n);\n\n-- \u5927\u304d\u306a\u30c6\u30fc\u30d6\u30eb: \u95be\u5024\u3092\u7d76\u5bfe\u5024\u3067\u8a2d\u5b9a\nALTER TABLE huge_table SET (\n    autovacuum_vacuum_threshold = 10000,     -- \u56fa\u5b9a\u95be\u5024\n    autovacuum_vacuum_scale_factor = 0,      -- \u5272\u5408\u3092\u7121\u52b9\u5316\n    autovacuum_vacuum_cost_delay = 0         -- \u5236\u9650\u306a\u3057\n);\n\n-- \u307b\u3068\u3093\u3069\u66f4\u65b0\u3055\u308c\u306a\u3044\u30c6\u30fc\u30d6\u30eb: VACUUM\u983b\u5ea6\u3092\u4e0b\u3052\u308b\nALTER TABLE static_table SET (\n    autovacuum_vacuum_scale_factor = 0.5,\n    autovacuum_analyze_scale_factor = 0.5\n);\n\n-- \u8a2d\u5b9a\u306e\u78ba\u8a8d\nSELECT relname, reloptions\nFROM pg_class\nWHERE relname = 'high_update_table';\n"})}),"\n",(0,l.jsx)(e.h3,{id:"64-autovacuum\u306e\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0",children:"6.4 Autovacuum\u306e\u30e2\u30cb\u30bf\u30ea\u30f3\u30b0"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-sql",children:"-- Autovacuum\u306e\u52d5\u4f5c\u72b6\u6cc1\nSELECT\n    schemaname,\n    relname,\n    last_vacuum,\n    last_autovacuum,\n    vacuum_count,\n    autovacuum_count,\n    n_dead_tup\nFROM pg_stat_user_tables\nWHERE last_autovacuum IS NOT NULL\nORDER BY last_autovacuum DESC;\n\n-- \u73fe\u5728\u5b9f\u884c\u4e2d\u306eAutovacuum\nSELECT\n    pid,\n    datname,\n    relid::regclass AS table_name,\n    phase,\n    heap_blks_total,\n    heap_blks_vacuumed,\n    index_vacuum_count\nFROM pg_stat_progress_vacuum;\n\n-- Autovacuum\u304c\u30d6\u30ed\u30c3\u30af\u3055\u308c\u3066\u3044\u308b\u304b\nSELECT\n    a.pid,\n    a.query,\n    b.pid AS blocking_pid,\n    b.query AS blocking_query\nFROM pg_stat_activity a\nJOIN pg_stat_activity b ON b.pid = ANY(pg_blocking_pids(a.pid))\nWHERE a.query LIKE 'autovacuum%';\n"})}),"\n",(0,l.jsx)(e.h3,{id:"65-autovacuum\u306e\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0",children:"6.5 Autovacuum\u306e\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502            Autovacuum\u306e\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0                 \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u554f\u984c1\u3011Autovacuum\u304c\u8ffd\u3044\u3064\u304b\u306a\u3044                           \u2502\n\u2502  \u75c7\u72b6: dead tuples \u304c\u5897\u3048\u7d9a\u3051\u308b                              \u2502\n\u2502  \u5bfe\u7b56:                                                       \u2502\n\u2502  - autovacuum_max_workers \u3092\u5897\u3084\u3059                          \u2502\n\u2502  - autovacuum_vacuum_cost_limit \u3092\u5897\u3084\u3059                    \u2502\n\u2502  - autovacuum_vacuum_cost_delay \u3092\u6e1b\u3089\u3059                    \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u554f\u984c2\u3011Autovacuum\u304c\u8d77\u52d5\u3057\u306a\u3044                             \u2502\n\u2502  \u75c7\u72b6: \u5927\u91cf\u306e dead tuples \u304c\u3042\u308b\u306e\u306bVACUUM\u3055\u308c\u306a\u3044          \u2502\n\u2502  \u78ba\u8a8d:                                                       \u2502\n\u2502  - autovacuum = on \u304b\u78ba\u8a8d                                   \u2502\n\u2502  - \u30c6\u30fc\u30d6\u30eb\u5358\u4f4d\u306e\u8a2d\u5b9a\u3092\u78ba\u8a8d                                  \u2502\n\u2502  - \u30ed\u30f3\u30b0\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u304c\u306a\u3044\u304b\u78ba\u8a8d                        \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u554f\u984c3\u3011Autovacuum\u304c\u9045\u3044                                   \u2502\n\u2502  \u75c7\u72b6: \u9577\u6642\u9593\u5b9f\u884c\u3055\u308c\u3066\u3044\u308b                                  \u2502\n\u2502  \u78ba\u8a8d:                                                       \u2502\n\u2502  - maintenance_work_mem \u304c\u5341\u5206\u304b                            \u2502\n\u2502  - I/O\u8ca0\u8377\u304c\u9ad8\u304f\u306a\u3044\u304b                                      \u2502\n\u2502  - \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u304c\u591a\u3059\u304e\u306a\u3044\u304b                                \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u554f\u984c4\u3011\u30ed\u30f3\u30b0\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u306b\u3088\u308bVACUUM\u963b\u5bb3             \u2502\n\u2502  \u75c7\u72b6: VACUUM\u3057\u3066\u3082 dead tuples \u304c\u6e1b\u3089\u306a\u3044                  \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 SELECT pid, now() - xact_start AS duration, query   \u2502   \u2502\n\u2502  \u2502 FROM pg_stat_activity                               \u2502   \u2502\n\u2502  \u2502 WHERE xact_start < now() - interval '1 hour';      \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"7-\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb",children:"7. \u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb"}),"\n",(0,l.jsx)(e.h3,{id:"71-\u65e5\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9",children:"7.1 \u65e5\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# daily_maintenance.sh\n\nPGHOST="${PGHOST:-localhost}"\nPGUSER="${PGUSER:-postgres}"\nLOG_FILE="/var/log/pg_maintenance/daily_$(date +%Y%m%d).log"\n\nexec > >(tee -a $LOG_FILE) 2>&1\n\necho "=== Daily Maintenance Started: $(date) ==="\n\n# \u7d71\u8a08\u60c5\u5831\u306e\u78ba\u8a8d\npsql -h $PGHOST -U $PGUSER -d mydb << \'EOF\'\n-- \u6b7b\u3093\u3060\u884c\u304c\u591a\u3044\u30c6\u30fc\u30d6\u30eb\nSELECT schemaname, relname, n_dead_tup, last_autovacuum\nFROM pg_stat_user_tables\nWHERE n_dead_tup > 10000\nORDER BY n_dead_tup DESC\nLIMIT 10;\n\n-- \u30d5\u30ea\u30fc\u30ba\u304c\u5fc5\u8981\u306a\u30c6\u30fc\u30d6\u30eb\nSELECT schemaname, relname, age(relfrozenxid)\nFROM pg_stat_user_tables\nWHERE age(relfrozenxid) > 1000000000\nORDER BY age(relfrozenxid) DESC;\nEOF\n\necho "=== Daily Maintenance Completed: $(date) ==="\n'})}),"\n",(0,l.jsx)(e.h3,{id:"72-\u9031\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9",children:"7.2 \u9031\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# weekly_maintenance.sh\n\nPGHOST="${PGHOST:-localhost}"\nPGUSER="${PGUSER:-postgres}"\nLOG_FILE="/var/log/pg_maintenance/weekly_$(date +%Y%m%d).log"\n\nexec > >(tee -a $LOG_FILE) 2>&1\n\necho "=== Weekly Maintenance Started: $(date) ==="\n\n# \u5168\u30c6\u30fc\u30d6\u30eb\u306e VACUUM ANALYZE\npsql -h $PGHOST -U $PGUSER -d mydb -c "VACUUM ANALYZE;"\n\n# \u4f7f\u7528\u3055\u308c\u3066\u3044\u306a\u3044\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u30ec\u30dd\u30fc\u30c8\npsql -h $PGHOST -U $PGUSER -d mydb << \'EOF\'\nSELECT schemaname, relname, indexrelname, idx_scan,\n       pg_size_pretty(pg_relation_size(indexrelid)) AS size\nFROM pg_stat_user_indexes\nWHERE idx_scan = 0\n  AND indexrelname NOT LIKE \'%_pkey\'\nORDER BY pg_relation_size(indexrelid) DESC;\nEOF\n\necho "=== Weekly Maintenance Completed: $(date) ==="\n'})}),"\n",(0,l.jsx)(e.h3,{id:"73-\u6708\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9",children:"7.3 \u6708\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:'#!/bin/bash\n# monthly_maintenance.sh\n\nPGHOST="${PGHOST:-localhost}"\nPGUSER="${PGUSER:-postgres}"\nLOG_FILE="/var/log/pg_maintenance/monthly_$(date +%Y%m%d).log"\n\nexec > >(tee -a $LOG_FILE) 2>&1\n\necho "=== Monthly Maintenance Started: $(date) ==="\n\n# \u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u306e\u518d\u69cb\u7bc9 (\u5927\u304d\u304f\u80a5\u5927\u5316\u3057\u305f\u3082\u306e\u306e\u307f)\npsql -h $PGHOST -U $PGUSER -d mydb << \'EOF\'\n-- \u80a5\u5927\u5316\u7387\u304c\u9ad8\u3044\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u7279\u5b9a\nSELECT indexrelname, pg_size_pretty(pg_relation_size(indexrelid))\nFROM pg_stat_user_indexes ui\nJOIN pg_index i ON ui.indexrelid = i.indexrelid\nWHERE pg_relation_size(ui.indexrelid) > 100 * 1024 * 1024  -- 100MB\u4ee5\u4e0a\nORDER BY pg_relation_size(ui.indexrelid) DESC;\nEOF\n\n# pg_repack\u3067\u80a5\u5927\u5316\u30c6\u30fc\u30d6\u30eb\u3092\u518d\u69cb\u7bc9\nfor table in $(psql -h $PGHOST -U $PGUSER -d mydb -t -c "\n    SELECT schemaname || \'.\' || relname\n    FROM pg_stat_user_tables\n    WHERE ROUND(100.0 * n_dead_tup / NULLIF(n_live_tup + n_dead_tup, 0), 2) > 20\n    AND pg_total_relation_size(schemaname || \'.\' || relname) > 1073741824  -- 1GB\u4ee5\u4e0a\n"); do\n    echo "Repacking: $table"\n    pg_repack -h $PGHOST -U $PGUSER -d mydb -t "$table"\ndone\n\necho "=== Monthly Maintenance Completed: $(date) ==="\n'})}),"\n",(0,l.jsx)(e.h3,{id:"74-cron\u3067\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb",children:"7.4 cron\u3067\u306e\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb"}),"\n",(0,l.jsx)(e.pre,{children:(0,l.jsx)(e.code,{className:"language-bash",children:"# /etc/cron.d/pg_maintenance\n\n# \u65e5\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9 (\u6bce\u65e5\u5348\u524d3\u6642)\n0 3 * * * postgres /opt/scripts/daily_maintenance.sh\n\n# \u9031\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9 (\u6bce\u9031\u65e5\u66dc\u5348\u524d4\u6642)\n0 4 * * 0 postgres /opt/scripts/weekly_maintenance.sh\n\n# \u6708\u6b21\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9 (\u6bce\u67081\u65e5\u5348\u524d5\u6642)\n0 5 1 * * postgres /opt/scripts/monthly_maintenance.sh\n"})}),"\n",(0,l.jsx)(e.hr,{}),"\n",(0,l.jsx)(e.h2,{id:"\u53c2\u8003\u30ea\u30f3\u30af",children:"\u53c2\u8003\u30ea\u30f3\u30af"}),"\n",(0,l.jsxs)(e.ul,{children:["\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/maintenance.html",children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 - \u30eb\u30fc\u30c1\u30f3\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/sql-vacuum.html",children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 - VACUUM"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/routine-vacuuming.html#AUTOVACUUM",children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 - Autovacuum"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://reorg.github.io/pg_repack/",children:"pg_repack"})}),"\n",(0,l.jsx)(e.li,{children:(0,l.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/pgstattuple.html",children:"pgstattuple"})}),"\n"]})]})}function o(n={}){const{wrapper:e}={...(0,r.R)(),...n.components};return e?(0,l.jsx)(e,{...n,children:(0,l.jsx)(i,{...n})}):i(n)}},28453:(n,e,a)=>{a.d(e,{R:()=>t,x:()=>c});var s=a(96540);const l={},r=s.createContext(l);function t(n){const e=s.useContext(r);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function c(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(l):n.components||l:t(n.components),s.createElement(r.Provider,{value:e},n.children)}}}]);