"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[2009],{77730:(n,e,i)=>{i.r(e),i.d(e,{assets:()=>o,contentTitle:()=>l,default:()=>p,frontMatter:()=>s,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"content_06_developer-guide/implementation-guides/infrastructure/multi-tenancy","title":"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8","description":"\ud83d\udccd \u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f4d\u7f6e\u3065\u3051","source":"@site/docs/content_06_developer-guide/04-implementation-guides/infrastructure/multi-tenancy.md","sourceDirName":"content_06_developer-guide/04-implementation-guides/infrastructure","slug":"/content_06_developer-guide/implementation-guides/infrastructure/multi-tenancy","permalink":"/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/multi-tenancy","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_06_developer-guide/04-implementation-guides/infrastructure/multi-tenancy.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"\u30de\u30eb\u30c1\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9","permalink":"/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/multi-datasource"},"next":{"title":"Repository","permalink":"/idp-server/docs/content_06_developer-guide/implementation-guides/infrastructure/repository"}}');var r=i(74848),a=i(28453);const s={},l="\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8",o={},d=[{value:"\ud83d\udccd \u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f4d\u7f6e\u3065\u3051",id:"-\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f4d\u7f6e\u3065\u3051",level:2},{value:"\ud83c\udfd7\ufe0f \u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u6982\u8981",id:"\ufe0f-\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u6982\u8981",level:2},{value:"\u8a2d\u8a08\u539f\u5247",id:"\u8a2d\u8a08\u539f\u5247",level:3},{value:"1. Tenant-First Design",id:"1-tenant-first-design",level:4},{value:"2. \u4e8c\u91cd\u9632\u5fa1\uff08Defense in Depth\uff09",id:"2-\u4e8c\u91cd\u9632\u5fa1defense-in-depth",level:4},{value:"3. Organization-Tenant \u968e\u5c64\u69cb\u9020",id:"3-organization-tenant-\u968e\u5c64\u69cb\u9020",level:4},{value:"\ud83d\udce6 \u30b3\u30a2\u30e2\u30c7\u30eb",id:"-\u30b3\u30a2\u30e2\u30c7\u30eb",level:2},{value:"Tenant",id:"tenant",level:3},{value:"TenantIdentifier",id:"tenantidentifier",level:3},{value:"TenantType",id:"tenanttype",level:3},{value:"Organization",id:"organization",level:3},{value:"OrganizationIdentifier",id:"organizationidentifier",level:3},{value:"\ud83d\udee0\ufe0f Repository\u5c64\u306e\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3",id:"\ufe0f-repository\u5c64\u306e\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3",level:2},{value:"Tenant\u7b2c\u4e00\u5f15\u6570\u30d1\u30bf\u30fc\u30f3",id:"tenant\u7b2c\u4e00\u5f15\u6570\u30d1\u30bf\u30fc\u30f3",level:3},{value:"Query Repository",id:"query-repository",level:4},{value:"Command Repository",id:"command-repository",level:4},{value:"\u4f8b\u5916: OrganizationRepository",id:"\u4f8b\u5916-organizationrepository",level:3},{value:"\ud83d\udd10 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30ec\u30d9\u30eb\u306e\u30c6\u30ca\u30f3\u30c8\u5206\u96e2",id:"-\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30ec\u30d9\u30eb\u306e\u30c6\u30ca\u30f3\u30c8\u5206\u96e2",level:2},{value:"PostgreSQL Row Level Security (RLS)",id:"postgresql-row-level-security-rls",level:3},{value:"DDL\u3067\u306eRLS\u8a2d\u5b9a",id:"ddl\u3067\u306erls\u8a2d\u5b9a",level:4},{value:"\u5168\u30c6\u30fc\u30d6\u30eb\u3078\u306eRLS\u9069\u7528",id:"\u5168\u30c6\u30fc\u30d6\u30eb\u3078\u306erls\u9069\u7528",level:4},{value:"TransactionManager\u306b\u3088\u308b\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u8a2d\u5b9a",id:"transactionmanager\u306b\u3088\u308b\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u8a2d\u5b9a",level:3},{value:"1. <code>is_local = true</code> \u306e\u91cd\u8981\u6027",id:"1-is_local--true-\u306e\u91cd\u8981\u6027",level:4},{value:"2. \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u958b\u59cb\u5f8c\u306b\u8a2d\u5b9a",id:"2-\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u958b\u59cb\u5f8c\u306b\u8a2d\u5b9a",level:4},{value:"3. PreparedStatement\u3067SQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u5bfe\u7b56",id:"3-preparedstatement\u3067sql\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u5bfe\u7b56",level:4},{value:"\ud83d\udd04 \u5b9f\u88c5\u30d5\u30ed\u30fc",id:"-\u5b9f\u88c5\u30d5\u30ed\u30fc",level:2},{value:"\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u30d5\u30ed\u30fc\u306e\u4f8b",id:"\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u30d5\u30ed\u30fc\u306e\u4f8b",level:3},{value:"\u30b3\u30fc\u30c9\u4f8b",id:"\u30b3\u30fc\u30c9\u4f8b",level:3},{value:"\ud83e\uddea \u30c6\u30b9\u30c8\u6642\u306e\u6ce8\u610f\u4e8b\u9805",id:"-\u30c6\u30b9\u30c8\u6642\u306e\u6ce8\u610f\u4e8b\u9805",level:2},{value:"RLS\u52d5\u4f5c\u78ba\u8a8d",id:"rls\u52d5\u4f5c\u78ba\u8a8d",level:3},{value:"RLS\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d\u30af\u30a8\u30ea",id:"rls\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d\u30af\u30a8\u30ea",level:3},{value:"\ud83d\udccb \u5b9f\u88c5\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",id:"-\u5b9f\u88c5\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",level:2},{value:"\ud83d\udea8 \u3088\u304f\u3042\u308b\u9593\u9055\u3044",id:"-\u3088\u304f\u3042\u308b\u9593\u9055\u3044",level:2},{value:"1. Tenant\u306e\u7701\u7565",id:"1-tenant\u306e\u7701\u7565",level:3},{value:"2. TenantIdentifier\u3068Tenant\u306e\u6df7\u540c",id:"2-tenantidentifier\u3068tenant\u306e\u6df7\u540c",level:3},{value:"3. OrganizationRepository\u3067\u306eTenant\u6e21\u3057",id:"3-organizationrepository\u3067\u306etenant\u6e21\u3057",level:3},{value:"4. RLS\u8a2d\u5b9a\u306eis_local=false",id:"4-rls\u8a2d\u5b9a\u306eis_localfalse",level:3},{value:"\ud83d\udd17 \u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"-\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:2}];function c(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,a.R)(),...n.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(e.header,{children:(0,r.jsx)(e.h1,{id:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8",children:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8"})}),"\n",(0,r.jsx)(e.h2,{id:"-\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f4d\u7f6e\u3065\u3051",children:"\ud83d\udccd \u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u4f4d\u7f6e\u3065\u3051"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u5bfe\u8c61\u8aad\u8005"}),": idp-server\u306e\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u5b9f\u88c5\u3092\u7406\u89e3\u3057\u305f\u3044\u958b\u767a\u8005"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u5b66\u3079\u308b\u3053\u3068"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u306e\u5b9f\u88c5\u8a73\u7d30"}),"\n",(0,r.jsx)(e.li,{children:"Tenant/Organization \u30e2\u30c7\u30eb\u306e\u8a2d\u8a08"}),"\n",(0,r.jsx)(e.li,{children:"Repository\u5c64\u3067\u306e\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,r.jsx)(e.li,{children:"PostgreSQL RLS\u306b\u3088\u308b\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30ec\u30d9\u30eb\u306e\u5206\u96e2"}),"\n",(0,r.jsx)(e.li,{children:"\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u7ba1\u7406\u306e\u4ed5\u7d44\u307f"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u524d\u63d0\u77e5\u8b58"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"../../content_03_concepts/01-foundation/concept-01-multi-tenant.md",children:"concept-01: \u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8"}),"\u306e\u7406\u89e3"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"../../content_01_intro/tech-overview.md#%E3%82%A2%E3%83%BC%E3%82%AD%E3%83%86%E3%82%AF%E3%83%81%E3%83%A3",children:"Hexagonal Architecture"}),"\u306e\u57fa\u790e\u77e5\u8b58"]}),"\n",(0,r.jsx)(e.li,{children:"Repository \u30d1\u30bf\u30fc\u30f3\u306e\u7406\u89e3"}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\ufe0f-\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u6982\u8981",children:"\ud83c\udfd7\ufe0f \u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u6982\u8981"}),"\n",(0,r.jsxs)(e.p,{children:["idp-server\u306f\u3001",(0,r.jsx)(e.strong,{children:"1\u3064\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u3067\u8907\u6570\u306e\u30c6\u30ca\u30f3\u30c8\u3092\u5b8c\u5168\u5206\u96e2"}),"\u3059\u308b\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u578bIdP\u3067\u3059\u3002"]}),"\n",(0,r.jsx)(e.h3,{id:"\u8a2d\u8a08\u539f\u5247",children:"\u8a2d\u8a08\u539f\u5247"}),"\n",(0,r.jsx)(e.h4,{id:"1-tenant-first-design",children:"1. Tenant-First Design"}),"\n",(0,r.jsx)(e.p,{children:"\u3059\u3079\u3066\u306e\u30c7\u30fc\u30bf\u30a2\u30af\u30bb\u30b9\u3067\u30c6\u30ca\u30f3\u30c8\u3092\u660e\u793a\u7684\u306b\u6307\u5b9a\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u2705 \u6b63\u3057\u3044: Tenant\u3092\u660e\u793a\u7684\u306b\u6e21\u3059\npublic interface UserCommandRepository {\n  void register(Tenant tenant, User user);\n  void update(Tenant tenant, User user);\n  void delete(Tenant tenant, UserIdentifier userIdentifier);\n}\n\n// \u274c \u8aa4\u308a: Tenant\u306a\u3057\u3067\u30c7\u30fc\u30bf\u30a2\u30af\u30bb\u30b9\uff08\u30c6\u30ca\u30f3\u30c8\u6f0f\u6d29\u30ea\u30b9\u30af\uff09\npublic interface UserCommandRepository {\n  void register(User user);  // \u3069\u306e\u30c6\u30ca\u30f3\u30c8\u306e\u30e6\u30fc\u30b6\u30fc?\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"../../../libs/idp-server-core/src/main/java/org/idp/server/core/openid/identity/repository/UserCommandRepository.java#L23",children:"UserCommandRepository.java:23"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"../../../libs/idp-server-core/src/main/java/org/idp/server/core/openid/authentication/repository/AuthenticationConfigurationQueryRepository.java#L24",children:"AuthenticationConfigurationQueryRepository.java:24"})}),"\n"]}),"\n",(0,r.jsx)(e.h4,{id:"2-\u4e8c\u91cd\u9632\u5fa1defense-in-depth",children:"2. \u4e8c\u91cd\u9632\u5fa1\uff08Defense in Depth\uff09"}),"\n",(0,r.jsx)(e.p,{children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64\u3068\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5c64\u306e\u4e21\u65b9\u3067\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u3092\u5f37\u5236\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Application Layer (\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5c64)   \u2502\n\u2502  - Repository\u7b2c\u4e00\u5f15\u6570\u3067Tenant\u5f37\u5236        \u2502\n\u2502  - TransactionManager\u3067RLS\u8a2d\u5b9a           \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n               \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  Database Layer (\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5c64)         \u2502\n\u2502  - Row Level Security (RLS)\u306b\u3088\u308b\u5f37\u5236\u5206\u96e2\u2502\n\u2502  - FORCE ROW LEVEL SECURITY              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h4,{id:"3-organization-tenant-\u968e\u5c64\u69cb\u9020",children:"3. Organization-Tenant \u968e\u5c64\u69cb\u9020"}),"\n",(0,r.jsx)(e.p,{children:"\u7d44\u7e54\u3068\u30c6\u30ca\u30f3\u30c8\u306e2\u5c64\u69cb\u9020\u3092\u30b5\u30dd\u30fc\u30c8\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"Organization (\u7d44\u7e54)\n\u251c\u2500\u2500 Tenant (ORGANIZER) - \u7d44\u7e54\u7ba1\u7406\u7528\n\u251c\u2500\u2500 Tenant (PUBLIC)    - \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u2460\n\u2514\u2500\u2500 Tenant (PUBLIC)    - \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u2461\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"-\u30b3\u30a2\u30e2\u30c7\u30eb",children:"\ud83d\udce6 \u30b3\u30a2\u30e2\u30c7\u30eb"}),"\n",(0,r.jsx)(e.h3,{id:"tenant",children:"Tenant"}),"\n",(0,r.jsxs)(e.p,{children:["\u30c6\u30ca\u30f3\u30c8\u306f\u3001idp-server\u5185\u3067\u306e",(0,r.jsx)(e.strong,{children:"\u5b8c\u5168\u306b\u72ec\u7acb\u3057\u305f\u8a8d\u8a3c\u30fb\u8a8d\u53ef\u30c9\u30e1\u30a4\u30f3"}),"\u3092\u8868\u3057\u307e\u3059\u3002"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u4e3b\u8981\u30d5\u30a3\u30fc\u30eb\u30c9"}),":"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class Tenant implements Configurable {\n  TenantIdentifier identifier;           // UUID\u5f62\u5f0f\u306e\u30c6\u30ca\u30f3\u30c8ID\n  TenantName name;                        // \u30c6\u30ca\u30f3\u30c8\u540d\n  TenantType type;                        // ADMIN/ORGANIZER/PUBLIC\n  TenantDomain domain;                    // \u30c6\u30ca\u30f3\u30c8\u30c9\u30e1\u30a4\u30f3\uff08\u30c8\u30fc\u30af\u30f3issuer\u306b\u4f7f\u7528\uff09\n  AuthorizationProvider authorizationProvider;\n  TenantAttributes attributes;            // \u30ab\u30b9\u30bf\u30e0\u5c5e\u6027\n  TenantFeatures features;\n  UIConfiguration uiConfiguration;\n  CorsConfiguration corsConfiguration;\n  SessionConfiguration sessionConfiguration;\n  SecurityEventLogConfiguration securityEventLogConfiguration;\n  SecurityEventUserAttributeConfiguration securityEventUserAttributeConfiguration;\n  TenantIdentityPolicy identityPolicyConfig;\n  OrganizationIdentifier mainOrganizationIdentifier;  // \u6240\u5c5e\u7d44\u7e54\n  boolean enabled;\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/multi_tenancy/tenant/Tenant.java#L34",children:"Tenant.java:34"})]}),"\n",(0,r.jsx)(e.h3,{id:"tenantidentifier",children:"TenantIdentifier"}),"\n",(0,r.jsx)(e.p,{children:"\u30c6\u30ca\u30f3\u30c8ID\u3092\u8868\u3059\u5024\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u3059\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class TenantIdentifier implements UuidConvertable {\n  String value;  // UUID\u6587\u5b57\u5217\n\n  public UUID valueAsUuid() {\n    return convertUuid(value);\n  }\n\n  public boolean exists() {\n    return Objects.nonNull(value) && !value.isEmpty();\n  }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/multi_tenancy/tenant/TenantIdentifier.java#L23",children:"TenantIdentifier.java:23"})]}),"\n",(0,r.jsx)(e.h3,{id:"tenanttype",children:"TenantType"}),"\n",(0,r.jsx)(e.p,{children:"\u30c6\u30ca\u30f3\u30c8\u306e\u7a2e\u5225\u3092\u5b9a\u7fa9\u3057\u307e\u3059\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public enum TenantType {\n  ADMIN,      // \u30b7\u30b9\u30c6\u30e0\u7ba1\u7406\u7528\u30c6\u30ca\u30f3\u30c8\uff08\u521d\u671f\u5316\u6642\u306b\u81ea\u52d5\u4f5c\u6210\uff09\n  ORGANIZER,  // \u7d44\u7e54\u7ba1\u7406\u7528\u30c6\u30ca\u30f3\u30c8\uff08\u7d44\u7e54\u4f5c\u6210\u6642\u306b\u81ea\u52d5\u4f5c\u6210\uff09\n  PUBLIC;     // \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30c6\u30ca\u30f3\u30c8\uff08API\u7d4c\u7531\u3067\u4f5c\u6210\uff09\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/multi_tenancy/tenant/TenantType.java#L19",children:"TenantType.java:19"})]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u4f7f\u3044\u5206\u3051"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"ADMIN"}),": \u30b7\u30b9\u30c6\u30e0\u5168\u4f53\u306e\u521d\u671f\u8a2d\u5b9a\u30fb\u7ba1\u7406\u7528\uff081\u3064\u306e\u307f\uff09"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"ORGANIZER"}),": \u7d44\u7e54\u5185\u306e\u30c6\u30ca\u30f3\u30c8\u7ba1\u7406\u30fb\u7d44\u7e54\u30e1\u30f3\u30d0\u30fc\u7ba1\u7406\u7528\uff08\u7d44\u7e54\u3054\u3068\u306b1\u3064\uff09"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:"PUBLIC"}),": \u5b9f\u969b\u306e\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8a8d\u8a3c\u7528\uff08\u7d44\u7e54\u3054\u3068\u306b\u8907\u6570\u4f5c\u6210\u53ef\u80fd\uff09"]}),"\n"]}),"\n",(0,r.jsx)(e.h3,{id:"organization",children:"Organization"}),"\n",(0,r.jsx)(e.p,{children:"\u7d44\u7e54\u306f\u3001\u8907\u6570\u306e\u30c6\u30ca\u30f3\u30c8\u3092\u30b0\u30eb\u30fc\u30d7\u5316\u3059\u308b\u4e0a\u4f4d\u6982\u5ff5\u3067\u3059\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class Organization implements Configurable {\n  OrganizationIdentifier identifier;    // UUID\u5f62\u5f0f\u306e\u7d44\u7e54ID\n  OrganizationName name;                 // \u7d44\u7e54\u540d\n  OrganizationDescription description;   // \u7d44\u7e54\u8aac\u660e\n  AssignedTenants assignedTenants;       // \u6240\u5c5e\u30c6\u30ca\u30f3\u30c8\u4e00\u89a7\n  boolean enabled;\n\n  public AssignedTenant findOrgTenant() {\n    // type="ORGANIZER"\u306e\u30c6\u30ca\u30f3\u30c8\u3092\u53d6\u5f97\n    for (AssignedTenant tenant : assignedTenants()) {\n      if ("ORGANIZER".equals(tenant.type())) {\n        return tenant;\n      }\n    }\n    throw new AdminTenantNotFoundException(...);\n  }\n\n  public boolean hasAssignedTenant(TenantIdentifier tenantIdentifier) {\n    return assignedTenants.contains(tenantIdentifier);\n  }\n}\n'})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/multi_tenancy/organization/Organization.java#L23",children:"Organization.java:23"})]}),"\n",(0,r.jsx)(e.h3,{id:"organizationidentifier",children:"OrganizationIdentifier"}),"\n",(0,r.jsx)(e.p,{children:"\u7d44\u7e54ID\u3092\u8868\u3059\u5024\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3067\u3059\u3002"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public class OrganizationIdentifier implements UuidConvertable {\n  String value;  // UUID\u6587\u5b57\u5217\n\n  public UUID valueAsUuid() {\n    return convertUuid(value);\n  }\n\n  public boolean exists() {\n    return value != null && !value.isEmpty();\n  }\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/multi_tenancy/organization/OrganizationIdentifier.java#L24",children:"OrganizationIdentifier.java:24"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"\ufe0f-repository\u5c64\u306e\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3",children:"\ud83d\udee0\ufe0f Repository\u5c64\u306e\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,r.jsx)(e.h3,{id:"tenant\u7b2c\u4e00\u5f15\u6570\u30d1\u30bf\u30fc\u30f3",children:"Tenant\u7b2c\u4e00\u5f15\u6570\u30d1\u30bf\u30fc\u30f3"}),"\n",(0,r.jsxs)(e.p,{children:["\u3059\u3079\u3066\u306eRepository\u64cd\u4f5c\u3067\u3001",(0,r.jsxs)(e.strong,{children:["\u7b2c\u4e00\u5f15\u6570\u306b",(0,r.jsx)(e.code,{children:"Tenant"}),"\u3092\u6e21\u3059"]}),"\u3053\u3068\u3067\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u3092\u8a2d\u8a08\u30ec\u30d9\u30eb\u3067\u5f37\u5236\u3057\u307e\u3059\u3002"]}),"\n",(0,r.jsx)(e.h4,{id:"query-repository",children:"Query Repository"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public interface AuthenticationConfigurationQueryRepository {\n  // \u2705 \u3059\u3079\u3066\u306e\u30e1\u30bd\u30c3\u30c9\u3067\u7b2c\u4e00\u5f15\u6570\u304cTenant\n  AuthenticationConfiguration get(Tenant tenant, String key);\n  AuthenticationConfiguration find(Tenant tenant, String key);\n  AuthenticationConfiguration find(Tenant tenant, AuthenticationConfigurationIdentifier identifier);\n  AuthenticationConfiguration findWithDisabled(Tenant tenant, AuthenticationConfigurationIdentifier identifier, boolean includeDisabled);\n  long findTotalCount(Tenant tenant);\n  List<AuthenticationConfiguration> findList(Tenant tenant, int limit, int offset);\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-core/src/main/java/org/idp/server/core/openid/authentication/repository/AuthenticationConfigurationQueryRepository.java#L24",children:"AuthenticationConfigurationQueryRepository.java:24"})]}),"\n",(0,r.jsx)(e.h4,{id:"command-repository",children:"Command Repository"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public interface UserCommandRepository {\n  // \u2705 \u3059\u3079\u3066\u306e\u30e1\u30bd\u30c3\u30c9\u3067\u7b2c\u4e00\u5f15\u6570\u304cTenant\n  void register(Tenant tenant, User user);\n  void update(Tenant tenant, User user);\n  void updatePassword(Tenant tenant, User user);\n  void delete(Tenant tenant, UserIdentifier userIdentifier);\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-core/src/main/java/org/idp/server/core/openid/identity/repository/UserCommandRepository.java#L23",children:"UserCommandRepository.java:23"})]}),"\n",(0,r.jsx)(e.h3,{id:"\u4f8b\u5916-organizationrepository",children:"\u4f8b\u5916: OrganizationRepository"}),"\n",(0,r.jsxs)(e.p,{children:["\u7d44\u7e54\u306f\u30c6\u30ca\u30f3\u30c8\u3088\u308a\u4e0a\u4f4d\u6982\u5ff5\u306e\u305f\u3081\u3001",(0,r.jsx)(e.code,{children:"Tenant"}),"\u3092\u7b2c\u4e00\u5f15\u6570\u306b\u53d6\u308a\u307e\u305b\u3093\u3002"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"public interface OrganizationRepository {\n  // \u2705 \u7d44\u7e54\u64cd\u4f5c\u3067\u306f\u3001OrganizationIdentifier\u306e\u307f\u3092\u4f7f\u7528\n  void register(Organization organization);\n  void update(Organization organization);\n  void delete(OrganizationIdentifier identifier);\n  Organization get(OrganizationIdentifier identifier);\n  List<Organization> findList(OrganizationQueries queries);\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/multi_tenancy/organization/OrganizationRepository.java#L21",children:"OrganizationRepository.java:21"})]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"-\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30ec\u30d9\u30eb\u306e\u30c6\u30ca\u30f3\u30c8\u5206\u96e2",children:"\ud83d\udd10 \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30ec\u30d9\u30eb\u306e\u30c6\u30ca\u30f3\u30c8\u5206\u96e2"}),"\n",(0,r.jsx)(e.h3,{id:"postgresql-row-level-security-rls",children:"PostgreSQL Row Level Security (RLS)"}),"\n",(0,r.jsxs)(e.p,{children:["PostgreSQL\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u3001",(0,r.jsx)(e.strong,{children:"Row Level Security (RLS)"})," \u306b\u3088\u308a\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30ec\u30d9\u30eb\u3067\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u3092\u5f37\u5236\u3057\u307e\u3059\u3002"]}),"\n",(0,r.jsx)(e.h4,{id:"ddl\u3067\u306erls\u8a2d\u5b9a",children:"DDL\u3067\u306eRLS\u8a2d\u5b9a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u30c6\u30ca\u30f3\u30c8\u30c6\u30fc\u30d6\u30eb\u306bRLS\u6709\u52b9\u5316\nALTER TABLE tenant ENABLE ROW LEVEL SECURITY;\n\n-- \u30dd\u30ea\u30b7\u30fc\u4f5c\u6210: app.tenant_id\u3068\u4e00\u81f4\u3059\u308b\u884c\u306e\u307f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\nCREATE POLICY tenant_isolation_policy\n  ON tenant\n  USING (id = current_setting('app.tenant_id')::uuid);\n\n-- \u5f37\u5236RLS: DB\u7ba1\u7406\u8005\u3082\u5236\u9650\nALTER TABLE tenant FORCE ROW LEVEL SECURITY;\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-database/postgresql/V0_9_0__init_lib.sql",children:"V0_9_0__init_lib.sql"})," (RLS\u8a2d\u5b9a\u7b87\u6240)"]}),"\n",(0,r.jsx)(e.h4,{id:"\u5168\u30c6\u30fc\u30d6\u30eb\u3078\u306erls\u9069\u7528",children:"\u5168\u30c6\u30fc\u30d6\u30eb\u3078\u306eRLS\u9069\u7528"}),"\n",(0,r.jsx)(e.p,{children:"idp-server\u3067\u306f\u3001\u4ee5\u4e0b\u306e\u30c6\u30fc\u30d6\u30eb\u306bRLS \u304c\u9069\u7528\u3055\u308c\u3066\u3044\u307e\u3059:"}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"tenant"})," - \u30c6\u30ca\u30f3\u30c8\u60c5\u5831"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"organization_tenants"})," - \u7d44\u7e54-\u30c6\u30ca\u30f3\u30c8\u95a2\u4fc2"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"authorization_server_configuration"})," - \u8a8d\u53ef\u30b5\u30fc\u30d0\u30fc\u8a2d\u5b9a"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"permission"})," - \u6a29\u9650"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"role"})," - \u30ed\u30fc\u30eb"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"idp_user"})," - \u30e6\u30fc\u30b6\u30fc"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"client_configuration"})," - \u30af\u30e9\u30a4\u30a2\u30f3\u30c8\u8a2d\u5b9a"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.code,{children:"authentication_configuration"})," - \u8a8d\u8a3c\u8a2d\u5b9a"]}),"\n",(0,r.jsx)(e.li,{children:"\u305d\u306e\u4ed6\u3059\u3079\u3066\u306e\u30c6\u30ca\u30f3\u30c8\u4f9d\u5b58\u30c6\u30fc\u30d6\u30eb"}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u78ba\u8a8d\u65b9\u6cd5"}),":"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- RLS\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u30c6\u30fc\u30d6\u30eb\u3068\u30dd\u30ea\u30b7\u30fc\u3092\u78ba\u8a8d\nSELECT schemaname, tablename, policyname, qual as policy_condition\nFROM pg_policies\nWHERE schemaname = 'public'\nORDER BY tablename, policyname;\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-database/postgresql/operation/select-rls-policy.sql",children:"select-rls-policy.sql"})]}),"\n",(0,r.jsx)(e.h3,{id:"transactionmanager\u306b\u3088\u308b\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u8a2d\u5b9a",children:"TransactionManager\u306b\u3088\u308b\u30c6\u30ca\u30f3\u30c8\u30b3\u30f3\u30c6\u30ad\u30b9\u30c8\u8a2d\u5b9a"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.code,{children:"TransactionManager"}),"\u306f\u3001\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u958b\u59cb\u6642\u306bPostgreSQL\u30bb\u30c3\u30b7\u30e7\u30f3\u5909\u6570",(0,r.jsx)(e.code,{children:"app.tenant_id"}),"\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'public class TransactionManager {\n\n  public static void beginTransaction(DatabaseType databaseType, TenantIdentifier tenantIdentifier) {\n    if (connectionHolder.get() != null) {\n      throw new SqlRuntimeException("Transaction already started");\n    }\n    OperationContext.set(OperationType.WRITE);\n    Connection conn = dbConnectionProvider.getConnection(\n        databaseType, AdminTenantContext.isAdmin(tenantIdentifier));\n\n    // PostgreSQL\u306e\u5834\u5408\u3001RLS\u7528\u306b\u30c6\u30ca\u30f3\u30c8ID\u3092\u8a2d\u5b9a\n    if (databaseType == DatabaseType.POSTGRESQL) {\n      setTenantId(conn, tenantIdentifier);\n    }\n    connectionHolder.set(conn);\n  }\n\n  /**\n   * Sets the current tenant identifier for Row-Level Security (RLS).\n   *\n   * PostgreSQL\u306eset_config()\u95a2\u6570\u3067app.tenant_id\u3092\u8a2d\u5b9a\u3057\u307e\u3059\u3002\n   * is_local=true\u306b\u3088\u308a\u3001\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u7d42\u4e86\u6642\u306b\u81ea\u52d5\u30af\u30ea\u30a2\u3055\u308c\u307e\u3059\u3002\n   */\n  private static void setTenantId(Connection conn, TenantIdentifier tenantIdentifier) {\n    log.trace("[RLS] SET app.tenant_id: tenant={}", tenantIdentifier.value());\n\n    // PreparedStatement\u3067SQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u5bfe\u7b56\n    try (var stmt = conn.prepareStatement("SELECT set_config(\'app.tenant_id\', ?, true)")) {\n      stmt.setString(1, tenantIdentifier.value());\n      stmt.execute();\n    } catch (SQLException e) {\n      throw new SqlRuntimeException("Failed to set tenant_id", e);\n    }\n  }\n}\n'})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5"}),": ",(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/datasource/TransactionManager.java#L25",children:"TransactionManager.java:25"})]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u91cd\u8981\u306a\u30dd\u30a4\u30f3\u30c8"}),":"]}),"\n",(0,r.jsxs)(e.h4,{id:"1-is_local--true-\u306e\u91cd\u8981\u6027",children:["1. ",(0,r.jsx)(e.code,{children:"is_local = true"})," \u306e\u91cd\u8981\u6027"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"SELECT set_config('app.tenant_id', 'xxx', true)\n                                          \u2191\n                                    is_local=true\n"})}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"true"})}),": \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u7d42\u4e86\u6642\u306b\u81ea\u52d5\u30af\u30ea\u30a2\uff08\u63a8\u5968\uff09"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.strong,{children:(0,r.jsx)(e.code,{children:"false"})}),": \u30bb\u30c3\u30b7\u30e7\u30f3\u5168\u4f53\u3067\u4fdd\u6301\uff08\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u4f7f\u7528\u6642\u306b\u5371\u967a\uff09"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsxs)(e.strong,{children:["\u5371\u967a\u306a\u30b7\u30ca\u30ea\u30aa\uff08",(0,r.jsx)(e.code,{children:"false"}),"\u306e\u5834\u5408\uff09"]}),":"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:'1. Tenant A \u306e\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u958b\u59cb \u2192 app.tenant_id = "A"\n2. \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u7d42\u4e86 \u2192 app.tenant_id = "A" \u306e\u307e\u307e\u6b8b\u308b\n3. \u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u304c\u30d7\u30fc\u30eb\u306b\u623b\u308b\n4. Tenant B \u304c\u305d\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3092\u53d6\u5f97\n5. app.tenant_id = "A" \u306e\u307e\u307e\uff08Tenant B \u306e\u30c7\u30fc\u30bf\u30a2\u30af\u30bb\u30b9\u304cTenant A \u3068\u3057\u3066\u5b9f\u884c\u3055\u308c\u308b\uff01\uff09\n'})}),"\n",(0,r.jsx)(e.h4,{id:"2-\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u958b\u59cb\u5f8c\u306b\u8a2d\u5b9a",children:"2. \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u958b\u59cb\u5f8c\u306b\u8a2d\u5b9a"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u274c \u8aa4\u308a: \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u958b\u59cb\u524d\u306b\u8a2d\u5b9a\nsetTenantId(conn, tenantIdentifier);\nconn.setAutoCommit(false);  // \u3053\u306e\u5f8c\u3060\u3068set_config\u304c\u7121\u52b9\u5316\u3055\u308c\u308b\n\n// \u2705 \u6b63\u3057\u3044: \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u958b\u59cb\u5f8c\u306b\u8a2d\u5b9a\nconn.setAutoCommit(false);\nsetTenantId(conn, tenantIdentifier);\n"})}),"\n",(0,r.jsx)(e.h4,{id:"3-preparedstatement\u3067sql\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u5bfe\u7b56",children:"3. PreparedStatement\u3067SQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u5bfe\u7b56"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u274c \u8aa4\u308a: \u6587\u5b57\u5217\u7d50\u5408\uff08SQL\u30a4\u30f3\u30b8\u30a7\u30af\u30b7\u30e7\u30f3\u30ea\u30b9\u30af\uff09\nstmt.execute(\"SELECT set_config('app.tenant_id', '\" + tenantId + \"', true)\");\n\n// \u2705 \u6b63\u3057\u3044: PreparedStatement\u4f7f\u7528\ntry (var stmt = conn.prepareStatement(\"SELECT set_config('app.tenant_id', ?, true)\")) {\n  stmt.setString(1, tenantIdentifier.value());\n  stmt.execute();\n}\n"})}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/functions-admin.html#FUNCTIONS-ADMIN-SET",children:"Configuration Settings Functions"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/ddl-rowsecurity.html",children:"Row Security Policies"})}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"-\u5b9f\u88c5\u30d5\u30ed\u30fc",children:"\ud83d\udd04 \u5b9f\u88c5\u30d5\u30ed\u30fc"}),"\n",(0,r.jsx)(e.h3,{id:"\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u30d5\u30ed\u30fc\u306e\u4f8b",children:"\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u30d5\u30ed\u30fc\u306e\u4f8b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 1. Controller Layer                                         \u2502\n\u2502    - HTTP Request\u53d7\u4fe1                                        \u2502\n\u2502    - TenantIdentifier\u3092\u62bd\u51fa\uff08URL\u30d1\u30b9\u307e\u305f\u306f\u30d8\u30c3\u30c0\u30fc\uff09         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 2. UseCase Layer (EntryService)                             \u2502\n\u2502    - TenantQueryRepository.get(tenantIdentifier)            \u2502\n\u2502    - Tenant\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u53d6\u5f97                                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 3. Core Layer (Handler/Service)                             \u2502\n\u2502    - \u30d3\u30b8\u30cd\u30b9\u30ed\u30b8\u30c3\u30af\u5b9f\u884c                                    \u2502\n\u2502    - Tenant\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092\u5404Repository\u306b\u6e21\u3059                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 4. Repository Layer                                          \u2502\n\u2502    - TransactionManager.beginTransaction(db, tenant)         \u2502\n\u2502    - PostgreSQL\u306e\u5834\u5408: app.tenant_id\u8a2d\u5b9a                     \u2502\n\u2502    - userRepository.register(tenant, user)                   \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                         \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 5. Database Layer                                            \u2502\n\u2502    - RLS\u30dd\u30ea\u30b7\u30fc\u9069\u7528                                         \u2502\n\u2502    - \u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u3055\u308c\u305f\u884c\u306e\u307f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,r.jsx)(e.h3,{id:"\u30b3\u30fc\u30c9\u4f8b",children:"\u30b3\u30fc\u30c9\u4f8b"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'// 1. Controller Layer\n@PostMapping("/v1/management/organizations/{orgId}/tenants/{tenantId}/users")\npublic ResponseEntity<?> registerUser(\n    @PathVariable String orgId,\n    @PathVariable String tenantId,\n    @RequestBody UserRequest request) {\n  TenantIdentifier tenantIdentifier = new TenantIdentifier(tenantId);\n  // EntryService\u306b\u59d4\u8b72\n  return userManagementEntryService.register(tenantIdentifier, request);\n}\n\n// 2. UseCase Layer\npublic class UserManagementEntryService {\n  public Response register(TenantIdentifier tenantIdentifier, UserRequest request) {\n    // Tenant\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u53d6\u5f97\n    Tenant tenant = tenantQueryRepository.get(tenantIdentifier);\n\n    // Handler\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u6e21\u3059\n    UserManagementResult result = userManagementHandler.register(tenant, request);\n    return result.toResponse();\n  }\n}\n\n// 3. Core Layer (Handler)\npublic class UserManagementHandler {\n  public UserManagementResult register(Tenant tenant, UserRequest request) {\n    // Service\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u6e21\u3059\n    userRegistrationService.execute(tenant, request);\n\n    // Repository\u306b\u30c6\u30ca\u30f3\u30c8\u3092\u6e21\u3059\n    userCommandRepository.register(tenant, user);\n    return UserManagementResult.success();\n  }\n}\n\n// 4. Repository Layer (Adapter)\npublic class UserCommandDataSource implements UserCommandRepository {\n  @Override\n  public void register(Tenant tenant, User user) {\n    // \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u958b\u59cb\uff08PostgreSQL\u306e\u5834\u5408app.tenant_id\u8a2d\u5b9a\uff09\n    TransactionManager.beginTransaction(databaseType, tenant.identifier());\n\n    // SQL\u5b9f\u884c\uff08RLS\u304c\u81ea\u52d5\u9069\u7528\u3055\u308c\u308b\uff09\n    String sql = "INSERT INTO idp_user (id, tenant_id, username, ...) VALUES (?, ?, ?, ...)";\n    sqlExecutor.insert(sql, ...);\n\n    TransactionManager.commitTransaction();\n  }\n}\n'})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"-\u30c6\u30b9\u30c8\u6642\u306e\u6ce8\u610f\u4e8b\u9805",children:"\ud83e\uddea \u30c6\u30b9\u30c8\u6642\u306e\u6ce8\u610f\u4e8b\u9805"}),"\n",(0,r.jsx)(e.h3,{id:"rls\u52d5\u4f5c\u78ba\u8a8d",children:"RLS\u52d5\u4f5c\u78ba\u8a8d"}),"\n",(0,r.jsx)(e.p,{children:"PostgreSQL\u306eRLS\u304c\u6b63\u3057\u304f\u52d5\u4f5c\u3057\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3059\u308b\u65b9\u6cd5:"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:'@Test\nvoid testTenantIsolation() {\n  // Tenant A \u3067\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\n  TenantIdentifier tenantA = new TenantIdentifier("tenant-a-uuid");\n  Tenant tenantAObj = tenantRepository.get(tenantA);\n  User userA = new User(...);\n  userRepository.register(tenantAObj, userA);\n\n  // Tenant B \u3067\u30e6\u30fc\u30b6\u30fc\u691c\u7d22\n  TenantIdentifier tenantB = new TenantIdentifier("tenant-b-uuid");\n  Tenant tenantBObj = tenantRepository.get(tenantB);\n\n  // \u2705 Tenant B\u304b\u3089\u306f\u30e6\u30fc\u30b6\u30fc\u304c\u898b\u3048\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d\n  assertThrows(UserNotFoundException.class, () -> {\n    userRepository.get(tenantBObj, userA.identifier());\n  });\n}\n'})}),"\n",(0,r.jsx)(e.h3,{id:"rls\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d\u30af\u30a8\u30ea",children:"RLS\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d\u30af\u30a8\u30ea"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"-- \u958b\u767a\u74b0\u5883\u3067RLS\u304c\u6b63\u3057\u304f\u8a2d\u5b9a\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\nSELECT\n    schemaname,\n    tablename,\n    policyname,\n    qual as policy_condition\nFROM pg_policies\nWHERE schemaname = 'public'\n  AND policyname = 'tenant_isolation_policy'\nORDER BY tablename;\n\n-- \u51fa\u529b\u4f8b:\n-- schemaname | tablename       | policyname              | policy_condition\n-- -----------|-----------------|-------------------------|----------------------------------\n-- public     | tenant          | tenant_isolation_policy | (id = current_setting('app.tenant_id')::uuid)\n-- public     | idp_user        | tenant_isolation_policy | (tenant_id = current_setting('app.tenant_id')::uuid)\n-- public     | client_configuration | tenant_isolation_policy | (tenant_id = current_setting('app.tenant_id')::uuid)\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"-\u5b9f\u88c5\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",children:"\ud83d\udccb \u5b9f\u88c5\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8"}),"\n",(0,r.jsx)(e.p,{children:"\u65b0\u3057\u3044\u30c9\u30e1\u30a4\u30f3\u30e2\u30c7\u30eb\u3092\u8ffd\u52a0\u3059\u308b\u969b\u306e\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8:"}),"\n",(0,r.jsxs)(e.ul,{className:"contains-task-list",children:["\n",(0,r.jsxs)(e.li,{className:"task-list-item",children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.input,{type:"checkbox",disabled:!0})," ",(0,r.jsx)(e.strong,{children:"Repository Interface"}),": \u3059\u3079\u3066\u306e\u30e1\u30bd\u30c3\u30c9\u3067\u7b2c\u4e00\u5f15\u6570\u306b",(0,r.jsx)(e.code,{children:"Tenant"}),"\u3092\u8ffd\u52a0"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u2705\nvoid register(Tenant tenant, Entity entity);\nEntity find(Tenant tenant, EntityIdentifier id);\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{className:"task-list-item",children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.input,{type:"checkbox",disabled:!0})," ",(0,r.jsx)(e.strong,{children:"DDL"}),": \u30c6\u30fc\u30d6\u30eb\u306b",(0,r.jsx)(e.code,{children:"tenant_id"}),"\u30ab\u30e9\u30e0\u3092\u8ffd\u52a0"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"CREATE TABLE new_entity (\n  id UUID PRIMARY KEY,\n  tenant_id UUID NOT NULL,  -- \u2190 \u5fc5\u9808\n  ...\n);\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{className:"task-list-item",children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.input,{type:"checkbox",disabled:!0})," ",(0,r.jsx)(e.strong,{children:"RLS Policy"}),": \u30c6\u30fc\u30d6\u30eb\u306bRLS\u30dd\u30ea\u30b7\u30fc\u3092\u8a2d\u5b9a"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"ALTER TABLE new_entity ENABLE ROW LEVEL SECURITY;\nCREATE POLICY tenant_isolation_policy ON new_entity\n  USING (tenant_id = current_setting('app.tenant_id')::uuid);\nALTER TABLE new_entity FORCE ROW LEVEL SECURITY;\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{className:"task-list-item",children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.input,{type:"checkbox",disabled:!0})," ",(0,r.jsx)(e.strong,{children:"Foreign Key"}),": ",(0,r.jsx)(e.code,{children:"tenant_id"}),"\u306b\u5916\u90e8\u30ad\u30fc\u5236\u7d04\u3092\u8ffd\u52a0\uff08\u30aa\u30d7\u30b7\u30e7\u30f3\uff09"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"ALTER TABLE new_entity\n  ADD CONSTRAINT fk_new_entity_tenant\n  FOREIGN KEY (tenant_id) REFERENCES tenant(id);\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{className:"task-list-item",children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.input,{type:"checkbox",disabled:!0})," ",(0,r.jsx)(e.strong,{children:"Index"}),": ",(0,r.jsx)(e.code,{children:"tenant_id"}),"\u306b\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u8ffd\u52a0\uff08\u30d1\u30d5\u30a9\u30fc\u30de\u30f3\u30b9\u5411\u4e0a\uff09"]}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-sql",children:"CREATE INDEX idx_new_entity_tenant_id ON new_entity(tenant_id);\n"})}),"\n"]}),"\n",(0,r.jsxs)(e.li,{className:"task-list-item",children:["\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.input,{type:"checkbox",disabled:!0})," ",(0,r.jsx)(e.strong,{children:"Test"}),": \u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u306e\u30c6\u30b9\u30c8\u30b1\u30fc\u30b9\u3092\u8ffd\u52a0"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:"\u7570\u306a\u308b\u30c6\u30ca\u30f3\u30c8\u304b\u3089\u306e\u30a2\u30af\u30bb\u30b9\u3067404\u304c\u8fd4\u308b\u3053\u3068\u3092\u78ba\u8a8d"}),"\n",(0,r.jsx)(e.li,{children:"RLS\u30dd\u30ea\u30b7\u30fc\u304c\u6b63\u3057\u304f\u6a5f\u80fd\u3059\u308b\u3053\u3068\u3092\u78ba\u8a8d"}),"\n"]}),"\n"]}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"-\u3088\u304f\u3042\u308b\u9593\u9055\u3044",children:"\ud83d\udea8 \u3088\u304f\u3042\u308b\u9593\u9055\u3044"}),"\n",(0,r.jsx)(e.h3,{id:"1-tenant\u306e\u7701\u7565",children:"1. Tenant\u306e\u7701\u7565"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u274c \u8aa4\u308a: Repository\u547c\u3073\u51fa\u3057\u3067Tenant\u3092\u6e21\u3055\u306a\u3044\nUser user = userRepository.find(userId);\n\n// \u2705 \u6b63\u3057\u3044: \u5e38\u306bTenant\u3092\u6e21\u3059\nTenant tenant = tenantRepository.get(tenantIdentifier);\nUser user = userRepository.find(tenant, userId);\n"})}),"\n",(0,r.jsx)(e.h3,{id:"2-tenantidentifier\u3068tenant\u306e\u6df7\u540c",children:"2. TenantIdentifier\u3068Tenant\u306e\u6df7\u540c"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u274c \u8aa4\u308a: TenantIdentifier\u3092\u305d\u306e\u307e\u307e\u4f7f\u3046\nuserRepository.register(tenantIdentifier, user);  // \u30b3\u30f3\u30d1\u30a4\u30eb\u30a8\u30e9\u30fc\n\n// \u2705 \u6b63\u3057\u3044: Tenant\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u3092Repository\u304b\u3089\u53d6\u5f97\nTenant tenant = tenantRepository.get(tenantIdentifier);\nuserRepository.register(tenant, user);\n"})}),"\n",(0,r.jsx)(e.h3,{id:"3-organizationrepository\u3067\u306etenant\u6e21\u3057",children:"3. OrganizationRepository\u3067\u306eTenant\u6e21\u3057"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u274c \u8aa4\u308a: OrganizationRepository\u306bTenant\u3092\u6e21\u3059\norganizationRepository.get(tenant, orgIdentifier);  // \u30b3\u30f3\u30d1\u30a4\u30eb\u30a8\u30e9\u30fc\n\n// \u2705 \u6b63\u3057\u3044: OrganizationRepository\u306fTenant\u4e0d\u8981\nOrganization org = organizationRepository.get(orgIdentifier);\n"})}),"\n",(0,r.jsx)(e.h3,{id:"4-rls\u8a2d\u5b9a\u306eis_localfalse",children:"4. RLS\u8a2d\u5b9a\u306eis_local=false"}),"\n",(0,r.jsx)(e.pre,{children:(0,r.jsx)(e.code,{className:"language-java",children:"// \u274c \u8aa4\u308a: \u30bb\u30c3\u30b7\u30e7\u30f3\u5168\u4f53\u3067\u4fdd\u6301\uff08\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u4f7f\u7528\u6642\u306b\u5371\u967a\uff09\nstmt.execute(\"SELECT set_config('app.tenant_id', '\" + tenantId + \"', false)\");\n\n// \u2705 \u6b63\u3057\u3044: \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u30ed\u30fc\u30ab\u30eb\nstmt.execute(\"SELECT set_config('app.tenant_id', ?, true)\");\n"})}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsx)(e.h2,{id:"-\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"\ud83d\udd17 \u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u6982\u5ff5\u30fb\u57fa\u790e"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"../../content_03_concepts/01-foundation/concept-01-multi-tenant.md",children:"concept-01: \u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8"})," - \u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u306e\u8a2d\u8a08\u601d\u60f3"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"../../content_05_how-to/how-to-02-organization-initialization.md",children:"how-to-02: \u7d44\u7e54\u521d\u671f\u5316"})," - \u7d44\u7e54\u4f5c\u6210\u624b\u9806"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"../../content_05_how-to/how-to-03-tenant-setup.md",children:"how-to-03: \u30c6\u30ca\u30f3\u30c8\u30bb\u30c3\u30c8\u30a2\u30c3\u30d7"})," - \u30c6\u30ca\u30f3\u30c8\u4f5c\u6210\u624b\u9806"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u5b9f\u88c5\u8a73\u7d30"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"./impl-03-transaction.md",children:"impl-03: \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3"})," - TransactionManager\u306e\u8a73\u7d30"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"./impl-02-multi-datasource.md",children:"impl-02: \u30de\u30eb\u30c1\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9"})," - \u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u7ba1\u7406"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"./impl-10-repository-implementation.md",children:"impl-10: Repository\u5b9f\u88c5"})," - Repository\u5c64\u306e\u5b9f\u88c5\u30d1\u30bf\u30fc\u30f3"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u8a2d\u5b9a"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"../05-configuration/tenant.md",children:"05-configuration/tenant.md"})," - Tenant\u8a2d\u5b9a\u30ac\u30a4\u30c9"]}),"\n",(0,r.jsxs)(e.li,{children:[(0,r.jsx)(e.a,{href:"../02-control-plane/04-organization-level-api.md",children:"02-control-plane/04-organization-level-api.md"})," - \u7d44\u7e54\u30ec\u30d9\u30ebAPI"]}),"\n"]}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u53c2\u8003\u5b9f\u88c5\u30af\u30e9\u30b9"}),":"]}),"\n",(0,r.jsxs)(e.ul,{children:["\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/multi_tenancy/tenant/Tenant.java",children:"Tenant.java"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/multi_tenancy/organization/Organization.java",children:"Organization.java"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"../../../libs/idp-server-platform/src/main/java/org/idp/server/platform/datasource/TransactionManager.java",children:"TransactionManager.java"})}),"\n",(0,r.jsx)(e.li,{children:(0,r.jsx)(e.a,{href:"../../../libs/idp-server-core/src/main/java/org/idp/server/core/openid/identity/repository/UserCommandRepository.java",children:"UserCommandRepository.java"})}),"\n"]}),"\n",(0,r.jsx)(e.hr,{}),"\n",(0,r.jsxs)(e.p,{children:[(0,r.jsx)(e.strong,{children:"\u6700\u7d42\u66f4\u65b0"}),": 2025-12-07\n",(0,r.jsx)(e.strong,{children:"\u96e3\u6613\u5ea6"}),": \u2b50\u2b50\u2b50 (\u4e2d\u7d1a)"]})]})}function p(n={}){const{wrapper:e}={...(0,a.R)(),...n.components};return e?(0,r.jsx)(e,{...n,children:(0,r.jsx)(c,{...n})}):c(n)}},28453:(n,e,i)=>{i.d(e,{R:()=>s,x:()=>l});var t=i(96540);const r={},a=t.createContext(r);function s(n){const e=t.useContext(a);return t.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function l(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(r):n.components||r:s(n.components),t.createElement(a.Provider,{value:e},n.children)}}}]);