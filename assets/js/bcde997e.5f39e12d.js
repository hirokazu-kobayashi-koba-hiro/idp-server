"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[4797],{66792:(e,n,s)=>{s.r(n),s.d(n,{assets:()=>c,contentTitle:()=>d,default:()=>o,frontMatter:()=>a,metadata:()=>r,toc:()=>t});const r=JSON.parse('{"id":"content_08_ops/commercial-deployment/database","title":"PostgreSQL \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a","description":"idp-server \u306e\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u74b0\u5883\u3067\u5fc5\u8981\u306aPostgreSQL\u8a2d\u5b9a\u306e\u624b\u9806\u3068\u52d5\u4f5c\u78ba\u8a8d\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002","source":"@site/docs/content_08_ops/commercial-deployment/03-database.md","sourceDirName":"content_08_ops/commercial-deployment","slug":"/content_08_ops/commercial-deployment/database","permalink":"/idp-server/docs/content_08_ops/commercial-deployment/database","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_08_ops/commercial-deployment/03-database.md","tags":[],"version":"current","sidebarPosition":3,"frontMatter":{},"sidebar":"docs","previous":{"title":"\u74b0\u5883\u5909\u6570\u30fb\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30d1\u30e9\u30e1\u30fc\u30bf\u8a2d\u5b9a","permalink":"/idp-server/docs/content_08_ops/commercial-deployment/environment-variables"},"next":{"title":"\u521d\u671f\u8a2d\u5b9a - \u7ba1\u7406\u30c6\u30ca\u30f3\u30c8\u30fb\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210","permalink":"/idp-server/docs/content_08_ops/commercial-deployment/initial-configuration"}}');var l=s(74848),i=s(28453);const a={},d="PostgreSQL \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a",c={},t=[{value:"1. \u69cb\u7bc9\u624b\u9806\u6982\u8981",id:"1-\u69cb\u7bc9\u624b\u9806\u6982\u8981",level:2},{value:"2. \u8a2d\u5b9a\u624b\u9806",id:"2-\u8a2d\u5b9a\u624b\u9806",level:2},{value:"2.1 PostgreSQL\u8a2d\u5b9a",id:"21-postgresql\u8a2d\u5b9a",level:3},{value:"postgresql.conf \u306e\u8a2d\u5b9a",id:"postgresqlconf-\u306e\u8a2d\u5b9a",level:4},{value:"\u8a2d\u5b9a\u78ba\u8a8d",id:"\u8a2d\u5b9a\u78ba\u8a8d",level:4},{value:"2.2 DB_OWNER \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",id:"22-db_owner-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",level:3},{value:"2.2.1 \u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a",id:"221-\u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a",level:4},{value:"2.2.2 idp \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",id:"222-idp-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",level:4},{value:"2.2.3 \u78ba\u8a8d",id:"223-\u78ba\u8a8d",level:4},{value:"2.3 \u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30fb\u6a29\u9650\u8a2d\u5b9a",id:"23-\u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6a29\u9650\u8a2d\u5b9a",level:3},{value:"2.3.1 pg_cron \u62e1\u5f35\uff08postgres DB\uff09",id:"231-pg_cron-\u62e1\u5f35postgres-db",level:4},{value:"2.3.2 pg_partman \u62e1\u5f35\uff08idpserver DB\uff09",id:"232-pg_partman-\u62e1\u5f35idpserver-db",level:4},{value:"2.3.3 \u30a2\u30fc\u30ab\u30a4\u30d6\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u6a29\u9650\uff08\u30aa\u30d7\u30b7\u30e7\u30f3\uff09",id:"233-\u30a2\u30fc\u30ab\u30a4\u30d6\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u6a29\u9650\u30aa\u30d7\u30b7\u30e7\u30f3",level:4},{value:"2.3.4 \u6a29\u9650\u78ba\u8a8d",id:"234-\u6a29\u9650\u78ba\u8a8d",level:4},{value:"2.4 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",id:"24-\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",level:3},{value:"2.4.1 \u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u30fc",id:"241-\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u30fc",level:4},{value:"2.4.2 \u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a",id:"242-\u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a",level:4},{value:"2.4.3 \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c",id:"243-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c",level:4},{value:"2.4.4 PostgreSQL\u8a8d\u8a3c\u8a2d\u5b9a\uff08\u63a8\u5968\uff09",id:"244-postgresql\u8a8d\u8a3c\u8a2d\u5b9a\u63a8\u5968",level:4},{value:"2.4.5 \u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d",id:"245-\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d",level:4},{value:"2.5 Flyway\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",id:"25-flyway\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",level:3},{value:"2.5.1 \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c",id:"251-\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c",level:4},{value:"2.5.2 \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u78ba\u8a8d",id:"252-\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u78ba\u8a8d",level:4},{value:"2.5.3 \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u95a2\u9023\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",id:"253-\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u95a2\u9023\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",level:4},{value:"2.6 pg_cron\u30b8\u30e7\u30d6\u767b\u9332",id:"26-pg_cron\u30b8\u30e7\u30d6\u767b\u9332",level:3},{value:"2.6.1 \u30b8\u30e7\u30d6\u767b\u9332",id:"261-\u30b8\u30e7\u30d6\u767b\u9332",level:4},{value:"2.6.2 \u767b\u9332\u3055\u308c\u308b\u30b8\u30e7\u30d6",id:"262-\u767b\u9332\u3055\u308c\u308b\u30b8\u30e7\u30d6",level:4},{value:"2.6.3 \u30b8\u30e7\u30d6\u78ba\u8a8d",id:"263-\u30b8\u30e7\u30d6\u78ba\u8a8d",level:4},{value:"2.7 S3\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u8a2d\u5b9a\uff08AWS RDS/Aurora\uff09",id:"27-s3\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u8a2d\u5b9aaws-rdsaurora",level:3},{value:"2.7.1 \u524d\u63d0\u6761\u4ef6",id:"271-\u524d\u63d0\u6761\u4ef6",level:4},{value:"2.7.2 S3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210",id:"272-s3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210",level:4},{value:"2.7.3 IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210",id:"273-iam\u30ed\u30fc\u30eb\u306e\u4f5c\u6210",level:4},{value:"2.7.4 RDS/Aurora\u3078\u306eIAM\u30ed\u30fc\u30eb\u95a2\u9023\u4ed8\u3051",id:"274-rdsaurora\u3078\u306eiam\u30ed\u30fc\u30eb\u95a2\u9023\u4ed8\u3051",level:4},{value:"2.7.5 aws_s3\u62e1\u5f35\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",id:"275-aws_s3\u62e1\u5f35\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",level:4},{value:"2.7.6 \u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u95a2\u6570\u306e\u8a2d\u5b9a",id:"276-\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u95a2\u6570\u306e\u8a2d\u5b9a",level:4},{value:"2.7.7 \u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30c6\u30b9\u30c8",id:"277-\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30c6\u30b9\u30c8",level:4},{value:"2.7.8 S3\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\uff08\u30aa\u30d7\u30b7\u30e7\u30f3\uff09",id:"278-s3\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u30aa\u30d7\u30b7\u30e7\u30f3",level:4},{value:"3. \u52d5\u4f5c\u78ba\u8a8d",id:"3-\u52d5\u4f5c\u78ba\u8a8d",level:2},{value:"3.1 RLS\u8a2d\u5b9a\u78ba\u8a8d",id:"31-rls\u8a2d\u5b9a\u78ba\u8a8d",level:3},{value:"RLS\u6709\u52b9\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d",id:"rls\u6709\u52b9\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d",level:4},{value:"RLS\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d",id:"rls\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d",level:4},{value:"3.2 \u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u52d5\u4f5c\u78ba\u8a8d",id:"32-\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u52d5\u4f5c\u78ba\u8a8d",level:3},{value:"\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d",id:"\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d",level:4},{value:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d",id:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d",level:4},{value:"3.3 pg_partman \u8a2d\u5b9a\u78ba\u8a8d",id:"33-pg_partman-\u8a2d\u5b9a\u78ba\u8a8d",level:3},{value:"3.4 \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u4e00\u89a7\u78ba\u8a8d",id:"34-\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u4e00\u89a7\u78ba\u8a8d",level:3},{value:"3.5 pg_cron \u5b9f\u884c\u5c65\u6b74\u78ba\u8a8d",id:"35-pg_cron-\u5b9f\u884c\u5c65\u6b74\u78ba\u8a8d",level:3},{value:"4. \u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",id:"4-\u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",level:2},{value:"\u5fc5\u9808\u8a2d\u5b9a\u9805\u76ee",id:"\u5fc5\u9808\u8a2d\u5b9a\u9805\u76ee",level:3},{value:"\u30aa\u30d7\u30b7\u30e7\u30f3\u8a2d\u5b9a\u9805\u76ee\uff08AWS\u74b0\u5883\uff09",id:"\u30aa\u30d7\u30b7\u30e7\u30f3\u8a2d\u5b9a\u9805\u76eeaws\u74b0\u5883",level:3},{value:"5. \u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0",id:"5-\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0",level:2},{value:"5.1 pg_cron \u30b8\u30e7\u30d6\u304c\u5b9f\u884c\u3055\u308c\u306a\u3044",id:"51-pg_cron-\u30b8\u30e7\u30d6\u304c\u5b9f\u884c\u3055\u308c\u306a\u3044",level:3},{value:"5.2 permission denied \u30a8\u30e9\u30fc",id:"52-permission-denied-\u30a8\u30e9\u30fc",level:3},{value:"5.3 \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c\u4f5c\u6210\u3055\u308c\u306a\u3044",id:"53-\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c\u4f5c\u6210\u3055\u308c\u306a\u3044",level:3},{value:"5.4 Flyway \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u304c\u5931\u6557\u3059\u308b",id:"54-flyway-\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u304c\u5931\u6557\u3059\u308b",level:3},{value:"5.5 RLS\u95a2\u9023\u306e\u30a8\u30e9\u30fc",id:"55-rls\u95a2\u9023\u306e\u30a8\u30e9\u30fc",level:3},{value:"5.6 \u63a5\u7d9a\u72b6\u6cc1\u78ba\u8a8d",id:"56-\u63a5\u7d9a\u72b6\u6cc1\u78ba\u8a8d",level:3},{value:"6. \u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",id:"6-\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",level:2}];function p(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",input:"input",li:"li",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,i.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(n.header,{children:(0,l.jsx)(n.h1,{id:"postgresql-\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a",children:"PostgreSQL \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a"})}),"\n",(0,l.jsx)(n.p,{children:"idp-server \u306e\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8\u74b0\u5883\u3067\u5fc5\u8981\u306aPostgreSQL\u8a2d\u5b9a\u306e\u624b\u9806\u3068\u52d5\u4f5c\u78ba\u8a8d\u65b9\u6cd5\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002"}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"1-\u69cb\u7bc9\u624b\u9806\u6982\u8981",children:"1. \u69cb\u7bc9\u624b\u9806\u6982\u8981"}),"\n",(0,l.jsx)(n.p,{children:"\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3092\u69cb\u7bc9\u3059\u308b\u306b\u306f\u3001\u4ee5\u4e0b\u306e\u9806\u5e8f\u3067\u8a2d\u5b9a\u3092\u884c\u3044\u307e\u3059\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  1.1 PostgreSQL\u8a2d\u5b9a                                             \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  \u2022 shared_preload_libraries \u306b pg_cron \u3092\u8ffd\u52a0                   \u2502\n\u2502  \u2022 cron.database_name = 'postgres' \u3092\u8a2d\u5b9a                       \u2502\n\u2502  \u2022 PostgreSQL\u518d\u8d77\u52d5\u304c\u5fc5\u8981                                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  1.2 DB_OWNER \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210                                       \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  \u2022 idp (DB_OWNER) - Flyway\u5b9f\u884c\u3001pg_cron\u30b8\u30e7\u30d6\u5b9f\u884c                \u2502\n\u2502  \u203b \u62e1\u5f35\u3078\u306e\u6a29\u9650\u4ed8\u4e0e\u306b\u5fc5\u8981\u306a\u305f\u3081\u5148\u306b\u4f5c\u6210                          \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  1.3 \u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30fb\u6a29\u9650\u8a2d\u5b9a                                   \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  \u2022 pg_cron \u62e1\u5f35\uff08postgres DB\u3001\u30af\u30ed\u30b9\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30e2\u30fc\u30c9\uff09          \u2502\n\u2502  \u2022 pg_partman \u62e1\u5f35\uff08idpserver DB\u3001partman\u30b9\u30ad\u30fc\u30de\uff09               \u2502\n\u2502  \u2022 idp \u30e6\u30fc\u30b6\u30fc\u3078\u306e\u6a29\u9650\u4ed8\u4e0e\uff08cron, partman \u30b9\u30ad\u30fc\u30de\uff09             \u2502\n\u2502  \u203b Flyway\u304c partman.create_parent() \u3092\u4f7f\u3046\u305f\u3081\u5fc5\u9808               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  1.4 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210                                 \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  \u2022 idp_admin_user - \u7ba1\u7406API\u7528\uff08BYPASSRLS\uff09                       \u2502\n\u2502  \u2022 idp_app_user - \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\uff08RLS\u9069\u7528\uff09                   \u2502\n\u2502  \u203b Flyway\u524d\u3067\u3082\u5f8c\u3067\u3082OK\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\u6a29\u9650\u3067\u81ea\u52d5\u4ed8\u4e0e\uff09               \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  1.5 Flyway\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3                                      \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  \u2022 \u30c6\u30fc\u30d6\u30eb\u4f5c\u6210\u3001partman.create_parent() \u3067\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u8a2d\u5b9a     \u2502\n\u2502  \u2022 archive \u30b9\u30ad\u30fc\u30de\u30fb\u95a2\u6570\u4f5c\u6210                                    \u2502\n\u2502  \u2022 RLS\u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a                                               \u2502\n\u2502  \u203b partman \u62e1\u5f35\u304c\u5fc5\u8981                                            \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  1.6 pg_cron\u30b8\u30e7\u30d6\u767b\u9332                                           \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  \u2022 partman-maintenance\uff08partman.run_maintenance_proc()\uff09        \u2502\n\u2502  \u2022 archive-processing\uff08archive.process_archive()\uff09              \u2502\n\u2502  \u203b Flyway\u3067\u30c6\u30fc\u30d6\u30eb\u30fb\u95a2\u6570\u304c\u4f5c\u6210\u3055\u308c\u305f\u5f8c\u306b\u767b\u9332                     \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  1.7 S3\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u8a2d\u5b9a\uff08\u30aa\u30d7\u30b7\u30e7\u30f3\u30fbAWS\u74b0\u5883\u306e\u307f\uff09                \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  \u2022 aws_s3 \u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb                                       \u2502\n\u2502  \u2022 IAM\u30ed\u30fc\u30eb\u4f5c\u6210\u30fb\u95a2\u9023\u4ed8\u3051                                       \u2502\n\u2502  \u2022 \u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u95a2\u6570\u306e\u8a2d\u5b9a                                        \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n                              \u2502\n                              \u25bc\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502  1.8 \u52d5\u4f5c\u78ba\u8a8d                                                    \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500  \u2502\n\u2502  \u2022 \u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u3001RLS\u3001\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u3001\u30b8\u30e7\u30d6\u306e\u78ba\u8a8d                \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u91cd\u8981"}),": 1.2\uff08idp\u4f5c\u6210\uff09\u2192 1.3\uff08\u62e1\u5f35\u30fb\u6a29\u9650\u4ed8\u4e0e\uff09\u2192 1.5\uff08Flyway\uff09\u2192 1.6\uff08pg_cron\u30b8\u30e7\u30d6\uff09\u306e\u9806\u5e8f\u306f\u53b3\u5b88\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"idp \u3078\u306e\u6a29\u9650\u4ed8\u4e0e\u306e\u305f\u3081\u3001\u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u524d\u306b idp \u30e6\u30fc\u30b6\u30fc\u304c\u5fc5\u8981"}),"\n",(0,l.jsxs)(n.li,{children:["Flyway DDL \u304c ",(0,l.jsx)(n.code,{children:"partman.create_parent()"})," \u3092\u547c\u3073\u51fa\u3059\u305f\u3081\u3001pg_partman \u62e1\u5f35\u304c\u5148\u306b\u5fc5\u8981"]}),"\n",(0,l.jsxs)(n.li,{children:["pg_cron \u30b8\u30e7\u30d6\u304c ",(0,l.jsx)(n.code,{children:"archive.*"})," \u95a2\u6570\u3092\u53c2\u7167\u3059\u308b\u305f\u3081\u3001Flyway \u5b9f\u884c\u5f8c\u306b\u30b8\u30e7\u30d6\u767b\u9332"]}),"\n",(0,l.jsx)(n.li,{children:"1.4\uff08\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\uff09\u306f 1.5\uff08Flyway\uff09\u306e\u524d\u5f8c\u3069\u3061\u3089\u3067\u3082\u53ef\uff08\u30ed\u30fc\u30ab\u30ebDocker\u74b0\u5883\u3068\u540c\u3058\u9806\u5e8f\uff09"}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"2-\u8a2d\u5b9a\u624b\u9806",children:"2. \u8a2d\u5b9a\u624b\u9806"}),"\n",(0,l.jsx)(n.h3,{id:"21-postgresql\u8a2d\u5b9a",children:"2.1 PostgreSQL\u8a2d\u5b9a"}),"\n",(0,l.jsx)(n.h4,{id:"postgresqlconf-\u306e\u8a2d\u5b9a",children:"postgresql.conf \u306e\u8a2d\u5b9a"}),"\n",(0,l.jsx)(n.p,{children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u6a5f\u80fd\u306b\u306f\u4ee5\u4e0b\u306e\u8a2d\u5b9a\u304c\u5fc5\u8981\u3067\u3059\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"shared_preload_libraries = 'pg_cron'\ncron.database_name = 'postgres'\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Note"}),": ",(0,l.jsx)(n.code,{children:"pg_partman_bgw"}),"\uff08pg_partman \u306e\u30d0\u30c3\u30af\u30b0\u30e9\u30a6\u30f3\u30c9\u30ef\u30fc\u30ab\u30fc\uff09\u306f\u4f7f\u7528\u305b\u305a\u3001pg_cron \u3067\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u7ba1\u7406\u3092\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb\u5b9f\u884c\u3057\u3066\u3044\u307e\u3059\u3002"]}),"\n",(0,l.jsx)(n.p,{children:(0,l.jsx)(n.strong,{children:"\u8a2d\u5b9a\u5f8c\u3001PostgreSQL\u306e\u518d\u8d77\u52d5\u304c\u5fc5\u8981\u3067\u3059\u3002"})}),"\n",(0,l.jsx)(n.h4,{id:"\u8a2d\u5b9a\u78ba\u8a8d",children:"\u8a2d\u5b9a\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SHOW shared_preload_libraries;\nSHOW cron.database_name;\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:" shared_preload_libraries\n--------------------------\n pg_stat_statements,pg_cron\n\n cron.database_name\n--------------------\n postgres\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"22-db_owner-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",children:"2.2 DB_OWNER \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210"}),"\n",(0,l.jsx)(n.h4,{id:"221-\u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a",children:"2.2.1 \u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a"}),"\n",(0,l.jsx)(n.p,{children:"\u203b\u30d1\u30b9\u30ef\u30fc\u30c9\u306f\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"export IDP_DB_HOST=localhost\nexport IDP_DB_PORT=5432\nexport IDP_DB_NAME=idpserver\nexport DB_OWNER_USER=idp\nexport DB_OWNER_PASSWORD=<password>\n"})}),"\n",(0,l.jsx)(n.h4,{id:"222-idp-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",children:"2.2.2 idp \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u91cd\u8981"}),": BYPASSRLS\u6a29\u9650\u3092\u6301\u3064\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3059\u308b\u306b\u306f\u3001\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u304c\u5fc5\u8981\u3067\u3059\u3002"]}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"\u30aa\u30f3\u30d7\u30ec\u30df\u30b9\u74b0\u5883"}),": PostgreSQL\u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u30fc\uff08\u4f8b: ",(0,l.jsx)(n.code,{children:"postgres"}),"\uff09\u3067\u5b9f\u884c"]}),"\n",(0,l.jsxs)(n.li,{children:[(0,l.jsx)(n.strong,{children:"AWS RDS\u74b0\u5883"}),": \u30de\u30b9\u30bf\u30fc\u30e6\u30fc\u30b6\u30fc\uff08",(0,l.jsx)(n.code,{children:"rds_superuser"}),"\u30ed\u30fc\u30eb\u3092\u6301\u3064\u30e6\u30fc\u30b6\u30fc\uff09\u3067\u5b9f\u884c"]}),"\n"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- superuser \u3067\u5b9f\u884c\n-- psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U <superuser> -d $IDP_DB_NAME\n\nCREATE USER idp WITH PASSWORD '<password>';\nGRANT CONNECT ON DATABASE idpserver TO idp;\nGRANT USAGE ON SCHEMA public TO idp;\nGRANT CREATE ON SCHEMA public TO idp;\nGRANT ALL PRIVILEGES ON DATABASE idpserver TO idp;\n\n-- BYPASSRLS \u6a29\u9650\u4ed8\u4e0e\uff08Flyway\u5b9f\u884c\u3068pg_cron\u30b8\u30e7\u30d6\u5b9f\u884c\u306b\u5fc5\u8981\uff09\nALTER USER idp BYPASSRLS;\n"})}),"\n",(0,l.jsx)(n.h4,{id:"223-\u78ba\u8a8d",children:"2.2.3 \u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT rolname, rolsuper, rolbypassrls\nFROM pg_roles\nWHERE rolname = 'idp';\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:" rolname | rolsuper | rolbypassrls\n---------+----------+--------------\n idp     | f        | t\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"23-\u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u6a29\u9650\u8a2d\u5b9a",children:"2.3 \u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u30fb\u6a29\u9650\u8a2d\u5b9a"}),"\n",(0,l.jsx)(n.h4,{id:"231-pg_cron-\u62e1\u5f35postgres-db",children:"2.3.1 pg_cron \u62e1\u5f35\uff08postgres DB\uff09"}),"\n",(0,l.jsxs)(n.p,{children:["pg_cron \u306f\u30af\u30ed\u30b9\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u30e2\u30fc\u30c9\u3067 ",(0,l.jsx)(n.code,{children:"postgres"})," \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3057\u307e\u3059\u3002"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- postgres \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\uff08superuser\u3067\u5b9f\u884c\uff09\n-- psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U <superuser> -d postgres\n\nCREATE EXTENSION IF NOT EXISTS pg_cron;\n\n-- idp \u30e6\u30fc\u30b6\u30fc\u3078\u306e\u6a29\u9650\u4ed8\u4e0e\nGRANT USAGE ON SCHEMA cron TO idp;\nGRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA cron TO idp;\nGRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA cron TO idp;\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u78ba\u8a8d"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM pg_extension WHERE extname = 'pg_cron';\n"})}),"\n",(0,l.jsx)(n.h4,{id:"232-pg_partman-\u62e1\u5f35idpserver-db",children:"2.3.2 pg_partman \u62e1\u5f35\uff08idpserver DB\uff09"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\uff08superuser\u3067\u5b9f\u884c\uff09\n-- psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U <superuser> -d idpserver\n\nCREATE SCHEMA IF NOT EXISTS partman;\nCREATE EXTENSION IF NOT EXISTS pg_partman WITH SCHEMA partman;\n\n-- idp \u30e6\u30fc\u30b6\u30fc\u3078\u306e\u6a29\u9650\u4ed8\u4e0e\nGRANT USAGE, CREATE ON SCHEMA partman TO idp;\nGRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA partman TO idp;\nGRANT SELECT, INSERT, UPDATE, DELETE ON ALL TABLES IN SCHEMA partman TO idp;\nGRANT ALL ON ALL SEQUENCES IN SCHEMA partman TO idp;\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u78ba\u8a8d"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT * FROM pg_extension WHERE extname = 'pg_partman';\n"})}),"\n",(0,l.jsx)(n.h4,{id:"233-\u30a2\u30fc\u30ab\u30a4\u30d6\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u6a29\u9650\u30aa\u30d7\u30b7\u30e7\u30f3",children:"2.3.3 \u30a2\u30fc\u30ab\u30a4\u30d6\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u6a29\u9650\uff08\u30aa\u30d7\u30b7\u30e7\u30f3\uff09"}),"\n",(0,l.jsx)(n.p,{children:"\u30ed\u30fc\u30ab\u30eb\u30d5\u30a1\u30a4\u30eb\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u3092\u4f7f\u7528\u3059\u308b\u5834\u5408\u306e\u307f\u5fc5\u8981\u3067\u3059\u3002\u672c\u756a\u74b0\u5883\u3067\u306f AWS S3 \u7b49\u306e\u5916\u90e8\u30b9\u30c8\u30ec\u30fc\u30b8\u3092\u4f7f\u7528\u3059\u308b\u3053\u3068\u3092\u63a8\u5968\u3057\u307e\u3059\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\nGRANT pg_write_server_files TO idp;\n"})}),"\n",(0,l.jsx)(n.h4,{id:"234-\u6a29\u9650\u78ba\u8a8d",children:"2.3.4 \u6a29\u9650\u78ba\u8a8d"}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u30b9\u30ad\u30fc\u30de\u6a29\u9650\u78ba\u8a8d"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT\n    nspname AS schema_name,\n    pg_get_userbyid(nspowner) AS owner,\n    nspacl AS access_privileges\nFROM pg_namespace\nWHERE nspname IN ('partman', 'cron');\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:" schema_name |   owner   |                  access_privileges\n-------------+-----------+-------------------------------------------\n partman     | <superuser> | {...,idp=UC/<superuser>}\n cron        | postgres  | {postgres=UC/postgres,idp=U/postgres}\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"24-\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210",children:"2.4 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210"}),"\n",(0,l.jsx)(n.p,{children:"Flyway\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u524d\u306b\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u3092\u4f5c\u6210\u3057\u307e\u3059\uff08\u30ed\u30fc\u30ab\u30ebDocker\u74b0\u5883\u3068\u540c\u3058\u9806\u5e8f\uff09\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"241-\u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u30fc",children:"2.4.1 \u4f5c\u6210\u3059\u308b\u30e6\u30fc\u30b6\u30fc"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u30e6\u30fc\u30b6\u30fc"}),(0,l.jsx)(n.th,{children:"\u5f79\u5272"}),(0,l.jsx)(n.th,{children:"BYPASSRLS"}),(0,l.jsx)(n.th,{children:"\u7528\u9014"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"idp_admin_user"})}),(0,l.jsx)(n.td,{children:"\u7ba1\u7406API\u7528"}),(0,l.jsx)(n.td,{children:"Yes"}),(0,l.jsx)(n.td,{children:"Control Plane API\uff08\u30c6\u30ca\u30f3\u30c8\u6a2a\u65ad\u64cd\u4f5c\uff09"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"idp_app_user"})}),(0,l.jsx)(n.td,{children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528"}),(0,l.jsx)(n.td,{children:"No"}),(0,l.jsx)(n.td,{children:"\u901a\u5e38\u306eAPI\uff08RLS\u9069\u7528\uff09"})]})]})]}),"\n",(0,l.jsx)(n.h4,{id:"242-\u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a",children:"2.4.2 \u74b0\u5883\u5909\u6570\u306e\u8a2d\u5b9a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"export IDP_DB_ADMIN_USER=idp_admin_user\nexport IDP_DB_ADMIN_PASSWORD=<admin_password>\nexport IDP_DB_APP_USER=idp_app_user\nexport IDP_DB_APP_PASSWORD=<app_password>\n"})}),"\n",(0,l.jsx)(n.h4,{id:"243-\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c",children:"2.4.3 \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\u30b9\u30af\u30ea\u30d7\u30c8\u306e\u5b9f\u884c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# \u30b9\u30fc\u30d1\u30fc\u30e6\u30fc\u30b6\u30fc\u3067\u5b9f\u884c\npsql -h $IDP_DB_HOST -p $IDP_DB_PORT -U <superuser> -d $IDP_DB_NAME \\\n  -f ./libs/idp-server-database/postgresql/user/admin_user.sql\n\npsql -h $IDP_DB_HOST -p $IDP_DB_PORT -U <superuser> -d $IDP_DB_NAME \\\n  -f ./libs/idp-server-database/postgresql/user/app_user.sql\n"})}),"\n",(0,l.jsx)(n.h4,{id:"244-postgresql\u8a8d\u8a3c\u8a2d\u5b9a\u63a8\u5968",children:"2.4.4 PostgreSQL\u8a8d\u8a3c\u8a2d\u5b9a\uff08\u63a8\u5968\uff09"}),"\n",(0,l.jsxs)(n.p,{children:["\u30d1\u30b9\u30ef\u30fc\u30c9\u81ea\u52d5\u8a8d\u8a3c\u306e\u305f\u3081",(0,l.jsx)(n.code,{children:".pgpass"}),"\u30d5\u30a1\u30a4\u30eb\u3092\u8a2d\u5b9a\uff1a"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"cat > ~/.pgpass << 'EOF'\nlocalhost:5432:idpserver:idp:<password>\nlocalhost:5432:idpserver:idp_admin_user:<admin_password>\nlocalhost:5432:idpserver:idp_app_user:<app_password>\nlocalhost:5432:postgres:idp:<password>\nEOF\nchmod 600 ~/.pgpass\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u30d5\u30a9\u30fc\u30de\u30c3\u30c8"}),": ",(0,l.jsx)(n.code,{children:"hostname:port:database:username:password"})]}),"\n",(0,l.jsx)(n.h4,{id:"245-\u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d",children:"2.4.5 \u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U <superuser> -d $IDP_DB_NAME \\\n  -f ./libs/idp-server-database/postgresql/operation/select-user-role.sql\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"    rolname     | rolsuper | rolbypassrls | rolconnlimit\n----------------+----------+--------------+--------------\n idp            | f        | t            |           -1\n idp_admin_user | f        | t            |           -1\n idp_app_user   | f        | f            |           -1\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"Note"}),": ",(0,l.jsx)(n.code,{children:"rolconnlimit = -1"})," \u306f\u7121\u5236\u9650\u3092\u610f\u5473\u3057\u307e\u3059\u3002\u63a5\u7d9a\u6570\u5236\u9650\u306f\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u306e\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\uff08HikariCP\u7b49\uff09\u3067\u7ba1\u7406\u3057\u307e\u3059\u3002"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"25-flyway\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",children:"2.5 Flyway\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,l.jsx)(n.h4,{id:"251-\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c",children:"2.5.1 \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# idp \u30e6\u30fc\u30b6\u30fc\uff08DB_OWNER\uff09\u3067\u5b9f\u884c\nflyway -url=jdbc:postgresql://$IDP_DB_HOST:$IDP_DB_PORT/idpserver \\\n       -user=idp \\\n       -password=<password> \\\n       migrate\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u307e\u305f\u306f Gradle \u3092\u4f7f\u7528\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"DB_TYPE=postgresql ./gradlew flywayMigrate\n"})}),"\n",(0,l.jsx)(n.h4,{id:"252-\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u78ba\u8a8d",children:"2.5.2 \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"flyway -url=jdbc:postgresql://$IDP_DB_HOST:$IDP_DB_PORT/idpserver \\\n       -user=idp \\\n       -password=<password> \\\n       info\n"})}),"\n",(0,l.jsx)(n.p,{children:"\u307e\u305f\u306f\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"./gradlew flywayInfo\n"})}),"\n",(0,l.jsx)(n.p,{children:'\u5168\u3066\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u304c "Success" \u3067\u3042\u308b\u3053\u3068\u3092\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\u3002'}),"\n",(0,l.jsx)(n.h4,{id:"253-\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u95a2\u9023\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3",children:"2.5.3 \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u95a2\u9023\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,l.jsx)(n.p,{children:"\u4ee5\u4e0b\u306e\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u3067\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u304c\u8a2d\u5b9a\u3055\u308c\u307e\u3059\uff1a"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3"}),(0,l.jsx)(n.th,{children:"\u5185\u5bb9"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"V0_9_21_1__add_event_partitioning.sql"})}),(0,l.jsx)(n.td,{children:"security_event, security_event_hook_results \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u8a2d\u5b9a"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"V0_9_21_2__statistics.sql"})}),(0,l.jsx)(n.td,{children:"statistics_daily_users, statistics_monthly_users, statistics_yearly_users \u306e\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u8a2d\u5b9a"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"V0_9_21_3__archive_support.sql"})}),(0,l.jsx)(n.td,{children:"archive \u30b9\u30ad\u30fc\u30de\u30fb\u95a2\u6570\u4f5c\u6210\u3001retention_schema \u8a2d\u5b9a"})]})]})]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"26-pg_cron\u30b8\u30e7\u30d6\u767b\u9332",children:"2.6 pg_cron\u30b8\u30e7\u30d6\u767b\u9332"}),"\n",(0,l.jsx)(n.h4,{id:"261-\u30b8\u30e7\u30d6\u767b\u9332",children:"2.6.1 \u30b8\u30e7\u30d6\u767b\u9332"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# idp \u30e6\u30fc\u30b6\u30fc\u3067 postgres \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\u3057\u3066\u5b9f\u884c\npsql -h $IDP_DB_HOST -p $IDP_DB_PORT -U idp -d postgres \\\n  -f ./libs/idp-server-database/postgresql/operation/setup-pg-cron-jobs.sql\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u91cd\u8981"}),": pg_cron \u306f postgres \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u305f\u3081\u3001postgres \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\u3057\u3066\u30b8\u30e7\u30d6\u3092\u767b\u9332\u3057\u307e\u3059\u3002\u30b8\u30e7\u30d6\u306f ",(0,l.jsx)(n.code,{children:"cron.schedule_in_database()"})," \u3092\u4f7f\u7528\u3057\u3066 idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u3067\u5b9f\u884c\u3055\u308c\u307e\u3059\u3002"]}),"\n",(0,l.jsx)(n.h4,{id:"262-\u767b\u9332\u3055\u308c\u308b\u30b8\u30e7\u30d6",children:"2.6.2 \u767b\u9332\u3055\u308c\u308b\u30b8\u30e7\u30d6"}),"\n",(0,l.jsxs)(n.table,{children:[(0,l.jsx)(n.thead,{children:(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.th,{children:"\u30b8\u30e7\u30d6\u540d"}),(0,l.jsx)(n.th,{children:"\u30b9\u30b1\u30b8\u30e5\u30fc\u30eb"}),(0,l.jsx)(n.th,{children:"\u5b9f\u884cDB"}),(0,l.jsx)(n.th,{children:"\u8aac\u660e"})]})}),(0,l.jsxs)(n.tbody,{children:[(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"partman-maintenance"})}),(0,l.jsx)(n.td,{children:"\u6bce\u65e5 02:00 UTC"}),(0,l.jsx)(n.td,{children:"idpserver"}),(0,l.jsx)(n.td,{children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u4f5c\u6210\u30fb\u524a\u9664"})]}),(0,l.jsxs)(n.tr,{children:[(0,l.jsx)(n.td,{children:(0,l.jsx)(n.code,{children:"archive-processing"})}),(0,l.jsx)(n.td,{children:"\u6bce\u65e5 03:00 UTC"}),(0,l.jsx)(n.td,{children:"idpserver"}),(0,l.jsx)(n.td,{children:"\u30a2\u30fc\u30ab\u30a4\u30d6\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30fb\u524a\u9664"})]})]})]}),"\n",(0,l.jsx)(n.h4,{id:"263-\u30b8\u30e7\u30d6\u78ba\u8a8d",children:"2.6.3 \u30b8\u30e7\u30d6\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- postgres \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\nSELECT\n    jobid,\n    jobname,\n    schedule,\n    database,\n    username,\n    active\nFROM cron.job\nWHERE jobname IN ('partman-maintenance', 'archive-processing');\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:" jobid |       jobname       | schedule  | database  | username | active\n-------+---------------------+-----------+-----------+----------+--------\n     1 | partman-maintenance | 0 2 * * * | idpserver | idp      | t\n     2 | archive-processing  | 0 3 * * * | idpserver | idp      | t\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h3,{id:"27-s3\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u8a2d\u5b9aaws-rdsaurora",children:"2.7 S3\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u8a2d\u5b9a\uff08AWS RDS/Aurora\uff09"}),"\n",(0,l.jsx)(n.p,{children:"AWS\u74b0\u5883\u3067\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30a4\u30d9\u30f3\u30c8\u3092S3\u306b\u30a2\u30fc\u30ab\u30a4\u30d6\u3059\u308b\u5834\u5408\u306e\u8a2d\u5b9a\u3067\u3059\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"271-\u524d\u63d0\u6761\u4ef6",children:"2.7.1 \u524d\u63d0\u6761\u4ef6"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:"AWS RDS PostgreSQL \u307e\u305f\u306f Aurora PostgreSQL"}),"\n",(0,l.jsx)(n.li,{children:"S3\u30d0\u30b1\u30c3\u30c8\uff08\u30a2\u30fc\u30ab\u30a4\u30d6\u7528\uff09"}),"\n",(0,l.jsx)(n.li,{children:"IAM\u30ed\u30fc\u30eb\uff08RDS/Aurora \u2192 S3\u30a2\u30af\u30bb\u30b9\u7528\uff09"}),"\n"]}),"\n",(0,l.jsx)(n.h4,{id:"272-s3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210",children:"2.7.2 S3\u30d0\u30b1\u30c3\u30c8\u306e\u4f5c\u6210"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'# S3\u30d0\u30b1\u30c3\u30c8\u4f5c\u6210\naws s3 mb s3://your-idp-archive-bucket --region ap-northeast-1\n\n# \u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a\uff08\u30b3\u30b9\u30c8\u6700\u9069\u5316\uff09\ncat > lifecycle-policy.json << \'EOF\'\n{\n  "Rules": [\n    {\n      "ID": "ArchiveToGlacier",\n      "Status": "Enabled",\n      "Filter": { "Prefix": "security_event/" },\n      "Transitions": [\n        { "Days": 90, "StorageClass": "STANDARD_IA" },\n        { "Days": 365, "StorageClass": "GLACIER" }\n      ]\n    }\n  ]\n}\nEOF\n\naws s3api put-bucket-lifecycle-configuration \\\n  --bucket your-idp-archive-bucket \\\n  --lifecycle-configuration file://lifecycle-policy.json\n'})}),"\n",(0,l.jsx)(n.h4,{id:"273-iam\u30ed\u30fc\u30eb\u306e\u4f5c\u6210",children:"2.7.3 IAM\u30ed\u30fc\u30eb\u306e\u4f5c\u6210"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:'# \u4fe1\u983c\u30dd\u30ea\u30b7\u30fc\ncat > trust-policy.json << \'EOF\'\n{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Principal": { "Service": "rds.amazonaws.com" },\n      "Action": "sts:AssumeRole"\n    }\n  ]\n}\nEOF\n\n# IAM\u30ed\u30fc\u30eb\u4f5c\u6210\naws iam create-role \\\n  --role-name idp-rds-s3-export-role \\\n  --assume-role-policy-document file://trust-policy.json\n\n# S3\u30a2\u30af\u30bb\u30b9\u30dd\u30ea\u30b7\u30fc\ncat > s3-policy.json << \'EOF\'\n{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Effect": "Allow",\n      "Action": [\n        "s3:PutObject",\n        "s3:GetObject",\n        "s3:ListBucket",\n        "s3:DeleteObject"\n      ],\n      "Resource": [\n        "arn:aws:s3:::your-idp-archive-bucket",\n        "arn:aws:s3:::your-idp-archive-bucket/*"\n      ]\n    }\n  ]\n}\nEOF\n\naws iam put-role-policy \\\n  --role-name idp-rds-s3-export-role \\\n  --policy-name S3ExportPolicy \\\n  --policy-document file://s3-policy.json\n'})}),"\n",(0,l.jsx)(n.h4,{id:"274-rdsaurora\u3078\u306eiam\u30ed\u30fc\u30eb\u95a2\u9023\u4ed8\u3051",children:"2.7.4 RDS/Aurora\u3078\u306eIAM\u30ed\u30fc\u30eb\u95a2\u9023\u4ed8\u3051"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-bash",children:"# RDS\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u306bIAM\u30ed\u30fc\u30eb\u3092\u95a2\u9023\u4ed8\u3051\naws rds add-role-to-db-instance \\\n  --db-instance-identifier your-rds-instance \\\n  --role-arn arn:aws:iam::ACCOUNT_ID:role/idp-rds-s3-export-role \\\n  --feature-name s3Export\n\n# Aurora \u306e\u5834\u5408\u306f\u30af\u30e9\u30b9\u30bf\u30fc\u306b\u95a2\u9023\u4ed8\u3051\naws rds add-role-to-db-cluster \\\n  --db-cluster-identifier your-aurora-cluster \\\n  --role-arn arn:aws:iam::ACCOUNT_ID:role/idp-rds-s3-export-role \\\n  --feature-name s3Export\n"})}),"\n",(0,l.jsx)(n.h4,{id:"275-aws_s3\u62e1\u5f35\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",children:"2.7.5 aws_s3\u62e1\u5f35\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\uff08superuser\u3067\u5b9f\u884c\uff09\n-- psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U <superuser> -d idpserver\n\nCREATE EXTENSION IF NOT EXISTS aws_s3 CASCADE;\n\n-- \u78ba\u8a8d\nSELECT * FROM pg_extension WHERE extname IN ('aws_s3', 'aws_commons');\n"})}),"\n",(0,l.jsx)(n.h4,{id:"276-\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u95a2\u6570\u306e\u8a2d\u5b9a",children:"2.7.6 \u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u95a2\u6570\u306e\u8a2d\u5b9a"}),"\n",(0,l.jsx)(n.p,{children:"Flyway\u3067\u4f5c\u6210\u3055\u308c\u305f\u30b9\u30bf\u30d6\u95a2\u6570\u3092\u3001S3\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u5b9f\u88c5\u306b\u7f6e\u304d\u63db\u3048\u307e\u3059\u3002"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\uff08idp \u30e6\u30fc\u30b6\u30fc\u3067\u5b9f\u884c\uff09\n-- psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U idp -d idpserver\n\n-- S3\u30d1\u30b9\u69cb\u7bc9\u30d8\u30eb\u30d1\u30fc\u95a2\u6570\nCREATE OR REPLACE FUNCTION archive.build_s3_path(p_table_name TEXT)\nRETURNS TEXT AS $$\nDECLARE\n    date_part TEXT;\n    year_val TEXT;\n    month_val TEXT;\n    day_val TEXT;\n    base_name TEXT;\nBEGIN\n    -- \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u540d\u304b\u3089\u65e5\u4ed8\u3092\u62bd\u51fa\n    -- \u4f8b: security_event_p20250905 \u2192 security_event/year=2025/month=09/day=05/\n    IF p_table_name ~ '_p[0-9]{8}$' THEN\n        date_part := substring(p_table_name from '_p([0-9]{8})$');\n        base_name := regexp_replace(p_table_name, '_p[0-9]{8}$', '');\n        year_val := substring(date_part from 1 for 4);\n        month_val := substring(date_part from 5 for 2);\n        day_val := substring(date_part from 7 for 2);\n\n        RETURN format('%s/year=%s/month=%s/day=%s/data.csv',\n                      base_name, year_val, month_val, day_val);\n    ELSE\n        RETURN format('archive/%s/data.csv', p_table_name);\n    END IF;\nEND;\n$$ LANGUAGE plpgsql;\n\n-- S3\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u95a2\u6570\uff08\u30b9\u30bf\u30d6\u95a2\u6570\u3092\u7f6e\u304d\u63db\u3048\uff09\nCREATE OR REPLACE FUNCTION archive.export_partition_to_external_storage(\n    p_schema_name TEXT,\n    p_table_name TEXT,\n    p_destination_path TEXT DEFAULT NULL\n)\nRETURNS BOOLEAN AS $$\nDECLARE\n    v_s3_bucket TEXT := 'your-idp-archive-bucket';  -- \u2605 \u8981\u5909\u66f4\n    v_s3_region TEXT := 'ap-northeast-1';           -- \u2605 \u8981\u5909\u66f4\n    v_s3_path TEXT;\n    v_row_count BIGINT;\n    v_result RECORD;\nBEGIN\n    -- \u884c\u6570\u53d6\u5f97\n    EXECUTE format('SELECT COUNT(*) FROM %I.%I', p_schema_name, p_table_name)\n    INTO v_row_count;\n\n    IF v_row_count = 0 THEN\n        RAISE NOTICE 'Table %.% is empty, skipping export', p_schema_name, p_table_name;\n        RETURN TRUE;\n    END IF;\n\n    -- S3\u30d1\u30b9\u306e\u69cb\u7bc9\uff08Hive\u5f62\u5f0f\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\uff09\n    v_s3_path := COALESCE(p_destination_path, archive.build_s3_path(p_table_name));\n\n    RAISE NOTICE 'Exporting %.% (% rows) to s3://%/%',\n        p_schema_name, p_table_name, v_row_count, v_s3_bucket, v_s3_path;\n\n    -- S3\u306b\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\n    SELECT * INTO v_result FROM aws_s3.query_export_to_s3(\n        format('SELECT * FROM %I.%I', p_schema_name, p_table_name),\n        aws_commons.create_s3_uri(v_s3_bucket, v_s3_path, v_s3_region),\n        options := 'FORMAT CSV, HEADER TRUE'\n    );\n\n    RAISE NOTICE 'Exported % rows, % files, % bytes to S3',\n        v_result.rows_uploaded, v_result.files_uploaded, v_result.bytes_uploaded;\n\n    RETURN TRUE;\n\nEXCEPTION WHEN OTHERS THEN\n    RAISE WARNING 'S3 export failed for %.%: %', p_schema_name, p_table_name, SQLERRM;\n    RETURN FALSE;\nEND;\n$$ LANGUAGE plpgsql;\n\nCOMMENT ON FUNCTION archive.export_partition_to_external_storage(TEXT, TEXT, TEXT) IS\n'Export archived partition to AWS S3. Uses aws_s3 extension for direct export.';\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u91cd\u8981"}),": ",(0,l.jsx)(n.code,{children:"v_s3_bucket"})," \u3068 ",(0,l.jsx)(n.code,{children:"v_s3_region"})," \u3092\u5b9f\u969b\u306e\u5024\u306b\u5909\u66f4\u3057\u3066\u304f\u3060\u3055\u3044\u3002"]}),"\n",(0,l.jsx)(n.h4,{id:"277-\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30c6\u30b9\u30c8",children:"2.7.7 \u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30c6\u30b9\u30c8"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\n\n-- archive\u30b9\u30ad\u30fc\u30de\u306e\u72b6\u614b\u78ba\u8a8d\nSELECT * FROM archive.get_archive_status();\n\n-- dry run\u3067\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u5bfe\u8c61\u3092\u78ba\u8a8d\nSELECT * FROM archive.process_archived_partitions(p_dry_run := TRUE);\n\n-- \u5358\u4e00\u30c6\u30fc\u30d6\u30eb\u306e\u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30c6\u30b9\u30c8\uff08\u30c6\u30b9\u30c8\u7528\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c\u3042\u308b\u5834\u5408\uff09\n-- SELECT archive.export_partition_to_external_storage('archive', 'security_event_p20250101');\n\n-- S3\u306b\u30a2\u30c3\u30d7\u30ed\u30fc\u30c9\u3055\u308c\u305f\u304b\u78ba\u8a8d\n-- aws s3 ls s3://your-idp-archive-bucket/security_event/ --recursive\n"})}),"\n",(0,l.jsx)(n.h4,{id:"278-s3\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\u30aa\u30d7\u30b7\u30e7\u30f3",children:"2.7.8 S3\u30d0\u30b1\u30c3\u30c8\u30dd\u30ea\u30b7\u30fc\uff08\u30aa\u30d7\u30b7\u30e7\u30f3\uff09"}),"\n",(0,l.jsx)(n.p,{children:"VPC\u30a8\u30f3\u30c9\u30dd\u30a4\u30f3\u30c8\u7d4c\u7531\u306e\u30a2\u30af\u30bb\u30b9\u306e\u307f\u306b\u5236\u9650\u3059\u308b\u5834\u5408\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-json",children:'{\n  "Version": "2012-10-17",\n  "Statement": [\n    {\n      "Sid": "AllowVPCEndpointAccess",\n      "Effect": "Deny",\n      "Principal": "*",\n      "Action": "s3:*",\n      "Resource": [\n        "arn:aws:s3:::your-idp-archive-bucket",\n        "arn:aws:s3:::your-idp-archive-bucket/*"\n      ],\n      "Condition": {\n        "StringNotEquals": {\n          "aws:sourceVpce": "vpce-xxxxxxxxxx"\n        }\n      }\n    }\n  ]\n}\n'})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"3-\u52d5\u4f5c\u78ba\u8a8d",children:"3. \u52d5\u4f5c\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.h3,{id:"31-rls\u8a2d\u5b9a\u78ba\u8a8d",children:"3.1 RLS\u8a2d\u5b9a\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.h4,{id:"rls\u6709\u52b9\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d",children:"RLS\u6709\u52b9\u30c6\u30fc\u30d6\u30eb\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_ADMIN_USER -d $IDP_DB_NAME \\\n  -f ./libs/idp-server-database/postgresql/operation/select-rls-table.sql\n"})}),"\n",(0,l.jsx)(n.h4,{id:"rls\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d",children:"RLS\u30dd\u30ea\u30b7\u30fc\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:"psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_ADMIN_USER -d $IDP_DB_NAME \\\n  -f ./libs/idp-server-database/postgresql/operation/select-rls-policy.sql\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:" schemaname |       tablename        |      policyname       |        policy_condition\n------------+------------------------+-----------------------+------------------------------\n public     | tenant                 | tenant_isolation_policy | (id = current_setting('app.tenant_id'::text)::uuid)\n(29 rows)\n"})}),"\n",(0,l.jsx)(n.h3,{id:"32-\u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u52d5\u4f5c\u78ba\u8a8d",children:"3.2 \u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u52d5\u4f5c\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.h4,{id:"\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d",children:"\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:'psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_ADMIN_USER -d $IDP_DB_NAME \\\n  -c "SELECT COUNT(*) FROM tenant;"\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u7ba1\u7406\u8005\u30e6\u30fc\u30b6\u30fc\uff08BYPASSRLS\uff09\u306f\u5168\u30c7\u30fc\u30bf\u306b\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3067\u3059\u3002"}),"\n",(0,l.jsx)(n.h4,{id:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d",children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u3067\u306e\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-shell",children:'psql -h $IDP_DB_HOST -p $IDP_DB_PORT -U $IDP_DB_APP_USER -d $IDP_DB_NAME \\\n  -c "SELECT COUNT(*) FROM tenant"\n'})}),"\n",(0,l.jsx)(n.p,{children:"\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u306fRLS\u9069\u7528\u306e\u305f\u3081\u3001\u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u306b\u5fdc\u3058\u305f\u30c7\u30fc\u30bf\u306e\u307f\u30a2\u30af\u30bb\u30b9\u53ef\u80fd\u3067\u3059\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- \u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u306a\u3057\nSELECT COUNT(*) FROM tenant;\n-- \u7d50\u679c: count = 0 \u307e\u305f\u306f ERROR: app.tenant_id is not set\n\n-- \u30c6\u30ca\u30f3\u30c8\u8a2d\u5b9a\u3042\u308a\nSET app.tenant_id = 'aaaaaaaa-bbbb-cccc-dddd-eeeeeeeeeeee';\nSELECT COUNT(*) FROM tenant;\n-- \u7d50\u679c: count = 1 (\u30c6\u30ca\u30f3\u30c8\u81ea\u8eab\u306e\u30c7\u30fc\u30bf\u306e\u307f)\n"})}),"\n",(0,l.jsx)(n.h3,{id:"33-pg_partman-\u8a2d\u5b9a\u78ba\u8a8d",children:"3.3 pg_partman \u8a2d\u5b9a\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\nSELECT\n    parent_table,\n    partition_interval,\n    retention,\n    retention_keep_table,\n    retention_schema,\n    premake\nFROM partman.part_config;\n"})}),"\n",(0,l.jsxs)(n.p,{children:[(0,l.jsx)(n.strong,{children:"\u671f\u5f85\u7d50\u679c"}),":"]}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{children:"           parent_table            | partition_interval | retention | retention_keep_table | retention_schema | premake\n-----------------------------------+--------------------+-----------+----------------------+------------------+---------\n public.security_event             | 1 day              | 90 days   | t                    | archive          |       7\n public.security_event_hook_results| 1 day              | 90 days   | t                    | archive          |       7\n public.statistics_daily_users     | 1 day              | 90 days   | f                    |                  |       7\n public.statistics_monthly_users   | 1 mon              | 13 months | f                    |                  |      13\n public.statistics_yearly_users    | 1 year             | 5 years   | f                    |                  |       5\n"})}),"\n",(0,l.jsx)(n.h3,{id:"34-\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u4e00\u89a7\u78ba\u8a8d",children:"3.4 \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u4e00\u89a7\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\nSELECT\n    tablename,\n    pg_size_pretty(pg_total_relation_size('public.' || tablename)) as size\nFROM pg_tables\nWHERE tablename LIKE 'security_event_p%'\nORDER BY tablename DESC\nLIMIT 10;\n"})}),"\n",(0,l.jsx)(n.h3,{id:"35-pg_cron-\u5b9f\u884c\u5c65\u6b74\u78ba\u8a8d",children:"3.5 pg_cron \u5b9f\u884c\u5c65\u6b74\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- postgres \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\nSELECT\n    jobid,\n    jobname,\n    start_time,\n    end_time,\n    status,\n    return_message\nFROM cron.job_run_details\nWHERE jobname IN ('partman-maintenance', 'archive-processing')\nORDER BY start_time DESC\nLIMIT 10;\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"4-\u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8",children:"4. \u8a2d\u5b9a\u30c1\u30a7\u30c3\u30af\u30ea\u30b9\u30c8"}),"\n",(0,l.jsx)(n.h3,{id:"\u5fc5\u9808\u8a2d\u5b9a\u9805\u76ee",children:"\u5fc5\u9808\u8a2d\u5b9a\u9805\u76ee"}),"\n",(0,l.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.1"}),": ",(0,l.jsx)(n.code,{children:"shared_preload_libraries"})," \u306b ",(0,l.jsx)(n.code,{children:"pg_cron"})," \u8ffd\u52a0"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.1"}),": ",(0,l.jsx)(n.code,{children:"cron.database_name = 'postgres'"})," \u8a2d\u5b9a"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.1"}),": PostgreSQL \u518d\u8d77\u52d5"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.2"}),": idp (DB_OWNER) \u30e6\u30fc\u30b6\u30fc\u4f5c\u6210"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.3"}),": pg_cron \u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08postgres DB\uff09"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.3"}),": pg_partman \u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\uff08idpserver DB\uff09"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.3"}),": idp \u30e6\u30fc\u30b6\u30fc\u3078\u306e\u6a29\u9650\u4ed8\u4e0e"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.4"}),": \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e6\u30fc\u30b6\u30fc\u4f5c\u6210\uff08idp_admin_user, idp_app_user\uff09"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.5"}),": Flyway \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u5b9f\u884c"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.6"}),": pg_cron \u30b8\u30e7\u30d6\u767b\u9332"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"3.1"}),": RLS \u8a2d\u5b9a\u78ba\u8a8d"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"3.2"}),": \u30c6\u30ca\u30f3\u30c8\u5206\u96e2\u52d5\u4f5c\u78ba\u8a8d"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"3.3"}),": pg_partman \u8a2d\u5b9a\u78ba\u8a8d"]}),"\n"]}),"\n",(0,l.jsx)(n.h3,{id:"\u30aa\u30d7\u30b7\u30e7\u30f3\u8a2d\u5b9a\u9805\u76eeaws\u74b0\u5883",children:"\u30aa\u30d7\u30b7\u30e7\u30f3\u8a2d\u5b9a\u9805\u76ee\uff08AWS\u74b0\u5883\uff09"}),"\n",(0,l.jsxs)(n.ul,{className:"contains-task-list",children:["\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.7"}),": S3\u30d0\u30b1\u30c3\u30c8\u4f5c\u6210\u30fb\u30e9\u30a4\u30d5\u30b5\u30a4\u30af\u30eb\u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.7"}),": IAM\u30ed\u30fc\u30eb\u4f5c\u6210\u30fbS3\u30a2\u30af\u30bb\u30b9\u30dd\u30ea\u30b7\u30fc\u8a2d\u5b9a"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.7"}),": RDS/Aurora\u3078\u306eIAM\u30ed\u30fc\u30eb\u95a2\u9023\u4ed8\u3051"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.7"}),": aws_s3 \u62e1\u5f35\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.7"}),": \u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u95a2\u6570\u306e\u8a2d\u5b9a\uff08\u30b9\u30bf\u30d6\u95a2\u6570\u306e\u7f6e\u304d\u63db\u3048\uff09"]}),"\n",(0,l.jsxs)(n.li,{className:"task-list-item",children:[(0,l.jsx)(n.input,{type:"checkbox",disabled:!0})," ",(0,l.jsx)(n.strong,{children:"2.7"}),": \u30a8\u30af\u30b9\u30dd\u30fc\u30c8\u30c6\u30b9\u30c8\u5b9f\u884c"]}),"\n"]}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"5-\u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0",children:"5. \u30c8\u30e9\u30d6\u30eb\u30b7\u30e5\u30fc\u30c6\u30a3\u30f3\u30b0"}),"\n",(0,l.jsx)(n.h3,{id:"51-pg_cron-\u30b8\u30e7\u30d6\u304c\u5b9f\u884c\u3055\u308c\u306a\u3044",children:"5.1 pg_cron \u30b8\u30e7\u30d6\u304c\u5b9f\u884c\u3055\u308c\u306a\u3044"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- postgres \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\n-- \u30b8\u30e7\u30d6\u304c active \u304b\u78ba\u8a8d\nSELECT jobname, active FROM cron.job;\n\n-- \u5b9f\u884c\u5c65\u6b74\u3067\u30a8\u30e9\u30fc\u3092\u78ba\u8a8d\nSELECT jobname, status, return_message\nFROM cron.job_run_details\nORDER BY start_time DESC\nLIMIT 5;\n"})}),"\n",(0,l.jsx)(n.h3,{id:"52-permission-denied-\u30a8\u30e9\u30fc",children:"5.2 permission denied \u30a8\u30e9\u30fc"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- \u6a29\u9650\u78ba\u8a8d\nSELECT\n    nspname,\n    nspacl\nFROM pg_namespace\nWHERE nspname IN ('cron', 'partman');\n\n-- \u5fc5\u8981\u306b\u5fdc\u3058\u3066\u6a29\u9650\u4ed8\u4e0e\nGRANT USAGE ON SCHEMA cron TO idp;\nGRANT EXECUTE ON ALL FUNCTIONS IN SCHEMA cron TO idp;\n"})}),"\n",(0,l.jsx)(n.h3,{id:"53-\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c\u4f5c\u6210\u3055\u308c\u306a\u3044",children:"5.3 \u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30f3\u304c\u4f5c\u6210\u3055\u308c\u306a\u3044"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\n-- partman \u8a2d\u5b9a\u78ba\u8a8d\nSELECT parent_table, automatic_maintenance, premake\nFROM partman.part_config;\n\n-- \u624b\u52d5\u3067\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u5b9f\u884c\nCALL partman.run_maintenance_proc();\n"})}),"\n",(0,l.jsx)(n.h3,{id:"54-flyway-\u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u304c\u5931\u6557\u3059\u308b",children:"5.4 Flyway \u30de\u30a4\u30b0\u30ec\u30fc\u30b7\u30e7\u30f3\u304c\u5931\u6557\u3059\u308b"}),"\n",(0,l.jsx)(n.p,{children:"pg_partman \u62e1\u5f35\u304c\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\u3055\u308c\u3066\u3044\u308b\u304b\u78ba\u8a8d\u3057\u3066\u304f\u3060\u3055\u3044\uff1a"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- idpserver \u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u306b\u63a5\u7d9a\nSELECT * FROM pg_extension WHERE extname = 'pg_partman';\n\n-- partman \u30b9\u30ad\u30fc\u30de\u304c\u5b58\u5728\u3059\u308b\u304b\u78ba\u8a8d\nSELECT nspname FROM pg_namespace WHERE nspname = 'partman';\n"})}),"\n",(0,l.jsx)(n.h3,{id:"55-rls\u95a2\u9023\u306e\u30a8\u30e9\u30fc",children:"5.5 RLS\u95a2\u9023\u306e\u30a8\u30e9\u30fc"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"-- \u30e6\u30fc\u30b6\u30fc\u5b58\u5728\u78ba\u8a8d\nSELECT usename, usesuper, usecreatedb\nFROM pg_user\nWHERE usename IN ('idp_admin_user', 'idp_app_user');\n\n-- \u30e6\u30fc\u30b6\u30fc\u6a29\u9650\u78ba\u8a8d\nSELECT grantee, table_name, privilege_type\nFROM information_schema.table_privileges\nWHERE grantee IN ('idp_admin_user', 'idp_app_user')\nORDER BY grantee, table_name;\n"})}),"\n",(0,l.jsx)(n.h3,{id:"56-\u63a5\u7d9a\u72b6\u6cc1\u78ba\u8a8d",children:"5.6 \u63a5\u7d9a\u72b6\u6cc1\u78ba\u8a8d"}),"\n",(0,l.jsx)(n.pre,{children:(0,l.jsx)(n.code,{className:"language-sql",children:"SELECT\n  datname,\n  usename,\n  client_addr,\n  state,\n  query_start\nFROM pg_stat_activity\nWHERE datname = 'idpserver'\nORDER BY query_start DESC;\n"})}),"\n",(0,l.jsx)(n.hr,{}),"\n",(0,l.jsx)(n.h2,{id:"6-\u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8",children:"6. \u95a2\u9023\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8"}),"\n",(0,l.jsxs)(n.ul,{children:["\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"/idp-server/docs/content_08_ops/commercial-deployment/overview",children:"\u30c7\u30d7\u30ed\u30a4\u6982\u8981"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"/idp-server/docs/content_08_ops/commercial-deployment/environment-variables",children:"\u74b0\u5883\u5909\u6570\u8a2d\u5b9a"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"/idp-server/docs/content_08_ops/commercial-deployment/initial-configuration",children:"\u521d\u671f\u8a2d\u5b9a\u30fb\u30e6\u30fc\u30b6\u30fc\u30fb\u30ed\u30fc\u30eb"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"/idp-server/docs/content_08_ops/commercial-deployment/operational-guidance",children:"\u904b\u7528\u30ac\u30a4\u30c0\u30f3\u30b9"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"/idp-server/docs/content_06_developer-guide/reference/database-partitioning-guide",children:"\u30d1\u30fc\u30c6\u30a3\u30b7\u30e7\u30cb\u30f3\u30b0\u30ac\u30a4\u30c9"})}),"\n",(0,l.jsx)(n.li,{children:(0,l.jsx)(n.a,{href:"/idp-server/docs/content_06_developer-guide/reference/security-event-archive-guide",children:"\u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30a4\u30d9\u30f3\u30c8\u30a2\u30fc\u30ab\u30a4\u30d6\u30ac\u30a4\u30c9"})}),"\n"]})]})}function o(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,l.jsx)(n,{...e,children:(0,l.jsx)(p,{...e})}):p(e)}},28453:(e,n,s)=>{s.d(n,{R:()=>a,x:()=>d});var r=s(96540);const l={},i=r.createContext(l);function a(e){const n=r.useContext(i);return r.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function d(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:a(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);