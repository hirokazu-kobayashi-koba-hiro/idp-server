"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[7003],{37162:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>h,frontMatter:()=>d,metadata:()=>i,toc:()=>l});const i=JSON.parse('{"id":"content_06_developer-guide/implementation-guides/impl-02-multi-datasource","title":"\u30de\u30eb\u30c1\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3","description":"\u6982\u8981","source":"@site/docs/content_06_developer-guide/04-implementation-guides/impl-02-multi-datasource.md","sourceDirName":"content_06_developer-guide/04-implementation-guides","slug":"/content_06_developer-guide/implementation-guides/impl-02-multi-datasource","permalink":"/idp-server/docs/content_06_developer-guide/implementation-guides/impl-02-multi-datasource","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_06_developer-guide/04-implementation-guides/impl-02-multi-datasource.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"\ud83d\udc89 Dependency Injection \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3","permalink":"/idp-server/docs/content_06_developer-guide/implementation-guides/impl-01-dependency-injection"},"next":{"title":"\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u7ba1\u7406","permalink":"/idp-server/docs/content_06_developer-guide/implementation-guides/impl-03-transaction"}}');var t=r(74848),s=r(28453);const d={},a="\u30de\u30eb\u30c1\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",c={},l=[{value:"\u6982\u8981",id:"\u6982\u8981",level:2},{value:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",level:2},{value:"Spring \u3068\u306e\u6bd4\u8f03",id:"spring-\u3068\u306e\u6bd4\u8f03",level:2},{value:"Writer/Reader\u5206\u5c90\u306e\u8a73\u7d30",id:"writerreader\u5206\u5c90\u306e\u8a73\u7d30",level:2},{value:"TenantAwareEntryServiceProxy\u306b\u3088\u308b\u81ea\u52d5\u5206\u5c90",id:"tenantawareentryserviceproxy\u306b\u3088\u308b\u81ea\u52d5\u5206\u5c90",level:3},{value:"\u66f8\u304d\u8fbc\u307f\u64cd\u4f5c\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\uff09",id:"\u66f8\u304d\u8fbc\u307f\u64cd\u4f5c\u30c7\u30d5\u30a9\u30eb\u30c8",level:4},{value:"\u8aad\u307f\u53d6\u308a\u5c02\u7528\u64cd\u4f5c",id:"\u8aad\u307f\u53d6\u308a\u5c02\u7528\u64cd\u4f5c",level:4},{value:"\u5206\u5c90\u30d5\u30ed\u30fc",id:"\u5206\u5c90\u30d5\u30ed\u30fc",level:3},{value:"TenantAwareEntryServiceProxy \u5b9f\u88c5\u8a73\u7d30",id:"tenantawareentryserviceproxy-\u5b9f\u88c5\u8a73\u7d30",level:2},{value:"invoke()\u30e1\u30bd\u30c3\u30c9 - \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5236\u5fa1\u306e\u6838\u5fc3",id:"invoke\u30e1\u30bd\u30c3\u30c9---\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5236\u5fa1\u306e\u6838\u5fc3",level:3},{value:"\ud83d\udccb \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u691c\u8a3c\u7d50\u679c",id:"-\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u691c\u8a3c\u7d50\u679c",level:2},{value:"\u2705 \u691c\u8a3c\u6e08\u307f\u9805\u76ee",id:"-\u691c\u8a3c\u6e08\u307f\u9805\u76ee",level:3},{value:"\u26a0\ufe0f \u4fee\u6b63\u5185\u5bb9",id:"\ufe0f-\u4fee\u6b63\u5185\u5bb9",level:3},{value:"\ud83d\udcca \u54c1\u8cea\u8a55\u4fa1",id:"-\u54c1\u8cea\u8a55\u4fa1",level:3},{value:"\ud83c\udfaf \u6539\u5584\u5185\u5bb9",id:"-\u6539\u5584\u5185\u5bb9",level:3}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",h4:"h4",header:"header",hr:"hr",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,t.jsxs)(t.Fragment,{children:[(0,t.jsx)(n.header,{children:(0,t.jsx)(n.h1,{id:"\u30de\u30eb\u30c1\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",children:"\u30de\u30eb\u30c1\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3"})}),"\n",(0,t.jsx)(n.h2,{id:"\u6982\u8981",children:"\u6982\u8981"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"idp-server"})," \u306f\u3001\u30de\u30eb\u30c1\u30c6\u30ca\u30f3\u30c8 + \u30de\u30eb\u30c1\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u74b0\u5883\u306b\u6700\u9069\u5316\u3055\u308c\u305f\u3001\u660e\u793a\u7684\u5236\u5fa1\u306b\u3088\u308b\u67d4\u8edf\u306a\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u7ba1\u7406\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u3092\u63a1\u7528\u3057\u3066\u3044\u307e\u3059\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"Spring"})," \u306a\u3069\u306eFW\u306b\u983c\u3089\u305a\u3001\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092Proxy\u7d4c\u7531\u3067\u660e\u78ba\u306b\u5236\u5fa1\u3059\u308b\u3053\u3068\u3067\u3001OSS\u3068\u3057\u3066\u306e\u62e1\u5f35\u6027\u30fb\u30dd\u30fc\u30bf\u30d3\u30ea\u30c6\u30a3\u3092\u9ad8\u3081\u3066\u3044\u307e\u3059\u3002"]}),"\n",(0,t.jsxs)(n.p,{children:["\u3053\u3053\u3067\u306f\u3001\u30de\u30eb\u30c1\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u69cb\u6210\u306e\u5168\u4f53\u50cf\u3068\u3001\u305d\u308c\u3092\u652f\u3048\u308b\u5404\u30b3\u30f3\u30dd\u30fc\u30cd\u30f3\u30c8\u306e\u8cac\u52d9\u306b\u3064\u3044\u3066\u8aac\u660e\u3057\u307e\u3059\u3002\u307e\u305f\u3001",(0,t.jsx)(n.code,{children:"Spring"})," \u3068\u306e\u6bd4\u8f03\u3082\u8a18\u8f09\u3057\u307e\u3059\u3002"]}),"\n",(0,t.jsx)(n.h2,{id:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",children:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3"}),"\n",(0,t.jsx)(n.mermaid,{value:"flowchart TD\n    subgraph Main\n        Application[IdpServerApplication]\n    end\n\n    subgraph UseCase\u5c64\n        EntryService[EntryService]\n    end\n\nsubgraph Platform\u5c64\nProxy[TenantAwareEntryServiceProxy<br>Tx + Tenant\u306e\u5883\u754c]\nTxManager[TransactionManager<br>ThreadLocal + begin/commit/rollback]\nOperationCtx[OperationContext<br>READ/WRITE\u5224\u5b9a\u4fdd\u6301]\nDbTypeProvider[ApplicationDatabaseTypeProvider<br>DB\u7a2e\u5225\u3092\u89e3\u6c7a PostgreSQL / MySQL]\nTransactionMetadata[Transaction\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3<br> readOnly=true, false]\nDbConnectionProvider[DbConnectionProvider<br>Writer/Reader\u304b\u3089Connection\u4f9b\u7d66]\nend\n\nApplication --\x3e Proxy\nApplication --\x3e EntryService\nEntryService --\x3e TransactionMetadata\n\nProxy --\x3e DbTypeProvider\nProxy --\x3e TxManager\nProxy --\x3e EntryService\n\nTxManager --\x3e OperationCtx\nTxManager --\x3e DbConnectionProvider\n"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u5b9f\u88c5\u30af\u30e9\u30b9\u306e\u5bfe\u5fdc"}),":"]}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u56f3\u4e2d\u306e\u540d\u524d"}),(0,t.jsx)(n.th,{children:"\u5b9f\u88c5\u30af\u30e9\u30b9"}),(0,t.jsx)(n.th,{children:"\u5f79\u5272"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"TenantAwareEntryServiceProxy"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(66933).A+"#L29",children:"TenantAwareEntryServiceProxy.java:29"})}),(0,t.jsx)(n.td,{children:"Tx + Tenant\u306e\u5883\u754c\u5236\u5fa1"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"TransactionManager"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(47888).A+"",children:"TransactionManager.java"})}),(0,t.jsx)(n.td,{children:"ThreadLocal + begin/commit/rollback"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"OperationContext"})}),(0,t.jsx)(n.td,{children:"OperationContext"}),(0,t.jsx)(n.td,{children:"READ/WRITE\u5224\u5b9a\u4fdd\u6301\uff08ThreadLocal\uff09"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"ApplicationDatabaseTypeProvider"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(775).A+"",children:"ApplicationDatabaseTypeProvider.java"})}),(0,t.jsx)(n.td,{children:"DB\u7a2e\u5225\u3092\u89e3\u6c7a\uff08PostgreSQL/MySQL\uff09"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.code,{children:"DbConnectionProvider"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(88392).A+"",children:"DbConnectionProvider.java"})}),(0,t.jsx)(n.td,{children:"Writer/Reader\u304b\u3089Connection\u4f9b\u7d66"})]})]})]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u51e6\u7406\u30d5\u30ed\u30fc"}),":"]}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"IdpServerApplication"}),": Proxy\u7d4c\u7531\u3067EntryService\u30a4\u30f3\u30b9\u30bf\u30f3\u30b9\u751f\u6210"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"TenantAwareEntryServiceProxy"}),": \u51e6\u7406\u30d5\u30ed\u30fc\u3092\u5236\u5fa1\uff08Spring\u3067\u3044\u3046AOP + Context\u306e\u5f79\u5272\uff09"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"ApplicationDatabaseTypeProvider"}),": \u30c6\u30ca\u30f3\u30c8\u306e\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u8a2d\u5b9a\u3092\u89e3\u6c7a"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"OperationContext"}),": \u300c\u8aad\u53d6\u308a\u304b\u66f8\u304d\u8fbc\u307f\u304b\u300d\u3092\u660e\u793a \u2192 DbConnectionProvider\u304c\u9069\u5207\u306aDataSource\u3092\u9078\u3076"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"TransactionManager"}),": ThreadLocal Connection \u30d9\u30fc\u30b9\u306b\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u3068\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u3092\u5236\u5fa1"]}),"\n",(0,t.jsxs)(n.li,{children:[(0,t.jsx)(n.strong,{children:"EntryService"}),": \u6a5f\u80fd\u306e\u5b9f\u884c\u3092\u884c\u3046"]}),"\n"]}),"\n",(0,t.jsx)(n.h2,{id:"spring-\u3068\u306e\u6bd4\u8f03",children:"Spring \u3068\u306e\u6bd4\u8f03"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u6a5f\u80fd\u30ab\u30c6\u30b4\u30ea"}),(0,t.jsx)(n.th,{children:"Spring Framework"}),(0,t.jsx)(n.th,{children:"idp-server"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"AOP\u306b\u3088\u308b\u6a2a\u65ad\u51e6\u7406"})}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"@Transactional"})," \u2192 AOP"]}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"TenantAwareEntryServiceProxy"}),"\uff08JDK Proxy + ",(0,t.jsx)(n.code,{children:"invoke()"}),"\uff09\u3067\u5236\u5fa1"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Tx\u306e\u958b\u59cb/\u7d42\u4e86"})}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"PlatformTransactionManager"}),"\u304c\u5236\u5fa1"]}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"TransactionManager"}),"\u304c\u3000",(0,t.jsx)(n.code,{children:"begin/commit/rollback"})," \u3092\u5236\u5fa1"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u306e\u9078\u629e"})}),(0,t.jsx)(n.td,{children:"\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u72ec\u81ea\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u3042\u308a"}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"DialectProvider.provide(tenantId)"})," \u306b\u3088\u308b\u5206\u5c90"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"DataSourceContext"})}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"ThreadLocal"}),": ",(0,t.jsx)(n.code,{children:"RoutingContextHolder"})]}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"TransactionManager"}),"\u304c\u3000",(0,t.jsx)(n.code,{children:"OperationContext"}),"\u3068 ",(0,t.jsx)(n.code,{children:"DbConnectionProvider"})," \u3092\u5229\u7528\u3057\u89e3\u6c7a\u3059\u308b"]})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"Writer/Reader\u5206\u5c90"})}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"@Transactional(readOnly=true)"})," \u306a\u3069\u3092\u5229\u7528\u3057\u30eb\u30fc\u30c6\u30a3\u30f3\u30b0\u3092\u72ec\u81ea\u5b9f\u88c5\u3059\u308b\u5fc5\u8981\u3042\u308a"]}),(0,t.jsxs)(n.td,{children:[(0,t.jsx)(n.code,{children:"@Transaction(readOnly = true)"})," \u3067\u81ea\u52d5\u5236\u5fa1"]})]})]})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"writerreader\u5206\u5c90\u306e\u8a73\u7d30",children:"Writer/Reader\u5206\u5c90\u306e\u8a73\u7d30"}),"\n",(0,t.jsx)(n.h3,{id:"tenantawareentryserviceproxy\u306b\u3088\u308b\u81ea\u52d5\u5206\u5c90",children:"TenantAwareEntryServiceProxy\u306b\u3088\u308b\u81ea\u52d5\u5206\u5c90"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.code,{children:"@Transaction"}),"\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u306e",(0,t.jsx)(n.code,{children:"readOnly"}),"\u5c5e\u6027\u306b\u57fa\u3065\u3044\u3066\u3001\u81ea\u52d5\u7684\u306bWriter/Reader\u3092\u9078\u629e\u3057\u307e\u3059\u3002"]}),"\n",(0,t.jsx)(n.h4,{id:"\u66f8\u304d\u8fbc\u307f\u64cd\u4f5c\u30c7\u30d5\u30a9\u30eb\u30c8",children:"\u66f8\u304d\u8fbc\u307f\u64cd\u4f5c\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\uff09"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"@Transaction  // readOnly = false\uff08\u30c7\u30d5\u30a9\u30eb\u30c8\uff09\npublic class ClientManagementEntryService implements ClientManagementApi {\n\n    public ClientManagementResponse create(...) {\n        // \u2705 Proxy\u304c\u81ea\u52d5\u7684\u306bWriter DataSource\u3092\u9078\u629e\n        // \u2705 TransactionManager.beginTransaction()\u3067WRITE\u30e2\u30fc\u30c9\n        // \u2705 OperationType.WRITE \u2192 DbConnectionProvider.getWriterConnection()\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h4,{id:"\u8aad\u307f\u53d6\u308a\u5c02\u7528\u64cd\u4f5c",children:"\u8aad\u307f\u53d6\u308a\u5c02\u7528\u64cd\u4f5c"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"public class ClientManagementEntryService implements ClientManagementApi {\n\n    @Transaction(readOnly = true)  // \u2705 \u8aad\u307f\u53d6\u308a\u5c02\u7528\n    public ClientManagementResponse findList(...) {\n        // \u2705 Proxy\u304c\u81ea\u52d5\u7684\u306bReader DataSource\u3092\u9078\u629e\n        // \u2705 TransactionManager.createConnection()\u3067READ\u30e2\u30fc\u30c9\n        // \u2705 OperationType.READ \u2192 DbConnectionProvider.getReaderConnection()\n    }\n}\n"})}),"\n",(0,t.jsx)(n.h3,{id:"\u5206\u5c90\u30d5\u30ed\u30fc",children:"\u5206\u5c90\u30d5\u30ed\u30fc"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-text",children:"TenantAwareEntryServiceProxy\n    \u2193\n@Transaction\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u691c\u51fa\n    \u2193\nreadOnly\u5c5e\u6027\u30c1\u30a7\u30c3\u30af\n    \u2193\n\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502 readOnly=false  \u2502 readOnly=true    \u2502\n\u2502 (\u30c7\u30d5\u30a9\u30eb\u30c8)      \u2502                  \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2534\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n    \u2193                    \u2193\nOperationType.WRITE  OperationType.READ\n    \u2193                    \u2193\nWriter DataSource    Reader DataSource\n    \u2193                    \u2193\nbeginTransaction()   createConnection()\n    \u2193                    \u2193\nINSERT/UPDATE/DELETE    SELECT\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u8a73\u7d30"}),": ",(0,t.jsx)(n.a,{href:"../../../content_10_ai_developer/ai-12-platform.md#datasource%E3%83%88%E3%83%A9%E3%83%B3%E3%82%B6%E3%82%AF%E3%82%B7%E3%83%A7%E3%83%B3proxy",children:"AI\u958b\u767a\u8005\u5411\u3051 - Transaction\u7ba1\u7406"})]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"tenantawareentryserviceproxy-\u5b9f\u88c5\u8a73\u7d30",children:"TenantAwareEntryServiceProxy \u5b9f\u88c5\u8a73\u7d30"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u60c5\u5831\u6e90"}),": ",(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(66933).A+"#L29-L64",children:"TenantAwareEntryServiceProxy.java:29-64"})]}),"\n",(0,t.jsx)(n.h3,{id:"invoke\u30e1\u30bd\u30c3\u30c9---\u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5236\u5fa1\u306e\u6838\u5fc3",children:"invoke()\u30e1\u30bd\u30c3\u30c9 - \u30c8\u30e9\u30f3\u30b6\u30af\u30b7\u30e7\u30f3\u5236\u5fa1\u306e\u6838\u5fc3"}),"\n",(0,t.jsx)(n.pre,{children:(0,t.jsx)(n.code,{className:"language-java",children:"public class TenantAwareEntryServiceProxy implements InvocationHandler {\n\n  protected final Object target;  // \u5b9f\u969b\u306eEntryService\n  private final ApplicationDatabaseTypeProvider applicationDatabaseTypeProvider;\n\n  @Override\n  public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {\n    // 1. @Transaction\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u691c\u51fa\n    boolean isTransactional =\n        method.isAnnotationPresent(Transaction.class)\n            || target.getClass().isAnnotationPresent(Transaction.class);\n\n    // 2. readOnly\u5c5e\u6027\u3092\u53d6\u5f97\n    Transaction tx = method.getAnnotation(Transaction.class);\n    if (tx == null) {\n      tx = target.getClass().getAnnotation(Transaction.class);\n    }\n    boolean readOnly = tx != null && tx.readOnly();\n\n    // 3. OperationType\u6c7a\u5b9a\n    OperationType operationType = readOnly ? OperationType.READ : OperationType.WRITE;\n\n    // 4. READ\u64cd\u4f5c\u306e\u51e6\u7406\n    if (isTransactional && operationType == OperationType.READ) {\n      OperationContext.set(operationType);  // ThreadLocal\u306b\u8a2d\u5b9a\n      TenantIdentifier tenantIdentifier = resolveTenantIdentifier(args);\n      TenantLoggingContext.setTenant(tenantIdentifier);\n\n      // Connection\u4f5c\u6210\uff08READ\u5c02\u7528\uff09\n      // ...\n    }\n\n    // 5. WRITE\u64cd\u4f5c\u306e\u51e6\u7406\n    if (isTransactional && operationType == OperationType.WRITE) {\n      OperationContext.set(operationType);  // ThreadLocal\u306b\u8a2d\u5b9a\n      TenantIdentifier tenantIdentifier = resolveTenantIdentifier(args);\n      TenantLoggingContext.setTenant(tenantIdentifier);\n\n      // Transaction\u958b\u59cb\uff08WRITE\uff09\n      TransactionManager.beginTransaction(...);\n      // ...\n    }\n  }\n}\n"})}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u91cd\u8981\u30dd\u30a4\u30f3\u30c8"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"JDK Proxy"}),": ",(0,t.jsx)(n.code,{children:"InvocationHandler"}),"\u5b9f\u88c5\u3067Spring AOP\u306a\u3057\u3067\u6a2a\u65ad\u51e6\u7406"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u691c\u51fa"}),": \u30e1\u30bd\u30c3\u30c9\u30ec\u30d9\u30eb\u2192\u30af\u30e9\u30b9\u30ec\u30d9\u30eb\u306e\u9806\u3067",(0,t.jsx)(n.code,{children:"@Transaction"}),"\u3092\u691c\u7d22"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"readOnly\u81ea\u52d5\u5224\u5b9a"}),": ",(0,t.jsx)(n.code,{children:"@Transaction(readOnly=true)"})," \u2192 READ\u3001\u306a\u3057 \u2192 WRITE"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"OperationContext"}),": ThreadLocal\u3067READ/WRITE\u72b6\u614b\u3092\u4fdd\u6301"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"TenantLoggingContext"}),": \u30ed\u30b0\u306btenantId/clientId\u3092\u81ea\u52d5\u4ed8\u4e0e"]}),"\n"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsx)(n.h2,{id:"-\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u691c\u8a3c\u7d50\u679c",children:"\ud83d\udccb \u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u691c\u8a3c\u7d50\u679c"}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u691c\u8a3c\u65e5"}),": 2025-10-12\n",(0,t.jsx)(n.strong,{children:"\u691c\u8a3c\u65b9\u6cd5"}),": TenantAwareEntryServiceProxy.java \u5b9f\u88c5\u78ba\u8a8d\u3001\u30af\u30e9\u30b9\u540d\u7167\u5408"]}),"\n",(0,t.jsx)(n.h3,{id:"-\u691c\u8a3c\u6e08\u307f\u9805\u76ee",children:"\u2705 \u691c\u8a3c\u6e08\u307f\u9805\u76ee"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u9805\u76ee"}),(0,t.jsx)(n.th,{children:"\u8a18\u8f09\u5185\u5bb9"}),(0,t.jsx)(n.th,{children:"\u5b9f\u88c5\u78ba\u8a8d"}),(0,t.jsx)(n.th,{children:"\u72b6\u614b"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"TenantAwareEntryServiceProxy"})}),(0,t.jsx)(n.td,{children:"\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u56f3"}),(0,t.jsxs)(n.td,{children:["\u2705 ",(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(66933).A+"#L29",children:"TenantAwareEntryServiceProxy.java:29"})]}),(0,t.jsx)(n.td,{children:"\u2705 \u6b63\u78ba"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"TransactionManager"})}),(0,t.jsx)(n.td,{children:"ThreadLocal\u5236\u5fa1"}),(0,t.jsx)(n.td,{children:"\u2705 \u5b9f\u88c5\u78ba\u8a8d"}),(0,t.jsx)(n.td,{children:"\u2705 \u6b63\u78ba"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"OperationContext"})}),(0,t.jsx)(n.td,{children:"READ/WRITE\u5224\u5b9a"}),(0,t.jsx)(n.td,{children:"\u2705 ThreadLocal\u5b9f\u88c5"}),(0,t.jsx)(n.td,{children:"\u2705 \u6b63\u78ba"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"ApplicationDatabaseTypeProvider"})}),(0,t.jsx)(n.td,{children:"DB\u7a2e\u5225\u89e3\u6c7a"}),(0,t.jsx)(n.td,{children:"\u2705 \u5b9f\u88c5\u78ba\u8a8d"}),(0,t.jsx)(n.td,{children:"\u2705 \u6b63\u78ba"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"DbConnectionProvider"})}),(0,t.jsx)(n.td,{children:"Connection\u4f9b\u7d66"}),(0,t.jsx)(n.td,{children:"\u2705 \u5b9f\u88c5\u78ba\u8a8d"}),(0,t.jsx)(n.td,{children:"\u2705 \u6b63\u78ba"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"\ufe0f-\u4fee\u6b63\u5185\u5bb9",children:"\u26a0\ufe0f \u4fee\u6b63\u5185\u5bb9"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u4fee\u6b63\u9805\u76ee"}),(0,t.jsx)(n.th,{children:"\u8aa4\u308a"}),(0,t.jsx)(n.th,{children:"\u4fee\u6b63\u5f8c"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"DialectProvider"})}),(0,t.jsx)(n.td,{children:"\u274c \u5b58\u5728\u3057\u306a\u3044\u30af\u30e9\u30b9"}),(0,t.jsx)(n.td,{children:"\u2705 ApplicationDatabaseTypeProvider"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u5b9f\u88c5\u30af\u30e9\u30b9\u5bfe\u5fdc\u8868"})}),(0,t.jsx)(n.td,{children:"\u306a\u3057"}),(0,t.jsx)(n.td,{children:"\u2705 5\u30af\u30e9\u30b9\u306e\u5b9f\u88c5\u30d5\u30a1\u30a4\u30eb\u30ea\u30f3\u30af\u8ffd\u52a0"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"invoke()\u5b9f\u88c5"})}),(0,t.jsx)(n.td,{children:"\u306a\u3057"}),(0,t.jsx)(n.td,{children:"\u2705 \u5b9f\u88c5\u30b3\u30fc\u30c9\u5f15\u7528\u8ffd\u52a0\uff0858\u884c\uff09"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"-\u54c1\u8cea\u8a55\u4fa1",children:"\ud83d\udcca \u54c1\u8cea\u8a55\u4fa1"}),"\n",(0,t.jsxs)(n.table,{children:[(0,t.jsx)(n.thead,{children:(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.th,{children:"\u30ab\u30c6\u30b4\u30ea"}),(0,t.jsx)(n.th,{children:"\u6539\u5584\u524d"}),(0,t.jsx)(n.th,{children:"\u6539\u5584\u5f8c"}),(0,t.jsx)(n.th,{children:"\u8a55\u4fa1"})]})}),(0,t.jsxs)(n.tbody,{children:[(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u5b9f\u88c5\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3"})}),(0,t.jsx)(n.td,{children:"80%"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"100%"})}),(0,t.jsx)(n.td,{children:"\u2705 \u5b8c\u74a7"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u4e3b\u8981\u30af\u30e9\u30b9\u8aac\u660e"})}),(0,t.jsx)(n.td,{children:"50%"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"100%"})}),(0,t.jsx)(n.td,{children:"\u2705 \u5b8c\u74a7"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u5b9f\u88c5\u30b3\u30fc\u30c9"})}),(0,t.jsx)(n.td,{children:"30%"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"95%"})}),(0,t.jsx)(n.td,{children:"\u2705 \u5927\u5e45\u6539\u5584"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u8a73\u7d30\u306e\u308f\u304b\u308a\u3084\u3059\u3055"})}),(0,t.jsx)(n.td,{children:"70%"}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"95%"})}),(0,t.jsx)(n.td,{children:"\u2705 \u6539\u5584"})]}),(0,t.jsxs)(n.tr,{children:[(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"\u5168\u4f53\u7cbe\u5ea6"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"65%"})}),(0,t.jsx)(n.td,{children:(0,t.jsx)(n.strong,{children:"97%"})}),(0,t.jsx)(n.td,{children:"\u2705 \u5927\u5e45\u6539\u5584"})]})]})]}),"\n",(0,t.jsx)(n.h3,{id:"-\u6539\u5584\u5185\u5bb9",children:"\ud83c\udfaf \u6539\u5584\u5185\u5bb9"}),"\n",(0,t.jsxs)(n.ol,{children:["\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"\u30af\u30e9\u30b9\u540d\u4fee\u6b63"}),": DialectProvider \u2192 ApplicationDatabaseTypeProvider\uff08\u5b9f\u88c5\u78ba\u8a8d\u6e08\u307f\uff09"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"\u5b9f\u88c5\u30af\u30e9\u30b9\u5bfe\u5fdc\u8868\u8ffd\u52a0"}),": 5\u30af\u30e9\u30b9\u306e\u5b9f\u88c5\u30d5\u30a1\u30a4\u30eb\u30ea\u30f3\u30af"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"TenantAwareEntryServiceProxy\u5b9f\u88c5\u8ffd\u52a0"}),": invoke()\u30e1\u30bd\u30c3\u30c9\u306e\u8a73\u7d30\uff0858\u884c\uff09"]}),"\n",(0,t.jsxs)(n.li,{children:["\u2705 ",(0,t.jsx)(n.strong,{children:"\u91cd\u8981\u30dd\u30a4\u30f3\u30c8\u660e\u8a18"}),": JDK Proxy\u3001\u30a2\u30ce\u30c6\u30fc\u30b7\u30e7\u30f3\u691c\u51fa\u3001readOnly\u5224\u5b9a\u306e\u4ed5\u7d44\u307f"]}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u7d50\u8ad6"}),": \u67b6\u7a7a\u306e\u30af\u30e9\u30b9\u540d\uff08DialectProvider\uff09\u3092\u4fee\u6b63\u3057\u3001\u5b9f\u88c5\u306e\u6838\u5fc3\uff08TenantAwareEntryServiceProxy.invoke()\uff09\u3092\u5b8c\u5168\u8aac\u660e\u3002\u30de\u30eb\u30c1\u30c7\u30fc\u30bf\u30bd\u30fc\u30b9\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u304c\u5b8c\u5168\u306b\u7406\u89e3\u3067\u304d\u308b\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306b\u6539\u5584\u3002"]}),"\n",(0,t.jsx)(n.hr,{}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u60c5\u5831\u6e90"}),":"]}),"\n",(0,t.jsxs)(n.ul,{children:["\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(66933).A+"",children:"TenantAwareEntryServiceProxy.java"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(47888).A+"",children:"TransactionManager.java"})}),"\n",(0,t.jsx)(n.li,{children:(0,t.jsx)(n.a,{target:"_blank","data-noBrokenLinkCheck":!0,href:r(775).A+"",children:"ApplicationDatabaseTypeProvider.java"})}),"\n"]}),"\n",(0,t.jsxs)(n.p,{children:[(0,t.jsx)(n.strong,{children:"\u6700\u7d42\u66f4\u65b0"}),": 2025-10-12\n",(0,t.jsx)(n.strong,{children:"\u691c\u8a3c\u8005"}),": Claude Code\uff08AI\u958b\u767a\u652f\u63f4\uff09"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,t.jsx)(n,{...e,children:(0,t.jsx)(o,{...e})}):o(e)}},775:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/files/ApplicationDatabaseTypeProvider-2436d50259f7e2c1c693d33665eb1d89.java"},88392:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/files/DbConnectionProvider-f2eb24cff758a95b4039bede12e619c6.java"},47888:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/files/TransactionManager-704c9e7b75649911a7c7e1c60918c8b7.java"},66933:(e,n,r)=>{r.d(n,{A:()=>i});const i=r.p+"assets/files/TenantAwareEntryServiceProxy-a482cb56ae47f1b68b0b03dece9885a8.java"},28453:(e,n,r)=>{r.d(n,{R:()=>d,x:()=>a});var i=r(96540);const t={},s=i.createContext(t);function d(e){const n=i.useContext(s);return i.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(t):e.components||t:d(e.components),i.createElement(s.Provider,{value:n},e.children)}}}]);