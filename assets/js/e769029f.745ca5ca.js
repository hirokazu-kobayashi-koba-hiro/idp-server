"use strict";(self.webpackChunkdocumentation=self.webpackChunkdocumentation||[]).push([[8579],{77588:(n,e,r)=>{r.r(e),r.d(e,{assets:()=>o,contentTitle:()=>t,default:()=>p,frontMatter:()=>i,metadata:()=>s,toc:()=>c});const s=JSON.parse('{"id":"content_11_learning/postgresql/dba-03-replication-ha","title":"PostgreSQL \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068HA\u69cb\u6210\u30ac\u30a4\u30c9","description":"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001PostgreSQL\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u9ad8\u53ef\u7528\u6027\uff08HA\uff09\u69cb\u6210\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002","source":"@site/docs/content_11_learning/11-postgresql/dba-03-replication-ha.md","sourceDirName":"content_11_learning/11-postgresql","slug":"/content_11_learning/postgresql/dba-03-replication-ha","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-03-replication-ha","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/content_11_learning/11-postgresql/dba-03-replication-ha.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"PostgreSQL \u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3068\u30ea\u30ab\u30d0\u30ea\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-02-backup-recovery"},"next":{"title":"PostgreSQL \u30bb\u30ad\u30e5\u30ea\u30c6\u30a3\u30ac\u30a4\u30c9","permalink":"/idp-server/docs/content_11_learning/postgresql/dba-04-security"}}');var a=r(74848),l=r(28453);const i={},t="PostgreSQL \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068HA\u69cb\u6210\u30ac\u30a4\u30c9",o={},c=[{value:"\u76ee\u6b21",id:"\u76ee\u6b21",level:2},{value:"1. \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u8981",id:"1-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u8981",level:2},{value:"1.1 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u76ee\u7684",id:"11-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u76ee\u7684",level:3},{value:"1.2 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u65b9\u5f0f\u306e\u6bd4\u8f03",id:"12-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u65b9\u5f0f\u306e\u6bd4\u8f03",level:3},{value:"2. \u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",id:"2-\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",level:2},{value:"2.1 \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",id:"21-\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",level:3},{value:"2.2 \u30d7\u30e9\u30a4\u30de\u30ea\u306e\u8a2d\u5b9a",id:"22-\u30d7\u30e9\u30a4\u30de\u30ea\u306e\u8a2d\u5b9a",level:3},{value:"2.3 \u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u69cb\u7bc9",id:"23-\u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u69cb\u7bc9",level:3},{value:"2.4 \u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u8a2d\u5b9a",id:"24-\u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u8a2d\u5b9a",level:3},{value:"2.5 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u306e\u78ba\u8a8d",id:"25-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u306e\u78ba\u8a8d",level:3},{value:"2.6 \u30ab\u30b9\u30b1\u30fc\u30c9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",id:"26-\u30ab\u30b9\u30b1\u30fc\u30c9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",level:3},{value:"3. \u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",id:"3-\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",level:2},{value:"3.1 \u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u5ff5",id:"31-\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u5ff5",level:3},{value:"3.2 \u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a",id:"32-\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a",level:3},{value:"3.3 synchronous_commit \u306e\u30ec\u30d9\u30eb",id:"33-synchronous_commit-\u306e\u30ec\u30d9\u30eb",level:3},{value:"3.4 \u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u72b6\u614b\u78ba\u8a8d",id:"34-\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u72b6\u614b\u78ba\u8a8d",level:3},{value:"4. \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",id:"4-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",level:2},{value:"4.1 \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u5ff5",id:"41-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u5ff5",level:3},{value:"4.2 Publisher (\u9001\u4fe1\u5074) \u306e\u8a2d\u5b9a",id:"42-publisher-\u9001\u4fe1\u5074-\u306e\u8a2d\u5b9a",level:3},{value:"4.3 Subscriber (\u53d7\u4fe1\u5074) \u306e\u8a2d\u5b9a",id:"43-subscriber-\u53d7\u4fe1\u5074-\u306e\u8a2d\u5b9a",level:3},{value:"4.4 \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u7ba1\u7406",id:"44-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u7ba1\u7406",level:3},{value:"4.5 \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u5236\u9650\u4e8b\u9805",id:"45-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u5236\u9650\u4e8b\u9805",level:3},{value:"5. \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8",id:"5-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8",level:2},{value:"5.1 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u306e\u5f79\u5272",id:"51-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u306e\u5f79\u5272",level:3},{value:"5.2 \u7269\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8",id:"52-\u7269\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8",level:3},{value:"5.3 \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8",id:"53-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8",level:3},{value:"5.4 \u30b9\u30ed\u30c3\u30c8\u306e\u76e3\u8996",id:"54-\u30b9\u30ed\u30c3\u30c8\u306e\u76e3\u8996",level:3},{value:"6. \u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc",id:"6-\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc",level:2},{value:"6.1 \u624b\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc",id:"61-\u624b\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc",level:3},{value:"6.2 pg_rewind \u306b\u3088\u308b\u518d\u69cb\u7bc9",id:"62-pg_rewind-\u306b\u3088\u308b\u518d\u69cb\u7bc9",level:3},{value:"7. Patroni\u306b\u3088\u308b\u81ea\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc",id:"7-patroni\u306b\u3088\u308b\u81ea\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc",level:2},{value:"7.1 Patroni\u306e\u6982\u8981",id:"71-patroni\u306e\u6982\u8981",level:3},{value:"7.2 Patroni\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",id:"72-patroni\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",level:3},{value:"7.3 Patroni\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb",id:"73-patroni\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb",level:3},{value:"7.4 Patroni\u306e\u64cd\u4f5c",id:"74-patroni\u306e\u64cd\u4f5c",level:3},{value:"7.5 HAProxy \u3068\u306e\u9023\u643a",id:"75-haproxy-\u3068\u306e\u9023\u643a",level:3},{value:"8. \u8aad\u307f\u53d6\u308a\u8ca0\u8377\u5206\u6563",id:"8-\u8aad\u307f\u53d6\u308a\u8ca0\u8377\u5206\u6563",level:2},{value:"8.1 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u3067\u306e\u5206\u6563",id:"81-\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u3067\u306e\u5206\u6563",level:3},{value:"8.2 PgBouncer\u306b\u3088\u308b\u8ca0\u8377\u5206\u6563",id:"82-pgbouncer\u306b\u3088\u308b\u8ca0\u8377\u5206\u6563",level:3},{value:"8.3 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e9\u30b0\u306e\u8003\u616e",id:"83-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e9\u30b0\u306e\u8003\u616e",level:3},{value:"\u53c2\u8003\u30ea\u30f3\u30af",id:"\u53c2\u8003\u30ea\u30f3\u30af",level:2}];function d(n){const e={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",hr:"hr",li:"li",ol:"ol",p:"p",pre:"pre",ul:"ul",...(0,l.R)(),...n.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(e.header,{children:(0,a.jsx)(e.h1,{id:"postgresql-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068ha\u69cb\u6210\u30ac\u30a4\u30c9",children:"PostgreSQL \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068HA\u69cb\u6210\u30ac\u30a4\u30c9"})}),"\n",(0,a.jsx)(e.p,{children:"\u3053\u306e\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u3067\u306f\u3001PostgreSQL\u306e\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3068\u9ad8\u53ef\u7528\u6027\uff08HA\uff09\u69cb\u6210\u3092\u89e3\u8aac\u3057\u307e\u3059\u3002"}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"\u76ee\u6b21",children:"\u76ee\u6b21"}),"\n",(0,a.jsxs)(e.ol,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#1-%E3%83%AC%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AE%E6%A6%82%E8%A6%81",children:"\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u8981"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#2-%E3%82%B9%E3%83%88%E3%83%AA%E3%83%BC%E3%83%9F%E3%83%B3%E3%82%B0%E3%83%AC%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3",children:"\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#3-%E5%90%8C%E6%9C%9F%E3%83%AC%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3",children:"\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#4-%E8%AB%96%E7%90%86%E3%83%AC%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3",children:"\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#5-%E3%83%AC%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%82%B9%E3%83%AD%E3%83%83%E3%83%88",children:"\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#6-%E3%83%95%E3%82%A7%E3%82%A4%E3%83%AB%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC",children:"\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#7-patroni%E3%81%AB%E3%82%88%E3%82%8B%E8%87%AA%E5%8B%95%E3%83%95%E3%82%A7%E3%82%A4%E3%83%AB%E3%82%AA%E3%83%BC%E3%83%90%E3%83%BC",children:"Patroni\u306b\u3088\u308b\u81ea\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"#8-%E8%AA%AD%E3%81%BF%E5%8F%96%E3%82%8A%E8%B2%A0%E8%8D%B7%E5%88%86%E6%95%A3",children:"\u8aad\u307f\u53d6\u308a\u8ca0\u8377\u5206\u6563"})}),"\n"]}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"1-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u8981",children:"1. \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u8981"}),"\n",(0,a.jsx)(e.h3,{id:"11-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u76ee\u7684",children:"1.1 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u76ee\u7684"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u76ee\u7684                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u9ad8\u53ef\u7528\u6027 (High Availability)\u3011                            \u2502\n\u2502  - \u30d7\u30e9\u30a4\u30de\u30ea\u969c\u5bb3\u6642\u306b\u30b9\u30bf\u30f3\u30d0\u30a4\u306b\u5207\u308a\u66ff\u3048                    \u2502\n\u2502  - \u30c0\u30a6\u30f3\u30bf\u30a4\u30e0\u306e\u6700\u5c0f\u5316                                      \u2502\n\u2502  - RPO (\u30c7\u30fc\u30bf\u640d\u5931) \u306e\u6700\u5c0f\u5316                                 \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u8aad\u307f\u53d6\u308a\u30b9\u30b1\u30fc\u30ea\u30f3\u30b0\u3011                                    \u2502\n\u2502  - \u8aad\u307f\u53d6\u308a\u30af\u30a8\u30ea\u3092\u30b9\u30bf\u30f3\u30d0\u30a4\u306b\u5206\u6563                          \u2502\n\u2502  - \u30d7\u30e9\u30a4\u30de\u30ea\u306e\u8ca0\u8377\u8efd\u6e1b                                      \u2502\n\u2502  - \u30ec\u30dd\u30fc\u30c8/\u5206\u6790\u30af\u30a8\u30ea\u306e\u5206\u96e2                                 \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u707d\u5bb3\u5bfe\u7b56 (Disaster Recovery)\u3011                            \u2502\n\u2502  - \u5730\u7406\u7684\u306b\u96e2\u308c\u305f\u5834\u6240\u306b\u30ec\u30d7\u30ea\u30ab\u3092\u914d\u7f6e                        \u2502\n\u2502  - \u30c7\u30fc\u30bf\u30bb\u30f3\u30bf\u30fc\u969c\u5bb3\u3078\u306e\u5bfe\u7b56                                \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30e1\u30f3\u30c6\u30ca\u30f3\u30b9\u3011                                            \u2502\n\u2502  - \u30ed\u30fc\u30ea\u30f3\u30b0\u30a2\u30c3\u30d7\u30b0\u30ec\u30fc\u30c9                                  \u2502\n\u2502  - \u30b9\u30bf\u30f3\u30d0\u30a4\u3067\u306e\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u53d6\u5f97                            \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"12-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u65b9\u5f0f\u306e\u6bd4\u8f03",children:"1.2 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u65b9\u5f0f\u306e\u6bd4\u8f03"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u65b9\u5f0f\u306e\u6bd4\u8f03                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3011(\u7269\u7406)                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 \u2705 WAL\u3092\u305d\u306e\u307e\u307e\u9001\u4fe1 \u2192 \u5b8c\u5168\u306a\u30ec\u30d7\u30ea\u30ab                \u2502   \u2502\n\u2502  \u2502 \u2705 \u8a2d\u5b9a\u304c\u6bd4\u8f03\u7684\u30b7\u30f3\u30d7\u30eb                               \u2502   \u2502\n\u2502  \u2502 \u2705 PITR\u3068\u7d44\u307f\u5408\u308f\u305b\u53ef\u80fd                               \u2502   \u2502\n\u2502  \u2502 \u274c \u30af\u30e9\u30b9\u30bf\u5168\u4f53\u306e\u8907\u88fd\u306e\u307f (\u30c6\u30fc\u30d6\u30eb\u5358\u4f4d\u4e0d\u53ef)         \u2502   \u2502\n\u2502  \u2502 \u274c \u540c\u4e00\u30e1\u30b8\u30e3\u30fc\u30d0\u30fc\u30b8\u30e7\u30f3\u9593\u306e\u307f                       \u2502   \u2502\n\u2502  \u2502 \u274c \u540c\u4e00\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3\u9593\u306e\u307f                           \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3011                                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 \u2705 \u30c6\u30fc\u30d6\u30eb/\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9\u5358\u4f4d\u3067\u9078\u629e\u53ef\u80fd               \u2502   \u2502\n\u2502  \u2502 \u2705 \u7570\u306a\u308b\u30e1\u30b8\u30e3\u30fc\u30d0\u30fc\u30b8\u30e7\u30f3\u9593\u3067\u53ef\u80fd                   \u2502   \u2502\n\u2502  \u2502 \u2705 \u30b5\u30d6\u30b9\u30af\u30e9\u30a4\u30d0\u30fc\u5074\u3067\u8ffd\u52a0\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u4f5c\u6210\u53ef\u80fd    \u2502   \u2502\n\u2502  \u2502 \u274c DDL\u306f\u8907\u88fd\u3055\u308c\u306a\u3044                                  \u2502   \u2502\n\u2502  \u2502 \u274c \u30b7\u30fc\u30b1\u30f3\u30b9\u3001\u30e9\u30fc\u30b8\u30aa\u30d6\u30b8\u30a7\u30af\u30c8\u306f\u8907\u88fd\u3055\u308c\u306a\u3044      \u2502   \u2502\n\u2502  \u2502 \u274c \u8a2d\u5b9a\u304c\u8907\u96d1                                         \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u9078\u629e\u306e\u6307\u91dd\u3011                                              \u2502\n\u2502  - HA/DR\u76ee\u7684 \u2192 \u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3               \u2502\n\u2502  - \u90e8\u5206\u7684\u306a\u8907\u88fd\u3001\u7570\u30d0\u30fc\u30b8\u30e7\u30f3\u9593 \u2192 \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3      \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"2-\u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",children:"2. \u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,a.jsx)(e.h3,{id:"21-\u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3",children:"2.1 \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502              \u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502   Primary                              Standby               \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510            \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502                     \u2502            \u2502                     \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502            \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502 \u2502\n\u2502  \u2502  \u2502   Backend     \u2502  \u2502            \u2502  \u2502  WAL Receiver \u2502  \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502            \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 \u2502\n\u2502  \u2502          \u2502 write    \u2502            \u2502          \u2502 apply    \u2502 \u2502\n\u2502  \u2502          \u25bc          \u2502            \u2502          \u25bc          \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502   WAL      \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502 \u2502\n\u2502  \u2502  \u2502    WAL        \u2502  \u2502  Stream    \u2502  \u2502    WAL        \u2502  \u2502 \u2502\n\u2502  \u2502  \u2502   Buffer      \u2502\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2192 \u2502  \u2502   Buffer      \u2502  \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502            \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 \u2502\n\u2502  \u2502          \u2502          \u2502            \u2502          \u2502          \u2502 \u2502\n\u2502  \u2502          \u25bc          \u2502            \u2502          \u25bc          \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502            \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502 \u2502\n\u2502  \u2502  \u2502   pg_wal/     \u2502  \u2502            \u2502  \u2502   pg_wal/     \u2502  \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502            \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 \u2502\n\u2502  \u2502          \u2502          \u2502            \u2502          \u2502          \u2502 \u2502\n\u2502  \u2502          \u25bc          \u2502            \u2502          \u25bc          \u2502 \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502            \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502 \u2502\n\u2502  \u2502  \u2502  Data Files   \u2502  \u2502            \u2502  \u2502  Data Files   \u2502  \u2502 \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502            \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 \u2502\n\u2502  \u2502                     \u2502            \u2502                     \u2502 \u2502\n\u2502  \u2502  Read/Write         \u2502            \u2502  Read Only          \u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518            \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30d7\u30ed\u30bb\u30b9\u3011                                                \u2502\n\u2502  Primary: WAL Sender \u30d7\u30ed\u30bb\u30b9\u304cWAL\u3092\u9001\u4fe1                    \u2502\n\u2502  Standby: WAL Receiver \u30d7\u30ed\u30bb\u30b9\u304cWAL\u3092\u53d7\u4fe1\u30fb\u9069\u7528            \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"22-\u30d7\u30e9\u30a4\u30de\u30ea\u306e\u8a2d\u5b9a",children:"2.2 \u30d7\u30e9\u30a4\u30de\u30ea\u306e\u8a2d\u5b9a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf (Primary)\n\n# WAL\u30ec\u30d9\u30eb (replica\u4ee5\u4e0a\u304c\u5fc5\u8981)\nwal_level = replica\n\n# WAL\u9001\u4fe1\u30d7\u30ed\u30bb\u30b9\u306e\u6700\u5927\u6570\nmax_wal_senders = 10\n\n# \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u6570\nmax_replication_slots = 10\n\n# \u30b9\u30bf\u30f3\u30d0\u30a4\u3078\u306eWAL\u4fdd\u6301 (\u30b9\u30ed\u30c3\u30c8\u672a\u4f7f\u7528\u6642)\nwal_keep_size = 1GB\n\n# \u30a2\u30fc\u30ab\u30a4\u30d6 (\u63a8\u5968)\narchive_mode = on\narchive_command = 'cp %p /var/lib/pgsql/archive/%f'\n\n# \u30db\u30c3\u30c8\u30b9\u30bf\u30f3\u30d0\u30a4\u304b\u3089\u306e\u30d5\u30a3\u30fc\u30c9\u30d0\u30c3\u30af\nhot_standby_feedback = on\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"# pg_hba.conf (Primary)\n# \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u63a5\u7d9a\u3092\u8a31\u53ef\nhost    replication     repl_user       192.168.1.0/24      scram-sha-256\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u7528\u30e6\u30fc\u30b6\u30fc\u306e\u4f5c\u6210 (Primary)\nCREATE ROLE repl_user WITH\n    LOGIN\n    REPLICATION\n    PASSWORD 'replication_password';\n"})}),"\n",(0,a.jsx)(e.h3,{id:"23-\u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u69cb\u7bc9",children:"2.3 \u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u69cb\u7bc9"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"# 1. \u30d7\u30e9\u30a4\u30de\u30ea\u304b\u3089\u30d9\u30fc\u30b9\u30d0\u30c3\u30af\u30a2\u30c3\u30d7\u3092\u53d6\u5f97\npg_basebackup -h primary_host -U repl_user -D /var/lib/pgsql/16/data \\\n    -Fp -Xs -P -R\n\n# -R \u30aa\u30d7\u30b7\u30e7\u30f3\u3067\u4ee5\u4e0b\u304c\u81ea\u52d5\u751f\u6210\u3055\u308c\u308b:\n# - standby.signal \u30d5\u30a1\u30a4\u30eb\n# - postgresql.auto.conf \u306b primary_conninfo \u304c\u8ffd\u52a0\u3055\u308c\u308b\n"})}),"\n",(0,a.jsx)(e.h3,{id:"24-\u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u8a2d\u5b9a",children:"2.4 \u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u8a2d\u5b9a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf (Standby)\n\n# \u30db\u30c3\u30c8\u30b9\u30bf\u30f3\u30d0\u30a4 (\u8aad\u307f\u53d6\u308a\u53ef\u80fd)\nhot_standby = on\n\n# \u30ea\u30ab\u30d0\u30ea\u4e2d\u306e\u30af\u30a8\u30ea\u7af6\u5408\u6642\u306e\u5f85\u6a5f\u6642\u9593\nmax_standby_streaming_delay = 30s\nmax_standby_archive_delay = 30s\n\n# WAL\u53d7\u4fe1\u30bf\u30a4\u30e0\u30a2\u30a6\u30c8\nwal_receiver_timeout = 60s\n\n# \u6607\u683c\u6642\u306e\u30c8\u30ea\u30ac\u30fc\u30d5\u30a1\u30a4\u30eb (\u65e7\u65b9\u5f0f\u3001\u73fe\u5728\u306f pg_promote() \u63a8\u5968)\n# promote_trigger_file = '/tmp/promote_trigger'\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ini",children:"# postgresql.auto.conf (\u81ea\u52d5\u751f\u6210\u307e\u305f\u306f\u624b\u52d5\u8a2d\u5b9a)\nprimary_conninfo = 'host=primary_host port=5432 user=repl_user password=replication_password'\nprimary_slot_name = 'standby1_slot'\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"# standby.signal \u30d5\u30a1\u30a4\u30eb\u306e\u5b58\u5728\u3067\u30b9\u30bf\u30f3\u30d0\u30a4\u30e2\u30fc\u30c9\u306b\u306a\u308b\ntouch /var/lib/pgsql/16/data/standby.signal\n"})}),"\n",(0,a.jsx)(e.h3,{id:"25-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u306e\u78ba\u8a8d",children:"2.5 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\u306e\u78ba\u8a8d"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30d7\u30e9\u30a4\u30de\u30ea\u3067\u78ba\u8a8d: \u63a5\u7d9a\u4e2d\u306e\u30b9\u30bf\u30f3\u30d0\u30a4\nSELECT\n    client_addr,\n    state,\n    sent_lsn,\n    write_lsn,\n    flush_lsn,\n    replay_lsn,\n    pg_wal_lsn_diff(sent_lsn, replay_lsn) AS replay_lag_bytes,\n    sync_state\nFROM pg_stat_replication;\n\n-- \u30b9\u30bf\u30f3\u30d0\u30a4\u3067\u78ba\u8a8d: \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u72b6\u614b\nSELECT\n    status,\n    received_lsn,\n    latest_end_lsn,\n    last_msg_send_time,\n    last_msg_receipt_time\nFROM pg_stat_wal_receiver;\n\n-- \u30b9\u30bf\u30f3\u30d0\u30a4\u3067\u78ba\u8a8d: \u30ea\u30ab\u30d0\u30ea\u72b6\u614b\nSELECT pg_is_in_recovery();\n\n-- \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e9\u30b0 (\u79d2)\nSELECT\n    CASE WHEN pg_is_in_recovery() THEN\n        EXTRACT(EPOCH FROM (now() - pg_last_xact_replay_timestamp()))\n    ELSE\n        0\n    END AS lag_seconds;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"26-\u30ab\u30b9\u30b1\u30fc\u30c9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",children:"2.6 \u30ab\u30b9\u30b1\u30fc\u30c9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                 \u30ab\u30b9\u30b1\u30fc\u30c9\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502   Primary \u2500\u2500\u2500\u2500\u2500\u2500\u2192 Standby1 \u2500\u2500\u2500\u2500\u2500\u2500\u2192 Standby2                 \u2502\n\u2502                       \u2502                                      \u2502\n\u2502                       \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2192 Standby3                     \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u5229\u70b9\u3011                                                    \u2502\n\u2502  - Primary\u306e\u8ca0\u8377\u8efd\u6e1b                                         \u2502\n\u2502  - \u5730\u7406\u7684\u306b\u96e2\u308c\u305f\u5834\u6240\u3078\u306e\u52b9\u7387\u7684\u306a\u8907\u88fd                        \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u8a2d\u5b9a\u3011                                                    \u2502\n\u2502  Standby1 \u3067 wal_level = replica \u3092\u8a2d\u5b9a                      \u2502\n\u2502  Standby2, Standby3 \u306f Standby1 \u3092 primary_conninfo \u3067\u6307\u5b9a   \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"3-\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",children:"3. \u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,a.jsx)(e.h3,{id:"31-\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u5ff5",children:"3.1 \u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u5ff5"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    \u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u975e\u540c\u671f (\u30c7\u30d5\u30a9\u30eb\u30c8)\u3011                                     \u2502\n\u2502                                                              \u2502\n\u2502  Client \u2500\u2500\u2192 Primary: COMMIT                                 \u2502\n\u2502             Primary: WAL\u66f8\u304d\u8fbc\u307f                             \u2502\n\u2502             Primary \u2500\u2500\u2192 Client: OK \u2190 \u3053\u3053\u3067\u5fdc\u7b54             \u2502\n\u2502             Primary \u2500\u2500\u2192 Standby: WAL\u9001\u4fe1 (\u5f8c\u304b\u3089)           \u2502\n\u2502                                                              \u2502\n\u2502  \u2192 Primary\u969c\u5bb3\u6642\u3001\u9001\u4fe1\u524d\u306eWAL\u304c\u5931\u308f\u308c\u308b\u53ef\u80fd\u6027                \u2502\n\u2502                                                              \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500             \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u540c\u671f\u3011                                                    \u2502\n\u2502                                                              \u2502\n\u2502  Client \u2500\u2500\u2192 Primary: COMMIT                                 \u2502\n\u2502             Primary: WAL\u66f8\u304d\u8fbc\u307f                             \u2502\n\u2502             Primary \u2500\u2500\u2192 Standby: WAL\u9001\u4fe1                    \u2502\n\u2502             Standby: WAL\u53d7\u4fe1/\u66f8\u304d\u8fbc\u307f                        \u2502\n\u2502             Standby \u2500\u2500\u2192 Primary: \u78ba\u8a8d\u5fdc\u7b54                   \u2502\n\u2502             Primary \u2500\u2500\u2192 Client: OK \u2190 \u3053\u3053\u3067\u5fdc\u7b54             \u2502\n\u2502                                                              \u2502\n\u2502  \u2192 \u30c7\u30fc\u30bf\u640d\u5931\u306a\u3057\u3001\u305f\u3060\u3057\u9045\u5ef6\u5897\u52a0                           \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"32-\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a",children:"3.2 \u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u8a2d\u5b9a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf (Primary)\n\n# \u540c\u671f\u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u6307\u5b9a\n# FIRST 1: \u6700\u521d\u306e1\u53f0\u304c\u5fdc\u7b54\u3059\u308c\u3070OK\nsynchronous_standby_names = 'FIRST 1 (standby1, standby2)'\n\n# \u307e\u305f\u306f ANY: N\u53f0\u4e2d\u3044\u305a\u308c\u304bN\u53f0\u304c\u5fdc\u7b54\u3059\u308c\u3070OK\nsynchronous_standby_names = 'ANY 2 (standby1, standby2, standby3)'\n\n# \u7279\u5b9a\u306e\u30b9\u30bf\u30f3\u30d0\u30a4\u3092\u6307\u5b9a\nsynchronous_standby_names = 'standby1'\n\n# \u540c\u671f\u30b3\u30df\u30c3\u30c8\u30ec\u30d9\u30eb\nsynchronous_commit = on\n"})}),"\n",(0,a.jsx)(e.h3,{id:"33-synchronous_commit-\u306e\u30ec\u30d9\u30eb",children:"3.3 synchronous_commit \u306e\u30ec\u30d9\u30eb"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                synchronous_commit \u306e\u30ec\u30d9\u30eb                    \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  off                                                         \u2502\n\u2502  \u2514\u2500 WAL\u30d0\u30c3\u30d5\u30a1\u306b\u66f8\u304d\u8fbc\u3093\u3060\u6642\u70b9\u3067\u5fdc\u7b54                        \u2502\n\u2502     \u6700\u901f\u3060\u304c\u3001\u30af\u30e9\u30c3\u30b7\u30e5\u6642\u306b\u30c7\u30fc\u30bf\u640d\u5931\u306e\u53ef\u80fd\u6027               \u2502\n\u2502                                                              \u2502\n\u2502  local                                                       \u2502\n\u2502  \u2514\u2500 \u30ed\u30fc\u30ab\u30eb\u306e\u30c7\u30a3\u30b9\u30af\u306b\u66f8\u304d\u8fbc\u3093\u3060\u6642\u70b9\u3067\u5fdc\u7b54                 \u2502\n\u2502     \u30b9\u30bf\u30f3\u30d0\u30a4\u3078\u306e\u9001\u4fe1\u306f\u5f85\u305f\u306a\u3044                             \u2502\n\u2502                                                              \u2502\n\u2502  remote_write                                                \u2502\n\u2502  \u2514\u2500 \u30b9\u30bf\u30f3\u30d0\u30a4\u304cOS\u30d0\u30c3\u30d5\u30a1\u306b\u66f8\u304d\u8fbc\u3093\u3060\u6642\u70b9\u3067\u5fdc\u7b54             \u2502\n\u2502     \u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u30c7\u30a3\u30b9\u30af\u66f8\u304d\u8fbc\u307f\u306f\u5f85\u305f\u306a\u3044                   \u2502\n\u2502                                                              \u2502\n\u2502  on (\u30c7\u30d5\u30a9\u30eb\u30c8)                                             \u2502\n\u2502  \u2514\u2500 \u30b9\u30bf\u30f3\u30d0\u30a4\u304c\u30c7\u30a3\u30b9\u30af\u306b\u66f8\u304d\u8fbc\u3093\u3060\u6642\u70b9\u3067\u5fdc\u7b54               \u2502\n\u2502     \u30b9\u30bf\u30f3\u30d0\u30a4\u3067\u306eWAL\u9069\u7528\u306f\u5f85\u305f\u306a\u3044                          \u2502\n\u2502                                                              \u2502\n\u2502  remote_apply                                                \u2502\n\u2502  \u2514\u2500 \u30b9\u30bf\u30f3\u30d0\u30a4\u304cWAL\u3092\u9069\u7528\u3057\u305f\u6642\u70b9\u3067\u5fdc\u7b54                      \u2502\n\u2502     \u30b9\u30bf\u30f3\u30d0\u30a4\u3067\u8aad\u307f\u53d6\u308a\u53ef\u80fd\u306b\u306a\u3063\u3066\u304b\u3089\u5fdc\u7b54                 \u2502\n\u2502     \u6700\u3082\u53b3\u683c\u3060\u304c\u6700\u3082\u9045\u3044                                     \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"34-\u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u72b6\u614b\u78ba\u8a8d",children:"3.4 \u540c\u671f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u72b6\u614b\u78ba\u8a8d"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u540c\u671f\u30b9\u30bf\u30f3\u30d0\u30a4\u306e\u78ba\u8a8d\nSELECT\n    application_name,\n    client_addr,\n    state,\n    sync_state,      -- sync, async, quorum, potential\n    sync_priority\nFROM pg_stat_replication;\n\n-- sync_state \u306e\u610f\u5473:\n-- sync: \u73fe\u5728\u306e\u540c\u671f\u30b9\u30bf\u30f3\u30d0\u30a4\n-- potential: \u5019\u88dc (sync\u304c\u843d\u3061\u305f\u3089\u6607\u683c)\n-- async: \u975e\u540c\u671f\n-- quorum: quorum\u5bfe\u8c61\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"4-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3",children:"4. \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3"}),"\n",(0,a.jsx)(e.h3,{id:"41-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u5ff5",children:"4.1 \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u6982\u5ff5"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3                        \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502   Publisher                        Subscriber                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510         \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u2502\n\u2502  \u2502                     \u2502         \u2502                     \u2502    \u2502\n\u2502  \u2502  CREATE PUBLICATION \u2502         \u2502 CREATE SUBSCRIPTION \u2502    \u2502\n\u2502  \u2502  FOR TABLE t1, t2   \u2502         \u2502 CONNECTION '...'    \u2502    \u2502\n\u2502  \u2502                     \u2502         \u2502 PUBLICATION pub1    \u2502    \u2502\n\u2502  \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502 logical \u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510  \u2502    \u2502\n\u2502  \u2502  \u2502 WAL Decoder   \u2502\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2192\u2502 Apply Worker  \u2502  \u2502    \u2502\n\u2502  \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502 changes \u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518  \u2502    \u2502\n\u2502  \u2502                     \u2502         \u2502                     \u2502    \u2502\n\u2502  \u2502  t1, t2 \u30c6\u30fc\u30d6\u30eb   \u2502         \u2502  t1, t2 \u30c6\u30fc\u30d6\u30eb   \u2502    \u2502\n\u2502  \u2502                     \u2502         \u2502                     \u2502    \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518         \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u7279\u5fb4\u3011                                                    \u2502\n\u2502  - \u30c6\u30fc\u30d6\u30eb\u5358\u4f4d\u3067\u9078\u629e\u53ef\u80fd                                    \u2502\n\u2502  - \u7570\u306a\u308b\u30d0\u30fc\u30b8\u30e7\u30f3\u9593\u3067\u53ef\u80fd                                  \u2502\n\u2502  - Subscriber\u5074\u3082\u66f8\u304d\u8fbc\u307f\u53ef\u80fd (\u7af6\u5408\u306b\u6ce8\u610f)                  \u2502\n\u2502  - DDL\u306f\u8907\u88fd\u3055\u308c\u306a\u3044                                         \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"42-publisher-\u9001\u4fe1\u5074-\u306e\u8a2d\u5b9a",children:"4.2 Publisher (\u9001\u4fe1\u5074) \u306e\u8a2d\u5b9a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ini",children:"# postgresql.conf (Publisher)\nwal_level = logical\nmax_replication_slots = 10\nmax_wal_senders = 10\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30d1\u30d6\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u4f5c\u6210\n-- \u7279\u5b9a\u306e\u30c6\u30fc\u30d6\u30eb\nCREATE PUBLICATION my_pub FOR TABLE users, orders;\n\n-- \u5168\u30c6\u30fc\u30d6\u30eb\nCREATE PUBLICATION my_pub FOR ALL TABLES;\n\n-- \u7279\u5b9a\u30b9\u30ad\u30fc\u30de\u306e\u5168\u30c6\u30fc\u30d6\u30eb\nCREATE PUBLICATION my_pub FOR TABLES IN SCHEMA public;\n\n-- INSERT/UPDATE/DELETE\u306e\u9078\u629e\nCREATE PUBLICATION my_pub FOR TABLE users\n    WITH (publish = 'insert, update, delete');\n\n-- \u30d1\u30d6\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306b\u30c6\u30fc\u30d6\u30eb\u3092\u8ffd\u52a0\nALTER PUBLICATION my_pub ADD TABLE products;\n\n-- \u30d1\u30d6\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\nSELECT * FROM pg_publication;\nSELECT * FROM pg_publication_tables;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"43-subscriber-\u53d7\u4fe1\u5074-\u306e\u8a2d\u5b9a",children:"4.3 Subscriber (\u53d7\u4fe1\u5074) \u306e\u8a2d\u5b9a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30c6\u30fc\u30d6\u30eb\u3092\u4e8b\u524d\u306b\u4f5c\u6210 (\u30b9\u30ad\u30fc\u30de\u306f\u8907\u88fd\u3055\u308c\u306a\u3044)\nCREATE TABLE users (\n    id SERIAL PRIMARY KEY,\n    name VARCHAR(100),\n    email VARCHAR(255)\n);\n\nCREATE TABLE orders (\n    id SERIAL PRIMARY KEY,\n    user_id INTEGER,\n    total NUMERIC\n);\n\n-- \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u4f5c\u6210\nCREATE SUBSCRIPTION my_sub\n    CONNECTION 'host=publisher_host port=5432 dbname=mydb user=repl_user password=xxx'\n    PUBLICATION my_pub;\n\n-- \u521d\u671f\u30c7\u30fc\u30bf\u30b3\u30d4\u30fc\u3092\u30b9\u30ad\u30c3\u30d7 (\u65e2\u306b\u30c7\u30fc\u30bf\u304c\u3042\u308b\u5834\u5408)\nCREATE SUBSCRIPTION my_sub\n    CONNECTION '...'\n    PUBLICATION my_pub\n    WITH (copy_data = false);\n\n-- \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u78ba\u8a8d\nSELECT * FROM pg_subscription;\nSELECT * FROM pg_stat_subscription;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"44-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u7ba1\u7406",children:"4.4 \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u7ba1\u7406"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u4e00\u6642\u505c\u6b62\nALTER SUBSCRIPTION my_sub DISABLE;\n\n-- \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u518d\u958b\nALTER SUBSCRIPTION my_sub ENABLE;\n\n-- \u30d1\u30d6\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u30ea\u30d5\u30ec\u30c3\u30b7\u30e5 (\u65b0\u3057\u3044\u30c6\u30fc\u30d6\u30eb\u3092\u540c\u671f)\nALTER SUBSCRIPTION my_sub REFRESH PUBLICATION;\n\n-- \u30b5\u30d6\u30b9\u30af\u30ea\u30d7\u30b7\u30e7\u30f3\u306e\u524a\u9664\nDROP SUBSCRIPTION my_sub;\n\n-- \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u72b6\u614b\u78ba\u8a8d (Subscriber\u5074)\nSELECT\n    subname,\n    received_lsn,\n    latest_end_lsn,\n    last_msg_send_time,\n    last_msg_receipt_time\nFROM pg_stat_subscription;\n\n-- \u521d\u671f\u540c\u671f\u306e\u72b6\u614b (Subscriber\u5074)\nSELECT * FROM pg_subscription_rel;\n"})}),"\n",(0,a.jsx)(e.h3,{id:"45-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u5236\u9650\u4e8b\u9805",children:"4.5 \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u5236\u9650\u4e8b\u9805"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502               \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u5236\u9650\u4e8b\u9805                  \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u8907\u88fd\u3055\u308c\u306a\u3044\u3082\u306e\u3011                                        \u2502\n\u2502  - DDL (CREATE, ALTER, DROP)                                 \u2502\n\u2502  - \u30b7\u30fc\u30b1\u30f3\u30b9\u306e\u5024                                            \u2502\n\u2502  - \u30e9\u30fc\u30b8\u30aa\u30d6\u30b8\u30a7\u30af\u30c8                                        \u2502\n\u2502  - TRUNCATE (PostgreSQL 11\u4ee5\u964d\u306f\u53ef\u80fd)                       \u2502\n\u2502  - \u30de\u30c6\u30ea\u30a2\u30e9\u30a4\u30ba\u30c9\u30d3\u30e5\u30fc                                    \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u8981\u4ef6\u3011                                                    \u2502\n\u2502  - \u30ec\u30d7\u30ea\u30ab\u30a2\u30a4\u30c7\u30f3\u30c6\u30a3\u30c6\u30a3\u304c\u5fc5\u8981                            \u2502\n\u2502    - PRIMARY KEY\u3001\u307e\u305f\u306f                                     \u2502\n\u2502    - REPLICA IDENTITY FULL                                  \u2502\n\u2502  - \u30c6\u30fc\u30d6\u30eb\u69cb\u9020\u304c\u4e00\u81f4\u3057\u3066\u3044\u308b\u5fc5\u8981                            \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u7af6\u5408\u3011                                                    \u2502\n\u2502  - Subscriber\u3067\u540c\u3058\u884c\u3092\u66f4\u65b0\u3059\u308b\u3068\u7af6\u5408                        \u2502\n\u2502  - \u7af6\u5408\u6642\u306f\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u304c\u505c\u6b62                            \u2502\n\u2502  - \u624b\u52d5\u3067\u306e\u89e3\u6c7a\u304c\u5fc5\u8981                                        \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30ec\u30d7\u30ea\u30ab\u30a2\u30a4\u30c7\u30f3\u30c6\u30a3\u30c6\u30a3\u306e\u8a2d\u5b9a (PK\u304c\u306a\u3044\u5834\u5408)\nALTER TABLE my_table REPLICA IDENTITY FULL;\n\n-- \u307e\u305f\u306f\u7279\u5b9a\u306e\u30a4\u30f3\u30c7\u30c3\u30af\u30b9\u3092\u4f7f\u7528\nALTER TABLE my_table REPLICA IDENTITY USING INDEX my_unique_idx;\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"5-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8",children:"5. \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8"}),"\n",(0,a.jsx)(e.h3,{id:"51-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u306e\u5f79\u5272",children:"5.1 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8\u306e\u5f79\u5272"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8                     \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u554f\u984c\u3011\u30b9\u30ed\u30c3\u30c8\u306a\u3057\u306e\u5834\u5408                                  \u2502\n\u2502                                                              \u2502\n\u2502  Standby\u304c\u4e00\u6642\u7684\u306b\u505c\u6b62                                       \u2502\n\u2502      \u2193                                                       \u2502\n\u2502  Primary\u306f\u901a\u5e38\u901a\u308aWAL\u3092\u751f\u6210\u30fb\u524a\u9664                            \u2502\n\u2502      \u2193                                                       \u2502\n\u2502  Standby\u304c\u5fc5\u8981\u3068\u3059\u308bWAL\u304c\u524a\u9664\u3055\u308c\u308b                          \u2502\n\u2502      \u2193                                                       \u2502\n\u2502  Standby\u304c\u518d\u63a5\u7d9a\u3067\u304d\u306a\u3044\uff01                                   \u2502\n\u2502                                                              \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500             \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u89e3\u6c7a\u3011\u30b9\u30ed\u30c3\u30c8\u3042\u308a\u306e\u5834\u5408                                  \u2502\n\u2502                                                              \u2502\n\u2502  \u30b9\u30ed\u30c3\u30c8\u304c\u300c\u3053\u306eLSN\u307e\u3067\u5fc5\u8981\u300d\u3092\u8a18\u9332                         \u2502\n\u2502      \u2193                                                       \u2502\n\u2502  Primary\u306f\u30b9\u30ed\u30c3\u30c8\u304c\u53c2\u7167\u3059\u308bWAL\u3092\u4fdd\u6301                        \u2502\n\u2502      \u2193                                                       \u2502\n\u2502  Standby\u304c\u518d\u63a5\u7d9a\u53ef\u80fd                                         \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u6ce8\u610f\u3011                                                    \u2502\n\u2502  Standby\u304c\u9577\u671f\u9593\u505c\u6b62\u3059\u308b\u3068WAL\u304c\u84c4\u7a4d\u3057\u3066\u30c7\u30a3\u30b9\u30af\u3092\u5727\u8feb       \u2502\n\u2502  \u2192 max_slot_wal_keep_size \u3067\u5236\u9650\u53ef\u80fd                        \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"52-\u7269\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8",children:"5.2 \u7269\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30b9\u30ed\u30c3\u30c8\u306e\u4f5c\u6210 (Primary)\nSELECT pg_create_physical_replication_slot('standby1_slot');\n\n-- Standby\u306e\u8a2d\u5b9a\n-- postgresql.auto.conf\nprimary_slot_name = 'standby1_slot'\n\n-- \u30b9\u30ed\u30c3\u30c8\u306e\u78ba\u8a8d\nSELECT\n    slot_name,\n    slot_type,\n    active,\n    restart_lsn,\n    pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn) AS lag_bytes\nFROM pg_replication_slots;\n\n-- \u30b9\u30ed\u30c3\u30c8\u306e\u524a\u9664\nSELECT pg_drop_replication_slot('standby1_slot');\n"})}),"\n",(0,a.jsx)(e.h3,{id:"53-\u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8",children:"5.3 \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30b9\u30ed\u30c3\u30c8"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u8ad6\u7406\u30b9\u30ed\u30c3\u30c8\u306f CREATE SUBSCRIPTION \u6642\u306b\u81ea\u52d5\u4f5c\u6210\u3055\u308c\u308b\n\n-- \u624b\u52d5\u4f5c\u6210 (\u30c7\u30b3\u30fc\u30c9\u30d7\u30e9\u30b0\u30a4\u30f3\u6307\u5b9a)\nSELECT pg_create_logical_replication_slot('my_slot', 'pgoutput');\n\n-- \u8ad6\u7406\u30b9\u30ed\u30c3\u30c8\u304b\u3089\u306e\u5909\u66f4\u53d6\u5f97 (\u30c7\u30d0\u30c3\u30b0\u7528)\nSELECT * FROM pg_logical_slot_peek_changes('my_slot', NULL, NULL);\n\n-- \u5909\u66f4\u3092\u6d88\u8cbb (\u78ba\u8a8d\u5f8c\u306b\u524a\u9664)\nSELECT * FROM pg_logical_slot_get_changes('my_slot', NULL, NULL);\n"})}),"\n",(0,a.jsx)(e.h3,{id:"54-\u30b9\u30ed\u30c3\u30c8\u306e\u76e3\u8996",children:"5.4 \u30b9\u30ed\u30c3\u30c8\u306e\u76e3\u8996"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30b9\u30ed\u30c3\u30c8\u306e\u72b6\u614b\u3068WAL\u4fdd\u6301\u91cf\nSELECT\n    slot_name,\n    slot_type,\n    active,\n    pg_size_pretty(pg_wal_lsn_diff(pg_current_wal_lsn(), restart_lsn)) AS wal_retained\nFROM pg_replication_slots;\n\n-- \u975e\u30a2\u30af\u30c6\u30a3\u30d6\u30b9\u30ed\u30c3\u30c8\u306e\u691c\u51fa (WAL\u84c4\u7a4d\u30ea\u30b9\u30af)\nSELECT slot_name, active, restart_lsn\nFROM pg_replication_slots\nWHERE NOT active;\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ini",children:"# WAL\u84c4\u7a4d\u306e\u5236\u9650 (PostgreSQL 13+)\nmax_slot_wal_keep_size = 10GB  # \u3053\u306e\u91cf\u3092\u8d85\u3048\u308b\u3068\u7121\u52b9\u30b9\u30ed\u30c3\u30c8\u3092\u7121\u8996\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"6-\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc",children:"6. \u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc"}),"\n",(0,a.jsx)(e.h3,{id:"61-\u624b\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc",children:"6.1 \u624b\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                    \u624b\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc                       \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u72b6\u6cc1\u3011Primary\u969c\u5bb3\u767a\u751f                                     \u2502\n\u2502                                                              \u2502\n\u2502  Step 1: Primary\u505c\u6b62\u306e\u78ba\u8a8d                                   \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 # Primary\u306b\u63a5\u7d9a\u3067\u304d\u306a\u3044\u3053\u3068\u3092\u78ba\u8a8d                     \u2502   \u2502\n\u2502  \u2502 psql -h primary_host -c "SELECT 1"                   \u2502   \u2502\n\u2502  \u2502                                                      \u2502   \u2502\n\u2502  \u2502 # \u53ef\u80fd\u306a\u3089\u6b63\u5e38\u505c\u6b62                                    \u2502   \u2502\n\u2502  \u2502 pg_ctl stop -D /var/lib/pgsql/16/data -m fast       \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  Step 2: Standby\u3092\u6607\u683c (Promote)                            \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 # \u65b9\u6cd51: pg_ctl                                      \u2502   \u2502\n\u2502  \u2502 pg_ctl promote -D /var/lib/pgsql/16/data            \u2502   \u2502\n\u2502  \u2502                                                      \u2502   \u2502\n\u2502  \u2502 # \u65b9\u6cd52: SQL\u95a2\u6570                                     \u2502   \u2502\n\u2502  \u2502 SELECT pg_promote();                                 \u2502   \u2502\n\u2502  \u2502                                                      \u2502   \u2502\n\u2502  \u2502 # \u78ba\u8a8d                                               \u2502   \u2502\n\u2502  \u2502 SELECT pg_is_in_recovery(); -- false\u306b\u306a\u308b          \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  Step 3: \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u306e\u63a5\u7d9a\u5148\u5909\u66f4                        \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502 - DNS\u66f4\u65b0                                            \u2502   \u2502\n\u2502  \u2502 - \u30ed\u30fc\u30c9\u30d0\u30e9\u30f3\u30b5\u30fc\u8a2d\u5b9a\u5909\u66f4                           \u2502   \u2502\n\u2502  \u2502 - \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u8a2d\u5b9a\u5909\u66f4                           \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  Step 4: \u65e7Primary\u3092\u30b9\u30bf\u30f3\u30d0\u30a4\u3068\u3057\u3066\u518d\u69cb\u7bc9 (\u5f8c\u3067)           \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,a.jsx)(e.h3,{id:"62-pg_rewind-\u306b\u3088\u308b\u518d\u69cb\u7bc9",children:"6.2 pg_rewind \u306b\u3088\u308b\u518d\u69cb\u7bc9"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"# \u65e7Primary\u3092\u65b0Standby\u3068\u3057\u3066\u518d\u69cb\u7bc9\n# (\u30c7\u30fc\u30bf\u3092\u518d\u30b3\u30d4\u30fc\u305b\u305a\u306b\u540c\u671f)\n\n# \u524d\u63d0\u6761\u4ef6:\n# - \u65e7Primary\u304c\u30af\u30ea\u30fc\u30f3\u30b7\u30e3\u30c3\u30c8\u30c0\u30a6\u30f3\u3055\u308c\u3066\u3044\u308b\n# - wal_log_hints = on \u307e\u305f\u306f data_checksums \u304c\u6709\u52b9\n\n# 1. \u65e7Primary\u3092\u505c\u6b62\npg_ctl stop -D /var/lib/pgsql/16/data -m fast\n\n# 2. pg_rewind\u3092\u5b9f\u884c\npg_rewind --target-pgdata=/var/lib/pgsql/16/data \\\n    --source-server=\"host=new_primary port=5432 user=postgres\"\n\n# 3. standby.signal \u3092\u4f5c\u6210\ntouch /var/lib/pgsql/16/data/standby.signal\n\n# 4. primary_conninfo \u3092\u8a2d\u5b9a\ncat >> /var/lib/pgsql/16/data/postgresql.auto.conf << EOF\nprimary_conninfo = 'host=new_primary port=5432 user=repl_user password=xxx'\nEOF\n\n# 5. \u8d77\u52d5\npg_ctl start -D /var/lib/pgsql/16/data\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"7-patroni\u306b\u3088\u308b\u81ea\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc",children:"7. Patroni\u306b\u3088\u308b\u81ea\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc"}),"\n",(0,a.jsx)(e.h3,{id:"71-patroni\u306e\u6982\u8981",children:"7.1 Patroni\u306e\u6982\u8981"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                      Patroni \u30a2\u30fc\u30ad\u30c6\u30af\u30c1\u30e3                   \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502\n\u2502  \u2502                      etcd / Consul / ZooKeeper          \u2502\u2502\n\u2502  \u2502                   (\u5206\u6563\u30ad\u30fc\u30d0\u30ea\u30e5\u30fc\u30b9\u30c8\u30a2)               \u2502\u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502\n\u2502               \u2502              \u2502              \u2502               \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u250c\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502\n\u2502  \u2502    Node 1          \u2502 \u2502    Node 2       \u2502 \u2502   Node 3    \u2502 \u2502\n\u2502  \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502 \u2502\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502 \u2502\n\u2502  \u2502 \u2502   Patroni      \u2502 \u2502 \u2502 \u2502  Patroni     \u2502\u2502 \u2502\u2502  Patroni  \u2502\u2502 \u2502\n\u2502  \u2502 \u2502   (Agent)      \u2502 \u2502 \u2502 \u2502  (Agent)     \u2502\u2502 \u2502\u2502  (Agent)  \u2502\u2502 \u2502\n\u2502  \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502 \u2502\u2514\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2518\u2502 \u2502\n\u2502  \u2502         \u2502          \u2502 \u2502        \u2502        \u2502 \u2502      \u2502      \u2502 \u2502\n\u2502  \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510 \u2502 \u2502 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\u2502 \u2502\u250c\u2500\u2500\u2500\u2500\u2500\u25bc\u2500\u2500\u2500\u2500\u2500\u2510\u2502 \u2502\n\u2502  \u2502 \u2502  PostgreSQL    \u2502 \u2502 \u2502 \u2502 PostgreSQL   \u2502\u2502 \u2502\u2502PostgreSQL \u2502\u2502 \u2502\n\u2502  \u2502 \u2502  (Leader)      \u2502 \u2502 \u2502 \u2502 (Replica)    \u2502\u2502 \u2502\u2502(Replica)  \u2502\u2502 \u2502\n\u2502  \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502 \u2502 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502 \u2502\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\u2502 \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518 \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u52d5\u4f5c\u3011                                                    \u2502\n\u2502  1. Patroni\u304c\u30ea\u30fc\u30c0\u30fc\u9078\u51fa\u3092\u884c\u3044\u3001etcd\u306b\u767b\u9332                  \u2502\n\u2502  2. \u30ea\u30fc\u30c0\u30fc\u304c\u969c\u5bb3 \u2192 etcd\u3067\u30ea\u30fc\u30c0\u30fc\u4e0d\u5728\u3092\u691c\u77e5               \u2502\n\u2502  3. \u65b0\u30ea\u30fc\u30c0\u30fc\u9078\u51fa \u2192 \u30ec\u30d7\u30ea\u30ab\u306e1\u3064\u304c\u6607\u683c                    \u2502\n\u2502  4. \u65e7\u30ea\u30fc\u30c0\u30fc\u304c\u5fa9\u5e30 \u2192 \u81ea\u52d5\u7684\u306b\u30ec\u30d7\u30ea\u30ab\u3068\u3057\u3066\u53c2\u52a0           \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.h3,{id:"72-patroni\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb",children:"7.2 Patroni\u306e\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"# Python\u30d1\u30c3\u30b1\u30fc\u30b8\u3068\u3057\u3066\u30a4\u30f3\u30b9\u30c8\u30fc\u30eb\npip install patroni[etcd]\n\n# \u307e\u305f\u306f RPM/DEB \u30d1\u30c3\u30b1\u30fc\u30b8\n# RHEL\u7cfb\nsudo dnf install patroni patroni-etcd\n\n# Debian\u7cfb\nsudo apt install patroni\n"})}),"\n",(0,a.jsx)(e.h3,{id:"73-patroni\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb",children:"7.3 Patroni\u8a2d\u5b9a\u30d5\u30a1\u30a4\u30eb"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-yaml",children:"# /etc/patroni/patroni.yml\n\nscope: pg-cluster\nname: node1\n\nrestapi:\n  listen: 0.0.0.0:8008\n  connect_address: 192.168.1.11:8008\n\netcd3:\n  hosts:\n    - 192.168.1.21:2379\n    - 192.168.1.22:2379\n    - 192.168.1.23:2379\n\nbootstrap:\n  dcs:\n    ttl: 30\n    loop_wait: 10\n    retry_timeout: 10\n    maximum_lag_on_failover: 1048576  # 1MB\n    postgresql:\n      use_pg_rewind: true\n      use_slots: true\n      parameters:\n        wal_level: replica\n        hot_standby: \"on\"\n        max_connections: 200\n        max_wal_senders: 10\n        max_replication_slots: 10\n        wal_keep_size: 1GB\n\n  initdb:\n    - encoding: UTF8\n    - data-checksums\n\n  pg_hba:\n    - host replication replicator 192.168.1.0/24 scram-sha-256\n    - host all all 192.168.1.0/24 scram-sha-256\n\n  users:\n    admin:\n      password: admin_password\n      options:\n        - createrole\n        - createdb\n    replicator:\n      password: repl_password\n      options:\n        - replication\n\npostgresql:\n  listen: 0.0.0.0:5432\n  connect_address: 192.168.1.11:5432\n  data_dir: /var/lib/pgsql/16/data\n  bin_dir: /usr/pgsql-16/bin\n  pgpass: /tmp/pgpass\n  authentication:\n    replication:\n      username: replicator\n      password: repl_password\n    superuser:\n      username: postgres\n      password: postgres_password\n  parameters:\n    unix_socket_directories: '/var/run/postgresql'\n    shared_buffers: 4GB\n    effective_cache_size: 12GB\n    work_mem: 64MB\n\ntags:\n  nofailover: false\n  noloadbalance: false\n  clonefrom: false\n  nosync: false\n"})}),"\n",(0,a.jsx)(e.h3,{id:"74-patroni\u306e\u64cd\u4f5c",children:"7.4 Patroni\u306e\u64cd\u4f5c"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-bash",children:"# \u30b5\u30fc\u30d3\u30b9\u8d77\u52d5\nsudo systemctl start patroni\n\n# \u30af\u30e9\u30b9\u30bf\u72b6\u614b\u306e\u78ba\u8a8d\npatronictl -c /etc/patroni/patroni.yml list\n\n# \u51fa\u529b\u4f8b:\n# + Cluster: pg-cluster (7123456789012345678) ----+----+-----------+\n# | Member | Host          | Role    | State     | TL | Lag in MB |\n# +--------+---------------+---------+-----------+----+-----------+\n# | node1  | 192.168.1.11  | Leader  | running   |  1 |           |\n# | node2  | 192.168.1.12  | Replica | streaming |  1 |         0 |\n# | node3  | 192.168.1.13  | Replica | streaming |  1 |         0 |\n# +--------+---------------+---------+-----------+----+-----------+\n\n# \u624b\u52d5\u30d5\u30a7\u30a4\u30eb\u30aa\u30fc\u30d0\u30fc\npatronictl -c /etc/patroni/patroni.yml failover\n\n# \u30b9\u30a4\u30c3\u30c1\u30aa\u30fc\u30d0\u30fc (\u8a08\u753b\u7684\u306a\u5207\u308a\u66ff\u3048)\npatronictl -c /etc/patroni/patroni.yml switchover\n\n# \u30ce\u30fc\u30c9\u306e\u518d\u8d77\u52d5\npatronictl -c /etc/patroni/patroni.yml restart pg-cluster node1\n\n# \u8a2d\u5b9a\u306e\u30ea\u30ed\u30fc\u30c9\npatronictl -c /etc/patroni/patroni.yml reload pg-cluster\n\n# \u30af\u30e9\u30b9\u30bf\u8a2d\u5b9a\u306e\u7de8\u96c6\npatronictl -c /etc/patroni/patroni.yml edit-config\n"})}),"\n",(0,a.jsx)(e.h3,{id:"75-haproxy-\u3068\u306e\u9023\u643a",children:"7.5 HAProxy \u3068\u306e\u9023\u643a"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                  HAProxy + Patroni \u69cb\u6210                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502                      \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                        \u2502\n\u2502                      \u2502   HAProxy    \u2502                        \u2502\n\u2502                      \u2502  (VIP)       \u2502                        \u2502\n\u2502                      \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u252c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518                        \u2502\n\u2502                 \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u253c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510                    \u2502\n\u2502                 \u2502           \u2502           \u2502                    \u2502\n\u2502            :5432\u2502      :5433\u2502      :8008\u2502                    \u2502\n\u2502          (write)\u2502    (read) \u2502   (health)\u2502                    \u2502\n\u2502                 \u25bc           \u25bc           \u25bc                    \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510   \u2502\n\u2502  \u2502                   PostgreSQL Nodes                    \u2502   \u2502\n\u2502  \u2502   Node1 (Leader)  Node2 (Replica)  Node3 (Replica)   \u2502   \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518   \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u30dd\u30fc\u30c8\u3011                                                  \u2502\n\u2502  5432: \u66f8\u304d\u8fbc\u307f\u7528 (Leader\u306e\u307f)                              \u2502\n\u2502  5433: \u8aad\u307f\u53d6\u308a\u7528 (\u5168Replica)                               \u2502\n\u2502  8008: Patroni REST API (\u30d8\u30eb\u30b9\u30c1\u30a7\u30c3\u30af)                    \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-haproxy",children:"# /etc/haproxy/haproxy.cfg\n\nglobal\n    maxconn 1000\n\ndefaults\n    mode tcp\n    timeout connect 10s\n    timeout client 30m\n    timeout server 30m\n\n# \u66f8\u304d\u8fbc\u307f\u7528 (Leader\u306e\u307f)\nfrontend pg_write\n    bind *:5432\n    default_backend pg_write_backend\n\nbackend pg_write_backend\n    option httpchk GET /primary\n    http-check expect status 200\n    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions\n    server node1 192.168.1.11:5432 check port 8008\n    server node2 192.168.1.12:5432 check port 8008\n    server node3 192.168.1.13:5432 check port 8008\n\n# \u8aad\u307f\u53d6\u308a\u7528 (\u5168Replica)\nfrontend pg_read\n    bind *:5433\n    default_backend pg_read_backend\n\nbackend pg_read_backend\n    balance roundrobin\n    option httpchk GET /replica\n    http-check expect status 200\n    default-server inter 3s fall 3 rise 2 on-marked-down shutdown-sessions\n    server node1 192.168.1.11:5432 check port 8008\n    server node2 192.168.1.12:5432 check port 8008\n    server node3 192.168.1.13:5432 check port 8008\n\n# \u7d71\u8a08\u60c5\u5831\nfrontend stats\n    bind *:7000\n    mode http\n    stats enable\n    stats uri /stats\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"8-\u8aad\u307f\u53d6\u308a\u8ca0\u8377\u5206\u6563",children:"8. \u8aad\u307f\u53d6\u308a\u8ca0\u8377\u5206\u6563"}),"\n",(0,a.jsx)(e.h3,{id:"81-\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u3067\u306e\u5206\u6563",children:"8.1 \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u3067\u306e\u5206\u6563"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{children:'\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                   \u8aad\u307f\u53d6\u308a\u8ca0\u8377\u5206\u6563\u306e\u65b9\u6cd5                      \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                              \u2502\n\u2502  \u3010\u65b9\u6cd51\u3011\u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u3067\u660e\u793a\u7684\u306b\u5206\u3051\u308b                   \u2502\n\u2502                                                              \u2502\n\u2502  write_conn = connect("primary_host")                        \u2502\n\u2502  read_conn  = connect("replica_host")                        \u2502\n\u2502                                                              \u2502\n\u2502  # \u66f8\u304d\u8fbc\u307f                                                  \u2502\n\u2502  write_conn.execute("INSERT INTO ...")                       \u2502\n\u2502                                                              \u2502\n\u2502  # \u8aad\u307f\u53d6\u308a                                                  \u2502\n\u2502  read_conn.execute("SELECT ...")                             \u2502\n\u2502                                                              \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500             \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u65b9\u6cd52\u3011\u30b3\u30cd\u30af\u30b7\u30e7\u30f3\u30d7\u30fc\u30eb\u3067\u5206\u3051\u308b                         \u2502\n\u2502                                                              \u2502\n\u2502  PgBouncer \u3084 Pgpool-II \u3067\u8aad\u307f\u53d6\u308a\u3092\u30ec\u30d7\u30ea\u30ab\u306b\u632f\u308a\u5206\u3051      \u2502\n\u2502                                                              \u2502\n\u2502  \u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500             \u2502\n\u2502                                                              \u2502\n\u2502  \u3010\u65b9\u6cd53\u3011libpq \u306e target_session_attrs                      \u2502\n\u2502                                                              \u2502\n\u2502  # \u8907\u6570\u30db\u30b9\u30c8\u6307\u5b9a\u3001primary \u306e\u307f\u306b\u63a5\u7d9a                        \u2502\n\u2502  host=node1,node2,node3 target_session_attrs=primary        \u2502\n\u2502                                                              \u2502\n\u2502  # \u8907\u6570\u30db\u30b9\u30c8\u6307\u5b9a\u3001\u3069\u308c\u3067\u3082OK (\u8aad\u307f\u53d6\u308a\u7528)                  \u2502\n\u2502  host=node1,node2,node3 target_session_attrs=any            \u2502\n\u2502                                                              \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n'})}),"\n",(0,a.jsx)(e.h3,{id:"82-pgbouncer\u306b\u3088\u308b\u8ca0\u8377\u5206\u6563",children:"8.2 PgBouncer\u306b\u3088\u308b\u8ca0\u8377\u5206\u6563"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-ini",children:"# /etc/pgbouncer/pgbouncer.ini\n\n[databases]\n# \u66f8\u304d\u8fbc\u307f\u7528\nmydb_write = host=primary_host port=5432 dbname=mydb\n\n# \u8aad\u307f\u53d6\u308a\u7528 (\u30e9\u30a6\u30f3\u30c9\u30ed\u30d3\u30f3)\nmydb_read = host=replica1,replica2 port=5432 dbname=mydb\n\n[pgbouncer]\nlisten_addr = 0.0.0.0\nlisten_port = 6432\nauth_type = scram-sha-256\nauth_file = /etc/pgbouncer/userlist.txt\npool_mode = transaction\nmax_client_conn = 1000\ndefault_pool_size = 20\n"})}),"\n",(0,a.jsx)(e.h3,{id:"83-\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e9\u30b0\u306e\u8003\u616e",children:"8.3 \u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u30e9\u30b0\u306e\u8003\u616e"}),"\n",(0,a.jsx)(e.pre,{children:(0,a.jsx)(e.code,{className:"language-sql",children:"-- \u30b9\u30bf\u30f3\u30d0\u30a4\u3067\u306e\u30e9\u30b0\u78ba\u8a8d\nSELECT\n    CASE\n        WHEN pg_last_wal_receive_lsn() = pg_last_wal_replay_lsn() THEN 0\n        ELSE EXTRACT(EPOCH FROM now() - pg_last_xact_replay_timestamp())\n    END AS lag_seconds;\n\n-- \u30a2\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3\u5074\u3067\u30e9\u30b0\u3092\u8a31\u5bb9\u3059\u308b\u4f8b (\u64ec\u4f3c\u30b3\u30fc\u30c9)\nif (query.can_tolerate_lag(seconds=5)) {\n    use_replica_connection()\n} else {\n    use_primary_connection()\n}\n"})}),"\n",(0,a.jsx)(e.hr,{}),"\n",(0,a.jsx)(e.h2,{id:"\u53c2\u8003\u30ea\u30f3\u30af",children:"\u53c2\u8003\u30ea\u30f3\u30af"}),"\n",(0,a.jsxs)(e.ul,{children:["\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/high-availability.html",children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 - \u9ad8\u53ef\u7528\u6027"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/warm-standby.html",children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 - \u30b9\u30c8\u30ea\u30fc\u30df\u30f3\u30b0\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://www.postgresql.org/docs/current/logical-replication.html",children:"PostgreSQL\u516c\u5f0f\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8 - \u8ad6\u7406\u30ec\u30d7\u30ea\u30b1\u30fc\u30b7\u30e7\u30f3"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://patroni.readthedocs.io/",children:"Patroni Documentation"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://www.pgbouncer.org/",children:"PgBouncer"})}),"\n",(0,a.jsx)(e.li,{children:(0,a.jsx)(e.a,{href:"https://www.haproxy.org/documentation/",children:"HAProxy Documentation"})}),"\n"]})]})}function p(n={}){const{wrapper:e}={...(0,l.R)(),...n.components};return e?(0,a.jsx)(e,{...n,children:(0,a.jsx)(d,{...n})}):d(n)}},28453:(n,e,r)=>{r.d(e,{R:()=>i,x:()=>t});var s=r(96540);const a={},l=s.createContext(a);function i(n){const e=s.useContext(l);return s.useMemo((function(){return"function"==typeof n?n(e):{...e,...n}}),[e,n])}function t(n){let e;return e=n.disableParentContext?"function"==typeof n.components?n.components(a):n.components||a:i(n.components),s.createElement(l.Provider,{value:e},n.children)}}}]);